/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../core/has.js";import{neverReached as t}from"../core/compilerUtils.js";import"../core/Logger.js";import"../core/accessorSupport/ensureType.js";import{property as r}from"../core/accessorSupport/decorators/property.js";import{subclass as s}from"../core/accessorSupport/decorators/subclass.js";import"../core/urlUtils.js";import"../core/uuid.js";import"../portal/support/resourceExtension.js";import{create as a,onAbort as o,createAbortError as i}from"../core/promiseUtils.js";import u from"../geometry/SpatialReference.js";import n from"../geometry/Extent.js";import l from"../request.js";import{normalizeCentralMeridian as c}from"../geometry/support/normalizeUtils.js";import p from"../layers/support/Field.js";import m from"./support/FeatureSet.js";import h from"./Task.js";import d from"./support/GPMessage.js";import f from"../layers/support/MapImage.js";import b from"./support/DataFile.js";import j from"./support/JobInfo.js";import S from"./support/LinearUnit.js";import v from"./support/ParameterValue.js";import G from"./support/RasterData.js";let g=class extends h{constructor(e){super(e),this._timers=new Map,this.outSpatialReference=null,this.processExtent=null,this.processSpatialReference=null,this.returnFeatureCollection=!1,this.returnM=!1,this.returnZ=!1}destroy(){this._timers.forEach((e=>{clearInterval(e)}))}cancelJob(e,t){const{path:r}=this.parsedUrl,s={...this.requestOptions,...t,query:{f:"json"}};this._clearTimer(e);return l(`${r}/jobs/${e}/cancel`,s).then((e=>j.fromJSON(e.data)))}checkJobStatus(e,t){const{path:r}=this.parsedUrl,s={...this.requestOptions,...t,query:{f:"json"}};return l(`${r}/jobs/${e}`,s).then((e=>j.fromJSON(e.data)))}execute(e,t){return this._constructRequest("execute",e,t).then((e=>{const t=e.data.results||[],r=e.data.messages||[];return{results:t.map(this._decode),messages:r.map((e=>d.fromJSON(e)))}}))}getResultData(e,t,r){const{returnFeatureCollection:s,returnM:a,returnZ:o,outSpatialReference:i,parsedUrl:u}=this,{path:n}=u,c={returnFeatureCollection:s||void 0,returnM:a||void 0,returnZ:o||void 0,outSR:i,returnType:"data",f:"json"},p=this._gpEncode(c,null),m={...this.requestOptions,...r,query:p};return l(`${n}/jobs/${e}/results/${t}`,m).then((e=>this._decode(e.data)))}getResultImage(e,t,r,s){const{path:a}=this.parsedUrl,o={...r.toJSON(),f:"json"},i=this._gpEncode(o),u={...this.requestOptions,...s,query:i};return l(`${a}/jobs/${e}/results/${t}`,u).then((e=>this._decode(e.data)))}async getResultMapImageLayer(e){const{path:t}=this.parsedUrl,r=t.indexOf("/GPServer/"),s=`${t.substring(0,r)}/MapServer/jobs/${e}`;return new(0,(await import("../layers/MapImageLayer.js")).default)({url:s})}submitJob(e,t){return this._constructRequest("submitJob",e,t).then((e=>j.fromJSON(e.data)))}waitForJobCompletion(e,r={}){const{interval:s=1e3,signal:u,statusCallback:n}=r;return a(((r,a)=>{o(u,(()=>{this._clearTimer(e),a(i())})),this._clearTimer(e);const l=setInterval((()=>{this._timers.has(e)||a(i()),this._getJobStatus(e,this.requestOptions).then((s=>{const{jobStatus:o}=s;switch(o){case"job-succeeded":this._clearTimer(e),r(s);break;case"job-submitted":case"job-executing":case"job-waiting":case"job-new":n&&n(s);break;case"job-cancelled":case"job-cancelling":case"job-deleted":case"job-deleting":case"job-timed-out":case"job-failed":this._clearTimer(e),a(s);break;default:t(o)}}))}),s);this._timers.set(e,l)}))}_clearTimer(e){this._timers.has(e)&&(clearInterval(this._timers.get(e)),this._timers.delete(e))}_constructRequest(e,t,r){const s={},a={},o=[];return this._collectGeometries(t,o,s),c(o).then((o=>{const{outSpatialReference:i,parsedUrl:u,processExtent:n,processSpatialReference:c,returnFeatureCollection:p,returnM:m,returnZ:h}=this,{path:d}=u;for(const e in s){const t=s[e];a[e]=o.slice(t[0],t[1])}const f=i?i.wkid||i:null,b=c?c.wkid||c:null,j="execute"===e?{returnFeatureCollection:p||void 0,returnM:m||void 0,returnZ:h||void 0}:null,S={...n?{context:{extent:n,outSR:f,processSR:b}}:{"env:outSR":f,"env:processSR":b},...t,...j,f:"json"},v=this._gpEncode(S,null,a),G={...this.requestOptions,...r,query:v};return l(`${d}/${e}`,G)}))}_collectGeometries(e,t,r){for(const s in e){const a=e[s];if(a&&"object"==typeof a&&a instanceof m){const{features:e}=a;r[s]=[t.length,t.length+e.length],e.forEach((e=>{t.push(e.geometry)}))}}}_decode(e){const t=e.dataType,r=v.fromJSON(e);switch(t){case"GPBoolean":case"GPDouble":case"GPLong":case"GPString":return r;case"GPDate":r.value=new Date(r.value);break;case"GPDataFile":r.value=b.fromJSON(r.value);break;case"GPLinearUnit":r.value=S.fromJSON(r.value);break;case"GPFeatureRecordSetLayer":case"GPRecordSet":{const t=e.value.url;r.value=t?b.fromJSON(r.value):m.fromJSON(r.value);break}case"GPRasterData":case"GPRasterDataLayer":{const t=e.value.mapImage;r.value=t?f.fromJSON(t):G.fromJSON(r.value);break}case"GPField":r.value=p.fromJSON(r.value);break;case"GPMultiValue:GPBoolean":case"GPMultiValue:GPDouble":case"GPMultiValue:GPLong":case"GPMultiValue:GPString":return r;case"GPMultiValue:GPDate":{const e=r.value;r.value=e.map((e=>new Date(e)));break}case"GPMultiValue:GPDataFile":r.value=r.value.map((e=>b.fromJSON(e)));break;case"GPMultiValue:GPLinearUnit":r.value=r.value.map((e=>S.fromJSON(e)));break;case"GPMultiValue:GPFeatureRecordSetLayer":case"GPMultiValue:GPRecordSet":r.value=r.value.map((e=>m.fromJSON(e)));break;case"GPMultiValue:GPRasterData":case"GPMultiValue:GPRasterDataLayer":r.value=r.value.map((e=>e?f.fromJSON(e):G.fromJSON(r.value)));break;case"GPMultiValue:GPField":r.value=r.value.map((e=>p.fromJSON(e)))}return r}_gpEncode(e,t,r){for(const t in e){const r=e[t];Array.isArray(r)?e[t]=JSON.stringify(r.map((e=>this._gpEncode({item:e},!0).item),this)):r instanceof Date&&(e[t]=r.getTime())}return this._encode(e,t,r)}_getJobStatus(e,t){const{path:r}=this.parsedUrl,s=`${r}/jobs/${e}`,a={...this.requestOptions,...t,query:{f:"json"}};return l(s,a).then((e=>j.fromJSON(e.data)))}};e([r({type:u})],g.prototype,"outSpatialReference",void 0),e([r({type:n})],g.prototype,"processExtent",void 0),e([r({type:u})],g.prototype,"processSpatialReference",void 0),e([r({nonNullable:!0})],g.prototype,"returnFeatureCollection",void 0),e([r({nonNullable:!0})],g.prototype,"returnM",void 0),e([r({nonNullable:!0})],g.prototype,"returnZ",void 0),g=e([s("esri/tasks/Geoprocessor")],g);var P=g;export default P;
