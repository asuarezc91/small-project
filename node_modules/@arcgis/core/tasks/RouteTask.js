/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../core/has.js";import"../core/Logger.js";import"../core/accessorSupport/ensureType.js";import"../core/accessorSupport/decorators/property.js";import{subclass as r}from"../core/accessorSupport/decorators/subclass.js";import"../core/urlUtils.js";import"../core/uuid.js";import"../portal/support/resourceExtension.js";import{resolve as t}from"../core/promiseUtils.js";import s from"../request.js";import{normalizeCentralMeridian as o}from"../geometry/support/normalizeUtils.js";import i from"./Task.js";import{createQueryParamsHelper as a}from"../core/queryUtils.js";import{NAServiceDescriptionMixin as n}from"./mixins/NAServiceDescription.js";import p from"./support/RouteResultsContainer.js";const l=a({accumulateAttributes:{name:"accumulateAttributeNames"},attributeParameterValues:!0,directionsTimeAttribute:{name:"directionsTimeAttributeName"},impedanceAttribute:{name:"impedanceAttributeName"},outSpatialReference:{name:"outSR",getter:e=>e.outSpatialReference.wkid},pointBarriers:{name:"barriers"},polylineBarriers:!0,polygonBarriers:!0,restrictionAttributes:{name:"restrictionAttributeNames"},stops:!0,travelMode:!0});let u=class extends(n(i)){constructor(e){super(e)}solve(e,r){const i=[],a=[],n={},p={};return e.stops&&e.stops.features&&this._collectGeometries(e.stops.features,a,"stops.features",n),e.pointBarriers&&e.pointBarriers.features&&this._collectGeometries(e.pointBarriers.features,a,"pointBarriers.features",n),e.polylineBarriers&&e.polylineBarriers.features&&this._collectGeometries(e.polylineBarriers.features,a,"polylineBarriers.features",n),e.polygonBarriers&&e.polygonBarriers.features&&this._collectGeometries(e.polygonBarriers.features,a,"polygonBarriers.features",n),o(a).then((e=>{for(const r in n){const t=n[r];i.push(r),p[r]=e.slice(t[0],t[1])}return this._isInputGeometryZAware(p,i)?this.getServiceDescription():t({dontCheck:!0})})).then((t=>{("dontCheck"in t?t.dontCheck:t.hasZ)||this._dropZValuesOffInputGeometry(p,i);for(const r in p)p[r].forEach(((t,s)=>{e.get(r)[s].geometry=t}));let o={query:{...this.parsedUrl.query,f:"json",...l.toQueryParams(e)}};(this.requestOptions||r)&&(o={...this.requestOptions,...r,...o});const{path:a}=this.parsedUrl,n="/solve",u=a.endsWith(n)?a:a+n;return s(u,o)})).then((e=>this._handleSolveResponse(e)))}_collectGeometries(e,r,t,s){s[t]=[r.length,r.length+e.length],e.forEach((e=>{r.push(e.geometry)}))}_handleSolveResponse(e){const r=[],t=[],{directions:s=[],routes:{features:o=[],spatialReference:i=null}={},stops:{features:a=[],spatialReference:n=null}={},barriers:l,polygonBarriers:u,polylineBarriers:c,messages:m}=e.data,f="esri.tasks.RouteTask.NULL_ROUTE_NAME";let h,y,d=!0;const g=o&&i||a&&n||l&&l.spatialReference||u&&u.spatialReference||c&&c.spatialReference;s.forEach((e=>{r.push(h=e.routeName),t[h]={directions:e}})),o.forEach((e=>{-1===r.indexOf(h=e.attributes.Name)&&(r.push(h),t[h]={}),e.geometry&&(e.geometry.spatialReference=g),t[h].route=e})),a.forEach((e=>{y=e.attributes,-1===r.indexOf(h=y.RouteName||f)&&(r.push(h),t[h]={}),h!==f&&(d=!1),e.geometry&&(e.geometry.spatialReference=g),null==t[h].stops&&(t[h].stops=[]),t[h].stops.push(e)})),a.length>0&&!0===d&&(t[r[0]].stops=t[f].stops,delete t[f],r.splice(r.indexOf(f),1));const B=r.map((e=>(t[e].routeName=e===f?null:e,t[e])));return p.fromJSON({routeResults:B,pointBarriers:l,polygonBarriers:u,polylineBarriers:c,messages:m})}};u=e([r("esri.tasks.RouteTask")],u);var c=u;export default c;
