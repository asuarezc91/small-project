/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isNone as n,isSome as t}from"../core/maybe.js";import e from"../core/Error.js";import{all as r,throwIfAborted as l}from"../core/promiseUtils.js";import{equals as u,isValid as o,isWGS84 as s,isWebMercator as i,isMars as a,isMoon as c}from"./support/spatialReferenceUtils.js";import{earth as f,moon as p,mars as h}from"./support/Ellipsoid.js";import m from"./Point.js";import d from"./Extent.js";import M from"./Multipoint.js";import R from"./Polygon.js";import j from"./Polyline.js";import{clamp as E,deg2rad as w,rad2deg as y,asinClamped as g}from"../core/mathUtils.js";import{c as x}from"../chunks/vec3f64.js";import{g as I,b as T,f as P,n as C,l as F}from"../chunks/vec3.js";import{SphericalECEFSpatialReference as S,WGS84ECEFSpatialReference as k,SphericalPCPFMars as b,SphericalPCPFMoon as v}from"./projectionEllipsoid.js";import{getMetersPerUnitForSR as q}from"../core/unitUtils.js";import{i as z,t as U,s as A}from"../chunks/mat4.js";import{l as G,p as W,i as Z}from"../chunks/pe.js";import{set as _}from"./support/aaBoundingRect.js";import{earthEllipsoidConstants as B}from"./support/geodesicConstants.js";import K from"./support/GeographicTransformation.js";let L=null,N=null,V=null,X={};function D(){return!!L&&Z()}function H(){return!0}function J(t){return n(V)&&(V=r([G(),import("../chunks/geometryEngineBase.js").then((function(n){return n.g})),import("./geometryAdapters/hydrated.js")])),V.then((([,n,{hydratedAdapter:e}])=>{l(t),N=e,L=n.default,L._enableProjection(W)}))}function O(n,t,e=null){return Array.isArray(n)?0===n.length?[]:Q(N,n,n[0].spatialReference,t,e):Q(N,[n],n.spatialReference,t,e)[0]}function Q(t,e,r,l,u=null){if(n(r)||n(l))return e;if(en(r,l,u))return e.map((n=>function(n,t,e){if(!n)return n;if("x"in n){const r=new m;return on(n,t,r,e)?r:null}if("xmin"in n){const r=new d;return dn(n,t,r,e)?r:null}if("rings"in n){const r=new R;return hn(n,t,r,e)?r:null}if("paths"in n){const r=new j;return fn(n,t,r,e)?r:null}if("points"in n){const r=new M;return an(n,t,r,e)?r:null}return null}(n,r,l)));if(n(u)){const t=K.cacheKey(r,l);void 0!==X[t]?u=X[t]:(u=Y(r,l,null),n(u)&&(u=new K),X[t]=u)}if(n(L))throw new nn;return L._project(t,e,r,l,u)}function Y(t,e,r=null){if(n(L))throw new nn;if(n(t)||n(e))return null;const l=L._getTransformation(N,t,e,r,null==r?void 0:r.spatialReference);return null!==l?K.fromGE(l):null}function $(t,e,r=null){if(n(L))throw new nn;const l=L._getTransformationBySuitability(N,t,e,r,null==r?void 0:r.spatialReference);if(null!==l){const n=[];for(const t of l)n.push(K.fromGE(t));return n}return[]}class nn extends e{constructor(){super("projection:not-loaded","projection engine not fully loaded yet, please call load()")}}function tn(){L=null,N=null,V=null,X={}}function en(n,t,e){return!e&&(!!u(n,t)||o(n)&&o(t)&&!!tt(n,t,ot))}async function rn(n,t){if(!D())for(const{source:e,dest:r,geographicTransformation:l}of n)if(!en(e,r,l))return J(t)}function ln(n,t){switch(tt(n,t,ot)){case qn:return"copy3";case Ln:return"wgs84ToSphericalECEF";case Gn:return"wgs84ToWebMercator";case On:return"wgs84ToWGS84ECEF";case zn:return"webMercatorToWGS84";case Un:return"webMercatorToSphericalECEF";case An:return"webMercatorToWGS84ECEF";case Qn:return"wgs84ECEFToWGS84";case Yn:return"wgs84ECEFToSphericalECEF";case $n:return"wgs84ECEFToWebMercator";case Dn:return"sphericalECEFToWGS84";case Hn:return"sphericalECEFToWebMercator";case Xn:return"sphericalECEFToMars2000";case Vn:return"sphericalECEFToMoon2000";case Jn:return"sphericalECEFToWGS84ECEF";case Kn:return"mars2000ToSphericalPCPF";case Bn:return"moon2000ToSphericalPCPF";default:return null}}function un(t,e,r=e.spatialReference,l=0){return!n(r)&&on(t,t.spatialReference,e,r,l)}function on(n,t,e,r,l=0){ht[0]=n.x,ht[1]=n.y;const u=n.z;return ht[2]=void 0!==u?u:l,!!xn(ht,t,0,ht,r,0,1)&&(e.x=ht[0],e.y=ht[1],e.spatialReference=r,void 0===u?(e.z=void 0,e.hasZ=!1):(e.z=ht[2],e.hasZ=!0),void 0===n.m?(e.m=void 0,e.hasM=!1):(e.m=n.m,e.hasM=!0),!0)}function sn(t,e,r=e.spatialReference,l=0){return!n(r)&&an(t,t.spatialReference,e,r,l)}function an(n,t,e,r,l=0){const{points:u,hasZ:o,hasM:s}=n,i=[],a=u.length,c=[];for(const n of u)c.push(n[0],n[1],o?n[2]:l);if(!xn(c,t,0,c,r,0,a))return!1;for(let n=0;n<a;++n){const t=3*n,e=c[t],r=c[t+1];o&&s?i.push([e,r,c[t+2],u[n][3]]):o?i.push([e,r,c[t+2]]):s?i.push([e,r,u[n][2]]):i.push([e,r])}return e.points=i,e.spatialReference=r,e.hasZ=o,e.hasM=s,!0}function cn(t,e,r=e.spatialReference,l=0){return!n(r)&&fn(t,t.spatialReference,e,r,l)}function fn(n,t,e,r,l=0){const{paths:u,hasZ:o,hasM:s}=n,i=[];return!!Tn(u,o,s,t,i,r,l)&&(e.paths=i,e.spatialReference=r,e.hasZ=o,e.hasM=s,!0)}function pn(t,e,r=e.spatialReference,l=0){return!n(r)&&hn(t,t.spatialReference,e,r,l)}function hn(n,t,e,r,l=0){const{rings:u,hasZ:o,hasM:s}=n,i=[];return!!Tn(u,o,s,t,i,r,l)&&(e.rings=i,e.spatialReference=r,e.hasZ=o,e.hasM=s,!0)}function mn(t,e,r=e.spatialReference,l=0){return!n(r)&&dn(t,t.spatialReference,e,r,l)}function dn(n,t,e,r,l=0){const{xmin:u,ymin:o,xmax:s,ymax:i,hasZ:a,hasM:c}=n;if(!En(u,o,a?n.zmin:l,t,ht,r))return!1;e.xmin=ht[0],e.ymin=ht[1],a&&(e.zmin=ht[2]);return!!En(s,i,a?n.zmax:l,t,ht,r)&&(e.xmax=ht[0],e.ymax=ht[1],a&&(e.zmax=ht[2]),c&&(e.mmin=n.mmin,e.mmax=n.mmax),e.spatialReference=r,!0)}function Mn(e,r,l,u){return n(r)||n(l)?null:(u=t(u)?u:new m({spatialReference:l}),xn(e,r,0,ht,l,0,1)?(u.x=ht[0],u.y=ht[1],u.z=ht[2],u.spatialReference=l,u):null)}function Rn(t,e,r,l){return n(l)&&(l=r.spatialReference),xn(t,e,0,ht,l,0,1)?(r.x=ht[0],r.y=ht[1],r.z=ht[2],r.spatialReference=l,r):null}function jn(n,t,e,r=0){ht[0]=n.x,ht[1]=n.y;const l=n.z;return ht[2]=void 0!==l?l:r,xn(ht,n.spatialReference,0,t,e,0,1)}function En(n,t,e,r,l,u){return ct[0]=n,ct[1]=t,ct[2]=e,xn(ct,r,0,l,u,0,1)}function wn(t,e,r,l){return!(n(e)||n(l)||t.length<2)&&(2===t.length&&(ct[0]=t[0],ct[1]=t[1],ct[2]=0,t=ct),xn(t,e,0,r,l,0,1))}function yn(n,t){ht[0]=n.x,ht[1]=n.y;const e=n.z;return ht[2]=void 0!==e?e:0,gn(ht,n.spatialReference,t)}function gn(t,e,r){return function(t,e,r,l){if(n(e))return!1;const u=vn(e,lt),o=nt[u][l];if(n(o))return!1;o(t,0,ct,0),r!==ct&&(r[0]=ct[0],r[1]=ct[1],r.length>2&&(r[2]=ct[2]));return!0}(t,e,r,6)}function xn(t,e,r,l,u,o,s=1){const i=tt(e,u,ot);if(n(i))return!1;if(i===qn){if(t===l&&r===o)return!0;const n=r+3*s;for(let e=r,u=o;e<n;e++,u++)l[u]=t[e];return!0}const a=r+3*s;for(let n=r,e=o;n<a;n+=3,e+=3)i(t,n,l,e);return!0}function In(n,t,e,r,l){I(ht,n),T(mt,n,t),wn(ht,e,ht,l),wn(mt,e,mt,l),P(r,mt,ht),C(r,r)}function Tn(n,t,e,r,l,u,o=0){const s=new Array;for(const e of n)for(const n of e)s.push(n[0],n[1],t?n[2]:o);if(!xn(s,r,0,s,u,0,s.length/3))return!1;let i=0;l.length=0;for(const r of n){const n=new Array;for(const l of r)t&&e?n.push([s[i++],s[i++],s[i++],l[3]]):t?n.push([s[i++],s[i++],s[i++]]):e?(n.push([s[i++],s[i++],l[2]]),i++):(n.push([s[i++],s[i++]]),i++);l.push(n)}return!0}function Pn(t,e,r,l){if(n(e)||n(l))return!1;const u=et(e,l,st);if(u.projector===qn)return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],!0;if(n(u.projector))return!1;const{source:o,dest:s}=u;if(3===s.spatialReferenceId){const e=nt[o.spatialReferenceId][2];if(n(e))return!1;e(t,0,ft,0);const l=Math.abs(it*ft[1])+Math.asin(t[3]/(f.radius+t[2]));if(Gn(ft,0,r,0),l>.9999*Math.PI)r[3]=Number.MAX_VALUE;else{const n=1/Math.cos(l);r[3]=n*t[3]}return!0}return u.projector(t,0,r,0),r[3]=t[3]*o.metersPerUnit/s.metersPerUnit,!0}function Cn(n,t,e,r){return null!=n&&(u(t,r)?(_(e,n),!0):(ct[0]=n[0],ct[1]=n[1],ct[2]=0,!!xn(ct,t,0,ct,r,0,1)&&(e[0]=ct[0],e[1]=ct[1],ct[0]=n[2],ct[1]=n[3],ct[2]=0,!!xn(ct,t,0,ct,r,0,1)&&(e[2]=ct[0],e[3]=ct[1],!0))))}function Fn(t,e,r,l){if(n(e)||n(l))return!1;const o=vn(e,lt),s=vn(l,ut);if(o===s&&0!==o||u(e,l))return r[0]=1,r[1]=1,r[2]=1,!0;if(1===o){const n=F(t),e=n/Math.sqrt(t[0]*t[0]+t[1]*t[1]),l=n/f.radius;if(3===s)return r[0]=e*l,r[1]=e*l,r[2]=1,!0;if(2===s||5===s){const n=180/(f.radius*Math.PI);return r[0]=n*e*l,r[1]=n*l,r[2]=1,!0}}return!1}function Sn(t,e,r,l){if(n(t)||n(l))return!1;const o=vn(t,lt),s=vn(l,ut);if(o===s&&1!==s&&(0!==o||u(t,l)))return z(r),U(r,r,e),!0;if(1===s||7===s||9===s){let t=0,l=0;if(1===s){const r=nt[o][6],u=nt[6][s];if(n(r)||n(u))return!1;r(e,0,ft,0),u(ft,0,pt,0),t=it*ft[0],l=it*ft[1]}else if(7===s||9===s){const r=nt[o][s];if(n(r))return!1;r(e,0,pt,0),t=it*e[0],l=it*e[1]}return kn(l,t,r),r[12]=pt[0],r[13]=pt[1],r[14]=pt[2],!0}if(3===s&&(2===o||1===o)){const t=nt[o][6];if(n(t))return!1;t(e,0,ft,0);const l=it*ft[1];Gn(ft,0,pt,0),z(r),U(r,r,pt);const u=1/Math.cos(l);return A(r,r,[u,u,1]),!0}return!1}function kn(n,t,e){const r=Math.sin(t),l=Math.cos(t),u=Math.sin(n),o=Math.cos(n),s=e;return s[0]=-r,s[4]=-u*l,s[8]=o*l,s[12]=0,s[1]=l,s[5]=-u*r,s[9]=o*r,s[13]=0,s[2]=0,s[6]=o,s[10]=u,s[14]=0,s[3]=0,s[7]=0,s[11]=0,s[15]=1,s}var bn;function vn(n,t){return t.spatialReference===n?t.spatialReferenceId:(t.spatialReference=n,"metersPerUnit"in t&&(t.metersPerUnit=q(n,1)),n.wkt===S.wkt?t.spatialReferenceId=1:s(n)?t.spatialReferenceId=2:i(n)?t.spatialReferenceId=3:n.wkt===k.wkt?t.spatialReferenceId=4:4490===n.wkid?t.spatialReferenceId=5:n.wkt===b.wkt?t.spatialReferenceId=7:n.wkt===v.wkt?t.spatialReferenceId=9:a(n)?t.spatialReferenceId=8:c(n)?t.spatialReferenceId=10:t.spatialReferenceId=0)}function qn(n,t,e,r){n!==e&&(e[r++]=n[t++],e[r++]=n[t++],e[r]=n[t])}function zn(n,t,e,r){e[r++]=at*(n[t++]/f.radius),e[r++]=at*(Math.PI/2-2*Math.atan(Math.exp(-1*n[t++]/f.radius))),e[r]=n[t]}function Un(n,t,e,r){zn(n,t,e,r),Ln(e,r,e,r)}function An(n,t,e,r){zn(n,t,e,r),On(e,r,e,r)}function Gn(n,t,e,r){const l=.4999999*Math.PI,u=E(it*n[t+1],-l,l),o=Math.sin(u);e[r++]=it*n[t]*f.radius,e[r++]=f.halfSemiMajorAxis*Math.log((1+o)/(1-o)),e[r]=n[t+2]}function Wn(t){if(n(t))return!1;const e=vn(t,lt);return!!nt[e][6]}function Zn(n,t,e,r,l=0){const u=r+l,o=Math.cos(e);n[0]=Math.cos(t)*o*u,n[1]=Math.sin(t)*o*u,n[2]=Math.sin(e)*u}function _n(n,t,e,r,l){const u=l+n[t+2],o=it*n[t+1],s=it*n[t],i=Math.cos(o);e[r++]=Math.cos(s)*i*u,e[r++]=Math.sin(s)*i*u,e[r]=Math.sin(o)*u}function Bn(n,t,e,r){_n(n,t,e,r,p.radius)}function Kn(n,t,e,r){_n(n,t,e,r,h.radius)}function Ln(n,t,e,r){_n(n,t,e,r,f.radius)}function Nn(n,t,e,r,l){const u=n[t],o=n[t+1],s=n[t+2],i=Math.sqrt(u*u+o*o+s*s),a=g(s/(0===i?1:i)),c=Math.atan2(o,u);e[r++]=at*c,e[r++]=at*a,e[r]=i-l}function Vn(n,t,e,r){Nn(n,t,e,r,p.radius)}function Xn(n,t,e,r){Nn(n,t,e,r,h.radius)}function Dn(n,t,e,r){Nn(n,t,e,r,f.radius)}function Hn(n,t,e,r){Dn(n,t,e,r),Gn(e,r,e,r)}function Jn(n,t,e,r){Dn(n,t,e,r),On(e,r,e,r)}function On(n,t,e,r){!function(n,t,e,r,l){const u=it*n[t],o=it*n[t+1],s=n[t+2],i=Math.sin(o),a=Math.cos(o),c=l.radius/Math.sqrt(1-l.eccentricitySquared*i*i);e[r++]=(c+s)*a*Math.cos(u),e[r++]=(c+s)*a*Math.sin(u),e[r++]=(c*(1-l.eccentricitySquared)+s)*i}(n,t,e,r,f)}function Qn(n,t,e,r){const l=B,u=n[t],o=n[t+1],s=n[t+2];let i,a,c,p,h,m,d,M,R,j,E,w,y,g,x,I,T,P,C,F,S;i=Math.abs(s),a=u*u+o*o,c=Math.sqrt(a),p=a+s*s,h=Math.sqrt(p),F=Math.atan2(o,u),m=s*s/p,d=a/p,g=l.a2/h,x=l.a3-l.a4/h,d>.3?(M=i/h*(1+d*(l.a1+g+m*x)/h),C=Math.asin(M),j=M*M,R=Math.sqrt(1-j)):(R=c/h*(1-m*(l.a5-g-d*x)/h),C=Math.acos(R),j=1-R*R,M=Math.sqrt(j)),E=1-f.eccentricitySquared*j,w=f.radius/Math.sqrt(E),y=l.a6*w,g=c-w*R,x=i-y*M,T=R*g+M*x,I=R*x-M*g,P=I/(y/E+T),C+=P,S=T+I*P/2,s<0&&(C=-C),e[r++]=at*F,e[r++]=at*C,e[r]=S}function Yn(n,t,e,r){Qn(n,t,e,r),Ln(e,r,e,r)}function $n(n,t,e,r){Qn(n,t,e,r),Gn(e,r,e,r)}!function(n){n.x2lon=function(n){return n/f.radius},n.y2lat=function(n){return Math.PI/2-2*Math.atan(Math.exp(-1*n/f.radius))},n.lon2x=function(n){return n*f.radius},n.lat2y=function(n){const t=Math.sin(n);return f.radius/2*Math.log((1+t)/(1-t))}}(bn||(bn={}));const nt={2:{5:null,8:null,10:null,6:qn,1:Ln,7:null,9:null,0:null,3:Gn,2:qn,4:On},5:{5:qn,8:null,10:null,6:qn,1:Ln,7:null,9:null,0:null,3:null,2:null,4:On},8:{5:null,8:qn,10:null,6:null,1:null,7:Kn,9:null,0:null,3:null,2:null,4:null},10:{5:null,8:null,10:qn,6:null,1:null,7:null,9:Bn,0:null,3:null,2:null,4:null},3:{5:null,8:null,10:null,6:zn,1:Un,7:null,9:null,0:null,3:qn,2:zn,4:An},4:{5:Qn,8:null,10:null,6:Qn,1:Yn,7:null,9:null,0:null,3:$n,2:Qn,4:qn},1:{5:Dn,8:null,10:null,6:Dn,1:qn,7:null,9:null,0:null,3:Hn,2:Dn,4:Jn},7:{5:null,8:Xn,10:null,6:null,1:null,7:qn,9:null,0:null,3:null,2:null,4:null},9:{5:null,8:null,10:Vn,6:null,1:null,7:null,9:qn,0:null,3:null,2:null,4:null},0:{5:null,8:null,10:null,6:null,1:null,7:null,9:null,0:qn,3:null,2:null,4:null},6:{5:null,8:null,10:null,6:qn,1:Ln,7:null,9:null,0:null,3:null,2:qn,4:On}};function tt(t,e,r=rt()){return n(t)||n(e)?null:et(t,e,r).projector}function et(t,e,r){if(n(t)||n(e)||r.source.spatialReference===t&&r.dest.spatialReference===e)return r;const l=vn(t,r.source),o=vn(e,r.dest);return 0===l&&0===o?u(t,e)?r.projector=qn:r.projector=null:r.projector=nt[l][o],r}function rt(){return{source:{spatialReference:null,spatialReferenceId:0,metersPerUnit:1},dest:{spatialReference:null,spatialReferenceId:0,metersPerUnit:1},projector:qn}}const lt={spatialReference:null,spatialReferenceId:0},ut={spatialReference:null,spatialReferenceId:0},ot=rt(),st=rt(),it=w(1),at=y(1),ct=x(),ft=x(),pt=x(),ht=x(),mt=x();export{Wn as canProjectToWGS84ComparableLonLat,en as canProjectWithoutEngine,kn as computeLatLonToENURotation,Sn as computeLinearTransformation,ln as getProjectorName,Y as getTransformation,$ as getTransformations,rn as initializeProjection,D as isLoaded,H as isSupported,J as load,Fn as localLinearScaleFactors,Zn as lonLatToSphericalPCPF,O as project,Cn as projectBoundingRect,Pn as projectBoundingSphere,xn as projectBuffer,In as projectDirection,mn as projectExtent,Q as projectMany,sn as projectMultipoint,un as projectPoint,jn as projectPointToVector,yn as projectPointToWGS84ComparableLonLat,pn as projectPolygon,cn as projectPolyline,Rn as projectVectorToDehydratedPoint,Mn as projectVectorToPoint,wn as projectVectorToVector,gn as projectVectorToWGS84ComparableLonLat,En as projectXYZToVector,Nn as sphericalECEFToSphericalPCPF,tn as unload,bn as webMercator};
