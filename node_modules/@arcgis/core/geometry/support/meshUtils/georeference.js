/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isNone as r}from"../../../core/maybe.js";import{getSphericalPCPF as n}from"../../projectionEllipsoid.js";import{getMetersPerUnit as t,getMetersPerVerticalUnitForSR as o,convertUnit as e}from"../../../core/unitUtils.js";import{a,s as i}from"../../../chunks/mat4.js";import{computeLinearTransformation as l}from"../../projection.js";import{a as s}from"../../../chunks/mat3f64.js";import{a as f}from"../../../chunks/mat4f64.js";import{n as c}from"../../../chunks/mat3.js";import{BufferViewVec3f64 as u,BufferViewVec3f as p}from"../../../views/3d/support/buffer/BufferView.js";import{projectFromECEF as m,projectNormalFromECEF as y,projectTangentFromECEF as h,projectToECEF as g,projectNormalToECEF as A,projectTangentToECEF as E}from"./projection.js";import{t as T,a as j}from"../../../chunks/vec32.js";function F(r,n,t){return R(n,t)?function(r,n,t){const o=n.spatialReference,e=w(n,t,v),a=new Float64Array(r.position.length),i=function(r,n,t,o){T(u.fromTypedArray(o),u.fromTypedArray(r),n);const e=new Float64Array(r.length);return m(o,e,t)}(r.position,e,o,a),l=c(_,e),s=function(r,n,t,o,e){if(!t)return null;const a=new Float32Array(t.length);return j(p.fromTypedArray(a),p.fromTypedArray(t),o),y(a,r,n,e,a),a}(i,a,r.normal,l,o),f=function(r,n,t,o,e){if(!t)return null;const a=new Float32Array(t.length);j(p.fromTypedArray(a,4*Float32Array.BYTES_PER_ELEMENT),p.fromTypedArray(t,4*Float32Array.BYTES_PER_ELEMENT),o);for(let r=3;r<a.length;r+=4)a[r]=t[r];return h(a,r,n,e,a),a}(i,a,r.tangent,l,o);return{position:i,normal:s,tangent:f}}(r,n,t):function(r,n,t){const o=new Float64Array(r.position.length),e=r.position,a=n.x,i=n.y,l=n.z||0,{horizontal:s,vertical:f}=z(t?t.unit:null,n.spatialReference);for(let r=0;r<e.length;r+=3)o[r+0]=e[r+0]*s+a,o[r+1]=e[r+1]*s+i,o[r+2]=e[r+2]*f+l;return{position:o,normal:r.normal,tangent:r.tangent}}(r,n,t)}function d(r,n,t){return R(n,t)?function(r,n,t){const o=n.spatialReference;w(n,t,v);const e=a(S,v),i=new Float64Array(r.position.length),l=function(r,n,t,o){const e=g(r,n,o),a=u.fromTypedArray(e),i=new Float64Array(e.length),l=u.fromTypedArray(i);return T(l,a,t),i}(r.position,o,e,i),s=c(_,e),f=function(r,n,t,o,e){if(!r)return null;const a=A(r,n,t,o,new Float32Array(r.length)),i=p.fromTypedArray(a);return j(i,i,e),a}(r.normal,r.position,i,o,s),m=function(r,n,t,o,e){if(!r)return null;const a=E(r,n,t,o,new Float32Array(r.length)),i=p.fromTypedArray(a,4*Float32Array.BYTES_PER_ELEMENT);return j(i,i,e),a}(r.tangent,r.position,i,o,s);return{position:l,normal:f,tangent:m}}(r,n,t):function(r,n,t){const o=new Float64Array(r.position.length),e=r.position,a=n.x,i=n.y,l=n.z||0,{horizontal:s,vertical:f}=z(t?t.unit:null,n.spatialReference);for(let r=0;r<e.length;r+=3)o[r+0]=(e[r+0]-a)/s,o[r+1]=(e[r+1]-i)/s,o[r+2]=(e[r+2]-l)/f;return{position:o,normal:r.normal,tangent:r.tangent}}(r,n,t)}function w(r,t,o){l(r.spatialReference,[r.x,r.y,r.z||0],o,n(r.spatialReference));const{horizontal:e,vertical:a}=z(t?t.unit:null,r.spatialReference);return i(o,o,[e,e,a]),o}function R(r,n){const t=r.spatialReference;return t.isWGS84||t.isWebMercator&&(!n||!1!==n.geographic)}function z(n,a){if(r(n))return k;const i=a.isWGS84?1:t(a),l=a.isWGS84?1:o(a),s=e(1,n,"meters");return{horizontal:s*i,vertical:s*l}}const v=f(),S=f(),_=s(),k={horizontal:1,vertical:1};export{F as georeference,d as ungeoreference};
