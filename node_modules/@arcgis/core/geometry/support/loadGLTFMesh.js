/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{unwrap as t,applySome as e}from"../../core/maybe.js";import{f as r}from"../../chunks/vec3f64.js";import{a as o}from"../../chunks/mat3f64.js";import{b as s}from"../../chunks/vec4f64.js";import n from"./MeshTexture.js";import a from"./MeshMaterialMetallicRoughness.js";import{n as i}from"../../chunks/mat3.js";import{BufferViewVec3f64 as u,BufferViewVec3f as c,BufferViewVec4f as f,BufferViewVec2f as m,BufferViewVec4u8 as l,BufferViewVec4u16 as p,BufferViewVec3u8 as d,BufferViewVec3u16 as h}from"../../views/3d/support/buffer/BufferView.js";import{t as v,a as g,s as w,b as j}from"../../chunks/vec32.js";import{georeference as b}from"./meshUtils/georeference.js";import{COLOR_GAMMA as x}from"../../views/3d/webgl-engine/materials/DefaultMaterial.js";import{DefaultLoadingContext as M}from"../../views/3d/glTF/DefaultLoadingContext.js";import{n as k}from"../../chunks/vec22.js";import{c as T}from"../../chunks/vec33.js";import{c as y,f as B}from"../../chunks/vec43.js";import{createBuffer as C}from"../../views/3d/support/buffer/utils.js";import{load as F}from"../../views/3d/glTF/loader.js";import{triangleFanToTriangles as E,triangleStripToTriangles as R,trianglesToTriangles as S}from"../../views/3d/glTF/internal/indexUtils.js";import{t as A,s as D,a as N}from"../../chunks/vec42.js";async function U(x,U,q){const K=new M,P=(await F(K,U,q)).model,Q=P.lods.shift(),V=new Map,G=new Map;return P.textures.forEach(((t,e)=>{return V.set(e,new n({data:(r=t).data,wrap:O(r.parameters.wrap)}));var r})),P.materials.forEach(((o,n)=>G.set(n,function(o,n){const i=(f=o.color,m=o.opacity,s(z(f[0]),z(f[1]),z(f[2]),m)),u=o.emissiveFactor?function(t){return r(z(t[0]),z(t[1]),z(t[2]))}(o.emissiveFactor):null,c={color:i,colorTexture:t(e(o.textureColor,(t=>n.get(t)))),normalTexture:t(e(o.textureNormal,(t=>n.get(t)))),emissiveColor:u,emissiveTexture:t(e(o.textureEmissive,(t=>n.get(t)))),occlusionTexture:t(e(o.textureOcclusion,(t=>n.get(t)))),alphaMode:L(o.alphaMode),alphaCutoff:o.alphaCutoff,doubleSided:o.doubleSided,metallic:o.metallicFactor,roughness:o.roughnessFactor,metallicRoughnessTexture:t(e(o.textureMetallicRoughness,(t=>n.get(t))))};var f,m;return new a(c)}(o,V)))),Q.parts.map((r=>function(r,s,n,a){const x=C(u,n.attributes.position.count);v(x,n.attributes.position,n.transform);const M=e(n.attributes.normal,(t=>{const e=C(c,t.count),r=i(o(),n.transform);return g(e,t,r),e.typedBuffer})),F=e(n.attributes.tangent,(t=>{const e=C(f,t.count),r=i(o(),n.transform);return A(e,t,r),e.typedBuffer})),U=e(n.attributes.texCoord0,(t=>{const e=C(m,t.count);return k(e,t),e.typedBuffer})),L=e(n.attributes.color,(t=>{const e=C(l,t.count);if(4===t.elementCount)t instanceof f?D(e,t,255):t instanceof l?y(e,t):t instanceof p&&N(e,t,8);else{B(e,255,255,255,255);const r=new d(e.buffer,0,4);t instanceof c?w(r,t,255):t instanceof d?T(r,t):t instanceof h&&j(r,t,8)}return e.typedBuffer})),O=b({position:x.typedBuffer,normal:t(M),tangent:t(F)},r,{...a,unit:"meters"}),q=function(t,e){switch(e){case 4:return S(t);case 5:return R(t);case 6:return E(t)}}(n.indices||n.attributes.position.count,n.primitiveType);return{vertexAttributes:{position:O.position,normal:O.normal,tangent:O.tangent,uv:t(U),color:t(L)},components:[{faces:q,material:s.get(n.material),trustSourceNormals:!0}],spatialReference:r.spatialReference}}(x,G,r,q)))}function L(t){switch(t){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function O(t){return{horizontal:q(t.s),vertical:q(t.t)}}function q(t){switch(t){case 33071:return"clamp";case 33648:return"mirror";case 10497:return"repeat"}}function z(t){return 255*Math.pow(t,1/x)}export{U as loadGLTFMesh};
