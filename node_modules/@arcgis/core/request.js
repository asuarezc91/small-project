/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import e from"./core/global.js";import r from"./core/has.js";import{clone as t,mixin as s}from"./core/lang.js";import o from"./config.js";import{unwrap as n}from"./core/maybe.js";import a from"./core/Error.js";import{isDataProtocol as i,isBlobProtocol as l,normalize as c,getInterceptor as u,isTrustedServer as d,getOrigin as p,toHTTPS as m,addQueryParameter as f,objectToQuery as h,getProxyRule as w,getProxyUrl as y,addQueryParameters as g,addProxyRule as b,removeFile as q,urlToObject as k}from"./core/urlUtils.js";import{createAbortController as O,onAbort as T,isAbortError as x,createAbortError as S,isAborted as C}from"./core/promiseUtils.js";import{id as v}from"./kernel.js";import{loadImageAsync as E}from"./support/requestUtils.js";async function L(t,s){const m=i(t),f=l(t);f||m||(t=c(t));const h={url:t,requestOptions:{...n(s)}};let w=u(t);if(w){const e=await async function(e,r){if(null!=e.responseData)return e.responseData;e.headers&&(r.requestOptions.headers={...r.requestOptions.headers,...e.headers});e.query&&(r.requestOptions.query={...r.requestOptions.query,...e.query});if(e.before){let t,s;try{s=await e.before(r)}catch(e){t=M("request:interceptor",e,r)}if((s instanceof Error||s instanceof a)&&(t=M("request:interceptor",s,r)),t)throw e.error&&e.error(t),t;return s}}(w,h);if(null!=e)return{data:e,getHeader:I,requestOptions:h.requestOptions,url:h.url};w.after||w.error||(w=null)}if(t=h.url,"image"===(s=h.requestOptions).responseType){if(r("host-webworker")||r("host-node"))throw M("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),h)}else if(m)throw M("request:invalid-parameters",new Error("Data URLs are not supported for responseType = "+s.responseType),h);if("head"===s.method){if(s.body)throw M("request:invalid-parameters",new Error("body parameter cannot be set when method is 'head'"),h);if(m||f)throw M("request:invalid-parameters",new Error("data and blob URLs are not supported for method 'head'"),h)}if(await async function(){r("host-webworker")?j||(j=await import("./core/workers/request.js")):L._abortableFetch||(L._abortableFetch=e.fetch.bind(e))}(),j)return j.execute(t,s);const y=O();T(s,(()=>y.abort()));const g={controller:y,credential:null,credentialToken:null,fetchOptions:null,hasToken:!1,interceptor:w,params:h,redoRequest:!1,useIdentity:U.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1},b=await async function(r){let t,s;await async function(r){const t=r.params.url,s=r.params.requestOptions,n=r.controller.signal,a=s.body;let i=null,l=null,c=null;P&&"HTMLFormElement"in e&&(a instanceof FormData?i=a:a instanceof HTMLFormElement&&(l=a,i=new FormData(l)));"string"==typeof a&&(c=a);r.fetchOptions={cache:s.cacheBust&&!L._abortableFetch.polyfill?"no-cache":"default",credentials:"same-origin",headers:s.headers||{},method:"head"===s.method?"HEAD":"GET",mode:"cors",redirect:"follow",signal:n},(i||c)&&(r.fetchOptions.body=i||c);"anonymous"===s.authMode&&(r.useIdentity=!1);r.hasToken=!!(/token=/i.test(t)||s.query&&s.query.token||i&&i.get&&i.get("token")||l&&l.elements.token);const u=p(t,!0);u&&!r.hasToken&&o.apiKey&&u.endsWith(".arcgis.com")&&"elevation3d.arcgis.com"!==u&&"js.arcgis.com"!==u&&"jsdev.arcgis.com"!==u&&"jsqa.arcgis.com"!==u&&(s.query||(s.query={}),s.query.token=o.apiKey,r.hasToken=!0);if(r.useIdentity&&!r.hasToken&&!r.credentialToken&&!H(t)&&!C(n)){let e;"immediate"===s.authMode?(await R(),e=await v.getCredential(t,{signal:n}),r.credential=e):"no-prompt"===s.authMode?(await R(),e=await v.getCredential(t,{prompt:!1,signal:n}).catch((()=>{})),r.credential=e):v&&(e=v.findCredential(t)),e&&(r.credentialToken=e.token,r.useSSL=!!e.ssl)}}(r);try{do{[t,s]=await A(r)}while(!await N(r,t,s))}catch(e){const s=M("request:server",e,r.params,t);throw s.details.ssl=r.useSSL,r.interceptor&&r.interceptor.error&&r.interceptor.error(s),s}const n=r.params.url;if(/\/sharing\/rest\/(accounts|portals)\/self/i.test(n)&&!r.hasToken&&!r.credentialToken&&s&&s.user&&s.user.username&&!d(n)){const e=p(n,!0);e&&U.trustedServers.push(e)}const a=r.credential;if(a&&v){const e=v.findServerInfo(a.server);let r=e&&e.owningSystemUrl;if(r){r=r.replace(/\/?$/,"/sharing");const e=v.findCredential(r,a.userId);e&&-1===v._getIdenticalSvcIdx(r,e)&&e.resources.unshift(r)}}return{data:s,getHeader:t?e=>t.headers.get(e):I,requestOptions:r.params.requestOptions,ssl:r.useSSL,url:r.params.url}}(g);return w&&w.after&&w.after(b),b}let j;const U=o.request,P="FormData"in e,_=[499,498,403,401],D=["COM_0056","COM_0057","SB_0008"],F=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],I=()=>null;function M(e,r,s,o){let n="Error";const i={url:s.url,requestOptions:s.requestOptions,getHeader:I,ssl:!1};if(r instanceof a)return r.details?(r.details=t(r.details),r.details.url=s.url,r.details.requestOptions=s.requestOptions):r.details=i,r;if(r){const e=o&&(e=>o.headers.get(e)),t=o&&o.status,s=r.message;s&&(n=s),e&&(i.getHeader=e),i.httpStatus=(null!=r.httpCode?r.httpCode:r.code)||t||0,i.subCode=r.subcode,i.messageCode=r.messageCode,"string"==typeof r.details?i.messages=[r.details]:i.messages=r.details}return x(r)?S():new a(e,n,i)}async function R(){v||await import("./identity/IdentityManager.js")}function H(e){return F.some((r=>r.test(e)))}async function A(e){let t=e.params.url;const s=e.params.requestOptions,o=e.fetchOptions,n=l(t)||i(t),a=s.responseType||"json",c=n?0:null!=s.timeout?s.timeout:U.timeout;let u=!1;if(!n){e.useSSL&&(t=m(t)),s.cacheBust&&"default"===o.cache&&(t=f(t,"request.preventCache",Date.now()));let n={...s.query};e.credentialToken&&(n.token=e.credentialToken);let a=h(n);r("esri-url-encodes-apostrophe")&&(a=a.replace(/'/g,"%27"));const i=t.length+1+a.length;let l;u="post"===s.method||!!s.body||i>U.maxUrlLength;const c=s.useProxy||!!w(t);if(c){const e=y(t);l=e.path,!u&&l.length+1+i>U.maxUrlLength&&(u=!0),e.query&&(n={...e.query,...n})}if("HEAD"===o.method&&(u||c)){if(u){if(i>U.maxUrlLength)throw M("request:invalid-parameters",new Error("URL exceeds maximum length"),e.params);throw M("request:invalid-parameters",new Error("cannot use POST request when method is 'head'"),e.params)}if(c)throw M("request:invalid-parameters",new Error("cannot use proxy when method is 'head'"),e.params)}if(u?(o.method="POST",s.body?t=g(t,n):(o.body=h(n),o.headers["Content-Type"]="application/x-www-form-urlencoded")):t=g(t,n),c&&(e.useProxy=!0,t=`${l}?${t}`),n.token&&P&&o.body instanceof FormData){const e=o.body;e.set?e.set("token",n.token):e.append("token",n.token)}if(s.hasOwnProperty("withCredentials"))e.withCredentials=s.withCredentials;else if(d(t))e.withCredentials=!0;else if(v){const r=v.findServerInfo(t);r&&r.webTierAuth&&(e.withCredentials=!0)}e.withCredentials&&(o.credentials="include")}let O,T,x=0,C=!1;c>0&&(x=setTimeout((()=>{C=!0,e.controller.abort()}),c));try{if("image"!==s.responseType||"default"!==o.cache||"GET"!==o.method||u||function(e){if(e)for(const r of Object.getOwnPropertyNames(e))if(e[r])return!0;return!1}(s.headers)||!n&&!e.useProxy&&U.proxyUrl&&!function(e){const r=p(e);return!r||r.endsWith(".arcgis.com")||-1!==L._corsServers.indexOf(r)||d(r)}(t)){if(O=await L._abortableFetch(t,o),e.useProxy||function(e){if(l(e)||i(e))return;const r=p(e);r&&-1===L._corsServers.indexOf(r)&&L._corsServers.push(r)}(t),O.ok&&"HEAD"!==o.method){switch(a){case"array-buffer":T=await O.arrayBuffer();break;case"blob":case"image":T=await O.blob();break;default:T=await O.text()}if(x&&(clearTimeout(x),x=0),"json"===a||"xml"===a||"document"===a)if(T)switch(a){case"json":T=JSON.parse(T);break;case"xml":T=B(T,"application/xml");break;case"document":T=B(T,"text/html")}else T=null;if(T){if("array-buffer"===a||"blob"===a){const e=O.headers.get("Content-Type");if(/application\/json|text\/plain/i.test(e)&&T["blob"===a?"size":"byteLength"]<=750)try{const e=await new Response(T).json();e.error&&(T=e)}catch{}}"image"===a&&T instanceof Blob&&(T=await W(URL.createObjectURL(T),e,!0))}}}else T=await W(t,e)}catch(r){if("AbortError"===r.name){if(C)throw new Error("Timeout exceeded");throw S("Request canceled")}if(!(!O&&r instanceof TypeError&&U.proxyUrl)||s.body||"post"===s.method||"head"===s.method||e.useProxy)throw r;e.redoRequest=!0,b({proxyUrl:U.proxyUrl,urlPrefix:q(k(t).path)})}finally{x&&clearTimeout(x)}return[O,T]}function B(e,r){let t;try{t=(new DOMParser).parseFromString(e,r)}catch{}if(!t||t.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return t}async function N(e,r,t){var o;if(e.redoRequest)return e.redoRequest=!1,!1;if(!r)return!0;if(!r.ok)throw new Error(`Unable to load ${r.url} status: ${r.status}`);let n,a,i,l;t&&t.error&&(n=s(new Error,t.error)),n&&(a=Number(n.code),i=n.hasOwnProperty("subcode")?Number(n.subcode):null,l=n.messageCode,l=l&&l.toUpperCase());const c=e.params.requestOptions.authMode,u=String(null==(o=e.params.requestOptions.query)?void 0:o.token);if(403===a&&(4===i||n.message&&n.message.toLowerCase().indexOf("ssl")>-1&&-1===n.message.toLowerCase().indexOf("permission"))){if(!e.useSSL)return e.useSSL=!0,!1}else if(e.useIdentity&&("no-prompt"!==c||498===a)&&-1!==_.indexOf(a)&&!H(e.params.url)&&!u.startsWith("AAPK")&&(403!==a||-1===D.indexOf(l)&&(null==i||2===i&&e.credentialToken))){await R();try{const r=await v.getCredential(e.params.url,{error:M("request:server",n,e.params),prompt:"no-prompt"!==c,signal:e.controller.signal,token:e.credentialToken});return e.credential=r,e.credentialToken=r.token,e.useSSL=e.useSSL||r.ssl,!1}catch(r){if("no-prompt"===c)return e.credential=null,e.credentialToken=null,!1;n=r}}if(n)throw n;return!0}function W(e,r,t=!1){const s=r.controller.signal,o=new Image;return r.withCredentials?o.crossOrigin="use-credentials":o.crossOrigin="anonymous",o.alt="",o.src=e,E(o,e,t,s)}L._abortableFetch=null,L._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"];export default L;
