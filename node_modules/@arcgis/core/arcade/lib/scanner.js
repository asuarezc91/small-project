/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{assert as e}from"./assert.js";import{Messages as t}from"./messages.js";import{Character as i}from"./character.js";function s(e){return"0123456789abcdef".indexOf(e.toLowerCase())}function n(e){return"01234567".indexOf(e)}class r{constructor(e,t){this.source=e,this.errorHandler=t,this.trackComment=!1,this.isModule=!1,this.length=e.length,this.index=0,this.lineNumber=e.length>0?1:0,this.lineStart=0,this.curlyStack=[]}saveState(){return{index:this.index,lineNumber:this.lineNumber,lineStart:this.lineStart,curlyStack:this.curlyStack.slice()}}restoreState(e){this.index=e.index,this.lineNumber=e.lineNumber,this.lineStart=e.lineStart,this.curlyStack=e.curlyStack}eof(){return this.index>=this.length}throwUnexpectedToken(e=t.UnexpectedTokenIllegal){return this.errorHandler.throwError(this.index,this.lineNumber,this.index-this.lineStart+1,e)}tolerateUnexpectedToken(e=t.UnexpectedTokenIllegal){this.errorHandler.tolerateError(this.index,this.lineNumber,this.index-this.lineStart+1,e)}skipSingleLineComment(e){let t,s,n=[];for(this.trackComment&&(n=[],t=this.index-e,s={start:{line:this.lineNumber,column:this.index-this.lineStart-e},end:{}});!this.eof();){const r=this.source.charCodeAt(this.index);if(++this.index,i.isLineTerminator(r)){if(this.trackComment){s.end={line:this.lineNumber,column:this.index-this.lineStart-1};const i={multiLine:!1,slice:[t+e,this.index-1],range:[t,this.index-1],loc:s};n.push(i)}return 13===r&&10===this.source.charCodeAt(this.index)&&++this.index,++this.lineNumber,this.lineStart=this.index,n}}if(this.trackComment){s.end={line:this.lineNumber,column:this.index-this.lineStart};const i={multiLine:!1,slice:[t+e,this.index],range:[t,this.index],loc:s};n.push(i)}return n}skipMultiLineComment(){let e,t,s=[];for(this.trackComment&&(s=[],e=this.index-2,t={start:{line:this.lineNumber,column:this.index-this.lineStart-2},end:{}});!this.eof();){const n=this.source.charCodeAt(this.index);if(i.isLineTerminator(n))13===n&&10===this.source.charCodeAt(this.index+1)&&++this.index,++this.lineNumber,++this.index,this.lineStart=this.index;else if(42===n){if(47===this.source.charCodeAt(this.index+1)){if(this.index+=2,this.trackComment){t.end={line:this.lineNumber,column:this.index-this.lineStart};const i={multiLine:!0,slice:[e+2,this.index-2],range:[e,this.index],loc:t};s.push(i)}return s}++this.index}else++this.index}if(this.trackComment){t.end={line:this.lineNumber,column:this.index-this.lineStart};const i={multiLine:!0,slice:[e+2,this.index],range:[e,this.index],loc:t};s.push(i)}return this.tolerateUnexpectedToken(),s}scanComments(){let e;this.trackComment&&(e=[]);let t=0===this.index;for(;!this.eof();){let s=this.source.charCodeAt(this.index);if(i.isWhiteSpace(s))++this.index;else if(i.isLineTerminator(s))++this.index,13===s&&10===this.source.charCodeAt(this.index)&&++this.index,++this.lineNumber,this.lineStart=this.index,t=!0;else if(47===s)if(s=this.source.charCodeAt(this.index+1),47===s){this.index+=2;const i=this.skipSingleLineComment(2);this.trackComment&&(e=e.concat(i)),t=!0}else{if(42!==s)break;{this.index+=2;const t=this.skipMultiLineComment();this.trackComment&&(e=e.concat(t))}}else if(t&&45===s){if(45!==this.source.charCodeAt(this.index+1)||62!==this.source.charCodeAt(this.index+2))break;{this.index+=3;const t=this.skipSingleLineComment(3);this.trackComment&&(e=e.concat(t))}}else{if(60!==s||this.isModule)break;if("!--"!==this.source.slice(this.index+1,this.index+4))break;{this.index+=4;const t=this.skipSingleLineComment(4);this.trackComment&&(e=e.concat(t))}}}return e}isFutureReservedWord(e){return!1}isStrictModeReservedWord(e){return!1}isRestrictedWord(e){return!1}isKeyword(e){switch((e=e.toLowerCase()).length){case 2:return"if"===e||"in"===e;case 3:return"var"===e||"for"===e;case 4:return"else"===e;case 5:return"break"===e;case 6:return"return"===e;case 8:return"function"===e||"continue"===e;default:return!1}}codePointAt(e){let t=this.source.charCodeAt(e);if(t>=55296&&t<=56319){const i=this.source.charCodeAt(e+1);if(i>=56320&&i<=57343){t=1024*(t-55296)+i-56320+65536}}return t}scanHexEscape(e){const t="u"===e?4:2;let n=0;for(let e=0;e<t;++e){if(this.eof()||!i.isHexDigit(this.source.charCodeAt(this.index)))return null;n=16*n+s(this.source[this.index++])}return String.fromCharCode(n)}scanUnicodeCodePointEscape(){let e=this.source[this.index],t=0;for("}"===e&&this.throwUnexpectedToken();!this.eof()&&(e=this.source[this.index++],i.isHexDigit(e.charCodeAt(0)));)t=16*t+s(e);return(t>1114111||"}"!==e)&&this.throwUnexpectedToken(),i.fromCodePoint(t)}getIdentifier(){const e=this.index++;for(;!this.eof();){const t=this.source.charCodeAt(this.index);if(92===t)return this.index=e,this.getComplexIdentifier();if(t>=55296&&t<57343)return this.index=e,this.getComplexIdentifier();if(!i.isIdentifierPart(t))break;++this.index}return this.source.slice(e,this.index)}getComplexIdentifier(){let e,t=this.codePointAt(this.index),s=i.fromCodePoint(t);for(this.index+=s.length,92===t&&(117!==this.source.charCodeAt(this.index)&&this.throwUnexpectedToken(),++this.index,"{"===this.source[this.index]?(++this.index,e=this.scanUnicodeCodePointEscape()):(e=this.scanHexEscape("u"),null!==e&&"\\"!==e&&i.isIdentifierStart(e.charCodeAt(0))||this.throwUnexpectedToken()),s=e);!this.eof()&&(t=this.codePointAt(this.index),i.isIdentifierPart(t));)e=i.fromCodePoint(t),s+=e,this.index+=e.length,92===t&&(s=s.substr(0,s.length-1),117!==this.source.charCodeAt(this.index)&&this.throwUnexpectedToken(),++this.index,"{"===this.source[this.index]?(++this.index,e=this.scanUnicodeCodePointEscape()):(e=this.scanHexEscape("u"),null!==e&&"\\"!==e&&i.isIdentifierPart(e.charCodeAt(0))||this.throwUnexpectedToken()),s+=e);return s}octalToDecimal(e){let t="0"!==e,s=n(e);return!this.eof()&&i.isOctalDigit(this.source.charCodeAt(this.index))&&(t=!0,s=8*s+n(this.source[this.index++]),"0123".indexOf(e)>=0&&!this.eof()&&i.isOctalDigit(this.source.charCodeAt(this.index))&&(s=8*s+n(this.source[this.index++]))),{code:s,octal:t}}scanIdentifier(){let e;const i=this.index,s=92===this.source.charCodeAt(i)?this.getComplexIdentifier():this.getIdentifier();if(e=1===s.length?3:this.isKeyword(s)?4:"null"===s.toLowerCase()?5:"true"===s.toLowerCase()||"false"===s.toLowerCase()?1:3,3!==e&&i+s.length!==this.index){const e=this.index;this.index=i,this.tolerateUnexpectedToken(t.InvalidEscapedReservedWord),this.index=e}return{type:e,value:s,lineNumber:this.lineNumber,lineStart:this.lineStart,start:i,end:this.index}}scanPunctuator(){const e=this.index;let t=this.source[this.index];switch(t){case"(":case"{":"{"===t&&this.curlyStack.push("{"),++this.index;break;case".":++this.index,"."===this.source[this.index]&&"."===this.source[this.index+1]&&(this.index+=2,t="...");break;case"}":++this.index,this.curlyStack.pop();break;case")":case";":case",":case"[":case"]":case":":case"?":case"~":++this.index;break;default:t=this.source.substr(this.index,4),">>>="===t?this.index+=4:(t=t.substr(0,3),"==="===t||"!=="===t||">>>"===t||"<<="===t||">>="===t||"**="===t?this.index+=3:(t=t.substr(0,2),"&&"===t||"||"===t||"=="===t||"!="===t||"+="===t||"-="===t||"*="===t||"/="===t||"++"===t||"--"===t||"<<"===t||">>"===t||"&="===t||"|="===t||"^="===t||"%="===t||"<="===t||">="===t||"=>"===t||"**"===t?this.index+=2:(t=this.source[this.index],"<>=!+-*%&|^/".indexOf(t)>=0&&++this.index)))}return this.index===e&&this.throwUnexpectedToken(),{type:7,value:t,lineNumber:this.lineNumber,lineStart:this.lineStart,start:e,end:this.index}}scanHexLiteral(e){let t="";for(;!this.eof()&&i.isHexDigit(this.source.charCodeAt(this.index));)t+=this.source[this.index++];return 0===t.length&&this.throwUnexpectedToken(),i.isIdentifierStart(this.source.charCodeAt(this.index))&&this.throwUnexpectedToken(),{type:6,value:parseInt("0x"+t,16),lineNumber:this.lineNumber,lineStart:this.lineStart,start:e,end:this.index}}scanBinaryLiteral(e){let t,s="";for(;!this.eof()&&(t=this.source[this.index],"0"===t||"1"===t);)s+=this.source[this.index++];return 0===s.length&&this.throwUnexpectedToken(),this.eof()||(t=this.source.charCodeAt(this.index),(i.isIdentifierStart(t)||i.isDecimalDigit(t))&&this.throwUnexpectedToken()),{type:6,value:parseInt(s,2),lineNumber:this.lineNumber,lineStart:this.lineStart,start:e,end:this.index}}scanOctalLiteral(e,t){let s="",n=!1;for(i.isOctalDigit(e.charCodeAt(0))?(n=!0,s="0"+this.source[this.index++]):++this.index;!this.eof()&&i.isOctalDigit(this.source.charCodeAt(this.index));)s+=this.source[this.index++];return n||0!==s.length||this.throwUnexpectedToken(),(i.isIdentifierStart(this.source.charCodeAt(this.index))||i.isDecimalDigit(this.source.charCodeAt(this.index)))&&this.throwUnexpectedToken(),{type:6,value:parseInt(s,8),octal:n,lineNumber:this.lineNumber,lineStart:this.lineStart,start:t,end:this.index}}scanNumericLiteral(){const t=this.index;let s=this.source[t];e(i.isDecimalDigit(s.charCodeAt(0))||"."===s,"Numeric literal must start with a decimal digit or a decimal point");let n="";if("."!==s){if(n=this.source[this.index++],s=this.source[this.index],"0"===n){if("x"===s||"X"===s)return++this.index,this.scanHexLiteral(t);if("b"===s||"B"===s)return++this.index,this.scanBinaryLiteral(t);if("o"===s||"O"===s)return this.scanOctalLiteral(s,t)}for(;i.isDecimalDigit(this.source.charCodeAt(this.index));)n+=this.source[this.index++];s=this.source[this.index]}if("."===s){for(n+=this.source[this.index++];i.isDecimalDigit(this.source.charCodeAt(this.index));)n+=this.source[this.index++];s=this.source[this.index]}if("e"===s||"E"===s)if(n+=this.source[this.index++],s=this.source[this.index],"+"!==s&&"-"!==s||(n+=this.source[this.index++]),i.isDecimalDigit(this.source.charCodeAt(this.index)))for(;i.isDecimalDigit(this.source.charCodeAt(this.index));)n+=this.source[this.index++];else this.throwUnexpectedToken();return i.isIdentifierStart(this.source.charCodeAt(this.index))&&this.throwUnexpectedToken(),{type:6,value:parseFloat(n),lineNumber:this.lineNumber,lineStart:this.lineStart,start:t,end:this.index}}scanStringLiteral(){const s=this.index;let n=this.source[s];e("'"===n||'"'===n,"String literal must starts with a quote"),++this.index;let r=!1,h="";for(;!this.eof();){let e=this.source[this.index++];if(e===n){n="";break}if("\\"===e)if(e=this.source[this.index++],e&&i.isLineTerminator(e.charCodeAt(0)))++this.lineNumber,"\r"===e&&"\n"===this.source[this.index]&&++this.index,this.lineStart=this.index;else switch(e){case"u":if("{"===this.source[this.index])++this.index,h+=this.scanUnicodeCodePointEscape();else{const t=this.scanHexEscape(e);null===t&&this.throwUnexpectedToken(),h+=t}break;case"x":{const i=this.scanHexEscape(e);null===i&&this.throwUnexpectedToken(t.InvalidHexEscapeSequence),h+=i;break}case"n":h+="\n";break;case"r":h+="\r";break;case"t":h+="\t";break;case"b":h+="\b";break;case"f":h+="\f";break;case"v":h+="\v";break;case"8":case"9":h+=e,this.tolerateUnexpectedToken();break;default:if(e&&i.isOctalDigit(e.charCodeAt(0))){const t=this.octalToDecimal(e);r=t.octal||r,h+=String.fromCharCode(t.code)}else h+=e}else{if(i.isLineTerminator(e.charCodeAt(0)))break;h+=e}}return""!==n&&(this.index=s,this.throwUnexpectedToken()),{type:8,value:h,octal:r,lineNumber:this.lineNumber,lineStart:this.lineStart,start:s,end:this.index}}scanTemplate(){let e="",s=!1;const n=this.index,r="`"===this.source[n];let h=!1,c=2;for(++this.index;!this.eof();){let n=this.source[this.index++];if("`"===n){c=1,h=!0,s=!0;break}if("$"===n){if("{"===this.source[this.index]){this.curlyStack.push("${"),++this.index,s=!0;break}e+=n}else if("\\"===n)if(n=this.source[this.index++],i.isLineTerminator(n.charCodeAt(0)))++this.lineNumber,"\r"===n&&"\n"===this.source[this.index]&&++this.index,this.lineStart=this.index;else switch(n){case"n":e+="\n";break;case"r":e+="\r";break;case"t":e+="\t";break;case"u":if("{"===this.source[this.index])++this.index,e+=this.scanUnicodeCodePointEscape();else{const t=this.index,i=this.scanHexEscape(n);null!==i?e+=i:(this.index=t,e+=n)}break;case"x":{const i=this.scanHexEscape(n);null===i&&this.throwUnexpectedToken(t.InvalidHexEscapeSequence),e+=i;break}case"b":e+="\b";break;case"f":e+="\f";break;case"v":e+="\v";break;default:"0"===n?(i.isDecimalDigit(this.source.charCodeAt(this.index))&&this.throwUnexpectedToken(t.TemplateOctalLiteral),e+="\0"):i.isOctalDigit(n.charCodeAt(0))?this.throwUnexpectedToken(t.TemplateOctalLiteral):e+=n}else i.isLineTerminator(n.charCodeAt(0))?(++this.lineNumber,"\r"===n&&"\n"===this.source[this.index]&&++this.index,this.lineStart=this.index,e+="\n"):e+=n}return s||this.throwUnexpectedToken(),r||this.curlyStack.pop(),{type:10,value:this.source.slice(n+1,this.index-c),cooked:e,head:r,tail:h,lineNumber:this.lineNumber,lineStart:this.lineStart,start:n,end:this.index}}testRegExp(e,i){let s=e;i.indexOf("u")>=0&&(s=s.replace(/\\u\{([0-9a-fA-F]+)\}|\\u([a-fA-F0-9]{4})/g,((e,i,s)=>{const n=parseInt(i||s,16);return n>1114111&&this.throwUnexpectedToken(t.InvalidRegExp),n<=65535?String.fromCharCode(n):"￿"})).replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,"￿"));try{RegExp(s)}catch(e){this.throwUnexpectedToken(t.InvalidRegExp)}try{return new RegExp(e,i)}catch(e){return null}}scanRegExpBody(){let s=this.source[this.index];e("/"===s,"Regular expression literal must start with a slash");let n=this.source[this.index++],r=!1,h=!1;for(;!this.eof();)if(s=this.source[this.index++],n+=s,"\\"===s)s=this.source[this.index++],i.isLineTerminator(s.charCodeAt(0))&&this.throwUnexpectedToken(t.UnterminatedRegExp),n+=s;else if(i.isLineTerminator(s.charCodeAt(0)))this.throwUnexpectedToken(t.UnterminatedRegExp);else if(r)"]"===s&&(r=!1);else{if("/"===s){h=!0;break}"["===s&&(r=!0)}return h||this.throwUnexpectedToken(t.UnterminatedRegExp),n.substr(1,n.length-2)}scanRegExpFlags(){let e="",t="";for(;!this.eof();){let s=this.source[this.index];if(!i.isIdentifierPart(s.charCodeAt(0)))break;if(++this.index,"\\"!==s||this.eof())t+=s,e+=s;else if(s=this.source[this.index],"u"===s){++this.index;let i=this.index;const s=this.scanHexEscape("u");if(null!==s)for(t+=s,e+="\\u";i<this.index;++i)e+=this.source[i];else this.index=i,t+="u",e+="\\u";this.tolerateUnexpectedToken()}else e+="\\",this.tolerateUnexpectedToken()}return t}scanRegExp(){const e=this.index,t=this.scanRegExpBody(),i=this.scanRegExpFlags();return{type:9,value:"",pattern:t,flags:i,regex:this.testRegExp(t,i),lineNumber:this.lineNumber,lineStart:this.lineStart,start:e,end:this.index}}lex(){if(this.eof())return{type:2,value:"",lineNumber:this.lineNumber,lineStart:this.lineStart,start:this.index,end:this.index};const e=this.source.charCodeAt(this.index);return i.isIdentifierStart(e)?this.scanIdentifier():40===e||41===e||59===e?this.scanPunctuator():39===e||34===e?this.scanStringLiteral():46===e?i.isDecimalDigit(this.source.charCodeAt(this.index+1))?this.scanNumericLiteral():this.scanPunctuator():i.isDecimalDigit(e)?this.scanNumericLiteral():96===e||125===e&&"${"===this.curlyStack[this.curlyStack.length-1]?this.scanTemplate():e>=55296&&e<57343&&i.isIdentifierStart(this.codePointAt(this.index))?this.scanIdentifier():this.scanPunctuator()}}export{r as Scanner};
