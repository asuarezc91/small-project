/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as t,unwrap as e}from"../core/maybe.js";import i from"../geometry/Geometry.js";import r from"../geometry/Point.js";import{fromJSON as s}from"../geometry/support/jsonUtils.js";import a from"./ImmutableArray.js";import{i as o,a as n,b as l,t as u,j as h,f,k as y,l as d,m as _}from"../chunks/languageUtils.js";import c from"./Dictionary.js";import{esriFieldToJson as m,layerGeometryEsriRestConstants as p}from"./featureset/support/shared.js";import{convertToGeometry as b}from"../layers/graphics/featureConversionUtils.js";class g{constructor(){this.declaredClass="esri.arcade.Feature",this._optimizedGeomDefinition=null,this._geometry=null,this.attributes=null,this._layer=null,this._datesfixed=!0,this.immutable=!0,this._datefields=null,this.immutable=!0}static createFromGraphic(e){const i=new g;return i._geometry=t(e.geometry)?e.geometry:null,void 0===e.attributes||null===e.attributes?i.attributes={}:i.attributes=e.attributes,e._sourceLayer?(i._layer=e._sourceLayer,i._datesfixed=!1):e._layer?(i._layer=e._layer,i._datesfixed=!1):e.layer?(i._layer=e.layer,i._datesfixed=!1):e.sourceLayer&&(i._layer=e.sourceLayer,i._datesfixed=!1),i}static createFromArcadeFeature(t){const e=new g;return e._datesfixed=t._datesfixed,e.attributes=t.attributes,e._geometry=t._geometry,e._optimizedGeomDefinition=t._optimizedGeomDefinition,t._layer&&(e._layer=t._layer),e}static createFromOptimisedFeature(t,e,i){const r=new g;return r._geometry=t.geometry?{geometry:t.geometry}:null,r._optimizedGeomDefinition=i,r.attributes=t.attributes||{},r._layer=e,r._datesfixed=!1,r}static createFromArcadeDictionary(t){const e=new g;return e.attributes=t.field("attributes"),null!==e.attributes&&e.attributes instanceof c?(e.attributes=e.attributes.attributes,null===e.attributes&&(e.attributes={})):e.attributes={},e._geometry=t.field("geometry"),null!==e._geometry&&(e._geometry instanceof c?e._geometry=g.parseGeometryFromDictionary(e._geometry):e._geometry instanceof i||(e._geometry=null)),e}static createFromGraphicLikeObject(e,i,r=null){const s=new g;return null===i&&(i={}),s.attributes=i,s._geometry=t(e)?e:null,s._layer=r,s._layer&&(s._datesfixed=!1),s._adapter=null,s}repurposeFromGraphicLikeObject(t,e,i=null){null===e&&(e={}),this.attributes=e,this._geometry=t||null,this._layer=i,this._layer?this._datesfixed=!1:this._datesfixed=!0}repurposeFromAdapter(t,e=null){this._adapter=t,this._layer=e}castToText(){if(this._adapter)return this._adapter.castToText();let t="";!1===this._datesfixed&&this._fixDates();for(const e in this.attributes){""!==t&&(t+=",");const r=this.attributes[e];null==r?t+=JSON.stringify(e)+":null":o(r)||n(r)||l(r)?t+=JSON.stringify(e)+":"+JSON.stringify(r):r instanceof i||r instanceof a||r instanceof Array?t+=JSON.stringify(e)+":"+u(r):r instanceof Date?t+=JSON.stringify(e)+":"+JSON.stringify(r):null!==r&&"object"==typeof r&&void 0!==r.castToText&&(t+=JSON.stringify(e)+":"+r.castToText())}return'{"geometry":'+(null===this.geometry()?"null":u(this.geometry()))+',"attributes":{'+t+"}}"}_fixDates(){if(null!==this._datefields)return this._datefields.length>0&&this._fixDateFields(this._datefields),void(this._datesfixed=!0);const t=[];for(let e=0;e<this._layer.fields.length;e++){const i=this._layer.fields[e];"date"!==i.type&&"esriFieldTypeDate"!==i.type||t.push(i.name)}this._datefields=t,t.length>0&&this._fixDateFields(t),this._datesfixed=!0}_fixDateFields(t){this.attributes={...this.attributes};for(let e=0;e<t.length;e++){let i=this.attributes[t[e]];if(null===i);else if(void 0===i){for(const r in this.attributes)if(r.toLowerCase()===t[e].toLowerCase()){i=this.attributes[r],null!==i&&(i instanceof Date||(this.attributes[r]=new Date(i)));break}}else i instanceof Date||(this.attributes[t[e]]=new Date(i))}}geometry(){return this._adapter?this._adapter.geometry():(null===this._geometry||this._geometry instanceof i||(this._optimizedGeomDefinition?(this._geometry=e(s(b(this._geometry,this._optimizedGeomDefinition.geometryType,this._optimizedGeomDefinition.hasZ,this._optimizedGeomDefinition.hasM))),this._geometry.spatialReference=this._optimizedGeomDefinition.spatialReference):this._geometry=e(s(this._geometry))),this._geometry)}field(t){if(this._adapter)return this._adapter.field(t);!1===this._datesfixed&&this._fixDates();const e=this.attributes[t];if(void 0!==e)return e;const i=t.toLowerCase();for(const t in this.attributes)if(t.toLowerCase()===i)return this.attributes[t];if(this._hasFieldDefinition(i))return null;throw new Error("Field not Found : "+t)}_hasFieldDefinition(t){if(null===this._layer)return!1;for(let e=0;e<this._layer.fields.length;e++){if(this._layer.fields[e].name.toLowerCase()===t)return!0}return!1}_field(t){var e;if(this._adapter)return null!=(e=this._adapter.field(t))?e:null;!1===this._datesfixed&&this._fixDates();const i=t.toLowerCase(),r=this.attributes[t];if(void 0!==r)return r;for(const t in this.attributes)if(t.toLowerCase()===i)return this.attributes[t];return null}setField(t,e){if(this.immutable)throw new Error("Feature is Immutable");if(!1===h(e))throw new Error("Illegal Value Assignment to Feature");if(this._adapter)return void this._adapter.setField(t,e);const i=t.toLowerCase();if(void 0===this.attributes[t]){for(const t in this.attributes)if(t.toLowerCase()===i)return void(this.attributes[t]=e);this.attributes[t]=e}else this.attributes[t]=e}hasField(t){if(this._adapter)return this._adapter.hasField(t);const e=t.toLowerCase();if(void 0!==this.attributes[t])return!0;for(const t in this.attributes)if(t.toLowerCase()===e)return!0;return!!this._hasFieldDefinition(e)}keys(){if(this._adapter)return this._adapter.keys();let t=[];const e={};for(const i in this.attributes)t.push(i),e[i.toLowerCase()]=1;if(null!==this._layer)for(let i=0;i<this._layer.fields.length;i++){const r=this._layer.fields[i];1!==e[r.name.toLowerCase()]&&t.push(r.name)}return t=t.sort(),t}static parseGeometryFromDictionary(t){const e=g.convertDictionaryToJson(t,!0);return void 0!==e.hasm&&(e.hasM=e.hasm,delete e.hasm),void 0!==e.hasz&&(e.hasZ=e.hasz,delete e.hasz),void 0!==e.spatialreference&&(e.spatialReference=e.spatialreference,delete e.spatialreference),void 0!==e.rings&&(e.rings=this.fixPathArrays(e.rings,!0===e.hasZ,!0===e.hasZ)),void 0!==e.paths&&(e.paths=this.fixPathArrays(e.paths,!0===e.hasZ,!0===e.hasM)),void 0!==e.points&&(e.points=this.fixPointArrays(e.points,!0===e.hasZ,!0===e.hasM)),s(e)}static fixPathArrays(t,e,i){const r=[];if(t instanceof Array)for(let s=0;s<t.length;s++)r.push(this.fixPointArrays(t[s],e,i));else if(t instanceof a)for(let s=0;s<t.length();s++)r.push(this.fixPointArrays(t.get(s),e,i));return r}static fixPointArrays(t,e,i){const s=[];if(t instanceof Array)for(let o=0;o<t.length;o++){const n=t[o];n instanceof r?e&&i?s.push([n.x,n.y,n.z,n.m]):e?s.push([n.x,n.y,n.z]):i?s.push([n.x,n.y,n.m]):s.push([n.x,n.y]):n instanceof a?s.push(n.toArray()):s.push(n)}else if(t instanceof a)for(let o=0;o<t.length();o++){const n=t.get(o);n instanceof r?e&&i?s.push([n.x,n.y,n.z,n.m]):e?s.push([n.x,n.y,n.z]):i?s.push([n.x,n.y,n.m]):s.push([n.x,n.y]):n instanceof a?s.push(n.toArray()):s.push(n)}return s}static convertDictionaryToJson(t,e=!1){const i={};for(const r in t.attributes){let s=t.attributes[r];s instanceof c&&(s=g.convertDictionaryToJson(s)),e?i[r.toLowerCase()]=s:i[r]=s}return i}static parseAttributesFromDictionary(t){const e={};for(const i in t.attributes){const r=t.attributes[i];if(!h(r))throw new Error("Illegal Argument");e[i]=r}return e}static fromJson(t){let e=null;null!==t.geometry&&void 0!==t.geometry&&(e=s(t.geometry));const i={};if(null!==t.attributes&&void 0!==t.attributes)for(const e in t.attributes){const r=t.attributes[e];if(null===r)i[e]=r;else{if(!(l(r)||n(r)||o(r)||f(r)))throw new Error("Illegal Argument");i[e]=r}}return g.createFromGraphicLikeObject(e,i,null)}fullDomain(t,e){if(null===this._layer)return null;if(!this._layer.fields)return null;return y(t,this._layer,this,e)}subtypes(){return null===this._layer?null:this._layer.fields&&this._layer.typeIdField?{subtypeField:this._layer.typeIdField,subtypes:this._layer.types?this._layer.types.map((t=>({name:t.name,code:t.id}))):[]}:null}domainValueLookup(t,e,i){if(null===this._layer)return null;if(!this._layer.fields)return null;const r=y(t,this._layer,this,i);if(void 0===e)try{e=this.field(t)}catch(t){return null}return d(r,e)}gdbVersion(){if(null===this._layer)return"";const t=this._layer.gdbVersion;return void 0===t?"":""===t&&this._layer.capabilities&&this._layer.capabilities.isVersioned?"SDE.DEFAULT":t}domainCodeLookup(t,e,i){if(null===this._layer)return null;if(!this._layer.fields)return null;if(void 0===e){try{e=this.field(t)}catch(t){return null}return e}const r=y(t,this._layer,this,i);return _(r,e)}schema(){if(null===this._layer)return null;if(!this._layer.fields)return null;const t=[];for(const e of this._layer.fields)t.push(m(e));return{objectIdField:this._layer.objectIdField,globalIdField:this._layer.globalIdField,geometryType:void 0===p[this._layer.geometryType]?"":p[this._layer.geometryType],fields:t}}}export default g;
