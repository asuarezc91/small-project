/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{resolve as e,reject as t}from"../../../core/promiseUtils.js";import r from"../../../geometry/SpatialReference.js";import s from"../../../Graphic.js";import{cloneField as i,FeatureServiceDatabaseType as a,layerGeometryEsriConstants as l}from"../support/shared.js";import{cloneGeometry as n}from"../../kernel.js";import o from"../support/IdSet.js";import{WhereClause as h}from"../../../core/sql/WhereClause.js";import{reformulateWithoutField as u,toWhereClause as d,translateFunctionToDatabaseSpecific as c,makeToday as p,makeDateString as f,convertIntervalToSql as g,combine as _,scanForField as N}from"../support/sqlUtils.js";import S from"../support/FeatureSet.js";class m{constructor(){this.sqlRewritable=!1}postInitialization(e,t){}}class w extends m{constructor(e){super(),this.field=e,this.sqlRewritable=!0}extractValue(e){return e.attributes[this.field.name]}rewriteSql(e){return{rewritten:this.sqlRewritable,where:e}}}class v extends m{constructor(e,t,r){super(),this.originalField=e,this.sqlRewritable=!0,this.field=i(e),this.field.name=t,this.field.alias=r}rewriteSql(e,t){return{rewritten:this.sqlRewritable,where:u(e,this.field.name,this.originalField.name,t.getFieldsIndex())}}extractValue(e){return e.attributes[this.originalField.name]}}class C extends m{constructor(e,t,r){super(),this.field=e,this.codefield=t,this.lkp=r,this.reverseLkp={};for(const e in r)this.reverseLkp[r[e]]=e;this.sqlRewritable=!0}rewriteSql(e,t){const r=this.evaluateNodeToWhereClause(e.parseTree,a.Standardised,this.field.name,this.codefield instanceof h?d(this.codefield,a.Standardised):this.codefield,e.parameters);return r.indexOf(C.BADNESS)>=0?{rewritten:!1,where:e}:{rewritten:this.sqlRewritable,where:h.create(r,t._parent.getFieldsIndex())}}evaluateNodeToWhereClause(e,t,r=null,s=null,i){let a,l,n,o;switch(e.type){case"interval":return g(this.evaluateNodeToWhereClause(e.value,t,r,s,i),e.qualifier,e.op);case"case_expression":{let s=" CASE ";"simple"===e.format&&(s+=this.evaluateNodeToWhereClause(e.operand,t,r,C.BADNESS,i));for(let a=0;a<e.clauses.length;a++)s+=" WHEN "+this.evaluateNodeToWhereClause(e.clauses[a].operand,t,r,C.BADNESS,i)+" THEN "+this.evaluateNodeToWhereClause(e.clauses[a].value,t,r,C.BADNESS,i);return null!==e.else&&(s+=" ELSE "+this.evaluateNodeToWhereClause(e.else,t,r,C.BADNESS,i)),s+=" END ",s}case"param":{const r=i[e.value.toLowerCase()];if("string"==typeof r){return"'"+i[e.value.toLowerCase()].toString().replace(/'/g,"''")+"'"}if(r instanceof Date)return f(r,t);if(r instanceof Array){const e=[];for(let s=0;s<r.length;s++)"string"==typeof r[s]?e.push("'"+r[s].toString().replace(/'/g,"''")+"'"):r[s]instanceof Date?e.push(f(r[s],t)):e.push(r[s].toString());return e}return r.toString()}case"expr_list":l=[];for(const a of e.value)l.push(this.evaluateNodeToWhereClause(a,t,r,s,i));return l;case"unary_expr":return" ( NOT "+this.evaluateNodeToWhereClause(e.expr,t,r,C.BADNESS,i)+" ) ";case"binary_expr":switch(e.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(e.left,t,r,s,i)+" AND "+this.evaluateNodeToWhereClause(e.right,t,r,s,i)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(e.left,t,r,s,i)+" OR "+this.evaluateNodeToWhereClause(e.right,t,r,s,i)+") ";case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,t,r,s,i)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,t,r,s,i)+" IS NOT NULL )";case"IN":if(a=[],"expr_list"===e.right.type){if("column_ref"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){const a=[];let l=!0;for(const t of e.right.value){if("string"!==t.type){l=!1;break}if(void 0===this.lkp[t.value]){l=!1;break}a.push(this.lkp[t.value].toString())}if(l)return" ("+this.evaluateNodeToWhereClause(e.left,t,r,s,i)+" IN ("+a.join(",")+")) "}return a=this.evaluateNodeToWhereClause(e.right,t,r,s,i)," ("+this.evaluateNodeToWhereClause(e.left,t,r,s,i)+" IN ("+a.join(",")+")) "}return o=this.evaluateNodeToWhereClause(e.right,t,r,s,i),o instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,t,r,s,i)+" IN ("+o.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,t,r,s,i)+" IN ("+o+")) ";case"NOT IN":if(a=[],"expr_list"===e.right.type){if("column_ref"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){const a=[];let l=!0;for(const t of e.right.value){if("string"!==t.type){l=!1;break}if(void 0===this.lkp[t.value]){l=!1;break}a.push(this.lkp[t.value].toString())}if(l)return" ("+this.evaluateNodeToWhereClause(e.left,t,r,s,i)+" NOT IN ("+a.join(",")+")) "}return a=this.evaluateNodeToWhereClause(e.right,t,r,s,i)," ("+this.evaluateNodeToWhereClause(e.left,t,r,s,i)+" NOT IN ("+a.join(",")+")) "}return o=this.evaluateNodeToWhereClause(e.right,t,r,s,i),o instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,t,r,s,i)+" NOT IN ("+o.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,t,r,s,i)+" NOT IN ("+o+")) ";case"BETWEEN":return n=this.evaluateNodeToWhereClause(e.right,t,r,C.BADNESS,i)," ("+this.evaluateNodeToWhereClause(e.left,t,r,C.BADNESS,i)+" BETWEEN "+n[0]+" AND "+n[1]+" ) ";case"NOTBETWEEN":return n=this.evaluateNodeToWhereClause(e.right,t,r,C.BADNESS,i)," ("+this.evaluateNodeToWhereClause(e.left,t,r,C.BADNESS,i)+" NOT BETWEEN "+n[0]+" AND "+n[1]+" ) ";case"LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,t,r,C.BADNESS,i)+" LIKE "+this.evaluateNodeToWhereClause(e.right,t,r,C.BADNESS,i)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,t,r,C.BADNESS,i)+" LIKE "+this.evaluateNodeToWhereClause(e.right,t,r,C.BADNESS,i)+") ";case"NOT LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,t,r,C.BADNESS,i)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,t,r,C.BADNESS,i)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,t,r,C.BADNESS,i)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,t,r,C.BADNESS,i)+") ";case"<>":case"=":if("column_ref"===e.left.type&&"string"===e.right.type){if(e.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[e.right.value.toString()])return" ("+s+" "+e.operator+" "+this.lkp[e.right.value.toString()].toString()+") "}else if("column_ref"===e.right.type&&"string"===e.left.type&&e.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[e.right.value.toString()].toString()+" "+e.operator+" "+s+") ";return" ("+this.evaluateNodeToWhereClause(e.left,t,r,C.BADNESS,i)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,t,r,C.BADNESS,i)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":return" ("+this.evaluateNodeToWhereClause(e.left,t,r,C.BADNESS,i)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,t,r,C.BADNESS,i)+") "}throw new Error("Not Supported Operator "+e.operator);case"null":return"null";case"bool":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return f(e.value,t);case"number":return e.value.toString();case"current_time":return p("date"===e.mode,t);case"column_ref":return r&&r.toLowerCase()===e.column.toLowerCase()?"("+s+")":e.column;case"function":{const s=this.evaluateNodeToWhereClause(e.args,t,r,C.BADNESS,i);return c(e.name,s,t)}}throw new Error("Unsupported sql syntax "+e.type)}extractValue(e){return this.codefield instanceof h?this.reverseLkp[this.codefield.calculateValueCompiled(e)]:this.reverseLkp[e.attributes[this.codefield]]}}C.BADNESS="_!!!_BAD_LKP_!!!!";class T extends m{constructor(e,t){super(),this.field=e,this.sql=t}rewriteSql(e,t){return{rewritten:!0,where:u(e,this.field.name,d(this.sql,a.Standardised),t.getFieldsIndex())}}extractValue(e){return this.sql.calculateValueCompiled(e)}}class E extends S{constructor(e){super(e),this._calcFunc=null,this.declaredClass="esri.arcade.featureset.actions.Adapted",this.adaptedFields=null,this._extraFilter=null,this._extraFilter=e.extraFilter,this._parent=e.parentfeatureset,this._maxProcessing=30,this.adaptedFields=e.adaptedFields}static findField(e,t){for(const r of e)if(r.name.toLowerCase()===t.toString().toLowerCase())return r;return null}_initialiseFeatureSet(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new r({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=l.point,this.typeIdField="",this.types=null),this.fields=[];for(const e of this.adaptedFields)e.postInitialization(this,this._parent),this.fields.push(e.field)}_getSet(t){return null===this._wset?this._ensureLoaded().then((()=>this._extraFilter?this._getFilteredSet("",null,null,null,t):this._parent._getSet(t))).then((e=>(this._checkCancelled(t),this._wset=new o(e._candidates.slice(0),e._known.slice(0),e._ordered,this._clonePageDefinition(e.pagesDefinition)),this._wset))):e(this._wset)}_isInFeatureSet(e){return this._parent._isInFeatureSet(e)}_getFeatures(t,r,i,a){const l=[];-1!==r&&void 0===this._featureCache[r]&&l.push(r);const h=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(t,h))return this._expandPagedSet(t,h,0,0,a).then((()=>this._getFeatures(t,r,i,a)));let u=0;for(let e=t._lastFetchedIndex;e<t._known.length&&(u++,u<=i&&(t._lastFetchedIndex+=1),!(void 0===this._featureCache[t._known[e]]&&(t._known[e]!==r&&l.push(t._known[e]),l.length>=h-1)));e++);if(0===l.length)return e("success");t=new o([],l,t._ordered,null);const d=Math.min(l.length,i);return this._parent._getFeatures(t,-1,d,a).then((()=>{this._checkCancelled(a);const e=[];for(let t=0;t<d;t++){const r=this._parent._featureFromCache(l[t]);void 0!==r&&e.push({geometry:r.geometry,attributes:r.attributes,id:l[t]})}for(const t of e){const e=[];for(const r of this.adaptedFields)e[r.field.name]=r.extractValue(t);this._featureCache[t.id]=new s({attributes:e,geometry:n(t.geometry)})}return"success"}))}_fetchAndRefineFeatures(){return t(new Error("Fetch and Refine should not be called in this featureset"))}_getFilteredSet(e,t,r,s,i){let a=!1;const l=this.reformulateWithoutAdaptions(r);a=l.cannot,r=l.where;let n=!1;if(null!==s){n=!0;const e=[];for(const t of this.adaptedFields)if(!(t instanceof w)&&!0===s.scanForField(t.field.name)){if(!(t instanceof v)){s=null,n=!1;break}e.push({field:t.field.name,newfield:t.originalField.name})}s&&e.length>0&&(s=s.replaceFields(e))}return null!==r?null!==this._extraFilter&&(r=_(this._extraFilter,r)):r=this._extraFilter,this._ensureLoaded().then((()=>this._parent._getFilteredSet(e,t,r,s,i))).then((e=>{let t;return this._checkCancelled(i),t=!0===a?new o(e._candidates.slice(0).concat(e._known.slice(0)),[],!0===n&&e._ordered,this._clonePageDefinition(e.pagesDefinition)):new o(e._candidates.slice(0),e._known.slice(0),!0===n&&e._ordered,this._clonePageDefinition(e.pagesDefinition)),t}))}reformulateWithoutAdaptions(e){const t={cannot:!1,where:e};if(null!==e)for(const r of this.adaptedFields)if(!0===N(e,r.field.name)){const s=r.rewriteSql(e,this);if(!0!==s.rewritten){t.cannot=!0,t.where=null;break}t.where=s.where}return t}_stat(t,r,s,i,a,l,n){let o=!1,h=this.reformulateWithoutAdaptions(r);return o=h.cannot,r=h.where,h=this.reformulateWithoutAdaptions(a),o=o||h.cannot,null!==(a=h.where)?null!==this._extraFilter&&(a=_(this._extraFilter,a)):a=this._extraFilter,!0===o?null===a&&""===s&&null===i?this._manualStat(t,r,l,n):e({calculated:!1}):this._parent._stat(t,r,s,i,a,l,n).then((e=>!1===e.calculated?null===a&&""===s&&null===i?this._manualStat(t,r,l,n):{calculated:!1}:e))}_canDoAggregates(t,r,s,i,a){if(null===this._parent)return e(!1);for(let r=0;r<t.length;r++)for(const s of this.adaptedFields)if(t[r].toLowerCase()===s.field.name.toLowerCase()&&!(s instanceof w))return e(!1);const l=[];for(let t=0;t<r.length;t++){const s=r[t];if(null!==s.workingexpr){const t=this.reformulateWithoutAdaptions(s.workingexpr);if(t.cannot)return e(!1);const r=s.clone();r.workingexpr=t.where,l.push(r)}else l.push(s)}const n=this.reformulateWithoutAdaptions(a);return n.cannot?e(!1):(null!==(a=n.where)?null!==this._extraFilter&&(a=_(this._extraFilter,a)):a=this._extraFilter,this._parent._canDoAggregates(t,l,s,i,a))}_getAggregatePagesDataSourceDefinition(e,r,s,i,a,l,n){if(null===this._parent)return t(new Error("Should never be called"));const o=[];for(let e=0;e<r.length;e++){const s=r[e];if(null!==s.workingexpr){const e=this.reformulateWithoutAdaptions(s.workingexpr);if(e.cannot)return t(new Error("Should never be called"));const r=s.clone();r.workingexpr=e.where,o.push(r)}else o.push(s)}const h=this.reformulateWithoutAdaptions(a);return h.cannot?t(new Error("Should never be called")):(null!==(a=h.where)?null!==this._extraFilter&&(a=_(this._extraFilter,a)):a=this._extraFilter,this._parent._getAggregatePagesDataSourceDefinition(e,o,s,i,a,l,n))}}export{E as AdaptedFeatureSet,m as AdaptedField,v as FieldRename,w as OriginalField,T as SqlExpressionAdapted,C as StringToCodeAdapted};
