/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import e from"../../../core/Error.js";import{WhereClauseCache as i}from"../../../core/sql/WhereClauseCache.js";const s=new i(50,500),n="feature-store:unsupported-query",t=new Set(["esriFieldTypeOID","esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong","esriFieldTypeDate"]);function r(i,t){if(!t)return!0;const r=s.get(t,i);if(!r)throw new e(n,"invalid SQL expression",{where:t});if(!r.isStandardized)throw new e(n,"where clause is not standard",{where:t});return l(i,r.fieldNames,"where clause contains missing fields"),!0}function o(i,t,r){if(!t)return!0;const o=s.get(t,i);if(!o)throw new e(n,"invalid SQL expression",{having:t});if(!o.isAggregate)throw new e(n,"having does not contain a valid aggregate function",{having:t});const a=o.fieldNames;l(i,a,"having contains missing fields");if(!o.getExpressions().every((e=>{const{aggregateType:s,field:n}=e,t=i.has(n)&&i.get(n).name;return r.some((e=>{const{onStatisticField:n,statisticType:r}=e;return(i.has(n)&&i.get(n).name)===t&&r.toLowerCase().trim()===s}))})))throw new e(n,"expressions in having should also exist in outStatistics",{having:t});return!0}function a(e,i){return e?s.get(e,i):null}function l(i,s,t,r=!0){const o=[];for(const t of s)if("*"!==t&&!i.has(t))if(r){const s=c(t);try{const t=a(s,i);if(!t)throw new e(n,"invalid SQL expression",{where:s});if(!t.isStandardized)throw new e(n,"expression is not standard",{clause:t});l(i,t.fieldNames,"expression contains missing fields")}catch(e){const i=e&&e.details;if(i&&(i.clause||i.where))throw e;i&&i.missingFields?o.push(...i.missingFields):o.push(t)}}else o.push(t);if(o.length)throw new e(n,t,{missingFields:o})}function c(e){return e.split(" as ")[0]}function d(e){return e.split(" as ")[1]}function u(e,i){const s=i.get(e);return!!s&&!t.has(s.type)}export{d as getAliasFromFieldName,c as getExpressionFromFieldName,a as getWhereClause,u as hasInvalidFieldType,l as validateFields,o as validateHaving,r as validateWhere};
