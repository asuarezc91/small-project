/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../core/has.js";import{clone as r}from"../core/lang.js";import{isSome as t}from"../core/maybe.js";import s from"../core/Logger.js";import"../core/accessorSupport/ensureType.js";import{property as i}from"../core/accessorSupport/decorators/property.js";import{reader as o}from"../core/accessorSupport/decorators/reader.js";import{subclass as a}from"../core/accessorSupport/decorators/subclass.js";import l from"../core/Error.js";import{join as n}from"../core/urlUtils.js";import"../core/uuid.js";import"../portal/support/resourceExtension.js";import{resolve as p}from"../core/promiseUtils.js";import u from"../geometry/SpatialReference.js";import y from"../geometry/Extent.js";import d from"../core/Collection.js";import{loadAll as c}from"../core/loadAll.js";import m from"../core/CollectionFlattener.js";import h from"./Layer.js";import{MultiOriginJSONMixin as b}from"../core/MultiOriginJSONSupport.js";import{readOnlyService as f,elevationInfo as v}from"./support/commonProperties.js";import{OperationalLayer as S}from"./mixins/OperationalLayer.js";import{ArcGISService as g}from"./mixins/ArcGISService.js";import{PortalLayer as j}from"./mixins/PortalLayer.js";import{ScaleRangeLayer as w}from"./mixins/ScaleRangeLayer.js";import O from"./buildingSublayers/BuildingComponentSublayer.js";import I from"./buildingSublayers/BuildingGroupSublayer.js";import{SceneService as L}from"./mixins/SceneService.js";import x from"./support/BuildingFilter.js";import T from"./support/BuildingSummaryStatistics.js";import{FetchAssociatedFeatureLayer as E}from"./support/FetchAssociatedFeatureLayer.js";const F=s.getLogger("esri.layers.BuildingSceneLayer"),B=d.ofType(x),_=r(I.sublayersProperty);_.json.origins["web-scene"]={type:[O],write:{enabled:!0,overridePolicy:()=>({enabled:!1})}},_.json.origins["portal-item"]={type:[O],write:{enabled:!0,overridePolicy:()=>({enabled:!1})}};let A=class extends(L(g(S(j(w(b(h))))))){constructor(e){super(e),this.operationalLayerType="BuildingSceneLayer",this.allSublayers=new m({root:this,rootCollectionNames:["sublayers"],getChildrenFunction:e=>"building-group"===e.type?e.sublayers:null}),this.sublayers=null,this.sublayerOverrides=null,this.filters=new B,this.activeFilterId=null,this.summaryStatistics=null,this.outFields=null,this.type="building-scene"}normalizeCtorArgs(e){return"string"==typeof e?{url:e}:e}destroy(){this.allSublayers.destroy()}readSublayers(e,r,t){const s=I.readSublayers(e,r,t);return I.forEachSublayer(s,(e=>e.layer=this)),this.sublayerOverrides&&(this.applySublayerOverrides(s,this.sublayerOverrides),this.sublayerOverrides=null),s}applySublayerOverrides(e,{overrides:r,context:t}){I.forEachSublayer(e,(e=>e.read(r.get(e.id),t)))}readSublayerOverrides(e,r){const t=new Map;for(const s of e)null!=s&&"object"==typeof s&&"number"==typeof s.id?t.set(s.id,s):r.messages.push(new l("building-scene-layer:invalid-sublayer-override","Invalid value for sublayer override. Not an object or no id specified.",{value:s}));return{overrides:t,context:r}}writeSublayerOverrides(e,r,t){const s=[];I.forEachSublayer(this.sublayers,(e=>{const r=e.write({},t);Object.keys(r).length>1&&s.push(r)})),s.length>0&&(r.sublayers=s)}writeUnappliedOverrides(e,t){t.sublayers=[],e.overrides.forEach((e=>{t.sublayers.push(r(e))}))}write(e,r){return e=super.write(e,r),!r||"web-scene"!==r.origin&&"portal-item"!==r.origin||(this.sublayers?this.writeSublayerOverrides(this.sublayers,e,r):this.sublayerOverrides&&this.writeUnappliedOverrides(this.sublayerOverrides,e)),e}read(e,r){if(super.read(e,r),r&&("web-scene"===r.origin||"portal-item"===r.origin)&&null!=e&&Array.isArray(e.sublayers)){const t=this.readSublayerOverrides(e.sublayers,r);this.sublayers?this.applySublayerOverrides(this.sublayers,t):this.sublayerOverrides=t}}readSummaryStatistics(e,r){if("string"==typeof r.statisticsHRef){const e=n(this.parsedUrl.path,r.statisticsHRef);return new T({url:e})}return null}set elevationInfo(e){this._set("elevationInfo",e),this._validateElevationInfo()}load(e){const r=t(e)?e.signal:null,s=this.loadFromPortal({supportedTypes:["Scene Service"]},e).catch((()=>{})).then((()=>this._fetchService(r))).then((()=>this._fetchAssociatedFeatureService(r)));return this.addResolvingPromise(s),p(this)}loadAll(){return c(this,(e=>{I.forEachSublayer(this.sublayers,(r=>{"building-group"!==r.type&&e(r)})),this.summaryStatistics&&e(this.summaryStatistics)}))}async saveAs(e,r){return this._debouncedSaveOperations(1,{...r,getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:"building-scene"},e)}async save(){const e={getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:"building-scene"};return this._debouncedSaveOperations(0,e)}validateLayer(e){if(!e.layerType||"Building"!==e.layerType)throw new l("buildingscenelayer:layer-type-not-supported","BuildingSceneLayer does not support this layer type",{layerType:e.layerType})}_getTypeKeywords(){return["Building"]}_validateElevationInfo(){const e=this.elevationInfo;e&&("absolute-height"!==e.mode&&F.warn(".elevationInfo=","Building scene layers only support absolute-height elevation mode"),e.featureExpressionInfo&&"0"!==e.featureExpressionInfo.expression&&F.warn(".elevationInfo=","Building scene layers do not support featureExpressionInfo"))}async _fetchAssociatedFeatureService(e){const r=new E(this.parsedUrl,this.portalItem,e);try{this.associatedFeatureServiceItem=await r.fetchPortalItem()}catch(e){F.warn("Associated feature service item could not be loaded",e)}}};e([i({type:["BuildingSceneLayer"]})],A.prototype,"operationalLayerType",void 0),e([i({readOnly:!0})],A.prototype,"allSublayers",void 0),e([i(_)],A.prototype,"sublayers",void 0),e([o("service","sublayers")],A.prototype,"readSublayers",null),e([i({type:B,nonNullable:!0,json:{write:!0}})],A.prototype,"filters",void 0),e([i({type:String,json:{write:!0}})],A.prototype,"activeFilterId",void 0),e([i({readOnly:!0,type:T})],A.prototype,"summaryStatistics",void 0),e([o("summaryStatistics",["statisticsHRef"])],A.prototype,"readSummaryStatistics",null),e([i({type:[String],json:{read:!1}})],A.prototype,"outFields",void 0),e([i(f(y))],A.prototype,"fullExtent",void 0),e([i({type:["show","hide","hide-children"]})],A.prototype,"listMode",void 0),e([i(f(u))],A.prototype,"spatialReference",void 0),e([i(v)],A.prototype,"elevationInfo",null),e([i({json:{read:!1},readOnly:!0})],A.prototype,"type",void 0),e([i()],A.prototype,"associatedFeatureServiceItem",void 0),A=e([a("esri.layers.BuildingSceneLayer")],A);var P=A;export default P;
