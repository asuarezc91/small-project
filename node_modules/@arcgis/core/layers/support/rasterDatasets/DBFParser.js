/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{bytesToUTF8 as e}from"./byteStreamUtils.js";export default class{static get supportedVersions(){return[5]}static parse(t){const r=new DataView(t),n=3&r.getUint8(0);if(3!==n)return{header:{version:n},recordSet:null};const i=r.getUint32(4,!0),s=r.getUint16(8,!0),a=r.getUint16(10,!0),o={version:n,recordCount:i,headerByteCount:s,recordByteCount:a};let l=32;const p=[],g=[];let u;if(3===n){for(;13!==r.getUint8(l);)u=String.fromCharCode(r.getUint8(l+11)).trim(),p.push({name:e(new Uint8Array(t,l,11)),type:u,typeName:["String","Date","Double","Boolean","String","Integer"][["C","D","F","L","M","N"].indexOf(u)],length:r.getUint8(l+16)}),l+=32;if(l+=1,p.length>0)for(;g.length<i&&t.byteLength-l>a;){const n=[];32===r.getUint8(l)?(l+=1,p.forEach((r=>{if("C"===r.type)n.push(e(new Uint8Array(t,l,r.length)).trim());else if("N"===r.type)n.push(parseInt(String.fromCharCode.apply(null,new Uint8Array(t,l,r.length)).trim(),10));else if("F"===r.type)n.push(parseFloat(String.fromCharCode.apply(null,new Uint8Array(t,l,r.length)).trim()));else if("D"===r.type){const e=String.fromCharCode.apply(null,new Uint8Array(t,l,r.length)).trim();n.push(new Date(parseInt(e.substring(0,4),10),parseInt(e.substring(4,6),10)-1,parseInt(e.substring(6,8),10)))}l+=r.length})),g.push(n)):l+=a}}const d=function(e){const t=e.fields,r=e.records,n=t.some((e=>"oid"===e.name.toLowerCase()))?"OBJECTID":"OID",i=[{name:n,type:"esriFieldTypeOID",alias:"OID"}].concat(t.map((e=>({name:e.name,type:"esriFieldType"+e.typeName,alias:e.name})))),s=i.map((e=>e.name)),a=[];let o=0,l=0;return r.forEach((e=>{const t={};for(t[n]=o++,l=1;l<s.length;l++)t[s[l]]=e[l-1];a.push({attributes:t})})),{displayFieldName:"",fields:i,features:a}}({fields:p,records:g});return{header:o,fields:p,records:g,recordSet:d}}}
