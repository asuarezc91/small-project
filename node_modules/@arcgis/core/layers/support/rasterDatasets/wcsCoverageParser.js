/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import e from"../../../geometry/Extent.js";import t from"../RasterInfo.js";import{getElements as n,isSameTagIgnoreNS as i,getElementValue as s,getElementValues as o,getNodeNameIgnoreNS as a,getSpaceDelimitedNumericValues as r,getElement as l}from"./xmlUtilities.js";import{coordsReversed as p}from"../wmsUtils.js";function u(e){const t=o(e,"interpolationMethod"),n=e.getAttribute("default");return null!=n?[n].concat(t.filter((e=>e.toLowerCase()!==n.toLowerCase()))):t}function m(e){return null==e?["nearest"]:e.map((e=>{const t=e.toLowerCase();return t.indexOf("nearest")>-1?"nearest":t.indexOf("linear")>-1?"bilinear":t.indexOf("cubic")>-1?"cubic":null})).filter((e=>!!e))}function d(t){const i=n(t,"pos"),s=r(i[0]),o=r(i[1]);return new e({xmin:s[0],ymin:s[1],xmax:o[0],ymax:o[1],spatialReference:{wkid:4326}})}function c(e){const t=[],i=n(e,"RangeSet");let a=[];for(let e=0;e<i.length;e++){const r=s(i[e],"name"),l=s(i[e],"label"),p=[],u=n(i[e],"AxisDescription");for(let e=0;e<u.length;e++){const t=s(u[e],"name"),n=s(u[e],"label"),i=o(u[e],"singleValue");if(0===i.length){const t=s(u[e],"min"),n=s(u[e],"max"),o=Number(s(u[e],"res"))||1;if(null!==t&&null!==n)for(let e=parseInt(t,10);e<=parseInt(n,10);e+=o)i.push(e.toString())}"band"===t.toLowerCase()&&(a=i),p.push({name:t,label:n,values:i})}t.push({name:r,label:l,axis:p})}return{rangeSet:t,bandNames:a}}function f(e){const t=n(e,"timeposition");if(t.length>0){const e=[];for(let n=0;n<t.length;n++)e.push(new Date(s(t[n])));return{begin:e[0],end:e[e.length-1],values:e}}const i=l(e,"timePeriod");if(i){return{begin:new Date(s(i,"beginPosition")),end:new Date(s(i,"endPosition")),...function(e=null){if(!e)return{resolution:null,units:null};let t=e.toUpperCase();const n=["Y","M","D"],i=["H","M","S"],s=["Years","Months","Days","Hours","Minutes","Seconds"];let o,a,r;return-1===t.indexOf("PT")?(t=t.slice(1),r=n.findIndex((e=>t.indexOf(e)>-1)),r>-1&&(o=s[r]),a=parseFloat(t.substring(0,t.length-1))):(t=t.slice(2),r=i.findIndex((e=>t.indexOf(e)>-1)),o=s[3+r],a=parseFloat(t.substring(0,t.length-1))),{resolution:a,units:o}}(s(i,"timeResolution"))}}return null}function h(t){const i=l(t,"spatialDomain"),o=l(i,"Envelope")||l(i,"EnvelopeWithTimePeriod"),a=o.getAttribute("srsName").split(":"),p=a[a.length-1],u=n(o,"pos"),m=r(u[0]),d=r(u[1]),c=new e({xmin:m[0],ymin:m[1],xmax:d[0],ymax:d[1],spatialReference:{wkid:parseInt(p,10)}}),h=l(i,"RectifiedGrid"),g=s(h,"low").split(" "),x=s(h,"high").split(" "),b=parseInt(x[0],10)-parseInt(g[0],10)+1,v=parseInt(x[1],10)-parseInt(g[1],10)+1,w=r(i,"origin/pos"),y=n(i,"offsetVector"),D={envelope:c,columns:b,rows:v,offset:{x:parseFloat(s(y[0]).split(" ")[0]),y:parseFloat(s(y[1]).split(" ")[1])},origin:{x:w[0],y:w[1]}},S=l(t,"temporalDomain");return{spatialDomain:D,temporalDomain:S?f(S):null}}function g(e){const t=[],i=n(e,"Field");let a=[];for(let e=0;e<i.length;e++){const r=s(i[e],"Identifier"),l=s(i[e],"Description"),p=s(i[e],"Definition"),u=s(i[e],"Abstract"),m=s(i[e],"Title"),d=o(i[e],"InterpolationMethod"),c=[],f=n(i[e],"Axis");for(let e=0;e<f.length;e++){const t=f[e].getAttribute("identifier"),n=s(f[e],"valuesUnit"),i=s(f[e],"DataType"),r=o(f[e],"Key");"band"===t.toLowerCase()&&(a=r),c.push({identifier:t,valuesUnit:n,dataType:i,values:r})}t.push({identifier:r,description:l,definition:p,abstract:u,title:m,supportedInterpolations:d,axis:c})}return{rangeSet:t,bandNames:a}}function x(t){var i;const o=l(t,"SpatialDomain"),a=l(o,"GridCRS"),u=s(a,"GridBaseCRS"),m=s(a,"GridOrigin"),d=null!=(i=null==m?void 0:m.split(" ").map((e=>parseFloat(e))))?i:[0,0],c=r(a,"GridOffsets"),h=n(o,"BoundingBox");let g,x,b,v;for(let t=0;t<h.length;t++){var w;const n=null==(w=h[t].getAttribute("crs"))?void 0:w.toLowerCase();if(null!=n)if(n.indexOf("imagecrs")>-1){const e=r(h[t],"LowerCorner"),n=r(h[t],"UpperCorner");g=n[0]-e[0]+1,x=n[1]-e[1]+1}else if(n.indexOf("epsg")>0){const i=n.split(":");b=parseInt(i[i.length-1],10);const s=r(h[t],"LowerCorner"),o=r(h[t],"UpperCorner");v=new e({xmin:s[0],ymin:s[1],xmax:o[0],ymax:o[1],spatialReference:{wkid:b}})}}const y=g>x,D=v.xmax-v.xmin>v.ymax-v.ymin;let S=!1;p(b)&&(y===D?S=!1:(S=!0,v=new e({xmin:v.ymin,ymin:v.xmin,xmax:v.ymax,ymax:v.xmax,spatialReference:{wkid:b}})));const L={columns:g,rows:x,origin:{x:d[0],y:d[1]},offset:{x:c[0],y:c[1]},gridBaseCRS:u,envelope:v,useEPSGAxis:S},C=l(t,"temporalDomain");return{spatialDomain:L,temporalDomain:C?f(C):null}}function b(e,n){const i=[],o=[],r={supportedFormats:i,supportedCRSs:o,version:"1.1"};let l;for(let t=0;t<e.childNodes.length;t++){const n=e.childNodes[t];if(1!==n.nodeType)continue;const p=a(n).toLowerCase();switch(p){case"title":case"abstract":case"identifier":r[p]=s(n);break;case"supportedformat":{const e=s(n);-1===i.indexOf(e)&&i.push(e)}break;case"supportedcrs":{const e=s(n);-1===o.indexOf(e)&&o.push(e)}break;case"range":{const e=g(n);r.range=e.rangeSet,l=e.bandNames}break;case"domain":r.domain=x(n)}}const p=m(r.range[0].supportedInterpolations),{identifier:u,abstract:d,title:c,domain:f,range:h}=r,b={x:Math.abs(f.spatialDomain.offset.x),y:Math.abs(f.spatialDomain.offset.y)},v=function(e,t){const n=e.filter((e=>-1===e.identifier.toLowerCase().indexOf("field_1")&&!e.axis.some((e=>"band"===e.identifier.toLowerCase())))),i=[];if(n.length&&n.forEach((e=>{var t;const n=e.axis.map((e=>{const t=e.values.map((e=>parseFloat(e.trim()))),n=[Math.min.apply(null,t),Math.max.apply(null,t)];return{name:e.identifier.trim(),description:"",field:e.identifier.trim(),unit:e.valuesUnit?e.valuesUnit.trim():"",hasRegularIntervals:!1,values:t,extent:n}}));i.push({name:e.identifier.trim(),description:null!=(t=null==e?void 0:e.description.trim())?t:"",unit:"",dimensions:n})})),t.temporalDomain){const{begin:e,end:n,values:s,units:o,resolution:a}=t.temporalDomain;i.forEach((t=>{t.dimensions.push({name:"StdTime",description:"",unit:"ISO8601",values:null==s?void 0:s.map((e=>e.getTime())),hasRegularIntervals:!s,interval:a,intervalUnit:o,extent:[e.getTime(),n.getTime()]})}))}return i.length?{variables:i}:null}(h,f),w=new t({width:f.spatialDomain.columns,height:f.spatialDomain.rows,pixelSize:b,extent:f.spatialDomain.envelope,spatialReference:f.spatialDomain.envelope.spatialReference,bandCount:l.length||1,multidimensionalInfo:v});return{id:u,title:r.title,description:d||c,lonLatEnvelope:null,bandNames:l,rasterInfo:w,supportedFormats:i,supportedInterpolations:p,coverageDescription:r,version:n,useEPSGAxis:f.spatialDomain.useEPSGAxis}}function v(t){const n=l(t,"Envelope")||l(t,"EnvelopeWithTimePeriod"),o=n.getAttribute("srsName"),a=o.slice(o.lastIndexOf("/")+1),p=n.getAttribute("axisLabels"),u=r(n,"lowerCorner"),m=r(n,"upperCorner"),d=!["y","lat","latitude","north","nor","n","b"].some((e=>e===p[0].toLowerCase()));let c;c=new e(d?{xmin:u[0],ymin:u[1],xmax:m[0],ymax:m[1],spatialReference:{wkid:parseInt(a,10)}}:{xmin:u[1],ymin:u[0],xmax:m[1],ymax:m[0],spatialReference:{wkid:parseInt(a,10)}});const f={mins:u,maxs:m},h=n.getAttribute("uomLabels").trim().split(" ");let g,x;return i(n,"EnvelopeWithTimePeriod")&&(g=new Date(s(t,"beginPosition")),x=new Date(s(t,"endPosition"))),{envelope:c,axisLabels:p,uomLabels:h.length?h:null,envelopeAllDims:f,beginPosition:g,endPosition:x,isEastFirst:d}}function w(e){const t=[],i=n(e,"DataRecord"),o=[];for(let e=0;e<i.length;e++){const a=n(i[e],"field"),p=[];for(let e=0;e<a.length;e++){const t=a[e].getAttribute("name"),n=s(a[e],"description")||"",i=l(a[e],"uom").getAttribute("code")||"",u=r(a[e],"interval");t.toLowerCase().indexOf("band")>-1&&o.push(t),p.push({name:t,description:n,uom:i,allowedValues:u})}t.push(p)}return{rangeType:t,bandNames:o}}function y(e){let t=1,n="";const i=.01;return Math.abs(e-1/24)<1/24*i?n="Hours":Math.abs(e-1)<.01?n="Days":e<1?(t=Math.round(24*e),n="Hours"):e>27.99&&e<31.01||Math.round(e/30)<12?n="Months":e>364.99&&e<366.01&&(n="Years"),{interval:t,intervalUnit:n}}function D(e){const t=l(e,"RectifiedGrid"),i=r(t,"low"),o=r(t,"high"),a=[];for(let e=0;e<i.length;e++)a.push(o[e]-i[e]+1);const p=s(t,"axisLabels").split(" "),u=r(t,"origin/pos"),m=n(t,"offsetVector"),d=[];for(let e=0;e<m.length;e++)d.push(parseFloat(s(m[e]).split(" ")[e]));let c,f,h;return["y","lat","latitude","north","nor","n","b"].some((e=>e===p[0].toLowerCase()))?(c=a[1],f=a[0],h={y:Math.abs(d[0]),x:Math.abs(d[1])}):(c=a[0],f=a[1],h={x:Math.abs(d[0]),y:Math.abs(d[1])}),{columns:c,rows:f,origin:u,offset:d,resolution:h,gridSamples:a,axisLabels:p}}function S(e){const n={version:"2.0"};let a=[];for(let t=0;t<e.childNodes.length;t++){const r=e.childNodes[t];if(1===r.nodeType)if(i(r,"coverageId"))n.coverageId=s(r);else if(i(r,"ServiceParameters"))n.serviceParameters={supportedFormats:o(r,"nativeFormat")};else if(i(r,"boundedBy"))n.boundedBy=v(r);else if(i(r,"rangeType")){const e=w(r);n.rangeType=e.rangeType,a=e.bandNames}else i(r,"domainSet")&&(n.domainSet=D(r))}const{coverageId:r,boundedBy:l,domainSet:p,rangeType:u,serviceParameters:m}=n,d=function(e,t,n){const i=[];for(let t=0;t<e.length;t++){const n=e[t];for(let e=0;e<n.length;e++)-1===n[e].name.toLowerCase().indexOf("band")&&i.push(n[e])}const s=[];if(i.length){const e=[];for(let i=2;i<n.axisLabels.length;i++){const s=(t.uomLabels&&t.uomLabels.length)>i?t.uomLabels[i]:"",o=n.axisLabels[i].toLowerCase().indexOf("time")>-1||"iso8601"===s.toLowerCase();let a,r;if(o){const e=y(n.offset[i]);a=e.interval,r=e.intervalUnit}else a=n.offset[i],r=s;const l=[];o?(l.push((new Date).setTime(24*(t.envelopeAllDims.mins[i]-25569)*3600*1e3)),l.push((new Date).setTime(24*(t.envelopeAllDims.maxs[i]-25569)*3600*1e3))):(l.push(t.envelopeAllDims.mins[i]),l.push(t.envelopeAllDims.maxs[i])),e.push({name:n.axisLabels[i].trim(),description:n.axisLabels[i].trim(),unit:t.uomLabels&&t.uomLabels.length>i?t.uomLabels[i].trim():"",hasRegularIntervals:!0,extent:l,interval:a,intervalUnit:r})}if(i.forEach((t=>s.push({name:t.name.trim(),description:t.description.trim(),unit:t.uom.trim(),dimensions:e}))),s.length)return{variables:s}}return null}(u,l,p);return{id:r,title:r,description:r,lonLatEnvelope:null,bandNames:a,rasterInfo:new t({width:p.columns,height:p.rows,pixelSize:p.resolution,extent:l.envelope,spatialReference:l.envelope.spatialReference,bandCount:a.length||1,multidimensionalInfo:d}),supportedFormats:m.supportedFormats,supportedInterpolations:null,coverageDescription:n,version:"1.0.0",useEPSGAxis:!1}}function L(e,a){let r=null;if("string"==typeof e){r=(new DOMParser).parseFromString(e,"text/xml")}else r=e;if("1.0.0"===a){return n(r,"CoverageOffering").map((e=>function(e){const n={version:"1.0"};let a=[];for(let t=0;t<e.childNodes.length;t++){const l=e.childNodes[t];if(1===l.nodeType)if(i(l,"description"))n.description=s(l);else if(i(l,"name"))n.name=s(l);else if(i(l,"label"))n.label=s(l);else if(i(l,"supportedFormats"))n.supportedFormats=o(l,"formats");else if(i(l,"supportedCRSs"))n.supportedCRSs={requestResponseCRSs:o(r=l,"requestResponseCRSs").map((e=>e.split(":")[1])),nativeCRSs:o(r,"nativeCRSs").map((e=>e.split(":")[1]))};else if(i(l,"supportedInterpolations"))n.supportedInterpolations=u(l);else if(i(l,"lonLatEnvelope"))n.lonLatEnvelope=d(l);else if(i(l,"rangeSet")){const e=c(l);n.rangeSet=e.rangeSet,a=e.bandNames}else i(l,"domainSet")&&(n.domainSet=h(l))}var r;const l=m(n.supportedInterpolations),{name:p,description:f,label:g,lonLatEnvelope:x,supportedFormats:b}=n,{spatialDomain:v}=n.domainSet,w={x:Math.abs(v.offset.x),y:Math.abs(v.offset.y)},y=new t({width:v.columns,height:v.rows,pixelSize:w,extent:v.envelope,spatialReference:v.envelope.spatialReference,bandCount:a.length||1});return{id:p,title:n.name,description:f||g,lonLatEnvelope:x,rasterInfo:y,bandNames:a,supportedFormats:b,supportedInterpolations:l,coverageDescription:n,version:"1.0.0",useEPSGAxis:!1}}(e)))}const l=n(r,"CoverageDescription");return"1.1.0"===a||"1.1.1"===a||"1.1.2"===a?l.map((e=>b(e,a))):l.map((e=>S(e)))}export{L as parseCoverages,m as standardizeInterpolations};
