/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import e from"../../../core/Error.js";import t from"../../../geometry/Extent.js";import{getElementValue as r,getElement as i,getElements as o,getSpaceDelimitedNumericValues as n,getElementValues as a,isSameTagIgnoreNS as s,getNodeNameIgnoreNS as l}from"./xmlUtilities.js";function c(e){return e.indexOf("?")===e.length-1?e.substring(0,e.length-1):e}function u(e){const i={};for(let o=0;o<e.childNodes.length;o++){const a=e.childNodes[o];if(1!==a.nodeType)continue;const s=l(a).toLowerCase();switch(s){case"title":case"abstract":i[s]=r(a);break;case"identifier":i.id=r(a);break;case"wgs84boundingbox":{const e=n(a,"LowerCorner"),r=n(a,"UpperCorner");i.lonLatEnvelope=new t({xmin:e[0],ymin:e[1],xmax:r[0],ymax:r[1],spatialReference:{wkid:4326}})}break;case"coveragesummary":i.coverageSummaries=i.coverageSummaries||[],i.coverageSummaries.push(u(a))}}return i}function m(e,t){if(e.coverageSummaries)for(let r=0;r<e.coverageSummaries.length;r++)e.coverageSummaries[r].abstract=e.coverageSummaries[r].abstract||e.abstract,e.coverageSummaries[r].lonLatEnvelope=e.coverageSummaries[r].lonLatEnvelope||e.lonLatEnvelope,e.coverageSummaries[r].title=e.coverageSummaries[r].title||e.title,m(e.coverageSummaries[r],t);null!=e.id&&t.push(e)}function p(e){const t=i(e.querySelector("Operation[name=GetCapabilities]"),"Get").getAttribute("xlink:href")||"",r=i(e.querySelector("Operation[name=DescribeCoverage]"),"Get").getAttribute("xlink:href")||"",o=i(e.querySelector("Operation[name=GetCoverage]"),"Get").getAttribute("xlink:href")||"";return{getCapabilities:c(t),describeCoverage:c(r),getCoverage:c(o)}}function g(l,g=null){let f=null;if("string"==typeof l){f=(new DOMParser).parseFromString(l,"text/xml")}else f=l;const v=f.documentElement.getAttribute("version"),d=(v||g||"1.0.0").slice(0,3);let b;if("2.0"===d)b=function(e){const s=i(e,"ServiceIdentification"),l=r(s,"Title"),c=a(s,"ServiceTypeVersion"),u=a(s,"Profile"),m=p(i(e,"OperationsMetadata")),g=o(e,"Contents/CoverageSummary"),f=[];for(let e=0;e<g.length;e++){const o=g[e],a=r(o,"CoverageId"),s=i(o,"WGS84BoundingBox");let l;if(s){const e=n(s,"LowerCorner"),r=n(s,"UpperCorner");l=new t({xmin:e[0],ymin:e[1],xmax:r[0],ymax:r[1],spatialReference:{wkid:4326}})}f.push({id:a,lonLatEnvelope:l})}const v=i(e,"ServiceMetadata");return{name:l,supportedVersions:c,supportedFormats:a(v,"formatSupported"),supportedInterpolations:a(v,"interpolationSupported"),onlineResources:m,profiles:u,coverages:f}}(f);else if("1.1"===d)b=function(e){const t=r(e,"ServiceIdentification/Title"),o=a(e,"ServiceIdentification/ServiceTypeVersion"),n=p(i(e,"OperationsMetadata")),l=[],c=i(e,"Contents");for(let e=0;e<c.childNodes.length;e++){const t=c.childNodes[e];1===t.nodeType&&s(t,"CoverageSummary")&&m(u(t),l)}return{name:t,onlineResources:n,coverages:l,supportedVersions:o,supportedFormats:a(c,"SupportedFormat")}}(f);else{if("1.0"!==d)throw new e("wcsraster:parsecapabilities","the capabilities version is not supported");b=function(e){var a,s,l;const u=r(e,"Service/name"),m=i(e,"Capability"),p=null!=(a=i(m,"GetCapabilities/Get/OnlineResource").getAttribute("xlink:href"))?a:"",g=null!=(s=i(m,"DescribeCoverage/Get/OnlineResource").getAttribute("xlink:href"))?s:"",f=null!=(l=i(m,"GetCoverage/Get/OnlineResource").getAttribute("xlink:href"))?l:"",v={getCapabilities:c(p),describeCoverage:c(g),getCoverage:c(f)},d=o(e,"CoverageOfferingBrief"),b=[];for(let e=0;e<d.length;e++){const i=d[e],a=r(i,"name"),s=o(i,"pos"),l=n(s[0]),c=n(s[1]),u=new t({xmin:l[0],ymin:l[1],xmax:c[0],ymax:c[1],spatialReference:{wkid:4326}});b.push({id:a,lonLatEnvelope:u})}return{name:u,onlineResources:v,coverages:b,supportedVersions:["1.0.0"]}}(f)}return b.capabilitiesVersion=v,b}export{g as parseCapabilities};
