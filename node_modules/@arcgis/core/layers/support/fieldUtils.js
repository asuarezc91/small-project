/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{getDeepValue as e,setDeepValue as n}from"../../core/object.js";import{isNone as t,isSome as i}from"../../core/maybe.js";import r from"../../core/Error.js";import{all as o}from"../../core/promiseUtils.js";import{validateDomainValue as l,getDomainRange as a,DomainValidationError as s}from"./domains.js";import{loadArcade as u}from"../../support/arcadeOnDemand.js";const f=["field","field2","field3","normalizationField","rotationInfo.field","proportionalSymbolInfo.field","proportionalSymbolInfo.normalizationField","colorInfo.field","colorInfo.normalizationField"],c=["field","normalizationField"];function d(e,n){if(null!=e&&null!=n)for(const t of Array.isArray(e)?e:[e])if(m(f,t,n),"visualVariables"in t&&t.visualVariables)for(const e of t.visualVariables)m(c,e,n)}function m(t,i,r){if(t)for(const o of t){const t=e(o,i),l=t&&"function"!=typeof t&&h(r,t);l&&n(o,l.name,i)}}function p(e,n){if(null!=e&&null!=n)if("startField"in e){const t=h(n,e.startField),i=h(n,e.endField);e.startField=t&&t.name||null,e.endField=i&&i.name||null}else{const t=h(n,e.startTimeField),i=h(n,e.endTimeField);e.startTimeField=t&&t.name||null,e.endTimeField=i&&i.name||null}}const y=new Set;function g(e,n){return e&&n?(y.clear(),F(y,e,n),Array.from(y).sort()):[]}function F(e,n,t){if(t)if(n&&n.length)if(t.includes("*"))for(const{name:t}of n)e.add(t);else for(const i of t)I(e,n,i);else{if(t.includes("*"))return e.clear(),void e.add("*");for(const n of t)e.add(n)}}function I(e,n,t){if(n&&n.length){const i=h(n,t);i&&e.add(i.name)}else"string"==typeof t&&e.add(t)}function b(e,n){return t(n)||t(e)?[]:n.includes("*")?e.map((e=>e.name)):n}function T(e,n,t=1){if(!n||!e)return[];if(n.includes("*"))return["*"];const i=g(e,n);return i.length/e.length>=t?["*"]:i}function h(e,n){if("string"!=typeof n)return null;if(null!=e){n=n.toLowerCase();for(const t of e)if(t&&t.name.toLowerCase()===n)return t}return null}function w(e,n){if(!e||!n||"string"!=typeof n)return!1;n=n.toLowerCase();for(const t of e)if(t&&t.name.toLowerCase()===n)return!0;return!1}async function S(e,n,t){if(!t)return;const{arcadeUtils:i}=await u(),r=i.extractFieldNames(t);for(const t of r)I(e,n,t)}function x({displayField:e,fields:n}){return e||(n&&n.length?N(n,"name-or-title")||N(n,"unique-identifier")||N(n,"type-or-category")||function(e){for(const n of e){if(!n||!n.name)continue;const e=n.name.toLowerCase();if(e.indexOf("name")>-1||e.indexOf("title")>-1)return n.name}return null}(n):null)}function N(e,n){for(const t of e)if(t&&t.valueType&&t.valueType===n)return t.name;return null}async function A(e){if(!e)return[];const n=new Set;return await v(n,e),Array.from(n).sort()}async function v(n,t){if(!t)return;const{fields:i}=t,r=e("elevationInfo.featureExpressionInfo",t);return r?r.collectRequiredFields(n,i):void 0}async function E(e,n,t){n&&t&&"cluster"===t.type&&t.fields&&await o(t.fields.map((t=>async function(e,n,t){t.outStatistic.onStatisticValueExpression?S(e,n,t.outStatistic.onStatisticValueExpression):e.add(t.outStatistic.onStatisticField)}(e,n.fields,t))))}async function V(e,n,t){if(n&&t&&(t.where&&"1=1"!==t.where||t.timeExtent)&&(n.timeInfo&&t.timeExtent&&F(e,n.fields,[n.timeInfo.startField,n.timeInfo.endField]),i(t.where)&&t.where)){const i=(await import("../../core/sql/WhereClause.js")).WhereClause.create(t.where,n.fieldsIndex);if(!i.isStandardized)throw new r("fieldUtils:collectFilterFields","Where clause is not standardized");F(e,n.fields,i.fieldNames)}}async function L(e){if(!e)return[];const n="timeInfo"in e&&e.timeInfo;return n?g(e.fields,[e.trackIdField,n.startField,n.endField]):[]}function _(e){if(!e)return[];const n="editFieldsInfo"in e&&e.editFieldsInfo;return n?g(e.fields,[n&&n.creatorField,n&&n.creationDateField,n&&n.editorField,n&&n.editDateField]):[]}function D(e){if(!e)return[];const n="geometryProperties"in e&&e.geometryProperties;return n?g(e.fields,[n&&n.shapeAreaFieldName,n&&n.shapeLengthFieldName]):[]}async function $(e){if(!e)return[];const n=new Set;return await O(n,e),Array.from(n).sort()}async function O(e,n){const{labelingInfo:t,fields:i}=n;t&&t.length&&await o(t.map((n=>async function(e,n,t){if(!t)return;const i=t.getLabelExpression(),r=t.where;if("arcade"===i.type)await S(e,n,i.expression);else{const t=i.expression.match(/{[^}]*}/g);t&&t.forEach((t=>{I(e,n,t.slice(1,-1))}))}const o=/['"]+/g;if(r){const t=r.split(" ");3===t.length&&I(e,n,t[0].replace(o,"")),7===t.length&&(I(e,n,t[0].replace(o,"")),I(e,n,t[4].replace(o,"")))}}(e,i,n))))}function U(e){const n=e.defaultValue;return void 0!==n&&q(e,n)?n:e.nullable?null:void 0}function j(e){return"number"==typeof e&&!isNaN(e)&&isFinite(e)}function C(e){return null===e||j(e)}const z="isInteger"in Number?Number.isInteger:e=>"number"==typeof e&&isFinite(e)&&Math.floor(e)===e;function k(e){return null===e||z(e)}function P(e){return null!=e&&"string"==typeof e}function R(e){return null===e||P(e)}function G(){return!0}function q(e,n){let t;switch(e.type){case"date":case"integer":case"long":case"small-integer":case"esriFieldTypeDate":case"esriFieldTypeInteger":case"esriFieldTypeLong":case"esriFieldTypeSmallInteger":t=e.nullable?k:z;break;case"double":case"single":case"esriFieldTypeSingle":case"esriFieldTypeDouble":t=e.nullable?C:j;break;case"string":case"esriFieldTypeString":t=e.nullable?R:P;break;default:t=G}return 1===arguments.length?t:t(n)}const M=["integer","small-integer","single","double"],W=new Set([...M,"esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"]);function Y(e){return null!=e&&W.has(e.type)}function J(e){return null!=e&&("string"===e.type||"esriFieldTypeString"===e.type)}function X(e){return null!=e&&("date"===e.type||"esriFieldTypeDate"===e.type)}function B(e,n){return null===Z(e,n)}var H,K;function Q(e){return null==e||"number"==typeof e&&isNaN(e)?null:e}function Z(e,n){return e.nullable&&null===n?null:Y(e)&&!ee(e.type,Number(n))?H.OUT_OF_RANGE:q(e,n)?e.domain?l(e.domain,n):null:K.INVALID_TYPE}function ee(e,n){const t="string"==typeof e?te(e):e;return!!t&&(t.isInteger?z(n)&&n>=t.min&&n<=t.max:n>=t.min&&n<=t.max)}function ne(e){const n=a(e.domain);return n||(Y(e)?te(e.type):void 0)}function te(e){switch(e){case"esriFieldTypeSmallInteger":case"small-integer":return re;case"esriFieldTypeInteger":case"integer":return oe;case"esriFieldTypeSingle":case"single":return le;case"esriFieldTypeDouble":case"double":return ae}}function ie(e){if(!j(e))return null;if(z(e)){if(e>=re.min&&e<=re.max)return"esriFieldTypeSmallInteger";if(e>=oe.min&&e<=oe.max)return"esriFieldTypeInteger"}return e>=le.min&&e<=le.max?"esriFieldTypeSingle":"esriFieldTypeDouble"}!function(e){e.OUT_OF_RANGE="numeric-range-validation-error::out-of-range"}(H||(H={})),function(e){e.INVALID_TYPE="type-validation-error::invalid-type"}(K||(K={}));const re={min:-32768,max:32767,isInteger:!0},oe={min:-2147483648,max:2147483647,isInteger:!0},le={min:-34e37,max:12e37,isInteger:!1},ae={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1};function se(e,n,t){switch(e){case s.INVALID_CODED_VALUE:return`Value ${t} is not in the coded domain - field: ${n.name}, domain: ${JSON.stringify(n.domain)}`;case s.VALUE_OUT_OF_RANGE:return`Value ${t} is out of the range of valid values - field: ${n.name}, domain: ${JSON.stringify(n.domain)}`;case K.INVALID_TYPE:return`Value ${t} is not a valid value for the field type - field: ${n.name}, type: ${n.type}, nullable: ${n.nullable}`;case H.OUT_OF_RANGE:{const{min:e,max:i}=te(n.type);return`Value ${t} is out of range for the number type - field: ${n.name}, type: ${n.type}, value range is ${e} to ${i}`}}}function ue(e,n){return!fe(e,n,null)}function fe(e,n,t){if(!n||!n.attributes||!e){if(i(t))for(const n of e)t.add(n);return!0}const r=n.attributes;let o=!1;for(const n of e)if(!(n in r)){if(o=!0,!i(t))break;t.add(n)}return o}async function ce(e,n){const t=new Set;for(const i of n)await S(t,e.fields,i);return Array.from(t).sort()}export{H as NumericRangeValidationError,K as TypeValidationError,S as collectArcadeFieldNames,v as collectElevationFields,E as collectFeatureReductionFields,I as collectField,F as collectFields,V as collectFilterFields,O as collectLabelingFields,ae as doubleRange,ue as featureHasFields,g as fixFields,d as fixRendererFields,p as fixTimeInfoFields,x as getDisplayFieldName,A as getElevationFields,ce as getExpressionFields,_ as getFeatureEditFields,D as getFeatureGeometryFields,h as getField,U as getFieldDefaultValue,ne as getFieldRange,$ as getLabelingFields,ie as getNumericTypeForValue,L as getTimeFields,w as hasField,oe as integerRange,X as isDateField,ee as isNumberInRange,Y as isNumericField,J as isStringField,B as isValidFieldValue,q as isValueMatchingFieldType,M as numericTypes,T as packFields,fe as populateMissingFields,f as rendererFields,Q as sanitizeNullFieldValue,le as singleRange,re as smallIntegerRange,b as unpackFieldNames,Z as validateFieldValue,se as validationErrorToString,c as visualVariableFields};
