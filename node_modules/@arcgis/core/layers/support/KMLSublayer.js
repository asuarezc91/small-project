/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../core/has.js";import{isSome as r}from"../../core/maybe.js";import"../../core/Logger.js";import{ensureType as t}from"../../core/accessorSupport/ensureType.js";import{property as s}from"../../core/accessorSupport/decorators/property.js";import{cast as o}from"../../core/accessorSupport/decorators/cast.js";import{reader as i}from"../../core/accessorSupport/decorators/reader.js";import{subclass as l}from"../../core/accessorSupport/decorators/subclass.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import{resolve as a}from"../../core/promiseUtils.js";import{JSONSupportMixin as n}from"../../core/JSONSupport.js";import u from"../../geometry/Extent.js";import"../../geometry.js";import p from"../../core/Evented.js";import y from"../../core/Collection.js";import c from"../../core/Loadable.js";import{whenOnce as h,whenTrueOnce as m}from"../../core/watchUtils.js";import{computeExtent as d,sublayersFromJSON as b,fetchService as f,parseKML as v}from"./kmlUtils.js";var j;let S=j=class extends(p.EventedMixin(n(c))){constructor(){super(...arguments),this._sublayersHandles=null,this.description=null,this.id=null,this.networkLink=null,this.title=null,this.sourceJSON=null,this.fullExtent=null}initialize(){h(this,"networkLink").then((()=>m(this,"visible"))).then((()=>this.load()))}load(e){if(!this.networkLink)return;const s=r(e)?e.signal:null,o=this._fetchService(this._get("networkLink").href,s).then((e=>{const r=d(e.sublayers);this.fullExtent=u.fromJSON(r),this.sourceJSON=e;const s=t(y.ofType(j),b(j,e));this.sublayers?this.sublayers.addMany(s):this.sublayers=s,this.layer.emit("sublayer-update"),this.layer&&this.layer.notifyChange("visibleSublayers")}));return this.addResolvingPromise(o),a(this)}set sublayers(e){const r=this._get("sublayers");r&&(r.forEach((e=>{e.parent=null,e.layer=null})),this._sublayersHandles.forEach((e=>e.remove())),this._sublayersHandles=null),e&&(e.forEach((e=>{e.parent=this,e.layer=this.layer})),this._sublayersHandles=[e.on("after-add",(({item:e})=>{e.parent=this,e.layer=this.layer})),e.on("after-remove",(({item:e})=>{e.parent=null,e.layer=null}))]),this._set("sublayers",e)}castSublayers(e){return t(y.ofType(j),e)}get visible(){return this._get("visible")}set visible(e){this._get("visible")!==e&&(this._set("visible",e),this.layer&&this.layer.notifyChange("visibleSublayers"))}readVisible(e,r){return!!r.visibility}set layer(e){this._set("layer",e),this.sublayers&&this.sublayers.forEach((r=>r.layer=e))}_fetchService(e,r){return f(e,this.layer.outSpatialReference,this.layer.refreshInterval,r).then((e=>v(e.data)))}};e([s()],S.prototype,"description",void 0),e([s()],S.prototype,"id",void 0),e([s({readOnly:!0,value:null})],S.prototype,"networkLink",void 0),e([s({json:{write:{allowNull:!0}}})],S.prototype,"parent",void 0),e([s({value:null,json:{write:{allowNull:!0}}})],S.prototype,"sublayers",null),e([o("sublayers")],S.prototype,"castSublayers",null),e([s({value:null,json:{read:{source:"name"}}})],S.prototype,"title",void 0),e([s({value:!0})],S.prototype,"visible",null),e([i("visible",["visibility"])],S.prototype,"readVisible",null),e([s()],S.prototype,"sourceJSON",void 0),e([s({value:null})],S.prototype,"layer",null),e([s({type:u})],S.prototype,"fullExtent",void 0),S=j=e([l("esri.layers.support.KMLSublayer")],S);var _=S;export default _;
