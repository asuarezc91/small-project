/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import e from"../../config.js";import{urlToObject as r,removeTrailingSlash as t,getOrigin as s,isProtocolRelative as o,isAbsolute as l,join as n,normalize as i,removeFile as u,appBaseUrl as a}from"../../core/urlUtils.js";import{throwIfAborted as c,reject as f,all as p,resolve as y}from"../../core/promiseUtils.js";import m from"../../request.js";import d from"../../views/2d/engine/vectorTiles/style/VectorTileSource.js";const S=e.defaults&&e.defaults.io.corsEnabledServers;async function h(e,t){const s={source:null,sourceBase:null,sourceUrl:null,validatedSource:null,style:null,styleBase:null,styleUrl:null,sourceNameToSource:{},primarySourceName:"",spriteFormat:"png"},[o,l]="string"==typeof e?[e,null]:[null,e.jsonUrl],n=o?r(o):null;await w(s,"esri",e,l,t);const i={layerDefinition:s.validatedSource,url:o,parsedUrl:n,serviceUrl:s.sourceUrl,style:s.style,styleUrl:s.styleUrl,spriteUrl:s.style.sprite&&x(s.styleBase,s.style.sprite),spriteFormat:s.spriteFormat,glyphsUrl:s.style.glyphs&&x(s.styleBase,s.style.glyphs),sourceNameToSource:s.sourceNameToSource,primarySourceName:s.primarySourceName};return U(i.spriteUrl),U(i.glyphsUrl),i}function U(e){if(!e)return;const r=s(e);S&&-1===S.indexOf(r)&&S.push(r)}function x(...e){let r;for(let t=0;t<e.length;++t)if(o(e[t])){if(r){const s=r.split("://")[0];r=s+":"+e[t].trim()}}else r=l(e[t])?e[t]:n(r,e[t]);return t(r)}async function w(e,t,s,o,l){let n,y,d;if(c(l),"string"==typeof s){const e=i(s);U(e);const t=r(e);d=await m(t.path,{query:{f:"json"},responseType:"json",...l}),n=e,y=e}else d={data:s},n=s.jsonUrl||null,y=o;const S=d.data;return d.ssl&&(n&&(n=n.replace(/^http:/i,"https:")),y&&(y=y.replace(/^http:/i,"https:"))),g(S)?(e.styleUrl=n||null,async function(e,r,t,s){const o=t?u(t):a;e.styleBase=o,e.style=r,e.styleUrl&&U(e.styleUrl);r["sprite-format"]&&"webp"===r["sprite-format"].toLowerCase()&&(e.spriteFormat="webp");const l=[];if(r.sources&&r.sources.esri){const t=r.sources.esri;t.url?await w(e,"esri",x(o,t.url),void 0,s):l.push(w(e,"esri",t,o,s))}for(const t of Object.keys(r.sources))"esri"!==t&&"vector"===r.sources[t].type&&(r.sources[t].url?l.push(w(e,t,x(o,r.sources[t].url),void 0,s)):l.push(w(e,t,r.sources[t],o,s)));await p(l)}(e,S,y,l)):g(S)?f("You must specify the URL or the JSON for a service or for a style."):e.sourceUrl?v(e,S,y,!1,t,l):(e.sourceUrl=n||null,v(e,S,y,!0,t,l))}function g(e){return!!e.sources}async function v(e,r,s,o,l,n){const i=s?t(s)+"/":a,u=function(e,r){if(e.hasOwnProperty("tileInfo"))return e;const t={xmin:-20037507.067161843,ymin:-20037507.067161843,xmax:20037507.067161843,ymax:20037507.067161843,spatialReference:{wkid:102100}},s=512;let o=78271.51696400007,l=295828763.7957775;const n=[],i=e.hasOwnProperty("minzoom")?parseFloat(e.minzoom):0,u=e.hasOwnProperty("maxzoom")?parseFloat(e.maxzoom):22;for(let e=0;e<=u;e++)e>=i&&n.push({level:e,scale:l,resolution:o}),o/=2,l/=2;for(const t of e.tiles)U(x(r,t));return{capabilities:"TilesOnly",initialExtent:t,fullExtent:t,minScale:0,maxScale:0,tiles:e.tiles,tileInfo:{rows:s,cols:s,dpi:96,format:"pbf",origin:{x:-20037508.342787,y:20037508.342787},lods:n,spatialReference:{wkid:102100}}}}(r,i),c=new d(l,i,u);if(!o&&e.primarySourceName in e.sourceNameToSource){const r=e.sourceNameToSource[e.primarySourceName];if(!r.isCompatibleWith(c))return y();null!=c.fullExtent&&(null!=r.fullExtent?r.fullExtent.union(c.fullExtent):r.fullExtent=c.fullExtent.clone()),r.tileInfo.lods.length<c.tileInfo.lods.length&&(r.tileInfo=c.tileInfo)}if(o?(e.sourceBase=i,e.source=r,e.validatedSource=u,e.primarySourceName=l,e.sourceUrl&&U(e.sourceUrl)):U(i),e.sourceNameToSource[l]=c,!e.style)return null==r.defaultStyles?f():"string"==typeof r.defaultStyles?w(e,"",x(i,r.defaultStyles,"root.json"),void 0,n):w(e,"",r.defaultStyles,x(i,"root.json"),n)}export{h as loadMetadata};
