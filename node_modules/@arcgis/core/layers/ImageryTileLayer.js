/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../core/has.js";import{isSome as r}from"../core/maybe.js";import"../core/Logger.js";import{Integer as t}from"../core/accessorSupport/ensureType.js";import{property as o}from"../core/accessorSupport/decorators/property.js";import{strict as i}from"../core/jsonMap.js";import{enumeration as s}from"../core/accessorSupport/decorators/enumeration.js";import{reader as a}from"../core/accessorSupport/decorators/reader.js";import{subclass as n}from"../core/accessorSupport/decorators/subclass.js";import p from"../core/Error.js";import"../core/urlUtils.js";import"../core/uuid.js";import"../portal/support/resourceExtension.js";import{resolve as l}from"../core/promiseUtils.js";import d from"../PopupTemplate.js";import u from"./Layer.js";import{MultiOriginJSONMixin as m}from"../core/MultiOriginJSONSupport.js";import{legendEnabled as c}from"./support/commonProperties.js";import{OperationalLayer as y}from"./mixins/OperationalLayer.js";import{read as h,rasterRendererTypes as f,websceneRasterRendererTypes as g}from"../rasterRenderers.js";import j from"./support/Field.js";import{BlendLayer as v}from"./mixins/BlendLayer.js";import{PortalLayer as S}from"./mixins/PortalLayer.js";import{RefreshableLayer as b}from"./mixins/RefreshableLayer.js";import{ScaleRangeLayer as w}from"./mixins/ScaleRangeLayer.js";import{createPopupTemplate as P}from"../support/popupUtils.js";import{ImageryTileMixin as T}from"./mixins/ImageryTileMixin.js";import R from"./support/rasterDatasets/RasterFactory.js";const I=i()({RSP_NearestNeighbor:"nearest",RSP_BilinearInterpolation:"bilinear",RSP_CubicConvolution:"cubic",RSP_Majority:"majority"});function O(){return{enabled:!this.loaded||"RasterTileServer"===this.raster.datasetFormat&&"Raster"===this.raster.tileType}}let x=class extends(v(w(b(y(S(T(m(u)))))))){constructor(...e){super(...e),this.bandIds=null,this.interpolation=null,this.legendEnabled=!0,this.isReference=null,this.listMode="show",this.sourceJSON=null,this.version=null,this.title=null,this.type="imagery-tile",this.operationalLayerType="ArcGISTiledImageServiceLayer",this.popupEnabled=!0,this.popupTemplate=null}normalizeCtorArgs(e,r){return"string"==typeof e?{url:e,...r}:e}load(e){const t=r(e)?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Image Service"]},e).then((()=>this._openRaster(t)),(()=>this._openRaster(t)))),l(this)}get defaultPopupTemplate(){return this.createPopupTemplate()}get fields(){var e,r;let t=[new j({name:"Raster.ServicePixelValue",alias:"Pixel Value",domain:null,editable:!1,length:50,type:"string"})];const o=null==(e=this.rasterInfo)||null==(r=e.attributeTable)?void 0:r.fields;if(o){const e=o.filter((e=>"oid"!==e.type&&"value"!==e.name.toLowerCase())).map((e=>{const r=e.clone();return r.name="Raster."+e.name,r}));t=t.concat(e)}return t}set renderer(e){this._set("renderer",e),this.updateRenderer()}readRenderer(e,r,t){const o=r&&r.layerDefinition&&r.layerDefinition.drawingInfo&&r.layerDefinition.drawingInfo.renderer,i=h(o,t)||void 0;if(null!=i)return i}createPopupTemplate(e){return P(this,e)}write(e,r){const{raster:t}=this;if(this.loaded?"RasterTileServer"===t.datasetFormat&&("Raster"===t.tileType||"Map"===t.tileType):this.url&&/\/ImageServer(\/|\/?$)/i.test(this.url))return super.write(e,r);if(r&&r.messages){const e=`${r.origin}/${r.layerContainerType||"operational-layers"}`;r.messages.push(new p("layer:unsupported",`Layers (${this.title}, ${this.id}) of type '${this.declaredClass}' are not supported in the context of '${e}'`,{layer:this}))}return null}async _openRaster(e){this.raster?(this.raster.rasterInfo||await this.raster.open(),this.url=this.raster.url):this.raster=await R.open({url:this.url,sourceJSON:this.sourceJSON,ioConfig:this.ioConfig,signal:e});const{rasterInfo:r}=this.raster;if(!r)throw new p("imagery-tile-layer:load","cannot load resources on "+this.url);this.sourceJSON=this.sourceJSON||this.raster.sourceJSON,null!=this.sourceJSON&&(this._set("version",this.sourceJSON.currentVersion),this._set("copyright",this.sourceJSON.copyrightText)),null==this.title&&(this.title=this.raster.datasetName),"Map"===this.raster.tileType&&(this.popupEnabled=!1),this._configDefaultSettings()}};e([o()],x.prototype,"ioConfig",void 0),e([o({type:[t],json:{write:{overridePolicy:O}}})],x.prototype,"bandIds",void 0),e([o({json:{write:{overridePolicy:O}}}),s(I)],x.prototype,"interpolation",void 0),e([o({json:{write:!0}})],x.prototype,"multidimensionalDefinition",void 0),e([o(c)],x.prototype,"legendEnabled",void 0),e([o({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],x.prototype,"isReference",void 0),e([o({type:["show","hide"]})],x.prototype,"listMode",void 0),e([o()],x.prototype,"sourceJSON",void 0),e([o({readOnly:!0})],x.prototype,"version",void 0),e([o()],x.prototype,"title",void 0),e([o({readOnly:!0,json:{read:!1}})],x.prototype,"type",void 0),e([o({type:["ArcGISTiledImageServiceLayer"]})],x.prototype,"operationalLayerType",void 0),e([o({type:Boolean,value:!0,json:{read:{source:"disablePopup",reader:(e,r)=>!r.disablePopup},write:{target:"disablePopup",overridePolicy:O,writer(e,r,t){r[t]=!e}}}})],x.prototype,"popupEnabled",void 0),e([o({type:d,json:{read:{source:"popupInfo"},write:{target:"popupInfo",overridePolicy:O}}})],x.prototype,"popupTemplate",void 0),e([o({readOnly:!0,dependsOn:["title"]})],x.prototype,"defaultPopupTemplate",null),e([o({readOnly:!0,type:[j],dependsOn:["rasterInfo"]})],x.prototype,"fields",null),e([o({types:f,json:{name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:O},origins:{"web-scene":{types:g,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:e=>({enabled:e&&"vector-field"!==e.type})}}}}})],x.prototype,"renderer",null),e([a("renderer")],x.prototype,"readRenderer",null),x=e([n("esri.layers.ImageryTileLayer")],x);var L=x;export default L;
