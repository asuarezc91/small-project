/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as t}from"../chunks/tslib.es6.js";import"../core/has.js";import{isSome as e}from"../core/maybe.js";import i from"../core/Logger.js";import{ensureType as r}from"../core/accessorSupport/ensureType.js";import{property as o}from"../core/accessorSupport/decorators/property.js";import{cast as n}from"../core/accessorSupport/decorators/cast.js";import{subclass as s}from"../core/accessorSupport/decorators/subclass.js";import"../core/urlUtils.js";import"../core/uuid.js";import"../portal/support/resourceExtension.js";import{eachAlways as a,createAbortController as l,onAbortOrThrow as p,isAbortError as m}from"../core/promiseUtils.js";import{JSONSupport as h}from"../core/JSONSupport.js";import c from"../core/Collection.js";import{referenceSetter as u}from"../core/collectionUtils.js";import{result as d}from"../core/asyncUtils.js";import y from"../Basemap.js";import{c as g}from"../chunks/vec3f64.js";import{h as v}from"../chunks/vec3.js";import{moduloPositive as b}from"../views/3d/support/mathUtils.js";import{ensureType as f,clonePreservingTiledLayers as w}from"../support/basemapUtils.js";import L from"../layers/Layer.js";import j from"../Viewpoint.js";import T from"../webdoc/support/Thumbnail.js";import _ from"./Lighting.js";import{isOperationalLayer as C}from"../layers/mixins/OperationalLayer.js";import S from"./support/Description.js";import{SlideEnvironment as U}from"./support/SlideEnvironment.js";import V from"./support/SlideGround.js";import x from"./support/SlideVisibleLayer.js";import E from"./support/Title.js";let R=0;const k=c.ofType(x),D=i.getLogger("esri.webscene.Slide");let q=class extends h{constructor(t){super(t),this._applyToController=null,this.id=Date.now().toString(16)+"-slide-"+R++,this.title=new E,this.description=new S,this.thumbnail=new T,this.viewpoint=null,this.basemap=null,this.ground=null,this.environment=new U,this.visibleLayers=new k}destroy(){this.visibleLayers.removeAll(),this.basemap=null,this.thumbnail&&this.thumbnail.destroy(),this.description=null,this.title=null,this.thumbnail=null}castTitle(t){return"string"==typeof t?new E({text:t}):r(E,t)}castDescription(t){return"string"==typeof t?new S({text:t}):r(S,t)}castThumbnail(t){return"string"==typeof t?new T({url:t}):r(T,t)}castBasemap(t){return f(t)}set visibleLayers(t){this._set("visibleLayers",u(t,this._get("visibleLayers"),k))}castVisibleLayers(t){return t&&"function"==typeof t.map?t.map((t=>{if("string"==typeof t)return{id:t};if(t instanceof L){const e=I(t);return{id:t.id,sublayerIds:e}}return t.id?{id:t.id,sublayerIds:t.sublayerIds}:(D.warn('Invalid visible layer, expected { id }, Layer or "id"'),t)})):null}clone(){return new(0,this.constructor)({id:this.id,title:this.title.clone(),thumbnail:this.thumbnail.clone(),description:this.description&&this.description.clone()||null,viewpoint:this.viewpoint&&this.viewpoint.clone()||null,basemap:this.basemap&&this.basemap.clone()||null,ground:this.ground&&this.ground.clone()||null,visibleLayers:this.visibleLayers.clone(),environment:this.environment&&this.environment.clone()||null})}_updateVisibleLayersFrom(t){const e=[];return a(this._allLayers(t.map).map((i=>t.whenLayerView(i).then((t=>{if(t.visible){const r=I(i);e.push(new x({id:t.layer.id,sublayerIds:r}))}})))).toArray()).then((()=>{this.visibleLayers.removeAll(),this.visibleLayers.addMany(e)}))}updateFrom(t,e){return e={screenshot:{format:"png",quality:80,width:120,height:75,disableDecorations:!0,...e&&e.screenshot}},t.when((()=>(this.viewpoint=t.viewpoint.clone(),this.environment.lighting=_.prototype.clone.apply(t.environment.lighting),this.basemap=t.map.basemap&&t.map.basemap.clone()||null,this.ground=t.map.ground?V.fromGround(t.map.ground):null,this._updateVisibleLayersFrom(t)))).then((()=>t.takeScreenshot(e.screenshot))).then((t=>(this.thumbnail=new T({url:t.dataUrl}),this)))}async applyTo(t,e){var i;this._applyToController&&this._applyToController.abort();let r=l();this._applyToController=r;let o=p(e,(()=>r.abort()));const n={animate:!0,...e,signal:this._applyToController.signal},s=await d((async()=>{await this._applyBasemap(t,n),this._applyLayerVisibility(t),this._applyGround(t),await this._applyViewpoint(t,n)})());if(this._applyToController===r&&(this._applyToController=null),null==(i=o)||i.remove(),o=null,r=null,!1===s.ok)throw s.error;return this}async _applyBasemap(t,e){if(this.basemap){try{await this.basemap.load(e)}catch(t){if(m(t))throw t}t.map.basemap=w(this.basemap,t.map.basemap)}}_applyGround(t){this.ground&&(t.map.ground=this.ground.cloneAndApplyTo(t.map.ground))}_allLayers(t){const e=new c;return this._collectLayers(t,e),this._collectLayers(t.ground,e),e}_collectLayers(t,e){t.layers.forEach((t=>{if(!C(t))return;e.add(t);const i=t;i.layers&&this._collectLayers(i,e)}))}_applyLayerVisibility(t){if(!this.visibleLayers)return;this._allLayers(t.map).forEach((t=>{const e=this.visibleLayers.find((e=>e.id===t.id));t.visible=null!=e;const i=e&&e.sublayerIds,r=A(t);i&&r&&r.forEach((t=>t.visible=i.indexOf(t.id)>=0))}))}async _applyViewpoint(t,i){if(this.viewpoint&&!i.ignoreViewpoint){if(e(this.viewpoint.camera)&&(this.viewpoint.camera.fov=t.camera.fov),i.animate&&this.get("environment.lighting.date"))return void await this._animateToLighting(t,i);i.animate&&(t.environment.updateLighting(this.environment.lighting.clone()),await t.goTo(this.viewpoint,i)),t.viewpoint=this.viewpoint}t.environment.updateLighting(this.environment.lighting.clone())}async _animateToLighting(t,e){let i=null;"global"===t.viewingMode&&(i=this._animateLightingWithCamera(t)),t.environment.lighting.cameraTrackingEnabled=!1,t.environment.lighting.directShadowsEnabled=this.environment.lighting.directShadowsEnabled,null!=this.environment.lighting.displayUTCOffset&&(t.environment.lighting.displayUTCOffset=this.environment.lighting.displayUTCOffset);const r=t.goTo(this.viewpoint,e),o=()=>{i&&i.remove(),t.environment.lighting.cameraTrackingEnabled=!0};return r.then((()=>{t.environment.updateLighting(this.environment.lighting.clone()),o()}),(t=>{throw o(),t}))}_getTime(t){return[t.getTime(),3600*t.getUTCHours()+60*t.getUTCMinutes()+t.getUTCSeconds()]}_setTime(t,e,i){return t.setTime(e),t.setUTCHours(i/3600),t.setUTCMinutes(i%3600/60),t.setUTCSeconds(i%3600%60),t}_animateLightingWithCamera(t){const i=new Date(t.environment.lighting.date.toString()),[r,o]=this._getTime(i),[n,s]=this._getTime(this.environment.lighting.date),a=function(t,e){let i=e-t;i>43200&&(i-=86400);i<-43200&&(i+=86400);return i}(o,s),l=t.renderCoordsHelper,p=g();l.toRenderCoords(t.camera.position,p);const m=g(),h=g();e(this.viewpoint.camera)&&l.toRenderCoords(this.viewpoint.camera.position,m);const c=new Date;return t.watch("camera",(e=>{l.toRenderCoords(e.position,h);const i=v(p,h),s=v(m,h);let u=0;i+s!==0&&(u=i/(i+s));const d=r+(n-r)*u,y=function(t,e){return b(t+e,86400)}(o,a*u);t.environment.lighting.date=this._setTime(c,d,y)}))}static createFrom(t,e){return(new this).updateFrom(t,e)}};function A(t){if("building-scene"===t.type||"map-image"===t.type)return t.allSublayers.toArray()}function I(t){const e=A(t);if(e)return e.filter((t=>t.visible)).map((t=>t.id))}t([o({type:String,json:{write:{isRequired:!0}}})],q.prototype,"id",void 0),t([o({type:E,json:{default:()=>new E({text:""}),write:{isRequired:!0}}})],q.prototype,"title",void 0),t([n("title")],q.prototype,"castTitle",null),t([o({type:S,json:{write:{overridePolicy:t=>({enabled:!(!t||!t.text)})}}})],q.prototype,"description",void 0),t([n("description")],q.prototype,"castDescription",null),t([o({type:T,json:{default:()=>new T({url:""}),write:{isRequired:!0}}})],q.prototype,"thumbnail",void 0),t([n("thumbnail")],q.prototype,"castThumbnail",null),t([o({type:j,nonNullable:!0,json:{write:{isRequired:!0}}})],q.prototype,"viewpoint",void 0),t([o({type:y,json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],q.prototype,"basemap",void 0),t([n("basemap")],q.prototype,"castBasemap",null),t([o({type:V,json:{write:!0}})],q.prototype,"ground",void 0),t([o({type:k,json:{write:{isRequired:!0}}})],q.prototype,"visibleLayers",null),t([n("visibleLayers")],q.prototype,"castVisibleLayers",null),t([o({type:U,json:{write:!0}})],q.prototype,"environment",void 0),q=t([s("esri.webscene.Slide")],q);var M=q;export default M;
