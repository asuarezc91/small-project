/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import"../../core/has.js";import{Integer as e,isLongFormType as t}from"../../core/accessorSupport/ensureType.js";import{isCollection as n}from"../../core/accessorSupport/extensions/serializableProperty/type.js";import r from"../../Basemap.js";import a from"../../Ground.js";import{supportedTypes as p}from"../../layers/mixins/operationalLayers.js";import s from"../../WebScene.js";import{MapLayerSource as o}from"../../layers/support/source/MapLayerSource.js";import{J as y,D as u}from"../../chunks/DataLayerSource.js";import i from"../../layers/GroupLayer.js";import l from"../../layers/KMLLayer.js";import c from"../../layers/support/Sublayer.js";import{typeModuleMap as m}from"../../layers/mixins/operationalLayerModuleMap.js";import{ScanContext as f}from"./utils.js";async function d(e){return g(null,{typeName:"json",type:e},new f)}async function b(e,t,n){switch(t.typeName){case"array":await async function(e,t,n){await b(`${e}[]`,t.elementType,n)}(e,t,n);break;case"union":await async function(e,t,n){const r=[];for(const a of t.types)if("native"!==a.type.typeName&&t.key){const t=`${e}<${j(a.type,a.value)}>`;await b(t,a.type,n)}else r.push(a.type);if(r.length){const a=r.map(T);t.nullable&&a.push("null"),a.sort(),n.addProperty({type:a.join("|"),name:e,default:t.default})}}(e,t,n);break;case"json":await g(e,t,n);break;case"native":await async function(e,t,n){n.addProperty({name:e,type:T(t),default:t.default})}(e,t,n);break;case"enum":await async function(e,t,n){const r=t.values.slice();t.nullable&&r.push(null);n.currentClass&&n.currentClass.typeValue&&"type"===e?n.addProperty({name:e,type:"string",enum:`"${n.currentClass.typeValue}"`}):n.addProperty({name:e,type:T(t),enum:w(r).map((e=>"string"==typeof e?`"${e}"`:`${e}`)).join("|"),default:t.default})}(e,t,n)}}function w(e){const t=e.slice();return t.sort(),t}function j(e,t){if("json"===e.typeName){const t=e.type.__accessorMetadata__,n=t&&t.properties&&t.properties&&t.properties.type,r=n&&O(n),a=r&&r.type,p=a||n&&n.type;if(p&&Array.isArray(p)&&1===p.length&&"string"==typeof p[0])return a?p[0]:L(n,p[0])}return t}async function N(e,t){return e.type===s&&"layers"===t?k("web-scene/operational-layers"):e.type!==r||"baseLayers"!==t&&"baseMapLayers"!==t?e.type===r&&"elevationLayers"===t||e.type===a&&"layers"===t?k("web-scene/ground"):e.type===i&&"layers"===t?k("web-scene/operational-layers",(e=>e!==i)):e.type!==y||"leftTableSource"!==t&&"rightTableSource"!==t?null:S({key:"type",base:null,typeMap:{"data-layer":u,"map-layer":o}}):k("web-scene/basemap")}async function v(e,t,n){const r=await N(e,t);return r||function(e){const t=O(e);if(t.types)return S(t.types);if(!t.type&&e.types)return S(e.types);return M(function(e){const t=O(e),n=A(e),r=P(t&&t.type||e.type);t&&void 0!==t.default&&"function"!=typeof t.default&&(r.default=L(e,t.default));n.allowNull&&(r.nullable=!0);return r}(e))}(n)}async function g(e,t,n){const r=t.type.__accessorMetadata__,a=t.type.prototype.declaredClass.replace(/\./g,"/");const p=r&&r.properties;if(!p)return e&&n.addProperty({name:e,type:"unknown"}),null;let s=a,o=null;const y=e&&e.match(/<([^>]+)>$/);y&&(s+=`--${y[1]}`,o=y[1]),t.type===c&&(s+=`--${n.currentClass.name}`,o=n.currentClass.name);const u=n.seen.get(s);if(u&&e)return n.addProperty({name:e,type:u}),u;const i={type:t.type,name:a,id:s,properties:[]};e&&(n.addProperty({name:e,type:i}),i.typeValue=o),n.push(e,i);for(const e in p){const r=p[e],a=A(r);if(!a||!a.enabled)continue;if(t.type===c){const e="esri/layers/TileLayer"===n.stack[n.stack.length-2].klass.name;if(e&&c.test.isMapImageLayerOverridePolicy(a.overridePolicy)||!e&&c.test.isTileImageLayerOverridePolicy(a.overridePolicy))continue}const s=a.target;if("string"==typeof s||null==s){const a=await v(t,e,r);if(!a)continue;await b("string"==typeof s?s:e,a,n)}else await h(t,s,n)}return n.pop()}async function h(e,t,n){for(const r in t){let a=await N(e,r);if(!a){const e=t[r];a=e.types?S(e.types):P(e.type),a.default=e.default,a=M(a)}await b(r,a,n)}}async function k(e,t){const n={typeName:"union",key:"layerType",types:[]};for(const r in p[e]){if("web-scene/operational-layers"===e&&"ArcGISTiledElevationServiceLayer"===r)continue;const a=await m[r]();a&&(t&&!t(a)||a!==l&&n.types.push({type:{typeName:"json",type:a},value:r}))}if(0===n.types.length)return null;return{typeName:"array",elementType:1===n.types.length?n.types[0].type:n}}function T(t){switch(t.typeName){case"array":return`${T(t.elementType)}[]`;case"union":{const e=t.types.map((e=>T(e.type)));return t.nullable&&e.push("null"),e.sort(),`${e.join(" | ")}`}case"native":switch(t.type){case Number:return"number";case e:return"integer";case String:return"string";case Boolean:return"boolean";case Object:return"object";default:return"unknown"}case"json":return t.type.prototype.declaredClass;case"enum":return"string";default:return}}function M(e){if("array"===e.typeName)return e.elementType=M(e.elementType),e;const t=function(e){if("json"!==e.typeName)return null;const t=e.type.__accessorMetadata__,n=t&&t.properties&&t.properties.type,r=n&&O(n),a=r&&r.type,p=a||n&&n.type;return p&&Array.isArray(p)&&"string"==typeof p[0]?a||n.type.map((e=>L(n,e))):null}(e);return t?{typeName:"union",key:"type",types:t.map((t=>({value:t,type:e})))}:e}function S(e){if(Array.isArray(e))return{typeName:"array",elementType:S(e[0])};const t=[];for(const n in e.typeMap){const r=e.typeMap[n];t.push({type:P(r),value:$(r)?null:n})}return{typeName:"union",key:"string"==typeof e.key?e.key:"type",types:t}}function L(e,t){const n=A(e);if(null!=(r=n.writer)&&r.isJSONMapWriter){const e={value:""};return n.writer(t,e,"value"),e.value}var r;return t}function P(e){return e?t(e)?_(e):Array.isArray(e)?"string"==typeof e[0]||"number"==typeof e[0]?{typeName:"enum",values:e}:e.length>1?{typeName:"union",key:null,types:e.map((e=>({type:P(e),value:null})))}:{typeName:"array",elementType:P(e[0])}:n(e)?function(e){const t=e.prototype.itemType&&e.prototype.itemType.Type;if(!t)return{typeName:"array",elementType:{typeName:"native",type:null}};if("function"==typeof t)return{typeName:"array",elementType:P(t)};if(t.typeMap){const e=[];for(const n in t.typeMap){const r=t.typeMap[n];e.push({type:P(r),value:$(r)?null:n})}return{typeName:"array",elementType:{typeName:"union",key:"string"==typeof t.key?t.key:"type",types:e}}}}(e):$(e)?{typeName:"native",type:e}:function(e){let t=e;for(;t;){if(t.prototype&&("esri.core.JSONSupport"===t.prototype.declaredClass||"esri.core.MultiOriginJSONSupport"===t.prototype.declaredClass))return!0;t=Object.getPrototypeOf(t)}return!1}(e)?{typeName:"json",type:e}:{typeName:"native",type:null}:{typeName:"native",type:null}}function _(e){switch(e.type){case"native":return{typeName:"native",type:e.value};case"array":return{typeName:"array",elementType:P(e.value)};case"one-of":return{typeName:"union",key:null,types:e.values.map((e=>({type:_(e),value:null})))};default:return}}function $(t){return t===String||t===Boolean||t===Number||t===e||t===Object}function O(e){if(!e.json)return null;const t=e.json.origins,n=e.json,r=t&&t["web-scene"],a=t&&t["web-document"];return r||a||n||null}function A(e){if(!e.json)return null;const t=e.json.origins,n=e.json.write,r=t&&t["web-scene"]&&t["web-scene"].write,a=t&&t["web-document"]&&t["web-document"].write;return r||a||n||null}export{d as scan};
