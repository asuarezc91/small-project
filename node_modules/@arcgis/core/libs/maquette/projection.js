/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{renderingSanitizer as e}from"../../widgets/support/widgetUtils.js";const t="http://www.w3.org/2000/svg",o=[];let r=(e,t)=>{const o={};return Object.keys(e).forEach((t=>{o[t]=e[t]})),t&&Object.keys(t).forEach((e=>{o[e]=t[e]})),o};const n=(e,t)=>e.vnodeSelector===t.vnodeSelector&&(e.properties&&t.properties?e.properties.key===t.properties.key&&e.properties.bind===t.properties.bind:!e.properties&&!t.properties),s=e=>{if("string"!=typeof e)throw new Error("Style values must be strings")},i=(e,t,o)=>{if(""!==t.vnodeSelector)for(let r=o;r<e.length;r++)if(n(e[r],t))return r;return-1},p=(e,t,o,r)=>{const s=e[t];if(""===s.vnodeSelector)return;const i=s.properties;if(!(i?void 0===i.key?i.bind:i.key:void 0))for(let i=0;i<e.length;i++)if(i!==t){const t=e[i];if(n(t,s))throw new Error(`${o.vnodeSelector} had a ${s.vnodeSelector} child ${"added"===r?r:"removed"}, but there is now more than one. You must add unique key properties to make them distinguishable.`)}},d=e=>{if(e.properties){const t=e.properties.enterAnimation;t&&t(e.domNode,e.properties)}},l=[];let c=!1;const a=e=>{(e.children||[]).forEach(a),e.properties&&e.properties.afterRemoved&&e.properties.afterRemoved.apply(e.properties.bind||e.properties,[e.domNode])},f=()=>{c=!1,l.forEach(a),l.length=0},u=e=>{l.push(e),c||(c=!0,"undefined"!=typeof window&&"requestIdleCallback"in window?window.requestIdleCallback(f,{timeout:16}):setTimeout(f,16))},h=e=>{const t=e.domNode;if(e.properties){const o=e.properties.exitAnimation;if(o){t.style.pointerEvents="none";const r=()=>{t.parentNode&&(t.parentNode.removeChild(t),u(e))};return void o(t,r,e.properties)}}t.parentNode&&(t.parentNode.removeChild(t),u(e))},m=(o,r,n)=>{if(!r)return;const i=n.eventHandlerInterceptor,p=Object.keys(r),d=p.length;for(let l=0;l<d;l++){const d=p[l];let c=r[d];if("className"===d)throw new Error('Property "className" is not supported, use "class".');if("class"===d)w(o,c,!0);else if("classes"===d){const e=Object.keys(c),t=e.length;for(let r=0;r<t;r++){const t=e[r];c[t]&&o.classList.add(t)}}else if("styles"===d){const e=Object.keys(c),t=e.length;for(let r=0;r<t;r++){const t=e[r],i=c[t];i&&(s(i),n.styleApplyer(o,t,i))}}else if("key"!==d&&null!=c){const s=typeof c;"function"===s?0===d.lastIndexOf("on",0)&&(i&&(c=i(d,c,o,r)),"oninput"===d&&function(){const e=c;c=function(t){e.apply(this,[t]),t.target["oninput-value"]=t.target.value}}(),o[d]=c):n.namespace===t?"href"===d?o.setAttributeNS("http://www.w3.org/1999/xlink",d,c):o.setAttribute(d,c):"string"===s&&"value"!==d?"innerHTML"===d?o[d]=e.sanitize(c):o.setAttribute(d,c):o[d]=c}}};let v,y=(e,t,o)=>{((e,t,o)=>{if(t)for(const r of t)g(r,e,void 0,o)})(e,t.children,o),t.text&&(e.textContent=t.text),m(e,t.properties,o),t.properties&&t.properties.afterCreate&&t.properties.afterCreate.apply(t.properties.bind||t.properties,[e,o,t.vnodeSelector,t.properties,t.children])},g=(e,o,n,s)=>{let i,p=0;const d=e.vnodeSelector,l=o.ownerDocument;if(""===d)i=e.domNode=l.createTextNode(e.text),void 0!==n?o.insertBefore(i,n):o.appendChild(i);else{for(let c=0;c<=d.length;++c){const a=d.charAt(c);if(c===d.length||"."===a||"#"===a){const a=d.charAt(p-1),f=d.slice(p,c);"."===a?i.classList.add(f):"#"===a?i.id=f:("svg"===f&&(s=r(s,{namespace:t})),void 0!==s.namespace?i=e.domNode=l.createElementNS(s.namespace,f):(i=e.domNode=e.domNode||l.createElement(f),"input"===f&&e.properties&&void 0!==e.properties.type&&i.setAttribute("type",e.properties.type)),void 0!==n?o.insertBefore(i,n):i.parentNode!==o&&o.appendChild(i)),p=c+1}}y(i,e,s)}};const w=(e,t,o)=>{t&&t.split(" ").forEach((t=>{t&&e.classList.toggle(t,o)}))};v=(l,c,a)=>{const f=l.domNode;let u=!1;if(l===c)return!1;let m=!1;if(""===c.vnodeSelector){if(c.text!==l.text){const e=f.ownerDocument.createTextNode(c.text);return f.parentNode.replaceChild(e,f),c.domNode=e,u=!0,u}c.domNode=f}else 0===c.vnodeSelector.lastIndexOf("svg",0)&&(a=r(a,{namespace:t})),l.text!==c.text&&(m=!0,void 0===c.text?f.removeChild(f.firstChild):f.textContent=c.text),c.domNode=f,m=((e,t,r,s,l)=>{if(r===s)return!1;s=s||o;const c=(r=r||o).length,a=s.length;let f,u=0,m=0,y=!1;for(;m<a;){const o=u<c?r[u]:void 0,a=s[m];if(void 0!==o&&n(o,a))y=v(o,a,l)||y,u++;else{const o=i(r,a,u+1);if(o>=0){for(f=u;f<o;f++)h(r[f]),p(r,f,e,"removed");y=v(r[o],a,l)||y,u=o+1}else g(a,t,u<c?r[u].domNode:void 0,l),d(a),p(s,m,e,"added")}m++}if(c>u)for(f=u;f<c;f++)h(r[f]),p(r,f,e,"removed");return y})(c,f,l.children,c.children,a)||m,m=((o,r,n,i)=>{if(!n)return;let p=!1;const d=Object.keys(n),l=d.length;for(let c=0;c<l;c++){const l=d[c];let a=n[l];const f=r[l];if("class"===l)f!==a&&(w(o,f,!1),w(o,a,!0));else if("classes"===l){const e=o.classList,t=Object.keys(a),r=t.length;for(let o=0;o<r;o++){const r=t[o],n=!!a[r];n!==!!f[r]&&(p=!0,n?e.add(r):e.remove(r))}}else if("styles"===l){const e=Object.keys(a),t=e.length;for(let r=0;r<t;r++){const t=e[r],n=a[t];n!==f[t]&&(p=!0,n?(s(n),i.styleApplyer(o,t,n)):i.styleApplyer(o,t,""))}}else if(a||"string"!=typeof f||(a=""),"value"===l){const e=o[l];e!==a&&(o["oninput-value"]?e===o["oninput-value"]:a!==f)&&(o[l]=a,o["oninput-value"]=void 0),a!==f&&(p=!0)}else if(a!==f){const r=typeof a;"function"===r&&i.eventHandlerInterceptor||(i.namespace===t?"href"===l?o.setAttributeNS("http://www.w3.org/1999/xlink",l,a):o.setAttribute(l,a):"string"===r?"innerHTML"===l?o[l]=e.sanitize(a):"role"===l&&""===a?o.removeAttribute(l):o.setAttribute(l,a):o[l]!==a&&(o[l]=a),p=!0)}}return p})(f,l.properties,c.properties,a)||m,c.properties&&c.properties.afterUpdate&&c.properties.afterUpdate.apply(c.properties.bind||c.properties,[f,a,c.vnodeSelector,c.properties,c.children]);return m&&c.properties&&c.properties.updateAnimation&&c.properties.updateAnimation(f,c.properties,l.properties),u};let b=(e,t)=>({getLastRender:()=>e,update:o=>{if(e.vnodeSelector!==o.vnodeSelector)throw new Error("The selector for the root VNode may not be changed. (consider using dom.merge and add one extra level to the virtual DOM)");const r=e;e=o,v(r,o,t)},domNode:e.domNode});export{g as createDom,b as createProjection,r as extend,y as initPropertiesAndChildren};
