/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import"../../core/has.js";import{isNone as e,isSome as t}from"../../core/maybe.js";import s from"../../core/Logger.js";import a from"../../core/Error.js";import{reject as o,resolve as r,eachAlways as l}from"../../core/promiseUtils.js";import{pt2px as n}from"../../core/screenUtils.js";import{defaultPrimitive as i}from"./IconSymbol3DLayerResource.js";import{getAssetUrl as c}from"../../assets.js";import{defaultPrimitive as h}from"./ObjectSymbol3DLayerResource.js";import{toHSV as p,toRGB as u}from"../../core/colorUtils.js";import{resolveWebStyleSymbol as m}from"./styleUtils.js";import{getPatternUrlWithColor as f,defaultThematicColor as y}from"./gfxUtils.js";import{isVolumetricSymbol as d,getIconHref as b}from"./utils.js";import{adjustColorComponentBrightness as g,getPathSymbolShapes as v,shapes as k,getTetrahedronShapes as w,getDiamondShapes as x,getCylinderShapes as M,getCubeShapes as L,getInvertedConeShapes as j,getConeShapes as z,getWaterSymbolShapes as S,getExtrudeSymbolShapes as U}from"./previewUtils.js";import{renderSymbol as D,tintImageWithColor as O}from"./renderUtils.js";const R=c("esri/symbols/patterns/"),I=c("esri/images/Legend/legend3dsymboldefault.png"),E=s.getLogger("esri.symbols.support.previewSymbol3D");function P(s){const a=s.outline,o=t(s.material)?s.material.color:null,r=t(o)?o.toRgba().toString():null;if(e(a))return"fill"===s.type&&"255,255,255,1"===r?{color:"#bdc3c7",width:.75}:null;const l=n(a.size)||0;return{color:"rgba("+(t(a.color)?a.color.toRgba():"255,255,255,1")+")",width:Math.min(l,80)}}function C(e,t=1){const s=e.a,a=p(e),o=a.h,r=a.s/t,l=100-(100-a.v)/t,{r:n,g:i,b:c}=u({h:o,s:r,v:l});return[n,i,c,s]}function Z(t){return"water"===t.type?e(t.color)?null:t.color:e(t.material)||e(t.material.color)?null:t.material.color}function q(e,t=0){const s=Z(e);if(!s){const e=y.r,s=g(e,t);return[s,s,s,100]}const a=s.toRgba();for(let e=0;e<3;e++)a[e]=g(a[e],t);return a}async function A(e,t){const s=e.style;if("none"===s)return null;return{type:"pattern",x:0,y:0,src:await f(`${R}${s}.png`,t.toCss(!0)),width:5,height:5}}function N(e){return e.outline?P(e):{color:"rgba(0, 0, 0, 1)",width:1.5}}function T(e,t){const s=Z(e);if(!s)return null;let a="rgba(";return a+=g(s.r,t)+",",a+=g(s.g,t)+",",a+=g(s.b,t)+",",a+s.a+");"}function $(e,t){const s=T(e,t);if(!s)return{};return{color:s,width:Math.min(e.size?n(e.size):.75,80)}}function H(e,t,s){const a=.75*s;return{type:"linear",x1:a?.25*a:0,y1:a?.5*a:0,x2:a||4,y2:a?.5*a:4,colors:[{color:e,offset:0},{color:t,offset:1}]}}function B(e,t){const s=t&&t.size?n(t.size):null,a=t&&t.maxSize?n(t.maxSize):null,o=t&&t.disableUpsampling,c=e.symbolLayers,p=[];let u=0,f=0;const y=c.getItemAt(c.length-1);let d;return y&&"icon"===y.type&&(d=y.size&&n(y.size)),c.forEach((l=>{if("icon"!==l.type&&"object"!==l.type)return;const c="icon"===l.type?l.size&&n(l.size):0,y=s||c?Math.ceil(Math.min(s||c,a||120)):22;if(l&&l.resource&&l.resource.href){const t=function(e,t){const s=t&&t.resource,a=s&&s.href;return e.thumbnail&&e.thumbnail.url?r(e.thumbnail.url):a&&"object"!==t.type?r(b(e,t)):e.styleOrigin&&(e.styleOrigin.styleName||e.styleOrigin.styleUrl)?m(e.styleOrigin,{portal:e.styleOrigin.portal},"webRef").catch((e=>e)).then((e=>e&&e.thumbnail&&e.thumbnail.url||I)):r(I)}(e,l).then((function(e){const t=l.get("material.color"),s=function(e){return"icon"===e.type?"multiply":"tint"}(l);return O(e,y,t,s,o)})).then((function(e){const t=e.width,s=e.height;return u=Math.max(u,t),f=Math.max(f,s),[{shape:{type:"image",x:0,y:0,width:t,height:s,src:e.url},fill:null,stroke:null}]}));p.push(t)}else{var g;let e=y;"icon"===l.type&&d&&s&&(e=y*(c/d));const a="tall"===(null==t?void 0:t.symbolConfig)||(null==t||null==(g=t.symbolConfig)?void 0:g.isTall)||"object"===l.type&&function(e){const t=e.depth,s=e.height,a=e.width;return a&&t&&s&&a===t&&a<s}(l);u=Math.max(u,a?20:e),f=Math.max(f,e),p.push(r(function(e,t,s){const a=[];if(!e)return a;switch(e.type){case"icon":{const s=0,o=0,r=t,l=t;switch(e.resource&&e.resource.primitive||i){case"circle":a.push({shape:{type:"circle",cx:0,cy:0,r:.5*t},fill:q(e,0),stroke:P(e)});break;case"square":a.push({shape:{type:"path",path:[{command:"M",values:[s,l]},{command:"L",values:[s,o]},{command:"L",values:[r,o]},{command:"L",values:[r,l]},{command:"Z",values:[]}]},fill:q(e,0),stroke:P(e)});break;case"triangle":a.push({shape:{type:"path",path:[{command:"M",values:[s,l]},{command:"L",values:[.5*r,o]},{command:"L",values:[r,l]},{command:"Z",values:[]}]},fill:q(e,0),stroke:P(e)});break;case"cross":a.push({shape:{type:"path",path:[{command:"M",values:[.5*r,o]},{command:"L",values:[.5*r,l]},{command:"M",values:[s,.5*l]},{command:"L",values:[r,.5*l]}]},stroke:N(e)});break;case"x":a.push({shape:{type:"path",path:[{command:"M",values:[s,o]},{command:"L",values:[r,l]},{command:"M",values:[r,o]},{command:"L",values:[s,l]}]},stroke:N(e)});break;case"kite":a.push({shape:{type:"path",path:[{command:"M",values:[s,.5*l]},{command:"L",values:[.5*r,o]},{command:"L",values:[r,.5*l]},{command:"L",values:[.5*r,l]},{command:"Z",values:[]}]},fill:q(e,0),stroke:P(e)})}break}case"object":switch(e.resource&&e.resource.primitive||h){case"cone":{const o=H(q(e,0),q(e,-.6),s?20:t),r=z(t,s);a.push({shape:r[0],fill:o}),a.push({shape:r[1],fill:o});break}case"inverted-cone":{const s=q(e,0),o=H(s,q(e,-.6),t),r=j(t);a.push({shape:r[0],fill:o}),a.push({shape:r[1],fill:s});break}case"cube":{const o=L(t,s);a.push({shape:o[0],fill:q(e,0)}),a.push({shape:o[1],fill:q(e,-.3)}),a.push({shape:o[2],fill:q(e,-.5)});break}case"cylinder":{const o=H(q(e,0),q(e,-.6),s?20:t),r=M(t,s);a.push({shape:r[0],fill:o}),a.push({shape:r[1],fill:o}),a.push({shape:r[2],fill:q(e,0)});break}case"diamond":{const s=x(t);a.push({shape:s[0],fill:q(e,-.3)}),a.push({shape:s[1],fill:q(e,0)}),a.push({shape:s[2],fill:q(e,-.3)}),a.push({shape:s[3],fill:q(e,-.7)});break}case"sphere":{const s=H(q(e,0),q(e,-.6));s.x1=0,s.y1=0,s.x2=.25*t,s.y2=.25*t,a.push({shape:{type:"circle",cx:0,cy:0,r:.5*t},fill:s});break}case"tetrahedron":{const s=w(t);a.push({shape:s[0],fill:q(e,-.3)}),a.push({shape:s[1],fill:q(e,0)}),a.push({shape:s[2],fill:q(e,-.6)});break}}}return a}(l,e,a)))}})),l(p).then((function(e){const s=[];return e.forEach((function(e){e.value?s.push(e.value):e.error&&E.warn("error while building swatchInfo!",e.error)})),D(s,[u,f],{node:t&&t.node,scale:!1,opacity:t&&t.opacity})}))}function F(e,s){if(0===e.symbolLayers.length)return o(new a("symbolPreview: renderPreviewHTML3D","No symbolLayers in the symbol."));let l=null;switch(e.type){case"point-3d":l=B(e,s);break;case"line-3d":l=function(e,t){const s=e.symbolLayers,a=[],o=d(e),l=t&&t.size?n(t.size):null,i=(t&&t.maxSize?n(t.maxSize):null)||80;let c,h=0,p=0;return s.forEach(((e,t)=>{if(!e)return;if("line"!==e.type&&"path"!==e.type)return;const s=[];switch(e.type){case"line":{const a=$(e,0),o=a&&a.width||0;0===t&&(c=o);const r=Math.min(l||o,i),n=0===t?r:l?r*(o/c):r,u=n>20?2*n:40;p=Math.max(p,n),h=Math.max(h,u),a.width=n,s.push({shape:{type:"path",path:[{command:"M",values:[0,.5*p]},{command:"L",values:[h,.5*p]}]},stroke:a});break}case"path":{const t=Math.min(l||22,i),a=q(e,0),o=q(e,-.2),r=T(e,-.4),n=r?{color:r,width:1}:{};if("quad"===e.profile){const t=e.width||e.size,r=e.height||e.size,l=v(t&&r?t/r:1),i={...n,join:"bevel"};s.push({shape:l[0],fill:o,stroke:i}),s.push({shape:l[1],fill:o,stroke:i}),s.push({shape:l[2],fill:a,stroke:i})}else s.push({shape:k.pathSymbol3DLayer[0],fill:o,stroke:n}),s.push({shape:k.pathSymbol3DLayer[1],fill:a,stroke:n});p=Math.max(p,t),h=p}}a.push(s)})),r(D(a,[h,p],{node:t&&t.node,scale:o,opacity:t&&t.opacity}))}(e,s);break;case"polygon-3d":case"mesh-3d":l=async function(e,s){const a="mesh-3d"===e.type,o=e.symbolLayers,l=s&&s.size?n(s.size):null,i=s&&s.maxSize?n(s.maxSize):null,c=l||22,h=[];let p=0,u=0,m=!1;for(let e=0;e<o.length;e++){const s=o.getItemAt(e),r=[];if(a&&"fill"!==s.type)continue;const l=k.fill[0];switch(s.type){case"fill":{const e=P(s),o=Math.min(c,i||120);p=Math.max(p,o),u=Math.max(u,o),m=!0;let n=q(s,0);const h="pattern"in s&&s.pattern,f=Z(s);!a&&t(h)&&"style"===h.type&&"solid"!==h.style&&f&&(n=await A(h,f)),r.push({shape:l,fill:n,stroke:e});break}case"line":{const e={stroke:$(s,0),shape:l};p=Math.max(p,22),u=Math.max(u,22),r.push(e);break}case"extrude":{const e={join:"round",...$(s,-.4)},t=q(s,0),a=q(s,-.2),o=Math.min(c,i||120),l=U(o);e.width=1,r.push({shape:l[0],fill:a,stroke:e}),r.push({shape:l[1],fill:a,stroke:e}),r.push({shape:l[2],fill:t,stroke:e});const n=22,h=22*.7+.5*o;p=Math.max(p,n),u=Math.max(u,h);break}case"water":{const e=Z(s),t=C(e),a=C(e,2),o=C(e,3),l=S();m=!0,r.push({shape:l[0],fill:t}),r.push({shape:l[1],fill:a}),r.push({shape:l[2],fill:o});const n=Math.min(c,i||120);p=Math.max(p,n),u=Math.max(u,n);break}}h.push(r)}return r(D(h,[p,u],{node:s&&s.node,scale:m,opacity:s&&s.opacity}))}(e,s)}return l||o(new a("symbolPreview: swatchInfo3D","symbol not supported."))}export{A as getPatternDescriptor,q as getSymbolLayerFill,F as previewSymbol3D};
