/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import"../../core/has.js";import{isSome as e,isNone as t,unwrap as l}from"../../core/maybe.js";import{loadArcade as i}from"../../support/arcadeOnDemand.js";import{applyColorToSymbol as o,applySizesToSymbol as r,applyRotationToSymbol as a}from"./utils.js";let s=null;function n(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function c(e,t,l){const{backgroundColor:i,outline:o,dotSize:r}=e,a=l&&l.swatchSize||22,c=Math.round(a*a/Math.pow(r,2)*.8),u=window.devicePixelRatio,p=document.createElement("canvas"),h=a*u;p.width=h,p.height=h,p.style.width=p.width/u+"px",p.style.height=p.height/u+"px";const y=p.getContext("2d");if(i&&(y.fillStyle=i.toCss(!0),y.fillRect(0,0,h,h),y.fill()),y.fillStyle=t.toCss(!0),s&&s.length/2===c)for(let e=0;e<2*c;e+=2){const t=s[e],l=s[e+1];y.fillRect(t,l,r*u,r*u),y.fill()}else{s=[];for(let e=0;e<2*c;e+=2){const e=n(0,h),t=n(0,h);s.push(e,t),y.fillRect(e,t,r*u,r*u),y.fill()}}o&&(o.color&&(y.strokeStyle=o.color.toCss(!0)),y.lineWidth=o.width,y.strokeRect(0,0,h,h));const d=new Image(a,a);return d.src=p.toDataURL(),d}function u(e,t={}){const l="horizontal"===t.align,i=l?75:24,o=l?24:75,{width:r=i,height:a=o,gradient:s=!0}=t,n=window.devicePixelRatio,c=r*n,u=a*n,p=document.createElement("canvas");p.width=c,p.height=u,p.style.width=`${r}px`,p.style.height=`${a}px`;const h=p.getContext("2d"),y=l?c:0,d=l?0:u;if(s){const t=h.createLinearGradient(0,0,y,d),l=1/(e.length-1);e.forEach(((e,i)=>t.addColorStop(i*l,e.toString()))),h.fillStyle=t,h.fillRect(0,0,c,u)}else{const t=l?c/e.length:c,i=l?u:u/e.length;let o=0,r=0;for(const a of e)h.fillStyle=a.toString(),h.fillRect(o,r,t,i),o=l?o+t:0,r=l?0:r+i}const m=document.createElement("div");return m.style.width=`${r}px`,m.style.height=`${a}px`,m.appendChild(p),m}async function p(e,t){switch(e.type){case"web-style":{const{previewWebStyleSymbol:l}=await import("./previewWebStyleSymbol.js");return l(e,p,t)}case"label-3d":case"line-3d":case"mesh-3d":case"point-3d":case"polygon-3d":{const{previewSymbol3D:l}=await import("./previewSymbol3D.js");return l(e,t)}case"simple-marker":case"simple-line":case"simple-fill":case"picture-marker":case"picture-fill":case"text":{const{previewSymbol2D:l}=await import("./previewSymbol2D.js");return l(e,t)}case"cim":{const{previewCIMSymbol:l}=await import("./previewCIMSymbol.js");return l(e,t)}default:return}}function h(e){return e&&"opacity"in e?e.opacity*h(e.parent):1}async function y(s,n){if(!s)return;const c=h(s.layer||s.sourceLayer);if(e(s.symbol)&&(!e(n)||!0!==n.ignoreGraphicSymbol)){const t="web-style"===s.symbol.type?await s.symbol.fetchSymbol(e(n)?n.abortOptions:null):s.symbol.clone();return o(t,null,c),t}const u=e(n)&&n.renderer||s.get("layer.renderer")||s.get("sourceLayer.renderer");let p=await u.getSymbolAsync(s);if(!p)return;if(p="web-style"===p.type?await p.fetchSymbol(e(n)?n.abortOptions:null):p.clone(),!("visualVariables"in u)||"visualVariables"in u&&!u.visualVariables||"visualVariables"in u&&u.visualVariables&&!u.visualVariables.length)return p;if(u.arcadeRequiredForVisualVariables&&(t(n)||t(n.arcade))){const e={...l(n)};e.arcade=await i(),n=e}const y=await import("../../renderers/visualVariables/support/visualVariableUtils.js"),d=[],m=[],f=[],b=[];for(const e of u.visualVariables)switch(e.type){case"color":d.push(e);break;case"opacity":m.push(e);break;case"rotation":b.push(e);break;case"size":e.target||f.push(e)}const w=!!d.length&&d[d.length-1],g=w?y.getColor(w,s,n):null,S=!!m.length&&m[m.length-1];let v=S?y.getOpacity(S,s,n):null;if(null!=c&&(v=null!=v?v*c:c),o(p,g,v),f.length){const e=y.getAllSizes(f,s,n);await r(p,e)}for(const e of b)a(p,y.getRotationAngle(e,s,n),e.axis);return p}export{y as getDisplayedSymbol,u as renderColorRampPreviewHTML,c as renderDotDensityPreviewHTML,p as renderPreviewHTML};
