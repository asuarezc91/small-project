/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{addFrameTask as e}from"../../../core/scheduling.js";import t from"./GamepadInputDevice.js";import{extractState as s,stateIdle as i,stateEqual as a}from"./GamepadState.js";class n{constructor(e,t){this.element=e,this.input=t,this._hasEventListeners=!1,this.onConnectGamepad=e=>{this.connectGamepad(e.gamepad)},this.onDisconnectGamepad=e=>{const t=e.gamepad,i=t.index,a=this.inputDevices[i];a&&(this.emitGamepadEvent(t,s(a),!1),this.inputDevices.splice(i,1),this.latestUpdate.splice(i,1),this.input.gamepad.devices.remove(a),this.ensurePollingState())},this.frameTask=null,this.latestUpdate=new Array,this.inputDevices=new Array,this.callback=null,this.supported="getGamepads"in window.navigator,this.supported&&(this.forEachGamepad(this.connectGamepad),window.addEventListener("gamepadconnected",this.onConnectGamepad),window.addEventListener("gamepaddisconnected",this.onDisconnectGamepad),this.ensurePollingState())}destroy(){this.hasEventListeners=!1,this.supported&&(window.removeEventListener("gamepadconnected",this.onConnectGamepad),window.removeEventListener("gamepaddisconnected",this.onDisconnectGamepad))}set hasEventListeners(e){this._hasEventListeners!==e&&(this._hasEventListeners=e,this.ensurePollingState())}get eventsEnabled(){return this.supported&&this.inputDevices.length>0&&this._hasEventListeners}set onEvent(e){this.callback=e}connectGamepad(e){const s=new t(e);"unknown"!==s.deviceType&&(this.inputDevices[e.index]=s,this.input.gamepad.devices.add(s)),this.ensurePollingState()}ensurePollingState(){this.eventsEnabled?this.startPolling():this.stopPolling()}startPolling(){null==this.frameTask&&(this.frameTask=e({update:()=>this.readGamepadState()}))}stopPolling(){null!=this.frameTask&&(this.frameTask.remove(),this.frameTask=null,this.latestUpdate=new Array)}readGamepadState(){const e=document.hasFocus(),t=this.element.contains(document.activeElement),n="document"===this.input.gamepad.enabledFocusMode&&!e||"view"===this.input.gamepad.enabledFocusMode&&!t;this.forEachGamepad((e=>{const t=this.inputDevices[e.index];if(!t)return;const d=this.latestUpdate[e.index],o=s(t),r=n||i(o);if(d){if(d.timestamp===e.timestamp)return;if(!d.active&&r)return;if(a(d.state,o))return}this.emitGamepadEvent(e,o,!r)}))}forEachGamepad(e){const t=window.navigator.getGamepads();for(let s=0;s<t.length;s++){const i=t[s];this.validate(i)&&e(i)}}emitGamepadEvent(e,t,s){const i=this.latestUpdate[e.index],a=i&&i.active;if(!a&&!s)return;const n=!a&&s?"start":a&&s?"update":"end";this.latestUpdate[e.index]={timestamp:e.timestamp,state:t,active:s},this.callback&&this.callback({device:this.inputDevices[e.index],state:t,action:n})}validate(e){if(!e)return!1;if(!e.connected)return!1;for(let t=0;t<e.axes.length;t++)if(isNaN(e.axes[t]))return!1;return!0}}export{n as GamepadSource};
