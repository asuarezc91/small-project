/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as t,isNone as e}from"../../../../core/maybe.js";import r from"../../../../core/Logger.js";import s from"../../../../core/Error.js";import i from"../../../webgl/VertexArrayObject.js";import{DisplayObject as h}from"../DisplayObject.js";import o from"./Mesh2D.js";const a=r.getLogger("esri.views.2d.engine.webgl.ClippingInfo"),c=t=>parseFloat(t)/100;class n extends h{constructor(t,e){super(),this._clip=e,this._cache={},this.stage=t,this._handle=e.watch("version",(()=>this._invalidate())),this.ready()}static fromClipArea(t,e){return new n(t,e)}_destroyGL(){t(this._cache.mesh)&&(this._cache.mesh.destroy(),this._cache.mesh=null),t(this._cache.vao)&&(this._cache.vao.dispose(),this._cache.vao=null)}destroy(){this._destroyGL(),this._handle.remove()}getVAO(t,r,s,h){const[o,a]=r.size;if("geometry"!==this._clip.type&&this._lastWidth===o&&this._lastHeight===a||(this._lastWidth=o,this._lastHeight=a,this._destroyGL()),e(this._cache.vao)){const e=this._createMesh(r,this._clip),o=e.getIndexBuffer(t),a=e.getVertexBuffers(t);this._cache.mesh=e,this._cache.vao=new i(t,s,h,a,o)}return this._cache.vao}_invalidate(){this._destroyGL(),this.requestRender()}_createScreenRect(t,e){const[r,s]=t.size,i="string"==typeof e.left?c(e.left)*r:e.left,h="string"==typeof e.right?c(e.right)*r:e.right,o="string"==typeof e.top?c(e.top)*s:e.top,a="string"==typeof e.bottom?c(e.bottom)*s:e.bottom,n=i,p=o;return{x:n,y:p,width:Math.max(r-h-n,0),height:Math.max(s-a-p,0)}}_createMesh(t,e){switch(e.type){case"rect":return o.fromRect(this._createScreenRect(t,e));case"path":return o.fromPath(e);case"geometry":return o.fromGeometry(t,e);default:return a.error(new s("mapview-bad-type","Unable to create ClippingInfo mesh from clip of type: ${clip.type}")),o.fromRect({x:0,y:0,width:1,height:1})}}}export default n;
