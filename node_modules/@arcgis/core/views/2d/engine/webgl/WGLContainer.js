/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import"../../../../core/has.js";import{isNone as e,isSome as r}from"../../../../core/maybe.js";import{WGLDrawPhase as s}from"./enums.js";import{Container as t}from"../Container.js";import{brushes as i}from"../brushes.js";import n from"./ClippingInfo.js";export default class extends t{constructor(){super(...arguments),this.name=this.constructor.name}set clips(e){this._clips=e,this.children.forEach((r=>r.clips=e)),this._updateClippingInfo()}doRender(e){const r=this.createRenderParams(e),{painter:t,globalOpacity:i,profiler:n,drawPhase:o}=r,a=o===s.LABEL?1:i*this.computedOpacity;n.recordContainerStart(this.name),t.beforeRenderLayer(r,this._clippingInfos?255:0,a),this.updateTransforms(e.state),this.renderChildren(r),t.compositeLayer(r,a),n.recordContainerEnd()}renderChildren(r){e(this._renderPasses)&&(this._renderPasses=this.prepareRenderPasses(r.painter));for(const e of this.children)e.beforeRender(r);for(const e of this._renderPasses)try{e.render(r)}catch(e){}for(const e of this.children)e.afterRender(r)}createRenderParams(e){return e}prepareRenderPasses(e){return[e.registerRenderPass({name:"clip",brushes:[i.clip],target:()=>this._clippingInfos,drawPhase:s.MAP|s.LABEL|s.LABEL_ALPHA|s.DEBUG|s.HIGHLIGHT})]}updateTransforms(e){for(const r of this.children)r.setTransform(e)}onAttach(){super.onAttach(),this._updateClippingInfo()}onDetach(){super.onDetach(),this._updateClippingInfo()}_updateClippingInfo(){if(r(this._clippingInfos)&&(this._clippingInfos.forEach((e=>e.destroy())),this._clippingInfos=null),!this.stage)return;const e=this._clips;r(e)&&e.length&&(this._clippingInfos=e.items.map((e=>n.fromClipArea(this.stage,e)))),this.requestRender()}}
