/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{pt2px as t}from"../../../../../../core/screenUtils.js";import{SPRITE_PADDING as i}from"../../definitions.js";import{i1616to32 as e}from"../../number.js";import{LineMaterialKey as s}from"../../materialKey/MaterialKey.js";import{premultiplyAlphaRGBA as r}from"../../color.js";import{ok as o}from"../../util/Result.js";import{isFunction as a,getLimitCosine as l}from"./util.js";import h from"./WGLDynamicMeshTemplate.js";import n from"./WGLBaseLineTemplate.js";class m extends(n(h)){constructor(i){super(i),this._cimLineLayer=i;let e=0;a(i.width)||(e=.5*t(i.width));if(this._dynamicPropertyMap.set("_halfWidth",((s,r,o)=>a(i.width)?.5*t(i.width(s,r,o)):e)),a(i.cap)?this._dynamicPropertyMap.set("_capType",i.cap):this._capType=i.cap,a(i.join)?this._dynamicPropertyMap.set("_joinType",i.join):this._joinType=i.join,a(i.color)){const t=(t,e,s)=>{const o=i.color(t,e,s);return o&&r(o)||0};this._dynamicPropertyMap.set("_fillColor",t)}else{const t=i.color;this._fillColor=t&&r(t)||0}if(a(i.miterLimit)){const t=(t,e,s)=>l(i.miterLimit(t,e,s));this._dynamicPropertyMap.set("_miterLimitCosine",t)}else this._miterLimitCosine=l(i.miterLimit);this._scaleFactor=i.scaleFactor||1,this._isDashed=i.isDashed,this.effects=i.effects,this.tessellationProperties._bitset=i.colorLocked?1:0,this._materialKey=i.materialKey,this._initializeTessellator(!0)}static fromCIMLine(t){return new m(t)}bindFeature(t,r,a){const l=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,i)=>{this[i]=t(l,r,a)})),this._halfWidth*=this._scaleFactor;const h=this._materialCache,n=(0,this._cimLineLayer.materialHash)(l,r,a),m=h.get(n);let c=null;if(m&&o(m.spriteMosaicItem)&&(c=m.spriteMosaicItem),c){this._hasPattern=!0;const{rect:t,width:s,height:r}=c,o=t.x+i,a=t.y+i,l=o+s,h=a+r;this.tessellationProperties._tl=e(o,a),this.tessellationProperties._br=e(l,h)}else this._hasPattern=!1,this.tessellationProperties._tl=0,this.tessellationProperties._br=0;this.tessellationProperties._fillColor=this._fillColor,this.tessellationProperties._halfWidth=this._halfWidth,this.tessellationProperties._halfReferenceWidth=this.tessellationProperties._halfWidth;const p=s.load(this._materialKey);c&&(p.sdf=c.sdf,p.pattern=!0,p.textureBinding=c.textureBinding),this._materialKey=p.data}}export default m;
