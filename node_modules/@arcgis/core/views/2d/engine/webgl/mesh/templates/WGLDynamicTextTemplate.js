/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{pt2px as t}from"../../../../../../core/screenUtils.js";import{getXAnchorDirection as e,getYAnchorDirection as i}from"../../alignmentUtils.js";import{TextMaterialKey as s}from"../../materialKey/MaterialKey.js";import{premultiplyAlphaRGBA as o}from"../../color.js";import{isFunction as a}from"./util.js";import r from"./WGLBaseTextTemplate.js";import n from"./WGLDynamicMeshTemplate.js";import{codepoints as l}from"../../../../layers/features/textUtils.js";class h extends(r(n)){constructor(e){super(e),this._horizontalAlignment="center",this._verticalAlignment="middle",this._textToGlyphs=new Map;const i=e.scaleFactor||1;if(this._cimTextLayer=e,a(e.color)){const t=(t,i,s)=>o(e.color(t,i,s));this._dynamicPropertyMap.set("_color",t)}else this._color=o(e.color);if(a(e.color)){const t=(t,i,s)=>o(e.outlineColor(t,i,s));this._dynamicPropertyMap.set("_haloColor",t)}else this._haloColor=o(e.outlineColor);let r;a(e.size)||(r=Math.min(Math.round(t(e.size*e.sizeRatio)),127));if(this._dynamicPropertyMap.set("_size",((i,s,o)=>a(e.size)?Math.min(Math.round(t(e.size(i,s,o)*e.sizeRatio)),127):r)),a(e.outlineSize)){const i=(i,s,o)=>Math.min(Math.floor(5*t(e.outlineSize(i,s,o)*e.sizeRatio)),127);this._dynamicPropertyMap.set("_haloSize",i)}else this._haloSize=Math.min(Math.floor(5*t(e.outlineSize*e.sizeRatio)),127);let n;a(e.offsetX)||(n=Math.round(t(e.offsetX*e.sizeRatio)));let l;this._dynamicPropertyMap.set("_xOffset",((i,s,o)=>a(e.offsetX)?Math.round(t(e.offsetX(i,s,o)*e.sizeRatio)):n)),a(e.offsetY)||(l=Math.round(t(e.offsetY*e.sizeRatio)));this._dynamicPropertyMap.set("_yOffset",((i,s,o)=>a(e.offsetY)?Math.round(t(e.offsetY(i,s,o)*e.sizeRatio)):l)),a(e.angle)?this._dynamicPropertyMap.set("_angle",e.angle):this._angle=e.angle,a(e.horizontalAlignment)?this._dynamicPropertyMap.set("_horizontalAlignment",e.horizontalAlignment):this._horizontalAlignment=e.horizontalAlignment,a(e.verticalAlignment)?this._dynamicPropertyMap.set("_verticalAlignment",e.verticalAlignment):this._verticalAlignment=e.verticalAlignment,this._scaleFactor=i,a(e.text)?this._dynamicPropertyMap.set("_text",e.text):this._text=e.text;const h=Math.min(Math.round(t(e.referenceSize*e.sizeRatio)),127);this._referenceSize=Math.round(Math.sqrt(256*h)),this._materialKey=e.materialKey;const c=s.load(this._materialKey);c.sdf=!0,this._bitset=(1===e.alignment?1:0)|(e.colorLocked?1:0)<<1,this._materialKey=c.data,this._decoration="none",this._lineHeight=1,this._lineWidth=512,this._textPlacement=e.markerPlacement,this.effects=e.effects,this._isCIM=!0}static fromCIMText(t){return new h(t)}async analyze(t,e,i,s){const o=e.readLegacyFeature(),a=function(t,e,i,s){return"string"==typeof t.text?t.text:"function"==typeof t.text?t.text(e,i,s):""}(this._cimTextLayer,o,i,s),r=await t.getMosaicItem(this._cimTextLayer.cim,l(a));return this._textToGlyphs.set(a,r.glyphMosaicItems),r}bindFeature(t,s,o){const a=t.readLegacyFeature();if(this._dynamicPropertyMap.forEach(((t,e)=>{this[e]=t(a,s,o)})),!this._text||0===this._text.length)return void(this._shapingInfo=null);this._size*=this._scaleFactor,this._scale=this._size/24,this._xOffset*=this._scaleFactor,this._yOffset*=this._scaleFactor,this._xAlignD=e(this._horizontalAlignment||"center"),this._yAlignD=i(this._verticalAlignment||"baseline");const r=this._textToGlyphs.get(this._text);this.bindTextInfo(r,!1)}}export default h;
