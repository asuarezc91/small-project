/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import o from"../../../../../../layers/graphics/OptimizedGeometry.js";import{earcut as t}from"../../../../../../core/libs/earcut/earcut.js";import{TILE_SIZE as e}from"../../definitions.js";import{TileClipper as n}from"../../TileClipper.js";import{bufcut as r}from"../bufcut.js";import s from"../Tesselator.js";const c=new s,l=new n(0,0,0,1,128);function f(o,t,e){let n=0;for(let r=1;r<e;r++){const e=o[2*(t+r-1)],s=o[2*(t+r-1)+1];n+=(o[2*(t+r)]-e)*(o[2*(t+r)+1]+s)}return n}function u(o,t,e,n,r){let s=0;for(let c=e;c<n;c+=3){const e=2*(o.getValue(c)-r),n=2*(o.getValue(c+1)-r),l=2*(o.getValue(c+2)-r);s+=Math.abs((t[e]-t[l])*(t[n+1]-t[e+1])-(t[e]-t[n])*(t[l+1]-t[e+1]))}return s}function i(o,t,e){const{coords:n,lengths:s,hasIndeterminateRingOrder:c}=t;if(c)return!1;const l=o.length;let i=0;for(let t=0;t<s.length;){let c=t,h=s[t],d=f(n,i,h);const g=[];for(;++c<s.length;){const o=s[c],t=f(n,i+h,o);if(!(t>0))break;d+=t,g.push(i+h),h+=o}const a=o.length;r(o,n,i,i+h,g,2,e);const m=u(o,n,a,o.length,e),p=Math.abs(d);if(Math.abs((m-p)/Math.max(1e-7,p))>1e-5)return o.seek(l),!1;t=c,i+=h}return!0}function h(o,e,n){const{coords:r,lengths:s,hasIndeterminateRingOrder:c}=e;if(c)return!1;let l=0;for(let c=0;c<s.length;){let u=c,i=s[c];const h=[];for(;++u<s.length;){const o=s[u];if(!(f(r,l+i,o)>0))break;h.push(l+i-l),i+=o}const d=l+i,g=e.coords.slice(2*l,2*d),a=t(g,h,2);for(const t of a)o.push(t+n+l);c=u,l+=i}return!0}function d(o,t,e,n){const r=[],{coords:s,lengths:l}=e;c.beginPolygon(o,r);let f=0;for(let o=0;o<l.length;o++){const t=e.lengths[o];c.beginContour();for(let o=0;o<t;o++){const t=[s[2*(f+o)],s[2*(f+o)+1],0];c.addVertex(t,t)}c.endContour(),f+=t}c.endPolygon();for(let o=0;o<r.length;o++)t.push(r[o]+n)}function g(o,t,e,n,r,s,c,l){const f=((o-r)*(s-l)-(t-l)*(r-c))/((o-e)*(s-l)-(t-n)*(r-c));if(f<0||f>1)return null;return{x:Math.round(o+f*(e-o)),y:Math.round(t+f*(n-t))}}function a(t){if(!function(o,t,e){let n=0;for(let r=0;r<o.lengths.length;r++){const s=o.lengths[r];for(let r=0;r<s;r++){const s=o.coords[2*(r+n)],c=o.coords[2*(r+n)+1];if(s<t||s>e||c<t||c>e)return!0}n+=s}return!1}(t,-128,e+128))return t;l.reset(3);let n=0;for(let o=0;o<t.lengths.length;o++){const e=t.lengths[o];let r=t.coords[2*(0+n)],s=t.coords[2*(0+n)+1];l.moveTo(r,s);for(let o=1;o<e;o++)r=t.coords[2*(o+n)],s=t.coords[2*(o+n)+1],l.lineTo(r,s);l.close(),n+=e}const r=l.result(!1);if(!r)return null;const s=[],c=[];for(const o of r){let t=0;for(const e of o)c.push(e.x),c.push(e.y),t++;s.push(t)}return new o(s,c)}function m(o,t,e=0){const n=-e,r=t+e;let s=0,c=0,l=0;for(let t=0;t<o.lengths.length;t++){const e=o.lengths[t],f=l+e;let u=0,i=null;for(;s!==f;){let t=o.coords[2*s],e=o.coords[2*s+++1],l=t<n||t>=r||e<n||e>=r;const h=l;for(;s!==f&&l===h;)l||(o.coords[2*c]=t,o.coords[2*c+++1]=e,u++),t=o.coords[2*s],e=o.coords[2*s+++1],l=t<n||t>=r||e<n||e>=r;if(s===f){l?i&&(o.coords[2*c]=i.x,o.coords[2*c+++1]=i.y,u++):(o.coords[2*c]=t,o.coords[2*c+++1]=e,u++);continue}const d=o.coords[2*(s-2)],a=o.coords[2*(s-2)+1],m=g(d,a,t,e,n,n,r,n)||g(d,a,t,e,r,n,r,r)||g(d,a,t,e,r,r,n,r)||g(d,a,t,e,n,n,n,r);m&&(o.coords[2*c]=m.x,o.coords[2*c+++1]=m.y,u++,i||(i=m)),l||(o.coords[2*c]=t,o.coords[2*c+++1]=e,u++)}o.lengths[t]=u,l+=e}}l.setExtent(e);export{f as area,m as clip,a as clipMarshall,u as triangleArea,i as triangulate,h as triangulateEarcut,d as triangulateLibtess};
