/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import"../../../../core/has.js";import{isSome as r}from"../../../../core/maybe.js";import"../../../../core/mathUtils.js";import"../../../../chunks/builtins.js";import"../../../webgl/FramebufferObject.js";import e from"../../../webgl/ProgramCache.js";import"../../../webgl/RenderingContext.js";import{WGLDrawPhase as t}from"./enums.js";import{createProgramTemplate as o}from"./shaders/MaterialPrograms.js";const a=r=>r===t.HITTEST||r===t.LABEL_ALPHA,s=({rendererInfo:e,drawPhase:o},s,i,n)=>`${s.getVariationHash()}-${n.join(".")}-${(r=>(a(r)?1:0)|(r===t.HIGHLIGHT?2:0))(o)}-${e.getVariationHash()}-${r(i)&&i.join(".")}`;export default class{constructor(r){this._programByKey=new Map,this._programCache=new e(r)}dispose(){this._programCache&&this._programCache.dispose()}getProgram(r,e,t=[],a=[]){const s=e.vsPath+"."+e.fsPath+JSON.stringify(t)+a.join(".");if(this._programByKey.has(s))return this._programByKey.get(s);const i=a.reduce(((e,t)=>({...e,[t]:r.driverTestResult[t]})),{}),n={...t.map((r=>"string"==typeof r?{name:r,value:!0}:r)).reduce(((r,e)=>({...r,[e.name]:e.value})),{}),...i},{vsPath:g,fsPath:m,attributes:h}=e,p=this._programCache.getProgram(o(g,m,h),n);if(!p)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(s,p),p}getMaterialProgram(e,i,n,g,m,h=["ignoresSamplerPrecision"]){const p=s(e,i,m,h);if(this._programByKey.has(p))return this._programByKey.get(p);const c=((e,o,s,i)=>{const n=i.reduce(((r,t)=>({...r,[t]:e.driverTestResult[t]})),{}),g={...o.getVariation(),...e.rendererInfo.getVariation(),highlight:e.drawPhase===t.HIGHLIGHT,id:a(e.drawPhase),...n};if(r(s))for(const r of s)g[r]=!0;return g})(e,i,m,h),f=this._programCache.getProgram(o(n,n,g),c);if(!f)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(p,f),f}}
