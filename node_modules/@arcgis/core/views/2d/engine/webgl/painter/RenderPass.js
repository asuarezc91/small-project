/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import r from"../../../../../core/has.js";import{isNone as e}from"../../../../../core/maybe.js";import{isArrayLike as s}from"../../../../../core/arrayUtils.js";import{WGLDrawPhase as t}from"../enums.js";export default class{constructor(r,e){var s;this.brushes=r,this.name=e.name,this.drawPhase=e.drawPhase||t.MAP,this._targetFn=e.target,this.effects=e.effects||[],this.enableDefaultDraw=null!=(s=e.enableDefaultDraw)?s:()=>!0,this.has=e.has}render(e){const{context:s,profiler:t}=e,a=this._targetFn(),o=this.drawPhase&e.drawPhase;if(t.recordPassStart(this.name),o&&(!this.has||r(this.has))){this.enableDefaultDraw()&&this._doRender(e,a),t.recordPassEnd();for(const r of this.effects){if(!r.enable())continue;const o=r.apply;t.recordPassStart(this.name+"."+o.name),t.recordBrushStart(o.name);const i=r.args&&r.args(),{x:n,y:h,width:f,height:d}=s.getViewport(),c=s.getBoundFramebufferObject();o.bind(e,i),this._doRender(e,a,o.defines),o.draw(e,i),o.unbind(e,i),s.bindFramebuffer(c),s.setViewport(n,h,f,d),t.recordBrushEnd(),t.recordPassEnd()}}}_doRender(r,t,a){if(!e(t))if(s(t)){for(const e of t)if(e.visible)for(const s of this.brushes)r.profiler.recordBrushStart(s.name),s.prepareState(r,e,a),s.draw(r,e,a),r.profiler.recordBrushEnd()}else for(const e of this.brushes)r.profiler.recordBrushStart(e.name),e.prepareState(r,t,a),e.draw(r,t,a),r.profiler.recordBrushEnd()}}
