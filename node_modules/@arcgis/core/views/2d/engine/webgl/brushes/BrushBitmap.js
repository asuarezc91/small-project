/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{TEXTURE_BINDING_BITMAP as e}from"../definitions.js";import t from"../VertexStream.js";import i from"./WGLBrush.js";const s={nearest:{defines:[],samplingMode:9728,mips:!1},bilinear:{defines:[],samplingMode:9729,mips:!1},bicubic:{defines:["bicubic"],samplingMode:9729,mips:!1},trilinear:{defines:[],samplingMode:9987,mips:!0}};export default class extends i{constructor(){super(...arguments),this._desc={vsPath:"raster/bitmap",fsPath:"raster/bitmap",attributes:{a_position:0,a_texcoord:1}}}dispose(){this._quad&&this._quad.dispose()}prepareState({context:e},t){e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(1,771,1,771),e.setColorMask(!0,!0,!0,!0),e.setStencilWriteMask(0),e.setStencilTestEnabled(!0),e.setStencilFunction(514,t.stencilRef,255)}draw(i,n){const{context:r,renderingOptions:a,painter:o}=i;if(!n.source)return;i.timeline.begin(this.name),this._quad||(this._quad=new t(r,[0,0,1,0,0,1,1,1]));const d=((e,t,i)=>{if("dynamic"===i.samplingMode){const{state:i}=e,n=t.resolution/t.pixelRatio/i.resolution,r=Math.round(e.pixelRatio)!==e.pixelRatio,a=n>1.05||n<.95;return i.rotation||a||r||t.isSourceScaled||t.rotation?s.bilinear:s.nearest}return s[i.samplingMode]})(i,n,a),m=o.materialManager.getProgram(i,this._desc,d.defines),{coordScale:c,computedOpacity:l,transforms:p}=n;n.setSamplingProfile(d),n.bind(i,e),r.bindProgram(m),m.setUniformMatrix3fv("u_dvsMat3",p.dvs),m.setUniform1i("u_texture",e),m.setUniform2fv("u_coordScale",c),m.setUniform1f("u_opacity",l),this._quad.draw(),i.timeline.end(this.name)}}
