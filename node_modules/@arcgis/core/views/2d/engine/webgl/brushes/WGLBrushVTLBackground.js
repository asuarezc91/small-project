/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import"../../../../../core/has.js";import"../../../../../core/mathUtils.js";import{VTL_TEXTURE_BINDING_UNIT_SPRITES as t,VTL_HIGH_RES_CUTOFF as r}from"../definitions.js";import{c as o}from"../../../../../chunks/mat3f32.js";import"../../../../../chunks/builtins.js";import e from"../../../../webgl/BufferObject.js";import s from"../../../../webgl/VertexArrayObject.js";import"../../../../webgl/FramebufferObject.js";import{createProgram as i}from"../../../../webgl/programUtils.js";import"../../../../webgl/RenderingContext.js";import{f as a}from"../../../../../chunks/vec4f32.js";import{u32to4Xu8 as n}from"../number.js";import{WGLDrawPhase as m}from"../enums.js";import c from"./WGLBrush.js";import{background as p}from"../../vectorTiles/shaders/Programs.js";class f extends c{constructor(){super(...arguments),this._color=a(1,0,0,1),this._patternMatrix=o(),this._programOptions={id:!1,pattern:!1}}dispose(){this._program&&(this._program.dispose(),this._program=null),this._vao&&(this._vao.dispose(),this._vao=null)}drawMany(o,e){const{context:s,styleLayerUID:i}=o;this._loadWGLResources(s);const a=o.displayLevel,c=o.styleLayer,p=o.painter.getVectorTileProgramCache(),f=c.getPaintValue("background-color",a),l=c.getPaintValue("background-opacity",a),_=c.getPaintValue("background-pattern",a),u=void 0!==_,h=f[3]*l,d=1|window.devicePixelRatio,g=o.spriteMosaic;let b;const v=d>r?2:1,j=o.drawPhase===m.HITTEST,x=(j?1:0)<<1|(u?1:0),y=this._programOptions;y.id=j,y.pattern=u;const w=p.getProgram(0,x,y);if(s.bindVAO(this._vao),s.bindProgram(w),u){if(b=g.getMosaicItemPosition(_,!0),!b)return;w.setUniform1f("u_opacity",l),w.setUniform2f("u_pattern_tl",b.tl[0],b.tl[1]),w.setUniform2f("u_pattern_br",b.br[0],b.br[1]),w.setUniform1i("u_texture",t),g.bind(s,9729,b.page,t)}else this._color[0]=h*f[0],this._color[1]=h*f[1],this._color[2]=h*f[2],this._color[3]=h,w.setUniform4fv("u_color",this._color);if(w.setUniform1f("u_depth",c.z||0),j){const t=n(i+1);w.setUniform4fv("u_id",t)}for(const t of e){if(w.setUniform1f("u_coord_range",t.coordRange[0]),w.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs),u){const r=Math.max(Math.pow(2,Math.round(a)-t.key.level),1),o=v*t.size[0]*r,e=o/b.size[0],s=o/b.size[1];this._patternMatrix[0]=e,this._patternMatrix[4]=s,w.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}s.setStencilFunction(514,t.stencilRef,255),s.drawArrays(5,0,4)}}_loadWGLResources(t){if(this._program&&this._vao)return;const r=i(t,p);if(!r)return;const o=new Int8Array([0,0,1,0,0,1,1,1]),a=e.createVertex(t,35044,o),n=new s(t,p.attributes,{geometry:[{name:"a_pos",count:2,type:5120,offset:0,stride:2,normalized:!1,divisor:0}]},{geometry:a});this._program=r,this._vao=n}}export{f as WGLBrushVTLBackground};
