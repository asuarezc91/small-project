/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import"../../../../../core/has.js";import"../../../../../chunks/builtins.js";import t from"../../../../webgl/BufferObject.js";import e from"../../../../webgl/Texture.js";import r from"../../../../webgl/VertexArrayObject.js";import"../../../../webgl/FramebufferObject.js";import{createProgram as i}from"../../../../webgl/programUtils.js";import"../../../../webgl/RenderingContext.js";import{f as o}from"../../../../../chunks/vec4f32.js";import s from"./WGLBrush.js";import{background as n}from"../shaders/BackgroundPrograms.js";import{tileInfo as a}from"../shaders/TileInfoPrograms.js";export default class extends s{constructor(){super(...arguments),this._color=o(1,0,0,1)}dispose(){this._outlineProgram&&(this._outlineProgram.dispose(),this._outlineProgram=null),this._tileInfoProgram&&(this._tileInfoProgram.dispose(),this._tileInfoProgram=null),this._outlineVertexArrayObject&&(this._outlineVertexArrayObject.dispose(),this._outlineVertexArrayObject=null),this._tileInfoVertexArrayObject&&(this._tileInfoVertexArrayObject.dispose(),this._tileInfoVertexArrayObject=null),this._canvas=null}prepareState({context:t}){t.setBlendingEnabled(!0),t.setBlendFunctionSeparate(1,771,1,771),t.setColorMask(!0,!0,!0,!0),t.setStencilWriteMask(0),t.setStencilTestEnabled(!1)}draw(t,e){const{context:r}=t;if(!e.isReady)return;this._loadWGLResources(r),r.bindVAO(this._outlineVertexArrayObject),r.bindProgram(this._outlineProgram),this._outlineProgram.setUniformMatrix3fv("u_dvsMat3",e.transforms.dvs),this._outlineProgram.setUniform2f("u_coord_range",e.coordRange[0],e.coordRange[1]),this._outlineProgram.setUniform1f("u_depth",0),this._outlineProgram.setUniform4fv("u_color",this._color),r.drawArrays(3,0,4),r.bindVAO();const i=this._getTexture(r,e);i&&(r.bindVAO(this._tileInfoVertexArrayObject),r.bindProgram(this._tileInfoProgram),r.bindTexture(i,0),this._tileInfoProgram.setUniformMatrix3fv("u_dvsMat3",e.transforms.dvs),this._tileInfoProgram.setUniform1f("u_depth",0),this._tileInfoProgram.setUniform2f("u_coord_ratio",e.coordRange[0]/e.size[0],e.coordRange[1]/e.size[1]),this._tileInfoProgram.setUniform2f("u_delta",8,8),this._tileInfoProgram.setUniform2f("u_dimensions",i.descriptor.width,i.descriptor.height),r.drawArrays(5,0,4),r.bindVAO())}_loadWGLResources(e){if(this._outlineProgram&&this._tileInfoProgram)return;const o=i(e,n),s=i(e,a),l={geometry:[{name:"a_pos",count:2,type:5120,offset:0,stride:2,normalized:!1,divisor:0}]},u=new Int8Array([0,0,1,0,1,1,0,1]),m=t.createVertex(e,35044,u),c=new r(e,n.attributes,l,{geometry:m}),f=new Int8Array([0,0,1,0,0,1,1,1]),d=t.createVertex(e,35044,f),g=new r(e,a.attributes,l,{geometry:d});this._outlineProgram=o,this._tileInfoProgram=s,this._outlineVertexArrayObject=c,this._tileInfoVertexArrayObject=g}_getTexture(t,r){if(r.texture&&r.triangleCountReportedInDebug===r.triangleCount)return r.texture;r.triangleCountReportedInDebug=r.triangleCount,this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.setAttribute("id","canvas2d"),this._canvas.setAttribute("width","300"),this._canvas.setAttribute("height","32"),this._canvas.setAttribute("style","display:none"));const i=r.triangleCount;let o=r.key.id;r.triangleCount>0&&(o+=`, ${i}`);const s=this._canvas,n=s.getContext("2d");return n.font="24px sans-serif",n.textAlign="left",n.textBaseline="top",n.clearRect(0,0,300,32),i>1e5?(n.fillStyle="red",n.fillRect(0,0,300,32),n.fillStyle="black"):(n.clearRect(0,0,300,32),n.fillStyle="blue"),n.fillText(o,0,0),r.texture=new e(t,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071},s),r.texture}}
