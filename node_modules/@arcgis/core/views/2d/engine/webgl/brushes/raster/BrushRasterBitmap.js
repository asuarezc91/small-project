/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{setTextures as t,getCommonUniforms as e,setUniforms as r,getColormapUniforms as s,getStretchUniforms as a,getShadedReliefUniforms as i,getUniformLocationInfos as o,getBasicGridUniforms as n}from"../../../../../webgl/rasterUtils.js";import h from"../../VertexStream.js";import c from"../WGLBrush.js";export default class extends c{constructor(){super(...arguments),this._desc={lut:{vsPath:"raster/lut",fsPath:"raster/lut",attributes:{a_position:0,a_texcoord:1}},stretch:{vsPath:"raster/stretch",fsPath:"raster/stretch",attributes:{a_position:0,a_texcoord:1}},hillshade:{vsPath:"raster/hillshade",fsPath:"raster/hillshade",attributes:{a_position:0,a_texcoord:1}}},this._rendererUniformInfos=new Map}dispose(){this._quad&&this._quad.dispose()}prepareState({context:t},e){t.setBlendingEnabled(!0),t.setBlendFunctionSeparate(1,771,1,771),t.setColorMask(!0,!0,!0,!0),t.setStencilWriteMask(0),t.setStencilTestEnabled(!0),t.setStencilFunction(514,e.stencilRef,255)}draw(t,e){var r;if(!e.source)return;if(e.suspended)return;t.timeline.begin(this.name);const s=!(null!=(r=t.context.capabilities.textureFloat)&&r.textureFloatLinear);e.updateTexture(t);const a=this.getShaderVariations(e,s),i=t.painter.materialManager.getProgram(t,this._desc[e.symbolizerParameters.type],a);this.drawWithProgram(t.context,i,e),t.timeline.end(this.name)}drawWithProgram(o,c,l,d=1,u=[0,0],p=!1){this._quad||(this._quad=new h(o,[0,0,1,0,0,1,1,1]));const{symbolizerParameters:m,transformGrid:f,width:g,height:_,opacity:b}=l,x=m.type;o.bindProgram(c);const P=this.getShaderVariations(l),S=this.getUniformInfos(x,o,c,P),{names:y,textures:w}=l.getTextures();t(o,c,y,w);const U=n(d,u),v=e(f,[g,_],[l.source.width,l.source.height],b,p);if(r(c,S,{u_coordScale:l.coordScale,u_dvsMat3:l.transforms.dvs,...U,...v}),m.colormap){const{colormap:t,colormapOffset:e}=m,a=s(t,e);r(c,S,a)}if("stretch"===m.type){const t=a(m);r(c,S,t)}else if("hillshade"===m.type){const t=i(m);r(c,S,t)}this._quad.draw()}getUniformInfos(t,e,r,s){const a=s.length>0?t+"-"+s.join("-"):t;if(this._rendererUniformInfos.has(a))return this._rendererUniformInfos.get(a);const i=o(e,r);return this._rendererUniformInfos.set(a,i),i}getShaderVariations(t,e=!1){const r=[];return"cubic"===t.interpolation?r.push("bicubic"):e&&"bilinear"===t.interpolation&&r.push("bilinear"),t.isRendereredSource?r.push("noop"):t.symbolizerParameters.colormap&&r.push("applyColormap"),t.transformGrid&&r.push("applyProjection"),r}}
