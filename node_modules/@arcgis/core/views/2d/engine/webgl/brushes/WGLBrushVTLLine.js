/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isNone as t}from"../../../../../core/maybe.js";import{VTL_TEXTURE_BINDING_UNIT_SPRITES as e}from"../definitions.js";import{c as i}from"../../../../../chunks/vec2f32.js";import{c as r}from"../../../../../chunks/vec4f32.js";import{u32to4Xu8 as a}from"../number.js";import{WGLDrawPhase as s}from"../enums.js";import n from"./WGLBrush.js";const o=Math.PI/180,l=[1,1,1,1];class f extends n{constructor(){super(...arguments),this._color=r(),this._dashArray=i(),this._programOptions={id:!1,dd:!1,pattern:!1}}dispose(){}drawMany(i,r){const{context:n,displayLevel:o,state:f,drawPhase:c,styleLayerUID:m}=i,d=i.styleLayer,u=i.painter.getVectorTileProgramCache(),h=d.getPaintValue("line-translate",o),p=d.getPaintValue("line-translate-anchor",o),_=d.getPaintValue("line-pattern",o),y=void 0!==_,g=1/i.pixelRatio,v=d.getPaintValue("line-blur",o),U=d.hasDataDrivenColor?l:d.getPaintValue("line-color",o),P=d.hasDataDrivenOpacity?1:d.getPaintValue("line-opacity",o),M=d.hasDataDrivenWidth?1:d.getPaintValue("line-width",o),V=P*U[3];this._color[0]=V*U[0],this._color[1]=V*U[1],this._color[2]=V*U[2],this._color[3]=V;const x=d.hasDataDrivenLine,b=c===s.HITTEST;let D;b&&(D=a(m+1));const j=(b?1:0)<<2|(x?1:0)<<1|(y?1:0),w=this._programOptions;w.id=b,w.dd=x,w.pattern=y;const A=u.getProgram(3,j,w);if(n.bindProgram(A),A.setUniformMatrix3fv("u_displayViewMat3",f.displayViewMat3),A.setUniformMatrix3fv("u_displayMat3",1===p?f.displayMat3:f.displayViewMat3),A.setUniform2fv("u_lineTranslation",h),A.setUniform1f("u_depth",d.z),A.setUniform1f("u_blur",v),A.setUniform1f("u_antialiasing",g),A.setUniform4fv("u_color",this._color),A.setUniform1f("u_width",M),b&&A.setUniform4fv("u_id",D),y){const t=i.spriteMosaic,r=t.getMosaicItemPosition(_,!0);r&&(t.bind(n,9729,r.page,e),A.setUniform2f("u_pattern_tl",r.tl[0],r.br[1]),A.setUniform2f("u_pattern_br",r.br[0],r.tl[1]),A.setUniform2f("u_spriteSize",8*r.size[0],r.size[1]),A.setUniform1i("u_texture",e))}else{let t=d.getPaintValue("line-dasharray",o);t.length<2&&(t=[1,-1]);const e=8;this._dashArray[0]=e*t[0],this._dashArray[1]=e*t[1],A.setUniform2fv("u_dasharray",this._dashArray)}for(const e of r){if(!e.layerData.has(m))continue;const i=e.layerData.get(m);i.prepareForRendering(n,u);const r=i.lineVertexArrayObject;t(r)||(n.bindVAO(r),A.setUniformMatrix3fv("u_dvsMat3",e.transforms.dvs),n.setStencilFunction(514,e.stencilRef,255),n.drawElements(4,i.lineIndexCount,5125,Uint32Array.BYTES_PER_ELEMENT*i.lineIndexStart),e.triangleCount+=i.lineIndexCount/3)}}}export{o as C_DEG_TO_RAD,f as WGLBrushVTLLine};
