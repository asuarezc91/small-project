/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isNone as t}from"../../../../../core/maybe.js";import{VTL_TEXTURE_BINDING_UNIT_SPRITES as e,VTL_TEXTURE_BINDING_UNIT_GLYPHS as i}from"../definitions.js";import{c as o,f as a}from"../../../../../chunks/vec2f32.js";import{c as r}from"../../../../../chunks/vec4f32.js";import{FADE_DURATION as s}from"../../vectorTiles/decluttering/config.js";import{u32to4Xu8 as n}from"../number.js";import{WGLDrawPhase as l}from"../enums.js";import f from"./WGLBrush.js";import{degToByte as c}from"../GeometryUtils.js";const u=[1,1,1,1];class m extends f{constructor(){super(...arguments),this._iconProgramOptions={id:!1,dd:!1,sdf:!1},this._sdfProgramOptions={id:!1,dd:!1},this._spritesTextureSize=o(),this._haloColor=r(),this._sdfColor=r(),this._color=r()}dispose(){}drawMany(t,e){const{drawPhase:i,styleLayerUID:o}=t,a=t.styleLayer;let r;i===l.HITTEST&&(r=n(o+1)),this._drawIcons(t,a,e,r),this._drawText(t,a,e,r)}_drawIcons(i,o,a,r){const{context:n,displayLevel:f,drawPhase:m,painter:h,state:d,styleLayerUID:p}=i;let _,g=!1;for(const t of a)if(t.layerData.has(p)&&(_=t.layerData.get(p),_.iconPerPageElementsMap.size>0)){g=!0;break}if(!g)return;const y=o.hasDataDrivenIconSize?1:o.getLayoutValue("icon-size",f),U=o.hasDataDrivenIconColor?u:o.getPaintValue("icon-color",f),x=o.hasDataDrivenIconOpacity?1:o.getPaintValue("icon-opacity",f),P=o.getPaintValue("icon-translate",f),T=o.getPaintValue("icon-translate-anchor",f),v=h.getVectorTileProgramCache(),M=U[3]*x;this._color[0]=M*U[0],this._color[1]=M*U[1],this._color[2]=M*U[2],this._color[3]=M;let V=o.getLayoutValue("icon-rotation-alignment",f);2===V&&(V=0===o.getLayoutValue("symbol-placement",f)?1:0);const D=0===V,E=o.getLayoutValue("icon-keep-upright",f)&&D,S=_.isIconSDF,w=o.hasDataDrivenIcon,z=m===l.HITTEST,C=(z?1:0)<<2|(w?1:0)<<1|(S?1:0),L=this._iconProgramOptions;L.id=z,L.dd=w,L.sdf=S;const b=v.getProgram(4,C,L);if(n.bindProgram(b),S){const t=o.getPaintValue("icon-halo-color",f),e=o.getPaintValue("icon-halo-width",f);b.setUniform4f("u_outlineColor",t[0],t[1],t[2],t[3]),b.setUniform1f("u_outlineSize",e)}b.setUniformMatrix3fv("u_displayViewMat3",0===V?d.displayViewMat3:d.displayMat3),b.setUniformMatrix3fv("u_displayMat3",1===T?d.displayMat3:d.displayViewMat3),b.setUniform2fv("u_iconTranslation",P),b.setUniform1f("u_depth",o.z),b.setUniform1f("u_mapRotation",c(d.rotation)),b.setUniform1f("u_keepUpright",E?1:0),b.setUniform1f("u_level",10*f),b.setUniform1i("u_texture",e),b.setUniform1f("u_size",y),b.setUniform4fv("u_color",this._color),b.setUniform1f("u_opacity",1),b.setUniform1f("u_fadeDuration",s/1e3),z&&b.setUniform4fv("u_id",r);for(const e of a){if(!e.layerData.has(p))continue;if(_=e.layerData.get(p),0===_.iconPerPageElementsMap.size)continue;_.prepareForRendering(n,v),_.updateOpacityInfo();const o=_.iconVertexArrayObject;if(!t(o)){n.bindVAO(o),b.setUniformMatrix3fv("u_dvsMat3",e.transforms.dvs),b.setUniform1f("u_time",(performance.now()-_.lastOpacityUpdate)/1e3);for(const[t,o]of _.iconPerPageElementsMap)this._renderIconRange(i,b,o,t,e)}}}_renderIconRange(t,i,o,a,r){const{context:s,spriteMosaic:n}=t;this._spritesTextureSize[0]=n.getWidth(a)/4,this._spritesTextureSize[1]=n.getHeight(a)/4,i.setUniform2fv("u_mosaicSize",this._spritesTextureSize),n.bind(s,9729,a,e),s.setStencilTestEnabled(!0),s.setStencilFunction(516,255,255),s.setStencilWriteMask(0),s.drawElements(4,o[1],5125,Uint32Array.BYTES_PER_ELEMENT*o[0]),r.triangleCount+=o[1]/3}_drawText(e,o,r,n){const{context:f,displayLevel:m,drawPhase:h,glyphMosaic:d,painter:p,pixelRatio:_,state:g,styleLayerUID:y}=e;let U,x=!1;for(const t of r)if(t.layerData.has(y)&&(U=t.layerData.get(y),U.glyphPerPageElementsMap.size>0)){x=!0;break}if(!x)return;let P=o.getLayoutValue("text-rotation-alignment",m);2===P&&(P=0===o.getLayoutValue("symbol-placement",m)?1:0);const T=0===P,v=o.getLayoutValue("text-keep-upright",m)&&T,M=h===l.HITTEST,V=.8*3/_,D=o.hasDataDrivenTextSize?1:o.getLayoutValue("text-size",m),E=o.hasDataDrivenTextColor?u:o.getPaintValue("text-color",m),S=o.hasDataDrivenTextOpacity?1:o.getPaintValue("text-opacity",m),w=o.getPaintValue("text-halo-color",m),z=o.getPaintValue("text-halo-width",m),C=3*o.getPaintValue("text-halo-blur",m),L=3*z,b=p.getVectorTileProgramCache(),I=E[3]*S;this._sdfColor[0]=I*E[0],this._sdfColor[1]=I*E[1],this._sdfColor[2]=I*E[2],this._sdfColor[3]=I;const O=w[3]*S;this._haloColor[0]=O*w[0],this._haloColor[1]=O*w[1],this._haloColor[2]=O*w[2],this._haloColor[3]=O,this._glyphTextureSize||(this._glyphTextureSize=a(d.width/4,d.height/4));const R=o.getPaintValue("text-translate",m),j=o.getPaintValue("text-translate-anchor",m),k=o.hasDataDrivenText,A=(M?1:0)<<1|(k?1:0),B=this._sdfProgramOptions;B.id=M,B.dd=k;const F=b.getProgram(6,A,B);f.bindProgram(F),F.setUniformMatrix3fv("u_displayViewMat3",0===P?g.displayViewMat3:g.displayMat3),F.setUniformMatrix3fv("u_displayMat3",1===j?g.displayMat3:g.displayViewMat3),F.setUniform2fv("u_textTranslation",R),F.setUniform1f("u_depth",o.z+152587890625e-16),F.setUniform2fv("u_mosaicSize",this._glyphTextureSize),F.setUniform1f("u_mapRotation",c(g.rotation)),F.setUniform1f("u_keepUpright",v?1:0),F.setUniform1f("u_level",10*m),F.setUniform1i("u_texture",i),F.setUniform1f("u_size",D),F.setUniform1f("u_antialiasingWidth",V),F.setUniform1f("u_opacity",1),F.setUniform1f("u_fadeDuration",s/1e3),M&&F.setUniform4fv("u_id",n);for(const e of r){if(!e.layerData.has(y))continue;if(U=e.layerData.get(y),0===U.glyphPerPageElementsMap.size)continue;U.prepareForRendering(f,b),U.updateOpacityInfo();const i=U.textVertexArrayObject;if(t(i))continue;f.bindVAO(i),F.setUniformMatrix3fv("u_dvsMat3",e.transforms.dvs),f.setStencilTestEnabled(!0),f.setStencilFunction(516,255,255),f.setStencilWriteMask(0);const o=(performance.now()-U.lastOpacityUpdate)/1e3;F.setUniform1f("u_time",o),U.glyphPerPageElementsMap.forEach(((t,i)=>{this._renderGlyphRange(f,t,i,d,F,w[3],z,C,L,e)}))}}_renderGlyphRange(t,e,o,a,r,s,n,l,f,c){a.bind(t,9729,o,i),s>0&&n>0&&(r.setUniform4fv("u_color",this._haloColor),r.setUniform1f("u_halo",1),r.setUniform1f("u_edgeDistance",f),r.setUniform1f("u_edgeBlur",l),t.drawElements(4,e[1],5125,Uint32Array.BYTES_PER_ELEMENT*e[0]),c.triangleCount+=e[1]/3),this._sdfColor[3]>0&&(r.setUniform4fv("u_color",this._sdfColor),r.setUniform1f("u_halo",0),r.setUniform1f("u_edgeDistance",0),r.setUniform1f("u_edgeBlur",0),t.drawElements(4,e[1],5125,Uint32Array.BYTES_PER_ELEMENT*e[0]),c.triangleCount+=e[1]/3)}}export{m as WGLBrushVTLSymbol};
