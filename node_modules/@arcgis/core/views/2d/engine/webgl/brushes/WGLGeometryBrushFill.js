/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import"../../../../../core/has.js";import e from"../../../../../core/RandomLCG.js";import{TEXTURE_BINDING_RENDERER_0 as t,TEXTURE_BINDING_RENDERER_1 as o,TILE_SIZE as i}from"../definitions.js";import"../../../../../chunks/builtins.js";import r from"../../../../webgl/Texture.js";import"../../../../webgl/FramebufferObject.js";import"../../../../webgl/RenderingContext.js";import{WGLGeometryType as s}from"../enums.js";import{FillMaterialKey as a}from"../materialKey/MaterialKey.js";import{createProgramDescriptor as n}from"../Utils.js";import l from"./WGLGeometryBrush.js";export default class extends l{constructor(){super(...arguments),this._dotTextureSize=0,this._dotTextures=null,this._dotSamplers=new Int32Array([t,o])}dispose(){this._disposeTextures()}getGeometryType(){return s.FILL}drawGeometry(e,t,o,r,s){const{context:l,painter:d,rendererInfo:u,requiredLevel:m}=e,{indexCount:c,indexFrom:_,materialKey:f}=o,p=a.load(f),{bufferLayouts:x,attributes:v}=(e=>n(e.data,{geometry:[{location:0,name:"a_pos",count:2,type:5122},{location:1,name:"a_id",count:4,type:5121},...e.dotDensity?[]:[{location:2,name:"a_color",count:4,type:5121,normalized:!0},{location:3,name:"a_tlbr",count:4,type:5123},{location:4,name:"a_aux1",count:4,type:5121},{location:5,name:"a_aux2",count:2,type:5123},{location:6,name:"a_aux3",count:4,type:5121}],...e.dotDensity?[{location:2,name:"a_inverseArea",count:1,type:5126}]:[]]}))(p),h=d.materialManager.getMaterialProgram(e,p,"materials/fill",v,s),y=this._getVAO(l,x,v,r);if(l.bindProgram(h),l.bindVAO(y),this._setSharedUniforms(h,e,t),p.textureBinding){d.textureManager.bindTextures(l,h,p);const o=1/Math.pow(2,m-t.key.level)/e.pixelRatio;h.setUniform1f("u_zoomFactor",o)}if(p.vvColor&&(h.setUniform1fv("u_vvColorValues",u.vvColorValues),h.setUniform4fv("u_vvColors",u.vvColors)),p.vvOpacity&&(h.setUniform1fv("u_vvOpacityValues",u.vvOpacityValues),h.setUniform1fv("u_vvOpacities",u.vvOpacities)),p.dotDensity){const o=i/u.ddDotSize,r=o*window.devicePixelRatio*o*window.devicePixelRatio,s=1/Math.pow(2,m-t.key.level),a=1/s*(1/s),n=u.ddDotScale?e.state.scale/u.ddDotScale:1;h.setUniform1f("u_tileZoomFactor",s),h.setUniform1f("u_tileDotsOverArea",r/(i*window.devicePixelRatio*i*window.devicePixelRatio)),h.setUniformMatrix4fv("u_dotColors",u.ddColors),h.setUniform4fv("u_isActive",u.ddActiveDots),h.setUniform4fv("u_dotBackgroundColor",u.ddBackgroundColor),h.setUniform1f("u_dotValue",Math.max(1,u.ddDotValue*n*a)),this._bindDotDensityTextures(l,h,u,o)}l.drawElements(4,c,5125,Uint32Array.BYTES_PER_ELEMENT*_),l.bindVAO(null)}_disposeTextures(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}}_bindDotDensityTextures(e,t,o,i){const r=this._createDotDensityTextures(e,i,o.ddSeed);t.setUniform1iv("u_dotTextures",this._dotSamplers);for(let t=0;t<r.length;t++)e.bindTexture(r[t],this._dotSamplers[t])}_createDotDensityTextures(t,o,i){if(this._dotTextureSize===o&&this._seed===i||(this._disposeTextures(),this._dotTextureSize=o,this._seed=i),null===this._dotTextures){const r=new e(i);this._dotTextures=[this._allocDotDensityTexture(t,o,r),this._allocDotDensityTexture(t,o,r)]}return this._dotTextures}_allocDotDensityTexture(e,t,o){const i=new Float32Array(t*t*4);for(let e=0;e<i.length;e++)i[e]=o.getFloat();return new r(e,{wrapMode:10497,pixelFormat:6408,dataType:5126,samplingMode:9728,width:t,height:t},i)}}
