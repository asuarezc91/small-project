/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isNone as e,isSome as i}from"../../../../core/maybe.js";import t from"../../../../core/LRUCache.js";import l from"../../tiling/TileKey.js";import s from"../../tiling/TileCoverage.js";const r=(e,i)=>e+1/(1<<2*i);class o{constructor(e,i){this._tiles=new Map,this._tileCache=new t(40,(e=>e.dispose())),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,this._container=i}destroy(){this._tiles.clear(),this._tiles=null,this._tileCache.clear(),this._tileCache=null}update(e){this._updateCacheSize(e);const i=this.tileInfoView,t=i.getTileCoverage(e.state,0,"smallest"),{spans:r,lodInfo:o}=t,{level:n}=o,a=new Set,h=new Set;for(const{row:e,colFrom:i,colTo:t}of r)for(let s=i;s<=t;s++){const i=l.getId(n,e,o.normalizeCol(s),o.getWorldForColumn(s)),t=this._getOrAcquireTile(i);a.add(i),t.processed()?this._addToContainer(t):h.add(new l(i))}for(const[e,i]of this._tiles)i.isCoverage=a.has(e);for(const e of h)this._findPlaceholdersForMissingTiles(e,a);let c=!1;for(const[e,l]of this._tiles)l.neededForCoverage=a.has(e),l.neededForCoverage||l.isHoldingForFade&&i.intersects(t,l.key)&&a.add(e),l.isFading&&(c=!0);for(const[e,i]of this._tiles)a.has(e)||this._releaseTile(e);return s.pool.release(t),!c}clear(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear()}clearCache(){this._tileCache.clear()}_findPlaceholdersForMissingTiles(e,i){const t=[];for(const[l,s]of this._tiles)this._addPlaceholderChild(t,s,e,i);const l=t.reduce(r,0);Math.abs(1-l)<1e-6||this._addPlaceholderParent(e.id,i)}_addPlaceholderChild(e,i,t,l){i.key.level<=t.level||!i.hasData()||function(e,i){const t=i.level-e.level;return e.row===i.row>>t&&e.col===i.col>>t&&e.world===i.world}(t,i.key)&&(this._addToContainer(i),l.add(i.id),e.push(i.key.level-t.level))}_addPlaceholderParent(e,i){let t=e;for(;;){if(t=n(t),!t||i.has(t))return;const e=this._getTile(t);if(e&&e.hasData())return this._addToContainer(e),void i.add(e.id)}}_getOrAcquireTile(e){let i=this._tiles.get(e);return i||(i=this._tileCache.pop(e),i||(i=this.acquireTile(new l(e))),this._tiles.set(e,i),i)}_getTile(e){let i=this._tiles.get(e);return i||(i=this._tileCache.pop(e),i&&this._tiles.set(e,i),i)}_releaseTile(e){const i=this._tiles.get(e);this.releaseTile(i),this._removeFromContainer(i),this._tiles.delete(e),i.hasData()?this._tileCache.put(e,i,1):i.dispose()}_addToContainer(t){let l;const s=[],r=this._container;if(r.contains(t))return;const o=this._visibleTiles;for(const[i,r]of o)this._canConnectDirectly(t,r)&&s.push(r),e(l)&&this._canConnectDirectly(r,t)&&(l=r);if(i(l)){for(const e of s)l.childrenTiles.delete(e),t.childrenTiles.add(e),e.parentTile=t;l.childrenTiles.add(t),t.parentTile=l}else for(const e of s)t.childrenTiles.add(e),e.parentTile=t;o.set(t.id,t),r.addChild(t)}_removeFromContainer(e){if(this._visibleTiles.delete(e.id),this._container.removeChild(e),i(e.parentTile)){e.parentTile.childrenTiles.delete(e);for(const t of e.childrenTiles)i(e.parentTile)&&e.parentTile.childrenTiles.add(t)}for(const i of e.childrenTiles)i.parentTile=e.parentTile;e.parentTile=null,e.childrenTiles.clear()}_canConnectDirectly(e,i){const t=e.key;let{level:l,row:s,col:r,world:o}=i.key;const n=this._visibleTiles;for(;l>0;){if(l--,s>>=1,r>>=1,t.level===l&&t.row===s&&t.col===r&&t.world===o)return!0;if(n.has(`${l}/${s}/${r}/${o}`))return!1}return!1}_updateCacheSize(e){const i=e.state.size;if(i[0]===this._viewSize[0]&&i[1]===this._viewSize[1])return;const t=Math.ceil(i[0]/512)+1,l=Math.ceil(i[1]/512)+1;this._viewSize[0]=i[0],this._viewSize[1]=i[1],this._tileCache.maxSize=5*t*l}}function n(e){const[i,t,l,s]=e.split("/"),r=parseInt(i,10);return 0===r?null:`${r-1}/${parseInt(t,10)>>1}/${parseInt(l,10)>>1}/${parseInt(s,10)}`}export{o as TileManager};
