/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{vtlBrushes as e}from"../brushes.js";import r from"./shaders/ProgramCache.js";export default class{constructor(e,r){this.spriteMosaic=e,this.glyphMosaic=r,this._brushCache=new Map}dispose(){this._brushCache&&(this._brushCache.forEach((e=>e.dispose())),this._brushCache=null),this._programCache&&(this._programCache.dispose(),this._programCache=null)}setContext(e){this._programCache||(this._programCache=new r(e))}getVectorTileProgramCache(){return this._programCache}drawTile(e,r,t){const{context:s}=e,a=t.layers;t.backgroundBucketIds.length>0&&(e.renderPass="background",t.backgroundBucketIds.forEach((s=>this._renderStyleLayer(t.getLayerById(s),e,r,!0)))),s.setBlendingEnabled(!1),s.setDepthTestEnabled(!0),s.setDepthWriteEnabled(!0),s.setDepthFunction(515),e.renderPass="opaque";for(let t=a.length-1;t>=0;t--)this._renderStyleLayer(a[t],e,r,!1);s.setDepthWriteEnabled(!1),s.setBlendingEnabled(!0),s.setBlendFunctionSeparate(1,771,1,771),e.renderPass="translucent";for(let t=0;t<a.length;t++)this._renderStyleLayer(a[t],e,r,!1);s.setDepthTestEnabled(!1),e.renderPass="symbol";for(let t=0;t<a.length;t++)this._renderStyleLayer(a[t],e,r,!1);s.bindVAO()}_renderStyleLayer(e,r,t,s=!1){if(!(s||e&&t.layerData.has(e.uid)))return;const{renderPass:a}=r;let h;switch(e.type){case 0:if("background"!==a)return;h="vtlBackground";break;case 1:if("opaque"!==a&&"translucent"!==r.renderPass)return;h="vtlFill";break;case 2:if("translucent"!==a)return;h="vtlLine";break;case 4:if("symbol"!==a)return;h="vtlCircle";break;case 3:if("symbol"!==a)return;h="vtlSymbol"}const n=r.displayLevel;void 0!==e.minzoom&&e.minzoom>n+1e-6||void 0!==e.maxzoom&&e.maxzoom<=n-1e-6||(r.styleLayerUID=e.uid,r.styleLayer=e,this.drawWithBrush(r,t,h))}drawWithBrush(r,t,s){if(!this._brushCache.has(s)){const r=e[s];this._brushCache.set(s,new r)}this._brushCache.get(s).drawMany(r,[t])}getVectorTileProgramCach(){return this._programCache}}
