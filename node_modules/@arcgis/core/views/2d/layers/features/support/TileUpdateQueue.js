/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../../chunks/tslib.es6.js";import"../../../../../core/has.js";import"../../../../../core/Logger.js";import"../../../../../core/accessorSupport/ensureType.js";import{property as t}from"../../../../../core/accessorSupport/decorators/property.js";import{subclass as i}from"../../../../../core/accessorSupport/decorators/subclass.js";import"../../../../../core/urlUtils.js";import"../../../../../core/uuid.js";import"../../../../../portal/support/resourceExtension.js";import{createAbortController as s}from"../../../../../core/promiseUtils.js";import{schedule as o}from"../../../../../core/scheduling.js";import n from"../../../../../core/Accessor.js";import{i as l}from"../../../../../chunks/vec2.js";import r from"../../../tiling/TileKey.js";import"../../../tiling/PagedTileQueue.js";import"../../../tiling/TileInfoView.js";import"../../../tiling/TileQueue.js";import"../../../tiling/TileStrategy.js";const h=[0,0];let u=class extends n{constructor(e){super(e),this._queue=new Map,this._isPaused=!1,this._scheduledNextHandle=null,this._timestamp=Date.now(),this.tileInfoView=null,this._next=this._next.bind(this),this._finalize=this._finalize.bind(this)}get length(){return this._queue.size}get updating(){return this._queue.size>0||null!=this._onGoingTile}abort(e){this._onGoingTile&&this._onGoingTile.tileId===e&&(this._onGoingTile.abortController.abort(),this._onGoingTile=null),this._queue.delete(e),this._scheduleNext(),this.notifyChange("updating")}clear(){this._queue.clear(),this._onGoingTile&&(this._onGoingTile.abortController.abort(),this._onGoingTile=null),this._cancelNext(),this.notifyChange("updating")}has(e){return this._queue.has(e)}isOngoing(e){return this._onGoingTile&&this._onGoingTile.tileId===e}pause(){this._isPaused||(this._isPaused=!0,this._cancelNext())}push(e,t){if(this._queue.has(e))return;const i=s();this._queue.set(e,{tileId:e,key:r.pool.acquire(e),timestamp:t||this._timestamp,abortController:i}),this._scheduleNext(),this.notifyChange("updating")}refresh(){this._timestamp=Date.now(),this.reset()}reset(){const e=this._onGoingTile;if(e){const{tileId:t}=e;this.push(t,this._timestamp)}this.notifyChange("updating")}resume(){this._isPaused&&(this._isPaused=!1,this._scheduleNext()),this.notifyChange("updating")}_finalize(){this._onGoingTile=null,this.notifyChange("updating"),this._scheduleNext()}_cancelNext(){this._scheduledNextHandle&&(this._scheduledNextHandle.remove(),this._scheduledNextHandle=null)}_scheduleNext(){this._isPaused||this._scheduledNextHandle||0===this._queue.size||null!=this._onGoingTile||(this._scheduledNextHandle=o(this._next))}async _next(){if(null==this._scheduledNextHandle||0===this._queue.size||this._onGoingTile)return void(this._scheduledNextHandle=null);this._scheduledNextHandle=null;const e=this._peek(),t=e.abortController.signal,{tileId:i,key:s}=e;r.pool.release(s),this._queue.delete(i),this._onGoingTile=e;const o=this.process(i,this._timestamp,{signal:t});if(this.notifyChange("updating"),function(e){return e&&"function"==typeof e.then}(o))try{await o}catch(e){}this._finalize()}_peek(){if(!this.state)throw new Error("state not set");const e=this.tileInfoView,t=this.state.center;let i=Number.NEGATIVE_INFINITY,s=Number.POSITIVE_INFINITY,o=null;return this._queue.forEach((n=>{e.getTileCoords(h,n.key);const r=this._timestamp-n.timestamp;if(isNaN(r)){const e=l(h,t);e<s&&(s=e,o=n)}else if(r===i){const e=l(h,t);e<s&&(s=e,o=n)}else r>i&&(i=r,s=Number.POSITIVE_INFINITY,o=n)})),o}};e([t({readOnly:!0})],u.prototype,"length",null),e([t({constructOnly:!0})],u.prototype,"process",void 0),e([t()],u.prototype,"state",void 0),e([t({constructOnly:!0})],u.prototype,"tileInfoView",void 0),e([t({readOnly:!0})],u.prototype,"updating",null),u=e([i("esri.views.2d.layers.features.support.TileUpdateQueue")],u);var a=u;export default a;
