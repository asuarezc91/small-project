/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import e from"../../../../../core/SetPool.js";import{isParentOf as t,isChildOf as s}from"./Tile.js";import i from"../../../../../layers/graphics/data/FeatureStore.js";const r=[],a=new Set;export default class{constructor(){this._tileById=new Map,this._tilesToFeatures=new Map,this._featureToTiles=new Map}destroy(){this.clear()}add(i){if(this.has(i.id))return;const r=i;this._tileById.set(r.id,r),this._tilesToFeatures.set(r,e.acquire()),this._tilesToFeatures.forEach(((e,i)=>{r!==i&&(t(r,i)?e.forEach((e=>{this._link(r,e)})):s(r,i)&&this.featureStore.forEachInBounds(r.bounds,(t=>{e.has(t.objectId)&&this._link(r,t.objectId)})))}))}clear(){this._tilesToFeatures.forEach((t=>e.release(t))),this._tilesToFeatures.clear(),this._featureToTiles.forEach((t=>e.release(t))),this._featureToTiles.clear(),this._tileById.clear()}delete(e){const t=this.get(e.id);r.length=0,this._tilesToFeatures.get(t).forEach((e=>{const s=this._featureToTiles.get(e);s.has(t)&&1===s.size?r.push(e):this._unlink(t,e)}));for(const e of r)this._unlink(t,e);this.featureStore.removeManyById(r),this._tilesToFeatures.delete(t),this._tileById.delete(t.id),r.length=0}forEach(e,t){return this._tileById.forEach(e,t)}get(e){return this._tileById.get(e)}has(e){return this._tileById.has(e)}setTileFeatures(t,s){const i=this.get(t.id);this._tilesToFeatures.has(i)||(this._tileById.set(i.id,i),this._tilesToFeatures.set(i,e.acquire()));for(const e of s)a.add(e.objectId);r.length=0,this._tilesToFeatures.get(i).forEach((e=>{if(!a.has(e)){const t=this._featureToTiles.get(e);t.has(i)&&1===t.size?r.push(e):this._unlink(i,e)}}));for(const e of r)this._unlink(i,e);this.featureStore.removeManyById(r),this.featureStore.addMany(s),a.forEach((e=>{this._link(i,e)})),a.clear(),r.length=0}addOrUpdateFeatures(e){const t=new Set,s=new i({geometryType:this.featureStore.geometryType,hasM:this.featureStore.hasM,hasZ:this.featureStore.hasZ});for(const s of this.deleteFeaturesById(e.map((e=>e.objectId))))t.add(s);s.addMany(e),this._tileById.forEach((e=>{s.forEachInBounds(e.bounds,(s=>{this._link(e,s.objectId),t.add(e)}))})),this.featureStore.addMany(e);const r=[];return t.forEach((e=>r.push(e))),r}deleteFeaturesById(t){const s=new Set;for(const i of t){const t=this._featureToTiles.get(i);t&&(t.forEach((e=>{s.add(e),this._tilesToFeatures.get(e).delete(i)})),e.release(t),this._featureToTiles.delete(i))}this.featureStore.removeManyById(t);const i=[];return s.forEach((e=>i.push(e))),i}_link(t,s){this._featureToTiles.get(s)||this._featureToTiles.set(s,e.acquire()),this._featureToTiles.get(s).add(t),this._tilesToFeatures.get(t).add(s)}_unlink(t,s){this._featureToTiles.get(s).delete(t),this._tilesToFeatures.get(t).delete(s),0===this._featureToTiles.get(s).size&&(e.release(this._featureToTiles.get(s)),this._featureToTiles.delete(s))}}
