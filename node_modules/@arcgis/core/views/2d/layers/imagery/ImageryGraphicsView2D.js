/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import"../../../../core/has.js";import t from"../../../../core/Logger.js";import"../../../../core/accessorSupport/ensureType.js";import{property as i}from"../../../../core/accessorSupport/decorators/property.js";import{enumeration as r}from"../../../../core/accessorSupport/decorators/enumeration.js";import{subclass as s}from"../../../../core/accessorSupport/decorators/subclass.js";import"../../../../core/urlUtils.js";import"../../../../core/uuid.js";import"../../../../portal/support/resourceExtension.js";import{debounce as a,isAbortError as o,resolve as n,after as p}from"../../../../core/promiseUtils.js";import h from"../../../../geometry/Extent.js";import{createScreenPoint as c}from"../../../../core/screenUtils.js";import l from"../../../../Graphic.js";import m from"../../../../support/GraphicsCollection.js";import d from"../../../layers/LayerView.js";import{Container as u}from"../../engine/Container.js";import x from"../graphics/GraphicsView2D.js";import{LayerView2DMixin as g}from"../LayerView2D.js";const y=t.getLogger("esri.views.2d.layers.imagery.ImageryGraphicsView2D");let w=class extends(g(d)){constructor(){super(...arguments),this.container=new u,this._graphicsView=null,this.type="Graphics",this._graphics=new m,this._updateGraphics=a((async(e,t)=>{if(!e.stationary)return;const i=e.state,r=new h({xmin:i.extent.xmin,ymin:i.extent.ymin,xmax:i.extent.xmax,ymax:i.extent.ymax,spatialReference:i.spatialReference}),s=e.state.size[0],a=e.state.size[1],o={};o.timeExtent=this.timeExtent,o.requestAsImageElement=!1,o.signal=t;const n=this._getVectorFieldExportParams({extent:r,width:s,height:a}),c=await this.layer.fetchImage(n.extent,n.width,n.height,o),l=this.layer.renderer;if("vector-field"===l.type){this._pixelData={extent:n.extent,pixelBlock:c.pixelData.pixelBlock};const t=await l.getGraphicsFromPixelData(c.pixelData,"vector-uv"===this.layer.rasterInfo.dataType);this._graphicsView.update(e),await p(0).then((()=>{this._graphics.set("items",t)}))}}))}get updating(){var e;return null==(e=this._graphicsView)?void 0:e.updating}update(e){this._updateGraphics(e).catch((e=>{o(e)||y.error(e)}))}hitTest(e,t){if(this.suspended)return n(null);const i=this.view.toMap(c(e,t));return n(new l({attributes:{},geometry:i,layer:this.layer}))}attach(){this._graphicsView=new x({view:this.view,graphics:this._graphics,requestUpdateCallback:()=>this.requestUpdate()})}detach(){this._graphics.destroy(),this._graphicsView.destroy(),this.container.removeChild(this._graphicsView.container),this._graphicsView=null}moveStart(){}viewChange(){}moveEnd(){}install(e){this.container.addChild(this._graphicsView.container),e.addChild(this.container)}uninstall(e){this.container.removeChild(this._graphicsView.container),e.removeChild(this.container)}isUpdating(){return this._graphicsView.updating||this.updateRequested}getPixelData(){return this.updating?null:this._pixelData}redraw(){}_getVectorFieldExportParams(e){var t,i;let{extent:r,width:s,height:a}=e;const o=this.layer,n=null==(t=o.fullExtent)?void 0:t.xmin,p=null==(i=o.fullExtent)?void 0:i.ymax;let h;"vector-field"===o.renderer.type&&(h=o.renderer.symbolTileSize),h=Math.max(h||0,30),s=Math.ceil(s*(1/h)),a=Math.ceil(a*(1/h));const c=(r.xmax-r.xmin)/s,l=(r.ymax-r.ymin)/a;return r.xmin=n+Math.floor((r.xmin-n)/c)*c,r.xmax=n+Math.ceil((r.xmax-n)/c)*c,r.ymin=p+Math.floor((r.ymin-p)/l)*l,r.ymax=p+Math.ceil((r.ymax-p)/l)*l,{extent:r,width:s,height:a}}};e([i()],w.prototype,"container",void 0),e([i()],w.prototype,"layer",void 0),e([i()],w.prototype,"timeExtent",void 0),e([i({dependsOn:["_graphicsView.updating"]})],w.prototype,"updating",null),e([i()],w.prototype,"_graphicsView",void 0),e([r({graphics:"Graphics"})],w.prototype,"type",void 0),w=e([s("esri.views.2d.layers.imagery.ImageryGraphicsView2D")],w);var f=w;export default f;
