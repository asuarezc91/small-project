/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{valueOf as s}from"../../core/accessorSupport/get.js";import{property as t}from"../../core/accessorSupport/decorators/property.js";import{subclass as d}from"../../core/accessorSupport/decorators/subclass.js";import{schedule as r}from"../../core/scheduling.js";import{wire as i}from"../../core/accessorSupport/wire.js";import n from"../../core/Accessor.js";import a from"../../core/Handles.js";import{init as o,on as h}from"../../core/watchUtils.js";let c=class extends n{constructor(){super(...arguments),this.updating=!1,this.handleId=0,this.handles=new a,this.scheduleHandleId=0,this.pendingPromises=new Set}destroy(){this.removeAll(),this.handles.destroy()}add(e,s,t,d=0){const r=0!=(1&d),i=++this.handleId;r||this.installSyncUpdatingWatch(e,s,i);const n=0!=(2&d)?o(e,s,t,r):e.watch(s,t,r);return this.handles.add(n,i),{remove:()=>{this.handles.remove(i)}}}addOnCollectionPropertyChange(e,s,t,d=0){const r=0!=(2&d),i=++this.handleId;return this.handles.add([h(e,s,"after-changes",this.createSyncUpdatingCallback()),h(e,s,"change",t,r?e=>{t({added:e.items,removed:[],moved:[],target:e})}:void 0)],i),{remove:()=>{this.handles.remove(i)}}}addOnCollectionChange(e,s,t=0){const d=0!=(2&t),r=++this.handleId;return this.handles.add([e.on("after-changes",this.createSyncUpdatingCallback()),e.on("change",s)],r),d&&s({added:e.items,removed:[],moved:[],target:e}),{remove:()=>{this.handles.remove(r)}}}addPromise(e){if(!e)return e;const s=++this.handleId;this.handles.add({remove:()=>{this.pendingPromises.delete(e)&&(0!==this.pendingPromises.size||this.handles.has(l)||this._set("updating",!1))}},s),this.pendingPromises.add(e),this._set("updating",!0);const t=()=>this.handles.remove(s);return e.then(t,t),e}removeAll(){this.pendingPromises.clear(),this.handles.removeAll(),this._set("updating",!1)}installSyncUpdatingWatch(e,t,d){const r=this.createSyncUpdatingCallback(),n=i((()=>s(e,t)),r);return this.handles.add(n,d),n}createSyncUpdatingCallback(){return()=>{this.handles.remove(l),++this.scheduleHandleId;const e=this.scheduleHandleId;this._get("updating")||this._set("updating",!0),this.handles.add(r((()=>{e===this.scheduleHandleId&&(this._set("updating",this.pendingPromises.size>0),this.handles.remove(l))})),l)}}};e([t({readOnly:!0})],c.prototype,"updating",void 0),c=e([d("esri.views.support.WatchUpdatingTracking")],c);const l=-42;export{c as WatchUpdatingTracking};
