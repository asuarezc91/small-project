/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as e,isNone as t}from"../../../core/maybe.js";import{all as o}from"../../../core/promiseUtils.js";import{b as r}from"../../../chunks/mat4f64.js";import{DefaultErrorContext as s}from"./DefaultErrorContext.js";import{makeMaterialParameters as a,makeTextureSource as i}from"./LoaderResult.js";import{Resource as n}from"./internal/Resource.js";let l=0;async function u(s,a,i={}){const u=await n.load(s,x,a,i),p="gltf_"+l++,f={lods:[],materials:new Map,textures:new Map,meta:c(u)},T=!(!u.json.asset.extras||"symbolResource"!==u.json.asset.extras.ESRI_type);return await async function(e,t){const r=e.json,s=r.scenes[r.scene||0].nodes,a=s.length>1;for(const e of s){const t=r.nodes[e],s=[i(e,0)];if(m(t)&&!a){const e=t.extensions.MSFT_lod.ids;s.push(...e.map(((e,t)=>i(e,t+1))))}await o(s)}async function i(o,s){const a=r.nodes[o],n=e.getNodeTransform(o);if(x.warnUnsupportedIf(null!=a.weights,"Morph targets are not supported."),null!=a.mesh){const e=r.meshes[a.mesh];for(const o of e.primitives)await t(o,n,s,e.name)}for(const e of a.children||[])await i(e,s)}}(u,(async(o,s,a,n)=>{const l=void 0!==o.mode?o.mode:4,c=function(e){switch(e){case 4:case 5:case 6:return e;default:return null}}(l);if(t(c))return void x.warnUnsupported("Unsupported primitive mode ("+h[l]+"). Skipping primitive.");if(!u.hasPositions(o))return void x.warn("Skipping primitive without POSITION vertex attribute.");const m=await u.getMaterial(o,i),T={transform:r(s),attributes:{position:await u.getPositionData(o,i),normal:null,texCoord0:null,color:null,tangent:null},indices:await u.getIndexData(o,i),primitiveType:c,material:d(f,m,p)};u.hasNormals(o)&&(T.attributes.normal=await u.getNormalData(o,i)),u.hasTangents(o)&&(T.attributes.tangent=await u.getTangentData(o,i)),u.hasTextureCoordinates(o)&&(T.attributes.texCoord0=await u.getTextureCoordinates(o,i)),u.hasVertexColors(o)&&(T.attributes.color=await u.getVertexColors(o,i));let w=null;e(f.meta)&&e(f.meta.ESRI_lod)&&"screenSpaceRadius"===f.meta.ESRI_lod.metric&&(w=f.meta.ESRI_lod.thresholds[a]),f.lods[a]=f.lods[a]||{parts:[],name:n,lodThreshold:w},f.lods[a].parts.push(T)})),{model:f,meta:{isEsriSymbolResource:T,uri:u.uri},customMeta:{}}}function c(t){const o=t.json;let r=null;return o.nodes.forEach((t=>{const o=t.extras;e(o)&&(o.ESRI_proxyEllipsoid||o.ESRI_lod)&&(r=o)})),r}function m(e){return e.extensions&&e.extensions.MSFT_lod&&Array.isArray(e.extensions.MSFT_lod.ids)}function d(e,t,o){const r=t=>{const r=`${o}_tex_${t&&t.id}${t&&t.name?"_"+t.name:""}`;if(t&&!e.textures.has(r)){const o=i(t.data,{wrap:{s:p(t.wrapS),t:p(t.wrapT)},mipmap:f.some((e=>e===t.minFilter)),noUnpackFlip:!0});e.textures.set(r,o)}return r},s=`${o}_mat_${t.id}_${t.name}`;if(!e.materials.has(s)){const o=a({color:[t.color[0],t.color[1],t.color[2]],opacity:t.color[3],alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,colorMixMode:t.ESRI_externalColorMixMode,textureColor:t.colorTexture?r(t.colorTexture):void 0,textureNormal:t.normalTexture?r(t.normalTexture):void 0,textureOcclusion:t.occlusionTexture?r(t.occlusionTexture):void 0,textureEmissive:t.emissiveTexture?r(t.emissiveTexture):void 0,textureMetallicRoughness:t.metallicRoughnessTexture?r(t.metallicRoughnessTexture):void 0,emissiveFactor:[t.emissiveFactor[0],t.emissiveFactor[1],t.emissiveFactor[2]],metallicFactor:t.metallicFactor,roughnessFactor:t.roughnessFactor});e.materials.set(s,o)}return s}function p(e){if(33071===e||33648===e||10497===e)return e;x.error(`Unexpected TextureSampler WrapMode: ${e}`)}const x=new s,f=[9987,9985],h=["POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLES","TRIANGLE_STRIP","TRIANGLE_FAN"];export{u as load};
