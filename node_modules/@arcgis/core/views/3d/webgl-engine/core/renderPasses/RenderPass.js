/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import e from"../../../../../core/PooledArray.js";class t{constructor(t,s,i=0){this._rctx=t,this._techniqueRepository=s,this._sorting=i,this._draws=new e({initialSize:32,allocator:e=>e||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._passBoundTechniques=new Set,this._previouslyBoundMaterials=new Map,this._previouslyBoundDraw=new Map}submitDraw(e,t,s,i,r){const a=this._draws.pushNew();a.geometry=t,a.geometryRanges=s,a.material=e,a.bindDrawParams=i,a.depthSquaredHint=r,a.indexType=t.indexed?t.vao.indexBuffer.indexType:0}dispatch(e){const t=this._rctx;this._passBoundTechniques.clear(),this._previouslyBoundMaterials.clear(),this._previouslyBoundDraw.clear();let i=null;const r={repository:this._techniqueRepository},a=this._draws.length;for(let n=0;n<a;n++){const a=this._draws.data[n],o=a.geometry,l=a.material.getTechnique(r,e,o.parameters);if(this._passBoundTechniques.has(l)||(l.bindPass(t,e),this._passBoundTechniques.add(l)),t.bindVAO(o.vao),l===i&&3===l.configuration.transparencyPassType||(t.bindProgram(l.program),t.setPipelineState(l.pipeline),i=l),this._previouslyBoundMaterials.get(l)!==a.material&&(l.bindMaterial(t,a.material,e),this._previouslyBoundMaterials.set(l,a.material)),this._previouslyBoundDraw.get(l)!==a.bindDrawParams&&(l.bindDraw(a.bindDrawParams,a.material,e),this._previouslyBoundMaterials.set(l,a.material)),0!==a.indexType){const e=s.get(a.indexType);for(let s=0;s<a.geometryRanges.length;s+=2){const i=a.geometryRanges[s],r=a.geometryRanges[s+1];t.drawElements(o.primitiveType,r,a.indexType,i*e)}}else for(let e=0;e<a.geometryRanges.length;e+=2){const s=a.geometryRanges[e],i=a.geometryRanges[e+1];t.drawArrays(o.primitiveType,s,i)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=0===this._sorting?1:-1;this._draws.sort(((t,s)=>{const i=e*(t.depthSquaredHint-s.depthSquaredHint);return 0!==i?i:t.geometry.vao.size-s.geometry.vao.size}))}get count(){return this._draws.length}}const s=new Map;s.set(5121,1),s.set(5123,2),s.set(5125,4);export{t as RenderPass};
