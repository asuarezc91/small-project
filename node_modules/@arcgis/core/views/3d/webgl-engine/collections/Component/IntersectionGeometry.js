/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as t}from"../../../../../core/maybe.js";import{c as s}from"../../../../../chunks/vec3f64.js";import{x as o,y as e,t as i}from"../../../../../chunks/vec3.js";import{BufferViewVec3f as n}from"../../../support/buffer/BufferView.js";import{create as r}from"../../../../../geometry/support/aaBoundingBox.js";import{generateDefaultIndexArray as p}from"../../lib/geometryDataUtils.js";import{computeInvDir as m,intersectAabbInvDir as a,intersectTriangles as c}from"../../materials/internal/MaterialUtil.js";import{getVisibility as f}from"../../lib/ComponentUtils.js";const h=s(),b=r();export default class{constructor(s,o){this._indices=t(s.indices)?s.indices:p(s.positions.length/3),this._positions=new n(s.positions),this._components=o}getComponentAabb(s,o){if(t(this._perComponentAabbs)){for(let t=0;t<6;t++)o[t]=this._perComponentAabbs[6*s+t];return o}return this._computePerComponentAabbs(),this.getComponentAabb(s,o)}getComponentPositions(t,s){s.indices=this._indices,s.data=this._positions.typedBuffer,s.stride=this._positions.typedBufferStride,s.startIndex=this._components.offsets[t],s.endIndex=this._components.offsets[t+1]}intersect(s,o,e,n,r,p){const _={data:this._positions.typedBuffer,strideIdx:this._positions.typedBufferStride,offsetIdx:0,size:3},d=this._indices,u=this._components.offsets,A=m(s,o,h);this._components.visibility.forEachComponent((m=>{if(!f(this._components.pickability,m))return!0;const h=this.getComponentAabb(m,b);if(t(r)&&r.applyToAabb(h),!a(h,s,A,e))return!0;const l=u[m]/3,C=u[m+1]/3;return c(s,o,l,C,d,_,void 0,r,((t,s,o)=>p(m,t,i(s,s,n),o))),!0}))}_computePerComponentAabbs(){const t=this._components.count;this._perComponentAabbs=new Float32Array(6*t);for(let s=0;s<t;s++)this._computeAABB(s)}_computeAABB(t){const s=this._indices,i=this._positions,n=this._components.offsets,r=n[t],p=n[t+1],m=[0,0,0],a=[1/0,1/0,1/0],c=[-1/0,-1/0,-1/0];for(let t=r;t<p;t++){const n=s[t];i.getVec(n,m),o(a,a,m),e(c,c,m)}let f=6*t;this._perComponentAabbs[f++]=a[0],this._perComponentAabbs[f++]=a[1],this._perComponentAabbs[f++]=a[2],this._perComponentAabbs[f++]=c[0],this._perComponentAabbs[f++]=c[1],this._perComponentAabbs[f]=c[2]}get positions(){return this._positions}get indices(){return this._indices}}
