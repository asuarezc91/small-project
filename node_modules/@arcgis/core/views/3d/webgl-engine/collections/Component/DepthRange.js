/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import t from"../../../../../core/PooledArray.js";import{c as n}from"../../../../../chunks/vec3f64.js";import{d as e,r as o,q as r,b as a,s,e as c,g as f,t as l}from"../../../../../chunks/vec3.js";import{a as u}from"../../../../../chunks/mat3f64.js";import{a as i}from"../../../../../chunks/quatf64.js";import{g as h,c as m}from"../../../../../chunks/mat3.js";import{c as p}from"../../../../../chunks/quat.js";import{m as d}from"../../../../../chunks/plane.js";import{projectedRadius as g,intersectPlane as j}from"../../../support/orientedBoundingBox.js";import{empty as b,within as k,union as w}from"../../lib/depthRange.js";function z(t,n){const r=b(),a=t.eye,c=t.viewForward,f=t.frustum.planes;for(let t=0;t<n.length;t++){const s=n[t].obb,l=e(o(E,s.center,a),c),u=g(s,c);if(k(r,l-u)&&k(r,l+u))continue;const i=R(s,f);if(-1===i)continue;if(0===i){q.far=l+u,q.near=l-u,w(r,q);continue}const h=S.pushNew();h.near=l-u,h.far=l+u,h.mask=i,h.object=n[t]}for(let t=0;t<S.length;t++){const n=S.data[t];if(k(r,n.near)&&k(r,n.far))continue;q.far=n.far,q.near=1/0;0===M(n.object.obb,a,x,(t=>{let r=A;for(let e=0;e<P&&t.length>0;e++){if(0==(n.mask&1<<e))continue;B(f[e],t,r);const o=t;t=r,r=o}for(let n=0;n<t.length;n+=3){s(v,t.data[n+0],t.data[n+1],t.data[n+2]);const r=e(o(v,v,a),c);q.near=Math.min(q.near,r)}}))&&(q.near=0),w(r,q)}return S.length=0,r}const S=new t({allocator:t=>t||{near:1/0,far:-1/0,mask:0,object:null},deallocator:t=>(t.object=null,t)}),q=b(),v=n(),y=n(),x=new t({deallocator:null}),A=new t({deallocator:null});function B(t,n,e){e.length=0;const o=n.length-3;F(v,n,o);const r=d(t,v);r<=0&&(e.push(v[0]),e.push(v[1]),e.push(v[2]));let a=0,s=r;for(;a<o;a+=3){F(y,n,a);const o=d(t,y);if(s*o<0){c(v,y,v,o/(o-s)),I(e,v)}o<=0&&I(e,y),s=o,f(v,y)}if(s*r<0){F(y,n,o);c(v,y,v,r/(r-s)),I(e,v)}}function F(t,n,e){return s(t,n.data[e+0],n.data[e+1],n.data[e+2])}function I(t,n){t.push(n[0]),t.push(n[1]),t.push(n[2])}function M(t,n,e,c){p(D,t.quaternion),o(E,n,t.center),r(E,E,D);const f=8*((E[0]<-t.halfSize[0]?-1:E[0]>t.halfSize[0]?1:0)+3*(E[1]<-t.halfSize[1]?-1:E[1]>t.halfSize[1]?1:0)+9*(E[2]<-t.halfSize[2]?-1:E[2]>t.halfSize[2]?1:0)+13),u=N[f];if(0===u)return u;h(C,t.quaternion),m(C,C,t.halfSize);const i=(n,e)=>{const o=N[f+e+1];return s(n,((1&o)<<1)-1,(2&o)-1,((4&o)>>1)-1),l(n,n,C),a(n,t.center,n)};return e.length=0,I(e,i(G,0)),I(e,i(H,1)),I(e,i(E,2)),I(e,i(J,3)),c(e),1===u?u:(e.length=0,I(e,G),I(e,J),I(e,i(E,4)),I(e,i(K,5)),c(e),2===u||(e.length=0,I(e,G),I(e,K),I(e,i(E,6)),I(e,H),c(e)),u)}const N=(()=>{const t=new Int8Array(216);let n=0;const e=e=>{for(let o=0;o<e.length;o++)t[n+o]=e[o];n+=8};return e([3,0,6,2,3,1,5,4]),e([2,0,2,3,1,5,4,0]),e([3,1,0,2,3,7,5,4]),e([2,0,1,3,2,6,4,0]),e([1,0,1,3,2,0,0,0]),e([2,1,5,7,3,2,0,0]),e([3,2,0,1,3,7,6,4]),e([2,2,0,1,3,7,6,0]),e([3,3,0,1,5,7,6,2]),e([2,0,1,5,4,6,2,0]),e([1,0,1,5,4,0,0,0]),e([2,1,3,7,5,4,0,0]),e([1,0,2,6,4,0,0,0]),e([0,0,0,0,0,0,0,0]),e([1,1,3,7,5,0,0,0]),e([2,2,3,7,6,4,0,0]),e([1,2,3,7,6,0,0,0]),e([2,3,1,5,7,6,2,0]),e([3,4,0,1,5,7,6,2]),e([2,5,7,6,4,0,1,0]),e([3,5,0,1,3,7,6,4]),e([2,4,5,7,6,2,0,0]),e([1,4,5,7,6,0,0,0]),e([2,5,1,3,7,6,4,0]),e([3,6,0,2,3,7,5,4]),e([2,6,2,3,7,5,4,0]),e([3,7,6,2,3,1,5,4]),t})(),P=4;function R(t,n){let e=0;for(let o=0;o<P;o++){const r=j(t,n[o]);if(r>0)return-1;0===r&&(e|=1<<o)}return e}const C=u(),D=i(),E=n(),G=n(),H=n(),J=n(),K=n();export{z as computeDepthRange};
