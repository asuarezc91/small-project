/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../chunks/tslib.es6.js";import{ReloadableShaderModule as e}from"../core/shaderTechnique/ReloadableShaderModule.js";import{ShaderTechnique as r}from"../core/shaderTechnique/ShaderTechnique.js";import{ShaderTechniqueConfiguration as i,parameter as o}from"../core/shaderTechnique/ShaderTechniqueConfiguration.js";import{Default3D as s}from"../lib/DefaultVertexAttributeLocations.js";import a from"../../../webgl/Program.js";import{makePipelineState as n,defaultDepthWriteParams as p,defaultColorWriteParams as u}from"../../../webgl/renderState.js";import{View as h}from"../core/shaderLibrary/util/View.glsl.js";import{DefaultTextureUnits as c}from"../lib/DefaultTextureUnits.js";import{Slice as d}from"../core/shaderLibrary/Slice.glsl.js";import{OutputHighlight as l}from"../core/shaderLibrary/output/OutputHighlight.glsl.js";import{blendingDefault as g,OITBlending as m,OITDepthTest as f,OITDepthWrite as b,getOITPolygonOffset as y}from"../lib/OrderIndependentTransparency.js";import{ReadShadowMap as w}from"../core/shaderLibrary/shading/ReadShadowMap.glsl.js";import{ScreenSpaceReflections as S}from"../core/shaderLibrary/shading/ScreenSpaceReflections.glsl.js";import{WaterDistortion as T}from"../core/shaderLibrary/shading/WaterDistortion.glsl.js";import{W as x}from"../../../../chunks/WaterSurface.glsl.js";class j extends r{constructor(t,e){super(t,e),this.waterTextureRepository=t.waterTextureRepository}initializeProgram(t){const e=j.shader.get(),r=this.configuration,i=e.build({OITEnabled:0===r.transparencyPassType,output:r.output,viewingMode:t.viewingMode,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:r.receiveShadows,pbrMode:3,useCustomDTRExponentForWater:!0,ssrEnabled:r.useSSR,highStepCount:!0});return new a(t.rctx,i.generateSource("vertex"),i.generateSource("fragment"),s)}ensureResource(t){return this.waterTextureRepository.ready||this.waterTextureRepository.updating||this.waterTextureRepository.loadTextures(t),this.waterTextureRepository.ready?2:1}bindPass(t,e,r){h.bindProjectionMatrix(this.program,r.camera.projectionMatrix),0===this.configuration.output&&(r.lighting.setUniforms(this.program,!1),S.bindUniforms(this.program,t,r)),0!==this.configuration.output&&2!==this.configuration.output||(T.bindUniforms(this.program,e),this.waterTextureRepository.bindRepo(t)),this.program.setUniform4fv("waterColor",e.color),4===this.configuration.output&&l.bindOutputHighlight(t,this.program,r)}bindDraw(t){h.bindView(this.program,t),0!==this.configuration.output&&7!==this.configuration.output||h.bindCamPosition(this.program,t.origin,t.camera.viewInverseTransposeMatrix),0===this.configuration.output&&w.bindUniforms(this.program,t,c.SHADOW_MAP),0!==this.configuration.output&&7!==this.configuration.output&&4!==this.configuration.output||d.bindUniformsWithOrigin(this.program,this.configuration,t)}setPipelineState(t){const e=this.configuration,r=3===t,i=2===t;return n({blending:2!==e.output&&4!==e.output&&e.transparent?r?g:m(t):null,depthTest:{func:f(t)},depthWrite:r?e.writeDepth&&p:b(t),colorWrite:u,polygonOffset:r||i?null:y(e.enableOffset)})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}j.shader=new e(x,(()=>import("../shaders/WaterSurface.glsl.js")));class v extends i{constructor(){super(...arguments),this.output=0,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.useSSR=!1,this.isDraped=!1,this.transparencyPassType=3}}t([o({count:8})],v.prototype,"output",void 0),t([o()],v.prototype,"receiveShadows",void 0),t([o()],v.prototype,"slicePlaneEnabled",void 0),t([o()],v.prototype,"transparent",void 0),t([o()],v.prototype,"enableOffset",void 0),t([o()],v.prototype,"writeDepth",void 0),t([o()],v.prototype,"useSSR",void 0),t([o()],v.prototype,"isDraped",void 0),t([o({count:4})],v.prototype,"transparencyPassType",void 0);export{j as WaterTechnique,v as WaterTechniqueConfiguration};
