/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import{isSome as t,unwrap as i}from"../../../../core/maybe.js";import{ReloadableShaderModule as r}from"../core/shaderTechnique/ReloadableShaderModule.js";import{ShaderTechnique as s}from"../core/shaderTechnique/ShaderTechnique.js";import{ShaderTechniqueConfiguration as o,parameter as l}from"../core/shaderTechnique/ShaderTechniqueConfiguration.js";import{Default3D as p}from"../lib/DefaultVertexAttributeLocations.js";import n from"../../../webgl/Program.js";import{separateBlendingParams as a,makePipelineState as h,defaultColorWriteParams as u,defaultDepthWriteParams as d}from"../../../webgl/renderState.js";import{View as c}from"../core/shaderLibrary/util/View.glsl.js";import{Slice as m}from"../core/shaderLibrary/Slice.glsl.js";import{OutputHighlight as f}from"../core/shaderLibrary/output/OutputHighlight.glsl.js";import{depthCompareLess as g,stencilWriteMaskOn as b,stencilToolMaskBaseParams as x,stencilBaseAllZerosParams as P}from"../lib/StencilUtils.js";import{N as E}from"../../../../chunks/NativeLine.glsl.js";class v extends s{constructor(e,t){super(e,t),this.stipplePattern=null,this.stippleTextureBind=null,this.stippleTextureRepository=e.stippleTextureRepository}initializeProgram(e){const t=v.shader.get(),i=this.configuration,r=t.build({output:i.output,attributeColor:i.vertexColors,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:i.sliceHighlightDisabled,sliceEnabledForVertexPrograms:!1,stippleEnabled:i.stippleEnabled,stippleOffColorEnabled:i.stippleOffColorEnabled,stippleUVMaxEnabled:!1,stippleIntegerRepeatsEnabled:i.stippleIntegerRepeatsEnabled});return new n(e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),p)}dispose(){super.dispose(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(e,r,s){if(c.bindProjectionMatrix(this.program,s.camera.projectionMatrix),this.stipplePattern!==r.stipplePattern){const e=r.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,e),this.stipplePattern=e}if(this.configuration.stippleEnabled){const i=t(this.stippleTextureBind)?this.stippleTextureBind(e,0)*s.camera.pixelRatio:1;this.program.setUniform1i("stipplePatternTexture",0),this.program.setUniform1f("stipplePatternPixelSizeInv",1/i),this.program.setUniform2f("ndcToPixel",s.camera.fullViewport[2]/2,s.camera.fullViewport[3]/2)}if(this.program.setUniform4fv("constantColor",r.color),this.program.setUniform1f("alphaCoverage",Math.min(1,r.width*s.camera.pixelRatio)),this.configuration.stippleOffColorEnabled){const e=i(r.stippleOffColor);this.program.setUniform4f("stippleOffColor",e[0],e[1],e[2],e.length>3?e[3]:1)}4===this.configuration.output&&f.bindOutputHighlight(e,this.program,s)}bindDraw(e){c.bindView(this.program,e),m.bindUniformsWithOrigin(this.program,this.configuration,e)}initializePipeline(){const e=this.configuration,t=a(770,1,771,771),i=(t,i=null,r=null)=>h({blending:i,depthTest:g,depthWrite:r,colorWrite:u,stencilWrite:e.sceneHasOcludees?b:null,stencilTest:e.sceneHasOcludees?t?x:P:null});return 0===e.output?(this._occludeePipelineState=i(!0,e.transparent||e.stippleEnabled?t:null,d),i(!1,e.transparent||e.stippleEnabled?t:null,d)):i(!1)}get primitiveType(){return 1}getPipelineState(e){return e?this._occludeePipelineState:this.pipeline}}v.shader=new r(E,(()=>import("./NativeLine.glsl.js")));class T extends o{constructor(){super(...arguments),this.output=0,this.slicePlaneEnabled=!1,this.sliceHighlightDisabled=!1,this.vertexColors=!1,this.transparent=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleIntegerRepeatsEnabled=!1,this.sceneHasOcludees=!1}}e([l({count:8})],T.prototype,"output",void 0),e([l()],T.prototype,"slicePlaneEnabled",void 0),e([l()],T.prototype,"sliceHighlightDisabled",void 0),e([l()],T.prototype,"vertexColors",void 0),e([l()],T.prototype,"transparent",void 0),e([l()],T.prototype,"stippleEnabled",void 0),e([l()],T.prototype,"stippleOffColorEnabled",void 0),e([l()],T.prototype,"stippleIntegerRepeatsEnabled",void 0),e([l()],T.prototype,"sceneHasOcludees",void 0);export{v as NativeLineTechnique,T as NativeLineTechniqueConfiguration};
