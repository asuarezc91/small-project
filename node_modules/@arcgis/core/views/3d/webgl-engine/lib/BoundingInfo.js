/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import i from"../../../../core/PooledArray.js";import{c as t,f as s,b as e}from"../../../../chunks/vec3f64.js";import{e as n,h}from"../../../../chunks/vec3.js";import{assert as r}from"./Util.js";class b{constructor(i,h,a,o){this.primitiveIndices=i,this._numIndexPerPrimitive=h,this.indices=a,this._position=o,this.center=t(),r(i.length>=1),r(a.length%this._numIndexPerPrimitive==0),r(a.length>=i.length*this._numIndexPerPrimitive),r(3===this._position.size||4===this._position.size);const{data:c,offsetIdx:d,strideIdx:m}=this._position;let M=0;const l=i.length;let u=d+m*a[this._numIndexPerPrimitive*i[M]];for(b.tmpIndices.clear(),b.tmpIndices.push(u),this.bbMin=s(c[u],c[u+1],c[u+2]),this.bbMax=e(this.bbMin);M<l;++M){const t=this._numIndexPerPrimitive*i[M];for(let i=0;i<this._numIndexPerPrimitive;++i){u=d+m*a[t+i],b.tmpIndices.push(u);let s=c[u];this.bbMin[0]=Math.min(s,this.bbMin[0]),this.bbMax[0]=Math.max(s,this.bbMax[0]),s=c[u+1],this.bbMin[1]=Math.min(s,this.bbMin[1]),this.bbMax[1]=Math.max(s,this.bbMax[1]),s=c[u+2],this.bbMin[2]=Math.min(s,this.bbMin[2]),this.bbMax[2]=Math.max(s,this.bbMax[2])}}n(this.center,this.bbMin,this.bbMax,.5),this.bsRadius=.5*Math.max(Math.max(this.bbMax[0]-this.bbMin[0],this.bbMax[1]-this.bbMin[1]),this.bbMax[2]-this.bbMin[2]);let x=this.bsRadius*this.bsRadius;for(M=0;M<b.tmpIndices.length;++M){u=b.tmpIndices.data[M];const i=c[u]-this.center[0],t=c[u+1]-this.center[1],s=c[u+2]-this.center[2],e=i*i+t*t+s*s;if(e<=x)continue;const n=Math.sqrt(e),h=.5*(n-this.bsRadius);this.bsRadius=this.bsRadius+h,x=this.bsRadius*this.bsRadius;const r=h/n;this.center[0]+=i*r,this.center[1]+=t*r,this.center[2]+=s*r}b.tmpIndices.clear()}getCenter(){return this.center}getBSRadius(){return this.bsRadius}getBBMin(){return this.bbMin}getBBMax(){return this.bbMax}getPrimitiveIndices(){return this.primitiveIndices}getIndices(){return this.indices}getPosition(){return this._position}getChildren(){if(this._children)return this._children;if(h(this.bbMin,this.bbMax)>1){const i=n(t(),this.bbMin,this.bbMax,.5),s=this.primitiveIndices.length,e=new Uint8Array(s),h=new Array(8);for(let i=0;i<8;++i)h[i]=0;const{data:r,offsetIdx:a,strideIdx:o}=this._position;for(let t=0;t<s;++t){let s=0;const n=this._numIndexPerPrimitive*this.primitiveIndices[t];let b=a+o*this.indices[n],c=r[b],d=r[b+1],m=r[b+2];for(let i=1;i<this._numIndexPerPrimitive;++i){b=a+o*this.indices[n+i];const t=r[b],s=r[b+1],e=r[b+2];t<c&&(c=t),s<d&&(d=s),e<m&&(m=e)}c<i[0]&&(s|=1),d<i[1]&&(s|=2),m<i[2]&&(s|=4),e[t]=s,++h[s]}let c=0;for(let i=0;i<8;++i)h[i]>0&&++c;if(c<2)return;const d=new Array(8);for(let i=0;i<8;++i)d[i]=h[i]>0?new Uint32Array(h[i]):void 0;for(let i=0;i<8;++i)h[i]=0;for(let i=0;i<s;++i){const t=e[i];d[t][h[t]++]=this.primitiveIndices[i]}this._children=new Array(8);for(let i=0;i<8;++i)void 0!==d[i]&&(this._children[i]=new b(d[i],this._numIndexPerPrimitive,this.indices,this._position))}return this._children}}!function(t){t.tmpIndices=new i({deallocator:null})}(b||(b={}));var a=b;export default a;
