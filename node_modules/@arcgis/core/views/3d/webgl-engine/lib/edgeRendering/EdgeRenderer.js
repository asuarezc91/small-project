/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isNone as e}from"../../../../../core/maybe.js";import t from"../../../../../core/PooledArray.js";import{log2 as s}from"../../../../../core/mathUtils.js";import{c as r}from"../../../../../chunks/vec3f64.js";import{g as i,s as n}from"../../../../../chunks/vec3.js";import{t as o,d as a,e as l}from"../../../../../chunks/mat3.js";import{c as h}from"../../../../../chunks/mat3f32.js";import{Slice as c}from"../../core/shaderLibrary/Slice.glsl.js";import{doublePrecisionRequiresObfuscation as d}from"../../core/shaderLibrary/util/DoublePrecision.glsl.js";import{VertexPosition as m}from"../../core/shaderLibrary/attributes/VertexPosition.glsl.js";import{ComponentDrawParameters as u}from"../../collections/Component/Material/ComponentTechnique.js";import{TwoVectorPosition as f}from"../../core/util/TwoVectorPosition.js";import{EdgeShaderTechnique as g}from"./EdgeShaderTechnique.js";const b=8,p=128,x={type:"uber",slicePlaneEnabled:!1,sliceHighlightDisabled:!1,strokesTexture:null,legacy:!0};class y{constructor(){this._value=0}get value(){return this._value}increment(){this._value++}decrement(){this._value--}}const R={solid:0,sketch:1,uber:2};class q{constructor(e,s,r){this.rctx=e,this.shaderTechniqueRepository=s,this.config=new g.Configuration,this.technique=null,this.refCount=new y,this.renderables=new Set,this.sortedRenderables={1:{1:new t,2:new t},2:{1:new t,2:new t}},this.renderablesDirty=!1,this.settings={...x,...r},this.key=q.getKey(this.settings.type,this.settings.slicePlaneEnabled,this.settings.legacy);const i=this.settings.strokesTexture.variants;this.writerSettings={variants:i},this.config.legacy=this.settings.legacy,this.config.mode=R[this.settings.type],this.config.silhouette=!1,this.config.antialiasing=!!this.rctx.capabilities.blendMinMax,this.config.slicePlaneEnabled=this.settings.slicePlaneEnabled,this.config.doublePrecisionRequiresObfuscation=d(e)}dispose(){this.technique&&(this.shaderTechniqueRepository.release(this.technique),this.technique=null)}addRenderable(e){this.renderables.add(e),this.renderablesDirty=!0}removeRenderable(e){this.renderables.delete(e),this.renderablesDirty=!0}setRenderablesDirty(){this.renderablesDirty=!0}forEachRenderable(e,t){this.renderablesDirty&&this.sortRenderables(),this.sortedRenderables[t][1].forAll(e),this.sortedRenderables[t][2].forAll(e)}bindRegularEdges(e,t){this.config.silhouette=!1,this.technique=this.shaderTechniqueRepository.acquireAndReleaseExisting(g,this.config,this.technique),this.technique.bindPass(this.rctx,{bindParameters:e,edgeRenderParameters:t}),this.rctx.setPipelineState(this.technique.pipeline),this.rctx.bindProgram(this.technique.program)}bindSilhouetteEdges(e,t){this.config.silhouette=!0,this.technique=this.shaderTechniqueRepository.acquireAndReleaseExisting(g,this.config,this.technique),this.technique.bindPass(this.rctx,{bindParameters:e,edgeRenderParameters:t}),this.rctx.setPipelineState(this.technique.pipeline),this.rctx.bindProgram(this.technique.program)}renderRegularEdges(e,t,s){this.render(this.technique.program,e,e.regular.vao,t,s)}renderSilhouetteEdges(e,t,s){this.render(this.technique.program,e,e.silhouette.vao,t,s)}render(e,t,s,r,i){this.setUniforms(e,t,r),this.rctx.bindVAO(s),this.rctx.capabilities.instancing.drawArraysInstanced(6,0,4,i)}setUniforms(e,t,s){if(t.components.buffer.textureBuffer.bind(e,T),"origin"in t.transform)e.setUniformMatrix4fv("uView",s.localViewMatrixForEdges),e.setUniformMatrix4fv("uModel",t.transform.modelMatrix),c.bindUniforms(e,this.settings,s.slicePlane,t.transform.origin.vec3);else{const r=new f(t.transform.position),h=o(v,a(v,t.transform.rotationScale)),d=new u;i(d.worldFromModel_TL,r.low),i(d.worldFromModel_TH,r.high),l(d.worldFromModel_RS,t.transform.rotationScale),l(d.transformNormal_GlobalFromModel,h),m.bindModelTransform(e,d),e.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",d.transformNormal_GlobalFromModel);const g=s.camera.viewInverseTransposeMatrix,b=n(P,g[3],g[7],g[11]);c.bindUniforms(e,this.settings,s.slicePlane,b)}"uber"!==this.settings.type&&"sketch"!==this.settings.type||this.setSketchUniforms(e),e.setUniform1f("uWorldLineRadiusPerDistance",Math.tan(s.camera.fovY/2)/(s.camera.fullViewport[3]/2))}setSketchUniforms(t){const r=this.settings.strokesTexture,i=r.texture;e(i)||(this.rctx.bindTexture(i,0),t.setUniform1i("uStrokesTexture",0),t.setUniform2f("uStrokesTextureScale",1/i.descriptor.width,1/i.descriptor.height),t.setUniform1f("uStrokesLog2Resolution",s(r.resolution)),t.setUniform1f("uStrokesNormalizationScale",r.normalizationScale),t.setUniform1f("uStrokesAmplitude",r.amplitude),t.setUniform1f("uStrokeVariants",r.variants))}sortRenderables(){this.renderablesDirty=!1,this.sortedRenderables[1][1].clear(),this.sortedRenderables[1][2].clear(),this.sortedRenderables[2][1].clear(),this.sortedRenderables[2][2].clear(),this.renderables.forEach((e=>{0!==e.objectTransparency&&0!==e.edgeTransparency&&this.sortedRenderables[e.objectTransparency][e.edgeTransparency].push(e)}));const e=(e,t)=>"origin"in e.transform&&"origin"in t.transform?e.transform.origin.id<t.transform.origin.id?-1:e.transform.origin.id>t.transform.origin.id?1:0:0;this.sortedRenderables[1][1].sort(e),this.sortedRenderables[1][2].sort(e),this.sortedRenderables[2][1].sort(e),this.sortedRenderables[2][2].sort(e)}static getKey(e,t,s){return`edges-t:${e}:${t}:${s}`}}const T={texName:"uComponentDataTex",invDimName:"uComponentDataTexInvDim",unit:2},v=h(),P=r();export{p as EXTENSION_LENGTH_OFFSET,q as EdgeRenderer,b as LINE_WIDTH_FRACTION_FACTOR,T as componentDataBindParameters};
