/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import"../../../../core/has.js";import{destroyMaybe as e,disposeMaybe as r,isNone as t,unwrap as s,isSome as n}from"../../../../core/maybe.js";import{f as i}from"../../../../chunks/vec3f64.js";import a from"../../../../core/Handles.js";import{init as h}from"../../../../core/watchUtils.js";import{j as o,t as d,a as l,m as c}from"../../../../chunks/mat4.js";import{someMap as p}from"../../../../core/MapUtils.js";import _ from"../../../../core/TimeProfiler.js";import{a as m}from"../../../../chunks/mat4f64.js";import{a as g}from"../../../../chunks/vec2f64.js";import{createEmptyDepthTexture as f}from"./glUtil3D.js";import u from"./Camera.js";import x from"../../support/debugFlags.js";import{materialPredicate as R}from"./Material.js";import b from"./BoundingInfo.js";import T from"./RenderContext.js";import{splitRenderGeometryChangeSetByMaterial as P}from"./rendererUtils.js";import{startMeasurement as C}from"../../../webgl/Measurement.js";import{RendererPerformanceInfo as H}from"../statistics/RendererPerformanceInfo.js";import w from"../materials/renderers/MergedRenderer.js";import{SceneLighting as y}from"../lighting/SceneLighting.js";import{union as D}from"./depthRange.js";import{depthRangeFromScene as E}from"./depthRangeUtils.js";import{RenderPassManager as M}from"../core/renderPasses/RenderPassManager.js";import I from"./HighlightHelper.js";import{OffscreenRendering as v}from"./OffscreenRendering.js";import{RenderPluginManager as S}from"./RenderPluginManager.js";import O from"./ShadowMap.js";import j from"./SliceHelper.js";import F from"./SmaaRenderPass.js";import V from"./SSAOHelper.js";import{EdgeView as q}from"./edgeRendering/EdgeView.js";const G=[],U=[],L=m(),A=m(),k=m(),B=m(),N=m();export default class{constructor(e,r,t,s,n,o,d,l,c){this._materialRep=e,this._rctx=s,this._compositingHelper=n,this._magnifierHelper=o,this.requestRender=d,this._stage=c,this._materialRenderers=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._hasWater=!1,this._camera=new u(i(0,100,-100)),this._content=new Map,this._isRendering=!1,this._bindParameters={slot:null,camera:null,inverseViewport:g(),shadowMappingEnabled:!1,ssaoEnabled:!1,origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,slicePlane:null,highlightDepthTexture:null,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureID:0,lastFrameColorTexture:null,lastFrameColorTextureID:0,reprojectionMat:null,ssrEnabled:!1,lighting:new y},this._fallbackDepthStencilTexture=null,this.performanceInfo=new H,this._antialiasing=1,this._oitEnabled=!0,this._handles=new a,this.renderHiddenTransparentEdges=()=>{},this._shaderTechniqueRepository=t,this._smaaPass=new F(this._rctx),this.camera.viewport[2]=l[0],this.camera.viewport[3]=l[1],this.requestRender(),this._offscreenRendering=new v(this._rctx,this._compositingHelper),this._sliceHelper=new j,this._shadowMap=new O(this._rctx,t.viewingMode),this._ssaoHelper=new V(t,this._rctx,(()=>this.requestRender())),this._highlightHelper=new I(t,this._rctx),this._renderPlugins=new S({rctx:this._rctx,shaderTechniqueRep:t,textureRep:r,materialRep:this._materialRep,requestRender:this.requestRender}),this.renderPassManager=new M(this._rctx,this._shaderTechniqueRepository),this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager),this._renderContext=new T(this._rctx,this._offscreenRendering,this._bindParameters.lighting,this._shadowMap,this._ssaoHelper,this._sliceHelper),this._renderContext.ssrParams={camera:null,linearDepthTexture:null,linearDepthTextureID:0,lastFrameColorTexture:null,lastFrameColorTextureID:0,reprojectionMat:null,ssrEnabled:!1},this._handles.add(h(x,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",(e=>{this.renderHiddenTransparentEdges=e?()=>this.renderEdges(1):()=>{},this.requestRender()})))}dispose(){this._handles.destroy(),this._smaaPass.disable(),this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers=null,this._edgeView=e(this._edgeView),this._offscreenRendering=r(this._offscreenRendering),this._fallbackDepthStencilTexture=r(this._fallbackDepthStencilTexture),this._shadowMap&&(this._shadowMap.enabled=!1,this._shadowMap.dispose()),this._ssaoHelper&&(this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose()),this._highlightHelper&&(this._highlightHelper.enabled=!1),b.tmpIndices.prune(),this._content.clear(),this._content=null}get updating(){return 1===this._antialiasing&&this._smaaPass.isLoadingResources}ensureEdgeView(){return t(this._edgeView)&&(this._edgeView=new q(this._rctx,this._shaderTechniqueRepository,{setNeedsRender:()=>this.requestRender()},this._stage.scheduler)),this._edgeView}set camera(e){this._camera.copyFrom(e),this.requestRender()}get camera(){return this._camera}get edgeView(){return this._edgeView}get isCameraFinal(){return null===this._bindParameters.reprojectionMat||o(this._bindParameters.reprojectionMat,N)}get hasShadowsEnabled(){var e;return!(null==(e=this._shadowMap)||!e.enabled)}setLighting(e){this._bindParameters.lighting.set(e)}setRenderParameters(e){void 0!==e.screenSpaceReflectionsEnabled&&(this.renderPassManager.screenSpaceReflectionsEnabled=e.screenSpaceReflectionsEnabled),void 0!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this.renderPassManager.shadowCastingEnabled=e.shadowMap),void 0!==e.shadowMapMaxCascades&&(this._shadowMap.maxCascades=e.shadowMapMaxCascades),this._highlightHelper.enabled=!0,void 0!==e.ssao&&(this._ssaoHelper.enabled=e.ssao),void 0!==e.ssaoAttenuation&&(this._ssaoHelper.attenuation=e.ssaoAttenuation),void 0!==e.ssaoRadius&&(this._ssaoHelper.radius=e.ssaoRadius),void 0!==e.ssaoFilterRadius&&console.error("The property ssaoFilterRadius is no longer supported as a render parameter."),void 0!==e.ssaoSamples&&(this._ssaoHelper.samples=e.ssaoSamples),e.background&&(this._offscreenRendering.background=e.background),void 0!==e.antialiasingEnabled&&(this._antialiasing=e.antialiasingEnabled?1:0),void 0!==e.orderIndependentTransparencyEnabled&&(this._oitEnabled=e.orderIndependentTransparencyEnabled),void 0!==e.defaultHighlightOptions&&this._highlightHelper.setDefaultOptions(e.defaultHighlightOptions),void 0!==e.slicePlane&&(this._sliceHelper.plane=s(e.slicePlane)),void 0!==e.waterReflectionEnabled&&(this._waterReflectionEnabled=this._rctx.parameters.maxTextureImageUnits>=10&&e.waterReflectionEnabled),this.requestRender()}get hasSlicePlane(){return!!this._sliceHelper.plane}get renderPlugins(){return this._renderPlugins}get canRender(){return this._camera.fullWidth>0&&this._camera.fullHeight>0}getFramebufferTexture(e){switch(e){case"color":return this._offscreenRendering.colorTexture;case"hudVisibility":return this._offscreenRendering.hudVisibilityTexture;case"shadowMap":return this._shadowMap&&this._shadowMap.getDepthTexture();case"linearDepth":return this._offscreenRendering.linearDepthTexture;case"normals":return this._offscreenRendering.normalTexture;case"highlight":return this._offscreenRendering.highlightTexture;default:return null}}modify(e,r=(e?e.length:0),t,s=(t?t.length:0),n,i=(n?n.length:0)){this._isRendering&&console.warn("Renderer.modify called while rendering");for(let e=0;e<s;++e)this._content.delete(t[e].uniqueName);for(let t=0;t<r;++t)this._content.set(e[t].uniqueName,e[t]);if(r||s||i){const a=P({toAdd:e,numToAdd:r,toRemove:t,numToRemove:s,toUpdate:n,numToUpdate:i});let h=!1;a.forEach(((e,r)=>{let t=this._materialRenderers.get(r);!t&&e.toAdd.length>0&&(t=new w(this._rctx,this._materialRep,r),this._materialRenderers.set(r,t)),t&&(t.modify(e),t.isEmpty&&(h=!0))})),h&&this._materialRenderers.forEach(((e,r)=>{e.isEmpty&&(this._materialRenderers.delete(r),e.dispose())})),this._hasHighlights=p(this._materialRenderers,(e=>e.hasHighlights)),this._hasOccludees=p(this._materialRenderers,(e=>e.hasOccludees)),this._hasWater=p(this._materialRenderers,(e=>e.hasWater)),this.requestRender()}}updateLogic(e){let r=!1;return this._materialRenderers.forEach((t=>{t.updateLogic&&(r=t.updateLogic(e)||r)})),r}render(e,r,s){this.performanceInfo.prerender(this._rctx),this._isRendering=!0,this.setLighting(this._stage.lighting),this._renderContext.hasOccludees=this._hasOccludees,this._renderContext.transparencyPassType=3,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType;const n=this._offscreenRendering;n.needLastFrameColorTexture=this._waterReflectionEnabled,n.advanceCurrentRenderTarget();const i=this._sliceHelper.plane;s&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(e),r.setGLViewport(this._rctx),this._renderPlugins.prepareRender(r),this.performanceInfo.advance(0),this.renderShadowMap(e,r,this._stage.mainLightDirection),this.performanceInfo.advance(1),this.ensureBindParameters(this._renderContext,r),n.initializeFrame(r),this.renderLinearDepth(),this.performanceInfo.advance(2),this.renderNormal(),this.performanceInfo.advance(3),this.ensureBindParametersSSR(this._renderContext),this._ssaoHelper.enabled&&this._ssaoHelper.computeSSAO(r,n.linearDepthTexture,n.normalTexture),this._ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository),this.performanceInfo.stats.reset(),this.performanceInfo.advance(4),this._renderContext.pass=0,n.bindFramebuffer(),this._renderPlugins.render(0,this._renderContext),this.renderOpaqueGeometry(this._renderContext),this.performanceInfo.advance(5),this.renderEdges(2),this.performanceInfo.advance(6),this.renderHiddenTransparentEdges(),this.renderOrderIndependentTransparency((()=>this.renderTransparentGeometry(this._renderContext)),!1),this.performanceInfo.advance(7),this.renderEdges(1),this.performanceInfo.advance(8);const a={hudVisibility:!1,transparentTerrain:!1};a.hudVisibility=this.renderHUDVisibility(this._renderContext),this.renderInternalSlot(20,this._renderContext),this.performanceInfo.advance(9),a.transparentTerrain=this.renderTransparentTerrain(this._renderContext),a.transparentTerrain&&a.hudVisibility&&(n.compositeTransparentTerrainOntoHUDVisibility(),this.renderHUD(0,n.framebuffer),this.performanceInfo.advance(16)),this.performanceInfo.advance(10),a.transparentTerrain&&n.compositeTransparentTerrainOntoMain(),n.renderToTargets((()=>{this.renderInternalSlot(8,this._renderContext),this._renderPlugins.render(15,this._renderContext),this._renderPlugins.render(16,this._renderContext)}),n.currentColorTarget,n.mainDepth),this.performanceInfo.advance(11),this._renderPlugins.needsLaserlineWithContrastControl&&n.renderTmpAndCompositeToMain((()=>{this._renderPlugins.render(17,this._renderContext)}),2),this.performanceInfo.advance(12),this.renderOccluded(),this.performanceInfo.advance(13);const h=!s&&this._magnifierHelper.enabled,o=h&&t(e)?this._offscreenRendering.getFramebuffer(this._offscreenRendering.tmpColor,this._offscreenRendering.tmpDepth):e;this._rctx.bindFramebuffer(o),this.renderAntiAliasing(this._antialiasing,this._offscreenRendering.colorTexture)||this._compositingHelper.composite(this._offscreenRendering.colorTexture,0),this.performanceInfo.advance(14),this.renderHUD(1,o),this.performanceInfo.advance(17),this.renderHighlights(this._renderContext.camera,e),this.performanceInfo.advance(15),h&&this._magnifierHelper.render(this._rctx,this._bindParameters),o!==e&&(this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._offscreenRendering.tmpColorTexture,0)),this._renderContext.lastFrameCamera.copyFrom(this._renderContext.camera),this._sliceHelper.plane=i,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.postrender()}readDepthPixels(e,r,t,s,n){const i=this._offscreenRendering.bindTarget(this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth);if(!this.needsLinearDepth()){this._renderContext.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const e=17664;this._rctx.clearSafe(e,255),this.renderGeometryPass(2),this._rctx.gl.flush(),this._rctx.gl.finish()}i.readPixels(e,r,t,s,6408,5121,n)}renderEdges(e){const r=this._edgeView;n(r)&&r.shouldRender()&&this._offscreenRendering.renderTmpAndCompositeToMain((()=>r.render(this._bindParameters,e)),1)}renderShadowMap(e,r,t){const s=this._shadowMap;if(s.enabled){x.ENABLE_PROFILE_DEPTH_RANGE&&_.begin("depthRange");const n=this.computeDepthRange(r);x.ENABLE_PROFILE_DEPTH_RANGE&&_.end("depthRange"),s.prepare(r,t,n);const i=s.getCascades();for(let e=0;e<i.length;++e){const r=i[e];r.camera.setGLViewport(this._rctx),this.ensureCameraBindParameters(this._renderContext,r.camera),this.renderGeometryPass(4)}s.finish(e),r.setGLViewport(this._rctx)}s.bindToAllPrograms(this._shaderTechniqueRepository)}needsLinearDepth(){return this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled}renderLinearDepth(){this.needsLinearDepth()?this._offscreenRendering.renderToTargets((()=>this.renderGeometryPass(2)),this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth)}renderNormal(){this._ssaoHelper.enabled?this._offscreenRendering.renderToTargets((()=>{this.renderGeometryPass(3)}),this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)}computeDepthRange(e){const r=E(e,this._content,this._stage.getLayers());return D(r,this.renderPlugins.queryDepthRange(e)),r.near=Math.max(e.near,r.near),r.far=Math.min(e.far,r.far),r}renderGeometryPass(e){this._renderContext.pass=e,this.renderOpaqueGeometry(this._renderContext),this.renderTransparentGeometry(this._renderContext),this.renderTransparentTerrain(this._renderContext)}renderOpaqueGeometry(e){this._renderPlugins.render(1,e),this._renderPlugins.render(2,e),this.renderInternalSlot(3,e),this._renderPlugins.render(4,e),e.ssaoHelper&&e.ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository),this._renderPlugins.render(14,this._renderContext)}renderTransparentGeometry(e){this.renderInternalSlot(5,e),this._renderPlugins.render(6,e),e.ssaoHelper&&e.ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository)}renderTransparentTerrain(e){return this._renderPlugins.render(7,e)}renderHUDVisibility(e){let r=!1;return e.offscreenRenderingHelper&&e.offscreenRenderingHelper.renderHUDVisibility((()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper?this._renderContext.offscreenRenderingHelper.hudVisibilityTexture:null,r=this.renderInternalSlot(12,e)})),r}renderHUD(e,r){this._oitEnabled?(this.renderOrderIndependentTransparency((()=>this.renderHUDElements(e)),!0),this._rctx.bindFramebuffer(r),this._compositingHelper.composite(this._offscreenRendering.hudColorTexture,2)):0===e?this._offscreenRendering.renderToTargets((()=>this.renderHUDElements(0)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this.renderHUDElements(e)}renderHUDElements(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this.renderInternalSlot(21,this._renderContext),this.renderInternalSlot(18,this._renderContext),this.renderInternalSlot(19,this._renderContext)}renderHighlights(e,r){const t=this._highlightHelper;if(!(!!t&&t.enabled&&(this._hasHighlights||this._renderPlugins.needsHighlight)))return void this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight);const s=t.profilingCallback&&C(this._renderContext.rctx);this._renderContext.highlightDepthTexture=this._bindParameters.highlightDepthTexture;const i=this._offscreenRendering.renderToTargets((()=>{this.renderGeometryPass(5),this._rctx.clearSafe(256),this.renderHUDElements(2)}),this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);t.render(e,i,r),n(s)&&t.profilingCallback&&s.stop((e=>{t.profilingCallback&&t.profilingCallback(e)}))}renderOrderIndependentTransparency(e,r){if(this._oitEnabled&&this._rctx.capabilities.textureFloat&&this._rctx.capabilities.textureFloat.textureFloat&&this._rctx.capabilities.colorBufferFloat&&this._rctx.capabilities.colorBufferFloat.textureFloat){const t=t=>{this._renderContext.transparencyPassType=t,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._offscreenRendering.renderOITPass((()=>e()),t,r)},s=this._renderContext.pass;this._renderContext.pass=1,t(1),this._renderContext.pass=0,t(0),t(2),this._offscreenRendering.compositeTransparentOntoOpaque(r),this._renderContext.transparencyPassType=3,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._renderContext.pass=s}else e()}renderOccluded(){let e=0;this._materialRenderers.forEach(((r,t)=>{t&&t.isVisible()&&8===t.renderOccluded&&(e|=t.renderOccluded,U.push(t))}));const r=this._offscreenRendering,t=this._renderContext,s=(t,s,n=(()=>i(s)),a=!0,h=!0)=>{0!=(e&s)&&(r.renderToTargets(n,r.tmpColor,r.mainDepth,[0,0,0,0],a,h),r.compositeOccludedOntoMain(t))};0!==U.length&&(this.renderInternalSlot(10,t,U),s(.5,8,(()=>this.renderInternalSlot(11,t,U)),!1,!1),U.length=0),this._materialRenderers.forEach(((r,t)=>{t&&t.isVisible()&&(4===t.renderOccluded||2===t.renderOccluded||16===t.renderOccluded)&&(e|=t.renderOccluded,G.push(t))}));const n=this._renderPlugins.renderOccludedFlags;if(e|=n,!e)return;const i=e=>{t.renderOccludedMask=e,n>1&&this._renderPlugins.render(9,t),this.renderInternalSlot(3,t,G),this.renderInternalSlot(5,t,G),this.renderInternalSlot(8,t,G),t.resetRenderOccludedMask()};t.pass=0,s(.5,4,(()=>i(4)),!0,2),s(.5,2,(()=>i(2)),!0,2),s(1,16,(()=>i(16)),!0,2),G.length=0}renderAntiAliasing(e,r){if(1===e){if(this._smaaPass.loadResources((()=>this.requestRender())),this._smaaPass.enable())return this._smaaPass.render({colorTexture:r}),!0}else this._smaaPass.disable();return!1}ensureCameraBindParameters(e,r){this._renderContext.camera=r,this._bindParameters.camera=e.camera,this._bindParameters.inverseViewport[0]=1/e.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/e.camera.fullViewport[3]}ensureBindParameters(e,r){this.ensureCameraBindParameters(e,r);const t=this._renderContext.offscreenRenderingHelper;this._bindParameters.shadowMap=e.shadowMap,this._bindParameters.shadowMappingEnabled=!!e.shadowMap&&e.shadowMap.enabled,this._bindParameters.ssaoEnabled=!!e.ssaoHelper&&e.ssaoHelper.enabled,this._bindParameters.slicePlane=e.sliceHelper&&e.sliceHelper.plane,this._bindParameters.hasOccludees=e.hasOccludees,this._bindParameters.linearDepthTextureID=3,this._bindParameters.lastFrameColorTextureID=4,this._bindParameters.hudVisibilityTexture=t?t.hudVisibilityTexture:null,this._bindParameters.highlightDepthTexture=t&&t.depthTexture||this.getFallbackDepthTexture()}ensureBindParametersSSR(e){this._waterReflectionEnabled?(d(L,e.lastFrameCamera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),d(k,e.camera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),l(k,k),l(A,e.camera.projectionMatrix),c(B,k,A),c(B,L,B),c(B,e.lastFrameCamera.projectionMatrix,B),this._renderContext.ssrParams.camera=e.camera,this._renderContext.ssrParams.reprojectionMat=this._bindParameters.reprojectionMat=B,this._renderContext.ssrParams.linearDepthTexture=this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture,this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=null,this._renderContext.ssrParams.ssrEnabled=this._bindParameters.ssrEnabled=this._waterReflectionEnabled}renderInternalSlot(e,r,t){const s=0===r.pass?this.performanceInfo.stats:null;let i=!1;return this._bindParameters.slot=e,n(t)?t.forEach((t=>{if(!R(t,r))return;const s=this._materialRenderers.get(t);n(s)&&(i=s.render(e,r,this._bindParameters)||i)})):this._materialRenderers.forEach(((t,n)=>{R(n,r)&&(i=t.render(e,r,this._bindParameters,s)||i)})),i}getFallbackDepthTexture(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=f(this._rctx)),this._fallbackDepthStencilTexture}getGpuMemoryUsage(){return{offscreen:this._offscreenRendering?this._offscreenRendering.getGpuMemoryUsage():0,highlights:this._highlightHelper?this._highlightHelper.getGpuMemoryUsage():0,shadows:this._shadowMap?this._shadowMap.getGpuMemoryUsage():0,ssao:this._ssaoHelper?this._ssaoHelper.getGpuMemoryUsage():0}}get test(){return{antialiasing:this._antialiasing,offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlightHelper,materialRenderers:this._materialRenderers,oitEnabled:this._oitEnabled}}}
