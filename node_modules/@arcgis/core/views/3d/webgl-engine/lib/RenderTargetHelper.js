/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import e from"../../../webgl/Texture.js";import{getGpuMemoryUsage as t}from"../../../webgl/Util.js";import r from"../../../webgl/Renderbuffer.js";import h from"../../../webgl/FramebufferObject.js";const i={dataType:5121},s={};class d{constructor(e){this.rctx=e,this._activeTargets=new Set,this._depthTextures=new Map,this._depthBuffers=new Map,this._colorTextures=new Map,this._framebuffers=new Map,this._nextId=1,this.depthTextureSupported=e.capabilities.depthTexture}dispose(){this._depthBuffers.forEach((e=>e.dispose())),this._depthBuffers.clear(),this._depthTextures.forEach((e=>e.dispose())),this._depthTextures.clear(),this._colorTextures.forEach((e=>e.dispose())),this._colorTextures.clear(),this._framebuffers.forEach((e=>e.dispose())),this._framebuffers.clear()}disposeTargetResource(e){const t=e.id;this._activeTargets.has(t)&&(this._activeTargets.delete(t),this._depthTextures.has(t)&&(this._depthTextures.get(t).dispose(),this._depthTextures.delete(t)),this._depthBuffers.has(t)&&(this._depthBuffers.get(t).dispose(),this._depthBuffers.delete(t)),this._colorTextures.has(t)&&(this._colorTextures.get(t).dispose(),this._colorTextures.delete(t)))}getDepthTexture(t,r){if(!this.depthTextureSupported)return;let h=this._depthTextures.get(t.id);return h&&(h.descriptor.width===r.width&&h.descriptor.height===r.height||(h.dispose(),h=void 0)),h||(h=new e(this.rctx,{target:3553,pixelFormat:34041,dataType:34042,samplingMode:9728,wrapMode:33071,width:r.width,height:r.height}),this._depthTextures.set(t.id,h),this._activeTargets.add(t.id)),h}getAllocatedDepthTexture(e){return this._depthTextures.get(e.id)}getDepthBuffer(e,t){if(this.depthTextureSupported)return;let h=this._depthBuffers.get(e.id);return h?h.descriptor.width===t.width&&h.descriptor.height===t.height||h.resize(t.width,t.height):(h=new r(this.rctx,{internalFormat:34041,...t}),this._depthBuffers.set(e.id,h),this._activeTargets.add(e.id)),h}getColorTexture(t,r){let h=this._colorTextures.get(t.id);return h&&(h.descriptor.width===r.width&&h.descriptor.height===r.height||(h.dispose(),h=void 0)),h||(h=new e(this.rctx,{target:3553,pixelFormat:6408,dataType:t.dataType,samplingMode:null!=t.samplingMode?t.samplingMode:9729,wrapMode:33071,width:r.width,height:r.height}),this._colorTextures.set(t.id,h),this._activeTargets.add(t.id)),h}getAllocatedColorTexture(e){return this._colorTextures.get(e.id)}registerDepthTarget(e={}){return{id:this._nextId++,...s,...e}}registerColorTarget(e={}){return{id:this._nextId++,...i,...e}}getFramebuffer(e,t,r){const i=this.getKey(t,r);let s=this._framebuffers.get(i);const d=this.getColorTexture(t,e);if(this.depthTextureSupported){const t=r?this.getDepthTexture(r,e):void 0;if(!s)return s=r?new h(this.rctx,{colorTarget:0,depthStencilTarget:4},d,t):new h(this.rctx,{colorTarget:0,depthStencilTarget:0},d),this._framebuffers.set(i,s),s;return(s.width!==e.width||s.height!==e.height||s.colorTexture!==d||s.depthStencilTexture!==t)&&(s.detachColorTexture(),s.detachDepthStencilTexture(),s.resize(e.width,e.height),s.attachColorTexture(d),s.attachDepthStencilTexture(t)),s}{const t=r?this.getDepthBuffer(r,e):void 0;if(!s)return s=new h(this.rctx,{colorTarget:0,depthStencilTarget:r?3:0},d,t),this._framebuffers.set(i,s),s;return(s.width!==e.width||s.height!==e.height||s.colorTexture!==d)&&(s.detachColorTexture(),s.detachDepthStencilBuffer(),s.resize(e.width,e.height),s.attachColorTexture(d),s.attachDepthStencilBuffer(t)),s}}getKey(e,t){return`${e.id}_${t?t.id:"X"}_${e.name}${t?"_"+t.name:""}`}getGpuMemoryUsage(){let e=0;const r=new Set,h=h=>{r.has(h)||(r.add(h),e+=t(h))};return this._depthTextures.forEach(h),this._colorTextures.forEach(h),this._depthBuffers.forEach(h),this._framebuffers.forEach(h),e}}export{d as RenderTargetHelper};
