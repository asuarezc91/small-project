/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import e from"../../../../core/Logger.js";import{isPowerOfTwo as t}from"../../../../core/mathUtils.js";import r from"../../../webgl/Texture.js";const n=e.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil");function o(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}const a=o("DXT1"),i=o("DXT3"),s=o("DXT5");function l(e,t,n,o){const{textureData:a,internalFormat:i,width:s,height:l}=u(n,o);t.samplingMode=a.levels.length>1?9987:9729,t.hasMipmap=a.levels.length>1,t.internalFormat=i,t.width=s,t.height=l;const c=new r(e,t,a);return e.bindTexture(c,0),c}function u(e,r){const o=new Int32Array(e,0,31);if(542327876!==o[0])return n.error("Invalid magic number in DDS header"),null;if(!(4&o[20]))return n.error("Unsupported format, must contain a FourCC code"),null;const l=o[21];let u,c;switch(l){case a:u=8,c=33776;break;case i:u=16,c=33778;break;case s:u=16,c=33779;break;default:return n.error("Unsupported FourCC code:",(m=l,String.fromCharCode(255&m,m>>8&255,m>>16&255,m>>24&255))),null}var m;let h=1,d=o[4],p=o[3];0==(3&d)&&0==(3&p)||(n.warn("Rounding up compressed texture size to nearest multiple of 4."),d=d+3&-4,p=p+3&-4);const g=d,f=p;let w,x;131072&o[2]&&!1!==r&&(h=Math.max(1,o[7])),1===h||t(d)&&t(p)||(n.warn("Ignoring mipmaps of non power of two sized compressed texture."),h=1);let C=o[1]+4;const D=[];for(let t=0;t<h;++t)x=(d+3>>2)*(p+3>>2)*u,w=new Uint8Array(e,C,x),D.push(w),C+=x,d=Math.max(1,d>>1),p=Math.max(1,p>>1);return{textureData:{type:"compressed",levels:D},internalFormat:c,width:g,height:f}}export{l as createDDSTexture,u as createDDSTextureData};
