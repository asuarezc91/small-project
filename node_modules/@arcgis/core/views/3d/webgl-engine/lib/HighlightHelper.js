/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{a as e}from"../../../../chunks/vec4f64.js";import{c as i}from"../../../../chunks/vec4.js";import{Default3D as t}from"./DefaultVertexAttributeLocations.js";import{assert as r}from"./Util.js";import o from"../../../webgl/BufferObject.js";import{vertexCount as l,getGpuMemoryUsage as a}from"../../../webgl/Util.js";import s from"../../../webgl/VertexArrayObject.js";import{Pos2Tex as h}from"./DefaultVertexBufferLayouts.js";import{createQuadVAO as p}from"./glUtil3D.js";import n from"../../support/debugFlags.js";import u from"../../../webgl/FramebufferObject.js";import{f as c}from"../../../../chunks/vec4f32.js";import{HighlightCompositionTechniqueConfiguration as g,HighlightCompositionTechnique as d}from"../shaders/HighlightTechnique.js";export default class{constructor(i,t){this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0},this.quadVAO=null,this.blur0Fbo=null,this.blur1Fbo=null,this._rctx=t,this.viewportToRestore=e(),this.defaultOptions={color:c(1,0,1,1),haloColor:c(1,0,1,1),haloOpacity:1,fillOpacity:.2,haloOpacityOccluded:.25,fillOpacityOccluded:.05};const r=new g,o=(e,t)=>i.acquireAndReleaseExisting(d,e,t);r.highlightStage=0,r.gridOptimization=!1,this.blurTechnique=o(r,this.blurTechnique),r.highlightStage=0,r.gridOptimization=!0,this.blurGridTechnique=o(r,this.blurGridTechnique),r.highlightStage=1,r.gridOptimization=!1,this.applyTechnique=o(r,this.applyTechnique),r.highlightStage=1,r.gridOptimization=!0,this.applyGridTechnique=o(r,this.applyGridTechnique),r.highlightStage=2,r.gridOptimization=!1,this.downsampleTechnique=o(r,this.downsampleTechnique)}set enabled(e){e?this.enable():this.disable()}get enabled(){return null!==this.blur0Fbo}get profilingCallback(){return n.HIGHLIGHTS_PROFILE_TO_CONSOLE?e=>console.log(e):null}setDefaultOptions(e){this.defaultOptions=e}render(e,t,o){const a=e.pixelRatio,s=!n.HIGHLIGHTS_GRID_OPTIMIZATION_DISABLED,h=this._rctx;r(this.enabled),i(this.viewportToRestore,e.fullViewport);const p=e.fullWidth,u=e.fullHeight,c=Math.ceil(p/a),g=Math.ceil(u/a);this.blur0Fbo.resize(c,g),this.blur1Fbo.resize(c,g),h.bindVAO(this.quadVAO);let d=null,m=null;s&&(this._gridUpdateResources(t,32),this._gridComputeMipmap()),s?(d=this._grid.vao,m=this.blurGridTechnique,h.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,1),m.program.setUniform1i("coverageTex",1)):(d=this.quadVAO,m=this.blurTechnique),m.bindPipelineState(h),h.bindProgram(m.program),h.bindVAO(d),h.bindFramebuffer(this.blur0Fbo),h.setViewport(0,0,c,g),h.setClearColor(0,0,0,0),h.clear(16384),m.program.setUniform1i("tex",0),h.bindTexture(t.colorTexture,0),m.program.setUniform2f("blurSize",1/c,0),h.drawArrays(m.primitiveType,0,l(d,"geometry")),h.bindFramebuffer(this.blur1Fbo),h.clear(16384),h.bindTexture(this.blur0Fbo.colorTexture,0),m.program.setUniform2f("blurSize",0,1/g),h.drawArrays(m.primitiveType,0,l(d,"geometry"));const b=s?this.applyGridTechnique:this.applyTechnique;if(h.bindFramebuffer(o),b.bindPipelineState(h),h.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],this.viewportToRestore[2],this.viewportToRestore[3]),h.bindProgram(b.program),h.bindTexture(this.blur1Fbo.colorTexture,0),h.bindTexture(t.colorTexture,1),s){const e=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture;h.bindTexture(e,2)}b.bindApplyPass(this.defaultOptions),h.drawArrays(b.primitiveType,0,l(d,"geometry")),h.bindVAO(null)}enable(){if(this.enabled)return;this.quadVAO=p(this._rctx);const e={colorTarget:0,depthStencilTarget:0,width:0,height:0},i={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this.blur0Fbo=new u(this._rctx,e,i),this.blur1Fbo=new u(this._rctx,e,i)}disable(){this.enabled&&(this.quadVAO.dispose(!0),this.blur1Fbo.dispose(),this.blur0Fbo.dispose(),this.quadVAO=null,this.blur0Fbo=null,this.blur1Fbo=null)}_gridUpdateResources(e,i){const r=this._rctx,l=this._grid;let a=!1;if(null===l.coverageMipmap&&(l.coverageMipmap=[e],a=!0),l.viewportWidth===e.width&&l.viewportHeight===e.height||(a=!0,l.viewportWidth=e.width,l.viewportHeight=e.height),l.coverageMipmap[0]=e,l.cellPixelSize!==i&&(l.cellPixelSize=i,a=!0),a){for(let e=1;e<l.coverageMipmap.length;e++)l.coverageMipmap[e].dispose();l.mipmapLevels=Math.ceil(Math.log(l.cellPixelSize)*Math.LOG2E),l.coverageMipmap.length=l.mipmapLevels+1;for(let e=0;e<l.mipmapLevels;e++){const i=l.coverageMipmap[e],t={target:3553,pixelFormat:6407,dataType:33635,samplingMode:9729,wrapMode:33071,width:Math.ceil(i.width/2),height:Math.ceil(i.height/2)},o={colorTarget:0,depthStencilTarget:0,width:Math.ceil(i.width/2),height:Math.ceil(i.height/2)},a=new u(r,o,t);l.coverageMipmap[e+1]=a}}const p=Math.ceil(e.height/l.cellPixelSize),n=Math.ceil(e.width/l.cellPixelSize);if(!l.vao||l.verticalCellCount!==p||l.horizontalCellCount!==n){l.verticalCellCount=p,l.horizontalCellCount=n;const e=p+1,i=n+1,a=1/p,u=1/n,c=6,g=4,d=new Float32Array(c*g*e*i);let m=0;for(let t=0;t<e;t++)for(let e=0;e<i;e++)d[m+0]=(e-.5)*u*2-1,d[m+1]=(t-.5)*a*2-1,d[m+2]=e*u,d[m+3]=t*a,d[m+4]=(e+.5)*u*2-1,d[m+5]=(t-.5)*a*2-1,d[m+6]=e*u,d[m+7]=t*a,d[m+8]=(e-.5)*u*2-1,d[m+9]=(t+.5)*a*2-1,d[m+10]=e*u,d[m+11]=t*a,d[m+12]=(e-.5)*u*2-1,d[m+13]=(t+.5)*a*2-1,d[m+14]=e*u,d[m+15]=t*a,d[m+16]=(e+.5)*u*2-1,d[m+17]=(t-.5)*a*2-1,d[m+18]=e*u,d[m+19]=t*a,d[m+20]=(e+.5)*u*2-1,d[m+21]=(t+.5)*a*2-1,d[m+22]=e*u,d[m+23]=t*a,m+=c*g;l.vao&&l.vao.dispose(!0),l.vao=new s(r,t,{geometry:h},{geometry:o.createVertex(r,35044,d)})}}_gridComputeMipmap(){const e=this._rctx,i=this._grid,t=this.downsampleTechnique.program;this.downsampleTechnique.bindPipelineState(e),e.bindVAO(this.quadVAO);for(let r=0;r<i.mipmapLevels;r++){e.bindFramebuffer(i.coverageMipmap[r+1]),e.bindTexture(i.coverageMipmap[r].colorTexture,0);const o=i.coverageMipmap[r+1].width,a=i.coverageMipmap[r+1].height;e.bindProgram(t),t.setUniform1i("tex",0),t.setUniform2f("invFramebufferDim",1/o,1/a),e.setViewport(0,0,o,a),e.drawArrays(5,0,l(this.quadVAO,"geometry"))}}getGpuMemoryUsage(){let e=a(this.blur0Fbo)+a(this.blur1Fbo);if(this._grid&&this._grid.coverageMipmap)for(const i of this._grid.coverageMipmap)e+=a(i);return e}get test(){return{coverage:this._grid.coverageMipmap,blur:[this.blur0Fbo,this.blur1Fbo]}}}
