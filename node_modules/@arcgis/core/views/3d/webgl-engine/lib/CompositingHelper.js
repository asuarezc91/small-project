/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as t,isNone as e}from"../../../../core/maybe.js";import{vertexCount as i}from"../../../webgl/Util.js";import{createQuadVAO as r}from"./glUtil3D.js";import{CompositingTechnique as o,CompositingTechniqueConfiguration as s}from"../shaders/CompositingTechnique.js";const n=new s;export default class{constructor(t,e){this._rctx=t,this._techniqueRepository=e,this._techniques=new Set}dispose(){this._techniques.forEach((t=>this._techniqueRepository.release(t))),this._techniques.clear(),t(this._vao)&&(this._vao.dispose(),this._vao=null)}composite(t,e=0,i=1){this.compositeInternal(t,e,i,0)}compositeTransparent(t,e,r,s=1){const a=this._rctx;n.alphaMode=1,n.function=3,n.hasOpacityFactor=1!==s;const c=this._techniqueRepository.acquire(o,n);a.bindProgram(c.program),c.bindPipelineState(a),c.program.setUniform1i("colorTexture",1),a.bindTexture(t,1),c.program.setUniform1i("alphaTexture",2),a.bindTexture(e,2),c.program.setUniform1i("frontFaceTexture",3),a.bindTexture(r,3);const h=this.ensureVAO();a.bindVAO(h),a.drawArrays(5,0,i(h,"geometry")),this._techniqueRepository.release(c)}compositeSpecial(t,e){this.compositeInternal(t,0,1,e)}compositeInternal(t,e,r,s){const a=this._rctx;n.alphaMode=e,n.function=s,n.hasOpacityFactor=1!==r;const c=this._techniqueRepository.acquire(o,n);a.bindProgram(c.program),c.bindPipelineState(a),c.program.setUniform1i("tex",1),n.hasOpacityFactor&&c.program.setUniform1f("opacity",r),a.bindTexture(t,1);const h=this.ensureVAO();a.bindVAO(h),a.drawArrays(5,0,i(h,"geometry")),this._techniqueRepository.release(c)}ensureVAO(){return e(this._vao)&&(this._vao=r(this._rctx)),this._vao}}
