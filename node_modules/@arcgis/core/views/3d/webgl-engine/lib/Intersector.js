/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import"../../../../core/has.js";import{isSome as t}from"../../../../core/maybe.js";import{c as r}from"../../../../chunks/vec3f64.js";import{b as s,i as e}from"../../../../chunks/vec3.js";import{I as i}from"../../../../chunks/mat4f64.js";import{ray as a}from"../../support/geometryUtils.js";import{isInstanceHidden as o}from"../materials/renderers/utils.js";import{IntersectorOptions as n,IntersectorResults as h,IntersectorTransform as d,getVerticalOffsetObject3D as c,IntersectorResult as l}from"./intersectorUtils.js";class f{constructor(t){this.options=new n,this.results=new h,this.transform=new d,this.performanceInfo={queryDuration:0,numObjectsTested:0},this.tolerance=1e-5,this.verticalOffset=null,this._ray={origin:r(),direction:r()},this._rayEndPoint=r(),this._rayStartPointTransformed=r(),this._rayEndPointTransformed=r(),this.viewingMode=null==t?1:t}get ray(){return this._ray}get rayBeginPoint(){return this._ray.origin}get rayEndPoint(){return this._rayEndPoint}reset(t,r){this.resetWithRay(a.fromPoints(t,r,this._ray))}resetWithRay(t){t!==this._ray&&a.copy(t,this._ray),0!==this.options.verticalOffset?2===this.viewingMode?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,s(this._rayEndPoint,this._ray.origin,this._ray.direction),this._numObjectsTested=0,this.results.init(this._ray)}intersect(r,s,e,i,a,o){this.point=s,this.camera=e,this.filterPredicate=a,this.tolerance=null==i?1e-5:i;const n=c(this.verticalOffset),h=o?t=>{o(t)&&this.intersectObject(t)}:t=>{this.intersectObject(t)};if(r&&r.length>0)for(const s of r){const r=s.getSpatialQueryAccelerator&&s.getSpatialQueryAccelerator();if(r)t(n)?r.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,h,n):r.forEachAlongRay(this._ray.origin,this._ray.direction,h),this.options.selectionMode&&this.options.hud&&r.forEachDegenerateObject(h);else{const t=s.getObjects();for(const r of t)h(r)}}this.sortResults()}intersectObject(r){this._numObjectsTested++;const s=r.geometryRecords;if(!s)return;const a=r.id,n=r.objectTransformation;let h;const d=c(this.verticalOffset);for(const c of s){const{geometry:s,material:f,instanceParameters:m}=c;if(o(m))continue;h=s.id,this.transform.setAndInvalidateLazyTransforms(n,c.getShaderTransformation()),e(this._rayStartPointTransformed,this._ray.origin,this.transform.inverse),e(this._rayEndPointTransformed,this._rayEndPoint,this.transform.inverse);const u=this.transform.transform;t(d)&&(d.objectTransform=this.transform),f.intersect(s,m,this.transform.transform,this,this._rayStartPointTransformed,this._rayEndPointTransformed,((s,e,o,n,d,c)=>{if(s>=0){if(t(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEndPoint,s))return;if(d)return void((null==this.results.hud.dist||s<this.results.hud.dist)&&this.results.hud.set(r,a,s,e,i,n,c,h,o));const f=t=>t.set(r,a,s,e,u,n,null,h,o);if((null==this.results.min.drapedLayerOrder||n>=this.results.min.drapedLayerOrder)&&(null==this.results.min.dist||s<this.results.min.dist)&&f(this.results.min),0!==this.options.store&&(null==this.results.max.drapedLayerOrder||n<this.results.max.drapedLayerOrder)&&(null==this.results.max.dist||s>this.results.max.dist)&&f(this.results.max),2===this.options.store){const t=new l(this._ray);f(t),this.results.all.push(t)}}}),c.shaderTransformation)}}sortResults(){this.results.all.sort(((t,r)=>t.dist!==r.dist?t.dist-r.dist:t.drapedLayerOrder!==r.drapedLayerOrder?(void 0!==t.drapedLayerOrder?t.drapedLayerOrder:Number.MAX_VALUE)-(void 0!==r.drapedLayerOrder?r.drapedLayerOrder:Number.MAX_VALUE):(void 0!==r.drapedLayerGraphicOrder?r.drapedLayerGraphicOrder:Number.MIN_VALUE)-(void 0!==t.drapedLayerGraphicOrder?t.drapedLayerGraphicOrder:Number.MIN_VALUE)))}}f.DEFAULT_TOLERANCE=1e-5;export{f as Intersector};
