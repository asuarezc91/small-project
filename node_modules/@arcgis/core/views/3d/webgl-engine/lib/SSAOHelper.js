/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as e,disposeMaybe as t}from"../../../../core/maybe.js";import s from"../../../../core/Logger.js";import{k as i}from"../../../../chunks/vec3.js";import{a as r}from"../../../../chunks/vec2f64.js";import{a as o}from"../../../../chunks/vec4f64.js";import{c as n}from"../../../../chunks/vec4.js";import{requestImage as a}from"../../../../support/requestImageUtils.js";import{assert as h,inverseProjectionInfo as u}from"./Util.js";import l from"../../../webgl/Texture.js";import{vertexCount as _,getGpuMemoryUsage as m}from"../../../webgl/Util.js";import{createColorTexture as p,createQuadVAO as d}from"./glUtil3D.js";import{DefaultTextureUnits as f}from"./DefaultTextureUnits.js";import c from"../../../webgl/FramebufferObject.js";import{SSAOTechniqueConfiguration as b,SSAOTechnique as g}from"./SSAOTechnique.js";const T=s.getLogger("esri.views.3d.webgl-engine.lib.SSAOHelper");const x=r(),O=o();export default class{constructor(e,t,s){this._enabled=!1,this._BLUR_F=2,this._attenuation=.5,this._radius=3,this._samples=16,this._viewportToRestore=o(),this.quadVAO=null,this._rctx=t,this._techniqueRep=e,this._requestRender=s,this._ssaoTechniqueConfig=new b,this._emptyTexture=p(t,[1,1,1,1])}dispose(){this._emptyTexture.dispose(),this._emptyTexture=null,e(this.quadVAO)&&(this.quadVAO=t(this.quadVAO))}get isSupported(){const e=this._rctx,t=-1!==e.parameters.versionString.indexOf("WebGL 0.93"),s=-1!==e.parameters.versionString.indexOf("WebGL 0.94");return!(t||s)}set enabled(e){e?this.enable():this.disable()}get enabled(){return this._enabled}set attenuation(e){this._attenuation=e}get attenuation(){return this._attenuation}set radius(e){this._radius=e}get radius(){return this._radius}get filterRadius(){return 4}set samples(e){this._samples=e,this._enabled&&this.selectPrograms()}get samples(){return this._samples}computeSSAO(t,s,r){if(!this._noiseTexture)return;h(this.enabled);const o=this._rctx,a=t.fullViewport,l=a[2],m=a[3],p=l/this._BLUR_F,f=m/this._BLUR_F;this._ssaoFBO.resize(l,m),this._blur0FBO.resize(p,f),this._blur1FBO.resize(p,f);const c=1*l,b=1*m;o.bindFramebuffer(this._ssaoFBO),n(this._viewportToRestore,t.fullViewport),o.setViewport(0,0,l,m);const g=this._ssaoTechnique.program,T=this._blurTechnique.program;o.bindProgram(g),o.setPipelineState(this._ssaoTechnique.pipeline),g.setUniform2f("rnmScale",l/this._noiseTexture.descriptor.width,m/this._noiseTexture.descriptor.height),g.setUniform3fv("pSphere",this._samples<=8?this._data.random8:this._samples<=16?this._data.random16:this._samples<=32?this._data.random32:this._data.random64);const F=this._data.minDiscrepancy,U=this._samples<F.length?F[this._samples]:5779;g.setUniform1f("numSpiralTurns",U);const w=O,B=x;u(t.projectionMatrix,t.fullWidth,t.fullHeight,w,B),g.setUniform4fv("projInfo",w),g.setUniform2fv("zScale",B),g.setUniform2f("nearFar",t.near,t.far);let S=1/t.computeRenderPixelSizeAtDist(1);g.setUniform1f("projScale",1*S),g.setUniform2f("screenDimensions",c,b);let q=2*this._radius;const R=i(t.eye,t.center);q=20*t.computeRenderPixelSizeAtDist(R),q=Math.max(.1,q),g.setUniform1f("radius",q),g.setUniform1f("intensity",4*this._attenuation/Math.pow(q,6)),g.setUniform1i("rnm",0),g.setUniform1i("normalMap",1),g.setUniform1i("depthMap",2),o.bindTexture(this._noiseTexture,0),o.bindTexture(r,1),o.bindTexture(s,2),e(this.quadVAO)||(this.quadVAO=d(this._rctx));const A=this.quadVAO;o.bindVAO(A),o.drawArrays(5,0,_(A,"geometry"));o.bindTexture(this._ssaoFBO.colorTexture,0),o.setViewport(0,0,c/this._BLUR_F,b/this._BLUR_F),o.bindFramebuffer(this._blur0FBO),o.bindProgram(T),T.setUniform2f("screenDimensions",c,b),T.setUniform1i("tex",0),T.setUniform1i("normalMap",1),T.setUniform1i("depthMap",2),T.setUniform2f("blurSize",0,1*this._BLUR_F/b),T.setUniform1i("radius",4),T.setUniform1f("g_BlurFalloff",.08),T.setUniform2f("nearFar",t.near,t.far),R>5e4&&(S=Math.max(0,S-(R-5e4))),T.setUniform1f("projScale",S),T.setUniform2f("zScale",1,0),o.drawArrays(5,0,_(A,"geometry")),T.setUniform2f("blurSize",1*this._BLUR_F/c,0),o.bindFramebuffer(this._blur1FBO),o.bindTexture(this._blur0FBO.colorTexture,0),o.drawArrays(5,0,_(A,"geometry")),o.setViewport(this._viewportToRestore[0],this._viewportToRestore[1],this._viewportToRestore[2],this._viewportToRestore[3])}setUniforms(e,t){const s=this.enabled&&this._noiseTexture,i=this._rctx;i.bindTexture(s?this._blur1FBO.colorTexture:this._emptyTexture,t),i.setActiveTexture(0),e.setUniform1i("ssaoTex",t),s?e.setUniform4f("viewportPixelSz",this._viewportToRestore[0],this._viewportToRestore[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height):e.setUniform4f("viewportPixelSz",-1,-1,-1,-1)}bindToAllPrograms(e){const t=e.getProgramsUsingUniform("viewportPixelSz");for(let e=0;e<t.length;e++)this.setUniforms(t[e],f.SSAO)}selectPrograms(){const e=this._samples<=8?8:this._samples<=16?16:this._samples<=32?32:64;this._ssaoTechniqueConfig.samples=e,this._ssaoTechniqueConfig.radius=4,this._ssaoTechniqueConfig.output=0,this._ssaoTechnique=this._techniqueRep.acquireAndReleaseExisting(g,this._ssaoTechniqueConfig,this._ssaoTechnique),this._ssaoTechniqueConfig.output=1,this._blurTechnique=this._techniqueRep.acquireAndReleaseExisting(g,this._ssaoTechniqueConfig,this._blurTechnique)}enable(){this.enabled||(this.isSupported?(this._enabled=!0,this.loadResources((()=>{this._enabled&&this.initialize()}))):T.warn("SSAO is not supported for this browser or hardware"))}loadResources(e){this._data?e():import("./SSAOHelperData.js").then((t=>{this._data=t,e()}))}initialize(){const e={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0},t={colorTarget:0,depthStencilTarget:0};this._ssaoFBO=new c(this._rctx,t,e),this._blur0FBO=new c(this._rctx,t,e),this._blur1FBO=new c(this._rctx,t,e),a(this._data.noiseTexture).then((e=>{this._enabled&&(this._noiseTexture=new l(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,hasMipmap:!0,width:e.width,height:e.height},e),this._requestRender())})),this.selectPrograms()}disable(){this.enabled&&(this._enabled=!1,this._noiseTexture&&(this._noiseTexture.dispose(),this._noiseTexture=null),this._blur1FBO&&(this._blur1FBO.dispose(),this._blur1FBO=null),this._blur0FBO&&(this._blur0FBO.dispose(),this._blur0FBO=null),this._ssaoFBO&&(this._ssaoFBO.dispose(),this._ssaoFBO=null))}getGpuMemoryUsage(){return m(this._blur0FBO)+m(this._blur1FBO)+m(this._ssaoFBO)}get test(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}
