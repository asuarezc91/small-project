/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import t from"../../../../../core/Evented.js";import{c as e}from"../../../../../chunks/vec3f64.js";import{s}from"../../../../../chunks/vec3.js";import{scaleFromMatrix as i}from"../../../support/mathUtils.js";import{m as a}from"../../../../../chunks/mat4.js";import{a as r}from"../../../../../chunks/mat3f64.js";import{a as o}from"../../../../../chunks/mat4f64.js";import{f as n,d as l,t as h}from"../../../../../chunks/mat3.js";import{BufferViewMat4f64 as c,BufferViewVec3f64 as m,BufferViewMat3f as f,BufferViewVec2f as g,BufferViewVec4f64 as d,BufferViewVec4f as u,BufferViewUint8 as _}from"../../../support/buffer/BufferView.js";import{newLayout as T}from"../../../support/buffer/InterleavedLayout.js";import{assert as v}from"../Util.js";var p;!function(t){t[t.ALLOCATED=1]="ALLOCATED",t[t.ACTIVE=2]="ACTIVE",t[t.VISIBLE=4]="VISIBLE",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",t[t.REMOVE=32]="REMOVE",t[t.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED"}(p||(p={}));class F{constructor(t){this.localTransform=t.getField("localTransform",c),this.globalTransform=t.getField("globalTransform",c),this.modelOrigin=t.getField("modelOrigin",m),this.model=t.getField("model",f),this.modelNormal=t.getField("modelNormal",f),this.modelScaleFactors=t.getField("modelScaleFactors",g),this.boundingSphere=t.getField("boundingSphere",d),this.color=t.getField("color",u),this.featureAttribute=t.getField("featureAttribute",u),this.state=t.getField("state",_),this.lodLevel=t.getField("lodLevel",_)}}class b extends t{constructor(t,e){super(),this._capacity=0,this._size=0,this._next=0,this._layout=function(t){let e=T().mat4f64("localTransform").mat4f64("globalTransform").vec4f64("boundingSphere").vec3f64("modelOrigin").mat3f("model").mat3f("modelNormal").vec2f("modelScaleFactors");return t.indexOf("color")>=0&&(e=e.vec4f("color")),t.indexOf("featureAttribute")>=0&&(e=e.vec4f("featureAttribute")),e=e.u8("state").u8("lodLevel").alignTo(8),e}(t),this._shaderTransformation=e}get capacity(){return this._capacity}get size(){return this._size}get buffer(){return this._buffer.buffer}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this.grow();const t=this.findSlot();return this._view.state.set(t,p.ALLOCATED),this._size++,this.emit("instance-added",{index:t}),t}removeInstance(t){const e=this._view.state;v(t>=0&&t<this._capacity&&e.get(t)&p.ALLOCATED,"invalid instance handle"),this.getStateFlag(t,p.ACTIVE)?this.setStateFlags(t,p.REMOVE):this.freeInstance(t),this.emit("instance-removed",{index:t})}freeInstance(t){const e=this._view.state;v(t>=0&&t<this._capacity&&e.get(t)&p.ALLOCATED,"invalid instance handle"),e.set(t,0),this._size--}setLocalTransform(t,e,s=!0){this._view.localTransform.setMat(t,e),s&&this.updateModelTransform(t)}getLocalTransform(t,e){this._view.localTransform.getMat(t,e)}setGlobalTransform(t,e,s=!0){this._view.globalTransform.setMat(t,e),s&&this.updateModelTransform(t)}getGlobalTransform(t,e){this._view.globalTransform.getMat(t,e)}updateModelTransform(t){const e=this._view,r=w,o=L;e.localTransform.getMat(t,I),e.globalTransform.getMat(t,M);const c=a(M,M,I);s(r,c[12],c[13],c[14]),e.modelOrigin.setVec(t,r),n(o,c),e.model.setMat(t,o);const m=i(w,c);m.sort(),e.modelScaleFactors.set(t,0,m[1]),e.modelScaleFactors.set(t,1,m[2]),l(o,o),h(o,o),e.modelNormal.setMat(t,o),this.setStateFlags(t,p.TRANSFORM_CHANGED),this.emit("instance-transform-changed",{index:t})}getModelTransform(t,e){const s=this._view;s.model.getMat(t,L),s.modelOrigin.getVec(t,w),e[0]=L[0],e[1]=L[1],e[2]=L[2],e[3]=0,e[4]=L[3],e[5]=L[4],e[6]=L[5],e[7]=0,e[8]=L[6],e[9]=L[7],e[10]=L[8],e[11]=0,e[12]=w[0],e[13]=w[1],e[14]=w[2],e[15]=1}applyShaderTransformation(t,e){this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,e)}getCombinedModelTransform(t,e){return this.getModelTransform(t,e),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,e),e}getCombinedLocalTransform(t,e){return this._view.localTransform.getMat(t,e),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,e),e}getCombinedMaxScaleFactor(t){let e=this._view.modelScaleFactors.get(t,1);if(this._shaderTransformation){const s=this._shaderTransformation.scaleFactor(w,this,t);e*=Math.max(s[0],s[1],s[2])}return e}getCombinedMedianScaleFactor(t){let e=this._view.modelScaleFactors.get(t,0);if(this._shaderTransformation){const s=this._shaderTransformation.scaleFactor(w,this,t);s.sort(),e*=s[1]}return e}getModel(t,e){this._view.model.getMat(t,e)}setFeatureAttribute(t,e){this._view.featureAttribute.setVec(t,e)}getFeatureAttribute(t,e){this._view.featureAttribute.getVec(t,e)}setColor(t,e){this._view.color.setVec(t,e)}getColor(t,e){this._view.color.getVec(t,e)}setVisible(t,e){e!==this.getVisible(t)&&(this.setStateFlag(t,p.VISIBLE,e),this.emit("instance-visibility-changed",{index:t}))}getVisible(t){return this.getStateFlag(t,p.VISIBLE)}setHighlight(t,e){e!==this.getHighlight(t)&&(this.setStateFlag(t,p.HIGHLIGHT,e),this.emit("instance-highlight-changed",{index:t}))}getHighlight(t){return this.getStateFlag(t,p.HIGHLIGHT)}getState(t){return this._view.state.get(t)}getLodLevel(t){return this._view.lodLevel.get(t)}countFlags(t){let e=0;for(let s=0;s<this._capacity;++s){this.getState(s)&t&&++e}return e}setStateFlags(t,e){const s=this._view.state;e=s.get(t)|e,s.set(t,e)}clearStateFlags(t,e){const s=this._view.state;e=s.get(t)&~e,s.set(t,e)}setStateFlag(t,e,s){s?this.setStateFlags(t,e):this.clearStateFlags(t,e)}getStateFlag(t,e){return!!(this._view.state.get(t)&e)}grow(){const t=Math.max(S,Math.floor(this._capacity*A)),e=this._layout.createBuffer(t);if(this._buffer){const t=new Uint8Array(this._buffer.buffer);new Uint8Array(e.buffer).set(t)}this._capacity=t,this._buffer=e,this._view=new F(this._buffer)}findSlot(){const t=this._view.state;let e=this._next;for(;t.get(e)&p.ALLOCATED;)e=(e+1)%this._capacity;return this._next=(e+1)%this._capacity,e}}const S=1024,A=2,w=e(),L=r(),I=o(),M=o();export{b as InstanceData,p as StateFlags,F as View};
