/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import t from"../../../../core/has.js";import{isNone as r}from"../../../../core/maybe.js";import s from"../../../../core/Logger.js";import"../../../../core/accessorSupport/ensureType.js";import{property as i}from"../../../../core/accessorSupport/decorators/property.js";import{subclass as o}from"../../../../core/accessorSupport/decorators/subclass.js";import"../../../../core/urlUtils.js";import"../../../../core/uuid.js";import"../../../../portal/support/resourceExtension.js";import{addFrameTask as n}from"../../../../core/scheduling.js";import a from"../../../../core/Accessor.js";import p from"../../../../core/Evented.js";import{Milliseconds as h}from"../../../../layers/support/timeUtils.js";import{init as d}from"../../../../core/watchUtils.js";import{createContextOrErrorHTML as c}from"../../../webgl/context-util.js";import{AutoDisposableMixin as l,autoDispose as m}from"../lib/AutoDisposable.js";import _ from"../../../webgl/RenderingContext.js";import{CommonUniformStore as u}from"../core/shaderTechnique/CommonUniformStore.js";import{ShaderTechniqueRepository as g}from"../core/shaderTechnique/ShaderTechniqueRepository.js";import y from"../lib/GLMaterialRep.js";import{StippleTextureRepository as x}from"../materials/lineStippleUtils.js";import{clearTestWebGLDriver as f}from"../lib/WebGLDriverTest.js";import{DESIRED_ANIMATION_MS as R}from"../../support/animationUtils.js";import{removeLoadedShaderModules as v}from"./requireUtils.js";import{instrumentContext as b,begin as w,end as j}from"../statistics/tracer.js";import{ComponentObjectCollection as T}from"../collections/Component/ComponentObjectCollection.js";import U from"../lib/CompositingHelper.js";import{texure2depth as C}from"../lib/depthRangeUtils.js";import{MagnifierHelper as M}from"../lib/MagnifierHelper.js";import S from"../lib/Renderer.js";import{TextureRepository as O}from"../lib/TextureRepository.js";import{WaterTextureRepository as A}from"../materials/internal/WaterTextureRepository.js";import{ScreenshotManager as H}from"./ScreenshotManager.js";const L=s.getLogger("esri.views.3d.webgl-engine.parts.View");let q=null,E=class extends(l(a)){constructor(e){super({}),this._stage=e,this.events=new p,this._stippleTextureRepository=new x,this.waterTextureRepository=new A,this._magnifierHelper=new M,this._commonUniformStore=new u,this._componentObjectCollection=null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._logicUpdateLast=0,this._container=this._stage.container,this._initializeContext(this._stage.options),d(this.waterTextureRepository,"loadingState",(()=>this.setNeedsRender())),this._magnifierHelper.events.on("request-render",(()=>this.setNeedsRender())),this._shaderTechniqueRepository=new g({rctx:this._rctx,viewingMode:this._stage.options.viewingMode,commonUniformStore:this._commonUniformStore,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),this._textureRepository=new O(this._stage.scheduler,this._stage.getAll(4),this._shaderTechniqueRepository,this._rctx),this._textureRepository.events.on("changed",(e=>this.setNeedsRender(e))),this._materialRepository=new y(this._textureRepository,this._shaderTechniqueRepository,(()=>this.setNeedsRender())),this._compositingHelper=new U(this._rctx,this._shaderTechniqueRepository);const t=this._container.getBoundingClientRect();this._renderer=new S(this._materialRepository,this._textureRepository,this._shaderTechniqueRepository,this._rctx,this._compositingHelper,this._magnifierHelper,((e=1)=>this.setNeedsRender(e)),[t.width,t.height],this._stage),this._screenshotManager=new H(this._rctx,((e,t,r)=>this._render(e,t,r)),(()=>this.setNeedsRender()),this._stage.options.screenshot.renderOverlay,(e=>this.events.emit("force-camera-for-screenshot",e))),this._registerFrameTask()}normalizeCtorArgs(){return{}}dispose(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask&&(this._frameTask.remove(),this._frameTask=null),this._shaderTechniqueRepository.dispose(),this._shaderTechniqueRepository=null,f(this._rctx),super.dispose(),this._rctx=null}get performanceInfo(){const e=this._rctx.gl;return{renderer:this._renderer.performanceInfo,textureMemory:void 0!==e.getUsedTextureMemory?e.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==e.getUsedRenderbufferMemory?e.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==e.getUsedVBOMemory?e.getUsedVBOMemory():void 0}}setNeedsRender(e=1){1===e?this._needsUpdate||(this._needsUpdate=!0,this.notifyChange("updating")):this._needsRender=!0}get canRender(){return this._renderer.canRender}get needsUpdate(){return this._needsUpdate}get updating(){return this.evaluateUpdating()}evaluateUpdating(){return this.needsUpdate||this._renderer.updating||this._textureRepository.loadingCount>0||this.waterTextureRepository.updating||this._magnifierHelper.updating||this._stage.dirty}ensureEdgeView(){return this._renderer.ensureEdgeView()}get edgeView(){return this._renderer.edgeView}get textureRepository(){return this._textureRepository}get compositingHelper(){return this._compositingHelper}set magnifier(e){this._magnifierHelper.magnifier=e}setRenderParameters(e){this.setNeedsRender(),void 0!==e.idleSuspend&&(this._idleSuspend=!!e.idleSuspend),this._renderer.setRenderParameters(e)}get renderingContext(){return this._rctx}has(e){switch(e){case 0:return!!this._rctx.capabilities.compressedTextureS3TC;case 1:return!!this._rctx.capabilities.shaderTextureLOD;case 2:return this._renderer.hasShadowsEnabled;default:return!1}}modify(e,t,r){this._renderer.modify(e,e.length,t,t.length,r,r.length)}setCamera(e){this._renderer.camera=e}getCamera(){return this._renderer.camera}getCanvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e)}getMinimalDepthForArea(e,t,r,s=80,i=1){const o=s*r.pixelRatio,n=r.constrainWindowSize(e,t,o,i);q=new Uint8Array(4*n[2]*n[3]),this._renderer.readDepthPixels(n[0],n[1],n[2],n[3],q);let a=Number.MAX_VALUE;for(let e=0;e<n[2]*n[3];e++){const t=C(4*e,q,r.nearFar);a>t&&t!==r.nearFar[0]&&t!==r.nearFar[1]&&(a=t)}return a===Number.MAX_VALUE?void 0:a}get renderPlugins(){return this._renderer.renderPlugins}get test(){return{renderer:this._renderer}}getGpuMemoryUsage(){return this._renderer.getGpuMemoryUsage()}async hotReloadShaders(){v(),await this._shaderTechniqueRepository.hotReload(),this.setNeedsRender()}_registerFrameTask(){const e={viewCamera:this._renderer.camera,frameHasDecorations:!1};let t=!1;const r={preRender:e=>{t=this.evaluateUpdating(),w();let r=!1;this._stage.processDirty();const s=h(e.time-this._logicUpdateLast);if(s>R){const t={camera:this._renderer.camera,dt:s};r=this._renderer.updateLogic(t),this._logicUpdateLast=e.time}r&&this.setNeedsRender(0)},render:()=>{!this.needsUpdate&&!this._needsRender&&this._idleSuspend&&this._renderer.isCameraFinal||!this.canRender||(this._needsRender=!1,this._needsUpdate=!1,this._render(null,this._renderer.camera,!1))},postRender:()=>{t!==this.evaluateUpdating()&&this.notifyChange("updating"),j()},update:()=>{e.viewCamera=this._renderer.camera,e.frameHasDecorations=this._renderer.hasSlicePlane||this._magnifierHelper.enabled,this._textureRepository.update(),this._screenshotManager.update(e)}};this._frameTask=n(r)}_initializeContext(e){this._canvas=e.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const r={alpha:e.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==e.stencil||e.stencil,powerPreference:"high-performance"},s=b(c(this._canvas,r,e.renderContext)),i={disabledExtensions:e.deactivatedWebGLExtensions||{},debugWebGLExtensions:e.debugWebGLExtensions||{}};this._rctx=new _(s,i),null!=this._rctx.parameters.maxMaxAnisotropy&&(this._rctx.parameters.maxMaxAnisotropy=Math.min(this._rctx.parameters.maxMaxAnisotropy,8)),this._loadShaderOnlyExtensions(this._rctx),!e.alpha&&this._rctx.contextAttributes.alpha&&L.error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&t("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)}_render(e,t,r){this._renderer.render(e,t,r)}_loadShaderOnlyExtensions(e){const t=e.capabilities;t.standardDerivatives,t.shaderTextureLOD,t.textureFloat}get componentObjectCollection(){return r(this._componentObjectCollection)&&(this._componentObjectCollection=new T(this._renderer.renderPassManager)),this._componentObjectCollection}set componentObjectCollection(e){this._componentObjectCollection=e}};e([i({type:Boolean,readOnly:!0,dependsOn:["waterTextureRepository.updating","_magnifierHelper.updating"],autoTracked:!1})],E.prototype,"updating",null),e([m()],E.prototype,"_rctx",void 0),e([m()],E.prototype,"_container",void 0),e([m()],E.prototype,"_canvas",void 0),e([m()],E.prototype,"_stippleTextureRepository",void 0),e([m(),i()],E.prototype,"waterTextureRepository",void 0),e([m(),i()],E.prototype,"_magnifierHelper",void 0),e([m()],E.prototype,"_textureRepository",void 0),e([m()],E.prototype,"_commonUniformStore",void 0),e([m()],E.prototype,"_compositingHelper",void 0),e([m()],E.prototype,"_renderer",void 0),e([m()],E.prototype,"_screenshotManager",void 0),e([m()],E.prototype,"componentObjectCollection",null),e([m()],E.prototype,"_componentObjectCollection",void 0),E=e([o("esri.views.3d.webgl-engine.parts.RenderView")],E);export{E as RenderView};
