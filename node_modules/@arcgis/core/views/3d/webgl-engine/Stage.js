/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import{applySome as t}from"../../../core/maybe.js";import"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as r}from"../../../core/accessorSupport/decorators/property.js";import{subclass as i}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import o from"../../../core/Accessor.js";import{f as s}from"../../../chunks/vec3f64.js";import{s as n,p as d}from"../../../chunks/vec3.js";import{MainLight as m,AmbientLight as h}from"./lighting/Lightsources.js";import c from"./lib/GeometryRecord.js";import{AutoDisposableMixin as l,autoDispose as g}from"./lib/AutoDisposable.js";import{Model as a}from"./parts/Model.js";import{RenderView as p}from"./parts/RenderView.js";var u;let y=u=class extends(l(o)){constructor(e){super(e),this.model=new a,this._viewContent=[],this._mainLightDirection=s(0,1,0)}initialize(){this._set("renderView",new p(this)),this.setLighting({lights:[new m(s(.7,.7,.7)),new h(s(.3,.3,.3))],groundLightingFactor:.5,globalFactor:.5})}destroy(){c.pool.prune(0),this.dispose()}get dirty(){return this.model.getDirtySet().hasDirtyGeometryRecords()}get mainLightDirection(){return this._mainLightDirection}get lighting(){return this._lighting}setLighting(e){n(this._mainLightDirection,0,0,0);for(const t of e.lights)if(t instanceof m){d(this._mainLightDirection,t.direction);break}this._lighting=e,this.renderView.setNeedsRender()}stopAnimationsAtTime(e){this.getAll(3).forEach((r=>{t(r.animation,(t=>t.stopAtTime(e)))})),this.renderView.setNeedsRender()}add(e,t){this.model.add(e,t),f(t)&&t.addParentStage(this),this.renderView.setNeedsRender()}remove(e,t){this.renderView.setNeedsRender();const r=this.model.remove(e,t);return f(r)&&r.removeParentStage(this),r}notifyDirty(e,t,r){this.destroyed||(this.model.notifyDirty(e,t,r),this.renderView.setNeedsRender())}processDirty(){const e=this.model.getDirtySet();if(!e.hasDirtyGeometryRecords())return;u.DebugSettings.logDirtySet&&console.log("Dirty set: "+this.model.getDirtySet().formatDebugInfo());const t=e.commitLayers(this._viewContent);t[0].length+t[1].length+t[2].length>0&&this.renderView.modify(t[0],t[1],t[2]),u.DebugSettings.logDirtySet&&(console.log("RGs add: "+t[0].map((e=>e.uniqueName))),console.log("RGs remove: "+t[1].map((e=>e.uniqueName)))),e.commit(),this.renderView.setNeedsRender()}processDirtyLayer(e){const t=this.model.getDirtySet().commitLayers([e]);t[0].length+t[1].length+t[2].length>0&&this.renderView.modify(t[0],t[1],t[2]),this.renderView.setNeedsRender()}getContent(e,t){return this.model.get(e,t)}getAll(e){return this.model.getAll(e)}getCount(e){return this.model.getAll(e).size}getCamera(){return this.renderView.getCamera()}setCamera(e){this.renderView.setCamera(e)}getLayers(){return this.model.getAll(0)}getViewContent(){return this._viewContent.slice(0)}addToViewContent(e){const t=[];for(let r=0;r<e.length;r++)-1===this._viewContent.indexOf(e[r])&&t.push(e[r]);if(e.length>0){this.processDirty();const e=this.model.getDirtySet().getResidentRenderGeometriesFilteredByLayers(t);this.renderView.modify(e,[],[]),this._viewContent.push.apply(this._viewContent,t)}}removeFromViewContent(e){this.processDirty();const t=this.model.getDirtySet(),r=this._viewContent,i=[];for(let t=0;t<e.length;t++){const o=r.indexOf(e[t]);o>-1&&(r[o]=r[r.length-1],r.pop(),i.push(e[t]))}const o=t.getResidentRenderGeometriesFilteredByLayers(i);this.renderView.modify([],o,[])}addRenderPlugin(e,t){"intersect"in t&&this.sceneIntersectionHelper.addIntersectionHandler(t),this.renderView.renderPlugins.add(e,t)}removeRenderPlugin(e){"intersect"in e&&this.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderView.renderPlugins.remove(e)}get performanceInfo(){return{renderView:this.renderView.performanceInfo,model:this.model.getStats()}}};function f(e){return"function"==typeof e.addParentStage&&"function"==typeof e.removeParentStage}y.DebugSettings={endFrameContentValidation:!1,logDirtySet:!1},e([r({constructOnly:!0})],y.prototype,"scheduler",void 0),e([r({constructOnly:!0})],y.prototype,"options",void 0),e([r({constructOnly:!0})],y.prototype,"sceneIntersectionHelper",void 0),e([r({constructOnly:!0})],y.prototype,"viewingMode",void 0),e([r({constructOnly:!0})],y.prototype,"container",void 0),e([g(),r()],y.prototype,"renderView",void 0),y=u=e([i("esri.views.3d.webgl-engine.Stage")],y);export{y as Stage};
