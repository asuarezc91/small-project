/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as e}from"../../../core/maybe.js";import{equals as t}from"../../../core/arrayUtils.js";import{clamp as r}from"../../../core/mathUtils.js";import{empty as i}from"../../../geometry/support/aaBoundingBox.js";import{ELEVATION_DESIRED_RESOLUTION_LEVEL as s}from"./TerrainConst.js";import{Default3D as a}from"../webgl-engine/lib/DefaultVertexAttributeLocations.js";import{glLayout as o}from"../support/buffer/glUtil.js";import l from"../../webgl/BufferObject.js";import n from"../../webgl/VertexArrayObject.js";import{PatchGeometry as u,releaseGeometry as m}from"./PatchGeometryFactory.js";import{fallsWithinLayer as h}from"./tileUtils.js";import c from"./TextureFader.js";import f from"./TileOverlayData.js";class p{constructor(){this.geometryInfo=new u,this._textureRef=new c((()=>this.tile.surface.textureFadeDuration)),this.overlay=new f}init(e){this.tile=e,this.clear();const t=this.geometryInfo;t.indices=null,t.vertexAttributes=null,i(t.boundingBox),t.numSurfaceIndices=0,t.numSkirtIndices=0,t.numWithoutSkirtIndices=0,t.numVertsPerRow=0,this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},this.opacity=1,this.localOrigin=null,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear()}updateGeometry(e,t){return!!this._updateGeometryState(t)&&(this._releaseGeometry(),this._createGeometry(e),!0)}releaseGeometry(){return!!this._releaseGeometry()&&(this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},!0)}ensureTexture(t,r){return e(this._texture)&&this._texture.descriptor.width!==t&&this.releaseTexture(),this._texture||(this._texture=r(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){e(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}_updateGeometryState(e){const i=this._getElevationInfo(),a=this.tile.level;let o=a<8?this.tile.numSubdivisionsAtLevel[a]+1:2;if(i.samplerData){const e=this.tile.vlevel-a,t=Math.max(a-i.maxTileLevel,s-e),l=this.tile.maxTesselation;o=r(1+(l>>t),2,l+1)}let l=this.tile.clippingArea;this.tile.intersectsClippingArea&&!this.tile.isWithinClippingArea||(l=null);const n=this.geometryState;let u=!1;return n.numVertsPerRow!==o&&(n.numVertsPerRow=o,u=!0),i.changed&&(n.samplerData=i.samplerData,u=!0),t(n.clippingArea,l)||(n.clippingArea=l,u=!0),n.wireframe!==e&&(n.wireframe=e,u=!0),u}_createGeometry(e){this.tile.createGeometry(this.geometryState,this.localOrigin);const t=this.geometryInfo.vertexAttributes,r=this.geometryInfo.indices,i=e.gl;this._vao=new n(e,a,{geometry:o(t.layout)},{geometry:l.createVertex(e,i.STATIC_DRAW,t.buffer)},l.createIndex(e,i.STATIC_DRAW,r))}_releaseGeometry(){return!!this._vao&&(this._vao.dispose(),this._vao=null,m(this.geometryInfo),!0)}get vao(){return this._vao}setTextureReference(e,t,r,i,s=0){e!==this._texture&&this.releaseTexture(),this._textureRef.push(e,t,r,i,s)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[0],r=t.length;let i=new Array(r),s=0,a=0,o=!1;for(let l=0;l<r;l++){const r=t[l];if(r.upsampleInfo){const t=r.upsampleInfo.tile,n=t.layerInfo[0][l].data,u=n&&n.samplerData;e&&e[s]===u||(o=!0),i[s++]=u,a=Math.max(a,t.lij[0])}else if(r.data){const t=this.tile.surface.layerViewByIndex(l,0);if(h(this.tile,t.layer,!1)){const t=r.data;e&&e[s]===t.samplerData||(o=!0),i[s++]=t.samplerData,a=this.tile.lij[0]}}}return e&&e.length!==s&&(o=!0),s>0?i.length=s:i=null,{changed:o,samplerData:i,maxTileLevel:a}}get estimatedGeometryMemoryUsage(){return this.geometryInfo.indices.byteLength+this.geometryInfo.vertexAttributes.byteLength}get textureDescriptor(){return e(this._texture)?this._texture.descriptor:null}get test(){return{hasTexture:null!=this._texture}}}export{p as PatchRenderData};
