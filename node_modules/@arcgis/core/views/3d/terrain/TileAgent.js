/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{get as e,isNone as t}from"../../../core/maybe.js";import{LOADING_LEVEL_MODULO as s}from"./TerrainConst.js";import{getLayerWithExtentRange as i}from"./terrainUtils.js";import{fallsWithinLayer as l}from"./tileUtils.js";const a=new Error("Abstract method called on TileAgent");class r{constructor(){}get updating(){return!!this._tileRequested}init(e,t,s,i){this.tile=e,this._layerIdx=t,this._layerClass=s,this._suspended=i,this._tileLayerInfo=e.getLayerInfo(t,s),this._tileRequested=null;const l=this._findAncestorWithData();this._setUpsampleTile(l)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e){this._setUpsampleTile(e),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.disposeData(),this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return e?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const a=this._layerIdx,r=this._layerClass,n=this.tile.surface.layerViewByIndex(a,r),h=i(n),{minLevel:d,maxLevel:_}=n.dataLevelRange,o=this._desiredMinLevelDelta,u=this._loadingLevelDelta+o,y=this._scaleRangeEnabled?l:()=>!0;let p,f=this.tile,q=0;const I=this._tileLayerInfo.upsampleInfo,L=I?I.tile.level:-1,D=e(h,"tilemapCache");for(;f&&y(f,h,!1)&&f.level>=d;){const e=f.level,i=f.layerInfo[r][a];if(i.data&&q>=o){e>L&&this._setUpsampleTile(f),i.dataInvalidated&&(p=f);break}if((t(D)||"unavailable"!==D.getAvailability(f.lij[0],f.lij[1],f.lij[2]))&&e<=_&&!i.data&&!i.dataMissing&&((!p||e%s==0||this.tile.level-p.level<o)&&(p=f),q>=u))break;f=f.parent,q++}return p&&this.tile.level-p.level<o&&this._tileLayerInfo.upsampleInfo&&(p=null),p}_findAncestorWithData(){const e=this.tile.vlevel,t=this._desiredMinLevelDelta;let s;for(let i=this.tile;i;i=i.parent)if(i.hasLayerData(this._layerIdx,this._layerClass)){if(e-i.level>=t)return i;s=i}return s}_setUpsampleTile(e){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass)}get test(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}const n=new class extends r{get _desiredMinLevelDelta(){throw a}get _loadingLevelDelta(){throw a}};export{n as TILE_AGENT_DONE,r as TileAgent};
