/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as t}from"../../../core/accessorSupport/decorators/property.js";import{subclass as i}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import s from"../../../core/Accessor.js";import{isMars as r,isMoon as o}from"../../../geometry/support/spatialReferenceUtils.js";import n from"../../../core/Handles.js";import{canProjectToWGS84ComparableLonLat as l}from"../../../geometry/projection.js";import{isTiledLayer as a}from"../../../layers/support/layerUtils.js";import c from"./TilingScheme.js";import{getTiledLayerInfo as h,isProjectableRasterLayer as p}from"./terrainUtils.js";let m=class extends s{constructor(e){super(e),this._changeHandles=new n}initialize(){this._changeHandles.add(this.layers.on("change",(()=>this._update()))),this._changeHandles.add(this.extentHelper.watch("layerViewsExtent",(()=>this._setAdHocTilingScheme()))),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._changeHandles.destroy(),this._changeHandles=null}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this._set("tilingSchemeDone",!1),this.layers.some((t=>!(!a(t)||t.isRejected())&&(!(t.isFulfilled()&&!function(e,t,i){return!!h(e,t,i).tileInfo}(t,this.viewSpatialReference,this.manifold))&&(e=t,"vector-tile"!==t.type&&!p(t))))),e)if(e.isResolved()){const t=e,{tileInfo:i}=h(t,this.viewSpatialReference,this.manifold),s=new c(i);this._set("tilingSchemeDone",!0),this._lockTilingScheme(s)}else this._updateWhen(e);else this._set("tilingSchemeDone",!0)}_updateWhen(e){const t=e.when().catch((e=>e)).then((()=>{t===this._waitTask&&this._update()}));this._waitTask=t}_lockTilingScheme(e){if("spherical"===this.manifold){const t=e.levels.length-1;e.spatialReference.isWebMercator?e=c.makeWebMercatorAuxiliarySphere(t):l(e.spatialReference)&&(e=c.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this._changeHandles.removeAll(),this._changeHandles.add(this.extentHelper.watch("tiledLayersExtent",(()=>this._updateTiledLayerExtent())))}_updateTiledLayerExtent(){this.extent=this.extentHelper.tiledLayersExtent}_setAdHocTilingScheme(){if("spherical"===this.manifold){const e=this.extentHelper.spatialReference,t=l(e)||r(e)||o(e);e.isWebMercator?this.tilingScheme=c.WebMercatorAuxiliarySphere:t&&(this.tilingScheme=c.makeGCSWithTileSize(e,256)),this.extent=this.extentHelper.layerViewsExtent}else{const e=this.extentHelper.layerViewsExtent;e&&(this.tilingScheme=c.fromExtent(e,this.extentHelper.spatialReference),this.extent=e)}}};e([t()],m.prototype,"tilingScheme",void 0),e([t()],m.prototype,"extent",void 0),e([t({value:!1})],m.prototype,"tilingSchemeLocked",void 0),e([t({readOnly:!0,value:!1})],m.prototype,"tilingSchemeDone",void 0),e([t({constructOnly:!0})],m.prototype,"viewSpatialReference",void 0),e([t({constructOnly:!0})],m.prototype,"layers",void 0),e([t({constructOnly:!0})],m.prototype,"extentHelper",void 0),e([t({constructOnly:!0})],m.prototype,"manifold",void 0),m=e([i("esri.views.3d.terrain.SurfaceTilingSchemeLogic")],m);var d=m;export default d;
