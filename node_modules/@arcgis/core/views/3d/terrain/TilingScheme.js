/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import e from"../../../core/Error.js";import{isMars as t,isMoon as i}from"../../../geometry/support/spatialReferenceUtils.js";import s from"../../../geometry/SpatialReference.js";import r from"../../../geometry/Extent.js";import"../../../geometry.js";import{deg2rad as l,floatEqualAbsolute as o,floatEqualRelative as n}from"../../../core/mathUtils.js";import{getMetersPerUnitForSR as a}from"../../../core/unitUtils.js";import{create as h}from"../../../geometry/support/aaBoundingRect.js";import{webMercator as c,canProjectToWGS84ComparableLonLat as p}from"../../../geometry/projection.js";import u from"../../../layers/support/TileInfo.js";const m=c.x2lon,f=c.y2lat;class g{constructor(e){const s=g.checkUnsupported(e);if(s)throw s;this.spatialReference=e.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=p(this.spatialReference)||t(this.spatialReference)||i(this.spatialReference),this.origin=[e.origin.x,e.origin.y],this.pixelSize=e.size[0],this.dpi=e.dpi;const r=e.lods.reduce((function(e,t,i){return t.level<e.min&&(e.min=t.level,e.minIndex=i),e.max=Math.max(e.max,t.level),e}),{min:1/0,minIndex:0,max:-1/0}),l=e.lods[r.minIndex],o=Math.pow(2,l.level);let n=l.resolution*o,a=l.scale*o;this.levels=new Array(r.max+1);for(let t=0;t<this.levels.length;t++)this.levels[t]={resolution:n,scale:a,tileSize:[n*e.size[0],n*e.size[1]]},n/=2,a/=2}clone(){return new g(this.toTileInfo())}toTileInfo(){return new u({dpi:this.dpi,origin:{x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference},size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map(((e,t)=>({level:t,scale:e.scale,resolution:e.resolution})))})}getExtent(e,t,i,s){const r=this.levels[e],l=r.tileSize[0],o=r.tileSize[1];s[0]=this.origin[0]+i*l,s[2]=s[0]+l,s[3]=this.origin[1]-t*o,s[1]=s[3]-o}convertExtentToRadians(e,t){this._isWebMercator?(t[0]=m(e[0]),t[1]=f(e[1]),t[2]=m(e[2]),t[3]=f(e[3])):this._isGCS&&(t[0]=l(e[0]),t[1]=l(e[1]),t[2]=l(e[2]),t[3]=l(e[3]))}getExtentGeometry(e,t,i,s=new r){return this.getExtent(e,t,i,x),s.spatialReference=this.spatialReference,s.xmin=x[0],s.ymin=x[1],s.xmax=x[2],s.ymax=x[3],s.zmin=void 0,s.zmax=void 0,s}ensureMaxLod(e){if(null==e)return!1;let t=!1;for(;this.levels.length<=e;){const e=this.levels[this.levels.length-1],i=e.resolution/2;this.levels.push({resolution:i,scale:e.scale/2,tileSize:[i*this.pixelSize,i*this.pixelSize]}),t=!0}return t}capMaxLod(e){this.levels.length>e+1&&(this.levels.length=e+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(e){return this.levels[0].scale/Math.pow(2,e)}levelAtScale(e){const t=this.levels[0].scale;return e>=t?0:Math.log(t/e)*Math.LOG2E}resolutionAtLevel(e){return this.levels[0].resolution/Math.pow(2,e)}compatibleWith(e){if(!(e instanceof g)){if(g.checkUnsupported(e))return!1;e=new g(e)}if(!e.spatialReference.equals(this.spatialReference))return!1;if(e.pixelSize!==this.pixelSize)return!1;const t=Math.min(this.levels.length,e.levels.length)-1,i=this.levels[t].resolution;let s=.5*i;if(!o(e.origin[0],this.origin[0],s)||!o(e.origin[1],this.origin[1],s))return!1;return s=.5*i/Math.pow(2,t)/this.pixelSize*12,o(i,e.levels[t].resolution,s)}rootTilesInExtent(e,t,i){const s=this.levels[0].tileSize;if(0===s[0]||0===s[1])return[];g.computeRowColExtent(e,s,this.origin,x);let r=x[1],l=x[3],o=x[0],n=x[2];const a=n-o,h=l-r;if(a*h>i){const e=Math.floor(Math.sqrt(i));h>e&&(r=r+Math.floor(.5*h)-Math.floor(.5*e),l=r+e),a>e&&(o=o+Math.floor(.5*a)-Math.floor(.5*e),n=o+e)}const c=[];for(let e=r;e<l;e++)for(let t=o;t<n;t++)c.push([0,e,t]);return t&&(t[0]=this.origin[0]+o*s[0],t[1]=this.origin[1]-l*s[1],t[2]=this.origin[0]+n*s[0],t[3]=this.origin[1]-r*s[1]),c}static computeRowColExtent(e,t,i,s){const r=.001*(e[2]-e[0]+(e[3]-e[1]));s[0]=Math.max(0,Math.floor((e[0]+r-i[0])/t[0])),s[2]=Math.max(0,Math.ceil((e[2]-r-i[0])/t[0])),s[1]=Math.max(0,Math.floor((i[1]-e[3]+r)/t[1])),s[3]=Math.max(0,Math.ceil((i[1]-e[1]-r)/t[1]))}static isPowerOfTwo(e){const t=e.lods,i=t[0].resolution*Math.pow(2,t[0].level);return!t.some((function(e){return!n(e.resolution,i/Math.pow(2,e.level))}))}static hasGapInLevels(e){const t=e.lods.map((function(e){return e.level}));t.sort((function(e,t){return e-t}));for(let e=1;e<t.length;e++)if(t[e]!==t[0]+e)return!0;return!1}static tileSizeSupported(e){const t=e.size[1];return t===e.size[0]&&0==(t&t-1)&&t>=128&&t<=512}static checkUnsupported(t){return t?t.lods.length<1?new e("tilingscheme:generic","Tiling scheme must have at least one level"):g.isPowerOfTwo(t)?g.hasGapInLevels(t)?new e("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):g.tileSizeSupported(t)?null:new e("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new e("tilingscheme:power-of-two","Tiling scheme must be power of two"):new e("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static fromExtent(e,t){const i=e[2]-e[0],s=e[3]-e[1],r=a(t),l=1.2*Math.max(i,s),o=256,n=new g(new u({size:[o,o],origin:{x:e[0]-.5*(l-i),y:e[3]+.5*(l-s)},lods:[{level:0,resolution:l/o,scale:1/(o/96*.0254/(l*r))}],spatialReference:t}));return n.ensureMaxLod(20),n}static makeWebMercatorAuxiliarySphere(e){const t=new g(g.WebMercatorAuxiliarySphereTileInfo);return t.ensureMaxLod(e),t}static makeGCSWithTileSize(e,t=256,i=16){const s=256/t,r=new g(new u({size:[t,t],origin:{x:-180,y:90,spatialReference:e},spatialReference:e,lods:[{level:0,resolution:.703125*s,scale:295497598.570834*s}]}));return r.ensureMaxLod(i),r}get test(){return{isWebMercator:this._isWebMercator,isGCS:this._isGCS}}}g.WebMercatorAuxiliarySphereTileInfo=new u({size:[256,256],origin:{x:-20037508.342787,y:20037508.342787,spatialReference:s.WebMercator},spatialReference:s.WebMercator,lods:[{level:0,resolution:156543.03392800014,scale:591657527.591555}]}),g.WebMercatorAuxiliarySphere=g.makeWebMercatorAuxiliarySphere(19);const x=h();export default g;
