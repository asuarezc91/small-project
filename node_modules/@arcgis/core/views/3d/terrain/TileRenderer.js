/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import"../../../core/has.js";import{isSome as e,isNone as t}from"../../../core/maybe.js";import{nextHighestPowerOfTwo as r}from"../../../core/mathUtils.js";import{Z as i}from"../../../chunks/vec2f64.js";import{s,c as a}from"../../../chunks/vec2.js";import{isBaseLayer as o}from"../../../layers/support/layerUtils.js";import"../../../chunks/builtins.js";import n from"../../webgl/Texture.js";import{vertexCount as l}from"../../webgl/Util.js";import{Pos2Tex as u}from"../webgl-engine/lib/DefaultVertexBufferLayouts.js";import{createQuadVAO as c,createColorTexture as h,createEmptyTexture as d}from"../webgl-engine/lib/glUtil3D.js";import"../../webgl/FramebufferObject.js";import"../../webgl/RenderingContext.js";import{ImageWithType as f}from"../support/StreamDataLoader.js";import{setTextures as p}from"../../webgl/rasterUtils.js";import _ from"./TileTexture.js";import{isVectorTileLayerView as x,isVectorTileRenderInfo as m,isImageryTileRenderInfo as T,isRasterTileRenderInfo as y,isTextureTileRenderInfo as b}from"./terrainUtils.js";import{VectorTileRendererHelper3D as g}from"../../2d/engine/vectorTiles/tileRendererHelper3D.js";import{BlendLayersTechniqueConfiguration as w,BlendLayersTechnique as q}from"./BlendLayersTechnique.js";import{RasterColorizerTechniqueConfiguration as L,RasterColorizerTechnique as D}from"./RasterColorizerTechnique.js";import{FBOPool as C}from"./support/FBOPool.js";function I(e,t,r){r.layerIndex=t;const i=e.layerInfo[1][t];if(i.data)return s(r.offset,0,0),r.tile=e,r.scale=1,r.sourceLod=e.lij,r.sourceLayerInfo=i,r;const o=i.upsampleInfo;if(o){const e=o.tile.layerInfo[1][t];return r.tile=o.tile,a(r.offset,o.offset),r.scale=o.scale,r.sourceLod=o.tile.lij,r.sourceLayerInfo=e,r}return null}const k=new Array,R={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0};export default class{constructor(e,t,r){this._rctx=e,this.tileSize=t,this._backgroundTexture=null,this._blackTex=null,this._vectorTileHelper=new g;this._rctx.capabilities.textureFilterAnisotropic&&(this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy),this._vaoQuad=c(this._rctx,u);const i=new w;i.mode=2,this._blendLayersTechnique=r.acquireAndReleaseExisting(q,i,this._blendLayersTechnique),i.mode=1,this._applyOpacityTechnique=r.acquireAndReleaseExisting(q,i,this._applyOpacityTechnique),this._techniqueRep=r,this._blackTex=new _(h(this._rctx,[0,0,0,1])),this._fboPool=new C(this._rctx)}dispose(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null),this._vaoQuad&&(this._vaoQuad.dispose(),this._vaoQuad=null),e(this._backgroundTexture)&&(this._backgroundTexture.release(),this._backgroundTexture=null),this._blackTex&&(this._blackTex.release(),this._blackTex=null),this._blendLayersTechnique&&(this._blendLayersTechnique.dispose(),this._blendLayersTechnique=null),this._applyOpacityTechnique&&(this._applyOpacityTechnique.dispose(),this._applyOpacityTechnique=null),this._rasterColorizerTechnique&&(this._rasterColorizerTechnique.dispose(),this._rasterColorizerTechnique=null),this._vectorTileHelper&&(this._vectorTileHelper.dispose(),this._vectorTileHelper=null)}updateTileTexture(i){const s=i.layerInfo[1];for(const e of s)e.pendingUpdates&=-65;if(!i.renderData)return;const a=i.surface,n=a.baseOpacity;let l=0,u=0,c=this.tileSize,h=!1;const d=a.view.pixelRatio;let f=s.length,p=0;for(;p<s.length&&!h;p++){const t=a.layerViewByIndex(p,1),r=t.fullOpacity;if(k[p]=r,o(t.layer)&&f>=s.length&&(f=p),0===r)continue;++u;const _=I(i,p,R);_&&(x(t)?c=Math.max(c,this.tileSize*d):1===n&&1===r&&(t.isOpaque||this._dataToTexture(_)&&e(_.sourceLayerInfo.data)&&_.sourceLayerInfo.data.descriptor.isOpaque)&&(h=!0),++l)}this._cleanupFBOPool(d,s.length),c=function(e){const t=r(e),i=t*t,s=e*e;if(i===s)return e;const a=t/2;return i-s<s-a*a?t:a}(c);const _=c/this.tileSize,m=p-1;if(0===l){let e=0;(i.surface.view.layerViewManager.updating||u>0)&&(e=5e3),this._backgroundTexture&&t(i.renderData.textureReference)&&(e=0),this._useBackgroundTexture(i,e)}else 1===l&&h?this._useLayerTexture(i,m):this._composeMapLayers(i,m,f,h,k,c,_)}setBackground(t){e(this._backgroundTexture)&&this._backgroundTexture.release(),t instanceof HTMLImageElement?this._backgroundTexture=this._buildTexture(t):this._backgroundTexture=new _(h(this._rctx,t))}_buildTexture(e){if(t(e))return null;const r={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},i=this._rctx;let s;if("number"==typeof e)r.width=r.height=e,s=new _(new n(i,r));else if(e instanceof f)r.isOpaque=e.isOpaque,s=new _(new n(i,r,e.image)),e.release();else try{s=new _(new n(i,r,e))}catch(e){s=new _(d(i)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}return i.bindTexture(s.texture,0),s.generateMipmap(),s}_drawQuad(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(5,0,l(this._vaoQuad,"geometry"))}_drawRasterData(e,r,i,s,a=1){if(t(r))return;const o=this._rctx,n=e.program;o.setPipelineState(e.pipeline),o.bindProgram(n),o.bindTexture(r,0),n.setUniform1i("tex",0),n.setUniform1f("scale",i),n.setUniform2f("offset",s[0],s[1]),n.setUniform1f("opacity",a),this._drawQuad(n)}_drawImageryTileData(e,r=1){const i=e.sourceLayerInfo.data;if(t(i)||!i.source)return;e.tile.surface.layerViewByIndex(e.layerIndex,1).ensureSymbolizerParameters(i);const s=this._getRasterColorizerTechnique(i.symbolizerParameters.type,!!i.symbolizerParameters.colormap),a=this._rctx,o=s.program;if(a.setPipelineState(s.pipeline),a.bindProgram(o),!i.bind(a))return;i.opacity=r,i.scale=e.scale,i.offset=e.offset;const{names:n,textures:l}=i.getTextures();p(a,o,n,l);const u=i.getUniforms();s.bindPass(a,u),this._drawQuad(o),a.bindVAO()}_getRasterColorizerTechnique(e,t){const r=["stretch","lut","hillshade"].indexOf(e);return this._rasterColorizerConfig||(this._rasterColorizerConfig=new L,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.colorizerType=r,this._rasterColorizerConfig.applyColormap=t,this._rasterColorizerTechnique=this._techniqueRep.acquireAndReleaseExisting(D,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}_drawVectorData(e,r,i,s,a,o,n){const l=r.sourceLayerInfo.data;if(t(l))return n;const u=this._rctx,c=r.tile.surface.layerViewByIndex(r.layerIndex,1);let h;u.setPipelineState(e.pipeline);const d=s<1;return d?(h=this._fboPool.acquire(a),u.bindFramebuffer(h),u.setClearColor(1,1,1,0),u.clearSafe(16640)):n&&u.clearSafe(256),this._vectorTileHelper.render(u,r.sourceLod,l,c.painter,c.layer.styleRepository,c.schemaHelper,Math.round(1/r.scale),r.offset,this.tileSize,i),!d||(u.bindFramebuffer(o),this._drawRasterData(e,h.colorTexture,1,[0,0],s),this._fboPool.release(h),n)}_useBackgroundTexture(e,t){e.renderData.opacity=e.surface.baseOpacity,e.renderData.setTextureReference(this._backgroundTexture,0,0,1,t)}_useLayerTexture(e,t){e.renderData.opacity=e.surface.baseOpacity;const r=I(e,t,R);if(this._dataToTexture(r)){const t=r.offset;e.renderData.setTextureReference(r.sourceLayerInfo.data,t[0],t[1],r.scale)}}_composeMapLayers(r,s,a,o,n,l,u){const c=r.renderData.ensureTexture(l,(()=>this._buildTexture(l)));if(t(c))return;const h=this._rctx,d=this._fboPool.acquire(l);h.bindFramebuffer(d),h.setViewport(0,0,l,l),h.setClearColor(0,0,0,0),h.setClearDepth(1),h.clearSafe(16640);let f=!1;!o&&e(this._backgroundTexture)&&this._drawRasterData(this._blendLayersTechnique,this._backgroundTexture.texture,1,i);const p=r.surface.baseOpacity;let _=!1;for(let t=s;t>=0;t--){const s=I(r,t,R);s&&(t<a&&p<1&&!_&&(this._drawRasterData(this._applyOpacityTechnique,this._blackTex.texture,1,i,p),_=!0),0!==n[t]&&(m(s)?f=this._drawVectorData(this._blendLayersTechnique,s,u,n[t],l,d,f):T(s)?this._drawImageryTileData(s,n[t]):this._dataToTexture(s)&&e(s.sourceLayerInfo.data)&&this._drawRasterData(this._blendLayersTechnique,s.sourceLayerInfo.data.texture,s.scale,s.offset,n[t])))}h.bindTexture(c.texture,0);const x=c.descriptor;h.gl.copyTexImage2D(h.gl.TEXTURE_2D,0,x.pixelFormat,0,0,x.width,x.height,0),c.generateMipmap(),h.bindFramebuffer(null),this._fboPool.release(d),r.renderData.opacity=_?1:p,r.renderData.setTextureReference(c,0,0,1)}_dataToTexture(e){return y(e)&&this._rasterDataToTexture(e),b(e)}_rasterDataToTexture(e){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()}_cleanupFBOPool(e,t){e===this._lastPixelRatio&&t===this._lastNumLayers||(this._fboPool.clear(),this._lastPixelRatio=e,this._lastNumLayers=t)}get test(){return{backgroundTexture:this._backgroundTexture}}}
