/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../chunks/tslib.es6.js";import i from"../../../../core/has.js";import"../../../../core/Logger.js";import"../../../../core/accessorSupport/ensureType.js";import{property as s}from"../../../../core/accessorSupport/decorators/property.js";import{subclass as e}from"../../../../core/accessorSupport/decorators/subclass.js";import"../../../../core/urlUtils.js";import"../../../../core/uuid.js";import"../../../../portal/support/resourceExtension.js";import{acosClamped as o,clamp as r}from"../../../../core/mathUtils.js";import{createScreenPointArray as n}from"../../../../core/screenUtils.js";import{c as a}from"../../../../chunks/vec3f64.js";import{g as p,f as h,l as c,n as m,b as l,a as v,d as u,c as f,i as P}from"../../../../chunks/vec3.js";import{getReferenceEllipsoid as d}from"../../../../geometry/projectionEllipsoid.js";import{i as w,r as C}from"../../../../chunks/mat4.js";import{a as j}from"../../../../chunks/mat4f64.js";import{a as g}from"../../../../chunks/vec2f64.js";import{c as y}from"../../../../chunks/vec2.js";import{TiltDefault as b}from"../Constraints.js";import{applyAll as R}from"../../camera/constraintUtils.js";import{normalizeCoordinate as x,decideNavigationMode as D,NavigationMode as T}from"../utils/navigationUtils.js";import{InteractiveController as k}from"./InteractiveController.js";let V=class extends k{constructor(t){super(t),this.view=null,this.pivot="center",this.lastPoint=g(),this.tmpWorldUp=a(),this.tmpViewDir=a(),this.tmpRotCurPoint=g(),this.tmpTransf=j(),this.tmpAxis=a(),this.tmpPivotPoint=a(),this.pivotPos=a(),this.constraintOptions={selection:15,interactionType:2,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0}}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.rotScale="center"===this.pivot?3:1.5}begin(t){if(this.active){switch(this.pivot){case"eye":p(this.pivotPos,this.beginCamera.eye),this.constraintOptions.interactionType=3,this.constraintOptions.tiltMode=1,this.constraintOptions.selection=0;break;case"center":this.intersectionHelper.intersectRayFreePointFallback(this.beginCamera.ray,this.pivotPos)||p(this.pivotPos,this.beginCamera.center),i("disable-feature:context-navigation")||this.constrainPivotPoint(t),this.beginCamera.center=this.pivotPos,this.constraintOptions.interactionType=2,this.constraintOptions.tiltMode=0,this.constraintOptions.selection=11}this.constraintOptions.interactionStartCamera=this.beginCamera,x(this.beginCamera,t,this.lastPoint)}}constrainPivotPoint(t){const i=this.beginCamera,s=a();let e;h(s,this.pivotPos,i.eye),this.view.camera.position.hasZ&&(e=Math.abs(this.view.camera.position.z));let o=c(s);this.view.camera.position.hasZ&&o>7*e&&(o=7*e);const r=d(this.view.spatialReference),u=n(i.width/i.pixelRatio*.5,i.height/i.pixelRatio*.5),f=D(this.beginCamera,u,!0,r);let P=this.view._stage.renderView.getMinimalDepthForArea(i.fullWidth/i.pixelRatio*.5,i.fullHeight/i.pixelRatio*.5,i,90,2.5),w=this.view._stage.renderView.getMinimalDepthForArea(t[0],t[1],i,90);void 0===P&&void 0===w||(P=void 0===P?w:P,w=void 0===w||f===T.Horizontal?P:w,o=P>w?w:P),m(s,s),p(this.pivotPos,l(this.tmpPivotPoint,i.eye,v(this.tmpPivotPoint,s,o)))}update(t){if(!this.active)return;let i;switch(this.pivot){case"eye":i=this.currentCamera.center;break;case"center":this.currentCamera.center=this.pivotPos,i=this.currentCamera.eye}this.applyRotation(this.currentCamera,t,i,this.pivotPos),R(this.view,this.currentCamera,this.constraintOptions)}end(){this.active&&this.finishController()}applyRotation(t,i,s,e){this.view.renderCoordsHelper.worldUpAtPosition(e,this.tmpWorldUp),x(t,i,this.tmpRotCurPoint);let n=(this.lastPoint[1]-this.tmpRotCurPoint[1])*this.rotScale,a=(this.tmpRotCurPoint[0]-this.lastPoint[0])*this.rotScale;h(this.tmpViewDir,s,e);const p=c(this.tmpViewDir),m=o(u(this.tmpViewDir,this.tmpWorldUp)/p);if("eye"===this.pivot){n*=-.5;const t=.5*Math.PI-m,i=.5*Math.PI*.99;n=t-Math.max(-i,Math.min(i,t+n))}n=r(n+m,b.min,b.max)-m,w(this.tmpTransf),f(this.tmpAxis,t.up,this.tmpViewDir),"center"===this.pivot&&(a=-a),C(this.tmpTransf,this.tmpTransf,a,this.tmpWorldUp),C(this.tmpTransf,this.tmpTransf,n,this.tmpAxis),P(this.tmpViewDir,this.tmpViewDir,this.tmpTransf),l(s,e,this.tmpViewDir),P(t.up,t.up,this.tmpTransf),y(this.lastPoint,this.tmpRotCurPoint),t.markViewDirty()}};t([s({constructOnly:!0})],V.prototype,"view",void 0),t([s()],V.prototype,"pivot",void 0),V=t([e("esri.views.3d.state.controllers.RotateController")],V);export{V as RotateController};
