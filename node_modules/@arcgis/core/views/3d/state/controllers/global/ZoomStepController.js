/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../../chunks/tslib.es6.js";import i from"../../../../../core/has.js";import"../../../../../core/Logger.js";import"../../../../../core/accessorSupport/ensureType.js";import"../../../../../core/accessorSupport/decorators/property.js";import{subclass as e}from"../../../../../core/accessorSupport/decorators/subclass.js";import"../../../../../core/urlUtils.js";import"../../../../../core/uuid.js";import"../../../../../portal/support/resourceExtension.js";import{c as r}from"../../../../../chunks/vec3f64.js";import{g as s,l as o,f as a,a as n,b as m,h as c,n as p}from"../../../../../chunks/vec3.js";import{getReferenceEllipsoid as h}from"../../../../../geometry/projectionEllipsoid.js";import{sphere as l,ray as u}from"../../../support/geometryUtils.js";import{Intersector as d}from"../../../webgl-engine/lib/Intersector.js";import{applySurfaceCollisionConstraint as y}from"../../../camera/constraintUtils/surfaceCollision.js";import{outExpo as f}from"../../../../animation/easing.js";import{applyAll as g}from"../../../camera/constraintUtils.js";import w from"../../../webgl-engine/lib/Camera.js";import{PointToPointAnimationController as j}from"../PointToPointAnimationController.js";import{decideNavigationMode as C,NavigationMode as D,panToPosition as v}from"../../utils/navigationUtils.js";let R=class extends j{constructor(){super(...arguments),this.zoomLocation=r(),this.tmpCamera=new w,this.tmpViewDir=r(),this.tmpRayDir={origin:r(),direction:r()},this.targetOnSphere=r(),this.tmpCenter=r(),this.constraintOptions={selection:7,interactionType:1,interactionFactor:null,interactionStartCamera:new w,interactionDirection:null,tiltMode:0},this.sphere=l.create()}initialize(){this.intersector=new d(this.view.state.mode)}zoomStep(t,i){if(!this.active)return;const e=this.view.state,{interactionStartCamera:r}=this.constraintOptions;this.animation.finished?r.copyFrom(e.camera):this.animation.cameraAt(1,r);let o=!1,a=!1;this.intersectionHelper.intersectScreen(i,this.zoomLocation)&&(o=t>0,a=!0),this.tmpCamera.copyFrom(e.camera),o?this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter):this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:s(this.zoomLocation,this.tmpCamera.center),this.updateCamera(this.tmpCamera,t,this.zoomLocation,i,a),this.begin(this.tmpCamera)}animationSettings(){return{apex:null,duration:.6,easing:f}}updateCamera(t,e,r,s,d){const f=h(this.view.spatialReference);if(C(t,s,d,f)===D.Horizontal||i("disable-feature:context-navigation")){let i=Math.pow(.6,e);this.sphere.radius=o(r),a(this.tmpViewDir,t.center,t.eye);const p=o(this.tmpViewDir);let h=p*i;if(i<=1&&h<4&&(h=4,i=h/p),Math.abs(p-h)<1e-6)return;const u=o(t.center);if(this.sphere.radius!==u){const e=this.sphere.radius+i*(u-this.sphere.radius);n(t.center,t.center,e/u)}n(this.tmpViewDir,this.tmpViewDir,-i),m(t.eye,t.center,this.tmpViewDir),g(this.view,t,this.constraintOptions),c(r,t.center)>1e-12&&l.intersectScreen(this.sphere,t,s,this.targetOnSphere)&&v(this.sphere,t,r,this.targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let i=Math.pow(.6,Math.abs(e));const o=e>0?1:-1;let a;u.fromScreenAtEye(t,s,this.tmpRayDir),p(this.tmpRayDir.direction,this.tmpRayDir.direction),this.view.camera.position.hasZ&&(a=Math.abs(this.view.camera.position.z));let c=Math.max(12*a,20);const h=this.view._stage.renderView.getMinimalDepthForArea(s[0],s[1],this.view._stage.getCamera(),60);c=c>h?h:c,n(this.tmpRayDir.direction,this.tmpRayDir.direction,c),m(r,this.tmpRayDir.origin,this.tmpRayDir.direction);let l=c*i;if(e>0&&l<4&&(l=4,i=l/c),Math.abs(c-l)<1e-6)return;n(this.tmpRayDir.direction,this.tmpRayDir.direction,o*(1-i)),m(t.eye,t.eye,this.tmpRayDir.direction),m(t.center,t.center,this.tmpRayDir.direction)}y(this.view,t)}};R=t([e("esri.views.3d.state.controllers.global.ZoomStepController")],R);export{R as ZoomStepController};
