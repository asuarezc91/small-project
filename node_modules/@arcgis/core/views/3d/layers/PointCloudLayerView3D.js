/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import{estimateSize as t,isArrayBuffer as i}from"../../../core/typedArrayUtil.js";import{unwrapOr as r,isSome as s,isNone as o,mapSome as n}from"../../../core/maybe.js";import a from"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as d}from"../../../core/accessorSupport/decorators/property.js";import{subclass as l}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import{all as h,createAbortController as u,resolve as p,eachAlways as c,isAbortError as _,eachAlwaysValues as m,throwIfAborted as g}from"../../../core/promiseUtils.js";import f from"../../../core/Collection.js";import y from"../../../layers/support/CodedValue.js";import b from"../../../layers/support/CodedValueDomain.js";import"../../../layers/support/domains.js";import{unpackFieldNames as w}from"../../../layers/support/fieldUtils.js";import{pt2px as N}from"../../../core/screenUtils.js";import{result as x,forEach as P}from"../../../core/asyncUtils.js";import{d as v}from"../../../chunks/vec3.js";import{getMetersPerVerticalUnitForSR as C}from"../../../core/unitUtils.js";import{containsPoint as S,create as A}from"../../../geometry/support/aaBoundingRect.js";import{projectBoundingRect as I}from"../../../geometry/projection.js";import{getMetersPerUnit as k}from"../../../symbols/support/unitConversionUtils.js";import V from"../../../layers/support/PromiseQueue.js";import{Task as R}from"../../support/Scheduler.js";import{create as L}from"../../../geometry/support/aaBoundingBox.js";import{extractSafeScaleBounds as U,scaleBoundsPredicate as j}from"../../support/layerViewUtils.js";import{makeDehydratedPoint as Q}from"../../../layers/graphics/dehydratedFeatures.js";import{a as O}from"../../../chunks/vec3f32.js";import{plane as F}from"../support/geometryUtils.js";import{projectToBoundingBox as D}from"../support/extentUtils.js";import{LayerView3D as M}from"./LayerView3D.js";import{updatingProgress as W}from"./support/layerViewUpdatingProperties.js";import z from"../../layers/LayerView.js";import{minimumDistancePlane as E}from"../support/orientedBoundingBox.js";import{checkPointCloudLayerValid as H,checkPointCloudLayerCompatibleWithView as B}from"./i3s/I3SUtil.js";import{PointCloudWorkerHandle as G}from"./PointCloudWorkerHandle.js";import{nodeDiff as q,sortFrontToBack as T,splitWorkEntries as $}from"./i3s/LoDUtil.js";import J from"./i3s/PagedNodeIndex.js";import{getSplatSizeAlgorithm as Y,getFixedSizeAlgorithm as K,getRendererInfo as X,getFilterInfo as Z,rendererUsesFixedSizes as ee,getAttributeInfo as te}from"./i3s/PointCloudRendererUtil.js";import{getAttributeValues as ie,readGeometry as re,elevationFromPositions as se}from"./i3s/PointCloudWorkerUtil.js";import{PointGraphic as oe}from"./i3s/PointGraphic.js";import{PointRenderer as ne}from"./i3s/PointRenderer.js";import{PopupSceneLayerView as ae}from"./support/PopupSceneLayerView.js";const de=a.getLogger("esri.views.3d.layers.PointCloudLayerView3D"),le=F.create();let he=class extends(ae(M(z))){constructor(){super(...arguments),this.maximumPointCount=4e6,this.slicePlaneEnabled=!1,this._renderer=null,this._rendererAdded=!1,this._renderedNodes=new Set,this._nodeScales=new Map,this._updateViewNeeded=!0,this._lodFactor=1,this._maxLoggedBoxWarnings=5,this._pageMultiplier=1,this._nodeLoadEpoch=0,this._indexQueue=[],this._workQueue=new Array,this._idleQueue=new V,this._indexPagesLoading=new Map,this._loadingNodes=new Map,this._recalcWork=!0,this._layerIsVisible=!1,this._codedDomainPopulationPromise=null,this._codedDomainPopulationAbortController=null,this._totalWork=0,this._index=null,this._loadingInitNodePage=!1,this._nodeIdArray=[]}get pointScale(){const e=Y(this.layer&&this.layer.renderer);return e&&null!=e.scaleFactor?e.scaleFactor:1}get useRealWorldSymbolSizes(){const e=K(this.layer&&this.layer.renderer);return!(!e||null==e.useRealWorldSymbolSizes)&&e.useRealWorldSymbolSizes}get pointSize(){const e=K(this.layer&&this.layer.renderer);return e&&null!=e.size?e.size:0}get inverseDensity(){return this.layer&&this.layer.renderer?96/this.layer.renderer.pointsPerInch:5}get availableFields(){const e=X(this.layer),t=new Set;e.primaryAttribute&&t.add(e.primaryAttribute.name),e.modulationAttribute&&t.add(e.primaryAttribute.name);const i=Z(this.layer);if(i)for(const e of i)t.add(e.attributeInfo.name);if(this.layer.outFields)for(const e of w(this.layer.fields,this.layer.outFields))t.add(e);return Array.from(t)}get _clippingBox(){if(!this.view||!this.view.clippingArea)return null;const e=L(),t=this.view.renderSpatialReference;return D(this.view.clippingArea,e,t)?e:null}get _elevationOffset(){const e=this.layer&&this.layer.elevationInfo;if(e&&"absolute-height"===e.mode){const t=C(this.layer.spatialReference),i=k(e.unit);return r(e.offset,0)*i/t}return 0}initialize(){const e=this.view.resourceController,t=e.scheduler;this._worker=new G(t),this.addResolvingPromise(this._worker.promise),this._tmpPoint=Q(0,0,0,this.layer.spatialReference),H(this.layer),B(this.layer,this.view),this._indexRequester=e.createStreamDataRequester(2),this._dataRequester=e.createStreamDataRequester(3),this._initRenderer();const i=this._initNodePages(),r=this.view.resourceController.memoryController;this._memCache=r.getMemCache(this.layer.uid),this.updatingHandles.add(this,"_clippingBox",(()=>this._setUpdateViewNeeded()),2),this.updatingHandles.add(this,"_elevationOffset",(()=>this._elevationOffsetChanged()),2),this.updatingHandles.add(this.layer,"renderer",(()=>this._rendererChanged()),2),this.updatingHandles.add(this.layer,"filters",(()=>this._reload()),2),this.updatingHandles.add(this.layer,"outFields",(()=>this._reload()),2),this.updatingHandles.add(this.layer,"scaleRangeId",(()=>this._setUpdateViewNeeded())),this.updatingHandles.add(this,"clippingArea",(()=>this._setUpdateViewNeeded()),2),this.updatingHandles.add(this.view.state,"camera",(()=>this._setUpdateViewNeeded())),this.handles.add([this.view.basemapTerrain.on("scale-change",(e=>this._scaleUpdateHandler(e))),r.events.on("quality-changed",(()=>this._setUpdateViewNeeded()))]),this.addResolvingPromise(i),this.when((()=>{this.handles.add([t.registerTask(R.POINT_CLOUD_LAYER,(e=>this._process(e)),(()=>this._needsUpdate())),t.registerIdleStateCallbacks((()=>this._idleBegin()),(()=>this._idleEnd())),this.updatingHandles.add(this,"suspended",(e=>{e?this._clearNodeState():this._setUpdateViewNeeded()}),2)])}),(()=>{this.updatingHandles.removeAll(),this.handles.removeAll()}))}_setUpdateViewNeeded(){this._updateViewNeeded=!0,this._updateLoading()}destroy(){this.cancelLoading(),this._worker&&(this._worker.destroy(),this._worker=null),this._destroyRenderer(),this._memCache.destroy(),this._memCache=null,this._codedDomainPopulationAbortController&&(this._codedDomainPopulationAbortController.abort(),this._codedDomainPopulationAbortController=null),this._codedDomainPopulationPromise=null}_initRenderer(){this._renderer=new ne({createGraphic:(e,t,i)=>this._createGraphic(e,t,i)}),this._renderer.layerUid=this.layer.uid,this.updatingHandles.add(this,"_clippingBox",(e=>this._renderer.clippingBox=e),2),this.updatingHandles.add(this,"suspended",(e=>this._setPointsVisible(!e)),2),this.updatingHandles.add(this,"pointScale",(e=>this._renderer.scaleFactor=e),2),this._renderer.minSizePx=Math.sqrt(2),this.updatingHandles.add(this,"useRealWorldSymbolSizes",(e=>this._renderer.useRealWorldSymbolSizes=e),2),this.updatingHandles.add(this,"pointSize",(e=>{const t=N(e);this._renderer.size=e,this._renderer.sizePx=t}),2),this.updatingHandles.add(this,"slicePlaneEnabled",(e=>this._renderer.slicePlane=e),2),this.updatingHandles.add(this,"inverseDensity",(()=>this._setUpdateViewNeeded()),2),this.updatingHandles.add(this,"maximumPointCount",(()=>this._setUpdateViewNeeded()),2),this.updatingHandles.add(this.view,"qualitySettings.sceneService.pointCloud.lodFactor",(e=>{this._lodFactor=e,this._setUpdateViewNeeded()}),2)}_destroyRenderer(){this._renderer.removeAll(),this._setPointsVisible(!1)}_createGraphic(e,t,i){const r=s(e.pointIdFilterMap)?e.pointIdFilterMap[t]:t,o=this.view.computeMapPointFromVec3d(i),n=this._createGraphicAttributes(e,r);return new oe({pointCloudMetadata:{nodeId:e.id,pointIndexInNode:t,attributePointIndexInNode:r,epoch:this._nodeLoadEpoch},geometry:o,attributes:n,layer:this.layer,sourceLayer:this.layer})}_createGraphicAttributes(e,t){const i={};for(const r of e.attributes)this._encodeGraphicAttribute(r.attributeInfo,r.values,t,i);return i}_encodeGraphicAttribute(e,t,i,r){const s=e.storageInfo&&e.storageInfo.attributeValues,o=s?s.valuesPerElement:1;if(1===o)r[e.name]=t[i];else if("UInt8"===s.valueType&&o<=4){let s=0;const n=i*o;for(let e=n;e<n+o;e++)s=(s<<8)+t[e];r[e.name]=s}else r[e.name]=void 0}_setPointsVisible(e){e&&!this._rendererAdded?(this.view._stage.addRenderPlugin([4],this._renderer),this._rendererAdded=!0):!e&&this._rendererAdded&&(this.view._stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1)}_rendererChanged(){this._renderer.useFixedSizes=ee(this.layer.renderer),this._reload()}_reload(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded()}_elevationOffsetChanged(){this._clearNodeState(),this._memCache.clear(),this._initNodePages()}_scaleUpdateHandler(e){this.layer.minScale||this.layer.maxScale?I(e.extent,e.spatialReference,ue,this.layer.spatialReference)&&(this._nodeScales.forEach(((t,i)=>{if(!this._renderedNodes.has(i))return void this._nodeScales.delete(i);const r=this._index.getNode(i);S(ue,r.obb.center)&&this._nodeScales.set(i,e.scale)})),this._setUpdateViewNeeded()):this._nodeScales.clear()}displayNodes(e){this._workQueue=q([...this._renderedNodes],e,this._index),T(this._workQueue,this.view.state.camera.viewForward,this._index),$(this._workQueue,8,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=e.length>0||this._loadingInitNodePage,this.notifyChange("suspended")}cancelLoading(){this._cancelNodeLoading(),this._cancelIndexLoading()}_cancelNodeLoading(){const e=new Array;this._loadingNodes.forEach((({abortController:t})=>e.push(t))),this._loadingNodes.clear();for(const t of e)t.abort();this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()}_updateQueues(){const e=new Set;this._workQueue.forEach((t=>t.load.forEach((t=>e.add(t)))));const t=new Array,i=new Map;this._loadingNodes.forEach(((r,s)=>{e.has(s)?i.set(s,r):t.push(r)})),this._loadingNodes=i;for(const{abortController:e}of t)e.abort();this._workQueue=this._workQueue.filter((e=>{for(const t of e.load)if(this._loadingNodes.has(t))return this._recalcWork=!0,!1;return!0})),this._totalWork=this._computeWork(),this._updateLoading()}_cancelIndexLoading(){this._indexQueue=[],this._indexPagesLoading.forEach((({abortController:e})=>e.abort())),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()}_clearNodeState(){this._nodeLoadEpoch++,this._renderedNodes.forEach((e=>this._removeFromRenderer(e))),this._cancelNodeLoading()}_idleBegin(){this._setUpdateViewNeeded()}_idleEnd(){this._setUpdateViewNeeded()}_needsUpdate(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.length>0}_process(e){if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;const e=this._isRootNodeVisible();e!==this._layerIsVisible&&(this._layerIsVisible=e,this.notifyChange("suspended")),this._updateLoading()}}else{for(e.run((()=>this._updateWorkQueues()));this._indexQueue.length>0&&e.run((()=>this._processIndexQueue())););for(this._processWorkQueue(e);this._idleQueue.length>0&&e.run((()=>this._idleQueue.process())););}}_processIndexQueue(){const e=this._indexQueue.shift(),t=this._loadNodePage(e);return this._indexPagesLoading.set(e,t),t.promise.then((t=>{this._index.addPage(e,t,this._elevationOffset),this._setUpdateViewNeeded()})).then((()=>{this._indexPagesLoading.delete(e)}),(()=>{this._indexPagesLoading.delete(e)})),!0}_processWorkQueue(e){for(;!e.done;){const t=this._scheduleWorkEntry();if(o(t))return;this._processWorkEntry(t),e.madeProgress()}}_scheduleWorkEntry(){let e=this._workQueue.length;for(;e--;){const e=this._workQueue.shift();if(!e.remove.find((e=>!this._renderedNodes.has(e))))return e;this._workQueue.push(e)}return null}_processWorkEntry(e){if(0!==e.load.length)h(e.load.map((e=>{const t=u(),i=this._memCache.pop(e.toString());return s(i)?this._loadingNodes.set(e,{abortController:t,promise:p(i)}):this._loadingNodes.has(e)||this._loadingNodes.set(e,{abortController:t,promise:this.loadNode(e,t.signal)}),this._loadingNodes.get(e).promise}))).then((t=>{for(let i=0;i<e.load.length;i++)if(t[i]){const r=this._setupRendererData(e.load[i],t[i]);this._addToRenderer(r)}for(const t of e.remove)this._removeFromRenderer(t)})).catch((()=>{})).then((()=>{for(const t of e.load)this._loadingNodes.delete(t);this._updateLoading(),this._recalcWork&&0===this._idleQueue.length&&0===this._indexQueue.length&&0===this._loadingNodes.size&&(this._recalcWork=!1,this._setUpdateViewNeeded())})),this._updateLoading();else for(const t of e.remove)this._removeFromRenderer(t)}async populateClassCodeCodedDomain(e,t){const i="CLASS_CODE",r=this.layer.fieldsIndex.get(i);if(!r||r.domain)return;if(-1===e.indexOf(r.name))return;const s=await x(this.layer.queryCachedStatistics(i,{signal:t}));if(!1===s.ok)return;const o=s.value,n=o&&o.labels&&o.labels.labels;n&&Array.isArray(n)&&(r.domain=new b({name:"CLASS_CODE",codedValues:n.map((e=>new y({code:e.value,name:e.label})))}))}async prepareFetchPopupFeatures(e){return this._codedDomainPopulationPromise||(this._codedDomainPopulationAbortController=u(),this._codedDomainPopulationPromise=this.populateClassCodeCodedDomain(e,this._codedDomainPopulationAbortController.signal).then((()=>{this._codedDomainPopulationAbortController=null}))),this._codedDomainPopulationPromise}async whenGraphicAttributes(e,t){const i=this._splitGraphicsPerNode(e),r=this.layer.attributeStorageInfo,s=t.map((e=>te(r,e))),o=async(e,t)=>{const i=this._index.getNode(t);await P(s,(async t=>{const r=t.useElevation?await this._loadElevationAttributeFromGeometry(i.resourceId):await this._loadAndParseAttribute(i,t);if(r)for(const i of e)if(this._isValidPointGraphic(i)){const e=i.pointCloudMetadata.attributePointIndexInNode;this._encodeGraphicAttribute(t,r,e,i.attributes)}}))},n=[];return i.forEach(((e,t)=>{n.push(o(e,t))})),await c(n),e}_isValidPointGraphic(e){return e instanceof oe&&e.pointCloudMetadata&&e.pointCloudMetadata.epoch===this._nodeLoadEpoch}_splitGraphicsPerNode(e){const t=new Map;for(const i of e){if(!this._isValidPointGraphic(i))continue;const e=i.pointCloudMetadata,r=t.get(e.nodeId);r?r.push(i):t.set(e.nodeId,[i])}return t}async _loadAndParseAttribute(e,t){const i=await this._loadAttribute(e.resourceId,t,null);return s(i)?ie({attributeInfo:t,buffer:i},null,e.vertexCount):null}async _loadElevationAttributeFromGeometry(e){const t=this.layer.store.defaultGeometrySchema,i=re(t,await this._loadGeometry(e,null));return se(i,i.length/3)}highlight(e){if(!e)return{remove(){}};const t=f.isCollection(e)?e.toArray():Array.isArray(e)?e:[e];return this._renderer.highlight(t.map((e=>this._graphicToPointDefinition(e))))}_graphicToPointDefinition(e){if(!this._isValidPointGraphic(e))return null;const{nodeId:t,pointIndexInNode:i}=e.pointCloudMetadata;return null!=t&&null!=i?{nodeId:t,pointId:i}:null}_computeWork(){let e=0;for(const t of this._workQueue)e+=t.load.length+t.remove.length;return e+=this._loadingNodes.size,e+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,e+=this._loadingInitNodePage?100:0,e+=this._updateViewNeeded?100:0,e}get updatingProgressValue(){if(this.suspended)return this._updateViewNeeded?0:1;const e=this._computeWork();return 1-Math.min(this._totalWork,e)/this._totalWork}_updateLoading(){this.notifyChange("updating"),this.notifyChange("updatingProgressValue")}canResume(){return super.canResume()&&this._layerIsVisible}isUpdating(){return this.suspended?this._updateViewNeeded:this._computeWork()>0}_initNodePages(){const e=this.layer.store.index,t=e.nodesPerPage||e.nodePerIndexBlock;return this._index=new J(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,t),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=null!=e.nodesPerPage?1:e.nodePerIndexBlock,this._loadNodePage(0).promise.then((e=>{this._index.addPage(0,e,this._elevationOffset),this._loadingInitNodePage=!1,this._setUpdateViewNeeded()}))}_loadNodePage(e){const t=u(),i=`${this.baseUrl}/nodepages/${e*this._pageMultiplier}`;return{promise:this._requestNodePage(i,t.signal).then((t=>t.nodes.map(((t,i)=>({resourceId:null!=t.resourceId?t.resourceId:e*this._index.pageSize+i,obb:t.obb,firstChild:t.firstChild,childCount:t.childCount,vertexCount:null!=t.vertexCount?t.vertexCount:t.pointCount,lodThreshold:null!=t.lodThreshold?t.lodThreshold:t.effectiveArea}))))),abortController:t}}_updateWorkQueues(){if(!this._updateViewNeeded)return!1;let e=this.inverseDensity/this._lodFactor*this._getLodMemoryFactor();const t=this.maximumPointCount*this._lodFactor*this._getLodMemoryFactor();let i=this._computeNodesForMinimumDensity(e),r=this._computePointCount(i),s=Math.sqrt(r/(.75*t));for(;r>t;)e*=s,i=this._computeNodesForMinimumDensity(e),r=this._computePointCount(i),s=Math.sqrt(2);return this.displayNodes(i),this._updateViewNeeded=!1,this._updateLoading(),!0}_computePointCount(e){let t=0;for(let i=0;i<e.length;i++){const r=this._index.getNode(e[i]);r&&(t+=r.vertexCount)}return t}_getLodMemoryFactor(){return this.view.resourceController.memoryController.memoryFactor}_isRootNodeVisible(){let e=!1;return this._traverseVisible({frustumPlanes:this.view.state.camera.frustum.planes,clippingBox:this._clippingBox},{predicate:(t,i,r)=>(e=r,!1),pageMiss:()=>{}}),e}_computeNodesForMinimumDensity(e){const t=this.view.state.camera,i=t.frustum,r=this._clippingBox,s=t.viewForward,o=v(s,t.eye),n=F.fromNormalAndOffset(s,-o,le),a=t.perScreenPixelRatio/2,d=e*e,l=this._nodeIdArray;l.length=0;const{minScale:h,maxScale:u}=U(this.layer),p=0===h&&0===u?e=>l.push(e):e=>{const t=this._getScale(e);j(t,h,u)&&l.push(e)};return this._traverseVisible({frustumPlanes:i.planes,clippingBox:r},{predicate:(e,t,i)=>{if(!i)return!1;if(0===t.childCount)return p(e),!1;const r=this._index.getRenderObb(e);return!(this._computeAveragePixelArea(r,t.lodThreshold,t.vertexCount,n,a)<=d)||(p(e),!1)},pageMiss:(e,t)=>{p(e),this._indexQueue.indexOf(t)<0&&this._indexQueue.push(t)}}),l}_getScale(e){let t=this._nodeScales.get(e);if(null==t){const i=this._index.getNode(e).obb.center;this._tmpPoint.x=i[0],this._tmpPoint.y=i[1],this._tmpPoint.z=i[2],t=this.view.basemapTerrain.getScale(this._tmpPoint),this._nodeScales.set(e,t)}return t}_computeAveragePixelArea(e,t,i,r,s){const o=Math.max(1e-7,E(e,r));return t/(o*o)/(4*s*s)/i}loadNode(e,t){try{return this.loadNodeAsync(e,t)}catch(e){throw _(e)||de.error(e),e}}async loadAdditionalUserAttributes(e,t,i){const r=this.layer.outFields;if(!r)return[];const o=w(this.layer.fields,r),a=new Set(e.map((e=>s(e)?e.name:null))),d=this.layer.attributeStorageInfo,l=[];for(const e of o){if(a.has(e))continue;const i=te(d,e);i&&l.push(t(i))}const h=await m(l);return g(i),n(h,(e=>e))}async loadNodeAsync(e,t){const i=this._index.getNode(e),r=X(this.layer),n=Z(this.layer),a=i.resourceId,d=async e=>{if(o(e))return null;if(e.useElevation)return{attributeInfo:e,buffer:null};const i=await this._loadAttribute(a,e,t);return s(i)?{attributeInfo:e,buffer:i}:null};return this._idleQueue.push((async()=>{const i=this._loadGeometry(a,t),{primaryAttribute:s,modulationAttribute:o}=r,l=d(s),u=d(o),p=n.map((e=>e.attributeInfo)),c=p.map((e=>d(e))),_=this.loadAdditionalUserAttributes([s,o,...p],d,t),[m,f,y,b,w]=await h([i,l,u,h(c),_]);g(t);const N={geometryBuffer:m,primaryAttributeData:f,modulationAttributeData:y,filterAttributesData:b,userAttributesData:w,schema:this.layer.store.defaultGeometrySchema,rendererInfo:r,filterInfo:n,obb:this._index.getRenderObb(e),elevationOffset:this._elevationOffset,inSR:this.layer.spatialReference.toJSON(),outSR:this.view.renderCoordsHelper.spatialReference.toJSON()};return this._worker.invoke(N,t)}),t)}async _loadGeometry(e,t){return this._requestData(`${this.baseUrl}/nodes/${e}/geometries/0`,t)}async _loadAttribute(e,t,i){if(o(t)||!t.storageInfo)return null;const r=t.storageInfo.key;return this._requestData(`${this.baseUrl}/nodes/${e}/attributes/${r}`,i)}_requestNodePage(e,t){return this._indexRequester.request(e,"json",{query:{f:"json"},signal:t})}_requestData(e,t){return this._dataRequester.request(e,"binary",{signal:t})}_removeFromRenderer(e){if(this._renderedNodes.has(e)){const t=this._renderer.removeNode(e);this._renderedNodes.delete(e),this._nodeScales.delete(e),this._memCache.put(t.id.toString(),t,function(e){return 5*e.coordinates.length+128}(t))}}_addToRenderer(e){this._renderedNodes.has(e.id)||(this._renderedNodes.add(e.id),this._renderer.addNode(e))}_setupRendererData(e,t){const i=this._index.getNode(e),r=Math.sqrt(i.lodThreshold/i.vertexCount),s=this._index.getRenderObb(e);if(ne.isInstanceOfNode(t))return t.splatSize=r,t.obb=s,t.origin=O(t.obb.center),t;const o=1.001;if(t.obb.halfSize[0]>s.halfSize[0]*o||t.obb.halfSize[1]>s.halfSize[1]*o||t.obb.halfSize[2]>s.halfSize[2]*o){if(this._maxLoggedBoxWarnings>0){const i=e=>`[${e.halfSize[0]}, ${e.halfSize[1]}, ${e.halfSize[2]}]`;de.warn(`Node ${e} reported bounding box too small. got ${i(s)} but points cover ${i(t.obb)}`),0==--this._maxLoggedBoxWarnings&&de.warn("  Too many bounding box errors, stopping reporting for this layer.")}this._index.setRenderObb(e,t.obb)}return{id:e,coordinates:t.points,origin:O(s.center),rgb:t.rgb,attributes:t.attributes,pointIdFilterMap:t.pointIdFilterMap,highlights:null,splatSize:r,obb:s,isLeaf:0===i.childCount}}getUsedMemory(){let e=0;return this._renderer.forEachNode((r=>{e+=pe,e+=t(r.coordinates);for(const s of r.attributes){const r=s.values;i(r.buffer)&&(e+=t(r))}})),e}getUnloadedMemory(){const e=this._renderedNodes.size;if(e<4)return 0;const t=[...this._renderedNodes].reduce(((e,t)=>e+this._index.getNode(t).vertexCount));let i=this._loadingNodes.size;for(let e=0;e<this._workQueue.length;e++)i+=this._workQueue[e].load.length,i-=this._workQueue[e].remove.length;if(i<0)return 0;return i*t/e*((this.getUsedMemory()-e*pe)/t)+i*pe}ignoresMemoryFactor(){return!1}get performanceInfo(){return{nodes:this._renderedNodes.size,displayedNumberOfFeatures:[...this._renderedNodes].reduce(((e,t)=>e+this._index.getNode(t).vertexCount),0),maximumNumberOfFeatures:this.maximumPointCount,totalNumberOfFeatures:-1,core:null,"Loading Nodes":this._loadingNodes.size,"Index Queue":this._indexQueue.length,"Work Queue":this._workQueue.length,"Idle Queue":this._idleQueue.length}}get test(){return{index:this._index,visibleNodes:this._renderedNodes}}};e([d()],he.prototype,"layer",void 0),e([d({readOnly:!0,aliasOf:"layer.parsedUrl.path"})],he.prototype,"baseUrl",void 0),e([d({readOnly:!0,dependsOn:["layer.renderer"]})],he.prototype,"pointScale",null),e([d({readOnly:!0,dependsOn:["layer.renderer"]})],he.prototype,"useRealWorldSymbolSizes",null),e([d({readOnly:!0,dependsOn:["layer.renderer"]})],he.prototype,"pointSize",null),e([d({readOnly:!0,dependsOn:["layer.renderer"]})],he.prototype,"inverseDensity",null),e([d()],he.prototype,"maximumPointCount",void 0),e([d({readOnly:!0,dependsOn:["layer.renderer","layer.filters","layer.outFields"]})],he.prototype,"availableFields",null),e([d({readOnly:!0,dependsOn:["view.clippingArea"]})],he.prototype,"_clippingBox",null),e([d({readOnly:!0,dependsOn:["layer.elevationInfo"]})],he.prototype,"_elevationOffset",null),e([d({type:Boolean})],he.prototype,"slicePlaneEnabled",void 0),e([d()],he.prototype,"updating",void 0),e([d(W)],he.prototype,"updatingProgress",void 0),e([d({readOnly:!0,dependsOn:["suspended"]})],he.prototype,"updatingProgressValue",null),he=e([l("esri.views.3d.layers.PointCloudLayerView3D")],he);const ue=A(),pe=160;var ce=he;export default ce;
