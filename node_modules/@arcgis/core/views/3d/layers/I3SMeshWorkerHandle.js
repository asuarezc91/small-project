/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import e from"../../../core/Logger.js";import t from"../../../core/PooledArray.js";import{canProjectWithoutEngine as o,projectVectorToVector as r}from"../../../geometry/projection.js";import{WorkerHandle as s}from"../support/WorkerHandle.js";const n=e.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle");class i extends s{constructor(e){super("SceneLayerWorker","process",e,{hasInitialize:!0})}getTransferList(e){return[e.geometryBuffer]}setModifications(e,t,o){const r={context:e,modifications:f(t,o),isGeodetic:o.isGeographic};this.broadcast(r,"setModifications")}setLegacySchema(e,t){const o=JSON.stringify(t);this.broadcast({context:e,jsonSchema:o},"setLegacySchema")}destroyContext(e){return this.broadcast(e,"destroyContext")}}const c=new t({deallocator:null}),a=[0,0,0];function f(e,t){c.clear();for(const s of e){const e="clip"===s.type?2:"mask"===s.type?1:0,i=s.geometry;let f=e=>e;if(i.spatialReference){if(!o(i.spatialReference,t)){n.warn("Can't project modification polygon into layer spatial reference, ignoring modification");continue}f=e=>(r(e,i.spatialReference,a,t),a)}else i.hasZ||(a[2]=0,f=e=>(a[0]=e[0],a[1]=e[1],a));c.push(e),c.push(i.rings.length);for(const e of i.rings){c.push(e.length);for(const t of e){const e=f(t);c.push(e[0]),c.push(e[1]),c.push(e[2])}}}c.push(3);const s=new Float64Array(c.length);for(let e=0;e<c.length;++e)s[e]=c.getItemAt(e);return s}export{i as I3SMeshWorkerHandle,f as toWasmModification};
