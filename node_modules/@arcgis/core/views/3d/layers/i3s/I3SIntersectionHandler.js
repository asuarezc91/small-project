/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as e}from"../../../../core/maybe.js";import{g as t}from"../../../../chunks/vec3.js";import{getVerticalOffsetI3S as i,IntersectorResult as r}from"../../webgl-engine/lib/intersectorUtils.js";import{intersectLine as s}from"../../support/orientedBoundingBox.js";class n{constructor(e){this.type="I3S",this.layerUid=e.layerUid,this.sublayerUid=e.sublayerUid,this.collection=e.collection,this.forEach=e.forEach,this.slicePlane=e.slicePlaneEnabled,this.isGround=e.isGround}intersect(n,o,l,d){const a=n.results,c=2===n.options.store,u=n.ray.direction,b=n.tolerance;let m=e=>e,f=e=>e;const h=i(n.verticalOffset);e(h)&&(m=e=>h.applyToMbs(e),f=e=>h.applyToObb(e)),this.forEach(((i,y)=>{if(e(i.geometryObb)){if(!s(f(i.geometryObb),l,u,b))return}else if(e(i.serviceObbInRenderSR)){if(!s(f(i.serviceObbInRenderSR),l,u,b))return}else if(!function(e,t,i,r=0){const s=e[3]+r,n=t[0]-e[0],o=t[1]-e[1],l=t[2]-e[2],d=i[0],a=i[1],c=i[2],u=d*n+a*o+c*l;return u*u-(d*d+a*a+c*c)*(n*n+o*o+l*l-s*s)>=0}(m(i.renderMbs),l,u,b))return;this.collection.intersect(y,l,d,b,h,((e,s,u,b)=>{if(s>=0){if(null!=o&&!o(l,d,s))return;const m=r=>{r.intersector=this.type,r.target={type:"external",metadata:{layerUid:this.layerUid,sublayerUid:this.sublayerUid,nodeIndex:i.index,componentIndex:e}},r.dist=s,t(r.normal,u),r.triangleNr=b};if(this.isGround&&(null==a.ground.dist||s<a.ground.dist)&&m(a.ground),n.options.isFiltered)return;if((null==a.min.dist||s<a.min.dist)&&m(a.min),(null==a.max.dist||s>a.max.dist)&&m(a.max),c){const e=new r(n.ray);m(e),n.results.all.push(e)}}}))}))}get intersectionHandlerId(){return this.layerUid}}export{n as I3SIntersectionHandler};
