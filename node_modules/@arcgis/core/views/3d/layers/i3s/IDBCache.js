/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as e}from"../../../../core/maybe.js";import t from"../../../../core/Error.js";import{resolve as s,create as r,reject as i,onAbort as o,throwIfAborted as n,all as c}from"../../../../core/promiseUtils.js";class a{constructor(e,t,s=14){this._version=s,this._db=null,this._quotaReductionPromise=null,this._gcCounter=0,this._hit=0,this._miss=0,this._destroyed=!1,this.gcFrequency=50,this.maxByteSize=1073741824,this.quotaReductionFactor=.2,this._dbName=e,this._storeName=t}init(){return s().then((()=>{const e=indexedDB.open(this._dbName,this._version);return e.onupgradeneeded=t=>{const s=e.result,r=e.transaction,i=s.objectStoreNames.contains(this._storeName)?r.objectStore(this._storeName):s.createObjectStore(this._storeName),o=s.objectStoreNames.contains("last_access")?r.objectStore("last_access"):s.createObjectStore("last_access");o.indexNames.contains("date")||o.createIndex("date","date",{unique:!1}),o.indexNames.contains("byteSize")||o.createIndex("byteSize","byteSize",{unique:!1}),t.oldVersion<this._version&&(i.clear(),o.clear())},h(e)})).then((e=>{this._destroyed?e.close():this._db=e}))}destroy(){this._db&&(this._db.close(),this._db=null),this._destroyed=!0}get initialized(){return null!=this._db}getHitRate(){return this._hit/(this._hit+this._miss)}put(e,r){if(null==this._db)return i(new t("indexedb:not-initialized","IndexedDB Cache is not initialized"));return(null!=this._quotaReductionPromise?this._quotaReductionPromise:s()).then((()=>this._put(e,r))).catch((t=>{if(t&&"QuotaExceededError"===t.name)return null==this._quotaReductionPromise&&(this._quotaReductionPromise=this._getCacheSize().then((e=>this._removeLeastRecentlyAccessed(r.byteSize+Math.ceil(e*this.quotaReductionFactor)))),this._quotaReductionPromise.then((()=>this._quotaReductionPromise=null),(()=>this._quotaReductionPromise=null))),this._quotaReductionPromise.then((()=>this._put(e,r)));throw t})).then((()=>{this._gcCounter--,this._gcCounter<0&&null!=this._db&&(this._gcCounter=this.gcFrequency,this._getCacheSize().then((e=>this._removeLeastRecentlyAccessed(e-this.maxByteSize))))}))}get(t,r){if(null==this._db)return s(null);let i=null;return s().then((()=>{const e=this._db.transaction(this._storeName,"readonly");i=o(r,(()=>{e.abort()}));return h(e.objectStore(this._storeName).get(t))})).then((s=>{if(null==s)++this._miss;else if(this._db){++this._hit;this._db.transaction("last_access","readwrite").objectStore("last_access").put({date:Date.now(),byteSize:s.byteSize},t)}return e(i)&&i.remove(),s})).catch((()=>(++this._miss,n(r),e(i)&&i.remove(),null)))}remove(e){return null==this._db?s():s().then((()=>{const t=this._db.transaction([this._storeName,"last_access"],"readwrite"),s=t.objectStore(this._storeName),r=t.objectStore("last_access"),i=s.delete(e),o=r.delete(e);return c([h(i),h(o),u(t)])}))}_put(e,t){const s=this._db.transaction([this._storeName,"last_access"],"readwrite"),r=s.objectStore(this._storeName),i=s.objectStore("last_access"),o=r.put(t,e),n=i.put({date:Date.now(),byteSize:t.byteSize},e);return c([h(o),h(n),u(s)])}_removeLeastRecentlyAccessed(e){if(e<=0)return;const t=this._db.transaction([this._storeName,"last_access"],"readwrite"),s=t.objectStore(this._storeName),r=t.objectStore("last_access");let i=0;const o=r.index("date").openCursor(null,"next");return o.onsuccess=()=>{const t=o.result;null!=t&&(null!=t.value.byteSize&&(i+=t.value.byteSize),s.delete(t.primaryKey),r.delete(t.primaryKey),i<e&&t.continue())},u(t)}_getCacheSize(){const e=this._db.transaction("last_access"),t=e.objectStore("last_access");let s=0;const r=t.index("byteSize").openKeyCursor();return r.onsuccess=()=>{const e=r.result;if(!e)return;const t=e.key;null!=t&&(s+=t),e.continue()},u(e).then((()=>s))}}function u(e){return r(((t,s)=>{e.oncomplete=()=>t(),e.onerror=()=>s(e.error),e.onabort=()=>s(e.error)}))}function h(e){return r(((t,s)=>{"done"===e.readyState?null!=e.error?s(e.error):t(e.result):(e.onsuccess=()=>t(e.result),e.onerror=()=>s(e.error))}))}export{a as IDBCache,h as whenRequest,u as whenTransaction};
