/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import"../../../../core/has.js";import{isNone as t}from"../../../../core/maybe.js";import"../../../../core/Logger.js";import"../../../../core/accessorSupport/ensureType.js";import{property as r}from"../../../../core/accessorSupport/decorators/property.js";import{subclass as s}from"../../../../core/accessorSupport/decorators/subclass.js";import n from"../../../../core/Error.js";import"../../../../core/urlUtils.js";import"../../../../core/uuid.js";import"../../../../portal/support/resourceExtension.js";import o from"../../../../core/Accessor.js";import a from"../../../../geometry/Extent.js";import i from"../../../../core/Handles.js";import u from"../../../../tasks/support/FeatureSet.js";import y from"../../../../tasks/support/Query.js";import c from"../../../../layers/graphics/data/QueryEngine.js";const l=c;let p=class extends o{constructor(e){super(e),this._dataQueryEngineInstance=null,this._handles=new i}get defaultQueryJSON(){return new y({outSpatialReference:this.spatialReference}).toJSON()}get dataQueryEngine(){return this.ensureDataQueryEngine()}initialize(){this._handles.add(this.layerView.on("visible-geometry-changed",(()=>this.spatialIndex.events.emit("changed"))))}destroy(){this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null),this._handles&&(this._handles.destroy(),this._handles=null),this._set("layerView",null)}async executeQueryForCount(e,t){return this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}async executeQueryForExtent(e,t){const{count:r,extent:s}=await this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:r,extent:a.fromJSON(s)}}async executeQueryForIds(e,t){return this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}async executeQuery(e,t){const r=this._ensureQueryJSON(e);if(r.returnGeometry)throw new n("feature-store:unsupported-query","returnGeometry is not yet supported for mesh scene layer queries");if(r.returnCentroid)throw new n("feature-store:unsupported-query","returnCentroid is not yet supported for mesh scene layer queries");const s=await this.dataQueryEngine.executeQuery(r,t),o=u.fromJSON(s);return o.features.forEach((e=>{e.geometry=null})),o}_ensureQueryJSON(e){if(t(e))return this.defaultQueryJSON;const r=e.toJSON();return r.outSpatialReference||(e.outSpatialReference=this.spatialReference),r}ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e=this.layer.objectIdField||"OBJECTID",t=this.layer.fields.map((e=>e.toJSON())),r=this.layerView.view.resourceController.scheduler,s=this.spatialReference.toJSON(),n=this.task,o=this.spatialIndex;return this._dataQueryEngineInstance=new l({hasZ:!0,hasM:!1,geometryType:"esriGeometryPolygon",fields:t,timeInfo:null,spatialReference:s,objectIdField:e,featureStore:o,scheduler:r,task:n}),this._dataQueryEngineInstance}};e([r({constructOnly:!0})],p.prototype,"layerView",void 0),e([r({constructOnly:!0})],p.prototype,"task",void 0),e([r({constructOnly:!0})],p.prototype,"spatialIndex",void 0),e([r({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],p.prototype,"spatialReference",void 0),e([r({readOnly:!0,aliasOf:"layerView.i3slayer"})],p.prototype,"layer",void 0),e([r({readOnly:!0,dependsOn:["spatialReference"]})],p.prototype,"defaultQueryJSON",null),p=e([s("esri.views.3d.layers.i3s.I3SQueryEngine")],p);var d=p;export default d;export{p as I3SQueryEngine};
