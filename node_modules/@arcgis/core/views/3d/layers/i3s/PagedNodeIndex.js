/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{create as e,contains as t,intersects as s}from"../../../../geometry/support/aaBoundingBox.js";import{set as n,toAaBoundingBox as i,intersectPlane as r,ObbArray as o}from"../../support/orientedBoundingBox.js";import{transformObb as p}from"./I3SUtil.js";function h(e,t){return e/t|0}function a(e,t){return e%t}export default class{constructor(e,t,s){this._pages=[],this.pageSize=0,this._nodeSR=null,this._renderSR=null,this._nodeSR=e,this._renderSR=t,this.pageSize=s}addPage(e,t,s=0){for(;this._pages.length<e;)this._pages.push(null);const n=function(e,t,s,n){const i=new o(e.length);for(let r=0;r<e.length;r++)p(e[r].obb,t,i.obbs[r],s,n);return i.obbs}(t,this._nodeSR,this._renderSR,s);this._pages[e]={nodes:t,renderObbs:n,parents:new Uint32Array(this.pageSize)},function(e,t){const s=[0];for(;s.length;){const n=s.pop(),i=e[h(n,t)].nodes[a(n,t)];for(let r=0;r<i.childCount;r++){const o=i.firstChild+r;null!=e[h(o,t)]&&(e[h(o,t)].parents[a(o,t)]=n,s.push(o))}}}(this._pages,this.pageSize)}hasPage(e){return!!this._pages[e]}getNode(e){const t=this.pageSize;return this._pages[h(e,t)].nodes[a(e,t)]}getRenderObb(e){const t=this.pageSize;return this._pages[h(e,t)].renderObbs[a(e,t)]}getRenderCenter(e){return this.getRenderObb(e).center}setRenderObb(e,t){const s=this.pageSize;n(t,this._pages[h(e,s)].renderObbs[a(e,s)])}getParentId(e){const t=this.pageSize;return this._pages[h(e,t)].parents[a(e,t)]}hasNodes(e,t){const s=h(e,this.pageSize),n=h(e+t-1,this.pageSize);for(let e=s;e<=n;e++)if(null==this._pages[e])return!1;return!0}forEachNodeId(e){for(let t=0;t<this._pages.length;t++){const s=this._pages[t];if(s)for(let n=0;n<s.nodes.length;n++)e(t*this.pageSize+n)}}createVisibilityTraverse(){const n={index:this,queue:[],masks:[],tempAabb:e()};return(e,o)=>function(e,n,o){const p=e.index;if(!p.hasNodes(0,1))return;const a=e.queue;a.length=0,a.push(0);const g=e.masks;g.length=0,g.push(0);for(;a.length>0;){const l=a.pop();let u=g.pop();const c=p.getNode(l),d=p.getRenderObb(l);let f=!0;if(null!=n.clippingBox){const r=1<<n.frustumPlanes.length;if(0==(u&r)){const o=i(d,e.tempAabb);t(n.clippingBox,o)?u|=r:s(n.clippingBox,o)||(f=!1)}}for(let e=0;e<n.frustumPlanes.length&&f;e++){const t=1<<e;if(0==(u&t)){const s=r(d,n.frustumPlanes[e]);s>0?f=!1:s<0&&(u|=t)}}if(o.predicate(l,c,f)){const e=c.firstChild,t=c.childCount;let s=!1;const n=h(e,p.pageSize),i=h(e+t-1,p.pageSize);for(let e=n;e<=i;e++)if(!p.hasPage(e)){o.pageMiss(l,e),s=!0;break}if(!s)for(let s=0;s<t;s++)a.push(e+s),g.push(u)}}}(n,e,o)}}
