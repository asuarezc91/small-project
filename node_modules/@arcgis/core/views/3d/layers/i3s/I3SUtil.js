/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import e from"../../../../core/has.js";import{isInt16Array as t,isInt32Array as r}from"../../../../core/typedArrayUtil.js";import{isSome as o,isNone as n}from"../../../../core/maybe.js";import a from"../../../../core/Error.js";import{binaryIndexOf as i,flatten as s,splitIntoChunks as l}from"../../../../core/arrayUtils.js";import{all as c,eachAlways as u}from"../../../../core/promiseUtils.js";import f from"../../../../geometry/SpatialReference.js";import{canProject as p}from"../../../../geometry/support/webMercatorUtils.js";import m from"../../../../request.js";import{s as h,g as d,r as y,q as g,a as b,b as w,i as x}from"../../../../chunks/vec3.js";import{getSphericalPCPF as v,getReferenceEllipsoid as S}from"../../../../geometry/projectionEllipsoid.js";import{a as M}from"../../../../chunks/mat4.js";import{create as j,empty as R,expandPointInPlace as q,intersects as k}from"../../../../geometry/support/aaBoundingRect.js";import{projectBoundingSphere as T,projectBuffer as I,computeLinearTransformation as z,projectVectorToVector as F}from"../../../../geometry/projection.js";import A from"../../../../tasks/support/Query.js";import{a as C}from"../../../../chunks/mat4f64.js";import{a as U}from"../../../../chunks/vec4f64.js";import{a as B,m as K,c as L}from"../../../../chunks/quat.js";import{create as W}from"../../../../geometry/support/aaBoundingBox.js";import{createSolidEdgeMaterial as G,createMaterialFromEdges as O}from"../support/edgeUtils.js";import{parseColorMixMode as E}from"../support/symbolColorUtils.js";import{b as P}from"../../../../chunks/quatf32.js";import{corners as $,compute as Q,create as Z}from"../../support/orientedBoundingBox.js";import{readBinaryAttribute as D}from"./I3SBinaryReader.js";import{computeGlobalTransformation as H}from"./I3SProjectionUtil.js";const J="image/vnd-ms.dds",N=["image/jpeg","image/png"];function V(e){return e&&parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10)}function X(e,t){if(t)for(let t=0;t<e.length;t++)if("image/vnd-ms.dds"===e[t].encoding)return e[t];for(let t=0;t<e.length;t++)if(N.indexOf(e[t].encoding)>-1)return e[t];return null}function Y(t){if(e("disable-feature:i3s-draco")||!t)return!1;for(const e of t)for(const t of e.geometryBuffers)if("draco"===t.compressedAttributes.encoding)return!0;return!1}function _(e,t,r,o,n,a){n.traverse(r,(r=>{let n=r.mbs;t!==o&&(n=ne,T(r.mbs,o,n,t));const i=ae(e,n);return 0!==i&&(a(r,i),!0)}))}function ee(e,t,r){let o=0,n=0;for(let a=0;a<t.length&&o<e.length;a++)e[o]===t[a]&&(r(a)&&(e[n]=e[o],n++),o++);e.length=n}function te(e,t,r){let o=0,n=0;for(;o<r.length;){i(e,r[o])>=0===t&&(r[n]=r[o],n++),o++}r.length=n}const re=W();function oe(e,t){if(0===t.rotationScale[1]&&0===t.rotationScale[2]&&0===t.rotationScale[3]&&0===t.rotationScale[5]&&0===t.rotationScale[6]&&0===t.rotationScale[7])return re[0]=(e[0]-t.position[0])/t.rotationScale[0],re[1]=(e[1]-t.position[1])/t.rotationScale[4],re[2]=(e[2]-t.position[2])/t.rotationScale[8],re[3]=(e[3]-t.position[0])/t.rotationScale[0],re[4]=(e[4]-t.position[1])/t.rotationScale[4],re[5]=(e[5]-t.position[2])/t.rotationScale[8],re}const ne=U();function ae(e,t){const r=t[0],o=t[1],n=t[3],a=e[0]-r,i=r-e[2],s=e[1]-o,l=o-e[3],c=Math.max(a,i,0),u=Math.max(s,l,0),f=c*c+u*u;if(f>n*n)return 0;if(f>0)return 1;return-Math.max(a,i,s,l)>n?3:2}function ie(e,t){const r=t[0],o=t[1],n=t[2],a=t[3],i=e[0]-r,s=r-e[3],l=e[1]-o,c=o-e[4],u=e[2]-n,f=n-e[5],p=Math.max(i,s,0),m=Math.max(l,c,0),h=Math.max(u,f,0),d=p*p+m*m+h*h;if(d>a*a)return 0;if(d>0)return 1;return-Math.max(i,s,l,c,u,f)>a?3:2}function se(e,t,r){const o=[],n=r&&r.missingFields,a=r&&r.originalFields;for(const r of e){const e=r.toLowerCase();let i=!1;for(const n of t)if(e===n.name.toLowerCase()){o.push(n.name),i=!0,a&&a.push(r);break}!i&&n&&n.push(r)}return o}async function le(e,t,r,i,l,f){var p;if(!0===(f&&f.populateObjectId)&&(p=r,i=i.filter((e=>e!==p)).concat([p])),0===t.length)return[];const h=e.attributeStorageInfo;if(o(e.associatedLayer))try{return await async function(e,t,r,o){t.sort(((e,t)=>e.attributes[r]-t.attributes[r]));const n=t.map((e=>e.attributes[r])),a=[],i=se(o,e.fields,{originalFields:a}),s=await ce(e,n,i);for(let e=0;e<t.length;e++){const r=t[e],o=s[e],n={};if(r.attributes)for(const e in r.attributes)n[e]=r.attributes[e];for(let e=0;e<a.length;e++)n[a[e]]=o[i[e]];r.attributes=n}return t}(e.associatedLayer,t,r,i)}catch(t){if(e.associatedLayer.loaded)throw t}if(h){const o=function(e,t,r){const o=new Map,n=[],a=r();for(const r of e){const e=r.attributes[t];for(let t=0;t<a.length;t++){const i=a[t],s=i.featureIds.indexOf(e);if(s>=0){let e=o.get(i.node);e||(e={node:i.node,indices:[],graphics:[]},n.push(e),o.set(i.node,e)),e.indices.push(s),e.graphics.push(r);for(let e=t;e>0;e--)a[e]=a[e-1];a[0]=i;break}}}return n}(t,r,l);if(n(o))throw new a("scenelayer:features-not-loaded","Tried to query attributes for unloaded features");const f=e.parsedUrl.path,p=await c(o.map((e=>function(e,t,r,o,n){const a=[];for(const o of t)if(o&&-1!==n.indexOf(o.name)){const t=`${e}/nodes/${r.resources.attributes}/attributes/${o.key}/0`;a.push({url:t,storageInfo:o})}return u(a.map((e=>m(e.url,{responseType:"array-buffer"}).then((t=>D(e.storageInfo,t.data)))))).then((e=>{const t=[];for(const r of o){const o={};for(let t=0;t<e.length;t++)null!=e[t].value&&(o[a[t].storageInfo.name]=ue(e[t].value,r));t.push(o)}return t}))}(f,h,e.node,e.indices,i).then((t=>{for(let r=0;r<e.graphics.length;r++){const o=e.graphics[r],n=t[r];if(o.attributes)for(const e in o.attributes)e in n||(n[e]=o.attributes[e]);o.attributes=n}return e.graphics})))));return s(p)}throw new a("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function ce(e,t,r){const o=e.capabilities.query.maxRecordCount;if(null!=o&&t.length>o){const n=l(t,o);return c(n.map((t=>ce(e,t,r)))).then(s)}const n=new A({objectIds:t,outFields:r,orderByFields:[e.objectIdField]});return e.queryFeatures(n).then((e=>{if(e&&e.features&&e.features.length===t.length)return e.features.map((e=>e.attributes));throw new a("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")}))}function ue(e,o){if(!e)return null;const n=e[o];if(t(e))return-32768===n?null:n;if(r(e))return-2147483648===n?null:n;return n!=n?null:n}function fe(e){const t=e.store.indexCRS||e.store.geographicCRS,r=void 0===t?e.store.indexWKT:void 0;if(r){if(!e.spatialReference)throw new a("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indeWKT in the scene layer store but no layer spatial reference",{});if(r!==e.spatialReference.wkt)throw new a("layerview:store-spatial-reference-wkt-index-incompatible","The indeWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const o=t?new f(V(t)):e.spatialReference;return o.equals(e.spatialReference)?e.spatialReference:o}function pe(e){const t=e.store.vertexCRS||e.store.projectedCRS,r=void 0===t?e.store.vertexWKT:void 0;if(r){if(!e.spatialReference)throw new a("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(r!==e.spatialReference.wkt)throw new a("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const o=t?new f(V(t)):e.spatialReference;return o.equals(e.spatialReference)?e.spatialReference:o}function me(e,t){return n(t)?"@null":t===v(t)?"@ECEF":e.equals(t)?"":null!=t.wkid?"@"+t.wkid:null}function he(e,t,r){if(!p(e,t))throw new a("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===r&&e.isGeographic)throw new a("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",{})}function de(e,t,r){const o=fe(e),n=pe(e);he(o,t,r),he(n,t,r)}function ye(e){if(null==e.store||null==e.store.defaultGeometrySchema||(null!=(t=e.store.defaultGeometrySchema).geometryType&&"triangles"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null==t.vertexAttributes||null==t.vertexAttributes.position))throw new a("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path});var t}function ge(e,t){de(e,t.spatialReference,t.viewingMode)}function be(e){if(null==e.store||null==e.store.defaultGeometrySchema||(null==(t=e.store.defaultGeometrySchema).geometryType||"points"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null!=t.encoding&&""!==t.encoding&&"lepcc-xyz"!==t.encoding||null==t.vertexAttributes||null==t.vertexAttributes.position))throw new a("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});var t}function we(e,t){he(e.spatialReference,t.spatialReference,t.viewingMode)}function xe(e){return"mesh-3d"===e.type}function ve(e){if(null==e||!function(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;const t=e.getSymbols();if(0===t.length)return!0;for(const e of t){if(!xe(e)||0===e.symbolLayers.length)return!0;for(const t of e.symbolLayers.items)if("fill"!==t.type||n(t.material)||n(t.material.color)||"replace"!==t.material.colorMixMode)return!0}return!1}const Se=G({color:[0,0,0,0],opacity:0});class Me{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function je(e){const t=new Me;let r=!1,n=!1;for(const a of e.symbolLayers.items)if("fill"===a.type&&a.enabled){const e=a.material,i=a.edges;if(o(e)&&!r){const n=e.color,i=E(e.colorMixMode);o(n)?t.material={color:[n.r/255,n.g/255,n.b/255],alpha:n.a,colorMixMode:i}:t.material={color:[1,1,1],alpha:1,colorMixMode:1},t.castShadows=a.castShadows,r=!0}o(i)&&!n&&(t.edgeMaterial=O(i,{}),n=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:1}),t}function Re(e,t){return(0|e)+(0|t)|0}function qe(e,t,r,o,n=0){o===v(o)?t.isGeographic?function(e,t,r,o){const n=S(r),a=1+Math.max(0,o)/(n.radius+e.center[2]);h(t.center,e.center[0],e.center[1],e.center[2]+o),I(t.center,r,0,t.center,v(r),0,1),B(t.quaternion,e.quaternion),L(Ie,e.quaternion),h(Ue,0,0,1),g(Ue,Ue,Ie),h(Ue,e.halfSize[0]*Math.abs(Ue[0]),e.halfSize[1]*Math.abs(Ue[1]),e.halfSize[2]*Math.abs(Ue[2])),b(Ue,Ue,n.inverseFlattening),w(t.halfSize,e.halfSize,Ue),b(t.halfSize,t.halfSize,a)}(e,r,t,n):function(e,t,r,o){$(e,ze),h(t.center,e.center[0],e.center[1],e.center[2]+o),z(r,t.center,Te,v(r)),h(t.center,Te[12],Te[13],Te[14]);const n=2*Math.sqrt(1+Te[0]+Te[5]+Te[10]);Ie[0]=(Te[6]-Te[9])/n,Ie[1]=(Te[8]-Te[2])/n,Ie[2]=(Te[1]-Te[4])/n,Ie[3]=.25*n,K(t.quaternion,Ie,e.quaternion),L(Ie,t.quaternion);let a=0,i=0,s=0;for(const e of ze)e[2]+=o,I(e,r,0,e,v(r),0,1),y(Ue,e,t.center),g(Ue,Ue,Ie),a=Math.max(a,Math.abs(Ue[0])),i=Math.max(i,Math.abs(Ue[1])),s=Math.max(s,Math.abs(Ue[2]));h(t.halfSize,a,i,s)}(e,r,t,n):e===r?(r.center[2]+=n,I(r.center,t,0,r.center,o,0,1)):(h(r.center,e.center[0],e.center[1],e.center[2]+n),I(r.center,t,0,r.center,o,0,1),B(r.quaternion,e.quaternion),d(r.halfSize,e.halfSize))}function ke(e,t,r,a,i,s){if(!s||0===s.length||n(t))return null;const l=H(e.mbs,i,r,t);let c;M(Ke,l);let u=1/0,f=-1/0;const p=n=>{if("replace"!==n.type)return;const s=n.geometry;if(!s.hasZ)return;R(Fe);const l=s.spatialReference||a,p=s.rings.reduce(((e,r)=>r.reduce(((e,r)=>(F(r,l,Ue,t),x(Ue,Ue,Ke),q(Fe,Ue),Math.min(Ue[2],e))),e)),1/0);(()=>{if(!c)if(c=ze,R(Ae),o(e.serviceObb)){qe(e.serviceObb,r,Ce,t,i),$(Ce,c);for(const e of c)x(e,e,Ke),q(Ae,e)}else{const o=e.mbs,n=o[3];F(o,r,Ue,t),x(Ue,Ue,Ke),Ue[2]+=i;for(let e=0;e<8;++e){const t=1&e?n:-n,r=2&e?n:-n,o=4&e?n:-n,a=c[e];d(a,[Ue[0]+t,Ue[1]+r,Ue[2]+o]),q(Ae,a)}}})(),k(Ae,Fe)&&(u=Math.min(u,p),f=Math.max(f,p))};if(s.forEach((e=>p(e))),u===1/0)return null;for(let e=0;e<8;++e)m=Be.data,h=3*e,y=c[e],x(Ue,y,l),m[h+0]=Ue[0],m[h+1]=Ue[1],m[h+2]=Ue[2],h+=24,y[2]=u,x(Ue,y,l),m[h+0]=Ue[0],m[h+1]=Ue[1],m[h+2]=Ue[2],h+=24,y[2]=f,x(Ue,y,l),m[h+0]=Ue[0],m[h+1]=Ue[1],m[h+2]=Ue[2];var m,h,y;return Q(Be)}const Te=C(),Ie=P(),ze=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],Fe=j(),Ae=j(),Ce=Z(),Ue=[0,0,0],Be={data:new Array(72),size:3,offsetIdx:0,strideIdx:3},Ke=C();export{N as BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS,J as DDS_ENCODING_STRING,Me as SymbolInfo,Re as addWraparound,we as checkPointCloudLayerCompatibleWithView,be as checkPointCloudLayerValid,ge as checkSceneLayerCompatibleWithView,ye as checkSceneLayerValid,he as checkSpatialReference,de as checkSpatialReferences,ke as computeVisibilityObb,Y as containsDraco,V as extractWkid,ee as filterInPlace,se as findFieldsCaseInsensitive,_ as findIntersectingNodes,me as getCacheKeySuffix,ue as getCachedAttributeValue,oe as getClipAABB,fe as getIndexCrs,je as getSymbolInfo,pe as getVertexCrs,ie as intersectBoundingBoxWithMbs,ae as intersectBoundingRectWithMbs,te as objectIdFilter,ve as rendererNeedsTextures,X as selectEncoding,qe as transformObb,Se as transparentEdgeMaterial,le as whenGraphicAttributes};
