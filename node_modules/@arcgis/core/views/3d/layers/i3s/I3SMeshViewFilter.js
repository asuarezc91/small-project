/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import"../../../../core/has.js";import{isNone as t,isSome as r}from"../../../../core/maybe.js";import s from"../../../../core/Logger.js";import"../../../../core/accessorSupport/ensureType.js";import{property as o}from"../../../../core/accessorSupport/decorators/property.js";import{subclass as i}from"../../../../core/accessorSupport/decorators/subclass.js";import"../../../../core/urlUtils.js";import"../../../../core/uuid.js";import"../../../../portal/support/resourceExtension.js";import{indexOf as n,PositionHint as a}from"../../../../core/arrayUtils.js";import c from"../../../../core/Accessor.js";import l from"../../../../geometry/SpatialReference.js";import{canProject as p,project as u}from"../../../../geometry/support/webMercatorUtils.js";import"../../../../geometry.js";import{t as d,b as f,s as g}from"../../../../chunks/vec3.js";import{whenOnce as h}from"../../../../core/watchUtils.js";import{getUnitString as m}from"../../../../core/unitUtils.js";import{fromValues as y,expandWithNestedArray as j,expand as b}from"../../../../geometry/support/aaBoundingRect.js";import{load as S,project as R,projectBoundingSphere as w,projectVectorToVector as E}from"../../../../geometry/projection.js";import{WhereClause as F}from"../../../../core/sql/WhereClause.js";import{create as x}from"../../../../geometry/support/aaBoundingBox.js";import I from"../../../layers/support/FeatureFilter.js";import{objectIdFilter as _,filterInPlace as k}from"./I3SUtil.js";const v=s.getLogger("esri.views.3d.layers.i3s.I3SMeshViewFilter");let M,O=class extends c{constructor(e){super(e),this._projectionEngineLoaded=!1}initialize(){h(this,"filter.geometry").then((()=>this.loadAsyncModule(async function(){if(M)return M;return M=await import("../../../../geometry/geometryEngine.js"),M}().then((e=>{this.destroyed||(this._geometryEngine=e,this.applyFilters())})))))}get sortedObjectIds(){if(t(this.filter.objectIds))return null;const e=new Float64Array(this.filter.objectIds);return e.sort(),e}get parsedWhereClause(){const e=r(this.filter)?this.filter.where:null;if(t(e)||!e)return null;try{return F.create(e,this.layerFieldsIndex)}catch(e){v.error(`Failed to parse filter where clause: ${e}`)}return null}addFilters(e,t,s,o){const i=this.sortedObjectIds;r(i)&&e.push((e=>_(i,!0,e))),this.addSqlFilter(e,this.parsedWhereClause);const n=this.parsedGeometry;if(r(n)){const r=this.spatialRelationship;e.push(((e,i)=>function(e,t,r,s,o,i,n){const a=i[0].spatialReference||s.spatialReference;if(!w(t.node.mbs,o,C,a))return void v.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter");const c=function(e,t,r,s,o){const i=t.renderSpatialReference,n=new Map,a={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:r};a.rings[0][3]=a.rings[0][0];const c={indices:null,data:null,stride:0,startIndex:0,endIndex:0};let l,p;switch(e){case"intersects":l=(e,t)=>M.intersects(e,t)?0:2,p=A;break;case"contains":l=(e,t)=>M.contains(e,t)?2:1,p=A;break;case"disjoint":default:l=(e,t)=>M.disjoint(e,t)?2:1,p=B}return{collection:s,object:o,type:e,maskSR:r,renderSR:i,aabbCache:n,triangle:a,positions:c,triangleTest:l,geometryTest:p}}(n,s,a,r,t.objectHandle),l=function(e,t){const r={x:e[0],y:e[1],hasZ:!1,hasM:!1,type:"point",spatialReference:t.maskSR},s=t.maskSR.isWGS84||t.maskSR.isWebMercator?M.geodesicBuffer(r,e[3],1):M.buffer(r,e[3],1);return s.type="polygon",s}(C,c);for(const r of i){if(0===e.length)return;switch(L(r,l,n)){case 1:return void(e.length=0);case 0:continue}k(e,t.featureIds,(e=>T(r,e,c)))}}(e,i,o,t,s,n,r)))}}get parsedGeometry(){if(t(this.filter))return null;if(!this._geometryEngine)return null;const{geometry:e}=this.filter;if(t(e))return null;const{distance:r,units:s}=this.filter,o=this.spatialRelationship,i="mesh"===e.type?e.extent:e;if(t(r)||0===r)return G(i,o);const n=s||m(i.spatialReference);if(i.spatialReference.isWGS84){return G(this._geometryEngine.geodesicBuffer(i,r,n),o)}if(p(i,l.WGS84)){return G(u(this._geometryEngine.geodesicBuffer(u(i,l.WGS84),r,n),i.spatialReference),o)}if(!this._projectionEngineLoaded&&(this.loadAsyncModule(S().then((()=>this._projectionEngineLoaded=!0))),!this._projectionEngineLoaded))return null;let a=null;try{a=R(i,l.WGS84)}catch(e){}if(a)try{a=R(this._geometryEngine.geodesicBuffer(a,r,n),i.spatialReference)}catch(e){a=null}return a||v.error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${i.spatialReference.wkid}) to WGS84.`),G(a,o)}get spatialRelationship(){return r(this.filter)?this.filter.spatialRelationship:"intersects"}static checkSupport(e){return e.timeExtent?(v.warn("Filters with a timeExtent are not supported for mesh scene layers"),!1):null!=(t=e.spatialRelationship)&&W.indexOf(t)>=0||(v.warn(`Filters with spatialRelationship other than ${W.join(", ")} are not supported for mesh scene layers`),!1);var t}};e([o({type:I})],O.prototype,"filter",void 0),e([o()],O.prototype,"layerFieldsIndex",void 0),e([o()],O.prototype,"loadAsyncModule",void 0),e([o()],O.prototype,"applyFilters",void 0),e([o()],O.prototype,"addSqlFilter",void 0),e([o({readOnly:!0})],O.prototype,"sortedObjectIds",null),e([o({readOnly:!0})],O.prototype,"parsedWhereClause",null),e([o({readOnly:!0})],O.prototype,"parsedGeometry",null),e([o({readOnly:!0})],O.prototype,"spatialRelationship",null),e([o({})],O.prototype,"_projectionEngineLoaded",void 0),e([o({})],O.prototype,"_geometryEngine",void 0),O=e([i("esri.views.3d.layers.i3s.I3SMeshViewFilter")],O);const W=["contains","intersects","disjoint"];function G(e,t){if(!e)return null;if("disjoint"===t&&"polygon"===e.type){const t=new Array(e.rings.length);for(let r=0;r<e.rings.length;++r){const s=y(1/0,1/0,-1/0,-1/0);j(s,e.rings[r]),t[r]={type:"polygon",rings:[e.rings[r]],spatialReference:e.spatialReference,aabr:s}}t.sort(((e,t)=>e.aabr[0]-t.aabr[0]));const r=new Set,s=new a;for(let e=0;e<t.length;++e){const o=t[e];for(let s=e+1;s<t.length;++s){const e=t[s];if(e.aabr[0]>=o.aabr[2])break;r.add(e)}r.forEach((e=>{if(o!==e)if(e.aabr[2]<=o.aabr[0])r.delete(e);else if(M.intersects(o,e)){o.rings=o.rings.concat(e.rings),b(o.aabr,e.aabr),delete o._geVersion,r.delete(e);const i=n(t,e,t.length,s);t.splice(i,1)}})),r.add(o)}for(const e of t)delete e.aabr;return t}return[e]}const C=[0,0,0,0];function L(e,t,r){switch(r){case"intersects":case"contains":return A(e,t);case"disjoint":return B(e,t)}}function A(e,t){return M.intersects(e,t)?M.contains(e,t)?0:2:1}function B(e,t){return M.intersects(e,t)?M.contains(e,t)?1:2:0}function T(e,t,r){const{collection:s,object:o,renderSR:i,maskSR:n,geometryTest:a,aabbCache:c}=r;let l=c.get(t);if(!l){const e=s.getObjectTransform(o);s.getComponentAabb(o,t,U);const r=[[U[0],U[1],0],[U[0],U[4],0],[U[3],U[4],0],[U[3],U[1],0]];for(let t=0;t<4;++t)d(r[t],r[t],e.rotationScale),f(r[t],r[t],e.position),E(r[t],i,r[t],n);l={rings:[r],hasZ:!1,hasM:!1,type:"polygon",spatialReference:n},l.rings[0][4]=l.rings[0][0],c.set(t,l)}switch(a(e,l)){case 1:return!1;case 0:return!0}const{triangle:p,triangleTest:u,positions:h}=r,m=p.rings[0][0],y=p.rings[0][1],j=p.rings[0][2],b=s.getObjectTransform(o);s.getComponentPositions(o,t,h);const{indices:S,data:R,stride:w,startIndex:F,endIndex:x}=h;for(let t=F;t<x;t+=3){const r=w*S[t+0],s=w*S[t+1],o=w*S[t+2];g(m,R[r+0],R[r+1],R[r+2]),g(y,R[s+0],R[s+1],R[s+2]),g(j,R[o+0],R[o+1],R[o+2]),d(m,m,b.rotationScale),d(y,y,b.rotationScale),d(j,j,b.rotationScale),f(m,m,b.position),f(y,y,b.position),f(j,j,b.position),E(m,i,m,n),E(y,i,y,n),E(j,i,j,n);const a=y[0]-m[0],c=y[1]-m[1],l=j[0]-m[0],h=j[1]-m[1];if(!(Math.abs(a*h-c*l)<2.3283064365386963e-10))switch(delete p._geVersion,u(e,p)){case 1:return!1;case 0:return!0}}switch(r.type){case"intersects":return!1;case"contains":case"disjoint":default:return!0}}const U=x();export{O as I3SMeshViewFilter};
