/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as t}from"../../../core/accessorSupport/decorators/property.js";import{subclass as i}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import{reject as r,createAbortController as l,all as s}from"../../../core/promiseUtils.js";import{whenTrueOnce as o}from"../../../core/watchUtils.js";import n from"../../2d/engine/vectorTiles/SchemaHelper.js";import a from"../../2d/engine/vectorTiles/style/StyleRepository.js";import{test as h}from"../terrain/terrainUtils.js";import{LayerView3D as p}from"./LayerView3D.js";import{TiledLayerView3D as c}from"./TiledLayerView3D.js";import d from"../../layers/LayerView.js";import{TileHandler as m}from"../../2d/engine/vectorTiles/TileHandler.js";import y from"../../2d/engine/vectorTiles/VTLPainter3D.js";let u=class extends(c(p(d))){constructor(e){super(e)}initialize(){const e=h.force512VTL?this.layer.tileInfo:this.layer.compatibleTileInfo256,t=this._getTileInfoSupportError(e,this.layer.fullExtent);if(t)return void this.addResolvingPromise(r(t));const i=o(this.view,"basemapTerrain.tilingSchemeLocked").then((()=>{const e=this.view.basemapTerrain.tilingScheme,t=e.pixelSize;let i;this.schemaHelper=new n(t,this.view.spatialReference.isGeographic),i=256===t?this.layer.compatibleTileInfo256:this.view.spatialReference.isGeographic?this.layer.compatibleTileInfo512:this.layer.tileInfo;const r=this._getTileInfoCompatibilityError(i,e);if(r)throw r;this._set("tileInfo",i)}));this._tileHandlerController=l(),this._memCache=this.view.resourceController.memoryController.getMemCache(this.layer.uid,(e=>this.tileHandler.releaseVectorTile(e)));const p=this.view.resourceController.scheduler,{style:c,spriteUrl:d,glyphsUrl:u}=this.layer.currentStyleInfo;this.tileHandler=new m(this.layer,new a(c,{spriteUrl:d,glyphsUrl:u}),this.view.pixelRatio,this._memCache);const f=this.tileHandler.start({signal:this._tileHandlerController.signal,scheduler:p}),g=this.tileHandler.spriteMosaic;g.then((e=>this.painter=new y(e,this.tileHandler.glyphMosaic))),f.then((()=>this._tileHandlerController=null));const v=()=>{this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=l(),this._memCache.clear();const{style:e,spriteUrl:t,glyphsUrl:i}=this.layer.currentStyleInfo,r=new m(this.layer,new a(e,{spriteUrl:t,glyphsUrl:i}),this.view.pixelRatio,this._memCache),o=r.start({signal:this._tileHandlerController.signal,scheduler:p}),n=r.spriteMosaic;o.then((()=>this._tileHandlerController=null)),this.updatingHandles.addPromise(s([o,n]).then((([,e])=>{const t=this.tileHandler,i=this.painter;this.painter=new y(e,r.glyphMosaic),this.tileHandler=r,this.emit("data-changed"),t.destroy(),i&&i.dispose()})))};this.updatingHandles.add(this,"layer.currentStyleInfo",v),this.updatingHandles.add(this,"view.pixelRatio",v);const H=s([i,f,g]);this.addResolvingPromise(H)}destroy(){this._memCache&&(this._memCache.destroy(),this._memCache=null),this.painter&&(this.painter.dispose(),this.painter=null),this._tileHandlerController&&(this._tileHandlerController.abort(),this._tileHandlerController=null),this.tileHandler&&(this.tileHandler.destroy(),this.tileHandler=null)}get dataLevelRange(){const e=this.tileInfo.lods,t=e[0].scale,i=e[e.length-1].scale,r=this.levelRangeFromScaleRange(t,i);return 1===r.minLevel&&256===this.tileInfo.size[0]&&(r.minLevel=0),r}};e([t({aliasOf:"layer.fullExtent"})],u.prototype,"fullExtent",void 0),e([t()],u.prototype,"layer",void 0),e([t()],u.prototype,"tileInfo",void 0),e([t()],u.prototype,"dataLevelRange",null),e([t()],u.prototype,"updatingProgressValue",void 0),u=e([i("esri.views.3d.layers.VectorTileLayerView3D")],u);var f=u;export default f;
