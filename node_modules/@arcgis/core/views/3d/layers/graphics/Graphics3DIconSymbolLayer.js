/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import e from"../../../../core/has.js";import{mixin as t}from"../../../../core/lang.js";import{isSome as r,get as i,isNone as s,unwrap as a}from"../../../../core/maybe.js";import o from"../../../../core/Error.js";import{dataComponents as n,isSVG as l}from"../../../../core/urlUtils.js";import{throwIfAbortError as c,throwIfAborted as h}from"../../../../core/promiseUtils.js";import{createRendererExpression as m}from"../../../../support/arcadeOnDemand.js";import u from"../../../../Color.js";import d from"../../../../symbols/CIMSymbol.js";import{pt2px as _,px2pt as p}from"../../../../core/screenUtils.js";import{defaultPrimitive as f}from"../../../../symbols/support/IconSymbol3DLayerResource.js";import"../../../../chunks/symbols.js";import{result as y}from"../../../../core/asyncUtils.js";import{Z as g,O as x,f as b,c as S}from"../../../../chunks/vec3f64.js";import{projectPointToVector as z}from"../../../../geometry/projection.js";import{getIconHref as v}from"../../../../symbols/support/utils.js";import{a as P}from"../../../../chunks/mat4f64.js";import{f as R,a as M}from"../../../../chunks/vec2f64.js";import{b as w}from"../../../../chunks/vec4f64.js";import{containsPoint as C}from"../../../../geometry/support/aaBoundingBox.js";import I from"../../webgl-engine/lib/GeometryUtil.js";import{HUDMaterial as j}from"../../webgl-engine/materials/HUDMaterial.js";import{validateSymbolLayerSize as T,namedAnchorToHUDMaterialAnchorPos as E}from"./graphicUtils.js";import{elevationModeChangeUpdateType as O,SymbolUpdateType as L,needsElevationUpdates2D as U}from"./elevationAlignmentUtils.js";import{perObjectElevationAligner as F}from"./ElevationAligners.js";import{ElevationContext as D}from"./ElevationContext.js";import G from"./Graphics3DObject3DGraphicLayer.js";import A from"../../webgl-engine/lib/Geometry.js";import{Graphics3DSymbolLayer as V}from"./Graphics3DSymbolLayer.js";import{placePointOnGeometry as k,createStageObjectForHUD as B,extendPointGraphicElevationContext as N}from"./pointUtils.js";import{DRAPED_Z as H}from"../../terrain/OverlayRenderer.js";import q from"../../../2d/arcade/callExpressionWithFeature.js";import{TRANSPARENT_UNIT as W}from"./constants.js";import Z from"./Graphics3DDrapedGraphicLayer.js";import{createTriangle as $,createX as J,createCross as K,createKite as Q,createSquare as X,createCircle as Y}from"./sdfPrimitives.js";import{initFastSymbolUpdatesState as ee,updateFastSymbolUpdatesState as te,evaluateModelTransform as re}from"../support/FastSymbolUpdates.js";import ie from"../../webgl-engine/lib/RenderGeometry.js";import se from"../../webgl-engine/lib/Texture.js";const ae=P(),oe=b(0,0,1),ne=[.25,.25,.75,.75],le=[64,64];class ce extends V{constructor(e,t,r,i){super(e,t,r,i),this._cimLayers=null,this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._cimRequiredFields=null,this._cimScaleFactorOrFunction=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._texture=null,this._releaseTexture=null,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}getCachedSize(){return{size:this._getIconSize()}}async doLoad(e){this._validateOrThrow();const t=this._prepareMaterialParameters(),i=this._getPrimitive();if(r(i))this._prepareResourcesPrimitive(t,i);else{const r=v(this.symbol,this.symbolLayer),i=n(r);i&&"application/json"===i.mediaType?await this._prepareResourcesCIM(t,JSON.parse(i.data),e):await this._prepareResourcesHref(t,r,e)}}_validateOrThrow(){if(this._drivenProperties.size)return;const e=T(this._getIconSize());if(e)throw new o("graphics3diconsymbollayer:invalid-size",e)}_getIconSize(){const e=this.symbolLayer,t=Math.round(null!=e.size?_(e.size):16);return this._drivenProperties.size?Math.max(t,64):t}_generateTextureCIM(e){const t=this._getGraphicHash(e);let r=""===t?null:this._cimSymbolTextures.get(t);if(!r){const i={scaleFactor:this._cimScaleFactorOrFunction},s=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol(this._cimLayers,e,"esriGeometryPoint",i,null,null);this._cimMaterialParametersInfo.anchorPos=this._getAnchorPos("relative",s.anchorPosition);const a={width:s.imageData.width,height:s.imageData.height,powerOfTwoResizeMode:2};r=new se(s.imageData,"symbol",a),this._cimSymbolTextures.set(t,r),this._context.stage.add(4,r)}return r}_computeSize(e,t){const r=e.width/e.height;return r>1?[t,Math.round(t/r)]:[Math.round(t*r),t]}_prepareMaterialParameters(){const e={anchorPos:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},t=this.symbol;if(function(e){return e&&"point-3d"===e.type&&e.hasVisibleVerticalOffset()}(t)){const{screenLength:r,minWorldLength:i,maxWorldLength:s}=t.verticalOffset;e.verticalOffset={screenLength:_(r),minWorldLength:i||0,maxWorldLength:null!=s?s:1/0}}return this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),e.occlusionTest=!0,e.slicePlaneEnabled=this._context.slicePlaneEnabled,e}_prepareResourcesPrimitive(e,t){const r=this._getOutlineSize();if(he(t)&&0===r)throw new Error("Nothing to render");this._outlineSize=r,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize;const i=this._context.sharedResources.textures.fromData(t,(()=>function(e){let t;const r=128,i=.5*r;switch(e){case"circle":t=Y(r,i);break;case"square":t=X(r,i);break;case"kite":t=Q(r,i);break;case"cross":t=K(r,i);break;case"x":t=J(r,i);break;case"triangle":t=$(r,i)}return new se(t,"sdf_"+e,{mipmap:!1,wrap:{s:33071,t:33071},width:128,height:128,components:4,noUnpackFlip:!0})}(t)));this._texture=i.texture,this._releaseTexture=()=>this._context.sharedResources.textures.release(i.uid),e.textureIsSignedDistanceField=!0,e.distanceFieldBoundingBox=ne,e.textureId=this._texture.id;const s=this._getIconSize();this._size=[s,s],this._symbolTextureRatio=2,this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesHref(t,r,i){if(!e("esri-canvas-svg-support")&&l(r)){throw new o("graphics3diconsymbollayer:unsupported-image-format","IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)")}this._outlineSize=this._getOutlineSize(),t.color=this._getFillColor(),t.outlineColor=this._getOutlineColor(),t.outlineSize=this._outlineSize,t.textureIsSignedDistanceField=!1;const s=this._getIconSize(),a=s*this._context.layerView.view.pixelRatio,n=await y(this._context.sharedResources.textures.fromUrl(r,a,{signal:i}));if(!1===n.ok){c(n.error);throw new o("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${r})`)}const{uid:h,texture:m}=n.value;this._releaseTexture=()=>this._context.sharedResources.textures.release(h);const u=m.params;this._size=this._computeSize(u,s),t.textureId=m.id,this._createMaterialAndAddToStage(t,this._context.stage)}async _prepareResourcesCIM(e,t,r){const i=new d({data:t});if(!this._context.sharedResources.cimSymbolRasterizer){const e=(await import("../../../../symbols/cim/CIMSymbolRasterizer.js")).CIMSymbolRasterizer;h(r),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new e(this._context.renderCoordsHelper.spatialReference,!0))}const s=this._context.layer.fields?this._context.layer.fields.map((e=>e.toJSON())):null;let a,o;if(this._cimLayers=await this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(i,s,this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:r}),this._context.renderer&&"dictionary"===this._context.renderer.type&&this._context.renderer.scaleExpression){const e=this._context.renderer;if(isNaN(e.scaleExpression)){const t=e.scaleExpression,r=await m(t,this._context.layer.spatialReference,s);o=(e,t,i)=>{const s=q(r,e,{$view:i},"esriGeometryPoint",t);return null!==s?s:1}}else a=Number(e.scaleExpression)}this._cimScaleFactorOrFunction=a||o||1;const n=this._context.renderer?await this._context.renderer.getRequiredFields(this._context.layer.fields):[];h(r);const l=this._context.layer.fieldsIndex;this._cimRequiredFields=n.map((e=>l.get(e).name)),this._cimMaterialParametersInfo=e,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1}_getPrimitive(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||f}_getOutlineSize(){let e=0;const t=this.symbolLayer;if(r(t.outline)&&null!=t.outline.size)return Math.max(_(t.outline.size),0);return e=he(this._getPrimitive())?1.5:0,Math.max(e,0)}_getOutlineColor(){const e=this._getLayerOpacity(),t=this.symbolLayer,s=i(t,"outline","color");if(r(s)){const t=u.toUnitRGB(s),r=s.a*e;return[t[0],t[1],t[2],r]}return[0,0,0,0]}_getFillColor(){if(he(this._getPrimitive()))return W;const e=s(this._getPrimitive()),t=i(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(t,{hasIntrinsicColor:e})}_getAnchorPos(e,t){return"relative"===e?R((t.x||0)+.5,.5-(t.y||0)):e in E?E[e]:E.center}_createMaterialAndAddToStage(e,r){if(this._cimLayers?this._fastUpdates={enabled:!1}:this._fastUpdates=ee(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&t(e,this._fastUpdates.materialParameters),this._cimLayers){let t=this._cimSymbolMaterials.get(e.textureId);return t||(t=new j(e,this._getIdHint("_icon")),this._cimSymbolMaterials.set(e.textureId,t),r.add(3,t)),t}return this._material=new j(e,this._getIdHint("_icon")),r.add(3,this._material),this._material}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial((e=>{e.setParameterValues({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,slicePlaneEnabled:!1,shaderPolygonOffset:0,isDraped:this.draped})})),this.layerOpacityChanged())}destroy(){super.destroy(),this._forEachMaterial((e=>{this._context.stage.remove(3,e.id)})),r(this._material)&&(this._material=null),this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach((e=>{this._context.stage.remove(4,e.id)})),this._cimSymbolTextures.clear(),this._releaseTexture&&(this._releaseTexture(),this._releaseTexture=null)}_getScaleFactor(e,t){if(this._drivenProperties.size&&e.size){for(let t=0;t<3;t++){const r=e.size[t];r&&"symbol-value"!==r&&"proportional"!==r&&(e.size[t]=_(r))}if("symbol-value"===e.size[0])return 1;if(isFinite(+e.size[0]))return+e.size[0]/t;if(isFinite(+e.size[2]))return+e.size[2]/t}return 1}createGraphics3DGraphic(e){const t=e.renderingInfo,r=e.graphic;let i,o;if(this._cimLayers){if(!this._cimLayers.length)return null;const e=this._generateTextureCIM(r),t={textureId:e.id,...this._cimMaterialParametersInfo};o=this._createMaterialAndAddToStage(t,this._context.stage),i=[e.params.width,e.params.height]}else i=this._size,o=a(this._material);if(!this._validateGeometry(r.geometry))return null;const n=k(r.geometry);if(s(n))return this.logger.warn(`unsupported geometry type for icon symbol: ${r.geometry.type}`),null;const l="graphic"+r.uid,c=this._getVertexOpacityAndColor(t);let h=1;if(!this._fastUpdates.enabled||!this._fastUpdates.visualVariables.size){const e=i[0]>i[1]?i[0]:i[1];h=this._getScaleFactor(t,e)}h*=this._symbolTextureRatio;const m=[i[0]*h,i[1]*h],u=this.setGraphicElevationContext(r,new D);return this.ensureDrapedStatus("on-the-ground"===u.mode)&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(r,n,o,c,m,e.layer.uid):this._createAs3DShape(r,n,o,c,m,u,l,r.uid)}layerOpacityChanged(){const e=this._getFillColor(),t=this._getOutlineColor();return this._forEachMaterial((r=>{r.setParameterValues({color:e}),r.setParameterValues({outlineColor:t})})),!0}layerElevationInfoChanged(e,t,r){const i=this._elevationContext.mode,s=O(ce.elevationModeChangeTypes,r,i);if(s!==L.UPDATE)return s;const a=U(i)||"absolute-height"===i;return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>a))}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial((e=>{e.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled})})),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!!this._getPrimitive()}applyRendererDiff(e,t){for(const i in e.diff)switch(i){case"visualVariables":if(!te(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return!1;r(this._material)&&this._material.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0}_defaultElevationInfoNoZ(){return me}_createAs3DShape(e,t,r,i,s,a,o,n){const l=this.getFastUpdateAttrValues(e),c=l?e=>re(this._fastUpdates.materialParameters,l,e):null,h=I.createPointGeometry(oe,null,i,s,ue,null,l),m=[new A(h,o)],u=B(this._context,t,m,[r],null,null,a,o,this._context.layer.uid,n,c);if(null===u)return null;const d=F,_=new G(this,u.object,m,null,null,d,a);return _.alignedSampledElevation=u.sampledElevation,_.needsElevationUpdates=U(a.mode)||"absolute-height"===a.mode,_.getScreenSize=this._createScreenSizeGetter(s,c),_.calculateRelativeScreenBounds=e=>r.calculateRelativeScreenBounds(_.getScreenSize(),1,e),N(_,t,this._context.elevationProvider),_}_createAsOverlay(e,t,i,s,a,o){i.renderPriority=this._renderPriority;const n=S();z(t,n,this._context.overlaySR),n[2]=H;const l=this._context.clippingExtent;if(r(l)&&!C(l,n))return null;const c=this.getFastUpdateAttrValues(e),h=c?e=>re(this._fastUpdates.materialParameters,c,e):null,m=I.createPointGeometry(oe,n,s,a,null,null,c),u=new ie(m);u.material=i,u.center=n,u.bsRadius=0,u.data.layerUid=o,u.data.graphicUid=e.uid,u.calculateShaderTransformation=h;const d=new Z(this,[u],null);return d.getScreenSize=this._createScreenSizeGetter(a,h),d.calculateRelativeScreenBounds=e=>i.calculateRelativeScreenBounds(d.getScreenSize(),1,e),d}_createScreenSizeGetter(e,t){const r=this._outlineSize+2;if(this._fastUpdates.enabled){const i=e[0]/this._symbolTextureRatio,s=e[1]/this._symbolTextureRatio;return(e=M())=>{const a=t(ae);return e[0]=a[0]*i+r,e[1]=a[5]*s+r,e}}{const t=e[0]/this._symbolTextureRatio+r,i=e[1]/this._symbolTextureRatio+r;return(e=M())=>(e[0]=t,e[1]=i,e)}}_fastVisualVariableConvertOptions(){const e=this._size[0]>this._size[1]?this._size[0]:this._size[1],t=b(e,e,e),r=p(1),i=e*r;return{modelSize:t,symbolSize:b(i,i,i),unitInMeters:r,transformation:{anchor:g,scale:x,rotation:g}}}_getGraphicHash(e){let t="";for(const r of this._cimRequiredFields)t+=r+e.attributes[r];return t}_forEachMaterial(e){r(this._material)&&e(this._material),this._cimSymbolMaterials.forEach(e)}}function he(e){return!!r(e)&&("cross"===e||"x"===e)}ce.PRIMITIVE_SIZE=le,ce.elevationModeChangeTypes={definedChanged:L.UPDATE,staysOnTheGround:L.NONE,onTheGroundChanged:L.RECREATE};const me={mode:"relative-to-ground",offset:0},ue=w(0,0,0,1);export default ce;export{ce as Graphics3DIconSymbolLayer};
