/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import"../../../../core/has.js";import{isSome as e,unwrap as t,unwrapOr as o}from"../../../../core/maybe.js";import i from"../../../../core/Logger.js";import{isFinite as r}from"../../../../core/mathUtils.js";import n from"../../../../Color.js";import{O as s}from"../../../../chunks/vec3f64.js";import{b as a}from"../../../../chunks/vec4f64.js";import{mixinColorAndOpacity as l}from"./graphicUtils.js";import{SymbolUpdateType as p}from"./elevationAlignmentUtils.js";import{zeroContext as d}from"./featureExpressionInfoUtils.js";import{ElevationContext as c}from"./ElevationContext.js";import{Loadable as h}from"./Loadable.js";import{defaultSymbolLayerComplexity as u}from"./symbolComplexity.js";const y=i.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class f extends h{constructor(e,t,o,i){super(),this._elevationInfoOverride=null,this.complexity=null,this.logger=y,this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.symbol=e,this.symbolLayer=t,this._context=o,this._renderPriority=i.renderPriority,this._renderPriorityStep=i.renderPriorityStep,this._elevationContext=new c,this.complexity=this.computeComplexity(),this._updateDrivenProperties(i.ignoreDrivers),this._updateElevationContext()}getCachedSize(){return null}get extentPadding(){return 0}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(e,t,o,i){const r=e.projectionSuccess,n="polygons"in e?e.polygons:null,s=`${i} geometry failed to be created`;let a=null;r?!t.length||1===t.length&&!t[0].length?a=`${s} (no ${o} were defined)`:Array.isArray(t)&&Array.isArray(t[0])?n&&0===n.length&&"rings"===o&&t.length>0&&t[0].length>2&&(a=`${s} (filled rings should use clockwise winding - try reversing the order of vertices)`):a=`${s} (${o} should be defined as a 2D array)`:a=`${s} (failed to project geometry to view spatial reference)`,a&&y.warnOncePerTick(a)}_validateGeometryType(e,t,o){return!!t.includes(e.type)||(this.logger.warn("unsupported geometry type for "+o+` symbol: ${e.type}`),!1)}_validateGeometry(e){if("point"===e.type){const t=e;if(!r(t.x)||!r(t.y))return y.warn("point coordinate is not a valid number, graphic skipped"),!1}return!0}_defaultElevationInfoNoZ(){return m}_defaultElevationInfoZ(){return _}_updateElevationContext(){e(this._elevationInfoOverride)?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e,t=this.getDefaultElevationInfo(e)){return this._elevationContext.mode||t.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext()}setGraphicElevationContext(e,i){const r=t(e.geometry),n=this.getDefaultElevationInfo(r);i.unit=null!=this._elevationContext.unit?this._elevationContext.unit:n.unit,i.mode=this.getGeometryElevationMode(r,n),i.offsetMeters=o(this._elevationContext.meterUnitOffset,o(n.offset,0));const s=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===i.mode;s&&(i.mode="relative-to-ground",i.offsetMeters=0);const a=s?d:this._elevationContext.featureExpressionInfoContext;return i.updateFeatureExpressionInfoContext(a,e,this._context.layer),i}prepareSymbolLayerPatch(e){}updateGeometry(e,t){return!1}onRemoveGraphic(e){}_updateDrivenProperties(e){const t={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};if(e)return void(this._drivenProperties=t);const o=this._context.renderer;o&&"visualVariables"in o&&o.visualVariables&&o.visualVariables.forEach((e=>{switch(e.type){case"color":if(t.color=!0,e.stops)for(let o=0;o<e.stops.length;o++){const i=e.stops[o].color;i&&(t.opacity=!0,i.a<1&&(t.opacityAlwaysOpaque=!1))}break;case"opacity":t.opacity=!0,t.opacityAlwaysOpaque=!1;break;case"size":t.size=!0}})),this._drivenProperties=t}_getLayerOpacity(){if(this._context.layerView&&"fullOpacity"in this._context.layerView)return this._context.layerView.fullOpacity;const e=this._context.layer.opacity;return null==e?1:e}_getCombinedOpacity(t,o=g){let i=1;return this.draped||(i*=this._getLayerOpacity()),this._drivenProperties.opacity||(e(t)?i*=t.a:o.hasIntrinsicColor||(i=0)),i}_getCombinedOpacityAndColor(t,o=g){const i=this._getCombinedOpacity(t,o);if(this._drivenProperties.color)return l(null,i);const r=e(t)?n.toUnitRGB(t):s;return l(r,i)}_getVertexOpacityAndColor(e,t,o){const i=this._drivenProperties.color?e.color:null,r=this._drivenProperties.opacity?e.opacity:null,n=l(i,r);return o&&(n[0]*=o,n[1]*=o,n[2]*=o,n[3]*=o),t?new t(n):n}_getIdHint(e=""){return this._context.layer.id+"_symbol"+e}isFastUpdatesEnabled(){return this._fastUpdates&&this._fastUpdates.enabled}computeComplexity(){return u(this.symbol,this.symbolLayer)}destroy(){this.abortLoad()}globalPropertyChanged(e,t,o){switch(e){case"opacity":return this.layerOpacityChanged(t,o);case"elevationInfo":{const e=this._elevationContext.mode;this._updateElevationContext();return this.layerElevationInfoChanged(t,o,e)!==p.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(t,o);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged();default:return!1}}updateGraphics3DGraphicElevationInfo(t,o,i){let r=p.UPDATE;return t.forEach((t=>{const n=o(t);if(e(n)){const e=t.graphic;this.setGraphicElevationContext(e,n.elevationContext),n.needsElevationUpdates=i(n.elevationContext.mode)}else r=p.RECREATE})),r}applyRendererDiff(e,t){return!1}getFastUpdateAttrValues(e){if(!this._fastUpdates.enabled)return null;const t=this._fastUpdates.visualVariables,o=t.size?v(t.size.field,e):0,i=t.color?v(t.color.field,e):0,r=t.opacity?v(t.opacity.field,e):0;return a(o,i,r,0)}get draped(){return this._draped}ensureDrapedStatus(e){return null==this._draped?(this._draped=e,!0):(e!==this.draped&&y.warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}}function v(e,t){const o=null!=e?t.attributes[e]:0;return null!=o&&isFinite(o)?o:0}const m={mode:"on-the-ground",offset:0,unit:"meters"},_={mode:"absolute-height",offset:0,unit:"meters"},g={hasIntrinsicColor:!1};export default f;export{f as Graphics3DSymbolLayer,v as getAttributeValue};
