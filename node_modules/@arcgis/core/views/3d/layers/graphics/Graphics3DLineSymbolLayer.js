/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{get as e,isNone as t,isSome as i}from"../../../../core/maybe.js";import r from"../../../../core/Error.js";import a from"../../../../geometry/Extent.js";import s from"../../../../geometry/Polygon.js";import"../../../../geometry.js";import n from"../../../../Color.js";import{px2pt as o,pt2px as l}from"../../../../core/screenUtils.js";import{I as p}from"../../../../chunks/mat4f64.js";import{b as h}from"../../../../chunks/vec4f64.js";import{create as d,empty as c,expandWithBuffer as m,intersectsClippingArea as y,expandWithAABB as g}from"../../../../geometry/support/aaBoundingBox.js";import u from"../../webgl-engine/lib/Object3D.js";import{elevationModeChangeUpdateType as _,SymbolUpdateType as f,needsElevationUpdates2D as b}from"./elevationAlignmentUtils.js";import{perVertexElevationAligner as v}from"./ElevationAligners.js";import{ElevationContext as M}from"./ElevationContext.js";import P from"./Graphics3DObject3DGraphicLayer.js";import U from"../../webgl-engine/lib/Geometry.js";import{Graphics3DSymbolLayer as x,getAttributeValue as C}from"./Graphics3DSymbolLayer.js";import{getDriverAxisSizeValueAny as D}from"../../../../renderers/support/renderingInfoUtils.js";import{RibbonLineMaterial as E}from"../../webgl-engine/materials/RibbonLineMaterial.js";import{createStipplePattern as j}from"../../webgl-engine/materials/lineStippleUtils.js";import z from"./Graphics3DDrapedGraphicLayer.js";import{initFastSymbolUpdatesState as G,updateFastSymbolUpdatesState as L}from"../support/FastSymbolUpdates.js";import O from"../../webgl-engine/lib/RenderGeometry.js";import{geometryToRenderInfo as S,createGeometryData as w,geometryToRenderInfoDraped as A}from"./lineUtils.js";class V extends x{constructor(e,t,i,r){super(e,t,i,r),this._uniformSize=1}async doLoad(){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=G(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},!this._drivenProperties.size){const e=null!=this.symbolLayer.size?this.symbolLayer.size:o(1);if(e<0)throw new r("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._uniformSize=e}}getMaterialParameters(t){const i=e(this.symbolLayer,"material","color"),r=this._getCombinedOpacityAndColor(i),a=r[3],s={width:1,color:r,polygonOffset:!0,join:this.symbolLayer.join||"miter",cap:this.symbolLayer.cap||"butt",transparent:a<1||this.needsDrivenTransparentPass,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:t,stipplePattern:this.symbolLayer.stipplePattern?j(this.symbolLayer.stipplePattern.map(l)):null,stippleOffColor:this.symbolLayer.stippleOffColor?n.toUnitRGBA(this.symbolLayer.stippleOffColor):null,stippleIntegerRepeats:!0};if(this._drivenProperties.size)this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size&&(s.width=l(1));else{const e=null!=this.symbolLayer.size?this.symbolLayer.size:o(1);s.width=l(e)}return this._fastUpdates&&this._fastUpdates.visualVariables?{...s,...this._fastUpdates.materialParameters}:s}get lineMaterial(){return t(this._lineMaterial)&&(this._lineMaterial=new E(this.getMaterialParameters(!1),this._getIdHint("_ribbonlinemat")),this._context.stage.add(3,this._lineMaterial)),this._lineMaterial}get ringMaterial(){return t(this._ringMaterial)&&(this._ringMaterial=new E(this.getMaterialParameters(!0),this._getIdHint("_ribbonlinemat")),this._context.stage.add(3,this._ringMaterial)),this._ringMaterial}destroy(){super.destroy(),i(this._lineMaterial)&&(this._context.stage.remove(3,this._lineMaterial.id),this._lineMaterial=null),i(this._ringMaterial)&&(this._context.stage.remove(3,this._ringMaterial.id),this._ringMaterial=null)}getDrivenSize(e){return this._drivenProperties.size&&e.size?l(D(e.size)):1}getSizeFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?C(this._fastUpdates.visualVariables.size.field,e):null}getDrivenColor(e){const t=h(1,1,1,1);return this._drivenProperties.color&&e.color&&(t[0]=e.color[0],t[1]=e.color[1],t[2]=e.color[2],e.color.length>0&&(t[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(t[3]=e.opacity),t}getColorFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?C(this._fastUpdates.visualVariables.color.field,e):null}getOpacityFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?C(this._fastUpdates.visualVariables.opacity.field,e):null}createGraphics3DGraphic(e){const t=e.graphic,i=t.geometry;if(!this._validateGeometryType(t.geometry,V.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(i))return null;const r="graphic"+t.uid,a=this.setGraphicElevationContext(t,new M);return this.ensureDrapedStatus("on-the-ground"===a.mode),this.draped?this._createAsOverlay(e,this._context.layer.uid):this._createAs3DShape(e,a,r,t.uid)}applyRendererDiff(e,t){for(const r in e.diff)switch(r){case"visualVariables":if(!L(this._fastUpdates,t,this._vvConvertOptions))return!1;i(this._lineMaterial)&&this._lineMaterial.setParameterValues(this._fastUpdates.materialParameters),i(this._ringMaterial)&&this._ringMaterial.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0}layerOpacityChanged(){return i(this._lineMaterial)&&this.updateMaterialLayerOpacity(this._lineMaterial),i(this._ringMaterial)&&this.updateMaterialLayerOpacity(this._ringMaterial),!0}updateMaterialLayerOpacity(t){const i=t.params.color,r=e(this.symbolLayer,"material","color"),a=this._getCombinedOpacity(r),s=a<1||this.needsDrivenTransparentPass,n=[i[0],i[1],i[2],a];t.setParameterValues({color:n,transparent:s})}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,a=_(V.elevationModeChangeTypes,i,r);if(a!==f.UPDATE)return a;const s=b(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>s))}slicePlaneEnabledChanged(){return i(this._lineMaterial)&&this._lineMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),i(this._ringMaterial)&&this._ringMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_getGeometryAsPolygonOrPolyline(e){switch(e.type){case"extent":if(e instanceof a)return s.fromExtent(e);break;case"polygon":case"polyline":return e}return null}_createAs3DShape(e,t,r,a){const s=e.graphic,n=this._getGeometryAsPolygonOrPolyline(s.geometry),o="polygon"===n.type?n.rings:n.paths,l=[],h=[],g=[],_=d(),f=S(n,this._context.elevationProvider,this._context.renderCoordsHelper,t),M="polygon"===n.type?"rings":"paths";this._logGeometryCreationWarnings(f,o,M,"LineSymbol3DLayer");for(let t=0;t<f.lines.length;t++){const{position:a,mapPosition:s}=f.lines[t];if(i(this._context.clippingExtent)&&(c(_),m(_,s),!y(_,this._context.clippingExtent)))continue;const o=this._createGeometryData(e,a,s,n.type),d=new U(o,r+"path"+t);l.push(d),h.push("polygon"===n.type?this.ringMaterial:this.lineMaterial),g.push(p)}if(0===l.length)return null;const x=new u({geometries:l,materials:h,transformations:g,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:a},idHint:r}),C=new P(this,x,l,null,null,v,t);return C.alignedSampledElevation=f.sampledElevation,C.needsElevationUpdates=b(t.mode),C}_createGeometryData(e,t,i,r){const a="polygon"===r?1:0,s=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,n=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size;return w({removeDuplicateStartEnd:a,uniformSize:this._uniformSize,attributeData:{position:t,mapPosition:i,size:n?null:this.getDrivenSize(e.renderingInfo),color:s?null:this.getDrivenColor(e.renderingInfo),sizeFeature:this.getSizeFeatureAttributeData(e.graphic),colorFeature:this.getColorFeatureAttributeData(e.graphic),opacityFeature:this.getOpacityFeatureAttributeData(e.graphic)}})}_createAsOverlay(e,t){const i=e.graphic,r=this._getGeometryAsPolygonOrPolyline(i.geometry),a="polygon"===r.type?r.rings:r.paths,s="polygon"===r.type?this.ringMaterial:this.lineMaterial;s.renderPriority=this._renderPriority;const n=[],o=d(),l=c(),p=A(r,this._context.overlaySR),h="polygon"===r.type?"rings":"paths";if(this._logGeometryCreationWarnings(p,a,h,"LineSymbol3DLayer"),a.length>0){const{lines:a}=p;for(let p=0;p<a.length;++p){const h=a[p];if(c(o),m(o,h.position),!y(o,this._context.clippingExtent))continue;g(l,o);const d=this._createGeometryData(e,h.position,null,r.type),u=new O(d);u.data.layerUid=t,u.data.graphicUid=i.uid,u.material=s,u.center=[.5*(o[0]+o[3]),.5*(o[1]+o[4]),0],u.bsRadius=.5*Math.sqrt((o[3]-o[0])*(o[3]-o[0])+(o[4]-o[1])*(o[4]-o[1])),n.push(u)}return new z(this,n,l)}return null}}V.validGeometryTypes=["polyline","polygon","extent"],V.elevationModeChangeTypes={definedChanged:f.RECREATE,staysOnTheGround:f.NONE,onTheGroundChanged:f.RECREATE};export default V;export{V as Graphics3DLineSymbolLayer};
