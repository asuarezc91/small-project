/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{mixin as e}from"../../../../core/lang.js";import{isSome as t,get as s,none as r,isNone as i,unwrapOr as a}from"../../../../core/maybe.js";import o from"../../../../Color.js";import{pt2px as n}from"../../../../core/screenUtils.js";import{defaultPrimitive as l}from"../../../../symbols/support/ObjectSymbol3DLayerResource.js";import{d as c,O as h,Z as d,f as m,c as p}from"../../../../chunks/vec3f64.js";import{l as u,p as f,g as y,A as _,b,s as g}from"../../../../chunks/vec3.js";import{c as P,i as v,s as x,t as R}from"../../../../chunks/mat4.js";import{projectPointToVector as S,computeLinearTransformation as L}from"../../../../geometry/projection.js";import{a as C}from"../../../../chunks/mat4f64.js";import{O as U,a as E}from"../../../../chunks/vec4f64.js";import{create as j,size as w,containsPoint as T,center as B}from"../../../../geometry/support/aaBoundingBox.js";import{VertexAttrConstants as G}from"../../webgl-engine/lib/Util.js";import{validateSymbolLayerSize as O,mixinColorAndOpacity as I,computeObjectScale as z,computeObjectRotation as V}from"./graphicUtils.js";import{needsElevationUpdates3D as D,evaluateElevationAlignmentAtPoint as A}from"./elevationAlignmentUtils.js";import{perLodInstanceElevationAligner as M}from"./ElevationAligners.js";import{ElevationContext as F}from"./ElevationContext.js";import{isValidPrimitive as k,primitiveLodResources as W}from"./primitiveObjectSymbolUtils.js";import{materialsFromLodResources as q,texturesFromLodResources as H,geometriesFromLodResources as $,geometriesFromLodLevelResources as N}from"../../webgl-engine/lib/lodRendering/LodResources.js";import{defaultSymbolLayerMemoryComplexity as Z}from"./symbolComplexity.js";import{Graphics3DSymbolLayer as J}from"./Graphics3DSymbolLayer.js";import{placePointOnGeometry as K,extendPointGraphicElevationContext as Q}from"./pointUtils.js";import{DefaultMaterial as X}from"../../webgl-engine/materials/DefaultMaterial.js";import{initFastSymbolUpdatesState as Y,updateFastSymbolUpdatesState as ee,evaluateModelTransform as te,evaluateModelTransformScale as se}from"../support/FastSymbolUpdates.js";import{objectSymbolLayerPrimitiveBoundingBox as re,objectSymbolLayerSizeWithResourceSize as ie}from"../../../../symbols/support/symbolLayerUtils3D.js";import ae from"./Graphics3DLodInstanceGraphicLayer.js";import{makeLodResources as oe,fillEstimatedMinScreenSpaceRadius as ne}from"./lodResourceUtils.js";import{fetch as le}from"./objectResourceUtils.js";import{LodRenderer as ce}from"../../webgl-engine/lib/lodRendering/LodRenderer.js";class he extends J{constructor(e,t,s,r){super(e,t,s,r),this._resources=null,this._optionalFields=[],this._instanceIndexToGraphicUid=new Map,this.ensureDrapedStatus(!1)}getCachedSize(){const[e,s,r]=t(this._resources)?this._resources.symbolSize:[1,1,1];return{width:e,depth:s,height:r}}async doLoad(e){const t=this._getIdHint("_objectmat");if(!this._drivenProperties.size){if(O(this.symbolLayer))throw new Error}const s=this.symbolLayer;if(this.isPrimitive){const e=s.resource?s.resource.primitive:l;this._resources=this._createResourcesForPrimitive(e,t)}else this._resources=await this._createResourcesForUrl(s.resource.href,e);this.complexity=this.computeComplexity()}get extentPadding(){return t(this._resources)?this._resources.extentPadding:0}get isPrimitive(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}get lodRenderer(){return s(this._resources,"lodRenderer")}setMaterialTransparencyParams(e,t=s(this.symbolLayer,"material","color")){const r=this._getCombinedOpacity(t),i=r<1||this.needsDrivenTransparentPass;return e.transparent=i,e.opacity=r,e}_createResourcesForPrimitive(s,i){if(!k(s))throw new Error(`Unknown object symbol primitive: ${s}`);const a=this.symbolLayer,l=j(re(s)),d=c(w(l)),m=c(ie(d,a)),p=u(m),f={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,instanced:["transformation"],ambient:h,diffuse:h,slicePlaneEnabled:this._context.slicePlaneEnabled,sliceHighlightDisabled:!0,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},y=f.usePBR;this.setMaterialTransparencyParams(f);const _=this.symbol;if("point-3d"===_.type&&_.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:s}=_.verticalOffset;f.verticalOffset={screenLength:n(e),minWorldLength:t||0,maxWorldLength:null!=s?s:1/0},f.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(f.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)f.externalColor=U;else{const e=t(a.material)&&a.material.color,s=t(e)?o.toUnitRGBA(e):U;f.externalColor=s}this._fastUpdates=Y(this._context.renderer,this._fastVisualVariableConvertOptions(l,m,d,r)),this._fastUpdates.enabled?(e(f,this._fastUpdates.materialParameters),f.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(f.instanced.push("color"),this._optionalFields.push("color"));const b=new X(f,i),g=W(s,b,i);if(!g)throw new Error(`Unknown object symbol primitive: ${s}`);const P=q(g).map((e=>({opacity:1,transparent:e.params.transparent}))),v=this._createStageResources(g,y);return{lodResources:g,lodRenderer:this._createLodRenderer(g),stageResources:v,symbolSize:m,extentPadding:p,isEsriSymbolResource:!1,isWosr:!1,originalMaterialParameters:P,physicalBasedRenderingEnabled:y,resourceBoundingBox:l,resourceSize:d,dispose:r,pivotOffset:r}}async _createResourcesForUrl(t,i){const a=["transformation"],o={materialParamsMixin:{instanced:a,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=Y(this._context.renderer,this._fastVisualVariableConvertOptions(r,r,r,r)),this._fastUpdates.enabled?(e(o.materialParamsMixin,this._fastUpdates.materialParameters),a.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(a.push("color"),this._optionalFields.push("color"));const l=this.symbol;if("point-3d"===l.type&&l.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:s}=l.verticalOffset;o.materialParamsMixin.verticalOffset={screenLength:n(e),minWorldLength:t||0,maxWorldLength:null!=s?s:1/0},o.materialParamsMixin.castShadows=!1}o.signal=i,o.usePBR=this._context.physicalBasedRenderingEnabled;const h=o.usePBR,d=await le(t,o),m=d.isEsriSymbolResource,p=d.isWosr,f=d.remove,y=oe(d.lods);ne(y),y.levels.sort(((e,t)=>e.minScreenSpaceRadius-t.minScreenSpaceRadius)),y.levels[0].minScreenSpaceRadius=Math.min(2,y.levels[0].minScreenSpaceRadius);const _=this._context,b=this.symbolLayer.material,g=this._getExternalColorParameters(b),P=s(this.symbolLayer,"material","color"),v=this._getCombinedOpacity(P,{hasIntrinsicColor:!0}),x=this.needsDrivenTransparentPass,R=q(y),S=q(y).map((e=>{const t=e.params;return{opacity:t.opacity||1,transparent:t.transparent}}));R.forEach((e=>{const t=e.params;e.setParameterValues(g);const s=t.opacity*v,r=s<1||x||t.transparent;e.setParameterValues({opacity:s,transparent:r}),_.screenSizePerspectiveEnabled&&e.setParameterValues({screenSizePerspective:_.sharedResources.screenSizePerspectiveSettings})}));const L=d.referenceBoundingBox,C=c(w(L)),U=c(y.levels[0].pivotOffset),E=c(ie(C,this.symbolLayer)),j=u(E);ee(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(L,E,C,U))&&R.forEach((e=>e.setParameterValues(this._fastUpdates.materialParameters)));const T=this._createStageResources(y,h);return{lodResources:y,lodRenderer:this._createLodRenderer(y),stageResources:T,symbolSize:E,extentPadding:j,isEsriSymbolResource:m,isWosr:p,originalMaterialParameters:S,physicalBasedRenderingEnabled:h,resourceBoundingBox:L,resourceSize:C,dispose:f,pivotOffset:U}}_createStageResources(e,t){const s=this._context.stage,r=q(e);t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged();for(const e of r)s.add(3,e);const i=H(e);for(const e of i)s.add(4,e);const a=$(e);for(const e of a)s.add(2,e);return{materials:r,textures:i,geometries:a}}_createLodRenderer(e){const t=this._context.stage,s={layerUid:this._context.layer.uid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicUpdate:(e,t)=>this._context.notifyGraphicUpdate(this._instanceIndexToGraphicUid.get(e),t)},r=this._fastUpdates.enabled?{applyTransform:(e,t,s)=>{e.getFeatureAttribute(t,ue),P(s,te(this._fastUpdates.materialParameters,ue,s))},scaleFactor:(e,t,s)=>(t.getFeatureAttribute(s,ue),se(e,this._fastUpdates.materialParameters,ue))}:null,i=new ce(e,this._optionalFields,s,r);return i.slicePlane=this._context.slicePlaneEnabled,t.addRenderPlugin(i.slots,i),i}_getExternalColorParameters(e){const s={};return this._drivenProperties.color?s.externalColor=U:t(e)&&t(e.color)?s.externalColor=o.toUnitRGBA(e.color):(s.externalColor=U,s.colorMixMode="ignore"),s}destroy(){super.destroy();const e=this._context.stage;if(t(this._resources)){e.removeRenderPlugin(this._resources.lodRenderer),this._resources.lodRenderer.destroy();const s=this._resources.stageResources;for(const t of s.materials)e.remove(3,t.id);for(const t of s.textures)e.remove(4,t.id);for(const t of s.geometries)e.remove(2,t.id);t(this._resources.dispose)&&this._resources.dispose()}this._resources=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;const s=K(t.geometry);if(i(s))return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const r=this.setGraphicElevationContext(t,new F),a=e.renderingInfo;return this._createAs3DShape(t,s,a,r,t.uid)}notifyDestroyGraphicLayer(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(i(this._resources))return!0;const e=this._drivenProperties.opacity,t=!this.isPrimitive,r=this._resources.stageResources.materials,a=this._resources.originalMaterialParameters;for(let i=0;i<r.length;i++){const o=r[i],n=s(this.symbolLayer,"material","color"),l=a[i],c=this._getCombinedOpacity(n,{hasIntrinsicColor:t})*l.opacity;o.setParameterValues({opacity:c,transparent:c<1||e||l.transparent})}return!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,D)}slicePlaneEnabledChanged(){if(i(this._resources))return!0;this._resources.lodRenderer.slicePlane=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(i(this._resources))return!0;const{stageResources:e,isEsriSymbolResource:t,isWosr:s}=this._resources;for(const r of e.materials)this.isPrimitive?r.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t&&!s&&r.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!0}pixelRatioChanged(){return!0}applyRendererDiff(e,t){if(i(this._resources))return!0;const{stageResources:{materials:s},lodRenderer:r,resourceBoundingBox:a,symbolSize:o,resourceSize:n,pivotOffset:l}=this._resources;for(const i in e.diff)switch(i){case"visualVariables":if(!ee(this._fastUpdates,t,this._fastVisualVariableConvertOptions(a,o,n,l)))return!1;for(const e of s)e.setParameterValues(this._fastUpdates.materialParameters);r.notifyShaderTransformationChanged();break;default:return!1}return!0}computeComplexity(){if(i(this._resources))return super.computeComplexity();return{primitivesPerFeature:N(this._resources.lodResources.levels[0]).reduce(((e,t)=>e+t.data.getIndices(G.POSITION).length),0)/3,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:Z(this.symbol,this.symbolLayer)}}hasLodRenderer(){return t(this._resources)}_createAs3DShape(e,s,r,a,o){if(!this.hasLodRenderer()||i(this._resources))return null;const n=this.getFastUpdateAttrValues(e),l=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?I(r.color,r.opacity):null,c=this._context.clippingExtent;if(S(s,de,this._context.elevationProvider.spatialReference),t(c)&&!T(c,de))return null;const h=this._requiresTerrainElevation(a),d=this._computeGlobalTransform(s,a,pe,h?fe:null),m=this._computeLocalTransform(this._resources,this.symbolLayer,r,me),p=this._resources.lodRenderer.instanceData,u=p.addInstance();this._instanceIndexToGraphicUid.set(u,o),p.setLocalTransform(u,m,!1),p.setGlobalTransform(u,d),n&&p.setFeatureAttribute(u,n),l&&p.setColor(u,l);const f=new ae(this,u,M,a);return h&&(f.alignedSampledElevation=fe.sampledElevation),f.needsElevationUpdates=D(a.mode),Q(f,s,this._context.elevationProvider),f}_computeGlobalTransform(e,t,s,r){const i=A(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,r);return de[0]=e.x,de[1]=e.y,de[2]=i,L(e.spatialReference,de,s,this._context.renderCoordsHelper.spatialReference),s}_computeLocalTransform(e,t,s,r){return v(r),this._applyObjectRotation(s,!1,r),this._applyObjectRotation(t,!0,r),this._applyObjectScale(e,s,r),this._applyAnchor(e,t,r),r}_applyObjectScale(e,t,s){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._drivenProperties.size&&t.size?t.size:e.symbolSize,i=z(r,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===i[0]&&1===i[1]&&1===i[2]||x(s,s,i)}prepareSymbolLayerPatch(e){if("partial"!==e.diff.type)return;const t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t)}updateGeometry(e,t){if(i(this._resources))return!0;const s=t&&K(t);if(i(s))return!1;const r=this.getGeometryElevationMode(t);if(e.elevationContext.mode!==r)return!1;const a=this._requiresTerrainElevation(e.elevationContext);return this._computeGlobalTransform(s,e.elevationContext,pe,a?fe:null),a&&(e.alignedSampledElevation=fe.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,pe,!0),Q(e,s,this._context.elevationProvider),!0}_preparePatchTransform(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition))return;if(i(this._resources))return;const s=(e,t,s)=>a(null!=e&&"complete"===e.type?e.newValue:t,s),r=s(t.heading,this.symbolLayer.heading,0),o=s(t.tilt,this.symbolLayer.tilt,0),n=s(t.roll,this.symbolLayer.roll,0),l=s(t.width,this.symbolLayer.width,void 0),h=s(t.height,this.symbolLayer.height,void 0),d=s(t.depth,this.symbolLayer.depth,void 0),m=s(t.anchor,this.symbolLayer.anchor,void 0),p=s(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;const u={heading:r,tilt:o,roll:n,anchor:m,anchorPosition:p},f=this._resources;1===this.loadStatus&&e.symbolLayerStatePatches.push((()=>{f.symbolSize=c(ie(f.resourceSize,{width:l,height:h,depth:d,isPrimitive:this.symbolLayer.isPrimitive}))})),e.graphics3DGraphicPatches.push(((e,t)=>{const s=this._computeLocalTransform(f,u,t,me),r=e.instanceIndex;f.lodRenderer.instanceData.setLocalTransform(r,s,!0)}))}_preparePatchColor(e,s){if(!s.material||"partial"!==s.material.type)return;const r=s.material.diff;if(!r.color||"complete"!==r.color.type||null==r.color.newValue||null==r.color.oldValue)return;const a=r.color.newValue,n=t(a)?o.toUnitRGBA(a):U;delete r.color;const l=this._resources;i(l)||e.graphics3DGraphicPatches.push((e=>{let t;this._hasPerInstanceColor()?(l.lodRenderer.instanceData.setColor(e.instanceIndex,n),t=this.setMaterialTransparencyParams({},a)):t=this.setMaterialTransparencyParams({externalColor:n},a);for(const e of l.stageResources.materials)e.setParameterValues(t)}))}_requiresTerrainElevation(e){return"absolute-height"!==e.mode}_applyObjectRotation(e,t,s){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&t))return V(e.heading,e.tilt,e.roll,s)}_computeAnchor(e,s,r){const i=p();switch(r.anchor){case"center":y(i,B(e)),f(i,i);break;case"top":{const t=B(e);g(i,-t[0],-t[1],-e[5]);break}case"bottom":{const t=B(e);g(i,-t[0],-t[1],-e[2]);break}case"relative":{const t=B(e),s=w(e),a=r.anchorPosition,o=a?m(a.x,a.y,a.z):d;_(i,s,o),b(i,i,t),f(i,i);break}case"origin":default:t(s)?f(i,s):y(i,d)}return i}_applyAnchor(e,t,s){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._computeAnchor(e.resourceBoundingBox,e.pivotOffset,t);r&&R(s,s,r)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(e,s,r,i){const a=t(e)?c(w(e)):h,o=t(e)?this._computeAnchor(e,i,this.symbolLayer):d,n=this._context.renderCoordsHelper.unitInMeters,l=z(t(s)?s:void 0,s,r,n),p=m(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:a,symbolSize:t(s)?s:h,unitInMeters:n,transformation:{anchor:o,scale:l,rotation:p}}}}const de=p(),me=C(),pe=C(),ue=E(),fe={verticalDistanceToGround:0,sampledElevation:0};export default he;export{he as Graphics3DObjectSymbolLayer};
