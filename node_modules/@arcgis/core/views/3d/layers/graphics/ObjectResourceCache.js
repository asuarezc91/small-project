/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as e}from"../../../../core/maybe.js";import{timeoutHandle as t}from"../../../../core/handleUtils.js";import{create as r,isAborted as o,createAbortError as s,onAbort as i,createAbortController as a}from"../../../../core/promiseUtils.js";import l from"../../../../core/Handles.js";import{DefaultLoadingContext as n}from"../../glTF/DefaultLoadingContext.js";import{load as c}from"../../glTF/loader.js";import{load as h}from"./wosrLoader.js";class m{constructor(){this.gltfCache=new Map,this.wosrCache=new Map,this.evictHandles=new l}loadGLTF(e,t){const r=`gltf:${e}`;return this.fromCache(this.gltfCache,r,(t=>c(new n(t.streamDataRequester),e,t)),t)}loadWOSR(e,t){const r=`wosr:${e}:${t.disableTextures}`;return this.fromCache(this.wosrCache,r,(t=>h(e,t)),t)}destroy(){this.evictHandles.destroy(),this.gltfCache.clear(),this.wosrCache.clear()}get size(){return this.wosrCache.size+this.gltfCache.size}fromCache(t,l,n,c){return r(((r,h)=>{if(o(c))return void h(s());const m=i(c,(()=>{this.remove(t,l),h(s())})),f=t.get(l);if(f)return this.evictHandles.remove(l),f.refCount++,void f.item.then(r,h);const d=a(),C={...c,signal:d.signal},v={refCount:1,abortController:d,item:n(C).then((e=>(v.abortController=null,e.remove=()=>this.remove(t,l),e)))};t.set(l,v),v.item.then((t=>{e(m)&&m.remove(),r(t)}),(t=>{e(m)&&m.remove(),h(t)}))}))}remove(r,o){const s=r.get(o);s&&(s.refCount--,0===s.refCount&&this.evictHandles.add(t((()=>{r.delete(o),e(s.abortController)&&s.abortController.abort()}),f),o))}}let f=1e4;const d={overrideEvictDelay:e=>(f=e,{remove(){f=1e4}})};export{m as ObjectResourceCache,d as test};
