/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{c as e}from"../../../../chunks/vec3f64.js";import{i as t,s as i}from"../../../../chunks/vec3.js";import{a as n}from"../../../../chunks/mat4f64.js";import{create as s,empty as a,expandWithVec3 as r,isPoint as o,center as h,offset as l}from"../../../../geometry/support/aaBoundingBox.js";import{generateObject3DStateId as d}from"../../webgl-engine/lib/Object3DStateSet.js";import{demResolutionForBoundingBox as c}from"./graphicUtils.js";import{setContextFeature as g}from"./featureExpressionInfoUtils.js";const u=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],m=e(),p=e(),f=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],x=n();export default class{constructor(e,t,i,n){this.graphics3DSymbolLayer=e,this.instanceIndex=t,this.elevationAligner=i,this.elevationContext=n,this.type="lod-instance",this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}initialize(){}setVisibility(e){const t=this.lodRenderer.instanceData;e!==t.getVisible(this.instanceIndex)&&t.setVisible(this.instanceIndex,e)}destroy(){null!=this.instanceIndex&&(this.lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(e,t,i){if(this.elevationAligner){g(this.elevationContext.featureExpressionInfoContext,i);const n=this.elevationAligner(this,this.elevationContext,e,t);null!=n&&(this.alignedSampledElevation=n)}}getBSRadius(){const e=this.lodRenderer;return e.baseBoundingSphere.radius*e.instanceData.getCombinedMaxScaleFactor(this.instanceIndex)}getCenterObjectSpace(i=e()){return this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,x),t(i,this.lodRenderer.baseBoundingSphere.center,x)}getBoundingBoxObjectSpace(e=s()){this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,x);const n=this.lodRenderer.baseBoundingBox;a(e);for(let s=0;s<8;++s)i(m,0==(1&s)?n[0]:n[3],0==(2&s)?n[1]:n[4],0==(4&s)?n[2]:n[5]),t(m,m,x),r(e,m);return e}computeAttachmentOrigin(e){this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,x),e.render.origin[0]+=x[12],e.render.origin[1]+=x[13],e.render.origin[2]+=x[14],e.render.num++}async getProjectedBoundingBox(e,i,n,s,r){const d=this.getBoundingBoxObjectSpace(r),g=f,v=o(d)?1:g.length;this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,x);for(let e=0;e<v;e++){const i=g[e];m[0]=d[i[0]],m[1]=d[i[1]],m[2]=d[i[2]],t(m,m,x),u[3*e+0]=m[0],u[3*e+1]=m[1],u[3*e+2]=m[2]}if(!e(u,0,v))return null;a(d);let b=null;this.calculateRelativeScreenBounds&&(b=this.calculateRelativeScreenBounds());for(let e=0;e<3*v;e+=3){for(let t=0;t<3;t++)d[t]=Math.min(d[t],u[e+t]),d[t+3]=Math.max(d[t+3],u[e+t]);b&&n.push({location:u.slice(e,e+3),screenSpaceBoundingRect:b})}if(i&&(h(d,p),"absolute-height"!==this.elevationContext.mode)){let e;const t=c(d,i);try{e=await i.service.queryElevation(p[0],p[1],s,t,"ground")}catch(t){e=null}null!=e&&l(d,0,0,-this.alignedSampledElevation+e)}return d}addObjectState(e,t){if(0===e){const i=d(e);this.addHighlightId(i),t.addExternal((e=>{this.removeHighlightId(e)}),i)}}removeObjectState(e){this.highlights&&this.highlights.forEach((t=>e.remove(t)))}addHighlightId(e){this.highlights=this.highlights||new Set,this.highlights.add(e),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}removeHighlightId(e){this.highlights&&(this.highlights.delete(e),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,this.highlights.size>0),0===this.highlights.size&&(this.highlights=null))}get lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}}
