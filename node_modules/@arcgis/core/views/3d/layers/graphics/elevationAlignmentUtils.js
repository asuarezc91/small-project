/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{neverReached as e}from"../../../../core/compilerUtils.js";import{c as t}from"../../../../chunks/vec3f64.js";import{c as n}from"../../../../chunks/mat4.js";import{projectBuffer as o,computeLinearTransformation as r}from"../../../../geometry/projection.js";import{a as i}from"../../../../chunks/mat4f64.js";import{isDehydratedPoint as s}from"../../../../layers/graphics/dehydratedFeatures.js";import{isSamplePosition as a,getElevationAtPoint as l}from"../../support/ElevationProvider.js";import{updateVertexAttributeAuxpos1w as c}from"./graphicUtils.js";function u(e,t,n,r,i,s,a,l,c,u,f){const m=E[f.mode];let d,p,g=0;if(o(e,t,n,r,c.spatialReference,i,l))return m.requiresAlignment(f)?(g=m.applyElevationAlignmentBuffer(r,i,s,a,l,c,u,f),d=s,p=a):(d=r,p=i),o(d,c.spatialReference,p,s,u.spatialReference,a,l)?g:void 0}function f(t,n,o,r,i){const c=(s(t)?t.z:a(t)?t.array[t.offset+2]:t[2])||0;switch(o.mode){case"on-the-ground":{const e=l(n,t,"ground")||0;return i&&(i.verticalDistanceToGround=0,i.sampledElevation=e),e}case"relative-to-ground":{const e=l(n,t,"ground")||0,s=o.geometryZWithOffset(c,r);return i&&(i.verticalDistanceToGround=s,i.sampledElevation=e),s+e}case"relative-to-scene":{const e=l(n,t,"scene")||0,s=o.geometryZWithOffset(c,r);return i&&(i.verticalDistanceToGround=s,i.sampledElevation=e),s+e}case"absolute-height":{const e=o.geometryZWithOffset(c,r);if(i){const o=l(n,t,"ground")||0;i.verticalDistanceToGround=e-o,i.sampledElevation=o}return e}default:return e(o.mode),0}}function m(e,t,n){return null==t||null==n?e.definedChanged:"on-the-ground"===t&&"on-the-ground"===n?e.staysOnTheGround:t===n||"on-the-ground"!==t&&"on-the-ground"!==n?v.UPDATE:e.onTheGroundChanged}function d(e){return"relative-to-ground"===e||"relative-to-scene"===e}function p(e){return"absolute-height"!==e}function g(e,t,o,i,s){const a=f(t,o,s,i,y);c(e,y.verticalDistanceToGround);const l=y.sampledElevation,u=n(h,e.objectTransformation);A[0]=t.x,A[1]=t.y,A[2]=a;return r(t.spatialReference,A,u,i.spatialReference)?e.objectTransformation=u:console.warn("Could not locate symbol object properly, it might be misplaced"),l}var v;!function(e){e[e.NONE=0]="NONE",e[e.UPDATE=1]="UPDATE",e[e.RECREATE=2]="RECREATE"}(v||(v={}));const E={"absolute-height":{applyElevationAlignmentBuffer:function(e,t,n,o,r,i,s,a){const l=a.calculateOffsetRenderUnits(s),c=a.featureExpressionInfoContext;t*=3,o*=3;for(let i=0;i<r;++i){const r=e[t+0],i=e[t+1],s=e[t+2];n[o+0]=r,n[o+1]=i,n[o+2]=null==c?s+l:l,t+=3,o+=3}return 0},requiresAlignment:function(e){const t=e.meterUnitOffset,n=e.featureExpressionInfoContext;return 0!==t||null!=n}},"on-the-ground":{applyElevationAlignmentBuffer:function(e,t,n,o,r,i){let s=0;const a=i.spatialReference;t*=3,o*=3;for(let l=0;l<r;++l){const r=e[t+0],l=e[t+1],c=e[t+2],u=i.getElevation(r,l,c,a,"ground")||0;s+=u,n[o+0]=r,n[o+1]=l,n[o+2]=u,t+=3,o+=3}return s/r},requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:function(e,t,n,o,r,i,s,a){let l=0;const c=a.calculateOffsetRenderUnits(s),u=a.featureExpressionInfoContext,f=i.spatialReference;t*=3,o*=3;for(let s=0;s<r;++s){const r=e[t+0],s=e[t+1],a=e[t+2],m=i.getElevation(r,s,a,f,"ground")||0;l+=m,n[o+0]=r,n[o+1]=s,n[o+2]=null==u?a+m+c:m+c,t+=3,o+=3}return l/r},requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:function(e,t,n,o,r,i,s,a){let l=0;const c=a.calculateOffsetRenderUnits(s),u=a.featureExpressionInfoContext,f=i.spatialReference;t*=3,o*=3;for(let s=0;s<r;++s){const r=e[t+0],s=e[t+1],a=e[t+2],m=i.getElevation(r,s,a,f,"scene")||0;l+=m,n[o+0]=r,n[o+1]=s,n[o+2]=null==u?a+m+c:m+c,t+=3,o+=3}return l/r},requiresAlignment:()=>!0}},h=i(),y={verticalDistanceToGround:0,sampledElevation:0},A=t();export{v as SymbolUpdateType,g as applyElevationAlignmentForHUD,u as applyPerVertexElevationAlignment,m as elevationModeChangeUpdateType,f as evaluateElevationAlignmentAtPoint,d as needsElevationUpdates2D,p as needsElevationUpdates3D};
