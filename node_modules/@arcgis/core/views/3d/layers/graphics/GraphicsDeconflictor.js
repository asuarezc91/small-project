/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import"../../../../core/has.js";import{isSome as t}from"../../../../core/maybe.js";import"../../../../core/Logger.js";import"../../../../core/accessorSupport/ensureType.js";import"../../../../core/accessorSupport/decorators/property.js";import{subclass as i}from"../../../../core/accessorSupport/decorators/subclass.js";import"../../../../core/urlUtils.js";import"../../../../core/uuid.js";import"../../../../portal/support/resourceExtension.js";import s from"../../../../core/Handles.js";import{init as r}from"../../../../core/watchUtils.js";import{Task as a}from"../../../support/Scheduler.js";import{someMap as o}from"../../../../core/MapUtils.js";import{boundedPlane as c}from"../../support/geometryUtils.js";import{Deconflictor as n,DeconflictorViewState as h,DeconflictorGraphic as l}from"./Deconflictor.js";import{LabelDeconflictor as p}from"./LabelDeconflictor.js";let d=class extends n{constructor(){super(...arguments),this._handles=new s,this._contexts=new Map,this._viewState=new h,this.visibilityGroup=0,this._iconMarginFactor=-.1}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._handles.add([this.view.watch("state.camera",(()=>{this.updateViewState(),this.setDirty()})),this.view.watch("map.ground.opacity",((e,t)=>{1!==e&&1!==t||this.setDirty()})),r(this.view,"slicePlane",(()=>{this.updateSlicePlane(),this.slicePlaneChanged()}))]),this._frameTask=this.view.resourceController.scheduler.registerTask(a.GRAPHICS_DECONFLICTOR,(e=>this.update(e)),(()=>this.needsUpdate())),this._labels=new p({view:this.view,parent:this})}destroy(){this._labels.destroy(),this._labels=null,this._handles.destroy(),this._handles=null,this._frameTask&&(this._frameTask.remove(),this._frameTask=null)}get iconMarginFactor(){return this._iconMarginFactor}set iconMarginFactor(e){this._iconMarginFactor=e,this.setDirty()}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}update(e){super.update(e),this.needsUpdate()||this._labels.setDirty()}setInitialIconVisibilityFlag(e,t){const i=!(this._graphicSupportsDeconfliction(t)&&u(e));t.setVisibilityFlag(3,i,0)}updateViewState(){this.view&&this.view.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this.updateSlicePlane())}updateSlicePlane(){const e=this.view?this.view.slicePlane:null;t(e)&&c.transform(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=t(e)}slicePlaneChanged(){o(this._contexts,((e,t)=>t.symbolCreationContext.slicePlaneEnabled))&&this.setDirty()}addGraphicsOwner(e){let t=this._contexts.get(e);return null==t&&(t=new Map,this._contexts.set(e,t),this.setDirty()),{addGraphic:i=>this.addGraphic(e,t,i),removeGraphic:e=>this.removeGraphic(t,e),labelingInfoChange:()=>this._labels.enabledChanged(e,t),featureReductionChange:()=>this.enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach((e=>this.removeGraphic(t,e.graphics3DGraphic)))}}removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach((e=>this.removeGraphic(t,e.graphics3DGraphic))),this._contexts.delete(e),this.setDirty())}addGraphic(e,t,i){const s=i.graphic.uid,r=new l(i,e.symbolCreationContext.slicePlaneEnabled);t.set(s,r),u(e)&&this.addToActiveGraphics(r),e.labelsEnabled&&this._labels.addToActiveGraphics(r)}removeGraphic(e,t){const i=t.graphic.uid,s=e.get(i);s&&(this.removeFromActiveGraphics(s),this._labels.removeFromActiveGraphics(s),e.delete(i),this.setDirty())}enabledChanged(e,t){const i=u(e);i||function(e){const t=e.graphics3DGraphics;t&&t.forEach((e=>e.clearVisibilityFlag(3)))}(e),this.modifyGraphics(t,i)}_slicePlaneEnabledChanged(e,t){const i=e.symbolCreationContext.slicePlaneEnabled;t.forEach((e=>e.slicePlaneEnabled=i)),this.setDirty()}getGraphicsLayers(e){return e._graphics}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e._graphics;if(!t||!t.length)return!1;for(const e of t)if(this.layerSupportsDeconfliction(e))return!0;return!1}};function u(e){const t=e.layer;return!(!t||!t.featureReduction||"selection"!==t.featureReduction.type)}d=e([i("esri.views.3d.layers.graphics.GraphicsDeconflictor")],d);export{d as GraphicsDeconflictor};
