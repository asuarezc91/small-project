/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as e,isNone as i}from"../../../../core/maybe.js";import t from"../../../../core/ObjectPool.js";import r from"../../../../geometry/Polygon.js";import{forEach as s}from"../../../../core/asyncUtils.js";import{c as a}from"../../../../chunks/vec3f64.js";import{s as o,a as h}from"../../../../chunks/vec3.js";import{create as n,allFinite as c}from"../../../../geometry/support/aaBoundingRect.js";import{projectBoundingRect as l}from"../../../../geometry/projection.js";import{convertFromGeometry as p}from"../../../../layers/graphics/featureConversionUtils.js";import{a as y}from"../../../../chunks/vec2f64.js";import{a as m}from"../../../../chunks/vec2.js";import{set as u,ZERO as d,empty as g,expandWithAABB as b,allFinite as f,toRect as _}from"../../../../geometry/support/aaBoundingBox.js";import{computeAABR as G,estimateAttributesObjectSize as E,numVertices as x}from"../../../../layers/graphics/dehydratedFeatures.js";import{createFeature as S}from"./featureExpressionInfoUtils.js";const j=new t(Array,(e=>u(e,d)),null,10,5),v=n();export default class{constructor(i,t,r,s,a){this._labelGraphics=new Array,this._auxiliaryGraphics=new Array,this._visibilityFlags=function(e,i){const t=new Array(e);for(let e=0;e<t.length;e++)t[e]=new Array(i);return t}(2,4),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++t.referenced,this.graphics3DSymbol=t,this.graphic=i,this._graphics=r,this._featureExpressionFeature=a?S(a,i,s):null;for(const i of this._graphics)e(i)&&(this.isElevationSource=this.isElevationSource||i.isElevationSource)}get labelGraphics(){return this._labelGraphics}get extent(){return this._extent}initialize(e,i,t){this._layer=i,this._stage=e,this.forEachSymbolLayerGraphic((r=>{r.initialize(e,i,t),r.setVisibility(this.isVisible())}))}destroy(){this.forEachSymbolLayerGraphic((e=>e.destroy())),this._graphics=null,this._auxiliaryGraphics=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return null==this._graphics}clearLabelGraphics(){this.forEachLabelGraphic((e=>e.destroy())),this._labelGraphics.length=0}addLabelGraphic(e,i,t){this._labelGraphics.push(e),e.initialize(i,t),e.setVisibility(this.isVisible(1))}addAuxiliaryGraphic(e){this._auxiliaryGraphics.push(e),this._layer&&(e.initialize(this._stage,this._layer),e.setVisibility(this.isVisible()))}get isDraped(){let e=!1;return this.forEachSymbolLayerGraphic((i=>{"draped"===i.type&&(e=!0)})),e}isVisible(e=0,i){for(let t=0;t<=e;t++){const e=this._visibilityFlags[t];for(let t=0;t<e.length;++t)if(!1===e[t]&&t!==i)return!1}return!0}hasVisibilityFlag(e,i){return null!=this._visibilityFlags[i][e]}setVisibilityFlag(e,i,t){const r=this.isVisible(t);this._visibilityFlags[t][e]=i;const s=this.isVisible(t);if(r===s)return!1;if(1===t)this.forEachLabelGraphic((e=>e.setVisibility(s)));else{this.forEachSymbolLayerGraphic((e=>e.setVisibility(s)));const e=this.isVisible(1);this.forEachLabelGraphic((i=>i.setVisibility(e)))}return!0}clearVisibilityFlag(e,i=0){return this.setVisibilityFlag(e,void 0,i)}getBSRadius(){let e=0;return this.forEachSymbolLayerGraphic((i=>{e=Math.max(e,i.getBSRadius())})),e}getCenterObjectSpace(i=a()){if(0===this._graphics.length)return o(i,0,0,0),i;const t=this._graphics[0];return e(t)?t.getCenterObjectSpace(i):i}computeExtent(e){if(!this._extent){const t=this.graphic.geometry;if(i(t))return!1;this._extent=n(),G(t,this._extent);const r=t.spatialReference;if(!r.equals(e)&&!l(this._extent,r,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,i){return this._optimizedGeometry.geometry&&this._optimizedGeometry.hasZ===e&&this._optimizedGeometry.hasM===i||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,i),this._optimizedGeometry.hasZ=e,this._optimizedGeometry.hasM=i),this._optimizedGeometry.geometry}_convertGraphicToOptimizedGeometry(e,i,t){let s=e.geometry;return"mesh"!==s.type&&"extent"!==s.type||(s=r.fromExtent("mesh"===s.type?s.extent:s)),p(s,i,t)}get usedMemory(){let e=E(this.graphic.attributes);return this.forEachSymbolLayerGraphic((t=>{const r=t.graphics3DSymbolLayer.complexity;if(i(r))return;const s="draped"===t.type?r.memory.draped:r.memory;e+=s.bytesPerFeature,s.bytesPerCoordinate&&(e+=x(this.graphic.geometry)*s.bytesPerCoordinate)})),e}computeAttachmentOrigin(){const e={render:{origin:a(),num:0},draped:{origin:y(),num:0}};for(const t of this._graphics)i(t)||t.computeAttachmentOrigin(e);return e.render.num&&h(e.render.origin,e.render.origin,1/e.render.num),e.draped.num&&m(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(e,t,r,a,o){return o||(o={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),o.boundingBox?g(o.boundingBox):o.boundingBox=g(),o.requiresDrapedElevation=!1,await s(this._graphics,(async s=>{if(i(s))return;const h="draped"===s.type?t:e,n=j.acquire(),c=await s.getProjectedBoundingBox(h,r,o.screenSpaceObjects,a,n);isFinite(c[2])&&isFinite(c[5])||(o.requiresDrapedElevation=!0),c&&b(o.boundingBox,n),j.release(n)})),f(o.boundingBox)||c(_(o.boundingBox,v))?o:null}needsElevationUpdates(){for(const i of this._graphics)if(e(i)&&("object3d"===i.type||"lod-instance"===i.type)&&i.needsElevationUpdates)return!0;for(const e of this._labelGraphics)if(e&&e.needsElevationUpdates)return!0;return!1}alignWithElevation(e,i,t){this.forEachRenderedGraphic((r=>{"object3d"!==r.type&&"lod-instance"!==r.type||r.alignWithElevation(e,i,this._featureExpressionFeature,t)}))}addObjectStateSet(e,i){this.forEachSymbolLayerGraphic((t=>t.addObjectState(e,i)))}removeObjectState(e){this.forEachSymbolLayerGraphic((i=>i.removeObjectState(e)))}forEachGraphicList(e,i){e.forEach((e=>e&&i(e)))}forEachSymbolLayerGraphic(e){this.forEachGraphicList(this._graphics,e),this.forEachGraphicList(this._auxiliaryGraphics,e)}forEachLabelGraphic(e){this.forEachGraphicList(this._labelGraphics,e)}forEachRenderedGraphic(e){this.forEachSymbolLayerGraphic(e),this.forEachLabelGraphic(e)}}
