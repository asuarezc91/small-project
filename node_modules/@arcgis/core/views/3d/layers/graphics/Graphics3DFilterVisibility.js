/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import"../../../../core/has.js";import{isNone as t,isSome as i}from"../../../../core/maybe.js";import r from"../../../../core/Logger.js";import"../../../../core/accessorSupport/ensureType.js";import{property as s}from"../../../../core/accessorSupport/decorators/property.js";import{subclass as h}from"../../../../core/accessorSupport/decorators/subclass.js";import"../../../../core/urlUtils.js";import"../../../../core/uuid.js";import"../../../../portal/support/resourceExtension.js";import{isAbortError as o}from"../../../../core/promiseUtils.js";import l from"../../../../core/Accessor.js";import a from"../../../../core/Handles.js";import{on as n}from"../../../../core/watchUtils.js";import{Task as u}from"../../../support/Scheduler.js";import c from"../../../layers/support/FeatureFilter.js";import d from"./QueryEngine.js";const y=r.getLogger("esri.views.3d.layers.graphics.Graphics3DFilterVisibility");let p=class extends l{constructor(...e){super(...e),this.filter=null,this._dirty=!1,this._querying=!1,this._handles=new a}get updating(){return this._dirty||this._querying||null!=this._queryResult}setup(e,t){this._layerView=e,this._core=t,this._objectIdField=e.layer.objectIdField,this._queryEngine=new d({layerView:this._layerView,task:u.FILTER_VISIBILITY});const i=this._layerView.view.resourceController.scheduler;this._handles.add(i.registerTask(u.FILTER_VISIBILITY,(e=>this._update(e)),(()=>this._needsUpdate()))),this._handles.add(n(t.owner,"loadedGraphics","after-changes",(e=>this._graphicsChanged(e)),(()=>this.dirty=!0))),this.filterChanged()}destroy(){this._handles.destroy(),this._handles=null,this.clear(),this._layerView=null,this._core=null}clear(){this._queryEngine.clear()&&(this._core.modifyGraphics3DGraphicVisibilities((e=>e.clearVisibilityFlag(2))),this._queryResult=null,this._querying=!1),this.dirty=!1,this.notifyChange("updating")}_graphicsChanged(e){this._queryEngine&&0==(1&e.type)||(this.dirty=!0)}updateVisibility(e){this.active&&(e.hasVisibilityFlag(2,0)||e.setVisibilityFlag(2,!1,0),this.dirty=!0)}filterChanged(){const e=this.recomputeFilter();e!==this.filter&&(this.filter=e,this.dirty=!0)}get active(){return this.filter&&this._core.graphics3DGraphics.size>0}recomputeFilter(){const e="filter"in this._layerView?this._layerView.filter:null,r="timeExtent"in this._layerView?this._layerView.timeExtent:null;if(t(r))return e;const s=i(e)?e.clone():new c;return s.timeExtent=i(s.timeExtent)?s.timeExtent.intersection(r):r,s}_needsUpdate(){return this._dirty&&!this._querying||null!=this._queryResult}_update(e){this.active?(!this._dirty||this._querying||e.done||(this._querying=!0,this.dirty=!1,this._queryEngine.executeQueryForIdSet(this.filter).then((e=>{this._queryResult=e,this._querying=!1})).catch((e=>{o(e)||(y.warn("FeatureFilter query failed: "+e,{error:e}),this._queryResult=new Set,this._core.graphics3DGraphics.forEach((e=>this._queryResult.add(this._getFeatureId(e.graphic)))),this._querying=!1)})),e.madeProgress()),this._queryResult&&!e.done&&(this._core.modifyGraphics3DGraphicVisibilities((t=>{if(e.done)return!1;const i=this._queryResult.has(this._getFeatureId(t.graphic));return!!t.setVisibilityFlag(2,i,0)&&(e.madeProgress(),!0)})),e.done||(this._queryResult=null)),this.notifyChange("updating")):this.clear()}_getFeatureId(e){return null==e.objectId?e.attributes[this._objectIdField]:e.objectId}set dirty(e){this._dirty!==e&&(this._dirty=e,this.notifyChange("updating"))}};e([s({readOnly:!0})],p.prototype,"updating",null),p=e([h("esri.views.3d.layers.graphics.Graphics3DFilterVisibility")],p);export{p as Graphics3DFilterVisibility};
