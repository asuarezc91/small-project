/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{c as e}from"../../../../chunks/vec3f64.js";import{s as t}from"../../../../chunks/vec3.js";import{create as i}from"../../../../geometry/support/aaBoundingRect.js";import{create as r,empty as s,expandWithRect as o,center as a,set as n,toRect as d}from"../../../../geometry/support/aaBoundingBox.js";import{demResolutionForBoundingBox as h}from"./graphicUtils.js";const c=i(),l=r(),m=e();export default class{constructor(e,t,i){this.graphics3DSymbolLayer=e,this.renderGeometries=t,this.boundingBox=i,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this._layerView=null,this.isElevationSource=!1}initialize(e,t,i){this.stage=e,this._layerView=i,this._overlayRenderer=this._layerView.view.basemapTerrain.overlayManager.renderer}setVisibility(e){if(null!=this.stage&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._overlayRenderer.addGeometries(this.renderGeometries,this._layerView,1);if(e||this._addedToStage){for(const e of this.renderGeometries)e.instanceParameters.visible=this._visible;this._overlayRenderer.updateGeometries(this.renderGeometries,this._layerView,1)}}}destroy(){this.stage&&this._addedToStage&&this._overlayRenderer.removeGeometries(this.renderGeometries,this._layerView,4),this._addedToStage=!1,this._visible=!1,this.stage=null}getBSRadius(){return this.renderGeometries.reduce(((e,t)=>Math.max(e,t.bsRadius)),0)}getCenterObjectSpace(i=e()){return t(i,0,0,0)}getBoundingBoxObjectSpace(e=r()){return s(e)}addObjectState(e,t){0===e&&(this.renderGeometries.forEach((e=>{const i=e.addHighlight();t.addRenderGeometry(e,i,this)})),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._layerView))}removeObjectState(e){this.renderGeometries.forEach((t=>{e.removeRenderGeometry(t)}))}removeRenderGeometryObjectState(e,t){e.removeHighlight(t),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._layerView)}computeAttachmentOrigin(e){for(const t of this.renderGeometries)t.computeAttachmentOrigin(m)&&(e.draped.origin[0]+=m[0],e.draped.origin[1]+=m[1],e.draped.num++)}async getProjectedBoundingBox(e,t,i,r,n){s(n);for(let t=0;t<this.renderGeometries.length;t++){const r=this.renderGeometries[t];this._getRenderGeometryProjectedBoundingRect(r,e,c,i),o(n,c)}if(t){let e;a(n,m);const i=h(n,t);try{e=await t.service.queryElevation(m[0],m[1],r,i,"ground")}catch(t){e=null}null!=e&&(n[2]=Math.min(n[2],e),n[5]=Math.max(n[5],e))}return n}_getRenderGeometryProjectedBoundingRect(e,t,i,r){if(this.boundingBox)n(l,this.boundingBox);else{const t=e.center,i=e.bsRadius;l[0]=t[0]-i,l[1]=t[1]-i,l[2]=t[2]-i,l[3]=t[0]+i,l[4]=t[1]+i,l[5]=t[2]+i}return t(l,0,2),this.calculateRelativeScreenBounds&&r.push({location:a(l),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),d(l,i)}}
