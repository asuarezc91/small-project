/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isNone as e,isSome as t}from"../../../../core/maybe.js";import{c as i}from"../../../../chunks/vec3f64.js";import{g as s,i as a,b as n}from"../../../../chunks/vec3.js";import{create as r,isPoint as o,empty as h,center as l,offset as c,setMin as g,setMax as d}from"../../../../geometry/support/aaBoundingBox.js";import{demResolutionForBoundingBox as u}from"./graphicUtils.js";import{setContextFeature as b}from"./featureExpressionInfoUtils.js";class j{constructor(e,t,i,s,a,n,r,o=null){this.uniqueGeometries=i,this.uniqueMaterials=s,this.uniqueTextures=a,this.elevationAligner=n,this.elevationContext=r,this._edgeState=o,this.type="object3d",this.stageLayer=null,this.stage=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.graphics3DSymbolLayer=e,this.stageObject=t}get isElevationSource(){return!(!this.stageObject.metadata||!this.stageObject.metadata.isElevationSource)}initialize(e,t){if(this.stageLayer=t,this.stage=e,this.uniqueMaterials)for(let t=0;t<this.uniqueMaterials.length;t++)e.add(3,this.uniqueMaterials[t]);if(this.uniqueGeometries)for(let t=0;t<this.uniqueGeometries.length;t++)e.add(2,this.uniqueGeometries[t]);if(this.uniqueTextures)for(let t=0;t<this.uniqueTextures.length;t++)e.add(4,this.uniqueTextures[t]);e.add(1,this.stageObject)}layerOpacityChanged(t,i){if(e(this._edgeState))return;const s=O(this._edgeState.baseMaterial);let a=!1;for(const e of this._edgeState.edgeMaterials)e.objectTransparency!==s&&(e.objectTransparency=s,a=!0);a&&this.resetEdgeObject(i);this.stage.renderView.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[t])}slicePlaneEnabledChanged(t,i){if(e(this._edgeState))return;this.stage.renderView.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{slicePlaneEnabled:t},!i),this._edgeState.properties.slicePlaneEnabled=t}setVisibility(e){if(null!=this.stage&&this._visible!==e&&(this._visible=e,this._visible?this._addedToStage?this.stageObject.setVisible(!0):(this.stageLayer.addObject(this.stageObject),this._addedToStage=!0):this.stageObject.setVisible(!1),t(this._edgeState))){const t=this.stage.renderView.ensureEdgeView();t.hasObject(this.stageObject)?t.updateObjectVisibility(this.stageObject,e):e&&this.addOrUpdateEdgeObject(t,!1)}}get visible(){return this._visible}destroy(){const e=this.stage;if(this.stageLayer){if(this.uniqueMaterials)for(let t=0;t<this.uniqueMaterials.length;t++)e.remove(3,this.uniqueMaterials[t].id);if(this.uniqueGeometries)for(let t=0;t<this.uniqueGeometries.length;t++)e.remove(2,this.uniqueGeometries[t].id);if(this.uniqueTextures)for(let t=0;t<this.uniqueTextures.length;t++)e.remove(4,this.uniqueTextures[t].id)}e.remove(1,this.stageObject.id),this._addedToStage&&(this.stageLayer.removeObject(this.stageObject),this._addedToStage=!1);const t=this.stage.renderView.ensureEdgeView();t.hasObject(this.stageObject)&&t.removeObject(this.stageObject),this.stageObject.dispose(),this._visible=!1,this.stageLayer=null,this.stage=null}alignWithElevation(e,i,s,a){if(null==this.elevationAligner)return;t(s)&&b(this.elevationContext.featureExpressionInfoContext,s);const n=this.elevationAligner(this,this.elevationContext,e,i);null!=n&&(this.alignedSampledElevation=n),this.resetEdgeObject(a)}getBSRadius(){return this.stageObject.getBSRadius()}getCenterObjectSpace(e=i()){return s(e,this.stageObject.getCenter(!0))}getBoundingBoxObjectSpace(e=r()){return function(e,t,i){i||(i=r());return g(i,e.getBBMin(t)),d(i,e.getBBMax(t)),i}(this.stageObject,!0,e)}computeAttachmentOrigin(e){for(const t of this.stageObject.geometryRecords)t.computeAttachmentOrigin(p)&&(a(p,p,this.stageObject.objectTransformation),n(e.render.origin,e.render.origin,p),e.render.num++)}async getProjectedBoundingBox(e,t,i,s,n){const r=this.getBoundingBoxObjectSpace(n),g=v,d=o(r)?1:g.length;for(let e=0;e<d;e++){const t=g[e];f[0]=r[t[0]],f[1]=r[t[1]],f[2]=r[t[2]],a(f,f,this.stageObject.objectTransformation),m[3*e+0]=f[0],m[3*e+1]=f[1],m[3*e+2]=f[2]}if(!e(m,0,d))return null;h(r);let b=null;this.calculateRelativeScreenBounds&&(b=this.calculateRelativeScreenBounds());for(let e=0;e<3*d;e+=3){for(let t=0;t<3;t++)r[t]=Math.min(r[t],m[e+t]),r[t+3]=Math.max(r[t+3],m[e+t]);b&&i.push({location:m.slice(e,e+3),screenSpaceBoundingRect:b})}if(t&&t.service&&"absolute-height"!==this.elevationContext.mode){l(r,p);const e="relative-to-scene"===this.elevationContext.mode?"scene":"ground";let i;if(t.useViewElevation)i=t.service.getElevation(p[0],p[1],e);else try{const a=u(r,t);i=await t.service.queryElevation(p[0],p[1],s,a,e)}catch(e){i=null}c(r,0,0,-this.alignedSampledElevation+i)}return r}addObjectState(e,t){0===e&&t.addObject(this.stageObject,this.stageObject.highlight()),1===e&&t.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeObject(this.stageObject)}resetEdgeObject(t){if(e(this._edgeState))return;const i=this.stage.renderView.ensureEdgeView();this._visible?this.addOrUpdateEdgeObject(i,t):i.removeObject(this.stageObject)}addOrUpdateEdgeObject(t,i){const s=this._edgeState;if(e(s))return;const a=O(s.baseMaterial);for(const e of s.edgeMaterials)e.objectTransparency=a;t.addOrUpdateObject3D(this.stageObject,s.edgeMaterials,s.properties,!i)}}function O(e){return e.isVisible?e.params.transparent?1:2:0}!function(e){let t;!function(e){e[e.REMOVE_OBJECT=0]="REMOVE_OBJECT",e[e.HIDE_FACERANGE=1]="HIDE_FACERANGE"}(t=e.VisibilityModes||(e.VisibilityModes={}))}(j||(j={}));const m=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],f=i(),p=i(),v=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];var E=j;export default E;
