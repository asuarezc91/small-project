/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as e,get as t,isNone as i,unwrap as r}from"../../../../core/maybe.js";import n from"../../../../Color.js";import{pt2px as a}from"../../../../core/screenUtils.js";import{I as o}from"../../../../chunks/mat4f64.js";import{earcut as s}from"../../../../core/libs/earcut/earcut.js";import{BufferViewVec3f64 as l,BufferViewVec4f as u}from"../../support/buffer/BufferView.js";import{empty as p,expandWithBuffer as d,intersectsClippingArea as h,expandWithAABB as c,create as m}from"../../../../geometry/support/aaBoundingBox.js";import{VertexAttrConstants as _}from"../../webgl-engine/lib/Util.js";import y from"../../webgl-engine/lib/Object3D.js";import{mixinColorAndOpacity as f}from"./graphicUtils.js";import{elevationModeChangeUpdateType as g,SymbolUpdateType as b,needsElevationUpdates2D as E}from"./elevationAlignmentUtils.js";import{PatternMaterial as M}from"../../webgl-engine/materials/PatternMaterial.js";import{createMapSpaceUVCoords as v,createMapSpaceUVCoordsDraped as x}from"../support/uvUtils.js";import{uvElevationAligner as O}from"./ElevationAligners.js";import{ElevationContext as A}from"./ElevationContext.js";import D from"./Graphics3DObject3DGraphicLayer.js";import P from"../../webgl-engine/lib/Geometry.js";import{Graphics3DSymbolLayer as U}from"./Graphics3DSymbolLayer.js";import{RibbonLineMaterial as w}from"../../webgl-engine/materials/RibbonLineMaterial.js";import{createStipplePattern as S}from"../../webgl-engine/materials/lineStippleUtils.js";import{geometryAsPolygon as T,geometryToRenderInfo as G,createColorGeometryData as C,geometryToRenderInfoDraped as j}from"./polygonUtils.js";import B from"./Graphics3DDrapedGraphicLayer.js";import L from"../../webgl-engine/lib/RenderGeometry.js";import{createGeometryData as R}from"./lineUtils.js";import{NativeLineMaterial as N}from"../../webgl-engine/materials/NativeLineMaterial.js";import{createMaterial as V}from"../support/patternUtils.js";class F extends U{constructor(e,t,i,r){super(e,t,i,r),this._needsUV=!1,this._hasOutline=!1}async doLoad(){}ensureMaterials(){this.ensureFillMaterial(),this.ensureOutlineMaterial()}ensureFillMaterial(){if(e(this._material))return;const i=t(this.symbolLayer,"material","color"),r=this._getCombinedOpacityAndColor(i);this._material=V(this.symbolLayer,{color:r,transparent:r[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,vertexColors:!0,writeLinearDepth:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},{isDraped:this.draped,idHint:this._getIdHint()}),this._needsUV=this._material instanceof M,this._context.stage.add(3,this._material)}ensureOutlineMaterial(){const t=this.symbolLayer.outline;if(e(this._outlineMaterial)||!this._isValidOutline(t))return;this._hasOutline=!0;this._outlineMaterial=(e=>{const i=t.stipplePattern?S(t.stipplePattern.map(a)):null,r=t.stippleOffColor?n.toUnitRGBA(t.stippleOffColor):null;return e>1.5?new w({width:e,color:this._getOutlineColor(),polygonOffset:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:i,stippleIntegerRepeats:!0,stippleOffColor:r},this._getIdHint("_outline_ribbonlinemat")):new N({color:this._getOutlineColor(),slicePlaneEnabled:this._context.slicePlaneEnabled,width:e,stipplePattern:i,stippleIntegerRepeats:!0,stippleOffColor:r},this._getIdHint("_outline_nativelinemat"))})(a(t.size)),this._context.stage.add(3,this._outlineMaterial)}_isValidOutline(t){return e(t)&&t.size&&t.size>0&&e(t.color)}destroy(){super.destroy(),e(this._material)&&(this._context.stage.remove(3,this._material.id),this._material=null),e(this._outlineMaterial)&&(this._context.stage.remove(3,this._outlineMaterial.id),this._outlineMaterial=null)}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometryType(t.geometry,F.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(t.geometry))return null;const i="graphic"+t.uid,r=this._getVertexOpacityAndColor(e.renderingInfo,Uint8Array,255),n=this.setGraphicElevationContext(t,new A);return this.ensureDrapedStatus("on-the-ground"===n.mode),this.ensureMaterials(),this.draped?this._createAsOverlay(t,r,i):this._createAs3DShape(t,r,n,i)}layerOpacityChanged(){if(e(this._material)){const e=this._material.params.color,i=t(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(i);this._material.setParameterValues({color:[e[0],e[1],e[2],r],transparent:r<1||this.needsDrivenTransparentPass})}if(e(this._outlineMaterial)){const e=this._outlineMaterial.params.color;this._outlineMaterial.setParameterValues({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}return!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,n=g(F.elevationModeChangeTypes,i,r);if(n!==b.UPDATE)return n;const a=E(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>a))}slicePlaneEnabledChanged(){if(e(this._material)&&this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),e(this._outlineMaterial)){const e={slicePlaneEnabled:this._context.slicePlaneEnabled};this._outlineMaterial.setParameterValues(e)}return!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(e,t,r,n){const a=T(e.geometry);if(i(a))return null;I.renderData=G(a,this._context.elevationProvider,this._context.renderCoordsHelper,r),I.idHint=n,I.color=t;const o=I.renderData.position.length/3;if(this._needsUV&&(I.uvMapSpace=new Float32Array(4*o),I.bound1=new Float64Array(3*o),I.bound2=new Float64Array(3*o),I.bound3=new Float64Array(3*o)),I.outNum=0,I.outGeometries=[],I.outTransforms=[],I.outMaterials=[],this._createAs3DShapeFill(I),this._hasOutline&&this._createAs3DShapeOutline(I),this._logGeometryCreationWarnings(I.renderData,a.rings,"rings","FillSymbol3DLayer"),0===I.outNum)return null;this._needsUV&&v(u.fromTypedArray(I.uvMapSpace),l.fromTypedArray(I.renderData.position),this._context.layerView.view.renderCoordsHelper,l.fromTypedArray(I.bound1),l.fromTypedArray(I.bound2),l.fromTypedArray(I.bound3));const s=new y({geometries:I.outGeometries,materials:I.outMaterials,transformations:I.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e.uid},idHint:n}),p=O,d=new D(this,s,I.outGeometries,null,null,p,r);return d.alignedSampledElevation=I.renderData.sampledElevation,d.needsElevationUpdates=E(r.mode),d}_createAs3DShapeFill(t){const i=t.renderData.polygons;for(const{position:n,mapPosition:a,holeIndices:l,index:u,count:c}of i){if(e(this._context.clippingExtent)&&(p(H),d(H,a),!h(H,this._context.clippingExtent)))continue;const i=s(a,l,3);if(0===i.length)continue;const m=new Uint32Array(i),_=C({indices:m,attributeData:{position:n,color:t.color,mapPosition:a,uvMapSpace:this._needsUV?new Float32Array(t.uvMapSpace.buffer,4*u*t.uvMapSpace.BYTES_PER_ELEMENT,4*c):null,bound1:this._needsUV?new Float64Array(t.bound1.buffer,3*u*t.bound1.BYTES_PER_ELEMENT,3*c):null,bound2:this._needsUV?new Float64Array(t.bound2.buffer,3*u*t.bound2.BYTES_PER_ELEMENT,3*c):null,bound3:this._needsUV?new Float64Array(t.bound3.buffer,3*u*t.bound3.BYTES_PER_ELEMENT,3*c):null}}),y=new P(_,t.idHint);t.outGeometries.push(y),t.outMaterials.push(r(this._material)),t.outTransforms.push(o),t.outNum++}}_createAs3DShapeOutline(t){if(!this._hasOutline)return;const i=t.renderData.outlines,n=this._outlineMaterial instanceof N;for(let a=0;a<i.length;++a){const{mapPosition:s,position:l}=i[a];if(e(this._context.clippingExtent)&&(p(H),d(H,s),!h(H,this._context.clippingExtent)))continue;const u=R({removeDuplicateStartEnd:n?0:1,attributeData:{position:l,mapPosition:s}}),c=u.vertexAttributes[_.POSITION];c.data===l&&(c.data=new Float64Array(l));const m=new P(u,t.idHint+"outline"+a);t.outGeometries.push(m),t.outMaterials.push(r(this._outlineMaterial)),t.outTransforms.push(o),t.outNum++}}_createAsOverlay(t,n,a){const o=T(t.geometry);if(i(o))return null;r(this._material).renderPriority=this._renderPriority+this._renderPriorityStep/2,e(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority),Y.renderData=j(o,this._context.overlaySR),Y.idHint=a,Y.color=n;const s=Y.renderData.position.length/3;return this._needsUV&&(Y.uvMapSpace=new Float32Array(4*s)),Y.outNum=0,Y.outGeometries=[],Y.outBoundingBox=p(),Y.layerUid=this._context.layer.uid,Y.graphicsUid=t.uid,this._createAsOverlayFill(Y),this._hasOutline&&this._createAsOverlayOutline(Y),this._logGeometryCreationWarnings(Y.renderData,o.rings,"rings","FillSymbol3DLayer"),0===Y.outNum?null:(this._needsUV&&x(u.fromTypedArray(Y.uvMapSpace),l.fromTypedArray(Y.renderData.position),this._context.overlaySR),Y.outNum>0?new B(this,Y.outGeometries,Y.outBoundingBox):null)}_createAsOverlayFill(e){const t=e.renderData.polygons;for(const{position:i,holeIndices:n,index:a,count:o}of t){if(p(H),d(H,i),!h(H,this._context.clippingExtent))continue;const t=s(i,n,3);if(0===t.length)continue;c(e.outBoundingBox,H);const l=new Uint32Array(t),u=C({indices:l,attributeData:{position:i,color:e.color,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*a*e.uvMapSpace.BYTES_PER_ELEMENT,4*o):null}}),m=new L(u);m.data.layerUid=e.layerUid,m.data.graphicUid=e.graphicsUid,m.material=r(this._material);const _=H;m.center=[.5*(_[0]+_[3]),.5*(_[1]+_[4]),0],m.bsRadius=.5*Math.sqrt((_[3]-_[0])*(_[3]-_[0])+(_[4]-_[1])*(_[4]-_[1])),e.outGeometries.push(m),e.outNum++}}_createAsOverlayOutline(e){if(!this._hasOutline)return;const t=e.renderData.outlines;for(let i=0;i<t.length;++i){const{position:n}=t[i];if(p(H),d(H,n),!h(H,this._context.clippingExtent))continue;c(e.outBoundingBox,H);const a=this._outlineMaterial instanceof N,o=R({removeDuplicateStartEnd:a?0:1,attributeData:{position:n}}),s=new L(o);s.data.layerUid=e.layerUid,s.data.graphicUid=e.graphicsUid,s.material=r(this._outlineMaterial);const l=H;s.center=[.5*(l[0]+l[3]),.5*(l[1]+l[4]),0],s.bsRadius=.5*Math.sqrt((l[3]-l[0])*(l[3]-l[0])+(l[4]-l[1])*(l[4]-l[1])),e.outGeometries.push(s),e.outNum++}}_getOutlineOpacity(){const i=t(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*(e(i)?i.a:0)}_getOutlineColor(){const i=t(this.symbolLayer,"outline","color"),r=this._getOutlineOpacity();return f(e(i)?n.toUnitRGB(i):null,r)}get test(){return{createAsOverlay:(e,t,i)=>this._createAsOverlay(e,t,i),createAs3DShape:(e,t,i,r)=>this._createAs3DShape(e,t,i,r)}}}F.validGeometryTypes=["polyline","polygon","extent"],F.elevationModeChangeTypes={definedChanged:b.RECREATE,staysOnTheGround:b.NONE,onTheGroundChanged:b.RECREATE};const H=m(),I={idHint:null,renderData:null,color:null,uvMapSpace:null,bound1:null,bound2:null,bound3:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},Y={idHint:null,renderData:null,color:null,uvMapSpace:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};export default F;export{F as Graphics3DPolygonFillSymbolLayer};
