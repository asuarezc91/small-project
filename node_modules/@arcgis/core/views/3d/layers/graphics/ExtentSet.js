/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import t from"../../../../core/PooledArray.js";import{create as e,set as r,area as s,expand as n,contains as o,containsPoint as i}from"../../../../geometry/support/aaBoundingRect.js";import{noBudget as h}from"../../../support/Scheduler.js";class a{constructor(){this.extents=new t({allocator:t=>t||e()}),this.tempExtent=e(),this.dirty=!1}get empty(){return 0===this.extents.length}clear(){this.extents.clear()}add(t){this.contains(t)||(this.removeContained(t),r(this.extents.pushNew(),t),this.dirty=!0)}pop(){return this.dirty&&this.mergeTight(),this.extents.pop()}merge(t){return this.mergeTight(t),t.hasProgressed}mergeTight(t=h){const e=this.extents,o=new Set;let i=0;for(;i!==e.length;){e.sort(((t,e)=>t[0]-e[0])),i=e.length,o.clear();for(let i=0;i<e.length;++i){if(t.done)return;const h=e.getItemAt(i);for(let t=i+1;t<e.length;++t){const r=e.getItemAt(t);if(r[0]>=h[2])break;o.add(r)}o.forEach((i=>{if(h===i)return;if(i[2]<=h[0])return void o.delete(i);const a=s(h),m=s(i),c=this.tempExtent;n(h,i,c);const d=a+m;(s(c)-d)/d<.05&&(r(h,c),o.delete(i),e.remove(i),t.madeProgress())})),o.add(h)}}this.dirty=!1}contains(t){return this.extents.some((e=>o(e,t)))}removeContained(t){this.extents.filterInPlace((e=>!o(t,e)))}get test(){const t=this;return{containsPoint:e=>t.extents.some((t=>i(t,e)))}}}export{a as ExtentSet};
