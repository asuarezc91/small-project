/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import{isNone as i}from"../../../core/maybe.js";import"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as s}from"../../../core/accessorSupport/decorators/property.js";import{subclass as r}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import t from"../../../core/Accessor.js";import o from"../../../symbols/PointSymbol3D.js";import"../../../chunks/symbols.js";import a from"../../../Graphic.js";import{c as l}from"../../../chunks/vec3f64.js";import p from"../../../core/Handles.js";import{diff as c}from"../../../core/accessorSupport/diffUtils.js";import{makeDehydratedPoint as h}from"../../../layers/graphics/dehydratedFeatures.js";import{Graphics3DCore as n}from"./graphics/Graphics3DCore.js";import d from"./graphics/Graphics3DScaleVisibility.js";import{boundingBoxTop as u}from"./i3s/I3SGeometryUtil.js";import{LimitGraphicsMap as y}from"../support/LimitGraphicsMap.js";let m=class extends t{constructor(e){super(e),this.loadedGraphics=new y(5e4),this.slicePlaneEnabled=!1,this._renderingInfo={symbol:new o},this._handles=new p,this._graphicsByNode=new Map,this._scaleVisibility=null}initialize(){this._graphicsCore=new n({owner:this,layer:this.layer,preferredUpdatePolicy:1,elevationFeatureExpressionEnabled:!1,graphicSymbolSupported:!1,getRenderingInfoWithoutRenderer:!0,hasZ:!0,hasM:!1});const e=this.view.basemapTerrain;this._scaleVisibility=new d({layerScaleEnabled:!1}),this._scaleVisibility.setup(this,this.layer,((e,i,s)=>this._graphicsCore.spatialIndex.queryGraphicUIDsInExtent(e,i,s)),this._graphicsCore,e);const i=this.view.labeler.addGraphicsOwner(this._graphicsCore,this._scaleVisibility,{emptySymbolLabelSupported:!0,elevationInfoOverride:{mode:"absolute-height",offset:0},disablePlacement:{logEntityDescription:"3D Object Scene Layer features"}}),s=this.view.deconflictor.addGraphicsOwner(this._graphicsCore);this._graphicsCore.setup({labeler:i,deconflictor:s,scaleVisibility:this._scaleVisibility}).then((()=>{this._graphicsCore.startCreateGraphics()})).catch((()=>{})),this._handles.add([this.layer.watch("labelingInfo",((e,i)=>{c(e,i)&&this._graphicsCore.updateLabelingInfo()}))])}destroy(){this._handles&&(this._handles.destroy(),this._handles=null),null!=this._scaleVisibility&&(this._scaleVisibility.destroy(),this._scaleVisibility=null),null!=this._graphicsCore&&(this._graphicsCore.destroy(),this._graphicsCore=null),this.loadedGraphics.destroy(),this.view=null}addNodeMeta(e,s){let r=0;const t=e.filteredIds,o=e.featureIds.map(((o,l)=>{u(l,this.collection,e.objectHandle,b);const p=h(0,0,0,this.view.spatialReference);this.view.renderCoordsHelper.fromRenderCoords(b,p);const c=s(l,e);let n=!1;return i(t)?n=!0:r<t.length&&o===t[r]&&(n=!0,r++),{objectId:o,uid:a.generateUID(),attributes:c,visible:n,geometry:p}}));this.loadedGraphics.addMany(o),this._graphicsByNode.set(e.node.index,o)}setNodeMetaAttributes(e,i){const s=this._graphicsByNode.get(e.node.index),r=new Array(s.length);for(let t=0;t<s.length;t++){const o=s[t];o.attributes=i(t,e),r[t]=o.uid}this._graphicsCore.updateLabelingInfo(r)}applyFilterChange(e){const s=this._graphicsByNode.get(e.node.index);if(s)if(i(e.filteredIds))for(const e of s)e.visible||(e.visible=!0,g.graphic=e,g.property="visible",g.oldValue=!1,g.newValue=!0,this._graphicsCore.graphicUpdateHandler(g));else{let i=0;for(const r of s){const s=r.visible;i<e.filteredIds.length&&r.objectId===e.filteredIds[i]?(r.visible=!0,i++):r.visible=!1,s!==r.visible&&(g.graphic=r,g.property="visible",g.oldValue=s,g.newValue=r.visible,this._graphicsCore.graphicUpdateHandler(g))}}}removeNodeMeta(e){this.loadedGraphics.removeManyByObjectId(e.featureIds)}getRenderingInfo(){return this._renderingInfo}notifyGraphicUpdate(){}get usedMemory(){return this._graphicsCore.usedMemory}get unloadedMemoryEstimate(){return this._graphicsCore.unprocessedMemoryEstimate}get test(){return{graphicsCore:this._graphicsCore}}};e([s()],m.prototype,"view",void 0),e([s()],m.prototype,"layer",void 0),e([s()],m.prototype,"collection",void 0),e([s()],m.prototype,"loadedGraphics",void 0),e([s({aliasOf:"_graphicsCore.updating"})],m.prototype,"updating",void 0),e([s()],m.prototype,"slicePlaneEnabled",void 0),e([s()],m.prototype,"_graphicsCore",void 0),m=e([r("esri.views.3d.layers.I3SMeshViewLabeler")],m);const g={graphic:null,property:null,oldValue:null,newValue:null},b=l();var f=m;export default f;
