/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import{unwrap as r}from"../../../core/maybe.js";import"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as t}from"../../../core/accessorSupport/decorators/property.js";import{subclass as i}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import{whenTrueOnce as s}from"../../../core/watchUtils.js";import{RefreshableLayerView as a}from"../../layers/RefreshableLayerView.js";import l from"../terrain/RasterTile.js";import{LayerView3D as o}from"./LayerView3D.js";import{TiledLayerView3D as n}from"./TiledLayerView3D.js";import d from"../../layers/LayerView.js";import{createQueryGeometry as m}from"../../support/drapedUtils.js";import{ImageryTileLayerView as p}from"../../layers/ImageryTileLayerView.js";let h=class extends(p(a(n(o(d))))){constructor(){super(...arguments),this.isAlignedMapTile=!0}initialize(){this.layer.increaseRasterJobHandlerUsage();const e=this.updateFullExtent();this.addResolvingPromise(e);const r=s(this.view,"basemapTerrain.tilingSchemeLocked").then((()=>{const e=this.view.basemapTerrain.tilingScheme,{tileInfo:r}=this.layer,t=["png","png24","png32","jpg","mixed"].indexOf(r.format)>-1&&e.compatibleWith(r);this.isAlignedMapTile=t;const i=t?r:e.toTileInfo();this._set("tileInfo",i),this.updatingHandles.add(this,"layer.renderer",(()=>this.refresh())),this.updatingHandles.add(this,"layer.interpolation",(()=>this.refresh())),this.updatingHandles.add(this,"layer.bandIds",(()=>this.refresh())),this.updatingHandles.add(this,"layer.multidimensionalDefinition",(()=>this.refresh()))}));this.addResolvingPromise(r)}destroy(){this.layer.decreaseRasterJobHandlerUsage(),this.view=null}get _blankTile(){const e=document.createElement("canvas"),r=e.getContext("2d"),[t,i]=this.tileInfo.size;return e.width=t,e.height=i,r.clearRect(0,0,t,i),r.getImageData(0,0,t,i)}get imageFormatIsOpaque(){return"jpg"===this.layer.tileInfo.format}get hasMixedImageFormats(){return"mixed"===this.layer.tileInfo.format}get dataLevelRange(){const e=this.tileInfo.lods,r=this.layer.tileInfo.lods,t=e[0].scale,i=r[r.length-1].scale;return this.levelRangeFromScaleRange(t,i)}async fetchTile(e,t,i,s){const a=this.tileInfo,o=this.layer.symbolizer.canRenderInWebGL,n={tileInfo:a,requestRawData:o,signal:r(s.signal),requestAsImageElement:this.isAlignedMapTile},d=await this.layer.fetchTile(e,t,i,n);if(d instanceof HTMLImageElement)return d;let m=d&&d.pixelBlock;if(!m)return this._blankTile;if(!o&&(m=await this.layer.applyRenderer(d),null==m))return this._blankTile;const p=new l([e,t,i],m,a.size[0],a.size[1]);return o&&(p.symbolizerRenderer=this.layer.symbolizer.rendererJSON,p.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(e)),p.transformGrid=d.transformGrid),p.bandIds=this.layer.bandIds,p}_getSymbolizerOptions(e){const r=this.tileInfo.lodAt(e).resolution;return{pixelBlock:null,isGCS:this.view.spatialReference.isGeographic,resolution:{x:r,y:r},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(e){JSON.stringify(e.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(e.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(e.lij[0])))}createFetchPopupFeaturesQueryGeometry(e,r){return m(e,r,this.view)}refresh(){this.emit("data-changed")}async doRefresh(e){this.suspended||this.emit("data-changed")}};e([t({readOnly:!0,dependsOn:["tileInfo"]})],h.prototype,"_blankTile",null),e([t({readOnly:!0,dependsOn:["layer.tileInfo.format"]})],h.prototype,"imageFormatIsOpaque",null),e([t({readOnly:!0,dependsOn:["layer.tileInfo.format"]})],h.prototype,"hasMixedImageFormats",null),e([t({readOnly:!0,dependsOn:["tileInfo","view.basemapTerrain.tilingScheme","layer.url"]})],h.prototype,"dataLevelRange",null),h=e([i("esri.views.3d.layers.ImageryTileLayerView3D")],h);var y=h;export default y;
