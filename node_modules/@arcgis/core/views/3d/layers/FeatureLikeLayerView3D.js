/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import{get as t,isNone as r}from"../../../core/maybe.js";import"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as i}from"../../../core/accessorSupport/decorators/property.js";import{subclass as s}from"../../../core/accessorSupport/decorators/subclass.js";import n from"../../../core/Error.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import{reject as o}from"../../../core/promiseUtils.js";import{whenTrueOnce as a}from"../../../core/watchUtils.js";import{Task as p}from"../../support/Scheduler.js";import l from"../../../tasks/support/Query.js";import{hydrateGraphic as h}from"../../../layers/graphics/hydratedFeatures.js";import{getRenderingInfo as d,getRenderingInfoAsync as u}from"../../../renderers/support/renderingInfoUtils.js";import c from"../../../layers/graphics/controllers/FeatureTileController3D.js";import{toViewIfLocal as g}from"./support/projectExtentUtils.js";import y from"./graphics/QueryEngine.js";import m from"./graphics/Graphics3DFeatureLikeLayerView.js";const f=f=>{let E=class extends f{constructor(){super(...arguments),this.controller=null,this.asyncGraphicsUpdates=!1,this.suspendResumeExtentMode="computed",this.slicePlaneEnabled=!1,this.drapeSourceType=1,this.fullExtentInLocalViewSpatialReference=null,this.suspendResumeExtent=null,this._controllerCreated=!1,this.clippingExtent=null,this.supportsHeightUnitConversion=!0,this.pendingController=null,this.queryEngine=null}initialize(){const e=this.layer;"isTable"in e&&e.isTable?this.addResolvingPromise(o(new n("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:e}))):(this._set("graphics3d",new m({owner:this,layer:e,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentVisibilityEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.asyncGraphicsUpdates?1:0,suspendResumeExtentMode:this.suspendResumeExtentMode,updateClippingExtent:e=>this.updateClippingExtent(e)})),this.updatingHandles.add(this,"asyncGraphicsUpdates",(e=>{this.graphics3d.graphicsCore.preferredUpdatePolicy=e?1:0})),this.updatingHandles.add(this,"suspendResumeExtentMode",(e=>{this.graphics3d.suspendResumeExtentMode=e})),this.addResolvingPromise(this.graphics3d.setup().then((()=>this.validateGeometryType())).then((()=>this.queryEngine=new y({layerView:this,task:p.FEATURE_QUERY_ENGINE}))).then((()=>g(this))).then((e=>this.fullExtentInLocalViewSpatialReference=e)).then((()=>this.initializeController()))),this.notifyChange("updating"))}destroy(){this.destroyPendingController(),this.controller&&(this.controller.destroy(),this.controller=null),this.graphics3d&&(this.graphics3d.destroy(),this._set("graphics3d",null)),this.queryEngine&&(this.queryEngine.destroy(),this.queryEngine=null),this.loadedGraphics=null}destroyPendingController(){this.pendingController&&(this.pendingController.destroy(),this.pendingController=null)}get legendEnabled(){var e,t;return this.canResume()&&!(null!=(e=this.graphics3d)&&null!=(t=e.frustumVisibility)&&t.suspended)}notifyGraphicUpdate(e,t){this.graphics3d.graphicsCore.notifyGraphicUpdate(e,t)}getRenderingInfo(e,t,r){const i=d(e,{renderer:t,arcade:r});if(i&&i.color){const e=i.color;e[0]=e[0]/255,e[1]=e[1]/255,e[2]=e[2]/255}return i}async getRenderingInfoAsync(e,t,r,i){return u(e,{renderer:t,arcade:r,...i})}getGraphicFromGraphicUid(e){let t=null;return this.loadedGraphics&&this.loadedGraphics.forEach((r=>{r.uid===e&&(t=h(r,this.layer))})),t}get graphics3DGraphics(){return this.graphics3d?this.graphics3d.graphicsCore.graphics3DGraphics:null}get graphics3DGraphicsByObjectID(){return this.graphics3d?this.graphics3d.graphicsCore.graphics3DGraphicsByObjectID:null}get symbolUpdateType(){return this.graphics3d?this.graphics3d.graphicsCore.symbolUpdateType:null}whenGraphicBounds(e,t){return this.graphics3d?this.graphics3d.graphicsCore.whenGraphicBounds(e,t):null}computeAttachmentOrigin(e,t){return this.graphics3d?this.graphics3d.graphicsCore.computeAttachmentOrigin(e,t):null}getSymbolLayerSize(e,t){return this.graphics3d?this.graphics3d.graphicsCore.getSymbolLayerSize(e,t):null}queryFeatures(e,r){return this.queryEngine.executeQuery(this._ensureQuery(e),t(r,"signal"))}queryObjectIds(e,r){return this.queryEngine.executeQueryForIds(this._ensureQuery(e),t(r,"signal"))}queryFeatureCount(e,r){return this.queryEngine.executeQueryForCount(this._ensureQuery(e),t(r,"signal"))}queryExtent(e,r){return this.queryEngine.executeQueryForExtent(this._ensureQuery(e),t(r,"signal"))}_ensureQuery(e){return r(e)?this.createQuery():l.from(e)}highlight(e){return this.graphics3d.highlight(e,this.layer.objectIdField)}maskOccludee(e){return this.graphics3d.maskOccludee(e)}canResume(){return!(!super.canResume()||this.graphics3d&&this.graphics3d.suspended)}getSuspendInfo(){const e=super.getSuspendInfo();return this.graphics3d?{...e,...this.graphics3d.suspendInfo}:e}isUpdating(){return!(!this.graphics3d||this.graphics3d.destroyed)&&!(!(!this._controllerCreated||this.controller&&this.controller.updating)&&this.view.basemapTerrain&&this.view.basemapTerrain.ready&&!this.graphics3d.updating)}async initializeController(){const e=this.createController();this.pendingController=e,await e.when(),this.setControllerWhenInitialized(e)}async setControllerWhenInitialized(e){try{await this.when()}catch(e){}this._controllerCreated=!0,this.notifyChange("updating"),this.isResolved()&&!this.destroyed?(await a(this.view,"basemapTerrain.ready"),this.beforeSetController(e),this.pendingController=null,this.controller=e,this.loadedGraphics=e.graphics,this.notifyChange("updating")):this.destroyPendingController()}updateClippingExtent(e){if(this.clippingExtent=e,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=e,!0}}validateGeometryType(){switch(this.layer.geometryType){case"multipatch":case"multipoint":return o(new n("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:this.layer.geometryType}))}}_getResourceInfo(){const e=this.controller&&this.controller instanceof c?this.controller:null;return{displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:e?e.maximumNumberOfFeatures:-1,totalNumberOfFeatures:e?e.serviceDataCount:-1,nodes:0,core:this.graphics3d.graphicsCore.performanceInfo,elevationUpdating:this.graphics3d.elevationAlignment.updating,visibilityFrustum:!this.graphics3d.frustumVisibility.suspended,visibilityScale:!this.graphics3d.scaleVisibility.suspended}}get performanceInfo(){return this._getResourceInfo()}};return e([i()],E.prototype,"loadedGraphics",void 0),e([i({dependsOn:["graphics3d.suspended"]})],E.prototype,"suspended",void 0),e([i({readOnly:!0,dependsOn:["graphics3d.frustumVisibility.suspended"]})],E.prototype,"legendEnabled",null),e([i({dependsOn:["graphics3d.updating","controller.updating"]})],E.prototype,"updating",void 0),e([i()],E.prototype,"controller",void 0),e([i()],E.prototype,"graphics3d",void 0),e([i({readOnly:!0})],E.prototype,"asyncGraphicsUpdates",void 0),e([i({readOnly:!0})],E.prototype,"suspendResumeExtentMode",void 0),e([i({type:Boolean})],E.prototype,"slicePlaneEnabled",void 0),e([i({readOnly:!0,dependsOn:["graphics3d.suspendInfo"]})],E.prototype,"suspendInfo",void 0),E=e([s("esri.views.3d.layers.FeatureLikeLayerView3D")],E),E};export{f as FeatureLikeLayerView3D};
