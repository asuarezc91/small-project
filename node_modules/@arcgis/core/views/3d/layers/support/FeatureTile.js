/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{unwrapOr as t}from"../../../../core/maybe.js";import{shuffle as e}from"../../../../core/arrayUtils.js";import{fromExtent as s,intersects as i,set as r,POSITIVE_INFINITY as u,intersection as a,create as h}from"../../../../geometry/support/aaBoundingRect.js";import{numVertices as n,estimateSize as f,getObjectId as m}from"../../../../layers/graphics/dehydratedFeatures.js";const d=new Set;class _{constructor(t){this.descriptor=t,this.fetchStatus=0,this._features=null,this._numVertices=0,this._featureLimit=0,this.featuresMissing=!0,this._shuffled=!1,this._numFeatures=l,this._emptyFeatureRatio=0,this._estimatedSize=-1,this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._availableFields=d,this.displayingFeatures=null,this.alive=!0,this.filtered=!1}get perTileMaximumNumberOfFeaturesExceeded(){return!this.filtered&&(this.featuresMissing||this.features&&this.featureLimit!==this.features.length)}get features(){return this._features}get featureLimit(){return this._featureLimit}set featureLimit(t){this._featureLimit!==t&&(this._featureLimit=t,this._estimatedUnusedSizeDirty=!0)}get availableFields(){return this._availableFields}setFeatures(e,s,i){this._availableFields=t(i,d),this._features=e,this._shuffled=!1,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,e&&e.length>0?(this._emptyFeatureRatio=s/(e.length+s),this._numVertices=e.reduce(((t,e)=>t+n(e.geometry)),0)):(this._emptyFeatureRatio=0,this._numVertices=0)}get emptyFeatureRatio(){return this._emptyFeatureRatio}get numFeatures(){return this.hasPreciseFeatureCount?this._numFeatures:this._features?this._features.length:0}set numFeatures(t){this._numFeatures=t}get hasPreciseFeatureCount(){return this._numFeatures>l}get needsFeatureCount(){return this._numFeatures===l}get numVertices(){return this._numVertices}get id(){return this.descriptor.id}get estimatedSize(){return this.updateMemoryEstimates(),this._estimatedSize}get estimatedUnusedSize(){return this._estimatedUnusedSize}updateMemoryEstimates(){if(this._estimatedSize<0){if(this._estimatedSize=0,this._estimatedUnusedSize=0,this._features)for(let t=0;t<this._features.length;++t){const e=f(this._features[t]);this._estimatedSize+=e,t>=this.featureLimit&&(this._estimatedUnusedSize+=e)}return!0}if(this._estimatedUnusedSizeDirty){if(this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._features)for(let t=this.featureLimit;t<this._features.length;++t)this._estimatedUnusedSize+=f(this._features[t]);return!0}return!1}get isFetching(){return 2===this.fetchStatus||3===this.fetchStatus}get isRefetching(){return 3===this.fetchStatus}get needsFetching(){return 0===this.fetchStatus||1===this.fetchStatus}get needsRefetching(){return 1===this.fetchStatus}get isFetched(){return 4===this.fetchStatus||5===this.fetchStatus}resetFetching(){this.fetchStatus=3===this.fetchStatus?1:0}get needsDisplayUpdate(){return!!this._features&&!function(t,e,s){if(!e||!t||s!==e.length||s>t.length)return!1;for(let i=0;i<s;++i)if(t[i]!==e[i])return!1;return!0}(this._features,this.displayingFeatures,this.featureLimit)}intersects(t){return!t||!this.descriptor.extent||(s(t,o),i(this.descriptor.extent,o))}intersection(t,e){return t||this.descriptor.extent?(t?(s(t,e),this.descriptor.extent&&a(e,this.descriptor.extent,e)):r(e,this.descriptor.extent),e):(r(e,u),e)}_shuffle(t){this._features.sort(((e,s)=>m(e,t)-m(s,t))),e(this._features,16438),this._shuffled=!0,this._estimatedUnusedSizeDirty=!0}reduceFeatures(t,e,s){if(t<=0)return!1;if(!this._features)return this.featureLimit=0,!1;let i=!1;this.featureLimit=Math.ceil(this.numFeatures*t),this.featureLimit>this._features.length&&(this.featureLimit=this._features.length,4===this.fetchStatus&&this._features.length>0&&(this.fetchStatus=1,i=!0)),!this._shuffled&&t<1&&this._shuffle(s);const r=Math.max(this.featureLimit,Math.ceil(e*this.numFeatures));return this._features.length>r&&(this._features.length=r,this.featuresMissing=!0,5===this.fetchStatus&&(this.fetchStatus=4)),i}get cache(){return{availableFields:this._availableFields,features:this.features,numFeatures:this._numFeatures,emptyFeatureRatio:this._emptyFeatureRatio,fetchStatus:this.fetchStatus,featuresMissing:this.featuresMissing}}set cache(t){this.requestController=null,this._availableFields=t.availableFields,this._features=t.features,this._numFeatures=t.numFeatures,this._emptyFeatureRatio=t.emptyFeatureRatio,this.fetchStatus=t.fetchStatus,this.featuresMissing=t.featuresMissing,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0}}const l=-1,c=-2;const o=h();export{c as FAILED_FEATURE_COUNT,_ as FeatureTile};
