/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import"../../../../core/has.js";import{isSome as r}from"../../../../core/maybe.js";import"../../../../core/Logger.js";import"../../../../core/accessorSupport/ensureType.js";import"../../../../core/accessorSupport/decorators/property.js";import{subclass as s}from"../../../../core/accessorSupport/decorators/subclass.js";import t from"../../../../core/Error.js";import"../../../../core/urlUtils.js";import"../../../../core/uuid.js";import"../../../../portal/support/resourceExtension.js";import{reject as o,resolve as p}from"../../../../core/promiseUtils.js";import{unpackFieldNames as a,populateMissingFields as i}from"../../../../layers/support/fieldUtils.js";import{getFetchPopupTemplate as c,getRequiredFields as u}from"../../../layers/support/popupUtils.js";const n=n=>{let l=class extends n{_validateFetchPopupFeatures(e){const{layer:r}=this,{popupEnabled:s}=r;if(!s)return new t("scenelayerview3d:fetchPopupFeatures","Popups are disabled",{layer:r});return c(r,e)?void 0:new t("scenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{layer:r})}async prepareFetchPopupFeatures(e){}async fetchPopupFeatures(e,s){const t=this._validateFetchPopupFeatures(s);if(t)return o(t);const n=r(s)?s.clientGraphics:null;if(!n||0===n.length)return p([]);const l=[],h=[],m="scene"===this.layer.type&&r(this.layer.associatedLayer)?this.layer.associatedLayer:this.layer,y=a(this.layer.fields,await u(m,c(this.layer,s)));await this.prepareFetchPopupFeatures(y);const d=new Set;for(const e of n)i(y,e,d)?h.push(e):l.push(e);return 0===h.length?p(l):this.whenGraphicAttributes(h,[...d]).catch((()=>h)).then((e=>l.concat(e)))}};return l=e([s("esri.views.3d.layers.support.PopupSceneLayerView")],l),l};export{n as PopupSceneLayerView};
