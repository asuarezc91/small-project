/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import"../../../../core/has.js";import{unwrapOr as t}from"../../../../core/maybe.js";import r from"../../../../core/Logger.js";import"../../../../core/accessorSupport/ensureType.js";import{property as s}from"../../../../core/accessorSupport/decorators/property.js";import{subclass as o}from"../../../../core/accessorSupport/decorators/subclass.js";import"../../../../core/urlUtils.js";import"../../../../core/uuid.js";import"../../../../portal/support/resourceExtension.js";import i from"../../../../core/Accessor.js";import a from"../../../../core/Evented.js";import{c as n}from"../../../../chunks/vec3f64.js";import{g as l}from"../../../../chunks/vec3.js";import{getMetersPerVerticalUnitForSR as c}from"../../../../core/unitUtils.js";import{empty as d}from"../../../../geometry/support/aaBoundingRect.js";import{getMetersPerUnit as p}from"../../../../symbols/support/unitConversionUtils.js";import{empty as m,toRect as h,expandWithVec3 as u}from"../../../../geometry/support/aaBoundingBox.js";import{Intersector as f}from"../../webgl-engine/lib/Intersector.js";const y=r.getLogger("esri.views.3d.layers.support.StageLayerElevationProvider");let v=class extends(a.EventedMixin(i)){constructor(e){super(e),this.elevationOffset=0,this.layerDirtyNotificationHandle=null}initialize(){this.renderCoordsHelper=this.view.renderCoordsHelper,this.intersectLayers=[this.stageLayer],this.intersector=new f(this.view.state.mode),this.intersector.options.store=0;const e=this.computeLayerExtent(this.stageLayer);this.zmin=e[2],this.zmax=e[5],this.layerDirtyNotificationHandle=this.stageLayer.on("dirty",(e=>this.stageLayerChanged(e.origin,e.dirtyType,e.subObject)))}dispose(){this.layerDirtyNotificationHandle.remove()}elevationInfoChanged(){const e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"on-the-ground"!==e.mode){const r=c(this.layer.spatialReference),s=p(e.unit);this.elevationOffset=t(e.offset,0)*s/r}else this.elevationOffset=0}getElevation(e,t,r,s){if(b[0]=e,b[1]=t,b[2]=r,!this.renderCoordsHelper.toRenderCoords(b,s,b))return y.error("could not project point for elevation alignment"),null;const o=this.elevationOffset,i=this.zmin+o,a=this.zmax+o;l(B,b),l(E,b),this.renderCoordsHelper.setAltitude(a,B),this.renderCoordsHelper.setAltitude(i,E);return this.intersector.reset(B,E),this.intersector.intersect(this.intersectLayers,null,null,1,null,(e=>e.metadata&&e.metadata.isElevationSource)),this.intersector.results.min.getIntersectionPoint(b)?this.renderCoordsHelper.getAltitude(b):null}stageLayerChanged(e,t,r){switch(t){case"layerObjectAdded":case"layerObjectRemoved":case"objGeometryAdded":{const e=r;e.metadata&&e.metadata.isElevationSource&&this.objectChanged(e)}break;case"objGeometryRemoved":case"vertexAttrsUpdated":case"objTransformation":{const t=e;t.metadata&&t.metadata.isElevationSource&&this.objectChanged(t)}}}objectChanged(e){if(this.spatialReference){m(g),e.metadata.lastValidElevationBB.isEmpty()||this.expandExtent(e.metadata.lastValidElevationBB.bbMin,e.metadata.lastValidElevationBB.bbMax,g);const t=e.getBBMin(!1),r=e.getBBMax(!1);this.expandExtent(t,r,g),h(g,j),this.zmin=Math.min(this.zmin,g[2]),this.zmax=Math.max(this.zmax,g[5]),x.extent=j,x.spatialReference=this.spatialReference,this.emit("elevation-change",x),l(e.metadata.lastValidElevationBB.bbMin,t),l(e.metadata.lastValidElevationBB.bbMax,r)}}computeLayerExtent(e){m(g);for(const t of e.getObjects())this.expandExtent(t.getBBMin(!1),t.getBBMax(!1),g);return g}expandExtent(e,t,r){for(let s=0;s<8;++s)b[0]=1&s?e[0]:t[0],b[1]=2&s?e[1]:t[1],b[2]=4&s?e[2]:t[2],this.renderCoordsHelper.fromRenderCoords(b,b,this.spatialReference),u(r,b);return r}};e([s({constructOnly:!0})],v.prototype,"layer",void 0),e([s({constructOnly:!0})],v.prototype,"stageLayer",void 0),e([s({constructOnly:!0})],v.prototype,"view",void 0),e([s({readOnly:!0,aliasOf:"view.spatialReference"})],v.prototype,"spatialReference",void 0),v=e([o("esri.views.3d.layers.support.StageLayerElevationProvider")],v);const g=m(),j=d(),x={spatialReference:null,extent:j,context:"scene"},b=n(),B=n(),E=n();export{v as StageLayerElevationProvider};
