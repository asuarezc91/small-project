/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import"../../../../core/has.js";import{isNone as r,isSome as t,destroyMaybe as s}from"../../../../core/maybe.js";import"../../../../core/Logger.js";import"../../../../core/accessorSupport/ensureType.js";import{property as o}from"../../../../core/accessorSupport/decorators/property.js";import{aliasOf as a}from"../../../../core/accessorSupport/decorators/aliasOf.js";import{subclass as u}from"../../../../core/accessorSupport/decorators/subclass.js";import"../../../../core/urlUtils.js";import"../../../../core/uuid.js";import"../../../../portal/support/resourceExtension.js";import{throwIfAborted as i,reject as p,createAbortError as c}from"../../../../core/promiseUtils.js";import l from"../../../../core/Accessor.js";import{runQuery as y,executeQuery as n}from"../../../../tasks/operations/query.js";import{fromFeatureSetJSON as d}from"../../../../layers/graphics/dehydratedFeatures.js";import{PBFDecoder as m}from"../../support/PBFDecoder.js";let h=class extends l{get queryFeaturesDehydrated(){const e=this.layer.capabilities,s=e&&e.query;if(s&&s.supportsFormatPBF){var o,a;r(this._decoder)&&(this._decoder=new m(this.scheduler));const e={sourceSpatialReference:null!=(o=null==(a=this.layer.spatialReference)?void 0:a.toJSON())?o:null,applyTransform:!0,maxStringAttributeLength:1024};return(r,s)=>y(this.layer.parsedUrl,r,"pbf",s).then((r=>(i(s),t(this._decoder)?this._decoder.invoke({buffer:r.data,options:e},s.signal):p(c()))))}return(e,r)=>n(this.layer.parsedUrl,e,this.layer.spatialReference,r).then((e=>d(e.data)))}queryFeatureCount(e,r){return this.layer.queryFeatureCount(e,r)}destroy(){this._decoder=s(this._decoder)}};e([o({constructOnly:!0})],h.prototype,"layer",void 0),e([o({constructOnly:!0})],h.prototype,"scheduler",void 0),e([o({readOnly:!0,dependsOn:["layer.capabilities.query.supportsFormatPBF"]})],h.prototype,"queryFeaturesDehydrated",null),h=e([u("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],h);let f=class extends l{queryFeaturesDehydrated(e,r){return this.layer.queryFeatures(e,r)}};e([o({constructOnly:!0})],f.prototype,"layer",void 0),f=e([u("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],f);let F=class extends l{destroy(){}queryFeaturesDehydrated(e,r){return this.source.queryFeaturesJSON(e,r).then(d,(t=>{if(t&&"query-features-json:unsupported"===t.name)return this.layer.queryFeatures(e,r);throw t}))}queryFeatureCount(e,r){return this.layer.queryFeatureCount(e,r)}};function j(e,r){switch(e.source.type){case"feature-layer":return new h({layer:e,scheduler:r});case"memory":case"csv":case"geojson":return new F({layer:e});case"ogc-feature":return new f({layer:e});case"stream-layer":throw new Error("Tile based queries unsupported for stream sources")}}e([o({constructOnly:!0})],F.prototype,"layer",void 0),e([a("layer.source")],F.prototype,"source",void 0),F=e([u("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileClientQuery3D")],F);export{j as createFeatureTileQuery3D};
