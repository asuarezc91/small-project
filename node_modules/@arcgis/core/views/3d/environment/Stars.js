/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import{isSome as t,isNone as r}from"../../../core/maybe.js";import s from"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as a}from"../../../core/accessorSupport/decorators/property.js";import{subclass as i}from"../../../core/accessorSupport/decorators/subclass.js";import o from"../../../core/Error.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import{createTask as n,isAbortError as c}from"../../../core/promiseUtils.js";import u from"../../../core/Accessor.js";import{fetchAsset as f}from"../../../assets.js";import{c as d,g as p,m as l}from"../../../chunks/mat4.js";import{WatchUpdatingTracking as h}from"../../support/WatchUpdatingTracking.js";import{a as m,f as g}from"../../../chunks/mat4f64.js";import{Default3D as _}from"../webgl-engine/lib/DefaultVertexAttributeLocations.js";import{glLayout as b}from"../support/buffer/glUtil.js";import{newLayout as y}from"../support/buffer/InterleavedLayout.js";import j from"../../webgl/BufferObject.js";import v from"../../webgl/VertexArrayObject.js";import{StarsTechnique as w}from"./StarsTechnique.js";const k=s.getLogger("esri.views.3d.environment.Stars");let T=class extends u{constructor(e){super(e),this.slot=14,this._loadDataTask=null,this._resources=null,this._modelMatrix=m(),this._updatingTracking=new h,this._requestRender=()=>{}}get updating(){return this._updatingTracking.updating||this.loading}get loading(){return t(this._loadDataTask)&&!this._loadDataTask.finished}get canRender(){return!this.loading}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){t(this._loadDataTask)&&(this._loadDataTask.abort(),this._loadDataTask=null),this._updatingTracking.destroy(),t(this._resources)&&(this._resources.vao.dispose(),this._resources.technique.dispose(),this._resources=null),this._requestRender=null}initializeRenderContext(e){this._requestRender=e.requestRender}uninitializeRenderContext(){this.destroy()}render(e){if(e.slot!==this.slot||0!==e.pass)return!1;if(this._ensureResources(e),r(this._resources))return!0;const{technique:t,vao:s,num:a}=this._resources,i=e.rctx,o=t.program;return i.bindProgram(o),t.bindPass(i,{camera:e.camera,modelMatrix:this._modelMatrix}),t.bindPipelineState(i),i.bindVAO(s),o.assertCompatibleVertexAttributeLocations(s),i.drawArrays(0,0,a),!0}_ensureResources(e){if(t(this._resources)||r(q))return;const s=e.rctx,a=new w({rctx:s,viewingMode:this.view.state.mode},null),i=q.byteLength/R,o=new Float32Array(q,0,2*i),n=new Uint8Array(q,2*i*4,i),c=this._createVertexArrayObject(e.rctx,o,n,i);this._resources={vao:c,technique:a,num:i},this._updatingTracking.add(this.view,"environment.lighting.date",(e=>this._update(e)),2)}_computeDayDuration(e){const t=e,r=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+r)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+r)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,r=2*this._computeDayDuration(e),s=this._modelMatrix;d(s,M),p(s,s,-r*Math.PI),l(s,D,s),p(s,s,-t*Math.PI),this._requestRender()}_hexToRGB(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]}_unpackUint8Attributes(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}_createVertexArrayObject(e,t,r,s){const a=A.createBuffer(s),i=a.position,o=a.color,n=a.size;for(let e=0;e<s;e++){const s=t[2*e+0],a=t[2*e+1];i.set(e,0,-Math.cos(s)*Math.sin(a)),i.set(e,1,-Math.sin(s)*Math.sin(a)),i.set(e,2,-Math.cos(a));const c=this._unpackUint8Attributes(r[e]),u=this._hexToRGB(x[c[1]]);o.set(e,0,255*u[0]),o.set(e,1,255*u[1]),o.set(e,2,255*u[2]),o.set(e,3,255),n.set(e,c[0])}return new v(e,_,{geometry:b(A)},{geometry:j.createVertex(e,35044,a.buffer)})}_createLoadDataTask(){if(t(q))return null;const e=n((async e=>{const{data:t}=await f("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:e});this._verifyStarData(t),q=t}));return e.promise.catch((e=>{c(e)||k.error(e)})).then((()=>{this.destroyed||(this._requestRender(),this.notifyChange("updating"))})),e}_verifyStarData(e){if(!e)throw new o("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/R;if(t%1!=0||t>5e4||t<5e3)throw new o("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}};e([a({constructOnly:!0})],T.prototype,"view",void 0),e([a({readOnly:!0,dependsOn:["_updatingTracking.updating"]})],T.prototype,"updating",null),e([a()],T.prototype,"_loadDataTask",void 0),e([a()],T.prototype,"_updatingTracking",void 0),T=e([i("esri.views.3d.environment.Stars")],T);const x=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],D=g(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),M=g(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),R=9,A=y().vec3f("position").vec4u8("color").f32("size");let q=null;export{T as Stars};
