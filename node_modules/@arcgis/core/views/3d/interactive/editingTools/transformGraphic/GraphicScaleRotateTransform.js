/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as t,isNone as e}from"../../../../../core/maybe.js";import{addFrameTask as a}from"../../../../../core/scheduling.js";import i from"../../../../../core/Evented.js";import{clamp as o}from"../../../../../core/mathUtils.js";import{castRenderScreenPointArray as s,createScreenPointArray as r}from"../../../../../core/screenUtils.js";import{b as n,f as l,c}from"../../../../../chunks/vec3f64.js";import{a as h}from"../../../../../chunks/common.js";import{s as g,f as d,l as m,h as u,c as p,b as f}from"../../../../../chunks/vec3.js";import{cyclicalPI as D}from"../../../support/mathUtils.js";import M from"../../../../../core/Handles.js";import{init as y}from"../../../../../core/watchUtils.js";import{i as S,r as b,p as R,m as v,s as w}from"../../../../../chunks/mat4.js";import{a as k}from"../../../../../chunks/mat4f64.js";import{getGraphicEffectiveElevationInfo as _}from"../../../../../support/elevationInfoUtils.js";import{sv3d as j,sm4d as A}from"../../../support/stack.js";import{plane as F,ray as I}from"../../../support/geometryUtils.js";import E from"../../../webgl-engine/lib/GeometryUtil.js";import P from"../../../webgl-engine/lib/Geometry.js";import{ColorMaterial as L}from"../../../webgl-engine/materials/ColorMaterial.js";import{createManipulatorDragEventPipeline as T,resetSymbol as U}from"../../../../interactive/dragEventPipeline.js";import{screenToRenderPlane as O}from"../dragEventPipeline3D.js";import{Manipulator3D as x}from"../../Manipulator3D.js";import{calculateInputRotationTransform as z,placeAtGraphic as C}from"../../manipulatorUtils.js";import{ROTATE_INDICATOR_DIRECTION_BUFFER as N,SCALE_INDICATOR_DIRECTION_BUFFER as Z,RING_HEIGHT as G,ROTATE_INDICATOR_ARROW_TIP_LENGTH as H,ROTATE_INDICATOR_ARROW_TIP_RADIUS as V,RING_THICKNESS as q,DRAG_THRESHOLD_PX as B,RING_RESET_ANIMATION_SPEED_FACTOR as J,RING_INDICATOR_DELAY_MS as K,INDICATOR_THICKNESS as Q,ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE as W,HANDLE_COLOR as X,RING_RADIUS as Y,ROTATE_INDICATOR_ARC_LENGTH as $,INNER_INDICATOR_RADIUS as tt,OUTER_INDICATOR_RADIUS as et,SCALE_INDICATOR_OFFSET1 as at,SCALE_INDICATOR_OFFSET2 as it,GEOMETRY_SEGMENTS as ot,SCALE_INDICATOR_ARC_LENGTH as st}from"../manipulations/config.js";var rt;!function(t){t.ScaleIn=32,t.ScaleOut=64,t.RotateLeft=128,t.RotateRight=256,t.Unlocked=1024,t.DelayedFocused=2048,t.TouchInput=32768}(rt||(rt={}));class nt{constructor(e){this.mode=null,this._handles=new M,this._scaleRotateDragData=null,this._activeAnimation=null,this.events=new i,this.getFocused=()=>this.ringManipulator.focused,this.getScale=()=>t(this._scaleRotateDragData)&&"scale"===this._scaleRotateDragData.mode?this._scaleRotateDragData.scale:1,this.tool=e.tool,this.mode=e.mode,this.createManipulator(),this.updateDragState(),this.updateManipulatorTransform()}destroy(){t(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles.removeAll(),this.tool.manipulators.remove(this.ringManipulator),this.ringManipulator=null}startAnimation(t){this.cancelActiveAnimation(),t.start();const e=a({update:({deltaTime:e})=>{t.update(e)&&this.cancelActiveAnimation()}});this._activeAnimation={...t,frameTask:e}}cancelActiveAnimation(){t(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation.destroy(),this._activeAnimation=null)}forEachManipulator(t){t(this.ringManipulator,2)}createManipulator(){this.ringManipulator=this.createRingManipulator(),this.tool.manipulators.add(this.ringManipulator);const a=this.ringManipulator,i=this.tool.graphicState.graphic,s=T(a,((a,s,r)=>{this._scaleRotateDragData=null;const l=function(t,a){const i=t.allLayerViews.find((t=>t.layer===a.layer));if(e(a.symbol))return null;const o=a.symbol;return{symbolLayers:o.symbolLayers.map((t=>{let e=null,a=null;return"object"===t.type&&(e=t.heading),a=i.getSymbolLayerSize(o,t),{heading:e,size:a}})).toArray()}}(this.tool.view,i);if(e(l))return this.updateDragState(),null;const c={mode:"none",origin:n(a.renderLocation),angle:0,startAngle:this.tool.symbolRotationAngle,angleDir:0,scale:1,scaleDir:0,startSymbolData:l};this._scaleRotateDragData=c,this.updateDragState();const h=j.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(a.renderLocation,h),s.next(O(this.tool.view,F.fromPositionAndNormal(a.renderLocation,h))).next((e=>{const a=F.normal(e.plane),s=z(e.renderStart,e.renderEnd,c.origin,a),r=D.shortestSignedDiff(c.angle,s);c.angleDir=o(c.angleDir+r,-N,N),c.angle=s;const n=function(t,e){const a=d(j.get(),e.renderStart,t.origin),i=d(j.get(),e.renderEnd,t.origin),o=m(a),s=m(i);if(0===o)return 0;return s/o}(c,e),l=n-c.scale;if(c.scaleDir=o(c.scaleDir+l,-Z,Z),c.scale=n,this.onScaleChanged(),"none"===c.mode){const a=this.mode||function(t,e,a,i){const{renderStart:o,renderEnd:s}=t,r=lt(o,i,j.get()),n=lt(s,i,j.get());if(u(r,n)<B*B)return null;const l=d(j.get(),o,a),c=p(j.get(),l,e),h=o,g=f(j.get(),h,c),m=lt(a,i,j.get()),D=r,M=lt(g,i,j.get()),y=d(j.get(),M,D),S=d(j.get(),r,m),b=I.wrap(D,y),R=I.wrap(m,S);if(I.distance2(b,n)<I.distance2(R,n))return"rotate";return"scale"}(e,e.plane,c.origin,this.tool.view.state.camera);if(t(a)){switch(a){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:i,angle:c.angle});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:i,scale:c.scale})}c.mode=a}}if(this.updateDragState(),t(i.symbol)){const t=i.symbol.clone();let e=0,a=1;switch(c.mode){default:case"none":break;case"scale":a=c.scale;break;case"rotate":e=c.angle}this.applySymbolData(t,c.startSymbolData,e,a),i.symbol=t,this.updateManipulatorTransform()}switch(e.action){case"start":case"update":switch(c.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:i,angle:c.angle});break;case"scale":this.tool.emit("graphic-scale",{graphic:i,scale:c.scale})}break;case"end":switch(c.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:i,angle:c.angle});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:i,scale:c.scale});break;default:case"none":}}"end"===e.action&&(this.startAnimation(ct(this,(()=>this.onScaleChanged()))),this._scaleRotateDragData=null,this.updateDragState())})),r.next(U(i)).next((()=>{if(t(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:i,angle:this._scaleRotateDragData.startAngle});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:i,scale:1})}this.startAnimation(ct(this,(()=>this.onScaleChanged()))),this._scaleRotateDragData=null}}))}));this._handles.add(s),this._handles.add([this.ringManipulator.events.on("focus-changed",(t=>{"focus"===t.action?this.startAnimation(function(t,e){let a=0,i=null;const o=()=>!1;return{start:()=>{i=t.getFocused,t.getFocused=o,a=0,e()},update:t=>(a+=t,!i()||a>K?1:0),destroy:()=>{t.getFocused=i,e()}}}(this,(()=>this.updateDelayedFocusedState()))):this.updateDelayedFocusedState()})),this.ringManipulator.events.on("immediate-click",(t=>{t.stopPropagation()})),y(this.tool.graphicState,"displaying",(t=>this.ringManipulator.available=t)),this.tool.graphicState.on("changed",(()=>C(this.tool.view,this.ringManipulator,i)))]),C(this.tool.view,this.ringManipulator,i)}onScaleChanged(){this.events.emit("scale-changed"),this.updateManipulatorTransform()}updateDelayedFocusedState(){this.ringManipulator.updateStateEnabled(rt.DelayedFocused,this.getFocused())}updateDragState(){if(this.ringManipulator.updateStateEnabled(rt.Unlocked,!(t(this._scaleRotateDragData)&&"none"!==this._scaleRotateDragData.mode)),t(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this.ringManipulator.updateStateEnabled(rt.ScaleIn|rt.ScaleOut,!1),this.ringManipulator.updateStateEnabled(rt.RotateLeft,this._scaleRotateDragData.angleDir<0),this.ringManipulator.updateStateEnabled(rt.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this.ringManipulator.updateStateEnabled(rt.RotateLeft|rt.RotateRight,!1),this.ringManipulator.updateStateEnabled(rt.ScaleIn,this._scaleRotateDragData.scaleDir<0),this.ringManipulator.updateStateEnabled(rt.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this.ringManipulator.updateStateEnabled(rt.ScaleIn|rt.ScaleOut|rt.RotateLeft|rt.RotateRight,!1)}updateManipulatorTransform(){const t=S(A.get()),e=this.tool.symbolRotationAngle;b(t,t,e,l(0,0,1));const a=this.getScale(),i=R(A.get(),g(j.get(),a,a,a)),o=S(A.get());v(o,i,t),this.ringManipulator.modelTransform=o}createRingManipulator(){const t=(t,e,a)=>{const i=[],o=Math.ceil(ot*(e-t)/(2*Math.PI));for(let s=0;s<o+1;s++){const r=t+s*(e-t)/o;i.push(l(a*Math.cos(r),a*Math.sin(r),0))}return i},e=e=>t(0,2*Math.PI,e),a=(t,e)=>new P(E.createPathExtrusionGeometry((t=>[[-t/2,0],[t/2,0],[t/2,G/2],[-t/2,G/2]])(e),t,[],[],!1),"graphic-transform-ring"),i=e(Y),o=a(i,q),s={left:[],right:[]},r=[];for(let e=0;e<2;e++){const i=e*Math.PI-Math.PI/4,o=Math.PI/2-$,n=i+o,l=i+Math.PI/2-o,c=t(n,l,tt),h=a(c,Q);r.push(c),r.push(t(n,l,et-q/2)),s.left.push(h),s.right.push(h);for(let t=0;t<2;t++){const e=0===t,a=k();if(e){w(a,a,[1,-1,1]),b(a,a,-n,[0,0,1]);const t=Math.round(W*(c.length-1));a[12]=c[t][0],a[13]=c[t][1],a[14]=c[t][2]}else{b(a,a,l,[0,0,1]);const t=Math.round((1-W)*(c.length-1));a[12]=c[t][0],a[13]=c[t][1],a[14]=c[t][2]}const i=E.createExtrudedTriangle(H,0,V,G);E.transformInPlace(i,a);const o=new P(i,"graphic-transform-ring-rotate");(e?s.left:s.right).push(o)}}const n=[];for(let e=0;e<2;e++){const i=e*Math.PI-Math.PI/4,o=Math.PI/2-st,s=i+o,r=i+Math.PI/2-o,l=t(s,r,et);n.push(a(l,Q))}const c=e(Y+at),h=e(Y+it),g=a(c,Q),d=a(h,Q),m=e(Y-at),u=e(Y-it),p=a(m,Q),f=a(u,Q),D=this.createMaterial(),M=this.createMaterial(.66),y=this.createMaterial(.5),S=this.createMaterial(.33);let R=[{geometry:o,material:D,stateMask:rt.DelayedFocused},{geometry:o,material:y,stateMask:0}];this.mode&&"scale"!==this.mode||(R=R.concat([{geometry:n,material:D,stateMask:rt.DelayedFocused|rt.Unlocked},{geometry:g,material:M,stateMask:rt.DelayedFocused|rt.ScaleIn},{geometry:d,material:S,stateMask:rt.DelayedFocused|rt.ScaleIn},{geometry:p,material:M,stateMask:rt.DelayedFocused|rt.ScaleOut},{geometry:f,material:S,stateMask:rt.DelayedFocused|rt.ScaleOut}])),this.mode&&"rotate"!==this.mode||(R=R.concat([{geometry:s.right,material:D,stateMask:rt.DelayedFocused|rt.Unlocked},{geometry:s.left,material:D,stateMask:rt.DelayedFocused|rt.RotateLeft},{geometry:s.right,material:D,stateMask:rt.DelayedFocused|rt.RotateRight}]));const v=[i,...r];return new x({view:this.tool.view,renderObjects:R,autoScaleRenderObjects:!1,worldOriented:!0,radius:q,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:_(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:v,direction:l(0,0,1)}})}createMaterial(t=1){const e=[...X,t];return new L({color:e,transparent:1!==t,cullFace:2,renderOccluded:2},"graphic-transform")}applySymbolData(e,a,i,o){e.symbolLayers.forEach(((e,s)=>{const{heading:r,size:n}=a.symbolLayers[s];"object"===e.type&&(e.heading=(t(r)?r:0)-h(i),t(n)&&"width"in n&&(n.width=this.enforceNonZeroSize(n.width),n.height=this.enforceNonZeroSize(n.height),n.depth=this.enforceNonZeroSize(n.depth),e.width=n.width*o,e.depth=n.depth*o,e.height=n.height*o))}))}enforceNonZeroSize(t){return t||this.tool.view.state.camera.computeRenderPixelSizeAt(this.ringManipulator.renderLocation)}get test(){return{ringManipulator:this.ringManipulator}}}function lt(t,e,a){const i=e.projectToRenderScreen(t,s(ht)),o=e.renderToScreen(i,gt);return g(a,o[0],o[1],0)}function ct(t,e){let a=null,i=1;const o=()=>i;return{start:()=>{i=t.getScale(),a=t.getScale,t.getScale=o,e()},update:t=>(i+=((i+1)/2-i)*Math.min(t*J,1),e(),Math.abs(i-1)<.01?1:0),destroy:()=>{t.getScale=a,e()}}}const ht=c(),gt=r();export{nt as GraphicScaleRotateTransform};
