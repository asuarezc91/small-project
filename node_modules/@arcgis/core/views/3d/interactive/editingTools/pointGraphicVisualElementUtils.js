/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as e}from"../../../../core/maybe.js";import{handlesGroup as t,destroyHandle as n,refHandle as o}from"../../../../core/handleUtils.js";import{deg2rad as i}from"../../../../core/mathUtils.js";import{c as r}from"../../../../chunks/vec3f64.js";import{s as a}from"../../../../chunks/vec3.js";import{init as s}from"../../../../core/watchUtils.js";import{containsXY as l}from"../../../../geometry/support/aaBoundingRect.js";import{projectVectorToVector as p,projectPointToVector as c}from"../../../../geometry/projection.js";import{create as m,empty as h,getMin as u}from"../../../../geometry/support/aaBoundingBox.js";import{getGraphicEffectiveElevationInfo as g}from"../../../../support/elevationInfoUtils.js";import{evaluateElevationAlignmentAtPoint as d}from"../../layers/graphics/elevationAlignmentUtils.js";import{ElevationContext as f}from"../../layers/graphics/ElevationContext.js";import{LaserlineVisualElement as v}from"../visualElements/LaserlineVisualElement.js";import{ExtendedLineVisualElement as y}from"../visualElements/ExtendedLineVisualElement.js";import{PointVisualElement as E}from"../visualElements/PointVisualElement.js";import{settings as w}from"./settings.js";import{ManipulatorState as j}from"./ManipulatorState.js";import{GraphicState as b}from"../../layers/graphics/GraphicState.js";function x(r){const{view:m,graphic:x}=r,A=new b({graphic:x}),C=[],M=function(t,i,r){const{view:a,graphic:p}=t,m=new E({view:a,geometry:S(p)?p.geometry:null,elevationInfo:g(p),attached:!1});return function(t,n,i,r){const a=()=>n.attached=i.displaying;(function(t,n,i,r){const{view:a,graphic:s}=t;let p=null;const m=()=>{e(p)&&(p.remove(),p=null),i.isDraped&&S(s)&&(p=function(e,t,n){const o=e.elevationProvider.spatialReference;c(t,L,o);const i=L[0],r=L[1];return e.elevationProvider.on("elevation-change",(e=>{l(e.extent,i,r)&&n()}))}(a,s.geometry,(()=>{n.geometry=s.geometry})))},h=()=>{m(),n.geometry=S(s)?s.geometry:null};r.push(i.on("changed",h),o((()=>p))),h()})(t,n,i,r),w.visualElements.pointGraphics.outline.apply(n),r.push(s(i,"displaying",a))}(t,m,i,r),r.push(n(m)),m}(r,A,C);return function(e,t,o,r){const{view:s,graphic:l}=e,c=new y({view:s,extensionType:w.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4});w.visualElements.zVerticalLine.apply(c);const m=new v({view:s,intersectsLineInfinite:!0,attached:!1});w.visualElements.pointGraphics.shadowStyle.apply(m);const E=i(w.visualElements.heightPlaneAngleCutoff),b=new v({view:s,attached:!1,angleCutoff:E});w.visualElements.heightPlane.apply(b);const x=g(e.graphic),A=f.fromElevationInfo(x),C="on-the-ground"===x.mode||!x.offset&&"absolute-height"!==x.mode,M=new j;let R=1,U=1;const D=()=>{M.update(e);const n=C&&(t.isDraped||!S(l)||!l.geometry.hasZ);let o=!0;if(!n&&S(l)){const e=l.geometry,t=d(l.geometry,s.elevationProvider,A,s.renderCoordsHelper);a(L,e.x,e.y,t),p(L,e.spatialReference,L,s.renderCoordsHelper.spatialReference),c.setStartEndFromWorldDownAtLocation(L),m.intersectsWorldUpAtLocation=L}else o=!1;{const e=2&M.grabbingState?w.visualElements.laserlineAlphaMultiplier:1;e!==R&&(R=e,w.visualElements.heightPlane.apply(b,e))}{const e=h(P);!n&&t.displaying&&r.calculateMapBounds(e)&&p(u(e,L),s.spatialReference,L,s.renderCoordsHelper.spatialReference)?(b.heightManifoldTarget=L,b.attached=!0):b.attached=!1}{const e=4&M.grabbingState?w.visualElements.laserlineAlphaMultiplier:1;e!==U&&(U=e,w.visualElements.pointGraphics.shadowStyle.apply(m,e))}const i=o&&t.displaying&&!n;m.attached=i,c.attached=i};o.push(t.watch(["displaying","isDraped"],D),t.on("changed",D)),e.forEachManipulator((e=>{o.push(e.events.on("grab-changed",D))})),o.push(n(m)),o.push(n(c)),o.push(n(b)),D()}(r,A,C,M),C.push(m.trackGraphicState(A)),{visualElement:M,remove(){t(C).remove()}}}function S(t){return e(t.geometry)&&"point"===t.geometry.type}const L=r(),P=m();export{x as createVisualElements};
