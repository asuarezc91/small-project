/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as e}from"../../../../core/maybe.js";import{handlesGroup as t,destroyHandle as a,refHandle as n}from"../../../../core/handleUtils.js";import{deg2rad as i}from"../../../../core/mathUtils.js";import{c as l}from"../../../../chunks/vec3f64.js";import{s,b as o,a as r}from"../../../../chunks/vec3.js";import{getGraphicEffectiveElevationInfo as c}from"../../../../support/elevationInfoUtils.js";import{LaserlineVisualElement as p}from"../visualElements/LaserlineVisualElement.js";import{ExtendedLineVisualElement as m}from"../visualElements/ExtendedLineVisualElement.js";import{Manipulator3D as h}from"../Manipulator3D.js";import{settings as u}from"./settings.js";import{OutlineVisualElement as d}from"../visualElements/OutlineVisualElement.js";import{ManipulatorState as g}from"./ManipulatorState.js";import{GraphicState as f}from"../../layers/graphics/GraphicState.js";function v(l){const{view:d,graphic:v}=l,b=new f({graphic:v}),S=y(l,b),j=[S,function(l,d,f){const{graphic:v,view:y}=l,b=[],S=c(v),j="on-the-ground"===S.mode||!S.offset&&"absolute-height"!==S.mode,M=new g,G=new m({view:y,extensionType:u.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4});u.visualElements.pointGraphics.shadowStyle.apply(G);const L=i(u.visualElements.heightPlaneAngleCutoff),D=new p({view:y,attached:!1,angleCutoff:L});u.visualElements.heightPlane.apply(D);let C=1,V=1;const k=()=>{if(M.update(l),!f.displaying||j&&(f.isDraped||!E(v)||!v.geometry.hasZ))return d.laserlineEnabled=!1,G.attached=!1,void(D.attached=!1);d.laserlineEnabled=!0;{const e=4&M.grabbingState?u.visualElements.laserlineAlphaMultiplier:1;e!==C&&(C=e,u.visualElements.lineGraphics.shadowStyle.apply(d,e),u.visualElements.pointGraphics.shadowStyle.apply(G,e))}{const e=2&M.grabbingState?u.visualElements.laserlineAlphaMultiplier:1;e!==V&&(V=e,u.visualElements.heightPlane.apply(D,e))}!function(t,a){const n=1===a.numSelected?a.firstSelected:a.numSelected>1&&e(a.firstGrabbedXY)?a.firstGrabbedXY:null;e(n)?(t.setStartEndFromWorldDownAtLocation(n.renderLocation),t.attached=!0):t.attached=!1}(G,M),function(t,a,n,i){if(i.numSelected>0){s(w,0,0,0);let e=0;t.forEachManipulator(((t,a)=>{1===a&&t.selected&&t instanceof h&&(o(w,w,t.renderLocation),e++)})),e>0?(n.heightManifoldTarget=r(w,w,1/e),n.attached=!0):n.attached=!1}else{const i=a.attachmentOrigin;e(i)&&t.view.renderCoordsHelper.toRenderCoords(i,w)?(n.heightManifoldTarget=w,n.attached=!0):n.attached=!1}}(l,d,D,M)};u.visualElements.zVerticalLine.apply(G),b.push(f.on("changed",k),f.watch("displaying",k),d.events.on("attachment-origin-changed",k),a(G),a(D));const x=[],A=()=>{t(x).remove(),x.length=0,l.forEachManipulator((e=>x.push(e.events.on("grab-changed",k)))),l.forEachManipulator((e=>x.push(e.events.on("select-changed",k)))),k()};return A(),b.push(l.onManipulatorsChanged(A),n((()=>t(x)))),t(b)}(l,S.visualElement,b),d.maskOccludee(v),d.trackGraphicState(b)];return{visualElement:S.visualElement,remove:()=>t(j).remove()}}function y(e,n){const{view:i,graphic:l}=e,s=new d({view:i,geometry:E(l)?l.geometry:null,elevationInfo:c(l),attached:!1});u.visualElements.lineGraphics.shadowStyle.apply(s);const o=()=>{s.attached=n.displaying};u.visualElements.lineGraphics.outline.apply(s);const r=[n.watch("displaying",o),n.watch("isDraped",(e=>s.isDraped=e)),n.on("changed",(()=>s.geometry=E(l)?l.geometry:null)),a(s)];return o(),{visualElement:s,remove:()=>t(r).remove()}}function E(t){return e(t.geometry)&&("polygon"===t.geometry.type||"polyline"===t.geometry.type)}const w=l();export{y as createGeometryRepresentationVisualElement,v as createVisualElements};
