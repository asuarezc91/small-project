/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{unwrap as t}from"../../../../../core/maybe.js";import e from"../../../../../core/Evented.js";import{clamp as r}from"../../../../../core/mathUtils.js";import{c as a,f as i}from"../../../../../chunks/vec3f64.js";import{w as o,f as s,n,d as l,c as m,a as p}from"../../../../../chunks/vec3.js";import c from"../../../../../core/Handles.js";import{t as u,e as h,s as d}from"../../../../../chunks/mat4.js";import{darken as f}from"../../../../../core/colorUtils.js";import{a as M}from"../../../../../chunks/mat4f64.js";import g from"../../../webgl-engine/lib/GeometryUtil.js";import _ from"../../../webgl-engine/lib/Geometry.js";import{createManipulatorDragEventPipeline as y,addScreenDelta as j}from"../../../../interactive/dragEventPipeline.js";import{screenToZConstrained as v}from"../dragEventPipeline3D.js";import{Manipulator3D as w}from"../../Manipulator3D.js";import{createManipulatorMaterial as z}from"../../manipulatorUtils.js";import{settings as b}from"../settings.js";import{DISC_RADIUS as k}from"./config.js";import{Manipulation as P}from"./Manipulation.js";import{createGraphicMoveDragPipeline as x}from"./moveUtils.js";class D extends P{constructor(t){super(),this._handles=new c,this._radius=k,this.events=new e,this._tool=t.tool,this._view=t.view,null!=t.radius&&(this._radius=t.radius),this.createManipulator(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}destroy(){this._handles.destroy(),this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()}))}forEachManipulator(t){t(this._manipulator,0)}createGraphicDragPipeline(e,r){const a=t(e.graphic.geometry).spatialReference;return x(e,r,(t=>this.createDragPipeline(t,a)))}createDragPipeline(t,e){const r=this._view;return y(this._manipulator,((a,i,o,s,n)=>{const l=i.next((t=>({...t,manipulatorType:0}))).next(v(r,a.renderLocation,e)).next(j());t(a,l,o,s,n)}))}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this.updateManipulator())}updateManipulator(){const t=this._radius/k,e=b.zManipulator.height*t,r=b.zManipulator.coneHeight*t,a=b.zManipulator.coneWidth*t,o=b.zManipulator.width*t,s=[i(0,0,0),i(0,0,e)],n=new _(g.createTubeGeometry(s,o/2,16,!1),"move-z"),l=g.createConeGeometry(r,a/2,16,!1),m=new _(l),p=[i(0,0,0),i(0,0,e+r)],c=(t=>{const r=M();if(u(r,r,[0,0,e]),h(r,r,Math.PI/2),t){const e=1+2*t/a;d(r,r,[e,e,e])}return r})(0),y=(t,e)=>{const r=f(b.zManipulator.color,e);return[r.r/255,r.g/255,r.b/255,b.zManipulator.color.a*t]},j=z(y(1,.25),1),v=z(y(1,0),1),w=z(y(.7,0),b.zManipulator.renderOccluded),P=z(y(.85,0),b.zManipulator.renderOccluded);this._manipulator.renderObjects=[{geometry:m,transform:c,material:j,stateMask:1},{geometry:n,material:j,stateMask:1},{geometry:m,transform:c,material:v,stateMask:2},{geometry:n,material:v,stateMask:2},{geometry:m,transform:c,material:w,stateMask:1},{geometry:n,material:w,stateMask:1},{geometry:m,transform:c,material:P,stateMask:2},{geometry:n,material:P,stateMask:2}],this._manipulator.radius=o/2+2,this._manipulator.collisionType={type:"line",paths:[p]}}createManipulator(){const t=new w({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});t.applyObjectTransform=t=>{const e=this._view.state.camera,a=E;this._view.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,a);const i=o(e.eye,a),c=e.computeRenderPixelSizeAtDist(i),u=s(O,a,e.eye);n(u,u);const h=U;this._view.renderCoordsHelper.worldUpAtPosition(E,h);const d=Math.abs(l(u,h)),f=m(O,u,h),M=m(O,f,h),g=r(d,.01,1),_=1-Math.sqrt(1-g*g)/g/e.fullWidth,y=this._radius/k,j=b.zManipulator.width*y;p(M,n(M,M),(1/_-1)*i+c*j),t[12]-=O[0],t[13]-=O[1],t[14]-=O[2]},this._manipulator=t,this.updateManipulator()}}const E=a(),O=a(),U=a();export{D as MoveZManipulation};
