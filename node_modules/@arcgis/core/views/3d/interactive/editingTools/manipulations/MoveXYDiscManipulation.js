/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{unwrap as t}from"../../../../../core/maybe.js";import e from"../../../../../Color.js";import{f as i}from"../../../../../chunks/vec3f64.js";import{s as a}from"../../../../../chunks/vec3.js";import r from"../../../../../core/Handles.js";import{p as s}from"../../../../../chunks/mat4.js";import{a as o}from"../../../../../chunks/mat4f64.js";import{getGraphicEffectiveElevationInfo as n}from"../../../../../support/elevationInfoUtils.js";import{sv3d as l,sm4d as p}from"../../../support/stack.js";import c from"../../../webgl-engine/lib/GeometryUtil.js";import m from"../../../webgl-engine/lib/Geometry.js";import{ColorMaterial as u}from"../../../webgl-engine/materials/ColorMaterial.js";import{createManipulatorDragEventPipeline as h,dragAtLocation as d,addScreenDelta as _}from"../../../../interactive/dragEventPipeline.js";import{screenToMapXYAtLocation as f}from"../dragEventPipeline3D.js";import{Manipulator3D as g}from"../../Manipulator3D.js";import{colors as M}from"../settings.js";import{DISC_RADIUS as j,DISC_HEIGHT as y,GEOMETRY_SEGMENTS as S,DISC_COLLISION_RADIUS as v}from"./config.js";import{Manipulation as T}from"./Manipulation.js";import{createGraphicMoveDragPipeline as w}from"./moveUtils.js";import{SnapToScene as b}from"../snapping/SnapToScene.js";class x extends T{constructor(t){super(),this._handles=new r,this._snapToScene=new b,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),this._scale=1,this._radius=j,this._view=t.view,this._tool=t.tool,null!=t.snapToScene&&(this.snapToScene=t.snapToScene),null!=t.radius&&(this._radius=t.radius),this._createManipulator(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}destroy(){this._handles.destroy(),this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(t){t(this._manipulator,1)}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(t){this._snapToScene.enabled=t}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}createGraphicDragPipeline(e,i){const a=e.graphic,r=n(a),s=t(a.geometry).spatialReference;return w(e,i,(t=>this.createDragPipeline(t,r,s)))}createDragPipeline(t,e,i){const a=this._view;return h(this._manipulator,((r,s,o,n,l)=>{const p=s.next(d(a,r.elevationAlignedLocation)).next(f(a,r.elevationAlignedLocation,e,i)).next(this._snapToScene.createDragEventPipelineStep(a,e),this._snapToScene.next).next((t=>({...t,manipulatorType:1}))).next(_());t(r,p,o,n,l)}))}_updateManipulatorTransform(){const t=s(p.get(),a(l.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=t}_createManipulator(){const t=this._view;this._manipulator=new g({view:t,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:i(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const t=new m(c.createCylinderGeometry(y,1,S,i(0,0,1),i(0,0,0)),"graphic-transform-disc"),e=s(o(),i(this._radius,this._radius,this._radius));this._manipulator.renderObjects=[{geometry:t,material:this._discMaterial,transform:e,stateMask:2},{geometry:t,material:this._discMaterialTransparent,transform:e,stateMask:1}],this._manipulator.radius=v*(this._radius/j)}_createMaterial(t=1){const i=e.toUnitRGBA(M.main);return i[3]*=t,new u({color:i,transparent:1!==t,cullFace:2,renderOccluded:2},"move-xy-disc")}get test(){return{discManipulator:this._manipulator}}}export{x as MoveXYDiscManipulation};
