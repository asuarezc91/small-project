/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as t,unwrap as e}from"../../../../core/maybe.js";import{createRenderScreenPointArray as s,createRenderScreenPointArray3 as i,createScreenPointArray as o}from"../../../../core/screenUtils.js";import{c as h}from"../../../../chunks/vec3f64.js";import r from"../../../../core/Handles.js";import{s as a,n,l,a as c,h as m}from"../../../../chunks/vec2.js";import{VisualElement as _}from"./VisualElement.js";import u from"../../../overlay/LineOverlayItem.js";import d from"../../../overlay/TextOverlayItem.js";import{screenSpaceTangent as p}from"../measurementTools/support/viewUtils.js";class x extends _{constructor(t){super(t.view),this._handles=new r,this._textItem=null,this._calloutItem=null,this._showCallout=!0,this._showText=!0,this._geometry=null,this._text=null,this._fontSize=14,this._distance=25,this._anchor="right",this.applyProps(t)}get geometry(){return this._geometry}set geometry(t){this._geometry=t,this._updateLabelPosition()}get textItem(){return this._textItem}get text(){return this._text}set text(t){this._text=t,this.attached&&(this._textItem.text=this._text)}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize=t,this.attached&&(this._textItem.fontSize=this._fontSize)}get distance(){return this._distance}set distance(t){this._distance!==t&&(this._distance=t,this._updateLabelPosition())}get anchor(){return this._anchor}set anchor(t){this._anchor!==t&&(this._anchor=t,this._updateLabelPosition())}_updateLabelPosition(){if(this.attached&&t(this.geometry)&&this.view._stage)switch(this.geometry.type){case"point":this._computeLabelPositionFromPoint(this.geometry,f)?(this._textItem.position=[f[0],f[1]],this._textItem.anchor="center",this._showText=!0):this._showText=!1,this._showCallout=!1;break;case"euclidean":case"geodesic":if(this._computeLabelPositionFromSegment(this.geometry,this._distance,this._anchor,f,y)){const t=y[0]-f[0],e=y[1]-f[1];this._textItem.position=[y[0],y[1]],this._textItem.anchor=Math.abs(t)>Math.abs(e)?t>0?"left":"right":e>0?"top":"bottom",this._textItem.visible=this.visible,this._calloutItem.startPosition=[f[0],f[1]],this._calloutItem.endPosition=[y[0],y[1]],this._showText=!0,this._showCallout=!0}else this._showText=!1,this._showCallout=!1}this.updateVisibility(this.visible)}_computeLabelPositionFromPoint(t,e){this.view.renderCoordsHelper.toRenderCoords(t,w);const s=this.view._stage.getCamera();return s.projectToRenderScreen(w,g),!(g[2]<0||g[2]>1)&&(s.renderToScreen(g,e),!0)}_computeLabelPositionFromSegment(t,e,s,i,o){if(!t)return!1;const h=this.view._stage.getCamera();p(t.startRenderSpace,t.endRenderSpace,b,h),a(v,-b[1],b[0]);let r=!1;switch(s){case"top":r=v[1]<0;break;case"bottom":r=v[1]>0;break;case"left":r=v[0]>0;break;case"right":r=v[0]<0}if(r&&n(v,v),0===l(v))switch(s){case"top":v[1]=1;break;case"bottom":v[1]=-1;break;case"left":v[0]=-1;break;case"right":v[0]=1}return t.eval(.5,w),h.projectToRenderScreen(w,g),!(g[2]<0||g[2]>1)&&(h.renderToScreen(g,i),c(v,v,e*h.pixelRatio),m(v,v,g),h.renderToScreen(v,o),!0)}createResources(){this._textItem=new d({visible:!0}),this._textItem.text=e(this._text),this._textItem.fontSize=this._fontSize,this._calloutItem=new u({visible:!0,width:2}),this._updateLabelPosition(),this.view.overlay.items.addMany([this._textItem,this._calloutItem]),this._handles.add(this.view.state.watch("camera",(()=>{this._updateLabelPosition()})))}destroyResources(){this.view.overlay&&!this.view.overlay.destroyed&&this.view.overlay.items.removeMany([this._textItem,this._calloutItem]),this._handles.removeAll()}updateVisibility(t){this._textItem.visible=this._showText&&t,this._calloutItem.visible=this._showCallout&&t}}const b=s(),v=s(),w=h(),g=i(),f=o(),y=o();export{x as LabelVisualElement};
