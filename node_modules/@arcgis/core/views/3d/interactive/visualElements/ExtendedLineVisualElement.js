/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import"../../../../core/has.js";import{isSome as e,unwrap as t,isNone as s,unwrapOr as i}from"../../../../core/maybe.js";import{c as r,f as n}from"../../../../chunks/vec3f64.js";import{g as a,f as l,m as o,p as h}from"../../../../chunks/vec3.js";import d from"../../../../core/Handles.js";import{g as p,c as _}from"../../../../chunks/vec4.js";import{f as c,g as u,d as f,b as m}from"../../../../chunks/clipRay.js";import{ray as g,lineSegment as y,frustum as x}from"../../support/geometryUtils.js";import w from"../../webgl-engine/lib/GeometryUtil.js";import b from"../../webgl-engine/lib/Geometry.js";import{RibbonVertexAttributeConstants as R}from"../../webgl-engine/shaders/RibbonLineTechnique.js";import{RibbonLineMaterial as E}from"../../webgl-engine/materials/RibbonLineMaterial.js";import{f as O,a as C}from"../../../../chunks/vec4f32.js";import{LaserlineVisualElement as P}from"./LaserlineVisualElement.js";import{Object3DVisualElement as A}from"./Object3DVisualElement.js";class j extends A{constructor(e){super(e),this._ray=g.create(),this._externalResources=null,this._handles=new d,this._isWorldDown=!1,this._start=r(),this._end=n(1,0,0),this._width=1,this._color=O(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=O(1,1,1,1),this._stippleIntegerRepeats=!0,this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._extensionType=0,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=4,this._fadedExtensions=I,this.applyProps(e)}createExternalResources(){const e=new E(this.materialParameters,"lineVisualElement");this._handles.add(this.view.state.watch("camera",(()=>{this.updateGeometry()})));const t=new P({view:this.view,attached:this._laserlineEnabled});this._externalResources={material:e,laserline:t}}destroyExternalResources(){e(this._externalResources)&&this._externalResources.laserline.destroy(),this._externalResources=null,this._handles.removeAll()}forEachExternalResource(t){e(this._externalResources)&&t(this._externalResources.material)}createGeometries(e){const s=[r(),r()],i=3===this.extensionType;i&&s.push(r(),r());const n=new b(w.createPolylineGeometry(s),"lineVisualElement");i&&(n.data.vertexAttributes[R.COLOR]={size:4,data:new Float32Array([1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]),offsetIdx:0,strideIdx:4},n.data.indices[R.COLOR]=new Uint32Array([0,1,2,3])),e.addGeometry(n,t(this._externalResources).material),this.updateVertices(n)}updateVisibility(t){super.updateVisibility(t),e(this._externalResources)&&(this._externalResources.laserline.visible=t)}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,a(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),l(this._end,e,this._end),g.fromPoints(this._start,this._end,this._ray),this.updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,o(this._start,e)||(a(this._start,e),g.fromPoints(this._start,this._end,this._ray),this.updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,o(this._end,e)||(a(this._end,e),g.fromPoints(this._start,this._end,this._ray),this.updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this.updateMaterial())}get color(){return this._color}set color(e){p(e,this._color)||(_(this._color,e),this.updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this.updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this.updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this.updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){p(e,this._innerColor)||(_(this._innerColor,e),this.updateMaterial())}get stippleIntegerRepeats(){return this._stippleIntegerRepeats}set stippleIntegerRepeats(e){e!==this._stippleIntegerRepeats&&(this._stippleIntegerRepeats=e,this.updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(t){const s=e(t)!==e(this._stipplePattern);this._stipplePattern=t,s?this.recreate():this.updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(t){(s(t)||s(this._stippleOffColor)||!p(t,this._stippleOffColor))&&(this._stippleOffColor=e(t)?C(t):null,this.updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this.updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this.updateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&e(this._laserlineStyle)}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(t){this._laserlineStyle=t,e(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached,e(t)&&(this._externalResources.laserline.style=t))}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(t){this._laserlineEnabled!==t&&(this._laserlineEnabled=t,e(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached))}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this.updateMaterial())}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=i(e,I),this.recreateGeometry()}updateMaterial(){if(s(this._externalResources))return;this._externalResources.material.setParameterValues(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stippleIntegerRepeats:this._stippleIntegerRepeats,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,polygonOffset:this._polygonOffset,renderOccluded:this._renderOccluded,writeDepth:this._writeDepthEnabled}}updateGeometry(){e(this.object)&&this.updateVertices(this.object.geometries[0])}updateVertices(t){const s=3===this._extensionType?this.updateLineSegmentFinite(V):this.updateLineSegmentInfinite(this._extensionType,V);this.updateVertexAttributes(t,s),e(this._externalResources)&&(this._externalResources.laserline.intersectsLine=s)}updateLineSegmentFinite(e){return y.fromPoints(this._start,this._end,e)}updateLineSegmentInfinite(e,t){const s=this.view.state.camera;switch(c(this._ray,v),e){case 0:v.c0=-Number.MAX_VALUE;break;case 1:case 2:{const e=this._ray.origin,t=this.view.elevationProvider.getElevation(e[0],e[1],e[2],this.view.renderCoordsHelper.spatialReference,"ground")||0,s=this.view.renderCoordsHelper.getAltitude(e);this._isWorldDown&&s<t&&h(v.ray.direction,v.ray.direction),2===this._extensionType&&null!=t&&(v.c1=Math.abs(s-t));break}}if(!x.intersectClipRay(s.frustum.planes,v))return y.fromPoints(this._start,this._end,t);const i=u(v,D),r=f(v,M);return y.fromPoints(i,r,t)}updateVertexAttributes(t,s){const i=t.data.getVertexAttr()[R.POSITION].data;if(3===this.extensionType){{const e=y.pointAt(s,-this.fadedExtensions.start,D);i[0]=e[0],i[1]=e[1],i[2]=e[2]}{const e=y.pointAt(s,0,D);i[3]=e[0],i[4]=e[1],i[5]=e[2]}{const e=y.pointAt(s,1,D);i[6]=e[0],i[7]=e[1],i[8]=e[2]}{const e=y.pointAt(s,1+this.fadedExtensions.end,D);i[9]=e[0],i[10]=e[1],i[11]=e[2]}}else{{const e=y.pointAt(s,0,D);i[0]=e[0],i[1]=e[1],i[2]=e[2]}{const e=y.pointAt(s,1,D);i[3]=e[0],i[4]=e[1],i[5]=e[2]}}e(this.object)&&this.object.geometryVertexAttrsUpdated(0)}}const v=m(),D=r(),M=r(),V=y.create(),I={start:.3333333333333333,end:.3333333333333333};export{j as ExtendedLineVisualElement};
