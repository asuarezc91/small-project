/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as e,isNone as s}from"../../../../core/maybe.js";import{init as r}from"../../../../core/watchUtils.js";import t from"../../webgl-engine/lib/Object3D.js";import o from"../../webgl-engine/lib/Geometry.js";import i from"../../webgl-engine/lib/Layer.js";import c from"../../webgl-engine/lib/Texture.js";class a{constructor(e){this.resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get object(){return e(this._resources)?this._resources.object:null}get resources(){return e(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncVisible())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){if(!this.resourceFactory.recreateGeometry)return void this.recreate();const e=this.resourceFactory.view._stage;if(s(this._resources)||!e)return;const r=this._resources.object;this._resources.external.forEach((s=>{s instanceof o&&e.remove(2,s.id)})),r.removeAllGeometries();const t=this.resourceFactory.recreateGeometry(this._resources.external,r,this._resources.layer);for(const s of t)e.add(2,s)}_createOrDestroyResources(){this._attached?this._resources||this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this.resourceFactory.view._stage;if(!e)return;const s=new i("element",{isPickable:!1});e.add(0,s),e.addToViewContent([s.id]);const o=new t({idHint:"element",castShadow:!1}),c=this.resourceFactory.createResources(o,s);c.forEach((s=>{e.add(this._contentTypeFromResource(s),s)})),e.add(1,o),s.addObject(o),o.setVisible(this._visible);const a=this.resourceFactory.cameraChanged?r(this.resourceFactory.view.state,"camera",(e=>this.resourceFactory.cameraChanged(e))):null;this._resources={layer:s,object:o,external:c,cameraHandle:a}}_contentTypeFromResource(e){return e instanceof o?2:e instanceof c?4:3}_destroyResources(){if(s(this._resources))return;const e=this.resourceFactory.view._stage;null==e||e.remove(1,this._resources.object.id),null==e||e.remove(0,this._resources.layer.id),this._resources.external.forEach((s=>{null==e||e.remove(this._contentTypeFromResource(s),s.id),"dispose"in s&&s.dispose()})),this._resources.object.dispose(),this._resources.cameraHandle&&this._resources.cameraHandle.remove(),this._resources=null}_syncVisible(){s(this._resources)||this._resources.object.setVisible(this._visible)}}export{a as VisualElementResources};
