/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{neverReached as e}from"../../../core/compilerUtils.js";import{isSome as t,isNone as i,unwrapOr as s,unwrap as o}from"../../../core/maybe.js";import{once as n}from"../../../core/accessorSupport/utils.js";import r from"../../../geometry/Point.js";import"../../../geometry.js";import a from"../../../core/Evented.js";import{deg2rad as c}from"../../../core/mathUtils.js";import{createScreenPointArray as l,createRenderScreenPointArray3 as h,screenPointObjectToArray as d,castRenderScreenPointArray as _}from"../../../core/screenUtils.js";import{c as u,Z as g}from"../../../chunks/vec3f64.js";import{b as m,t as f,i as p,a as b,g as v,h as y,s as j,f as L}from"../../../chunks/vec3.js";import{getReferenceEllipsoid as S}from"../../../geometry/projectionEllipsoid.js";import{c as R,d as w,m as O,i as T}from"../../../chunks/mat4.js";import{containsPointObject as E}from"../../../geometry/support/aaBoundingRect.js";import{canProjectWithoutEngine as A,projectPoint as D,sphericalECEFToSphericalPCPF as I,computeLatLonToENURotation as P}from"../../../geometry/projection.js";import{a as F}from"../../../chunks/mat3f64.js";import{a as z}from"../../../chunks/mat4f64.js";import{f as k}from"../../../chunks/mat3.js";import{j as C}from"../../../chunks/vec2.js";import{getElevationAtPoint as M}from"../support/ElevationProvider.js";import{sv3d as x}from"../support/stack.js";import{ray as B,plane as V,lineSegment as W}from"../support/geometryUtils.js";import H from"../webgl-engine/lib/Object3D.js";import U from"../webgl-engine/lib/Camera.js";import{clonePoint as G}from"../../../layers/graphics/hydratedFeatures.js";import N from"../webgl-engine/lib/Layer.js";class Z{constructor(e){this.camera=new U,this._elevation={offset:0,override:null},this.collisionType={type:"point"},this.collisionPriority=0,this._renderObjects=[],this.autoScaleRenderObjects=!0,this._available=!0,this._noDisplayCount=0,this._radius=10,this._worldSized=!1,this.focusMultiplier=2,this.touchMultiplier=2.5,this.worldOriented=!1,this._modelTransform=z(),this._worldFrame=null,this._renderLocation=u(),this._renderLocationDirty=!0,this._location=new r({x:0,y:0,z:0}),this._elevationAlignedLocation=new r,this._elevationAlignedLocationDirty=!0,this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.cursor=null,this._grabbing=!1,this.dragging=!1,this._hovering=!1,this._selected=!1,this._state=0,this._focused=!1,this.events=new a.EventEmitter,this._screenLocation={screenPointArray:l(),renderScreenPointArray:h(),pixelSize:0},this._screenLocationDirty=!0,this._applyObjectTransform=null,this._engineResourcesAddedToStage=!1,this._engineResources=null,this._attached=!1,this._engineLayerId=null,this._materialIdReferences=null,this._location.spatialReference=e.view.spatialReference;for(const t in e)this[t]=e[t];this.view.state&&this.view.state.camera&&this.camera.copyFrom(this.view.state.camera)}destroy(){this._removeResourcesFromStage(),this._engineResources=null,this.view=null,this.camera=null}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this._elevationAlignedLocationDirty=!0,this._renderLocationDirty=!0,this._updateEngineObject()}get renderObjects(){return this._renderObjects}set renderObjects(e){this._removeResourcesFromStage(),this._engineResources=null,this._renderObjects=e.slice(),this._updateEngineObject()}set available(e){e!==this._available&&(this._available=e,this._updateEngineObject())}get available(){return this._available}disableDisplay(){return this._noDisplayCount++,1===this._noDisplayCount&&this._updateEngineObject(),{remove:n((()=>{this._noDisplayCount--,0===this._noDisplayCount&&this._updateEngineObject()}))}}set radius(e){e!==this._radius&&(this._radius=e,this._updateEngineObject())}get radius(){return this._radius}set worldSized(e){e!==this._worldSized&&(this._worldSized=e,this._updateEngineObject())}get worldSized(){return this._worldSized}get modelTransform(){return this._modelTransform}set modelTransform(e){q(e)&&(this._screenLocationDirty=!0),R(this._modelTransform,e),this._updateEngineObject()}get renderLocation(){return this._renderLocationDirty&&(this._renderLocationDirty=!1,this.view.renderCoordsHelper.toRenderCoords(this.elevationAlignedLocation,this._renderLocation),this.worldOriented?(this._worldFrame||(this._worldFrame=z()),function(e,t,i){switch(e.viewingMode){case"local":return T(i),!0;case"global":{const s=S(e.renderCoordsHelper.spatialReference);I(t,0,te,0,s.radius),P(c(te[1]),c(te[0]),i)}}}(this.view,this._renderLocation,this._worldFrame)):this._worldFrame&&(this._worldFrame=null)),this._renderLocation}set renderLocation(e){this.view.renderCoordsHelper.fromRenderCoords(e,this._location),this.elevationAlignedLocation=this._location}get location(){return this._location}set location(e){G(e,this._location),this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!0,this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}get elevationAlignedLocation(){return this._elevationAlignedLocationDirty?(this._evaluateElevationAlignment(),this._updateElevationAlignedLocation(),this._elevationAlignedLocation):this._elevationAlignedLocation}set elevationAlignedLocation(e){G(e,this._location),this._evaluateElevationAlignment(),this._location.z-=this._elevation.offset,this._updateElevationAlignedLocation(),this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}_updateElevationAlignedLocation(){this._elevationAlignedLocation.x=this.location.x,this._elevationAlignedLocation.y=this.location.y;const e=t(this._elevation.override)?this._elevation.override:this.location.z||0;this._elevationAlignedLocation.z=e+this._elevation.offset,this._elevationAlignedLocation.spatialReference=this.location.spatialReference,this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!1}grabbableForEvent(){return!0}get grabbing(){return this._grabbing}set grabbing(e){e!==this._grabbing&&(this._grabbing=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get hovering(){return this._hovering}set hovering(e){e!==this._hovering&&(this._hovering=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get selected(){return this._selected}set selected(e){e!==this._selected&&(this._selected=e,this._updateEngineObject(),this.events.emit("select-changed",{action:e?"select":"deselect"}))}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._updateEngineObject())}updateStateEnabled(e,t){t?this.state|=e:this.state&=~e}_setFocused(e){e!==this._focused&&(this._focused=e,this.events.emit("focus-changed",{action:!0===e?"focus":"unfocus"}))}get focused(){return this._focused}get screenLocation(){return this.ensureScreenLocation(),this._screenLocation}ensureScreenLocation(){if(!this._screenLocationDirty)return;this._screenLocation.pixelSize=this.camera.computeScreenPixelSizeAt(this.renderLocation),this._screenLocationDirty=!1;let e;if(q(this._modelTransform)){const t=this._calculateModelTransformOffset(re);e=m(t,t,this.renderLocation)}else e=this.renderLocation;this.camera.projectToRenderScreen(e,this._screenLocation.renderScreenPointArray),this.camera.renderToScreen(this._screenLocation.renderScreenPointArray,this._screenLocation.screenPointArray)}get applyObjectTransform(){return this._applyObjectTransform}set applyObjectTransform(e){this._applyObjectTransform=e,this._screenLocationDirty=!0,this._updateEngineObject()}intersectionDistance(t,s){if(!this.available)return null;const o=d(t,J),n=this._getCollisionRadius(s),r=-1*this.collisionPriority;switch(this.collisionType.type){case"point":if(C(this.screenLocation.screenPointArray,o)<n*n)return this.screenLocation.renderScreenPointArray[2]+r;break;case"line":{const e=this.collisionType.paths,t=this._getWorldToScreenObjectScale(),s=this._calculateObjectTransform(t,$),a=n*this.screenLocation.pixelSize,c=B.fromScreen(this.camera,o,Q);if(i(c))return null;for(const t of e){if(0===t.length)continue;const e=p(te,t[0],s);for(let i=1;i<t.length;i++){const o=p(ie,t[i],s),n=W.closestRayDistance2(W.fromPoints(e,o,K),c);if(null!=n&&n<a*a){const t=m(x.get(),e,o);b(t,t,.5);const i=_(x.get());return this.camera.projectToRenderScreen(t,i),i[2]+r}v(e,o)}}break}case"disc":{var a;const e=this.collisionType.direction,t=null!=(a=this.collisionType.offset)?a:g,s=this._getWorldToScreenObjectScale(),c=this._calculateObjectTransform(s,$),l=n*this.screenLocation.pixelSize,h=B.fromScreen(this.camera,o,Q);if(i(h))return null;const d=k(X,c),_=f(oe,e,d),u=p(ne,t,c);V.fromPositionAndNormal(u,_,ee);const m=se;if(V.intersectRay(ee,h,m)&&y(m,u)<l*l)return this.screenLocation.renderScreenPointArray[2]+r;break}case"ribbon":{const{paths:e,direction:t}=this.collisionType,s=this._getWorldToScreenObjectScale(),a=this._calculateObjectTransform(s,$),c=n*this.camera.computeScreenPixelSizeAt(this.renderLocation),l=B.fromScreen(this.camera,o,Q);if(i(l))return null;const h=k(X,a),d=f(oe,t,h),u=this._calculateModelTransformPosition(ne);V.fromPositionAndNormal(u,d,ee);const g=se;if(!V.intersectRay(ee,l,g))break;for(const t of e){if(0===t.length)continue;const e=p(te,t[0],a);for(let i=1;i<t.length;i++){const s=p(ie,t[i],a),o=W.distance2(W.fromPoints(e,s,K),g);if(null!=o&&o<c*c){const t=m(x.get(),e,s);b(t,t,.5);const i=_(x.get());return this.camera.projectToRenderScreen(t,i),i[2]+r}v(e,s)}}break}default:e(this.collisionType)}return null}attach(e={manipulator3D:{}}){if(!this.view._stage)return;const t=e.manipulator3D;if(this._engineLayerId=t.engineLayerId,i(this._engineLayerId)){const e=new N("manipulator-3d",{isPickable:!1});this.view._stage.add(0,e),this.view._stage.addToViewContent([e.id]),this._engineLayerId=e.id,t.engineLayerId=e.id}t.engineLayerReferences=(t.engineLayerReferences||0)+1,this._materialIdReferences=t.materialIdReferences,i(this._materialIdReferences)&&(this._materialIdReferences=new Map,t.materialIdReferences=this._materialIdReferences),this.camera.copyFrom(this.view.state.camera),this._attached=!0,this._updateEngineObject(),A(this._location.spatialReference,this.view.spatialReference)||(this.location=new r({x:0,y:0,z:0,spatialReference:this.view.spatialReference}))}detach(e={manipulator3D:{}}){const t=e.manipulator3D;t.engineLayerReferences--;const i=0===t.engineLayerReferences;i&&(t.engineLayerId=null),this._removeResourcesFromStage(i),this._engineResources=null,this._engineLayerId=null,this._materialIdReferences=null,this._attached=!1}onViewChange(){this.camera.copyFrom(this.view.state.camera),this._screenLocationDirty=!0,this._updateEngineObject()}onElevationChange(e){D(this.location,ae,e.spatialReference),E(e.extent,ae)&&(this.location=this._location)}_evaluateElevationAlignment(e=this.location){if(i(this.elevationInfo))return!1;let t=null,o=0;const n=s(this.elevationInfo.offset,0);switch(this.elevationInfo.mode){case"on-the-ground":t=M(this.view.elevationProvider,e,"ground")||0;break;case"relative-to-ground":o=(M(this.view.elevationProvider,e,"ground")||0)+n;break;case"relative-to-scene":o=(M(this.view.elevationProvider,e,"scene")||0)+n;break;case"absolute-height":o=n}return(o!==this._elevation.offset||t!==this._elevation.override)&&(this._elevation.offset=o,this._elevation.override=t,!0)}_updateEngineObject(){if(!this._attached)return;if(!this.available)return void this._removeResourcesFromStage();const e=this._getWorldToScreenObjectScale(),t=$;if(!0===this.autoScaleRenderObjects){const i=this._getFocusedSize(this._radius,this.focused)*e;this._calculateObjectTransform(i,t)}else this._calculateObjectTransform(e,t);const{objectsByState:i}=this._ensureEngineResources(),s=(this.focused?2:1)|(this.selected?8:4),o=this._noDisplayCount>0;for(const{stateMask:e,objects:n}of i){if(o){for(const e of n)e.setVisible(!1);continue}const i=!(0!=(15&e))||(s&e)==(15&e),r=!(0!=(65520&e))||(this.state&e)==(65520&e);if(i&&r)for(const e of n)e.setVisible(!0),e.objectTransformation=t;else for(const e of n)e.setVisible(!1)}}_ensureEngineResources(){if(i(this._engineResources)){const e=this.view._stage.getContent(0,o(this._engineLayerId)),t=[],i=new Set;this.renderObjects.forEach((({material:e})=>{i.has(e)||(t.push(e),i.add(e))}));const s=(e,t)=>{const{geometry:i,material:s,transform:o}=t;Array.isArray(i)?i.forEach((t=>e.addGeometry(t,s,o))):e.addGeometry(i,s,o)},n=new Map;this.renderObjects.forEach((e=>{const t=new H({idHint:"manipulator",castShadow:!1});s(t,e);const i=e.stateMask||0,o=n.get(i)||[];o.push(t),n.set(i,o)}));const r=[];n.forEach(((e,t)=>{r.push({stateMask:t,objects:e})})),this._engineResources={objectsByState:r,layer:e,materials:t}}return this._addResourcesToStage(),this._engineResources}_addResourcesToStage(){if(this._engineResourcesAddedToStage||i(this._engineResources))return;const{objectsByState:e,layer:t,materials:s}=this._engineResources;s.forEach((e=>{const t=o(this._materialIdReferences),i=t.get(e.id)||0;0===i&&this.view._stage.add(3,e),t.set(e.id,i+1)})),e.forEach((({objects:e})=>{e.forEach((e=>{t.addObject(e),this.view._stage.add(1,e)}))})),this._engineResourcesAddedToStage=!0}_removeResourcesFromStage(e=!1){if(!this._engineResourcesAddedToStage||i(this._engineResources))return;const{objectsByState:t,layer:s,materials:n}=this._engineResources;t.forEach((({objects:e})=>{e.forEach((e=>{s.removeObject(e),this.view._stage.remove(1,e.id)}))})),n.forEach((e=>{const t=o(this._materialIdReferences),i=t.get(e.id);1===i?(this.view._stage.remove(3,e.id),t.delete(e.id)):t.set(e.id,i-1)})),e&&this.view._stage.remove(0,s.id),this._engineResourcesAddedToStage=!1}_getCollisionRadius(e){return this._getFocusedSize(this.radius,!0)*("touch"===e?this.touchMultiplier:1)}_getFocusedSize(e,t){return e*(t?this.focusMultiplier:1)}_getWorldToScreenObjectScale(){return this._worldSized?1:this.screenLocation.pixelSize}_calculateModelTransformPosition(e){const t=this._getWorldToScreenObjectScale(),i=this._calculateObjectTransform(t,Y);return j(e,i[12],i[13],i[14])}_calculateModelTransformOffset(e){const t=this._calculateModelTransformPosition(e);return L(e,t,this.renderLocation)}_calculateObjectTransform(e,i){return w(i,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1),this._worldFrame&&O(i,i,this._worldFrame),O(i,i,this._modelTransform),i[12]+=this.renderLocation[0],i[13]+=this.renderLocation[1],i[14]+=this.renderLocation[2],i[15]=1,t(this._applyObjectTransform)&&this._applyObjectTransform(i),i}get test(){let e=!1;if(t(this._engineResources))for(const t in this._engineResources.objectsByState){const i=this._engineResources.objectsByState[t];for(const t of i.objects)if(t.isVisible){e=!0;break}if(e)break}return{areAnyResourcesVisible:e}}}function q(e){return 0!==e[12]||0!==e[13]||0!==e[14]}const J=l(),K=W.create(),Q=B.create(),X=F(),Y=z(),$=z(),ee=V.create(),te=u(),ie=u(),se=u(),oe=u(),ne=u(),re=u(),ae=new r({x:0,y:0,z:0,spatialReference:null});export{Z as Manipulator3D};
