/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{neverReached as e}from"../../../../../core/compilerUtils.js";import{isSome as t,isNone as i}from"../../../../../core/maybe.js";import r from"../../../../../core/Logger.js";import s from"../../../../../geometry/Point.js";import"../../../../../geometry.js";import{rad2deg as o,deg2rad as n}from"../../../../../core/mathUtils.js";import{castRenderScreenPointArray3 as a}from"../../../../../core/screenUtils.js";import{b as c,c as l,f as d}from"../../../../../chunks/vec3f64.js";import{a as m,g,d as u,c as p,n as f,b,l as h,f as w,o as y,s as j}from"../../../../../chunks/vec3.js";import{g as M,i as P,s as k,m as O,e as v,t as U,n as R}from"../../../../../chunks/mat4.js";import{a as S}from"../../../../../chunks/mat4f64.js";import{r as T}from"../../../../../chunks/quat.js";import{sv3d as A,sm4d as G,sq4d as I}from"../../../support/stack.js";import{b as F}from"../../../../../chunks/vector.js";import{plane as L,boundedPlane as z,ray as C}from"../../../support/geometryUtils.js";import{VertexAttrConstants as x}from"../../../webgl-engine/lib/Util.js";import{GeometryData as D}from"../../../webgl-engine/lib/GeometryData.js";import E from"../../../webgl-engine/lib/GeometryUtil.js";import N from"../../../webgl-engine/lib/Geometry.js";import{RibbonLineMaterial as V}from"../../../webgl-engine/materials/RibbonLineMaterial.js";import{NativeLineMaterial as B}from"../../../webgl-engine/materials/NativeLineMaterial.js";import{ColorMaterial as q}from"../../../webgl-engine/materials/ColorMaterial.js";import{Manipulator3D as W}from"../../Manipulator3D.js";import{calculateTranslateRotateFromBases as $}from"../../manipulatorUtils.js";import{SMALL_ANGLE_DOT_THRESHOLD as H,RESIZE_HANDLE_EDGE_PADDING_FRAC as J,PLANE_MIN_BASIS_SCREEN_LEN2 as K,INITIAL_PLANE_HALF_SIZE_VIEW_PROPORTION as Q,SHIFT_RESTART_OFFSET_DISTANCE as X,SHIFT_RESTART_ARROW_TIP_COLOR as Y,SHIFT_RESTART_ARROW_CAP_COLOR as Z,SHIFT_RESTART_TUBE_COLOR as _,SHIFT_RESTART_OUTLINE_COLOR as ee,SHIFT_RESTART_CALLOUT_COLOR as te,SHIFT_RESTART_TIP_RADIUS as ie,ROTATE_HEADING_CALLOUT_COLOR as re,PLANE_OUTLINE_WIDTH as se,GRID_COLOR as oe,RESIZE_HANDLE_CORNER_INPUT_RADIUS as ne,RESIZE_HANDLE_EDGE_INPUT_RADIUS as ae,ROTATE_HEADING_TIP_LENGTH as ce,VERTICAL_DOT_THRESHOLD as le,SHIFT_RESTART_TUBE_RADIUS as de,SHIFT_RESTART_TIP_LENGTH as me,SHIFT_RESTART_TUBE_FOCUS_MULTIPLIER as ge,SHIFT_RESTART_TIP_FOCUS_MULTIPLIER as ue,SHIFT_RESTART_ARROW_OUTLINE_WIDTH as pe,ROTATE_HEADING_OFFSET_DISTANCE as fe,ROTATE_HEADING_DISC_RADIUS as be,ROTATE_HEADING_DISC_RADIUS_FOCUS_MULTIPLIER as he,PLANE_OUTLINE_COLOR as we,PLANE_BACKGROUND_COLOR as ye,HANDLE_COLOR as je,DISPLAY_FOCUS_MULTIPLIER as Me,SHIFT_RESTART_ARROW_LENGTH as Pe,RESIZE_HANDLE_CORNER_WIDTH as ke,RESIZE_HANDLE_EDGE_WIDTH as Oe}from"./sliceToolConfig.js";import{ImageMaterial as ve}from"../../../webgl-engine/materials/ImageMaterial.js";import{SlicePlaneMaterial as Ue}from"../../../webgl-engine/materials/SlicePlaneMaterial.js";const Re=r.getLogger("esri.views.3d.interactive.analysisTools.slice.sliceToolUtils");function Se(e,t,i,r,s,o,n,a){return Te(t,n.worldUpAtPosition(e,A.get()),s,o,a.basis1,a.basis2),m(a.basis1,a.basis1,i),m(a.basis2,a.basis2,r),g(a.origin,e),L.fromVectorsAndPoint(a.basis2,a.basis1,a.origin,a.plane),a}function Te(e,t,i,r,s,o){const n=u(e,t),a=A.get(),c=A.get();switch(0===r?Math.abs(n)>le?1:2:r){case 2:{const r=Math.abs(n)<=H?e:i.viewUp;p(a,r,t),g(c,t);break}case 1:p(a,i.viewUp,t),p(c,t,a);break;case 3:{const r=Math.abs(n)<=H?t:i.viewUp;p(a,r,e),p(c,e,a);break}}const l=p(A.get(),a,c);u(l,i.viewForward)>0&&m(c,c,-1),f(s,a),f(o,c)}function Ae(e,t,i){const r=t.worldUpAtPosition(e.origin,A.get()),s=e.basis1,o=_e(e,r),n=Math.round(o/ot)*ot;return z.rotate(e,n-o,s,i)}function Ge(e,t,i,r,s,o){const n=g(A.get(),s.origin);b(n,n,m(A.get(),s.basis1,e.direction[0]<0?1:-1)),b(n,n,m(A.get(),s.basis2,e.direction[1]<0?1:-1));const a=h(s.basis1),c=h(s.basis2),l=w(A.get(),i,n),d=w(A.get(),t,n);let p=0,f=0;if(We(e)){const t=qe(s),i=qe(o);p=a-.5*e.direction[0]*u(s.basis1,d)/a,f=c-.5*e.direction[1]*u(s.basis2,d)/c;const r=i/t;p*=r,f*=r}const y=p+.5*e.direction[0]*u(s.basis1,l)/a,j=f+.5*e.direction[1]*u(s.basis2,l)/c,M=m(A.get(),s.basis1,y/a),P=m(A.get(),s.basis2,j/c);(y<=0||Ve(o.origin,M,r)<=K)&&g(M,o.basis1),(j<=0||Ve(o.origin,P,r)<=K)&&g(P,o.basis2);const k=g(A.get(),n);return b(k,k,m(A.get(),M,e.direction[0]<0?-1:1)),b(k,k,m(A.get(),P,e.direction[1]<0?-1:1)),z.fromValues(k,M,P,o)}function Ie(e,t){return Q*Math.min(t.width,t.height)*t.computeRenderPixelSizeAt(e)}function Fe(e,t,i,r){const s=p(A.get(),t,i);return p(s,s,t),L.fromPositionAndNormal(e,s,r)}function Le(e,t){return $(e.basis1,e.basis2,e.origin,t)}function ze(e,t,i,r){const s=t.worldUpAtPosition(e.origin,A.get()),o=A.get();switch(i){case 1:g(o,s);break;case 2:g(o,e.basis1)}return L.fromPositionAndNormal(e.origin,o,r)}function Ce(e,t,i,r){const s=Ne(i,2),o=G.get();M(o,t,s.edge*Math.PI/2);const n=f(A.get(),s.basis);let l=m(A.get(),n,s.direction*r.computeScreenPixelSizeAt(s.position)*X);b(l,l,s.position);const d=r.projectToRenderScreen(l,a(A.get())),g=function(e,t){const[i,r,s,o]=e.viewport,n=Math.min(s,o)/16;let a=!0;t[0]<i+n?(t[0]=i+n,a=!1):t[0]>i+s-n&&(t[0]=i+s-n,a=!1);t[1]<r+n?(t[1]=r+n,a=!1):t[1]>r+o-n&&(t[1]=r+o-n,a=!1);return a}(r,d);C.fromRender(r,d,st),f(st.direction,st.direction);const u=A.get();!g&&z.intersectRay(i,st,u)&&(l=u),o[12]=0,o[13]=0,o[14]=0,e.modelTransform=o,e.renderLocation=c(l),g?e.state|=rt:e.state&=~rt}function xe(e,t,i,r){const s=h(r.basis1),o=h(r.basis2),n=Be(r),a=qe(r),c=j(A.get(),0,0,0);b(c,m(A.get(),r.basis1,t.direction[0]),m(A.get(),r.basis2,t.direction[1])),b(c,r.origin,c);let l=0,d=1;if(We(t))1===t.direction[0]&&-1===t.direction[1]?l=ot:1===t.direction[0]&&1===t.direction[1]?l=Math.PI:-1===t.direction[0]&&1===t.direction[1]&&(l=3*Math.PI/2),d=a;else{const e=0!==t.direction[0]?1:2;l=1===e?ot:0,d=(1===e?o:s)-n}const g=P(G.get());M(g,g,l),k(g,g,j(A.get(),d,d,d)),O(g,i,g),g[12]=0,g[13]=0,g[14]=0,e.modelTransform=g,e.renderLocation=c}function De(e,t,i,r){const s=r.worldUpAtPosition(i.origin,A.get()),o=Ne(i,0),n=P(G.get());M(n,n,o.edge*Math.PI/2),v(n,n,-_e(i,s)),O(n,t,n),n[12]=0,n[13]=0,n[14]=0,e.modelTransform=n,e.renderLocation=o.position}function Ee(e,t,i){const r=Ne(i,1),s=P(G.get());M(s,s,r.edge*Math.PI/2),v(s,s,ot),O(s,t,s),s[12]=0,s[13]=0,s[14]=0,e.modelTransform=s,e.renderLocation=r.position}function Ne(e,t){switch(t){case 0:return{basis:e.basis1,direction:1,position:b(A.get(),e.origin,e.basis1),edge:t};case 1:return{basis:e.basis2,direction:1,position:b(A.get(),e.origin,e.basis2),edge:t};case 2:return{basis:e.basis1,direction:-1,position:w(A.get(),e.origin,e.basis1),edge:t};case 3:return{basis:e.basis2,direction:-1,position:w(A.get(),e.origin,e.basis2),edge:t}}}function Ve(e,t,i){const r=i.projectToRenderScreen(b(A.get(),e,t),a(A.get())),s=i.projectToRenderScreen(w(A.get(),e,t),a(A.get()));return y(w(r,r,s))}function Be(e){const t=h(e.basis1),i=h(e.basis2);return J*Math.min(t,i)}function qe(e){return Be(e)}function We(e){return 0!==e.direction[0]&&0!==e.direction[1]}function $e(e){const t=[d(0,0,-Pe/2),d(0,0,Pe/2)],i=Ye(t,!0),r=(e,i)=>Xe(t,t,{tubeRadius:de,tipRadius:ie,tipLength:me,tubeFocusMultiplier:ge,tipFocusMultiplier:ue,padding:e,bothEnds:!0,flat:null,focusTipLength:!0,addCap:i}),s=r(0,!1),o=r(pe,!0),n=new q({color:Y,cullFace:2,renderOccluded:16},"slice-shift"),a=new q({color:Z,cullFace:2,renderOccluded:16},"slice-shift"),c=new q({color:_,cullFace:2,renderOccluded:16},"slice-shift"),l=new q({color:ee,transparent:!0,writeDepth:!1,cullFace:1,renderOccluded:2},"slice-shift"),m=new N(E.createPolylineGeometry([[0,0,0],[-X,0,0]]),"slice-rotate-heading"),g=new N(E.createPolylineGeometry([[0,0,0],[-X,0,0]]),"slice-rotate-heading"),u=new B({color:te,renderOccluded:4},"slice-rotate-heading");return new W({view:e,renderObjects:[...s.normal.map((({part:e,geometry:t,transform:i})=>({geometry:t,material:"tip"===e?n:"cap"===e?a:c,transform:i,stateMask:1|it}))),...o.normal.map((({geometry:e,transform:t})=>({geometry:e,material:l,transform:t,stateMask:1|it}))),{geometry:m,material:u,stateMask:1|it|rt},...s.focused.map((({part:e,geometry:t,transform:i})=>({geometry:t,material:"tip"===e?n:"cap"===e?a:c,transform:i,stateMask:2|it}))),...o.focused.map((({geometry:e,transform:t})=>({geometry:e,material:l,transform:t,stateMask:2|it}))),{geometry:g,material:u,stateMask:2|it|rt}],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[i]},collisionPriority:1,radius:ie,state:it})}function He(e,t){const i=new ve({transparent:!0,writeDepth:!1,textureId:t.id,renderOccluded:16},"slice-rotate"),r=fe,s=be,o=s*he,n=e=>{const t=new Uint32Array([0,1,2,2,3,0]);return new N(new D({[x.POSITION]:{size:3,data:new Float32Array([r-e,-e,0,r+e,-e,0,r+e,e,0,r-e,e,0])},[x.UV0]:{size:2,data:new Float32Array([0,0,1,0,1,1,0,1])}},{[x.POSITION]:t,[x.UV0]:t}))},a=new N(E.createPolylineGeometry([[0,0,0],[r-s,0,0]]),"slice-rotate-heading"),c=new N(E.createPolylineGeometry([[0,0,0],[r-o,0,0]]),"slice-rotate-heading"),l=new B({color:re,renderOccluded:4},"slice-rotate-heading"),d=[{geometry:n(s),material:i,stateMask:1|it},{geometry:a,material:l,stateMask:1|it},{geometry:n(o),material:i,stateMask:2|it},{geometry:c,material:l,stateMask:2|it}];return new W({view:e,renderObjects:d,autoScaleRenderObjects:!1,collisionType:{type:"disc",direction:[0,0,1],offset:[r,0,0]},collisionPriority:1,radius:s/2,state:it})}function Je(e){const t=new N(E.createPolylineGeometry([[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]]),"slice-outline"),i=[...we],r=new V({color:i,writeDepth:!1,width:se,renderOccluded:4},"slice-outline");return{manipulator:new W({view:e,renderObjects:[{geometry:t,material:r}],interactive:!1,autoScaleRenderObjects:!1,worldSized:!0}),material:r}}function Ke(e){const t=new N(E.createSquareGeometry(),"slice-grid"),i=[...ye],r=new Ue({backgroundColor:i,gridColor:oe,gridWidth:4,renderOccluded:4},"slice-grid");return{manipulator:new W({view:e,renderObjects:[{geometry:t,material:r}],interactive:!1,autoScaleRenderObjects:!1,worldSized:!0}),material:r}}function Qe(e,t){const i=We(t),r=i?[d(1,0,0),d(0,0,0),d(0,1,0)]:[d(1,0,0),d(-1,0,0)],s=new N(E.createPolylineGeometry(r),"slice-resize"),o=[...je,1],n=i?ke:Oe,a=n*Me,c=e=>e>1?(e=>new V({color:o,width:e,renderOccluded:4},"slice-resize"))(e):new B({color:o,renderOccluded:4},"slice-resize");return new W({view:e,renderObjects:[{geometry:s,material:c(n),stateMask:1},{geometry:s,material:c(a),stateMask:2}],collisionType:{type:"line",paths:[r]},autoScaleRenderObjects:!1,worldSized:!0,radius:i?ne:ae})}function Xe(e,i,r){const s=s=>{const o=(s?i:e).slice(0),n=w(A.get(),o[0],o[1]);f(n,n);const a=w(A.get(),o[o.length-1],o[o.length-2]);if(f(a,a),r.padding>0){const e=m(l(),a,-r.padding);if(o[o.length-1]=b(e,e,o[o.length-1]),r.bothEnds){const e=m(l(),n,-r.padding);o[0]=b(e,e,o[0])}}const c=s?r.tipFocusMultiplier:1,g=r.tipLength*(r.focusTipLength?c:1),u=r.tipRadius*c,p=P(G.get());if(r.padding>0){const e=g/4,t=j(A.get(),0,e,0),i=1+r.padding/e;U(p,p,t),k(p,p,j(A.get(),i,i,i)),U(p,p,m(t,t,-1/i))}const h=P(S()),y=d(0,1,0),M=R(S(),T(I.get(),y,a));M[12]=o[o.length-1][0],M[13]=o[o.length-1][1],M[14]=o[o.length-1][2],O(M,M,p);const v=[{part:"tube",geometry:new N(function(e,i,r){const s=[];if(t(i))s.push([e,i.thickness/2],[-e,i.thickness/2],[-e,-i.thickness/2],[e,-i.thickness/2]);else{const t=12;for(let i=0;i<t;i++){const r=i/t*2*Math.PI;s.push([Math.cos(r)*e,Math.sin(r)*e])}}return E.createPathExtrusionGeometry(s,r,[],[],!1)}(r.tubeRadius*(s?r.tubeFocusMultiplier:1)+r.padding,r.flat,o),"arrow-tube"),transform:h}];let F,L;if(t(r.flat)?F=new N(E.createExtrudedTriangle(g,u,u,r.flat.thickness),"arrow-tip"):(F=new N(E.createConeGeometry(g,u,24,!1,!1,!0),"arrow-tip"),L=new N(E.createConeGeometry(g,u,24,!1,!0,!1),"arrow-cap")),v.push({part:"tip",geometry:F,transform:M}),L&&v.push({part:"cap",geometry:L,transform:M}),r.bothEnds){const e=R(S(),T(I.get(),y,n));e[12]=o[0][0],e[13]=o[0][1],e[14]=o[0][2],O(e,e,p),v.push({part:"tip",geometry:F,transform:e}),L&&v.push({part:"cap",geometry:L,transform:e})}return v};return{normal:s(!1),focused:s(!0)}}function Ye(e,t){const i=w(l(),e[e.length-1],e[e.length-2]);if(f(i,i),m(i,i,ce),b(i,i,e[e.length-1]),t){const t=w(l(),e[0],e[1]);return f(t,t),m(t,t,ce),b(t,t,e[0]),[t,...e,i]}return[...e,i]}function Ze(e,r,n,a){if(i(e))return null;const c=t(a.position)?a.position:new s;r.fromRenderCoords(e.origin,c,n),a.position=c;const l=r.worldUpAtPosition(e.origin,A.get()),d=r.worldBasisAtPosition(e.origin,1,A.get());return a.width=2*h(e.basis1),a.height=2*h(e.basis2),a.tilt=o(_e(e,l)),a.heading=o(function(e,t,i){return F(e.basis1,i,t)-ot}(e,l,d)),a}function _e(e,t){return F(t,e.basis2,e.basis1)+ot}function et(e,t,r){return i(e)||i(e.position)?null:t.toRenderCoords(e.position,r.origin)?(t.worldBasisAtPosition(r.origin,0,r.basis1),t.worldBasisAtPosition(r.origin,1,r.basis2),L.fromVectorsAndPoint(r.basis2,r.basis1,r.origin,r.plane),z.rotate(r,-n(e.heading),z.normal(r),r),z.rotate(r,n(e.tilt),r.basis1,r),m(r.basis1,r.basis1,e.width/2),m(r.basis2,r.basis2,e.height/2),z.updateUnboundedPlane(r),r):(Re.error(`Failed to project slice plane position, projection from ${e.position.spatialReference.wkid} is not supported`),null)}function tt(t){switch(t.type){case"building-scene":case"csv":case"feature":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"kml":case"map-notes":case"ogc-feature":case"point-cloud":case"route":case"scene":case"stream":case"unknown":case"unsupported":case null:return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"imagery":case"imagery-tile":case"map-image":case"open-street-map":case"tile":case"vector-tile":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return e(t.type),!1}}const it=16,rt=32,st=C.create(),ot=Math.PI/2;export{it as DidPointerMoveRecentlyFlag,Ye as addArrowTips,Le as calculateBoundedPlaneTranslateRotate,qe as calculateDiagonalResizeHandleScale,Ie as calculatePlaneHalfSize,Be as calculateResizeHandlePadding,Ve as calculateScreenSpaceBasisLength2,Xe as createArrowGeometry,Ke as createGridManipulator,Je as createOutlineManipulator,Se as createPlane,Qe as createResizeManipulator,He as createRotateManipulator,ze as createRotatePlane,$e as createShiftManipulator,Fe as createShiftPlane,Ae as forceHorizontalOrVertical,tt as isAlwaysDrapedLayer,We as isDiagonalResizeHandle,Te as normalToBases,Ze as planeToShape,Ge as resizePlane,et as shapeToPlane,xe as updateResizeHandle,De as updateRotateHeadingHandle,Ee as updateRotateTiltHandle,Ce as updateShiftRestartHandle};
