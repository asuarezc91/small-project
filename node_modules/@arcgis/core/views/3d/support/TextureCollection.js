/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as e}from"../../../core/maybe.js";import{isSVG as t}from"../../../core/urlUtils.js";import{throwIfAborted as r,createAbortController as s,create as u,onAbort as o,createAbortError as i}from"../../../core/promiseUtils.js";import{Task as n,ImmediateTask as a}from"../../support/Scheduler.js";import h from"../webgl-engine/lib/Texture.js";class l{constructor(t,r,s,u){this._streamDataRequester=t,this._stage=r,this._textureOptions=s,this._textureRequests=new Map,this._frameTask=e(u)?u.registerTask(n.TEXTURE_UNLOAD,(()=>{}),(()=>!1)):a}destroy(){this._frameTask.remove(),this._textureRequests.forEach((e=>this.releaseTextureRequest(e))),this._textureRequests.clear()}async fromUrl(t,n,a){r(a);const h=e(a)&&a.signal,l=this.makeUid(t,n);let x=this._textureRequests.get(l);if(!x){const e=s(),r=this._streamDataRequester.request(t,"image",{uid:l,signal:e.signal});x={referenceCount:0,texture:null,textureAsync:null,abortController:e},this._textureRequests.set(l,x),x.textureAsync=r.then((e=>{const r=this.createTexture(t,e,n);return x.texture=r,x.abortController=null,this.addToStage(r),{uid:l,texture:r}}),(e=>{throw x.abortController=null,e}))}return x.referenceCount++,u(((e,t)=>{o(h,(()=>{t(i())})),x.textureAsync.then(e,t)})).catch((e=>{throw this.release(l),e}))}fromData(e,t){const r=this.makeUid(e);let s=this._textureRequests.get(r);return s||(s={referenceCount:0,texture:t(),textureAsync:null,abortController:null},this.addToStage(s.texture),this._textureRequests.set(r,s)),s.referenceCount++,{uid:r,texture:s.texture}}release(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule((()=>this.releaseNow(e)))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){return{textureRequests:this._textureRequests}}releaseNow(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||(this.releaseTextureRequest(t),this._textureRequests.delete(e))}releaseTextureRequest(e){e.texture?this.removeFromStage(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}createTexture(e,r,s){if(t(e)&&(s||0===r.width&&0===r.height)){const e=r.width?r.height/r.width:1;s=s||64,e>1?(r.width=Math.round(s/e),r.height=s):(r.width=s,r.height=Math.round(s*e))}const u={...this._textureOptions,width:r.width,height:r.height,powerOfTwoResizeMode:2};return new h(r,"symbol",u)}addToStage(e){this._stage.add(4,e)}removeFromStage(e){this._stage.remove(4,e.id)}makeUid(e,t){return null!=t?`${e}.${t}px`:e}}export default l;export{l as TextureCollection};
