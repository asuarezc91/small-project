/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isNone as e,isSome as t}from"../../../core/maybe.js";import n from"../../../core/Logger.js";import{createResolver as r}from"../../../core/promiseUtils.js";import i from"../../../geometry/SpatialReference.js";import o from"../../../geometry/Point.js";import{deg2rad as a,rad2deg as s}from"../../../core/mathUtils.js";import{b as l,c}from"../../../chunks/vec3f64.js";import{a as f,b as u,g as m,w as p,k as d}from"../../../chunks/vec3.js";import{Cyclical as h}from"./mathUtils.js";import v from"../../../Camera.js";import{getReferenceEllipsoid as g}from"../../../geometry/projectionEllipsoid.js";import{projectPointToVector as y,projectVectorToVector as R,projectVectorToPoint as M}from"../../../geometry/projection.js";import{isSpatialReferenceSupported as w}from"../../support/spatialReferenceSupport.js";import{getResolutionForScale as x}from"../../../geometry/support/scaleUtils.js";import{getElevationAtPoint as j}from"./ElevationProvider.js";import{getGreatCircleSpanAt as T}from"./earthUtils.js";import{cameraOnContentAlongViewDirection as S}from"../camera/intersectionUtils.js";import{t as b,c as z}from"../../../chunks/cameraUtilsPlanar.js";import{t as C,c as U}from"../../../chunks/cameraUtilsSpherical.js";const P=n.getLogger("esri.views.3d.support.cameraUtils"),H=c(),k=c(),A=c(),I={heading:0,tilt:0},L=new o,E=new h(-20037508.342788905,20037508.342788905),q=new h(-180,180);function F(e){return e.spatialReference||i.WGS84}function G(e){return"global"===e.viewingMode?U:z}function O(e,t,n,r,i){return G(e).headingTiltToDirectionUp(t,n,r,i)}function W(e,t){const n=e.renderSpatialReference,r=G(e).headingTiltToDirectionUp,i=c();if(!y(t.position,i,n))return null;const o=r(i,t.heading,t.tilt);f(o.direction,o.direction,e.state.camera.distance),u(o.direction,o.direction,i);const s=S(e,i,o.direction,o.up);return s.fov=a(t.fov),s}const X=c();function D(t,n,r){const a=t.renderSpatialReference,l=m(A,n.viewForward),c=J(t,n.eye,l,n.up,I);let f=F(t);return R(n.eye,a,X,f)||(f=i.WGS84,R(n.eye,a,X,f)),e(r)?new v(new o(X,f),c.heading,c.tilt,s(n.fov)):(r.position.x=X[0],r.position.y=X[1],r.position.z=X[2],r.position.spatialReference=f,r.heading=c.heading,r.tilt=c.tilt,r.fov=s(n.fov),r)}function Y(e,t,n){const r=e.state.camera,i=r.fovX,o=r.width/2/r.pixelRatio;"global"===e.viewingMode&&null!=n&&(t*=Math.cos(a(n)));return o/(3779.5199999999995/(t/=e.renderCoordsHelper.unitInMeters))/Math.tan(i/2)}function N(e,t,n){const r=e.state.camera,i=r.fovX,o=t*Math.tan(i/2);let s=3779.5199999999995/(r.width/2/r.pixelRatio/o);return"global"===e.viewingMode&&(s/=Math.cos(a(n))),s*=e.renderCoordsHelper.unitInMeters,s}function Z(e,t,n,r,i,o){return B(e,t,Y(e,n,t.latitude),r,i,o)}function B(t,n,r,i,o,a){if(se(a)){const s=new ae(a.signal);return K(t,i.heading,i.tilt,n,r,o,s),void s.resolver.promise.then((n=>{const r=te(t,n,i.fov);if(!e(r))return a.resolver.resolve(r);a.resolver.reject()}),(e=>a.resolver.reject(e)))}const s=K(t,i.heading,i.tilt,n,r,o);return te(t,s,i.fov,a)}function J(e,t,n,r,i){return G(e).directionToHeadingTilt(t,n,r,i)}function K(e,t,n,r,i,a,s){const l=r&&r instanceof o?r:null;if(se(s))return async function(e,t,n){const r=c();if(t)if(t instanceof o){if(y(t,r,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){const i=await e.elevationProvider.queryElevation(t.x,t.y,t.z,t.spatialReference,"ground",n);return null!=i&&e.renderCoordsHelper.setAltitude(i,r),r}}else m(r,t);else m(r,e.state.camera.center);return r}(e,r,s.signal).then((r=>{Q(e,t,n,l,r,i,a,s)}),(e=>s.resolver.reject(e))),null;const f=function(e,t){const n=c();if(t&&t instanceof o){if(y(t,n,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){const r=j(e.elevationProvider,t);null!=r&&e.renderCoordsHelper.setAltitude(r,n)}}else m(n,t||e.state.camera.center);return n}(e,r);return Q(e,t,n,l,f,i,a,s)}function Q(t,n,r,i,o,a,s,f){if(!i){const e=t.renderSpatialReference,n=F(t);if(!(i=M(o,e,n)))return null}a=Math.max(a,t.state.constraints.minimumPoiDistance);const u=function(t,n,r,i,o,a){let s=0;1===a&&function(t,n,r){const i=t.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(r/i)/Math.LN2>8)return!0;const o=t.renderSpatialReference,a=F(t),s=M(n,o,a),l=M(t.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,o,a);if(e(s)||e(l))return!1;const c=Math.tan(.5*t.state.camera.fov)*i;return l.distance(s)/c>5}(t,i,o)?(n=0,s=function(e,t,n,r){const i=e.state.constraints.tilt(t);i.max=Math.min(i.max,.5*Math.PI);const o=i.min*(1-.7)+.7*i.max,a=ee(e,r,t,n);return Math.min(a,o)}(t,o,r,i)):s=ee(t,i,o,r);return s=t.state.constraints.clampTilt(o,s),r=_(t,i,o,s),{heading:n,tilt:r}}(t,n,r,o,a,s),m=(0,G(t).eyeForCenterWithHeadingTilt)(o,a,u.heading,u.tilt);if(1===s&&"global"===t.viewingMode&&r>0){const e=()=>{const e=_(t,o,a,function(e,t,n,r){const i=e.state.constraints.tilt(t);let o=ee(e,r,t,n);return o=Math.min(o,.5*Math.PI),i.min*(1-.7)+.7*o}(t,a,r,o));return Q(t,n,e,i,o,a,s=r-e<1?0:1,f)},c=t.map.ground.navigationConstraint;if(!c||"stay-above"===c.type){if(function(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,L,e.spatialReference)&&j(e.elevationProvider,L)>L.z-1)}(t,m.eye))return e();if(se(f))return async function(e,t,n){return!!e.renderCoordsHelper.fromRenderCoords(t,L,e.spatialReference)&&await e.elevationProvider.queryElevation(L.x,L.y,L.z,L.spatialReference,"ground",n)>L.z-1}(t,m.eye,f.signal).then((t=>t?e():(f.resolver.resolve({eye:m.eye,up:m.up,center:l(o),heading:m.heading,tilt:m.tilt}),null))),null}}const p=!f||se(f)?{center:c(),eye:c(),up:c(),tilt:0,heading:0}:f;return p.eye=m.eye,p.up=m.up,p.center=l(o),p.heading=m.heading,p.tilt=m.tilt,se(f)&&f.resolver.resolve(p),p}function V(t,n,r,i,a,s=null){let l,c,f,u,m=0;null!=n.zmax&&null!=n.zmin&&(l=(n.zmax+n.zmin)/2,m=n.zmax-n.zmin);if("global"===t.viewingMode){if(!w(n.spatialReference,"global"))return se(s)&&s.resolver.reject(),null;const e=new o(n.xmin,n.ymin,n.spatialReference),t=new o(n.xmax,n.ymax,n.spatialReference),r=n.spatialReference.isGeographic?q:E;c=new o(r.center(e.x,t.x),(t.y+e.y)/2,n.spatialReference),null!=l&&(c.z=l);const i=g(n.spatialReference),a=T(c,e,t);f=a.lon,u=a.lat,r.diff(e.x,t.x)>r.range/2&&(f+=i.halfCircumference),f=Math.min(f,i.halfCircumference),u=Math.min(u,i.halfCircumference)}else{const e=F(t);f=n.xmax-n.xmin,u=n.ymax-n.ymin,c=new o({x:n.xmin+.5*f,y:n.ymin+.5*u,z:l,spatialReference:e})}const p=t.state.camera,d=1/Math.tan(p.fovX/2),h=1/Math.tan(p.fovY/2),v=1/Math.tan(p.fov/2),y=Math.max(.5*f*d,.5*u*h,.5*m*v)/1;if(se(s)){const n=new ae(s.signal);return K(t,r,i,c,y,a,n),void n.resolver.promise.then((n=>{const r=te(t,n,t.camera.fov);if(!e(r))return s.resolver.resolve(r);s.resolver.reject()}),(e=>s.resolver.reject(e)))}const R=K(t,r,i,c,y,a);return te(t,R,t.camera.fov,s)}function $(t,n,r){const i=t.renderSpatialReference,o=p(n.eye,r),a=M(r,i,F(t));if(e(a))return null;const s=2*o*Math.tan(n.fovX/2)*1,l=2*o*Math.tan(n.fovY/2)*1;return"global"===t.viewingMode?C(t,a,s,l):b(t,a,s,l)}function _(e,t,n,r){return G(e).lookAtTiltToEyeTilt(r,t,n)}function ee(e,t,n,r){return G(e).eyeTiltToLookAtTilt(r,t,n)}function te(n,r,i,o){if(e(r))return null;const a=n.renderSpatialReference,s=F(n),l=M(r.eye,a,s);return e(l)?null:t(o)?(o.position=l,o.heading=r.heading,o.tilt=r.tilt,o.fov=i,o):new v(l,r.heading,r.tilt,i)}function ne(e,t){const n=e.basemapTerrain&&e.basemapTerrain.tilingScheme;if(n)return n.levelAtScale(t);P.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function re(e,t){const n=e.basemapTerrain&&e.basemapTerrain.tilingScheme;if(n)return n.scaleAtLevel(t);P.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function ie(e,t){return e.spatialReference?x(t,e.spatialReference):void 0}function oe(e,t,n){const r=e.renderSpatialReference;let o,a;t||(t=e.state.camera);const s=i.WGS84;return t instanceof v?(o=t.position.latitude,y(t.position,H,r),y(n,k,r),a=d(H,k)):(R(t.center,r,k,s),o=k[1],a=t.distance),N(e,a,o)}class ae{constructor(e){this.signal=e,this.resolver=r()}}function se(e){return e&&"resolver"in e}export{ae as AsyncContext,oe as computeScale,J as directionToHeadingTilt,N as distanceToScale,W as externalToInternal,B as fromCenterDistance,Z as fromCenterScale,V as fromExtent,K as getObserverForPointAtDistance,O as headingTiltToDirectionUp,D as internalToExternal,te as observerToCamera,Y as scaleToDistance,ie as scaleToResolution,ne as scaleToZoom,$ as toExtent,re as zoomToScale};
