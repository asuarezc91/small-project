/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as e,isNone as t}from"../../../core/maybe.js";import{deg2rad as i}from"../../../core/mathUtils.js";import{c as n}from"../../../chunks/vec3f64.js";import{g as s,i as r,k as a,n as h,c as l,b as c}from"../../../chunks/vec3.js";import{a as o}from"../../../chunks/vec2f64.js";import{a as _}from"../../../chunks/vec4f64.js";import{t as d}from"../../../chunks/vec4.js";import{lineSegment as p,plane as m,sphere as f,clipRay as g,ray as u,frustum as b}from"./geometryUtils.js";import{inverseProjectionInfo as P}from"../webgl-engine/lib/Util.js";import{createQuadVAO as V}from"../webgl-engine/lib/glUtil3D.js";import{copyParameters as E,updateParameters as q}from"../webgl-engine/materials/internal/MaterialUtil.js";import{LaserlinePathTechniqueConfiguration as D,LaserlinePathTechnique as L}from"../webgl-engine/shaders/LaserlinePathTechnique.js";import{LaserlinePathData as S}from"./LaserlinePathData.js";import{LaserlineTechniqueConfiguration as R,LaserlineTechnique as U}from"../webgl-engine/shaders/LaserlineTechnique.js";const x=n(),C=_(),M={glowColor:[1,.5,0],glowWidth:8,glowFalloff:8,innerColor:[1,1,1],innerWidth:1,globalAlpha:.75,angleCutoff:i(6),globalAlphaContrastBoost:2};function T(e,t,i,n){const a=x,h=C;r(a,t,n),s(h,i),h[3]=0,d(h,h,n),m.fromPositionAndNormal(a,h,e)}class v{constructor(e,t={},i={contrastControlEnabled:!1}){this._technique=null,this._projInfo=_(),this._zScale=o(),this._heightManifoldEnabled=!1,this._heightManifoldTarget=n(),this._pointDistanceEnabled=!1,this._pointDistanceOrigin=n(),this._pointDistanceTarget=n(),this._lineVerticalPlaneEnabled=!1,this._lineVerticalPlaneSegment=p.create(),this._intersectsLineEnabled=!1,this._intersectsLineSegment=p.create(),this._intersectsLineRadius=3,this._intersectsLineInfinite=!1,this._pathVerticalPlaneEnabled=!1,this._pathVerticalPlaneData=null,this._pathTechnique=null,this.canRender=!0,this._tempNormal=n(),this._tempDir=n(),this._tempUp=n(),this._tempVec3A=n(),this._tempVec3B=n(),this._tempVec4=_(),this._tempPlane=m.create(),this._tempSphere=f.create(),this._renderCoordsHelper=e,this._params=E(t,M),this._config=i}get renderSlots(){return[this._config.contrastControlEnabled?17:16]}get needsLinearDepth(){return!0}get heightManifoldEnabled(){return this._heightManifoldEnabled}set heightManifoldEnabled(e){this._heightManifoldEnabled!==e&&(this._heightManifoldEnabled=e,this._requestRender())}get heightManifoldTarget(){return this._heightManifoldTarget}set heightManifoldTarget(e){s(this._heightManifoldTarget,e),this._requestRender()}get pointDistanceEnabled(){return this._pointDistanceEnabled}set pointDistanceEnabled(e){e!==this._pointDistanceEnabled&&(this._pointDistanceEnabled=e,this._requestRender())}get pointDistanceTarget(){return this._pointDistanceTarget}set pointDistanceTarget(e){s(this._pointDistanceTarget,e),this._requestRender()}get pointDistanceOrigin(){return this._pointDistanceOrigin}set pointDistanceOrigin(e){s(this._pointDistanceOrigin,e),this._requestRender()}get lineVerticalPlaneEnabled(){return this._lineVerticalPlaneEnabled}set lineVerticalPlaneEnabled(e){e!==this._lineVerticalPlaneEnabled&&(this._lineVerticalPlaneEnabled=e,this._requestRender())}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){p.copy(e,this._lineVerticalPlaneSegment),this._requestRender()}get intersectsLineEnabled(){return this._intersectsLineEnabled}set intersectsLineEnabled(e){e!==this._intersectsLineEnabled&&(this._intersectsLineEnabled=e,this._requestRender())}get intersectsLineSegment(){return this._intersectsLineSegment}set intersectsLineSegment(e){p.copy(e,this._intersectsLineSegment),this._requestRender()}get intersectsLineRadius(){return this._intersectsLineRadius}set intersectsLineRadius(e){e!==this._intersectsLineRadius&&(this._intersectsLineRadius=e,this._requestRender())}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){e!==this._intersectsLineInfinite&&(this._intersectsLineInfinite=e,this._requestRender())}get pathVerticalPlaneEnabled(){return this._pathVerticalPlaneEnabled}set pathVerticalPlaneEnabled(t){t!==this._pathVerticalPlaneEnabled&&(this._pathVerticalPlaneEnabled=t,e(this._pathVerticalPlaneData)&&this._requestRender())}set pathVerticalPlaneVertices(e){t(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new S(this._renderCoordsHelper)),this._pathVerticalPlaneData.vertices=e,this.pathVerticalPlaneEnabled&&this._requestRender()}set pathVerticalPlaneBuffers(e){t(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new S(this._renderCoordsHelper)),this._pathVerticalPlaneData.buffers=e,this.pathVerticalPlaneEnabled&&this._requestRender()}setParameterValues(e){q(this._params,e)&&this._requestRender()}initializeRenderContext(e){this._initContext=e;const t=e.rctx;this._quadVAO=V(t),this._techniqueRepository=e.shaderTechniqueRep,this._techniqueConfig=new R,this._pathTechniqueConfig=new D}uninitializeRenderContext(){this._quadVAO.dispose(),this._quadVAO=null,e(this._technique)&&this._techniqueRepository.release(this._technique),e(this._pathVerticalPlaneData)&&this._pathVerticalPlaneData.dispose(),e(this._pathTechnique)&&this._techniqueRepository.release(this._pathTechnique)}render(e){const t=this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled,i=this.pathVerticalPlaneEnabled;if(!t&&!i)return!0;const n=e.camera;return P(n.projectionMatrix,n.fullWidth,n.fullHeight,this._projInfo,this._zScale),t&&this.renderUnified(e),i&&this.renderPath(e),!0}renderUnified(e){const t=e.rctx,i=this._selectTechnique(),n=i.program;t.bindProgram(n),i.bindPipelineState(t),this.bindGlobalUniforms(e,n),this.bindHeightManifoldUniforms(e,n),this.bindPointDistanceUniforms(e,n),this.bindLineVerticalPlaneUniforms(e,n),this.bindIntersectsLineUniforms(e,n),i.bind(this._params,e.camera),t.bindVAO(this._quadVAO),t.drawArrays(5,0,4)}renderPath(e){if(t(this._pathVerticalPlaneData))return;this._pathTechniqueConfig.contrastControlEnabled=this._config.contrastControlEnabled,this._pathTechnique=this._techniqueRepository.acquireAndReleaseExisting(L,this._pathTechniqueConfig,this._pathTechnique);const i=e.rctx,n=this._pathTechnique,s=n.program;i.bindProgram(s),n.bindPipelineState(i),this.bindGlobalUniforms(e,s),n.bind(this._params,this._pathVerticalPlaneData.origin,e.camera),this._pathVerticalPlaneData.draw(e.rctx)}bindHeightManifoldUniforms(e,t){if(!this.heightManifoldEnabled)return;const i=this._tempVec3A,n=this._tempPlane;this._renderCoordsHelper.worldUpAtPosition(this._heightManifoldTarget,i),T(n,this._heightManifoldTarget,i,e.camera.viewMatrix),t.setUniform4fv("heightPlane",n)}bindPointDistanceUniforms(e,t){if(!this._pointDistanceEnabled)return;const i=e.camera,n=this._tempSphere;s(n.center,this._pointDistanceOrigin),r(n.center,n.center,i.viewMatrix),n.radius=a(this._pointDistanceOrigin,this._pointDistanceTarget),t.setUniform4f("pointDistanceSphere",n.center[0],n.center[1],n.center[2],n.radius)}bindLineVerticalPlaneUniforms(e,t){if(!this._lineVerticalPlaneEnabled)return;const i=this._renderCoordsHelper,n=e.camera,a=this._tempPlane,o=this._tempVec3A,_=this._tempUp,d=this._tempDir,m=this._tempNormal;p.pointAt(this._lineVerticalPlaneSegment,.5,o),i.worldUpAtPosition(o,_),h(d,this._lineVerticalPlaneSegment.vector),l(m,_,d),h(m,m),T(a,this._lineVerticalPlaneSegment.origin,m,n.viewMatrix),t.setUniform4fv("lineVerticalPlane",a);const f=this._tempVec3A;s(f,this._lineVerticalPlaneSegment.origin),i.setAltitude(0,f),r(f,f,n.viewMatrix),t.setUniform3fv("lineVerticalStart",f);const g=this._tempVec3B;c(g,this._lineVerticalPlaneSegment.origin,this._lineVerticalPlaneSegment.vector),i.setAltitude(0,g),r(g,g,n.viewMatrix),t.setUniform3fv("lineVerticalEnd",g)}bindIntersectsLineUniforms(e,t){if(!this._intersectsLineEnabled)return;const i=w,n=j;if(this._intersectsLineInfinite){const t=e.camera;if(g.fromRay(u.wrap(this._intersectsLineSegment.origin,this._intersectsLineSegment.vector),A),A.c0=-Number.MAX_VALUE,!b.intersectClipRay(t.frustum.planes,A))return;g.getStart(A,i),g.getEnd(A,n)}else s(i,this._intersectsLineSegment.origin),c(n,this._intersectsLineSegment.origin,this._intersectsLineSegment.vector);const a=this._tempVec3A;r(a,i,e.camera.viewMatrix),t.setUniform3fv("intersectsLineStart",a);const l=this._tempVec4;s(l,this._intersectsLineSegment.vector),this._tempVec4[3]=0,d(this._tempVec4,this._tempVec4,e.camera.viewMatrix),r(n,n,e.camera.viewMatrix),t.setUniform3fv("intersectsLineEnd",n),h(l,l),t.setUniform3f("intersectsLineDirection",l[0],l[1],l[2]),t.setUniform1f("intersectsLineRadius",this._intersectsLineRadius)}bindGlobalUniforms(e,t){const i=e.camera;t.setUniform4fv("projInfo",this._projInfo),t.setUniform2fv("zScale",this._zScale),t.setUniform2f("nearFar",i.near,i.far),this._heightManifoldEnabled?t.setUniform1f("maxPixelDistance",2*i.computeScreenPixelSizeAt(this._heightManifoldTarget)):this._pointDistanceEnabled?t.setUniform1f("maxPixelDistance",2*i.computeScreenPixelSizeAt(this._pointDistanceTarget)):this._lineVerticalPlaneEnabled&&t.setUniform1f("maxPixelDistance",2*i.computeScreenPixelSizeAt(this._lineVerticalPlaneSegment.origin)),t.setUniform1i("depthMap",0),e.rctx.bindTexture(e.offscreenRenderingHelper.linearDepthTexture,0),t.setUniform1i("frameColor",1),e.rctx.bindTexture(e.offscreenRenderingHelper.mainColorTexture,1)}_requestRender(){this._initContext&&this._initContext.requestRender()}_selectTechnique(){return this._techniqueConfig.heightManifoldEnabled=this.heightManifoldEnabled,this._techniqueConfig.lineVerticalPlaneEnabled=this.lineVerticalPlaneEnabled,this._techniqueConfig.pointDistanceEnabled=this.pointDistanceEnabled,this._techniqueConfig.intersectsLineEnabled=this.intersectsLineEnabled,this._techniqueConfig.contrastControlEnabled=this._config.contrastControlEnabled,this._technique=this._techniqueRepository.acquireAndReleaseExisting(U,this._techniqueConfig,this._technique),this._technique}}const A=g.create(),w=n(),j=n();export{v as LaserLineRenderer};
