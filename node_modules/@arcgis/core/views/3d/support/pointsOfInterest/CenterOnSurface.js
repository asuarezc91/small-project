/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../chunks/tslib.es6.js";import"../../../../core/has.js";import"../../../../core/Logger.js";import"../../../../core/accessorSupport/ensureType.js";import{property as e}from"../../../../core/accessorSupport/decorators/property.js";import{subclass as r}from"../../../../core/accessorSupport/decorators/subclass.js";import"../../../../core/urlUtils.js";import"../../../../core/uuid.js";import"../../../../portal/support/resourceExtension.js";import s from"../../../../geometry/Point.js";import{clamp as i}from"../../../../core/mathUtils.js";import{c as o}from"../../../../chunks/vec3f64.js";import{g as a,k as c,a as n,b as u,m as l,o as d}from"../../../../chunks/vec3.js";import{getReferenceEllipsoid as p}from"../../../../geometry/projectionEllipsoid.js";import h from"../debugFlags.js";import{PropertiesPool as f}from"../PropertiesPool.js";import{PointOfInterest as m}from"./PointOfInterest.js";const _=Array;let S=class extends m{constructor(t){super(t),this._propertiesPool=new f({location:s,renderLocation:_},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=o(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,(()=>this._measureSurfaceAltitude()),(()=>this.updating)),this._measureSurfaceAltitude()}destroy(){this._frameWorker&&(this._frameWorker.remove(),this._frameWorker=null),this._propertiesPool.destroy(),this._propertiesPool=null}get location(){const t=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,t,this.state.spatialReference),t}updateRenderLocation(){this._set("updating",!0),this._updateRenderLocation()}update(){this._measureSurfaceAltitude(),this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}_measureSurfaceAltitude(){this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this._set("updating",!1)}_updateRenderLocation(){const t=A;let e=this.calculateSurfaceIntersection(this._currentSurfaceAltitude,t);const r=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!e&&r&&(e=this.calculateSurfaceIntersection(this._latestSurfaceAltitude,t),e&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const s=g;if(e&&this.latestSurfaceAltitudeChangesDistanceSignificantly(t,s)&&(a(t,s),this._currentSurfaceAltitude=this._latestSurfaceAltitude),e){const e=c(this.state.camera.eye,t);e!==this._get("distance")&&this._set("distance",e)}else{const e=this.state.camera;n(t,e.viewForward,this._get("distance")),u(t,t,e.eye)}l(this._get("renderLocation"),t)||this._set("renderLocation",a(this._propertiesPool.get("renderLocation"),t))}calculateSurfaceIntersection(t,e){const r=this.state.camera;if(!this.renderCoordsHelper.intersectManifold(r.ray,t,e))return!1;if(this.state.isGlobal){const s=p(this.renderCoordsHelper.spatialReference).radius,i=s+t,o=d(r.eye),a=o<i*i,l=c(r.eye,e);if(a&&l>s/4){const t=i-Math.sqrt(o);return n(e,r.viewForward,t),u(e,e,r.eye),!0}}else{const t=this.surface.ready&&this.surface.extent;t&&(e[0]=i(e[0],t[0],t[2]),e[1]=i(e[1],t[1],t[3]))}return!0}latestSurfaceAltitudeChangesDistanceSignificantly(t,e){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==t)return!1;if(this.calculateSurfaceIntersection(this._latestSurfaceAltitude,e)){const r=this.state.camera.eye,s=c(r,t),i=c(r,e),o=Math.abs(i-s);if(h.TESTS_DISABLE_UPDATE_THRESHOLDS)return!0;if(o/s>y)return!0}return!1}};t([e({constructOnly:!0})],S.prototype,"scheduler",void 0),t([e({constructOnly:!0})],S.prototype,"task",void 0),t([e({readOnly:!0})],S.prototype,"distance",void 0),t([e({constructOnly:!0})],S.prototype,"estimateSurfaceAltitudeAtCenter",void 0),t([e({readOnly:!0,dependsOn:["renderLocation"]})],S.prototype,"location",null),t([e({readOnly:!0})],S.prototype,"renderLocation",void 0),t([e({readOnly:!0})],S.prototype,"updating",void 0),S=t([r("esri.views.3d.support.CenterOnSurface")],S);const y=.05,A=o(),g=o();var j=S;export default j;export{S as CenterOnSurface};
