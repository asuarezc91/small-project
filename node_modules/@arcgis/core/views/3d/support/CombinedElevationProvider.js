/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import{destroyMaybe as r,isNone as t}from"../../../core/maybe.js";import"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as s}from"../../../core/accessorSupport/decorators/property.js";import{subclass as o}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import{createResolver as i,isAbortError as n}from"../../../core/promiseUtils.js";import a from"../../../core/Accessor.js";import l from"../../../core/Evented.js";import{ElevationQuery as c}from"../layers/graphics/ElevationQuery.js";let p=class extends(l.EventedMixin(a)){constructor(e){super(e),this.im=new Array,this.ground=new Array,this.scene=new Array,this.handles=new Map}destroy(){this._elevationQuery=r(this._elevationQuery)}get elevationQuery(){return t(this._elevationQuery)&&(this._elevationQuery=new c(this.view.resourceController.scheduler,this.view.spatialReference,(()=>this.view.map&&this.view.map.ground),{maximumAutoTileRequests:4})),this._elevationQuery}getElevation(e,r,t,s,o){let i=null;return i=u(i,this.im,e,r,t,s,o),null==i&&(i=u(i,this.ground,e,r,t,s,o)),"scene"===o&&(i=u(i,this.scene,e,r,t,s,o)),i}queryElevation(e,r,t,s,o,a=null,l=0){const c=i();return this.elevationQuery.queryElevation(e,r,a,l).then((i=>{"scene"===o&&(i=u(i,this.scene,e,r,t,s,o)),c.resolve(i)})).catch((i=>{n(i)?c.reject(i):c.resolve(this.getElevation(e,r,t,s,o))})),c.promise}register(e,r){this.handles.set(r,r.on("elevation-change",(e=>this.emit("elevation-change",e)))),this[e].push(r)}unregister(e){this.handles.has(e)&&(this.handles.get(e).remove(),this.handles.delete(e));for(const r of[this.im,this.ground,this.scene]){const t=r.indexOf(e);t>-1&&r.splice(t,1)}}};function u(e,r,t,s,o,i,n){for(const a of r){const r=a.getElevation(t,s,o,i,n);null!=r&&(e=null!=e?Math.max(r,e):r)}return e}e([s({constructOnly:!0})],p.prototype,"view",void 0),e([s({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],p.prototype,"spatialReference",void 0),p=e([o("esri.views.3d.support.CombinedElevationProvider")],p);export{p as CombinedElevationProvider};
