/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as e}from"../../../core/maybe.js";import t from"../../../core/Logger.js";import i from"../../../core/Evented.js";import{MemCacheStorage as s,MemCache as a}from"../../../core/MemCache.js";import{isMemoryManagedLayerView as r}from"../layers/support/MemoryManagedLayerView.js";const h=t.getLogger("esri.views.3d.support.MemoryController");function o(e){return new m(e)}class m{constructor(e){this._view=e,this.events=new i,this.minQuality=.1,this._maxMemory=500,this._additionalCacheMemory=100,this._quality=1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryUsed=0,this._memoryPredicted=0,this._cacheStorage=new s,this._numQualityChanges=0,this._updating=!1}destroy(){this.events=null}getMemCache(e,t){return new a(e,this._cacheStorage,t)}set maxMemory(e){null!=e&&e>0&&(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(1),this._maxMemory=e)}get maxMemory(){return this._maxMemory}set additionalCacheMemory(e){null!=e&&e>=0&&(this._additionalCacheMemory=e)}disableMemCache(){this._additionalCacheMemory=-4096}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._memoryUsed}resetStableQuality(){this._stableQuality=0}update(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<.6&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1);else if(e)(this._memoryPredicted>1.1||this._memoryUsed>1)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._memoryUsed>1)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._memoryUsed<.75&&this._quality<1){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this.updating!==e&&(this._updating=e,this.events.emit("updating-changed",this.updating))}_updateQuality(e){return(e=Math.min(Math.max(e,this.minQuality),1))!==this._quality&&(this._quality=e,this.events.emit("quality-changed",this._quality),++this._numQualityChanges,!0)}_layersUpdating(){return this._view.allLayerViews.some((e=>!!e.updating))}_updateMemory(){let t=0,i=0;this._view.basemapTerrain&&this._view.basemapTerrain.getUsedMemory&&(t+=this._view.basemapTerrain.getUsedMemory());const s=this._view._stage&&this._view._stage.renderView&&this._view._stage.renderView.edgeView;e(s)&&(t+=s.getUsedMemory()),this._view.allLayerViews&&this._view.allLayerViews.forEach((e=>{if(r(e)){const s=e.ignoresMemoryFactor()?this._quality:1;t+=e.getUsedMemory()*s,i+=e.getUnloadedMemory()*s}}));const a=null==this._warnMemoryUsage||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),o=1048576*this._maxMemory;if(t>o&&a){this._warnMemoryUsage=t;const e=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",s=Math.round(100*this._quality);h.warn(`Memory Limit exceeded! Limit: ${e(o)} Current: ${e(t)} Projected: ${e(t+i)} Quality: ${s}%`)}this._memoryUsed=t/o,this._memoryPredicted=(t+i)/o;const m=o-t;this._cacheStorage.maxSize=Math.max(0,m+1048576*this._additionalCacheMemory),this.events.emit("memory-used",this._memoryUsed)}get test(){return{cacheStorage:this._cacheStorage,numQualityChanges:this._numQualityChanges}}}export{o as newMemoryController};
