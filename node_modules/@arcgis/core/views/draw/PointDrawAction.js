/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../core/has.js";import{isSome as o}from"../../core/maybe.js";import"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import{property as t}from"../../core/accessorSupport/decorators/property.js";import{subclass as r}from"../../core/accessorSupport/decorators/subclass.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import i from"../../core/Handles.js";import{ViewEventPriorities as s}from"../input/InputManager.js";import{createScreenPointFromEvent as n}from"../support/screenUtils.js";import{DefaultParameters as a}from"../input/recognizers/PointerClickHoldAndDrag.js";import d from"./DrawAction.js";import{CursorUpdateEvent as c,DrawCompleteEvent as l}from"./input/DrawEvents.js";import{KEYS as h}from"./input/Keys.js";import{DrawTool as p}from"../3d/interactive/editingTools/draw/DrawTool.js";let m=class extends d{constructor(e){super(e),this._clickDelay=a.maximumClickDelay,this._cursorMoved=!1,this._cursorScreenPoint=null,this._pointerDownEvent=null,this._viewHandles=new i,this.coordinates=[]}initialize(){"2d"===this.view.type?this._addViewHandles():this._addDrawTool(this.view)}destroy(){"2d"===this.view.type?(this._removeViewHandles(),this._viewHandles.destroy(),this.emit("destroy")):(this._removeDrawTool(),this.emit("destroy"))}complete(){if("2d"===this.view.type){if(this._cursorScreenPoint){const e=this.getCoordsFromScreenPoint(this._cursorScreenPoint);o(e)&&(this._set("coordinates",e),this._completeDrawing())}}else this._drawTool.completeCreateOperation()}_addViewHandles(){this._removeViewHandles(),this._viewHandles.add([this.view.on("click",(e=>{e.stopPropagation();const t=this.getCoordsFromScreenPoint(e.screenPoint);o(t)&&(this._set("coordinates",t),this._drawCompleteHandler(e))}),s.TOOL),this.view.on("pointer-down",(e=>{this._pointerDownEvent=e,this._cursorMoved=!1}),s.TOOL),this.view.on("pointer-move",(e=>{this._cursorMoved=!0,this._cursorScreenPoint=n(e),this._cursorUpdateHandler(e)}),s.TOOL),this.view.on("pointer-up",(e=>{if(this._pointerDownEvent&&!this._cursorMoved&&e.timestamp-this._pointerDownEvent.timestamp>this._clickDelay){this._cursorScreenPoint=n(e);const t=this.getCoordsFromScreenPoint(this._cursorScreenPoint);o(t)&&(this._set("coordinates",t),this._drawCompleteHandler(e))}}),s.TOOL),this.view.on("key-down",(e=>{if(e.key===h.drawCompleteKey&&this._cursorScreenPoint){const t=this.getCoordsFromScreenPoint(this._cursorScreenPoint);o(t)&&(this._set("coordinates",t),this._drawCompleteHandler(e))}}),s.TOOL)])}_removeViewHandles(){this._viewHandles.removeAll()}_addDrawTool(e){this._drawTool=new p({view:e,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"point",mode:"click"}),this.view.toolViewManager.tools.push(this._drawTool),this.view.activeTool=this._drawTool,this._drawTool.on("cursor-update",(e=>{1===e.vertices.length&&this.emit("cursor-update",new c(this.view,null,e.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))})),this._drawTool.on("complete",(e=>{this.emit("draw-complete",new l(null,this._drawTool.getVertexCoords())),this._removeDrawTool()}))}_removeDrawTool(){o(this._drawTool)&&(this.view.tools.remove(this._drawTool),this._drawTool.destroy(),this._drawTool=null)}_updateCursor(e,t){o(e)?this.emit("cursor-update",new c(this.view,t,0,[e])):this.emit("cursor-update",new c(this.view,t,null,null))}_completeDrawing(e){this._cursorMoved=!1,this._pointerDownEvent=null;const o=new l(e,[this.coordinates]);this.emit("draw-complete",o),o.defaultPrevented||this._removeViewHandles()}_cursorUpdateHandler(e){this._updateCursor(this.getCoordsFromScreenPoint(this._cursorScreenPoint),e.native)}_drawCompleteHandler(e){this._completeDrawing(e.native)}};e([t({readOnly:!0})],m.prototype,"coordinates",void 0),m=e([r("esri.views.draw.PointDrawAction")],m);export{m as PointDrawAction};
