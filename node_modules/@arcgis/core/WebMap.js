/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"./chunks/tslib.es6.js";import"./core/has.js";import{unwrap as t,isSome as r}from"./core/maybe.js";import i from"./core/Logger.js";import"./core/accessorSupport/ensureType.js";import{property as a}from"./core/accessorSupport/decorators/property.js";import{reader as o}from"./core/accessorSupport/decorators/reader.js";import{subclass as s}from"./core/accessorSupport/decorators/subclass.js";import{writer as n}from"./core/accessorSupport/decorators/writer.js";import l from"./core/Error.js";import{urlToObject as p,isDataProtocol as u,dataComponents as m,addQueryParameter as h}from"./core/urlUtils.js";import"./core/uuid.js";import"./portal/support/resourceExtension.js";import{flatten as d}from"./core/arrayUtils.js";import{reject as c,resolve as y,eachAlways as w}from"./core/promiseUtils.js";import{readLoadable as g}from"./core/accessorSupport/read.js";import f from"./geometry/SpatialReference.js";import{geographicToWebMercator as b,webMercatorToGeographic as _}from"./geometry/support/webMercatorUtils.js";import v from"./core/Collection.js";import{version as I}from"./kernel.js";import{EsriPromiseMixin as S}from"./core/Promise.js";import A from"./core/Loadable.js";import j from"./portal/Portal.js";import{loadAll as O}from"./core/loadAll.js";import L from"./portal/PortalItem.js";import{getLayerJSON as P}from"./webdoc/support/writeUtils.js";import{hasDeveloperBasemapLayer as V,isDeveloperBasemapLayer as U}from"./support/basemapUtils.js";import W from"./Map.js";import F from"./Viewpoint.js";import{MultiOriginJSONMixin as T,MultiOriginJSONSupport as R}from"./core/MultiOriginJSONSupport.js";import{whenTrueOnce as x}from"./core/watchUtils.js";import{updateOrigins as M}from"./core/accessorSupport/originUtils.js";import{isServerOrServicesAGOLUrl as k}from"./layers/support/arcgisLayerUrl.js";import{removeTypeKeyword as C,addTypeKeyword as N,hasTypeKeyword as E}from"./portal/support/portalItemUtils.js";import B from"./tasks/support/ProjectParameters.js";import D from"./webdoc/RangeInfo.js";import J from"./webdoc/Widgets.js";import{getOptimalThumbnailSize as G}from"./webdoc/support/thumbnailUtils.js";import K from"./webmap/ApplicationProperties.js";import $ from"./webmap/Bookmark.js";import z from"./webmap/background/ColorBackground.js";import q from"./webmap/InitialViewProperties.js";import{Version as H}from"./webmap/Version.js";const Q=new H(2,19),X=v.ofType($),Y=i.getLogger("esri.WebMap"),Z=new Map;Z.set("image/jpeg","jpeg"),Z.set("image/jpg","jpg"),Z.set("image/png","png"),Z.set("image/gif","gif");const ee=["NatGeo_World_Map","Ocean_Basemap","USA_Topo_Maps","World_Imagery","World_Street_Map","World_Terrain_Base","World_Topo_Map","World_Hillshade","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Reference_Overlay","Reference/World_Transportation"].map((e=>e.toLowerCase()));let te=class extends(T(A.LoadableMixin(S(W)))){constructor(e){super(e),this.applicationProperties=null,this.bookmarks=new X,this.initialViewProperties=new q,this.portalItem=null,this.presentation=null,this.sourceVersion=null,this.widgets=null,this.authoringApp=this.authoringAppVersion=null,this._isAuthoringAppSetByUser=this._isAuthoringAppVersionSetByUser=!1}destroy(){const e=this.portalItem;this.portalItem=null,null==e||e.destroy()}initialize(){if(this.when().catch((e=>{Y.error("#load()","Failed to load web map",e)})),this.resourceInfo){let e;try{e=this._validateJSON(this.resourceInfo)}catch(e){return void this.addResolvingPromise(c(e))}this.read(e)}}set authoringApp(e){this._isAuthoringAppSetByUser=!0,this._set("authoringApp",e)}writeAuthoringApp(e,t){e&&this._isAuthoringAppSetByUser?t.authoringApp=e:t.authoringApp="ArcGIS API for JavaScript"}set authoringAppVersion(e){this._isAuthoringAppVersionSetByUser=!0,this._set("authoringAppVersion",e)}writeAuthoringAppVersion(e,t){e&&this._isAuthoringAppVersionSetByUser?t.authoringAppVersion=e:t.authoringAppVersion=I}readInitialViewProperties(e,t){const r=new q;return t.background&&(r.background=z.fromJSON(t.background)),t.initialState&&t.initialState.viewpoint&&(r.viewpoint=F.fromJSON(t.initialState.viewpoint)),t.mapRangeInfo&&(r.rangeInfo=D.fromJSON(t.mapRangeInfo)),t.spatialReference&&(r.spatialReference=f.fromJSON(t.spatialReference)),r}writeInitialViewProperties(e,t,r,i){if(!e)return;const a=e.background;a&&a.color&&(t.background=a.write(null,i)),e.viewpoint&&(t.initialState={viewpoint:e.viewpoint.write(null,i)}),e.rangeInfo&&(t.mapRangeInfo=e.rangeInfo.toJSON(i)),e.spatialReference&&(t.spatialReference=e.spatialReference.write(null,i))}writeLayers(e,t,r,i){t[r]=this._writeLayers(e,i,"operational-layers")}readSourceVersion(e,t){const[r,i]=t.version.split(".");return new H(parseInt(r,10),parseInt(i,10))}writeSourceVersion(e,t,r){t[r]=`${Q.major}.${Q.minor}`}writeTables(e,t,r,i){const a=this._writeLayers(e,i,"tables");a.length&&(t[r]=a)}get thumbnailUrl(){return this.portalItem&&this.portalItem.thumbnailUrl||null}set thumbnailUrl(e){e?(this._override("thumbnailUrl",e),this._thumbnailFilename=this._generateCustomThumbnailFilename(e)):this._clearThumbnailOverride()}load(e){return this.addResolvingPromise(this._loadFromSource()),y(this)}loadAll(){return O(this,(e=>{e(this.ground,this.basemap,this.layers,this.tables)}))}read(e,t){t={...t,origin:"web-map"};const r=this._getAuthoringPropsState();g(this,e,(t=>super.read(e,t)),t),this._restoreAuthoringPropsFromState(r)}write(e,t){if("loaded"!==this.loadStatus){const e=new l("webmap:not-loaded","Web map must be loaded before it can be serialized");throw Y.error("#toJSON()","Web map must be loaded before it can be serialized",this.loadError||this.loadStatus),e}return this._removeDanglingLayerRefs(),t={...t,origin:"web-map",restrictedWebMapWriting:!0,webmap:this},super.write(e,t)}async save(e){e=e||{},this._validateItem(),await this._updateFromPromise,await this.load(),await this._loadLayerContainers(),this._validateMap();const t=this.portalItem,r={origin:"web-map",messages:[],writtenProperties:[],url:t.itemUrl&&p(t.itemUrl),portal:t.portal||j.getDefault()},i=this.write(null,r);return this._validateJSONForWriting(r,e),await this._updateItemProperties(t),await this._updateItem(t,i,r),await this._updateItemThumbnail(),t}async saveAs(e,t){t=t||{};const r=this._getPortalItem(e);await this._updateFromPromise,await this.load(),await this._loadLayerContainers(),this._validateMap();const i={origin:"web-map",messages:[],writtenProperties:[],url:null,portal:r.portal},a=this.write(null,i);this._validateJSONForWriting(i,t),await this._updateItemPropertiesForSaveAs(r);const o=this._getThumbnailState();return await this._createItem(r,a,i,t),this._restoreThumbnailFromState(o),await this._updateItemThumbnail(),r}async updateFrom(e,t){const r=this._updateFromInternal(e,t);this._updateFromPromise=r,await r;r===this._updateFromPromise&&(this._updateFromPromise=null)}getLayerJSONFromResourceInfo(e){var t,r,i,a;const o=this.resourceInfo;return this._collectAllLayersJSON(d([null==o||null==(t=o.baseMap)?void 0:t.baseMapLayers,null==o?void 0:o.operationalLayers,null==(r=this.basemap)||null==(i=r.resourceInfo)||null==(a=i.data)?void 0:a.baseMapLayers])).find((t=>t.id===e.id))}_collectAllLayersJSON(e){return e.reduce(((e,t)=>(e.push(t),"GroupLayer"===t.layerType&&(e=e.concat(this._collectAllLayersJSON(t.layers||[]))),e)),[])}_writeLayers(e,r,i){r={...r,layerContainerType:i};return e.map((e=>t(P(e,"tables"===i?null:this.getLayerJSONFromResourceInfo(e),r)))).filter(Boolean).toArray()}_loadFromSource(){return this.resourceInfo?this._loadFromJSON(this.resourceInfo,{origin:"web-map"}):this.portalItem&&this.portalItem.id?this._loadFromItem(this.portalItem):y(null)}_loadFromItem(e){return e.load().catch((e=>{throw new l("webmap:load-portal-item","Failed to load portal item",{error:e})})).then((()=>{if("Web Map"!==e.type)throw new l("webmap:invalid-portal-item","Invalid portal item type '${type}', expected 'Web Map'",{type:e.type})})).then((()=>e.fetchData())).then((t=>(this.resourceInfo=t,this._readAndLoadFromJSON(t,{origin:"web-map",portal:e.portal||j.getDefault()})))).then((()=>this._computeInitialViewpoint()))}_readAndLoadFromJSON(e,t){const r=this._validateJSON(e);return this.read(r,t),this._loadFromJSON(r,t)}_validateJSON(e){const t=H.parse(e.version||"","webmap");return Q.validate(t),e.version=`${t.major}.${t.minor}`,e}_loadFromJSON(e,t){const r={context:{...t,layerContainerType:"operational-layers"}};return this.portalItem&&(r.context.portal=this.portalItem.portal||j.getDefault()),import("./layers/support/layersCreator.js").then((({populateOperationalLayers:t})=>{const i=[],a=e.operationalLayers;a&&a.length&&i.push(t(this.layers,a,r));const o={...r,context:{...r.context,layerContainerType:"tables"},defaultLayerType:"ArcGISFeatureLayer"},s=e.tables;return s&&s.length&&i.push(t(this.tables,s,o)),w(i).then((()=>{}))}))}async _computeInitialViewpoint(){var e,t;let r=this.initialViewProperties;if(null==(e=r)||null==(t=e.viewpoint)?void 0:t.targetGeometry)return;const i=await this._getExtentFromItem();i&&(r=r?r.clone():new q,r.viewpoint=new F,r.viewpoint.targetGeometry=i,this.initialViewProperties=r)}async _getExtentFromItem(){var e,t;const r=null==(e=this.initialViewProperties)?void 0:e.spatialReference,i=null==(t=this.portalItem)?void 0:t.extent;if(r&&i){if(r.isWGS84)return i.clone();if(r.isWebMercator)return b(i);return(await import("./portal/support/geometryServiceUtils.js")).create(this.portalItem).then((e=>{const t=new B;return t.geometries=[i],t.outSpatialReference=r,e.project(t)})).then((e=>e[0])).catch((e=>(Y.error("Error projecting item's extent:",e),null)))}return null}_removeDanglingLayerRefs(){const e=this.applicationProperties,t=e&&e.viewing&&e.viewing.search,r=e=>!!this.allLayers.find((t=>t.id===e));t&&t.layers&&(t.layers=t.layers.filter((e=>r(e.id)))),t&&t.tables&&(t.tables=t.tables.filter((e=>!!this.tables.find((t=>t.id===e.id)))));const i=e&&e.editing&&e.editing.locationTracking;i&&i.info&&!r(i.info.layerId)&&(e.editing=null);const a=this.presentation&&this.presentation.slides;a&&a.forEach((e=>{e.visibleLayers&&(e.visibleLayers=e.visibleLayers.filter((e=>r(e.id))))}))}_validateMap(){if(!this.basemap||!this.basemap.baseLayers.length)throw new l("webmap:save","Map does not have a valid basemap with a base layer.")}_validateItem(){if(!this.portalItem)throw Y.error("save: requires the portalItem property to be set"),new l("webmap:portal-item-not-set","Portal item to save to has not been set on the WebMap");this._validateItemType(this.portalItem)}_validateItemType(e){if("Web Map"!==e.type)throw new l("webmap:portal-item-wrong-type",'Portal item needs to have type "Web Map"')}_loadLayerContainers(){const e=[];return this.basemap&&e.push(this.basemap.load()),this.ground&&e.push(this.ground.load()),w(e).then((()=>{}))}_loadAllLayers(){const e=this._getAllLayersAndTables().map((e=>e.load()));return w(e).then((()=>{}))}_getAllLayersAndTables(){return this.allLayers.concat(this.allTables)}_validateJSONForWriting(e,t){let r=e.messages.filter((e=>"error"===e.type)).map((e=>new l(e.name,e.message,e.details)));if(t.ignoreUnsupported&&(r=r.filter((e=>"layer:unsupported"!==e.name&&"symbol:unsupported"!==e.name&&"symbol-layer:unsupported"!==e.name&&"property:unsupported"!==e.name&&"url:unsupported"!==e.name))),r.length>0)throw new l("webmap:save","Failed to save webmap due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:r})}async _updateItemProperties(e){e.extent=await this._getWGS84Extent(this.initialViewProperties.viewpoint.targetGeometry),await this._updateTypeKeywords(e)}async _updateItemPropertiesForSaveAs(e){C(e,"CollectorDisabled"),C(e,"OfflineDisabled"),C(e,"Workforce Project"),C(e,"Workforce Worker"),C(e,"Workforce Dispatcher"),C(e,"Offline Map Areas"),C(e,"FieldMapsDisabled"),await this._updateItemProperties(e)}async _getWGS84Extent(e){const t=e.clone().normalize();let r;if(t.length>1)for(const e of t)r?e.width>r.width&&(r=e):r=e;else r=t[0];return this._projectToWGS84(r)}async _projectToWGS84(e){const t=e.spatialReference;if(t.isWGS84)return e.clone();if(t.isWebMercator)return _(e);const r=await import("./portal/support/geometryServiceUtils.js"),i=await r.create(this.portalItem),a=new B;a.geometries=[e],a.outSpatialReference=f.WGS84;return(await i.project(a))[0]}async _updateTypeKeywords(e){N(e,"ArcGIS API for JavaScript"),await this._loadAllLayers(),this._evalCollectorKeyword(e),this._evalDataEditingKeyword(e),this._evalOfflineKeyword(e),this._evalDeveloperBasemapKeyword(e),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,r)=>r.indexOf(e)===t)))}_evalCollectorKeyword(e){E(e,"CollectorDisabled")||E(e,"Workforce Project")||E(e,"Workforce Worker")||E(e,"Workforce Dispatcher")||!this._hasEditableFeatureLayer()?C(e,"Collector"):N(e,"Collector")}_evalDataEditingKeyword(e){this._hasEditableFeatureLayer()?N(e,"Data Editing"):C(e,"Data Editing")}_evalOfflineKeyword(e){!E(e,"OfflineDisabled")&&this._isOfflineCapableMap()?N(e,"Offline"):C(e,"Offline")}_evalDeveloperBasemapKeyword(e){V(this.basemap)?N(e,"DeveloperBasemap"):C(e,"DeveloperBasemap")}_hasEditableFeatureLayer(){return this._getAllLayersAndTables().some((e=>e.loaded&&this._isFeatureServiceLayer(e)&&e.capabilities.operations.supportsEditing&&e.editingEnabled))}_isFeatureServiceLayer(e){return!("feature"!==e.type||!e.source||"feature-layer"!==e.source.type)}_isOfflineCapableMap(){return this._getAllLayersAndTables().filter((e=>"group"!==e.type)).every((e=>e.loaded&&this._isOfflineCapableLayer(e)))}_isOfflineCapableLayer(e){return this._isFeatureServiceLayer(e)&&e.capabilities.operations.supportsSync||("tile"===e.type||"vector-tile"===e.type)&&(e.capabilities.operations.supportsExportTiles||this._isExportableAGOLTileLayer(e)||U(e))&&e.spatialReference.equals(this.initialViewProperties.spatialReference)}_isExportableAGOLTileLayer(e){return"tile"===e.type&&(k(e.url)&&ee.some((t=>e.url.toLowerCase().indexOf("/"+t+"/")>-1)))}async _updateItem(e,t,r){await e.update({data:t}),this._syncUpInstanceWithItem(e,t,r)}async _createItem(e,t,r,i){const a=this.portalItem,o=!!(a&&a.id&&a.portal.user),s=e.portal;if(await s._signIn(),!await this._canCopyItem(a,o,s))throw new l("webmap:save-as-copy-not-allowed","Owner of this map does not allow others to save a copy");await s.user.addItem({item:e,folder:i.folder,data:t}),this.portalItem=e,this._syncUpInstanceWithItem(e,t,r)}async _canCopyItem(e,t,i){return!(r(e)&&e.id&&e.typeKeywords&&e.typeKeywords.indexOf("useOnly")>-1)||e.portal.portalHostname===i.portalHostname&&(t||await e.reload(),"admin"===e.itemControl||"update"===e.itemControl)}_syncUpInstanceWithItem(e,t,r){R.prototype.read.call(this,{version:t.version,authoringApp:t.authoringApp,authoringAppVersion:t.authoringAppVersion},{origin:"web-map",ignoreDefaults:!0,url:e.itemUrl&&p(e.itemUrl)}),M(r),this.resourceInfo=t}async _updateItemThumbnail(){this.thumbnailUrl&&this._isOverridden("thumbnailUrl")&&(await this.portalItem.updateThumbnail({thumbnail:this.thumbnailUrl,filename:this._thumbnailFilename}),this._clearThumbnailOverride())}_getPortalItem(e){let t=L.from(e);return t.id&&(t=t.clone(),t.id=null),t.type||(t.type="Web Map"),t.portal||(t.portal=j.getDefault()),this._validateItemType(t),t}async _updateFromInternal(e,t){t=t||{},await x(e,"ready"),this._updateInitialViewProperties(e,t),await this._updateThumbnailUrl(e,t)}_updateInitialViewProperties(e,t){var r;t.backgroundExcluded||(this.initialViewProperties.background=null==(r=e.background)?void 0:r.clone());if(this.initialViewProperties.spatialReference=e.spatialReference.clone(),t.viewpointExcluded||(this.initialViewProperties.viewpoint=new F({rotation:e.rotation,scale:t.scalePreserved?e.scale:null,targetGeometry:this._getViewExtent(e)})),!t.widgetsExcluded)for(const t of e.persistableViewModels)t.updateWebDocument(this)}_getViewExtent(e){const t=e.center.clone().normalize(),r=e.extent.clone(),i=r.width/2;return r.xmin=t.x-i,r.xmax=t.x+i,r}async _updateThumbnailUrl(e,t){if(t.thumbnailExcluded)return;const r=G(e,t.thumbnailSize),i=await e.takeScreenshot({format:"png",width:r.width,height:r.height});this._setAutoGeneratedThumbnail(i.dataUrl)}_setAutoGeneratedThumbnail(e){this.thumbnailUrl=e,this._thumbnailFilename=null}_clearThumbnailOverride(){this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"),this._thumbnailFilename=null}_generateCustomThumbnailFilename(e){if(u(e)){const t=m(e),r=t&&t.mediaType,i=r&&Z.get(r.toLowerCase())||null,a=`thumbnail${Date.now()}`;return i?`${a}.${i}`:a}return null}_getThumbnailState(){let e=this.thumbnailUrl;return e&&(e=this._isOverridden("thumbnailUrl")?e:h(e,"w","8192")),{thumbnailUrl:e,filename:this._thumbnailFilename}}_restoreThumbnailFromState(e){this.thumbnailUrl=e.thumbnailUrl,this._thumbnailFilename=e.filename}_getAuthoringPropsState(){return{authoringApp:this.authoringApp,authoringAppVersion:this.authoringAppVersion,isAuthoringAppSetByUser:this._isAuthoringAppSetByUser,isAuthoringAppVersionSetByUser:this._isAuthoringAppVersionSetByUser}}_restoreAuthoringPropsFromState(e){e.isAuthoringAppSetByUser?this.authoringApp=e.authoringApp:this._isAuthoringAppSetByUser=!1,e.isAuthoringAppVersionSetByUser?this.authoringAppVersion=e.authoringAppVersion:this._isAuthoringAppVersionSetByUser=!1}static fromJSON(e){const t=e;if(!t)throw new l("webmap:empty-resource","Expected a JSON resource but got nothing");return new this({resourceInfo:t})}};te.VERSION=Q,e([a({type:K,json:{write:!0}})],te.prototype,"applicationProperties",void 0),e([a({type:String,json:{write:{allowNull:!0,ignoreOrigin:!0}}})],te.prototype,"authoringApp",null),e([n("authoringApp")],te.prototype,"writeAuthoringApp",null),e([a({type:String,json:{write:{allowNull:!0,ignoreOrigin:!0}}})],te.prototype,"authoringAppVersion",null),e([n("authoringAppVersion")],te.prototype,"writeAuthoringAppVersion",null),e([a({json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],te.prototype,"basemap",void 0),e([a({type:X,json:{write:{overridePolicy:e=>({enabled:!!(e&&e.length>0),ignoreOrigin:!0})}}})],te.prototype,"bookmarks",void 0),e([a({type:q,nonNullable:!0,json:{read:{source:["background","initialState.viewpoint","mapRangeInfo","spatialReference"]},write:{ignoreOrigin:!0,target:{background:{type:z},"initialState.viewpoint":{type:F},mapRangeInfo:{type:D},spatialReference:{type:f}}}}})],te.prototype,"initialViewProperties",void 0),e([o("initialViewProperties")],te.prototype,"readInitialViewProperties",null),e([n("initialViewProperties")],te.prototype,"writeInitialViewProperties",null),e([a({json:{write:{target:"operationalLayers",ignoreOrigin:!0}}})],te.prototype,"layers",void 0),e([n("layers")],te.prototype,"writeLayers",null),e([a({type:L})],te.prototype,"portalItem",void 0),e([a({json:{write:!0}})],te.prototype,"presentation",void 0),e([a()],te.prototype,"resourceInfo",void 0),e([a({readOnly:!0,type:H,json:{read:{source:"version"},write:{allowNull:!0,ignoreOrigin:!0,target:"version",isRequired:!0}}})],te.prototype,"sourceVersion",void 0),e([o("sourceVersion")],te.prototype,"readSourceVersion",null),e([n("sourceVersion")],te.prototype,"writeSourceVersion",null),e([a({json:{read:!1,write:{ignoreOrigin:!0}}})],te.prototype,"tables",void 0),e([n("tables")],te.prototype,"writeTables",null),e([a({dependsOn:["portalItem.thumbnailUrl"]})],te.prototype,"thumbnailUrl",null),e([a({type:J,json:{write:!0}})],te.prototype,"widgets",void 0),te=e([s("esri.WebMap")],te);var re=te;export default re;
