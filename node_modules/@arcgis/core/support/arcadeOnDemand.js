/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as e}from"../core/maybe.js";import{all as r}from"../core/promiseUtils.js";import t from"../geometry/SpatialReference.js";import"../geometry.js";let a;async function s(){return a||(a=(async()=>{const e=await import("./arcadeUtils.js");return await e.arcade.load(),{arcade:e.arcade,arcadeUtils:e,Dictionary:e.Dictionary,Feature:e.arcadeFeature}})()),a}const i=(e,r,t)=>l.create(e,r,t,null,["$feature"]),c=(e,r,t)=>l.create(e,r,t,null,["$feature","$view"]),n=c,o=(e,r,t,a)=>l.create(e,r,t,a,["$feature","$view"]);class l{constructor(e,r,t,a,s,i,c,n){this.script=e,this.evaluate=s,this.fields=c,this._syntaxTree=a,this._arcade=r,this._arcadeDictionary=t,this._arcadeFeature=i,this._spatialReference=n,this._referencesGeometry=r.scriptTouchesGeometry(this._syntaxTree),this._referencesScale=this._arcade.referencesMember(this._syntaxTree,"scale")}static async create(a,i,c,n,o,u){const{arcade:p,Feature:f,Dictionary:d}=await s(),m=t.fromJSON(i),h=p.parseScript(a,u),y=o.reduce(((e,r)=>({...e,[r]:null})),{});let _=null;e(n)&&(_=new d(n),_.immutable=!0,y.$config=null);const F=p.scriptUsesGeometryEngine(h)&&p.enableGeometrySupport(),w=p.scriptUsesFeatureSet(h)&&p.enableFeatureSetSupport(),S=p.scriptIsAsync(h)&&p.enableAsyncSupport(),b={vars:y,spatialReference:m,useAsync:!!S},$=new d;$.immutable=!1,$.setField("scale",0);const x=p.compileScript(h,b);return await r([F,w,S]),new l(a,p,d,h,(e=>("$view"in e&&e.$view&&($.setField("scale",e.$view.scale),e.$view=$),_&&(e.$config=_),x({vars:e,spatialReference:m}))),new f,c,m)}repurposeFeature(e){return e.geometry&&!e.geometry.spatialReference&&(e.geometry.spatialReference=this._spatialReference),this._arcadeFeature.repurposeFromGraphicLikeObject(e.geometry,e.attributes,{fields:this.fields}),this._arcadeFeature}repurposeAdapter(e){return this._arcadeFeature.repurposeFromAdapter(e,{fields:this.fields}),this._arcadeFeature}createDictionary(){return new this._arcadeDictionary}referencesMember(e){return this._arcade.referencesMember(this._syntaxTree,e)}referencesFunction(e){return this._arcade.referencesFunction(this._syntaxTree,e)}referencesGeometry(){return this._referencesGeometry}referencesScale(){return this._referencesScale}extractFieldLiterals(e){return this._arcade.extractFieldLiterals(this._syntaxTree,e)}}export default l;export{l as ArcadeExpression,o as createDictionaryExpression,i as createLabelExpression,c as createRendererExpression,n as createVVExpression,s as loadArcade};
