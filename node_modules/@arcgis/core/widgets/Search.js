/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../core/has.js";import{escapeRegExpString as t}from"../core/string.js";import"../core/Logger.js";import"../core/accessorSupport/ensureType.js";import{property as s}from"../core/accessorSupport/decorators/property.js";import{aliasOf as r}from"../core/accessorSupport/decorators/aliasOf.js";import{subclass as i}from"../core/accessorSupport/decorators/subclass.js";import"../core/urlUtils.js";import"../core/uuid.js";import"../portal/support/resourceExtension.js";import{eventKey as n}from"../core/events.js";import{createAbortController as o}from"../core/promiseUtils.js";import{substitute as a}from"../intl/substitute.js";import"../intl.js";import l from"../core/Handles.js";import{watch as u,on as c,init as h}from"../core/watchUtils.js";import{storeNode as d,keepMenuItemWithinView as g}from"./support/widgetUtils.js";import{messageBundle as p}from"./support/decorators/messageBundle.js";import{renderable as _}from"./support/decorators/renderable.js";import{vmEvent as m}from"./support/decorators/vmEvent.js";import{j as v}from"../chunks/index.js";import M from"./Widget.js";import S from"./Search/SearchViewModel.js";import w from"./Search/SearchResultRenderer.js";const I="esri-search esri-widget",y="esri-widget__loader",b="esri-widget__loader-text",f="esri-widget__loader-animation",C="esri-input",x="esri-search--multiple-sources",T="esri-search--loading",k="esri-search--searching",E="esri-search--show-suggestions",N="esri-search--sources",L="esri-search--warning",R="esri-search__container",B="esri-search__input",j="esri-search__input-container",A="esri-search__form",$="esri-search__submit-button",D="esri-search__sources-button",F="esri-search__clear-button",O="esri-search__source-name",W="esri-search__suggestions-menu",G="esri-search__suggestions-list",U="esri-search__suggestions-list--current-location",K="esri-search__sources-menu",H="esri-search__source",P="esri-search__warning-menu",V="esri-search__warning-body",X="esri-search__warning-header",z="esri-search__warning-text",q="esri-search__no-value-text",J="esri-widget--disabled",Q="esri-widget--button",Y="esri-icon-font-fallback-text",Z="esri-icon-locate-circled",ee="esri-menu",te="esri-menu__list",se="esri-menu__list-item",re="esri-menu__list-item--active",ie="esri-menu__list-item--focus",ne="esri-menu__header",oe="esri-icon-search",ae="esri-icon-down-arrow esri-search__sources-button--down",le="esri-icon-up-arrow esri-search__sources-button--up",ue="esri-icon-close",ce="esri-icon-notice-triangle",he="esri-icon-search",de="esri-disabled",ge=/<[a-z/][\s\S]*>/i;let pe=class extends M{constructor(e,t){super(e,t),this._activeMenuItemIndex=-1,this._handles=new l,this._inputNode=null,this._menuItemCount=0,this._sourceMenuButtonNode=null,this._sourceListNode=null,this._suggestionListNode=null,this._searchResultRenderer=new w,this._relatedTarget=null,this._locateFailed=null,this.activeMenu="none",this.activeSource=null,this.activeSourceIndex=null,this.allPlaceholder=null,this.allSources=null,this.autoNavigate=null,this.autoSelect=null,this.defaultSources=null,this.disabled=!1,this.goToOverride=null,this.iconClass=he,this.includeDefaultSources=null,this.label=void 0,this.locationEnabled=null,this.maxResults=null,this.maxSuggestions=null,this.messages=null,this.messagesCommon=null,this.minSuggestCharacters=null,this.popupEnabled=null,this.popupTemplate=null,this.portal=null,this.resultGraphic=null,this.resultGraphicEnabled=null,this.results=null,this.searchAllEnabled=null,this.searchTerm=null,this.selectedResult=null,this.sources=null,this.suggestions=null,this.suggestionsEnabled=null,this.view=null,this.viewModel=new S,this.own(u(this,"searchTerm",(e=>{(e&&"warning"===this.activeMenu||!e&&!this.get("viewModel.selectedSuggestion.location"))&&(this.activeMenu="none")})),c(this,"viewModel.allSources","change",(()=>this._watchSourceChanges())),h(this,"viewModel.defaultPopupTemplate",(e=>{e&&(e.content=this._renderSearchResultsContent.bind(this))})))}destroy(){this._handles.destroy(),this._handles=null,this._cancelSuggest(),this._cancelSearch(),this._searchResultRenderer&&(this._searchResultRenderer.viewModel=null,this._searchResultRenderer.destroy(),this._searchResultRenderer=null)}get displayedSearchTerm(){return`${this.viewModel.searchTerm}`.trim()}get suggestionsMenuId(){return this._buildId("suggest-menu")}get sourceMenuId(){return this._buildId("source-menu")}clear(){}focus(){this._inputNode&&(this.activeMenu="suggestion",this._inputNode.focus(),this.emit("search-focus"))}blur(e){this._inputNode&&(this._inputNode.blur(),this._inputBlur(e),this.emit("search-blur"))}search(e){this.activeMenu="none",this._cancelSuggest(),this._cancelSearch();const t=o(),{signal:s}=t;return this._searchController=t,this.viewModel.search(e,{signal:s}).catch((e=>{if(this._searchController===t)return this.activeMenu="none",this._searchController=null,e})).then((e=>{if(this._searchController===t)return this.activeMenu=e.numResults?"none":"warning",this._searchController=null,e}))}suggest(e){this._cancelSuggest();const t=o(),{signal:s}=t;return this._suggestController=t,this.viewModel.suggest(e,null,{signal:s}).then((e=>{if(this._suggestController===t)return this._suggestController=null,e.numResults&&(this.activeMenu="suggestion"),this._scrollToTopSuggestion(),e})).catch((()=>{if(this._suggestController===t)return this._suggestController=null,null}))}render(){const{state:e}=this.viewModel,t={[de]:"disabled"===e,[J]:this.disabled};return v("div",{class:this.classes(I,t)},"loading"===e?this.renderLoader():this.renderContainer())}renderSubmitButton(){const{messages:e}=this;return v("button",{"aria-label":e.searchButtonTitle,bind:this,class:this.classes($,Q),key:"esri-search__submit-button",onclick:this._handleSearchButtonClick,title:e.searchButtonTitle},v("span",{"aria-hidden":"true",role:"presentation",class:oe}))}renderWarningMenu(){return v("div",{key:"esri-search__error-menu",class:this.classes(ee,P)},v("div",{class:V},this.renderWarning()))}renderSourceMenuButton(){const{messages:e,activeMenu:t,sourceMenuId:s}=this,{activeSourceIndex:r,allSources:i}=this.viewModel,n="source"===t?this._buildId("source-item",r):null;return i.length>1?v("button",{"aria-activedescendant":n,key:"esri-search__source-menu-button",bind:this,title:e.searchIn,"aria-haspopup":"true","aria-expanded":"source"===t,"aria-controls":s,class:this.classes(D,Q),onkeydown:this._handleSourceMenuButtonKeydown,onclick:this._handleSourcesMenuToggleClick,onkeyup:this._handleSourceMenuButtonKeyup,onblur:this._sourcesButtonBlur,afterCreate:d,"data-node-ref":"_sourceMenuButtonNode"},v("span",{"aria-hidden":"true",role:"presentation",class:ae}),v("span",{"aria-hidden":"true",role:"presentation",class:le}),v("span",{class:O},this._getSourceName(r))):null}renderSourcesList(){const{allSources:e,searchAllEnabled:t}=this.viewModel;return e.length>1?v("ul",{id:this.sourceMenuId,role:"menu",bind:this,afterCreate:d,"data-node-ref":"_sourceListNode",class:te},t?this.renderSource(S.ALL_INDEX):null,e.map(((e,t)=>this.renderSource(t))).toArray()):null}renderSourcesMenu(){const{allSources:e}=this.viewModel;return e.length>1?v("div",{key:"esri-search__source-menu",class:this.classes(ee,K)},this.renderSourcesList()):null}renderLoader(){const{messages:e,messagesCommon:t}=this;return v("div",{role:"presentation",class:y,key:"base-loader"},v("span",{"aria-hidden":"true",role:"presentation",class:f}),v("span",{class:Y},e.searchButtonTitle),v("span",{class:b},t.loading))}renderContainer(){const{allSources:e,state:t}=this.viewModel,{activeMenu:s}=this,r={[x]:e.length>1,[T]:"loading"===t,[k]:"searching"===t,[L]:"warning"===s,[N]:"source"===s,[E]:"suggestion"===s};return v("div",{role:"presentation",class:this.classes(r,R),key:"base-container"},this.renderSourceMenuButton(),this.renderSourcesMenu(),this.renderInputContainer(),this.renderSubmitButton(),this.renderWarningMenu())}renderClearButton(){return this.searchTerm?v("button",{bind:this,class:this.classes(F,Q),key:"esri-search__clear-button",onclick:this._handleClearButtonClick,onfocus:this._clearButtonFocus,title:this.messages.clearButtonTitle},v("span",{"aria-hidden":"true",class:ue})):null}renderLocationGroup(){const{messages:e,locationEnabled:t,displayedSearchTerm:s}=this,r=t&&!s,i=0===this._activeMenuItemIndex;return r?v("ul",{role:"presentation",key:"esri-search__suggestion-list-current-location",class:this.classes(te,G,U)},v("li",{bind:this,"data-current-location-item":!0,onclick:this._handleUseCurrentLocationClick,role:"menuitem",class:this.classes(se,i?ie:null)},v("span",{"aria-hidden":"true",role:"presentation",class:Z})," ",e.useCurrentLocation)):null}renderInput(){const{_activeMenuItemIndex:e,activeMenu:t,locationEnabled:s,displayedSearchTerm:r,messages:i,suggestionsMenuId:n}=this,{maxInputLength:o,placeholder:a,searchTerm:l,suggestionCount:u}=this.viewModel,c=s&&!r||u,h="suggestion"===t?this._buildId("suggestion-item",e):null;return v("input",{"aria-activedescendant":h,bind:this,placeholder:a,"aria-label":i.searchButtonTitle,maxlength:o,autocomplete:"off",type:"text",class:this.classes(C,B),"aria-autocomplete":"list",value:l,"aria-haspopup":"true","aria-owns":c?n:null,role:"textbox",onkeyup:this._handleInputKeyup,onclick:this._handleInputClick,oninput:this._handleInputPaste,onpaste:this._handleInputPaste,afterCreate:d,"data-node-ref":"_inputNode",onfocusout:this._storeRelatedTarget,onfocus:this.focus,onblur:this.blur,title:l?"":a})}renderForm(){return v("form",{key:"esri-search__form",bind:this,class:A,onsubmit:this._formSubmit,role:"search"},this.renderInput())}renderSuggestList(e){const{sourceIndex:t}=e,s=e.results.length,r=e.results;return s?v("ul",{role:"presentation",key:`esri-search__suggestion-list-${t}`,class:this.classes(te,G)},r.map((e=>this.renderSuggestion(e,this._menuItemCount++)))):null}renderSuggestionsGroup(){const{suggestions:e}=this.viewModel;return e?e.map((e=>[this.renderSuggestionHeader(e),this.renderSuggestList(e)])):null}renderSuggestionsMenu(){const{activeMenu:e,displayedSearchTerm:t,locationEnabled:s,suggestionsMenuId:r}=this,{suggestionCount:i}=this.viewModel,n=s&&!t||i;return this._menuItemCount=0,n?v("div",{id:r,"aria-expanded":"suggestion"===e,key:"esri-search__suggestions-menu",class:this.classes(ee,W),role:"menu",bind:this,afterCreate:d,"data-node-ref":"_suggestionListNode"},this.renderLocationGroup(),this.renderSuggestionsGroup()):null}renderInputContainer(){return v("div",{key:"esri-search__input-container",class:j},this.renderForm(),this.renderSuggestionsMenu(),this.renderClearButton())}renderSuggestionHeader(e){const{allSources:t,activeSourceIndex:s}=this.viewModel,{sourceIndex:r}=e,i=e.results.length,n=t.length>1&&s===S.ALL_INDEX;return i&&n?v("div",{key:`esri-search__suggestion-header-${r}`,class:ne},this._getSourceName(r)):null}renderSuggestion(e,t){const{_activeMenuItemIndex:s,messages:r}=this,{searchTerm:i}=this.viewModel;if(i){const{text:n}=e,o=n||r.untitledResult,a=ge.test(o),l=[];if(a)l.push(v("div",{innerHTML:o}));else{const e=this._splitResult(o,i),t=i.toLowerCase();e.forEach(((e,s)=>{e&&e.length&&(e.toLowerCase()===t?l.push(v("strong",{key:s},e)):l.push(e))}))}const u=s===t;return v("li",{bind:this,id:this._buildId("suggestion-item",t),onclick:this._handleSuggestionClick,key:`esri-search__suggestion_${t}`,"data-suggestion":e,role:"menuitem",class:this.classes(se,u?ie:null)},l)}}renderSource(e){const{activeSourceIndex:t,searchAllEnabled:s}=this.viewModel,r={[re]:e===t,[ie]:e===(s?this._activeMenuItemIndex-1:this._activeMenuItemIndex)};return v("li",{bind:this,key:`esri-search__source-${e}`,id:this._buildId("source-item",e),onclick:this._handleSourceClick,"data-source-index":e,role:"menuitem",class:this.classes(H,se,r)},this._getSourceName(e))}renderNoResultsWarning(e){const{messages:t}=this,s=e?a(t.noResultsFoundForValue,{value:`"${e}"`}):t.noResultsFound;return v("div",{key:"esri-search__no_results"},v("div",{class:X},t.noResults),v("div",{class:z},s))}renderEmptySearchWarning(){const{messages:e}=this;return v("div",{key:"esri-search__empty-search"},v("span",{"aria-hidden":"true",class:ce}),v("span",{class:q},e.emptyValue))}renderLocateWarning(){const{messages:e}=this;return v("div",{key:"esri-search__locate-error"},v("span",{"aria-hidden":"true",class:ce}),v("span",{class:q},e.locateError))}renderWarning(){var e;const{displayedSearchTerm:t,_locateFailed:s}=this,{viewModel:r}=this;return s?this.renderLocateWarning():null!=(e=r.selectedSuggestion)&&e.location||t?this.renderNoResultsWarning(t):this.renderEmptySearchWarning()}_buildId(e,t){return`${this.id}-${e}${void 0===t?"":`-${t}`}`}_watchSourceChanges(){const{_handles:e,viewModel:{allSources:t}}=this,s="sources";e.remove(s),t.forEach((t=>e.add(u(t,"name",(()=>this.scheduleRender())),s)))}_handleSourcesMenuToggleClick(){if("source"===this.activeMenu){const e=this._sourceListNode.getElementsByTagName("li")[this._activeMenuItemIndex];this._setSourceFromMenuItem(e)}else this.activeMenu="source",this.renderNow(),this._sourceMenuButtonNode&&this._sourceMenuButtonNode.focus(),this._activeMenuItemIndex=this.searchAllEnabled?this.activeSourceIndex+1:this.activeSourceIndex}_handleClearButtonClick(){this.viewModel.clear(),this._focus()}_handleSearchButtonClick(){this.search()}_handleSuggestionClick(e){const t=e.currentTarget["data-suggestion"];t&&(this._focus(),this.search(t))}_handleUseCurrentLocationClick(){this._useCurrentLocation()}_useCurrentLocation(){this._focus("none"),this._cancelSuggest(),this._cancelSearch();const e=o(),{signal:t}=e;this._searchController=e,this.viewModel.searchNearby({signal:t}).catch((()=>{this._locateFailed=!0,this.activeMenu="warning"})).then((()=>{this._searchController=null}))}_handleSourceClick(e){this._setSourceFromMenuItem(e.currentTarget)}_setSourceFromMenuItem(e){const t=e["data-source-index"];this.viewModel.activeSourceIndex=t,this._focus("none")}_sourcesButtonBlur(e){const t=e&&e.relatedTarget;this._removeActiveMenu(t,this._sourceListNode)}_inputBlur(e){const t=e&&e.relatedTarget;this._removeActiveMenu(t||this._relatedTarget,this._suggestionListNode)}_storeRelatedTarget(e){this._relatedTarget=e.relatedTarget}_clearButtonFocus(){this.activeMenu="none"}_removeActiveMenu(e,t){!e||e&&t&&t.contains(e)||(this.activeMenu="none")}_cancelSuggest(){this._suggestController&&(this._suggestController.abort(),this._suggestController=null)}_cancelSearch(){this._searchController&&(this._searchController.abort(),this._searchController=null),this._locateFailed=!1}_handleInputKeyup(e){var t;const s=n(e);if(e.ctrlKey||e.metaKey||"Copy"===s||"ArrowLeft"===s||"ArrowRight"===s||"Shift"===s)return;if("Tab"===s||"Escape"===s||e.shiftKey&&"Tab"===s)return this._cancelSuggest(),"Escape"===s&&(this.activeMenu="none"),void(this._activeMenuItemIndex=-1);const r="Home"===s||"End"===s||"ArrowUp"===s||"ArrowDown"===s,i=null==(t=this._suggestionListNode)?void 0:t.getElementsByTagName("li");if(null!=i&&i.length){if("suggestion"!==this.activeMenu&&(this.activeMenu="suggestion"),r)return e.preventDefault(),this._cancelSuggest(),void this.handleItemNavigation(s,i,this._suggestionListNode);const t=i[this._activeMenuItemIndex];if("Enter"===s&&t){const e=t["data-suggestion"];return void(e?(this._focus(),this.search(e)):t["data-current-location-item"]&&this._useCurrentLocation())}}this.viewModel.searchTerm&&this.suggest()}handleItemNavigation(e,t,s){const r=this._activeMenuItemIndex;"Home"===e&&(this._activeMenuItemIndex=0),"End"===e&&(this._activeMenuItemIndex=t.length-1),"ArrowUp"===e&&(this._activeMenuItemIndex=0===this._activeMenuItemIndex?t.length-1:this._activeMenuItemIndex-1),"ArrowDown"===e&&(this._activeMenuItemIndex=this._activeMenuItemIndex===t.length-1?0:this._activeMenuItemIndex+1),r!==this._activeMenuItemIndex&&g(t[this._activeMenuItemIndex],s)}_scrollToTopSuggestion(){this._suggestionListNode&&(this._suggestionListNode.scrollTop=0)}_handleInputClick(){this.activeMenu="suggestion"}_handleInputPaste(e){const t=e.target;this.viewModel.searchTerm!==t.value&&(this.viewModel.searchTerm=t.value),this.viewModel.searchTerm&&this.suggest()}_handleSourceMenuButtonKeydown(e){const t=n(e);"ArrowUp"!==t&&"ArrowDown"!==t&&"End"!==t&&"Home"!==t||e.preventDefault()}_handleSourceMenuButtonKeyup(e){var t;const s=n(e),r="ArrowUp"===s||"ArrowDown"===s||"End"===s||"Home"===s;if(r&&e.preventDefault(),"Escape"===s)return void this._focus("none");const i=null==(t=this._sourceListNode)?void 0:t.getElementsByTagName("li");return i&&0!==i.length&&r?("source"!==this.activeMenu&&(this.activeMenu="source"),void this.handleItemNavigation(s,i,this._sourceListNode.parentElement)):void 0}_focus(e){this.focus(),this._activeMenuItemIndex=-1,e&&(this.activeMenu=e)}_formSubmit(e){e.preventDefault(),-1===this._activeMenuItemIndex&&this.search()}_getSourceName(e){const{messages:t}=this,s=this.viewModel,{allSources:r}=s,i=r.getItemAt(e);return e===S.ALL_INDEX?t.all:i&&i.name||t.untitledSource}_splitResult(e,s){const r=t(s);return e.replace(new RegExp(`(^|)(${r})(|$)`,"ig"),"$1|$2|$3").split("|")}_renderSearchResultsContent(){return this._searchResultRenderer.showMoreResultsOpen=!1,this._searchResultRenderer.viewModel=this.viewModel,this._searchResultRenderer}};e([s({dependsOn:["viewModel.searchTerm"]}),_()],pe.prototype,"displayedSearchTerm",null),e([s({readOnly:!0,dependsOn:["id"]}),_()],pe.prototype,"suggestionsMenuId",null),e([s({readOnly:!0,dependsOn:["id"]}),_()],pe.prototype,"sourceMenuId",null),e([s(),_()],pe.prototype,"activeMenu",void 0),e([r("viewModel.activeSource"),_()],pe.prototype,"activeSource",void 0),e([r("viewModel.activeSourceIndex"),_()],pe.prototype,"activeSourceIndex",void 0),e([r("viewModel.allPlaceholder"),_()],pe.prototype,"allPlaceholder",void 0),e([r("viewModel.allSources")],pe.prototype,"allSources",void 0),e([r("viewModel.autoNavigate")],pe.prototype,"autoNavigate",void 0),e([r("viewModel.autoSelect")],pe.prototype,"autoSelect",void 0),e([r("viewModel.defaultSources")],pe.prototype,"defaultSources",void 0),e([_(),s()],pe.prototype,"disabled",void 0),e([r("viewModel.goToOverride")],pe.prototype,"goToOverride",void 0),e([s()],pe.prototype,"iconClass",void 0),e([r("viewModel.includeDefaultSources")],pe.prototype,"includeDefaultSources",void 0),e([s({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],pe.prototype,"label",void 0),e([_(),r("viewModel.locationEnabled")],pe.prototype,"locationEnabled",void 0),e([r("viewModel.maxResults")],pe.prototype,"maxResults",void 0),e([r("viewModel.maxSuggestions")],pe.prototype,"maxSuggestions",void 0),e([s(),_(),p("esri/widgets/Search/t9n/Search")],pe.prototype,"messages",void 0),e([s(),_(),p("esri/t9n/common")],pe.prototype,"messagesCommon",void 0),e([r("viewModel.minSuggestCharacters")],pe.prototype,"minSuggestCharacters",void 0),e([r("viewModel.popupEnabled")],pe.prototype,"popupEnabled",void 0),e([r("viewModel.popupTemplate")],pe.prototype,"popupTemplate",void 0),e([r("viewModel.portal")],pe.prototype,"portal",void 0),e([r("viewModel.resultGraphic")],pe.prototype,"resultGraphic",void 0),e([r("viewModel.resultGraphicEnabled")],pe.prototype,"resultGraphicEnabled",void 0),e([r("viewModel.results"),_()],pe.prototype,"results",void 0),e([r("viewModel.searchAllEnabled"),_()],pe.prototype,"searchAllEnabled",void 0),e([r("viewModel.searchTerm"),_()],pe.prototype,"searchTerm",void 0),e([r("viewModel.selectedResult")],pe.prototype,"selectedResult",void 0),e([r("viewModel.sources")],pe.prototype,"sources",void 0),e([r("viewModel.suggestions"),_()],pe.prototype,"suggestions",void 0),e([r("viewModel.suggestionsEnabled")],pe.prototype,"suggestionsEnabled",void 0),e([r("viewModel.view"),_()],pe.prototype,"view",void 0),e([m(["search-complete","search-clear","search-start","select-result","suggest-start","suggest-complete"]),s({type:S}),_(["viewModel.allSources","viewModel.activeSource.placeholder","viewModel.activeSource.name","viewModel.state"])],pe.prototype,"viewModel",void 0),e([r("viewModel.clear")],pe.prototype,"clear",null),pe=e([i("esri.widgets.Search")],pe);var _e=pe;export default _e;
