/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../core/has.js";import"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import{property as a}from"../../core/accessorSupport/decorators/property.js";import{subclass as i}from"../../core/accessorSupport/decorators/subclass.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import s from"../../core/Accessor.js";import{init as l}from"../../core/watchUtils.js";import{HandleOwnerMixin as t}from"../../core/HandleOwner.js";import r from"../Slider/SliderViewModel.js";import n from"./ScaleRanges.js";let o=class extends(t(s)){constructor(e){super(e),this.layer=null,this.scaleRanges=n.fromScaleRange({minScale:0,maxScale:0}),this.sliderViewModel=(()=>{const{max:e}=this._getSliderIndexRange(this.scaleRanges.length-1);return new r({precision:10,min:0,max:e,values:[0,e]})})()}initialize(){this.handles.add([l(this,"sliderViewModel.values",(()=>{if(!this._hasTiledLayer())return;const[e,a]=this.sliderViewModel.values,i=this.mapScaleToSlider(this._getTiledLayerMaxScale()),s=this.mapScaleToSlider(this._getTiledLayerMinScale());(a>i||e<s)&&(this.sliderViewModel.values=[Math.max(e,s),Math.min(a,i)])})),l(this,"layer.loaded",(async()=>{const{layer:e,view:a}=this;if(e)if(a&&await a.when(),await e.when(),"minScale"in e&&"maxScale"in e){const{minScale:a,maxScale:i}=e;this.set({minScale:a,maxScale:i})}else this.set({minScale:void 0,maxScale:void 0})}))])}get maxScale(){const e=this.mapSliderToScale(this.sliderViewModel.values[1]);return this._handleEdgeScale("max",e)}set maxScale(e){this._setMaxScaleOnSlider(e)}get maxScaleLimit(){return this.mapSliderToScale(this.sliderViewModel.max)}set maxScaleLimit(e){this._setSliderRange({maxScale:e,minScale:this.minScaleLimit})}get minScale(){const e=this.mapSliderToScale(this.sliderViewModel.values[0]);return this._handleEdgeScale("min",e)}set minScale(e){this._setMinScaleOnSlider(e)}get minScaleLimit(){return this.mapSliderToScale(this.sliderViewModel.min)}set minScaleLimit(e){this._setSliderRange({maxScale:this.maxScaleLimit,minScale:e})}get state(){const{view:e,layer:a}=this;return!e&&!a||!e&&a&&a.loaded||!a&&e&&e.ready||e&&e.ready&&a&&a.loaded?"ready":"disabled"}set view(e){this._set("view",e)}mapScaleToSlider(e){const a=this.scaleRanges.scaleToRangeIndex(e),i=this.scaleRanges.findScaleRangeByIndex(a),{maxScale:s,minScale:l}=i,{max:t,min:r}=this._getSliderIndexRange(a);return this._mapToRange(e,l,s,r,t)}mapSliderToScale(e){const a=this.scaleRanges.findScaleRangeByIndex(e),{maxScale:i,minScale:s}=a,{max:l,min:t}=this._getSliderIndexRange(e);return this._mapToRange(e,t,l,s,i)}_setSliderRange(e){this.scaleRanges=n.fromScaleRange(e);const{max:a}=this._getSliderIndexRange(this.scaleRanges.length-1);this.sliderViewModel.max=a,this.sliderViewModel.min=0,this.notifyChange("maxScaleLimit"),this.notifyChange("minScaleLimit")}_getSliderIndexRange(e){const a=Math.floor(e);return{min:a,max:a+.99999}}_mapToRange(e,a,i,s,l){return s+(e-a)*(l-s)/(i-a)}_setMaxScaleOnSlider(e){const{scaleRanges:a,sliderViewModel:i}=this;if(void 0!==e){const s=this.mapScaleToSlider(this._constrainMaxScaleToLayer(a.clampMaxScale(e)));i.values=[i.values[0],s]}}_setMinScaleOnSlider(e){const{scaleRanges:a,sliderViewModel:i}=this;if(void 0!==e){const s=this.mapScaleToSlider(this._constrainMinScaleToLayer(a.clampMinScale(e)));i.values=[s,i.values[1]]}}_constrainMinScaleToLayer(e){const{scaleRanges:a}=this;if(this._hasTiledLayer()){const{firstRange:i}=a,s=this._getTiledLayerMinScale(),l=.85;e=this._mapToRange(e,i.maxScale,i.minScale,0,1)>l||e>s?s:e}return e}_constrainMaxScaleToLayer(e){if(this._hasTiledLayer()){const a=this._getTiledLayerMaxScale();e=e<a?a:e}return e}_handleEdgeScale(e,a){const i="max"===e?"maxScale":"minScale",s=this.scaleRanges[i]===a?0:a;return Number(s.toFixed(6))}_getLayerLODS(){return this.get("layer.tileInfo.lods")}_getTiledLayerMinScale(){const e=this._getLayerLODS();return this.scaleRanges.clampMinScale(e[0].scale)}_getTiledLayerMaxScale(){const e=this._getLayerLODS();return e[e.length-1].scale}_hasTiledLayer(){return!!this._getLayerLODS()}};e([a()],o.prototype,"layer",void 0),e([a({dependsOn:["sliderViewModel.values"]})],o.prototype,"maxScale",null),e([a({dependsOn:["sliderViewModel.max"]})],o.prototype,"maxScaleLimit",null),e([a({dependsOn:["sliderViewModel.values"]})],o.prototype,"minScale",null),e([a({dependsOn:["sliderViewModel.min"]})],o.prototype,"minScaleLimit",null),e([a()],o.prototype,"scaleRanges",void 0),e([a()],o.prototype,"sliderViewModel",void 0),e([a({dependsOn:["layer.loaded","view.ready"],readOnly:!0})],o.prototype,"state",null),e([a()],o.prototype,"view",null),o=e([i("esri.widgets.ScaleRangeSlider.ScaleRangeSliderViewModel")],o);var c=o;export default c;
