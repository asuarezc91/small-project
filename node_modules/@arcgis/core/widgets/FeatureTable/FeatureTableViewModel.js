/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../core/has.js";import"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import{property as t}from"../../core/accessorSupport/decorators/property.js";import{subclass as s}from"../../core/accessorSupport/decorators/subclass.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import i from"../../core/Collection.js";import{onLocaleChange as r}from"../../intl/locale.js";import{fetchMessageBundle as o}from"../../intl/messages.js";import"../../intl.js";import l from"../../Graphic.js";import a from"../../core/Handles.js";import{on as n,watch as d}from"../../core/watchUtils.js";import h from"../../layers/FeatureLayer.js";import{HandleOwnerMixin as m}from"../../core/HandleOwner.js";import{highlightsSupported as c}from"../../views/support/layerViewUtils.js";import g from"./AttachmentsColumn.js";import u from"./FieldColumn.js";import p from"./Grid/Grid.js";import f from"./Grid/GridViewModel.js";import y from"./support/FeatureStore.js";let C=class extends(m(f)){constructor(e){super(e),this._defaultHiddenFields=["CreationDate","Creator","EditDate","Editor","GlobalID"],this._highlights=new a,this.attachmentsEnabled=!1,this.cellClassNameGenerator=(e,t)=>e.path||null,this.dataProvider=async(e,t)=>{const{store:s}=this,{page:i,pageSize:r,sortOrders:o}=e,l=this._sortOrdersToLayerOrderByFields(o);t&&(s?(await s.set({orderByFields:l}),"loaded"!==s.state&&"loading"!==s.state&&await s.load(),t&&t(await s.fetchItems({page:i,pageSize:r}))):t&&t([]))},this.editingEnabled=!1,this.grid=null,this.hiddenFields=new i,this.highlightOnRowSelectEnabled=!0,this.itemIdPath="objectId",this.messagesCommon=null,this.relatedRecordsEnabled=!1,this.store=null,this.view=null;const{hiddenFields:t,itemIdPath:s}=this;t.addMany(this._defaultHiddenFields),this._set("store",new y),this._set("grid",new p({itemIdPath:s,viewModel:this}))}initialize(){const e=async()=>{this.messages=await o("esri/widgets/FeatureTable/t9n/FeatureTable"),this.messagesCommon=await o("esri/t9n/common")};e(),this.handles.add([r(e),n(this,"grid.selectedItems","change",(e=>this._onSelectionChange(e))),d(this,"relatedRecordsEnabled",(e=>this.store.relatedRecordsEnabled=e)),d(this,["layer.loaded"],(()=>{var e;if(null!=(e=this.layer)&&e.loaded){const e=this.layer.capabilities.query.maxRecordCount;e&&e<this.pageSize&&this.grid.set({pageSize:e}),this._generateColumns()}})),d(this,["editingEnabled","messages"],(()=>{var e;return(null==(e=this.layer)?void 0:e.loaded)&&this._generateColumns()})),d(this,"layer.definitionExpression",((e,t)=>(e||t)&&"loaded"===this.store.state&&this.refresh())),d(this,"attachmentsEnabled",((e,t)=>{(e||t)&&"loaded"===this.store.state&&(this.store.attachmentsEnabled=!0,this.refresh(),this._generateColumns())}))])}destroy(){this._resetColumns(),this.columns.destroy(),this.handles.removeAll(),this._highlights.removeAll(),this._highlights.destroy(),this.layer=null,this.view=null}set fieldConfigs(e){var t;this._set("fieldConfigs",e),(null==(t=this.layer)?void 0:t.loaded)&&this._generateColumns()}set layer(e){this._set("layer",e),this._resetColumns(),this.store.set({layer:e}),e&&e.load(),this.notifyChange("state")}set messages(e){var t;null==(t=this.grid)||t.set("messages",e),this._set("messages",e)}clearHighlights(){this._highlights.removeAll()}clearSelection(){var e;null==(e=this.grid)||e.clearSelection()}deselectRows(e){(e=e instanceof Array?e:[e]).forEach((e=>this._deselectRow(e)))}getObjectIdIndex(e){var t;return null==(t=this.store)?void 0:t.getObjectIdIndex(e)}getValue(e,t){var s;const i=this.store.getItemByObjectId(e);return null==i||null==(s=i.feature)?void 0:s.attributes[t]}refresh(){var e;null==(e=this.grid)||e.refresh()}selectRows(e){(e=e instanceof Array?e:[e]).forEach((e=>this._selectRow(e)))}_generateColumns(){this._resetColumns(),this.columns.addMany([...this._createFieldColumns()]),this.attachmentsEnabled&&this.columns.push(this._createAttachmentsColumn())}_createFieldColumns(){return this.fieldConfigs&&this.fieldConfigs.length?this._createColumnsFromConfigs():this._createColumnsFromFields()}_createColumnsFromConfigs(){const{editingEnabled:e,fieldConfigs:t,grid:s,hiddenFields:i,layer:r,messages:o,messagesCommon:l,store:a}=this,n=this.get("layer.fields")||[];return t.map((t=>{const d=t.direction||null,h=t.formatFunction||null,m=(n||[]).find((e=>t.name===e.name)),c=!1===t.visible||!0!==t.visible&&i.indexOf(m.name)>-1;return new u({config:t,direction:d,editingEnabled:e,field:m,formatFunction:h,grid:s,hidden:c,layer:r,store:a,messages:o,messagesCommon:l})}))}_createColumnsFromFields(){const{editingEnabled:e,grid:t,hiddenFields:s,layer:i,messages:r,messagesCommon:o,store:l}=this;return(this.get("layer.fields")||[]).map((a=>{const n=s.indexOf(a.name)>-1;return new u({editingEnabled:e,field:a,grid:t,hidden:n,layer:i,store:l,messages:r,messagesCommon:o})}))}_createAttachmentsColumn(){var e;return new g({header:null==(e=this.messages)?void 0:e.attachments})}_sortOrdersToLayerOrderByFields(e){return e&&e.length?e.filter(((e,t,s)=>s.map((e=>e.path)).indexOf(e.path)===t)).map((({direction:e,path:t})=>t+" "+e.toUpperCase())):[]}_highlight(e){const{view:t}=this,s=t&&e&&t.allLayerViews.items.find((({layer:t})=>t===e.layer));c(s)&&this._highlights.add(s.highlight(e),`feature-${e.getObjectId()}`)}_unhighlight(e){e&&this._highlights.remove(`feature-${e.getObjectId()}`)}_selectRow(e){const{grid:t}=this,s=e instanceof l?e:null,i=s?s.getObjectId():e,r=this.getObjectIdIndex(i);-1===r?null==t||t.selectItem({objectId:i,feature:s}):null==t||t.selectRow(r)}_deselectRow(e){const{grid:t}=this,s=e instanceof l?e.getObjectId():e,i=this.getObjectIdIndex(s);-1===i?null==t||t.deselectItem({objectId:s}):null==t||t.deselectRow(i)}_onSelectionChange(e){const{highlightOnRowSelectEnabled:t}=this,{added:s,removed:i}=e;t&&s.forEach((e=>this._highlight(e.feature))),t&&i.forEach((e=>this._unhighlight(e.feature)))}_resetColumns(){this.columns.items.forEach((e=>e.destroy())),this.columns.removeAll()}};e([t()],C.prototype,"attachmentsEnabled",void 0),e([t()],C.prototype,"cellClassNameGenerator",void 0),e([t()],C.prototype,"dataProvider",void 0),e([t()],C.prototype,"editingEnabled",void 0),e([t({dependsOn:["messages","layer.loaded"]})],C.prototype,"fieldConfigs",null),e([t({readOnly:!0})],C.prototype,"grid",void 0),e([t()],C.prototype,"hiddenFields",void 0),e([t()],C.prototype,"highlightOnRowSelectEnabled",void 0),e([t({readOnly:!0})],C.prototype,"itemIdPath",void 0),e([t({type:h})],C.prototype,"layer",null),e([t()],C.prototype,"messages",null),e([t()],C.prototype,"messagesCommon",void 0),e([t()],C.prototype,"relatedRecordsEnabled",void 0),e([t({readOnly:!0,type:y})],C.prototype,"store",void 0),e([t()],C.prototype,"view",void 0),C=e([s("esri.widgets.FeatureTable.FeatureTableViewModel")],C);var v=C;export default v;
