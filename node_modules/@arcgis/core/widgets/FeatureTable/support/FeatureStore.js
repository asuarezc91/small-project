/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import{clone as t}from"../../../core/lang.js";import r from"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as s}from"../../../core/accessorSupport/decorators/property.js";import{subclass as i}from"../../../core/accessorSupport/decorators/subclass.js";import a from"../../../core/Error.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import{equals as o,remove as n}from"../../../core/arrayUtils.js";import{resolve as u,reject as h}from"../../../core/promiseUtils.js";import d from"../../../core/Accessor.js";import l from"../../../core/Collection.js";import c from"../../../Graphic.js";import y from"../../../tasks/support/AttachmentQuery.js";import p from"../../../tasks/support/Query.js";const _="esri.widgets.FeatureTable.support.FeatureStore",m=r.getLogger(_);function g(e,t,r){m.error(new a(e,t,r))}let f=class extends d{constructor(e){super(e),this._loaded=!1,this._loadError=!1,this._loading=!1,this._editOperationQueue=[],this._queryOperationQueue=[],this._objectIds=new l,this._hasStaleCache=!1,this.attachmentsEnabled=!1,this.count=0,this.failures=new l,this.itemCache=new l,this.relatedRecordsEnabled=!1}destroy(){this.layer=null,this.itemCache&&this.itemCache.destroy(),this.failures&&this.failures.destroy(),this._set("itemCache",null)}get layer(){return this._get("layer")||null}set layer(e){this._reset(),this._set("layer",e),this.notifyChange("state")}get orderByFields(){return this._get("orderByFields")||[]}set orderByFields(e){const t=this.orderByFields;o(e,t)||(this.itemCache.removeAll(),this._hasStaleCache=!0,this._set("orderByFields",e))}get querying(){return this._queryOperationQueue.length>0}get state(){const{layer:e,_loaded:t,_loadError:r,_loading:s}=this;return r?"error":!e||this.get("layer.loadError")?"disabled":s?"loading":"loaded"===this.get("layer.loadStatus")&&t?"loaded":"ready"}get syncing(){return this._editOperationQueue.length>0}get where(){return this._get("where")||null}set where(e){this._reset(),this._set("where",e),this.notifyChange("state")}async load(){this._reset();const{layer:e}=this;if(!e)return u();this._loading=!0,this.notifyChange("state");try{await e.when(),await this._syncLayerInfo(),this._loading=!1,this._loaded=!0,this.notifyChange("state")}catch(e){throw this._reset(),this._loadError=!0,this.notifyChange("state"),g("store:load-error","An error ocurred.",{error:e}),e}}async addItems(e){}async fetchItems(e){const{page:t,pageSize:r}=e,s=t*r,i=s+r,{layer:a,state:o}=this;if(!a||"loaded"!==o)return u([]);this.notifyChange("querying");const n=await this._query({start:s,num:i,page:t,pageSize:r});return this.notifyChange("state"),n}async query(e){const{layer:t,state:r}=this;if(!t||"loaded"!==r)return[];this.notifyChange("querying");const s=await this._query(e);return this.notifyChange("state"),s}async removeItemAt(e){}async reset(){this._reset()}async updateItem(e){return this._update(e)}getItemByObjectId(e){const{itemCache:t,layer:{objectIdField:r}}=this;return t.find((t=>t.feature.attributes[r]===e))}getLocalItemAt(e){return this.itemCache.getItemAt(e)}getItemAt(e){return u(this.itemCache.getItemAt(e))}getObjectIdIndex(e){const{itemCache:t,layer:{objectIdField:r}}=this;return t.findIndex((t=>t.feature.attributes[r]===e))}_reset(){this.itemCache.removeAll(),this.failures.removeAll(),this._editOperationQueue=[],this._queryOperationQueue=[],this._hasStaleCache=!1,this._loading=!1,this._loaded=!1,this._loadError=!1,this._set("count",0),this._objectIds.removeAll(),this.notifyChange("querying"),this.notifyChange("syncing"),this.notifyChange("state")}_getIdsFromFeatures(e){return e.map((e=>e.attributes[this.layer.objectIdField]))}_toFeatureData(e,t){const{layer:{objectIdField:r}}=this;return e.map((e=>{const{attributes:s}=e,i=s[r];return{objectId:i,feature:e,attachments:t?t[i]:null,relatedRecords:null}}))}async _update(e){const{layer:r}=this,{operations:s}=r.capabilities;if(!s.supportsUpdate)throw new a("store:update-error","Update is not supported.");const{index:i,name:o,value:n}=e,u=await this.getItemAt(i);if(!u||!u.feature)throw new a("store:update-error","Feature with provided 'objectId' not found.");const{feature:h}=u,d=t(h.attributes);d[o]=n;const l=new c({attributes:d}),y=r.applyEdits({updateFeatures:[l]}).then((e=>{const{updateFeatureResults:t}=e,r=t.find((e=>!!e.error));if(r)throw r.error;return this._editOperationQueue.indexOf((()=>y))>-1&&t&&t.length&&(h.attributes=d),e}));return this._queueEditOperation((()=>y))}async _query(e){const{refresh:t}=e;return!0===t?(this.itemCache.removeAll(),this._syncLayerInfo().then((()=>this._queryFeatureData(e)))):(this._hasStaleCache&&(await this._updateIds(),this._hasStaleCache=!1),this._queryFeatureData(e))}async _queryFeatureData(e){return this._queueQueryOperation((async()=>{const{features:t}=await this._queryFeatures(e),r=this._getIdsFromFeatures(t),s=await this._queryAttachments(r);return this._toFeatureData(t,s)||[]}))}async _syncLayerInfo(){await this._updateCount(),await this._updateIds()}async _updateCount(){await this._queryCount().then((e=>this._set("count",e)))}async _updateIds(){var e,t,r;null!=(e=this.layer)&&null!=(t=e.capabilities)&&null!=(r=t.query)&&r.supportsPagination||(this._objectIds.removeAll(),await this._queryObjectIds().then((e=>this._objectIds.addMany(e))))}_queryCount(){const{layer:e}=this;return e.queryFeatureCount(new p({returnGeometry:!1,where:this._getWhere()}))}_queryObjectIds(){const{layer:e,orderByFields:t}=this,{capabilities:{query:{supportsCacheHint:r,supportsOrderBy:s}}}=e,i=new p({outFields:[e.objectIdField],returnGeometry:!1,where:this._getWhere()});return s&&(i.orderByFields=t),r&&(i.cacheHint=!0),e.queryObjectIds(i)}async _queryFeatures(e){const{layer:t}=this;if(!t.capabilities.operations.supportsQuery)return h(new a("store:query-error","Layer does not support query operation."));const{layer:{capabilities:{query:{supportsCacheHint:r,supportsOrderBy:s,supportsPagination:i}}},orderByFields:o}=this,{start:n,num:u}=e,d=new p({returnGeometry:!1,outFields:["*"]});return i?(d.start=n,d.num=u,d.where=this._getWhere()):d.objectIds=this._getObjectIdsForPage(n,u),s&&(d.orderByFields=o),r&&(d.cacheHint=!0),t.queryFeatures(d)}_getObjectIdsForPage(e,t){const r=this._objectIds.toArray();return r.length>=e+t?r.slice(e,e+t):r.slice(e)}_queryAttachments(e){const{attachmentsEnabled:t,layer:r}=this,{capabilities:{data:{supportsAttachment:s},operations:{supportsQueryAttachments:i}}}=r;return t&&s&&i?r.queryAttachments(new y({objectIds:e,where:this._getWhere()})):u(null)}_queueQueryOperation(e){return this._queryOperationQueue.push(e),this.notifyChange("querying"),e().then((t=>this._queryOperationQueue.indexOf(e)>-1?(this.itemCache.addMany(t),t):[])).catch((t=>{g("store:query-error","An error ocurred.",{error:t});const r={error:t,retry:()=>{this.failures.remove(r),this._queueQueryOperation(e)},cancel:()=>this.failures.remove(r)};return this.failures.add(r),[]})).then((t=>(n(this._queryOperationQueue,e),this.notifyChange("querying"),t)))}_queueEditOperation(e){return this._editOperationQueue.push(e),this.notifyChange("syncing"),e().then((()=>{n(this._editOperationQueue,e),this.notifyChange("syncing")})).catch((t=>{g("store:edit-error","An error ocurred.",{error:t});const r={error:t,retry:()=>{this.failures.remove(r),this._queueEditOperation(e)},cancel:()=>this.failures.remove(r)};throw this.failures.add(r),n(this._editOperationQueue,e),this.notifyChange("syncing"),t}))}_getWhere(){return this.where||this.layer.definitionExpression||"1=1"}};e([s()],f.prototype,"attachmentsEnabled",void 0),e([s({readOnly:!0})],f.prototype,"count",void 0),e([s({readOnly:!0})],f.prototype,"failures",void 0),e([s({readOnly:!0})],f.prototype,"itemCache",void 0),e([s()],f.prototype,"layer",null),e([s()],f.prototype,"orderByFields",null),e([s({readOnly:!0})],f.prototype,"querying",null),e([s()],f.prototype,"relatedRecordsEnabled",void 0),e([s({readOnly:!0,dependsOn:["layer","layer.loadError","layer.loadStatus"]})],f.prototype,"state",null),e([s({readOnly:!0})],f.prototype,"syncing",null),e([s()],f.prototype,"where",null),f=e([i(_)],f);var q=f;export default q;
