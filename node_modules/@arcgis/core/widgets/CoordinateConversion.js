/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../core/global.js";import"../core/has.js";import i from"../core/Logger.js";import"../core/accessorSupport/ensureType.js";import{property as o}from"../core/accessorSupport/decorators/property.js";import{aliasOf as s}from"../core/accessorSupport/decorators/aliasOf.js";import{subclass as n}from"../core/accessorSupport/decorators/subclass.js";import"../core/urlUtils.js";import"../core/uuid.js";import"../portal/support/resourceExtension.js";import{eventKey as r}from"../core/events.js";import{storeNode as a,isRTL as l}from"./support/widgetUtils.js";import{accessibleHandler as d}from"./support/decorators/accessibleHandler.js";import{messageBundle as c}from"./support/decorators/messageBundle.js";import{renderable as p}from"./support/decorators/renderable.js";import{j as h}from"../chunks/index.js";import u from"./Widget.js";import _ from"./CoordinateConversion/support/Conversion.js";import v from"./CoordinateConversion/CoordinateConversionViewModel.js";const m="esri-coordinate-conversion esri-widget",g="esri-coordinate-conversion--capture-mode",b="esri-coordinate-conversion--no-basemap",y="esri-coordinate-conversion__popup",C="esri-coordinate-conversion__conversion-list",w="esri-coordinate-conversion__row",f="esri-coordinate-conversion__display",x="esri-coordinate-conversion__conversions-view--expanded",k="esri-coordinate-conversion__conversions-view--expand-down",I="esri-coordinate-conversion__conversions-view--expand-up",M="esri-coordinate-conversion__conversions-view",V="esri-coordinate-conversion__select-primary",P="esri-coordinate-conversion__select-row",T="esri-coordinate-conversion__tools",F="esri-coordinate-conversion__mode-toggle",S="esri-coordinate-conversion__row-button",j="esri-coordinate-conversion__back-button",$="esri-coordinate-conversion__button",D="esri-coordinate-conversion__input-coordinate",O="esri-coordinate-conversion__input-form",E="esri-coordinate-conversion__input-group",L="esri-coordinate-conversion__input-coordinate--rejected",B="esri-coordinate-conversion__heading",A="esri-coordinate-conversion__pattern-input",R="esri-coordinate__settings",U="esri-coordinate-conversion__settings-group",q="esri-coordinate-conversion__settings-group-horizontal",G="esri-coordinate-conversion__preview-coordinate",z="esri-disabled",H="esri-input",N="esri-button",W="esri-widget__heading",J="esri-widget--button",K="esri-icon-left-arrow",Q="esri-icon-right-arrow",X="esri-icon-map-pin",Y="esri-icon-up",Z="esri-icon-duplicate",ee="esri-icon-edit",te="esri-select",ie="esri-icon-down",oe="esri-icon-refresh",se="esri-icon-close",ne="esri-icon-settings2",re=i.getLogger("esri.widgets.CoordinateConversion");let ae=class extends u{constructor(e,t){super(e,t),this._popupMessage=null,this._popupId=null,this._coordinateInput=null,this._badInput=!1,this._goToEnabled=!1,this._conversionFormat=null,this._settingsFormat=null,this._previewConversion=null,this._expanded=!1,this._popupVisible=!1,this._settingsVisible=!1,this._inputVisible=!1,this.conversions=null,this.currentLocation=null,this.formats=null,this.goToOverride=null,this.label=void 0,this.messages=null,this.messagesCommon=null,this.mode=null,this.orientation="auto",this.requestDelay=null,this.view=null,this.viewModel=new v}set multipleConversions(e){!1===e&&(this._expanded=!1,this.conversions.splice(1,this.conversions.length-1)),this._set("multipleConversions",e)}get multipleConversions(){const e=this._get("multipleConversions");return"boolean"!=typeof e||e}reverseConvert(e,t){return this.viewModel.reverseConvert(e,t)}render(){const e=this.get("viewModel.state"),t="disabled"===e?h("div",{key:"esri-coordinate__no-basemap"},this.messages.noBasemap):null,i=!t&&this._inputVisible?this._renderInputForm():null,o=!t&&this._settingsVisible?this._renderSettings():null,s=t||i||o?null:this._renderConversionsView(),n=this._popupVisible?this._renderPopup():null,r={[g]:"capture"===this.mode,[z]:"loading"===e,[b]:"disabled"===e};return h("div",{class:this.classes(m,r)},n,t,s,o,i)}_addConversion(e){const t=e.target,i=t.options[t.options.selectedIndex]["data-format"],o=t["data-index"],s=new _({format:i});t.options.selectedIndex=0,o>=0&&this.conversions.removeAt(o),this.conversions.add(s,o)}_findSettingsFormat(){return this._settingsFormat||this.conversions.reduceRight(((e,t)=>{const i=t.format;return i.get("hasDisplayProperties")?i:e}),null)||this.formats.find((e=>e.hasDisplayProperties))}_hidePopup(){this._popupId&&(clearTimeout(this._popupId),this._popupId=null),this._popupVisible=!1,this._popupMessage=null,this.scheduleRender()}_onConvertComplete(){this._inputVisible=!1,this._coordinateInput.value=""}_onCopy(e){const i=e.currentTarget["data-conversion"].displayCoordinate;"clipboardData"in t?t.clipboardData.setData("text",i):e.clipboardData.setData("text/plain",i),this._showPopup(this.messages.copySuccessMessage),e.preventDefault()}_processUserInput(e){const t=r(e),i=this.viewModel;if("Enter"!==t&&t)this._badInput&&(this._badInput=!1);else{const e=this._coordinateInput["data-format"],t=this._coordinateInput.value;this._reverseConvert(t,e).then((e=>{"capture"===this.mode?i.resume():this.mode="capture",this.currentLocation=e,i.setLocation(e),this._onConvertComplete()})).catch((e=>{re.error(e),this._showPopup(this.messages.invalidCoordinate),this._badInput=!0}))}}_reverseConvert(e,t){const i=this.viewModel;return t.reverseConvert(e).then((e=>(this._goToEnabled&&i.goToLocation(e).catch((e=>{re.warn(e),this._showPopup(this.messages.locationOffBasemap)})),e)))}_setInputFormat(e){const t=e.target,i=t[t.options.selectedIndex]["data-format"];this._conversionFormat=i}_setPreviewConversion(){const e=this._findSettingsFormat(),t=this.viewModel;if(e){const i=this.conversions.find((t=>t.format===e));this._previewConversion=new _({format:e,position:{location:this.currentLocation,coordinate:i&&i.position.coordinate}}),this._previewConversion.position.coordinate||t.previewConversion(this._previewConversion)}}_setSettingsFormat(e){const t=e.target,i=t[t.options.selectedIndex]["data-format"];this._settingsFormat=i,this._setPreviewConversion()}_showPopup(e,t=2500){this._popupMessage=e,this._popupVisible?clearTimeout(this._popupId):this._popupVisible=!0,this.scheduleRender(),this._popupId=setTimeout((()=>{this._popupId=null,this._hidePopup()}),t)}_toggleGoTo(){this._goToEnabled=!this._goToEnabled}_updateCurrentPattern(e){e.stopPropagation();const t=e.target,i=this._findSettingsFormat();i&&(i.currentPattern=t.value)}_renderConversion(e,t){const{messages:i}=this,o=`${this.id}__list-item-${t}`,s=`${e.format.name} ${i.conversionOutputSuffix}`,n=0===t,r=n||this._expanded,a=n?this._renderFirstConversion(e):this._renderTools(t,e,o),l=n&&!e.displayCoordinate?i.noLocation:e.displayCoordinate,d=h("div",{"aria-label":l,class:f,"data-conversion":e,role:"listitem",tabindex:"0",title:l},l),c=this._renderOptions(this.formats.filter((t=>t!==e.format)));return r?h("li",{"aria-label":s,class:w,id:o,key:e,role:"group",title:s,tabindex:"0"},h("select",{"aria-controls":o,"aria-label":i.selectFormat,class:this.classes(te,P),bind:this,"data-index":t,onchange:this._addConversion,title:i.selectFormat},h("option",{"aria-label":e.format.name,selected:!0,title:e.format.name},e.format.name.toUpperCase()),c),d,a):null}_renderCopyButton(e){return h("li",{"aria-label":this.messagesCommon.copy,bind:this,class:this.classes(J,S),"data-conversion":e,onclick:this._copyCoordinateOutput,onkeydown:this._copyCoordinateOutput,oncopy:this._onCopy,role:"button",tabindex:"0",title:this.messagesCommon.copy},h("span",{"aria-hidden":"true",class:Z}))}_renderFirstConversion(e){const t=this.id,i={[ie]:!this._expanded,[Y]:this._expanded},{messages:o,messagesCommon:s}=this,n="live"===this.mode?o.captureMode:o.liveMode,r=this._expanded?s.collapse:s.expand,a=e.displayCoordinate&&"capture"===this.mode?this._renderCopyButton(e):null,l=this.multipleConversions?h("li",{"aria-controls":`${t}__${C}`,"aria-label":r,bind:this,class:J,key:"esri-coordinate-conversion__expand-button",onclick:this._toggleExpand,onkeydown:this._toggleExpand,role:"button",tabindex:"0",title:r},h("span",{"aria-hidden":"true",class:this.classes(i)})):h("li",{"aria-label":n,bind:this,class:this.classes(J,F),key:"esri-coordinate-conversion__mode-toggle",onclick:this._toggleMode,onkeydown:this._toggleMode,role:"button",tabindex:"0",title:n},h("span",{"aria-hidden":"true",class:X}));return h("ul",{class:T},a,l)}_renderInputForm(){const e=this._conversionFormat||this.conversions.getItemAt(0).format,t=this.formats.findIndex((t=>t.name===e.name)),i=this.id,o=`${i}__${D}`,s=`${i}__${D}__header`,n=this._renderOptions(this.formats,!0,t),r={[L]:this._badInput},{messages:l,messagesCommon:d}=this;return h("div",{"aria-labelledby":s,class:O,key:"esri-coordinate-conversion__input-form",role:"search"},h("div",{class:B},h("div",{"aria-label":d.back,bind:this,class:this.classes(J,j),onclick:this._toggleInputVisibility,onkeydown:this._toggleInputVisibility,role:"button",tabindex:"0",title:d.back},this._renderBackIcon()),h("h4",{class:W,id:s},l.inputCoordTitle)),h("div",{class:E},h("select",{"aria-controls":o,"aria-label":l.selectFormat,bind:this,class:this.classes(te,P),onchange:this._setInputFormat,title:l.selectFormat},n),h("input",{afterCreate:a,"aria-labelledby":s,"aria-required":"true",bind:this,class:this.classes(D,H,r),"data-format":e,"data-node-ref":"_coordinateInput",id:o,onkeydown:this._processUserInput,placeholder:l.inputCoordTitle,role:"textbox",spellcheck:!1,title:l.inputCoordTitle,type:"text"})),h("div",{class:E},h("label",{"aria-label":l.goTo},h("input",{bind:this,checked:this._goToEnabled,onclick:this._toggleGoTo,title:l.goTo,type:"checkbox"}),l.goTo),h("button",{"aria-label":l.convert,bind:this,class:this.classes($,N),onclick:this._processUserInput,title:l.convert,type:"button"},l.convert)))}_renderConversionsView(){const e=`${this.id}__${C}`,t=this._renderPrimaryTools(),i=this._renderOptions(this.formats),o=this.conversions.map(((e,t)=>this._renderConversion(e,t))).toArray(),{messages:s}=this,n=this._expanded?h("div",{class:w},h("select",{"aria-controls":e,"aria-label":s.addConversion,bind:this,class:this.classes(te,V),onchange:this._addConversion,title:s.addConversion},h("option",{disabled:!0,selected:!0,value:""},s.addConversion),i),t):null,r={[x]:this._expanded,[I]:"expand-up"===this.orientation,[k]:"expand-down"===this.orientation};return h("div",{class:this.classes(M,r),key:"esri-coordinate-conversion__main-view"},h("ul",{"aria-expanded":this._expanded?"true":"false",class:C,id:e},o),n)}_renderOptions(e,t,i){const o=this.conversions.getItemAt(0);return e.map(((e,s)=>{const n=!(t||!o)&&(o.format.name===e.name||this.conversions.map((e=>e.format.name)).includes(e.name));return h("option",{"aria-label":e.name,"data-format":e,disabled:n,key:e.name,selected:s===i,value:e.name},e.name.toUpperCase())})).toArray()}_renderPopup(){return h("div",{class:y,role:"alert"},this._popupMessage)}_renderPrimaryTools(){const{messages:e}=this,t="live"===this.mode?e.captureMode:e.liveMode;return h("ul",{class:T},h("li",{bind:this,class:J,onclick:this._toggleInputVisibility,onkeydown:this._toggleInputVisibility,role:"button",tabindex:"0",title:e.inputCoordTitle},h("span",{"aria-hidden":"true",class:ee})),h("li",{bind:this,class:this.classes(J,F),onclick:this._toggleMode,onkeydown:this._toggleMode,role:"button",tabindex:"0",title:t},h("span",{"aria-hidden":"true",class:X})),h("li",{bind:this,class:J,onclick:this._toggleSettingsVisibility,onkeydown:this._toggleSettingsVisibility,role:"button",tabindex:"0",title:e.settingsTitle},h("span",{"aria-hidden":"true",class:ne})))}_renderSettings(){const e=this.id,t=`${e}__${A}`,i=`${e}__${A}__header`,o=`${e}__${G}`,s=this.formats.filter((e=>e.hasDisplayProperties)),n=this._findSettingsFormat(),r=s.indexOf(n),a=this._renderOptions(s,!0,r),l=n.get("currentPattern"),{messages:d,messagesCommon:c}=this;return h("div",{"aria-labelledby":i,class:R,key:"esri-coordinate-conversion__settings"},h("div",{class:B},h("div",{bind:this,class:this.classes(J,j),onclick:this._toggleSettingsVisibility,onkeydown:this._toggleSettingsVisibility,role:"button",tabindex:"0",title:c.back},this._renderBackIcon()),h("h4",{class:W,id:i},d.settingsTitle)),h("div",{class:U},h("label",{for:t},d.changeCoordinateDisplay),h("select",{"aria-label":d.selectFormat,class:te,bind:this,onchange:this._setSettingsFormat,title:d.selectFormat},a),h("div",{class:q},h("input",{"aria-controls":o,bind:this,class:this.classes(A,H),id:t,oninput:this._updateCurrentPattern,spellcheck:!1,title:d.changeCoordinateDisplay,type:"text",value:l}),h("div",{"aria-controls":t,bind:this,class:J,onclick:this._setDefaultPattern,onkeydown:this._setDefaultPattern,role:"button",tabindex:"0",title:d.defaultPattern},h("span",{"aria-hidden":"true",class:oe})))),h("div",{class:U},h("label",null,c.preview,h("div",{class:G,id:o,tabindex:"0"},this._previewConversion.displayCoordinate))))}_renderBackIcon(){return h("span",{"aria-hidden":"true",class:l()?Q:K})}_renderTools(e,t,i){const o=t.displayCoordinate&&"capture"===this.mode?this._renderCopyButton(t):null,{messages:s}=this;return h("ul",{class:T,role:"listitem"},o,h("li",{"aria-controls":i,"aria-label":s.removeConversion,bind:this,class:this.classes(J,S),"data-index":e,key:`${i}__${J}`,onclick:this._removeConversion,onkeydown:this._removeConversion,tabindex:"0",role:"button",title:s.removeConversion},h("span",{"aria-hidden":"true",class:se})))}_copyCoordinateOutput(e){const t=e.target;if(!("createTextRange"in document.body)){const e=window.getSelection(),i=document.createRange();i.selectNodeContents(t),e.removeAllRanges(),e.addRange(i)}document.execCommand("copy")}_removeConversion(e){const t=e.currentTarget["data-index"];this.conversions.removeAt(t)}_setDefaultPattern(e){e.stopPropagation();const t=this._findSettingsFormat();t&&(t.currentPattern=t.get("defaultPattern"))}_toggleExpand(){this._expanded=!this._expanded}_toggleInputVisibility(){this._inputVisible=!this._inputVisible,this._popupVisible&&this._hidePopup(),this._inputVisible?this.viewModel.pause():this.viewModel.resume()}_toggleMode(){this.mode="live"===this.mode?"capture":"live"}_toggleSettingsVisibility(){this._settingsVisible=!this._settingsVisible,this._popupVisible&&this._hidePopup(),this._settingsVisible?(this._setPreviewConversion(),this.viewModel.pause()):this.viewModel.resume()}};e([s("viewModel.conversions")],ae.prototype,"conversions",void 0),e([s("viewModel.currentLocation"),p()],ae.prototype,"currentLocation",void 0),e([s("viewModel.formats"),p()],ae.prototype,"formats",void 0),e([s("viewModel.goToOverride")],ae.prototype,"goToOverride",void 0),e([o({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],ae.prototype,"label",void 0),e([o(),p(),c("esri/widgets/CoordinateConversion/t9n/CoordinateConversion")],ae.prototype,"messages",void 0),e([o(),p(),c("esri/t9n/common")],ae.prototype,"messagesCommon",void 0),e([s("viewModel.mode"),p()],ae.prototype,"mode",void 0),e([o(),p()],ae.prototype,"orientation",void 0),e([s("viewModel.requestDelay")],ae.prototype,"requestDelay",void 0),e([o(),p()],ae.prototype,"multipleConversions",null),e([s("viewModel.locationSymbol")],ae.prototype,"locationSymbol",void 0),e([s("viewModel.view"),p()],ae.prototype,"view",void 0),e([o({type:v}),p(["viewModel.state","viewModel.waitingForConversions"])],ae.prototype,"viewModel",void 0),e([d()],ae.prototype,"_copyCoordinateOutput",null),e([d()],ae.prototype,"_removeConversion",null),e([d()],ae.prototype,"_setDefaultPattern",null),e([d()],ae.prototype,"_toggleExpand",null),e([d()],ae.prototype,"_toggleInputVisibility",null),e([d()],ae.prototype,"_toggleMode",null),e([d()],ae.prototype,"_toggleSettingsVisibility",null),ae=e([n("esri.widgets.CoordinateConversion")],ae);var le=ae;export default le;
