/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../core/has.js";import t from"../../core/Logger.js";import{property as r}from"../../core/accessorSupport/decorators/property.js";import{cast as i}from"../../core/accessorSupport/decorators/cast.js";import{subclass as s}from"../../core/accessorSupport/decorators/subclass.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import{ReentrantObjectPool as o}from"../../core/ReentrantObjectPool.js";import l from"../../core/Evented.js";import{loadArcade as n}from"../../support/arcadeOnDemand.js";import{onLocaleChange as a}from"../../intl/locale.js";import{fetchMessageBundle as d}from"../../intl/messages.js";import"../../intl.js";import p from"../../Graphic.js";import{init as u}from"../../core/watchUtils.js";import f from"../../form/FormTemplate.js";import{HandleOwnerMixin as c}from"../../core/HandleOwner.js";import m from"./FieldConfig.js";import h from"./FieldGroupConfig.js";import g from"./InputField.js";import y from"./InputFieldGroup.js";import{fieldConfigsFromFormTemplate as _}from"./support/formTemplateUtils.js";function v(e){return!!e.inputFields}function F(e){return!!e.fieldConfig}const C=new p({attributes:{}}),O="esri.widgets.FeatureForm.FeatureFormViewModel",j=t.getLogger(O);let b=class extends(c(l.EventedAccessor)){constructor(e){super(e),this._arcade=null,this._fieldPool=new o(g),this._fieldGroupPool=new o(y),this._featureClone=C.clone(),this._needsArcade=!1,this.messages=null,this.strict=!1}initialize(){const e=async()=>this.messages=await d("esri/widgets/FeatureForm/t9n/FeatureForm");e(),this.handles.add(a(e));const t=u(this,"fieldConfig",(async e=>{const r=[];e&&e.forEach((e=>{r.push(e.visibilityExpression),F(e)?e.fieldConfig.forEach((({requiredExpression:e,visibilityExpression:t})=>{r.push(e,t)})):r.push(e.requiredExpression)}));const i=r.filter((e=>!!e)),s=i.length>0;if(s){const e=await n(),{arcadeUtils:r}=e;i.some((e=>r.hasGeometryOperations(e)))&&(await r.enableGeometryOperations(),t.remove()),this._arcade=e,this.notifyChange("inputFields")}this._needsArcade=s}));this.handles.add(t)}destroy(){this.fieldConfig=null,this.feature=null,this.layer=null,this._fieldPool.destroy(),this._fieldGroupPool.destroy()}get _allInputFields(){return this.inputFields.reduce(((e,t)=>v(t)?[...e,...t.inputFields]:[...e,t]),[])}get _inputFieldCache(){const e=this._get("_inputFieldCache")||new Map;e.forEach((e=>this._disposeInputOrGroup(e))),e.clear();return(this.get("layer.fields")||[]).forEach((t=>e.set(t,this._fieldPool.acquire()))),e}get _inputFieldGroupCache(){const e=this._get("_inputFieldGroupCache")||new Map;e.forEach((e=>this._disposeInputOrGroup(e))),e.clear();return(this.fieldConfig||[]).filter(F).forEach((t=>e.set(t,this._fieldGroupPool.acquire()))),e}get description(){var e;return null==(e=this.formTemplate)?void 0:e.description}set description(e){void 0===e?this._clearOverride("description"):this._override("description",e)}get feature(){return this._get("feature")}set feature(e){this._featureClone=e?e.clone():C.clone(),this._set("feature",e)}get fieldConfig(){const{formTemplate:e}=this;if(!e)return null;const{config:t,encounteredUnsupportedTypes:r}=_(e);return r.length>0&&j.warn("form-info::unsupported-type","encountered unsupported elements/types when parsing form info",r),t}set fieldConfig(e){e?this._override("fieldConfig",e):this._clearOverride("fieldConfig")}castFieldConfig(e){return e?e.map((e=>e instanceof m||e instanceof h?e:F(e)?new h(e):new m(e))):null}get formTemplate(){var e;return null==(e=this.layer)?void 0:e.formTemplate}set formTemplate(e){void 0===e?this._clearOverride("formTemplate"):this._override("formTemplate",e)}get inputFields(){const{_arcade:e,_inputFieldCache:t,_inputFieldGroupCache:r,_featureClone:i,messages:s,_needsArcade:o,layer:l,state:n}=this,a=i.clone();if("ready"!==n||o&&!e)return[];const d=this.get("layer.fields")||[],p=this.fieldConfig||[];let u;return u=0!==p.length?p.map((i=>{if(F(i)){const o=r.get(i),n=i.fieldConfig.map((r=>{const i=d.find((e=>e.name===r.name)),n=t.get(i);return n.set({arcade:e,field:i,config:r,feature:a,group:o,layer:l,messages:s,value:this.getValue(i.name)}),n})).filter((e=>e.visible));return o.set({arcade:e,config:i,feature:a,inputFields:n}),o}const o=d.find((e=>e.name===i.name)),n=t.get(o);return n.set({arcade:e,field:o,config:i,feature:a,group:null,layer:l,messages:s,value:this.getValue(o.name)}),n})):d.map((r=>{const i=t.get(r);return i.set({arcade:e,config:null,field:r,feature:a,group:null,layer:l,messages:s,value:this.getValue(r.name)}),i})),u.filter((e=>e.visible))}get layer(){return this.get("feature.layer")}set layer(e){e?this._override("layer",e):this._clearOverride("layer")}get state(){return this.messages&&this.get("layer.loaded")?"ready":"disabled"}get title(){var e;return null==(e=this.formTemplate)?void 0:e.title}set title(e){void 0===e?this._clearOverride("title"):this._override("title",e)}get valid(){const e=this._allInputFields;return e.length>0&&e.every((({valid:e})=>e))}findField(e){return this._allInputFields.find((t=>t.name===e))}getValue(e){const{_featureClone:t}=this;return t.attributes?t.get(`attributes.${e}`):void 0}setValue(e,t){const{_featureClone:r,strict:i}=this;if(!r.attributes)return;const s=this.findField(e);if(t=""===t?null:t,!s||r.attributes[e]===t)return;s.value=t;if(this.get("layer.typeIdField")===s.name){const e=new Set;this.layer.types.forEach((t=>Object.keys(t.domains).forEach((t=>e.add(t))))),e.forEach((e=>{const t=this.findField(e);t&&t.notifyChange("domain")}))}i&&!s.valid||(r.attributes[e]=t,this.notifyChange("inputFields"),this._emitChangeEvent(s))}getValues(){return{...this._featureClone.attributes}}submit(){const e=this._allInputFields,t=e.filter((e=>e.valid)).map((({name:e})=>e)),r=e.filter((e=>!e.valid)).map((({name:e})=>e)),i=this.getValues();this.emit("submit",{valid:t,invalid:r,values:i})}_disposeInputOrGroup(e){v(e)?this._disposeGroup(e):this._disposeInput(e)}_disposeGroup(e){e.inputFields.forEach((e=>this._disposeInput(e))),this._fieldGroupPool.release(e)}_disposeInput(e){this._fieldPool.release(e)}_emitChangeEvent({name:e,valid:t,value:r}){this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:e,value:r,valid:t})}};e([r({readOnly:!0,dependsOn:["inputFields"]})],b.prototype,"_allInputFields",null),e([r({dependsOn:["layer.fields"],readOnly:!0})],b.prototype,"_inputFieldCache",null),e([r({dependsOn:["fieldConfig"],readOnly:!0})],b.prototype,"_inputFieldGroupCache",null),e([r({dependsOn:["formTemplate"]})],b.prototype,"description",null),e([r()],b.prototype,"feature",null),e([r({dependsOn:["formTemplate"]})],b.prototype,"fieldConfig",null),e([i("fieldConfig")],b.prototype,"castFieldConfig",null),e([r({dependsOn:["layer?.formTemplate"],type:f})],b.prototype,"formTemplate",null),e([r({readOnly:!0,dependsOn:["messages","feature","fieldConfig","layer.fields","layer.loaded","state"],autoTracked:!1})],b.prototype,"inputFields",null),e([r({dependsOn:["feature.layer"]})],b.prototype,"layer",null),e([r()],b.prototype,"messages",void 0),e([r({dependsOn:["messages","layer.loaded"]})],b.prototype,"state",null),e([r()],b.prototype,"strict",void 0),e([r({dependsOn:["formTemplate"]})],b.prototype,"title",null),e([r({dependsOn:["_allInputFields"]})],b.prototype,"valid",null),e([r()],b.prototype,"getValues",null),e([r()],b.prototype,"submit",null),b=e([s(O)],b);var E=b;export default E;
