/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../core/has.js";import{isSome as t,unwrap as i,isNone as o,get as r}from"../../core/maybe.js";import a from"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import{property as s}from"../../core/accessorSupport/decorators/property.js";import{subclass as n}from"../../core/accessorSupport/decorators/subclass.js";import p from"../../core/Error.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import c from"../../geometry/Point.js";import{geometryToCoordinates as h}from"../../geometry/support/coordsUtils.js";import"../../geometry.js";import l from"../../core/Evented.js";import d from"../../core/Collection.js";import{createScreenPoint as y,pt2px as v}from"../../core/screenUtils.js";import u from"../../symbols/SimpleLineSymbol.js";import m from"../../symbols/SimpleFillSymbol.js";import g from"../../symbols/SimpleMarkerSymbol.js";import{s as _}from"../../chunks/symbols.js";import G from"../../Graphic.js";import w from"../../core/Handles.js";import{watch as f,on as b,init as x,when as C,whenNotOnce as E}from"../../core/watchUtils.js";import{getReferenceEllipsoid as T}from"../../geometry/projectionEllipsoid.js";import S from"../../layers/GraphicsLayer.js";import{ViewEventPriorities as I}from"../../views/input/InputManager.js";import{isDOMContainer as A}from"../../views/DOMContainer.js";import{createScreenPointFromEvent as O}from"../../views/support/screenUtils.js";import{SnappingOptions as k}from"../../views/interactive/snapping/SnappingOptions.js";import{createMultipoint as H,createPolyline as L,createPolygon as M,createCircle as D,createSquare as P,createRectangle as U,createEllipse as R,createViewAlignedCoordinateSystem as F,makeSurfacePoint as K}from"../../views/draw/support/createUtils.js";import j from"../../views/draw/Draw.js";import{isSupportedGraphicResultMessage as V}from"../../views/3d/interactive/editingTools/isSupportedGraphicUtils.js";import{isSupportedGraphic as W}from"../../views/3d/interactive/editingTools/moveGraphic/isSupportedGraphic.js";import{isSupportedGraphic as z}from"../../views/3d/interactive/editingTools/reshapeGraphic/isSupportedGraphic.js";import{isSupportedGraphic as q}from"../../views/3d/interactive/editingTools/transformGraphic/isSupportedGraphic.js";import{addUniqueLayer as Z}from"../../views/draw/support/layerUtils.js";import{OperationHandle as B}from"./support/OperationHandle.js";const N=a.getLogger("esri.widgets.Sketch.SketchViewModel"),$={redoKey:"r",undoKey:"z",centerKey:"Alt",constraintKey:"Control",snappingKey:"Control",cancelKey:"Escape",deleteKeys:["Backspace","Delete"],complete:"c",pan:" "},Y={defaultZ:0},J={enableMidpoints:!0,enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,tool:"transform",enableZ:!0,enableMoveGraphic:!0};let Q=class extends l.EventedAccessor{constructor(e){super(e),this._activeFillGraphic=null,this._activeLineGraphic=null,this._centerIndicatorGraphic=null,this._centerSymbol=new g({style:"cross",size:6,color:[255,255,255]}),this._defaultSegmentOffset=48,this._numUpdating=0,this._handles=new w,this._internalGraphicsLayer=new S({listMode:"hide"}),this._lineGraphic=null,this._operationHandle=null,this._vertexGraphics=[],this._viewHandles=new w,this._doUnnormalization=!1,this.activeFillSymbol=new m({style:"solid",color:[150,150,150,.2],outline:{color:[50,50,50],width:0}}),this.activeLineSymbol=new u({color:[255,127,0,1],width:2}),this.activeVertexSymbol=new g({style:"circle",size:6,color:[255,127,0,1],outline:{color:[50,50,50],width:1}}),this.layer=null,this.pointSymbol=new g({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this.polygonSymbol=new m({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),this.polylineSymbol=new u({color:[130,130,130,1],width:2}),this.updateGraphics=new d,this.updateOnGraphicClick=!0,this.updatePointSymbol=new g({size:10,color:[0,200,255,.5],outline:{color:"black",width:1}}),this.updatePolygonSymbol=new m({color:[12,207,255,.2],outline:{join:"round",color:[12,207,255],width:2}}),this.updatePolylineSymbol=new u({color:[12,207,255],width:2}),this.vertexSymbol=new g({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this.snappingOptions=new k,this._originalAutoOpenEnabled=null,this.defaultCreateOptions=Y,this.defaultUpdateOptions=J}initialize(){this._handles.add([f(this,"layer",(()=>{this.cancel(),this._internalGraphicsLayer.elevationInfo=t(this.layer)?this.layer.elevationInfo:null})),b(this,"view.map.layers","change",(e=>{e.removed.indexOf(this.layer)>=0&&this.cancel()})),b(this,"layer.graphics","change",(e=>{if(t(this._operationHandle))for(const t of e.removed)this.updateGraphics.includes(t)&&(this.updateGraphics.length>1?this._operationHandle.removeFromSelection(t):this._operationHandle.cancel())})),x(this,"layer.elevationInfo",(()=>{this.cancel(),this._internalGraphicsLayer.elevationInfo=t(this.layer)?this.layer.elevationInfo:null}),!0)])}destroy(){this.cancel(),this._handles.removeAll(),this._handles=null,this._viewHandles.removeAll(),this._viewHandles=null,this._removeDefaultLayer(),this._draw&&this._draw.destroy(),this._set("view",null),this.emit("destroy")}get _defaultUpdateTool(){return"3d"===this.view.type?"move":"transform"}get _draw(){return"ready"===this.state||"active"===this.state?new j({view:this.view}):null}get updating(){return this._numUpdating>0}get activeTool(){return this._operationHandle&&this._operationHandle.tool?this._operationHandle.tool:null}get activeComponent(){return this._operationHandle?this._operationHandle.activeComponent:null}get createGraphic(){return this.view&&"3d"===this.view.type&&t(this.activeComponent)&&"draw-3d"===this.activeComponent.type?i(this.activeComponent.createGraphic):this._get("createGraphic")}set defaultCreateOptions(e){this._set("defaultCreateOptions",{...Y,...e})}set defaultUpdateOptions(e){this._set("defaultUpdateOptions",{...J,...e})}get state(){var e;const t=!(null==(e=this.view)||!e.ready||!this.layer),i=this._operationHandle;return t&&i?"active":t?"ready":"disabled"}get view(){return this._get("view")}set view(e){const t=this._get("view");if(t){const{container:e,map:i}=t;e&&(t.cursor=null),i&&i.remove(this._internalGraphicsLayer),this._viewHandles.removeAll(),this.cancel()}this._doUnnormalization=null!=e&&"3d"===e.type&&"global"===e.viewingMode;const i="view-ready";this._handles.remove(i),e&&this._handles.add(C(e,"ready",(t=>{this._viewHandles.removeAll(),t&&this._viewHandles.add(this._generateViewHandles(e))}),!0),i),this._set("view",e)}cancel(){this._moduleLoaderAbortController&&(this._moduleLoaderAbortController.abort(),this._moduleLoaderAbortController=null),this._operationHandle&&this._operationHandle.cancel()}complete(){this._operationHandle&&this._operationHandle.complete()}delete(){const{state:e,updateGraphics:t}=this;if("active"===e&&t.length){const{activeTool:e,layer:i}=this,o=t.toArray();i.removeMany(o),this.cancel(),this._emitDeleteEvent({graphics:o,tool:e})}}async create(e,t){if("disabled"===this.state)return this.layer||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),void(this.view||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."));if(this.cancel(),!e)return void this._logError("sketch:missing-parameter","Missing parameter 'tool'.");const i=await this._setupCreateOperation(e,t);if(o(i)||this.destroyed)return;Z(this.view,this._internalGraphicsLayer);i.on("complete",(()=>{if(i===this._operationHandle){const t=this.createGraphic,o=this._operationHandle.cancelled;this._operationHandle.destroy(),this._operationHandle=null,this._set("createGraphic",null),this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),i.cancelled||null==t||this.layer.add(t),this.emit("create",{graphic:t,state:o?"cancel":"complete",tool:e,toolEventInfo:null,type:"create"})}})),this._operationHandle=i,this.view.ready&&A(this.view)&&this.view.focus()}async update(e,t){const{layer:i,state:r,view:a}=this;if("disabled"===r)return i||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),void(a||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."));this.cancel();const s=Array.isArray(e)?e:[e];if(null==e||!s||!s.length)return void this._logError("sketch:missing-parameter","Missing parameter 'graphics'.");if(s.some((e=>e.layer!==i?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),!0):o(e.geometry)?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0):"2d"===a.type&&!a.spatialReference.equals(e.geometry.spatialReference)&&(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with a spatial reference different from the supplied MapView."),!0))))return;const n=await this._setupUpdateOperation(s,t);o(n)||oe(n)||(Z(this.view,this._internalGraphicsLayer),this._setUpdateOperationHandle(n,t),this.emit("update",{graphics:s,state:"start",aborted:!1,tool:n.tool,toolEventInfo:null,type:"update"}))}undo(){this.canUndo()&&this._operationHandle.undo()}redo(){this.canRedo()&&this._operationHandle.redo()}canUndo(){return!(!this._operationHandle||!this._operationHandle.canUndo())}canRedo(){return!(!this._operationHandle||!this._operationHandle.canRedo())}toggleUpdateTool(){this._operationHandle&&this._operationHandle.toggleTool&&this._operationHandle.toggleTool()}async _getFirstHit(e){const t=[];switch(this.view.type){case"2d":{const r=await this.view.hitTest(e);if(r.results.length>0){const e=r.results[0];if(e.graphic){var i,o;const r=e.graphic;"vector-tile"!==(null==(i=r.layer)?void 0:i.type)&&"imagery"!==(null==(o=r.layer)?void 0:o.type)&&t.push(e)}}}break;case"3d":{const i=[this.view.map.ground];this.view.map.allLayers.forEach((e=>{"integrated-mesh"===e.type&&i.push(e)}));const o=await this.view.hitTest(e,{exclude:i});if(o.results.length>0){const e=o.results[0];(!o.ground.mapPoint||this.view.map.ground.opacity<1||o.ground.distance-e.distance>-Math.min(3*o.ground.distance,"global"===this.view.viewingMode?T(this.view.renderCoordsHelper.spatialReference).radius/this.view.renderCoordsHelper.unitInMeters:Number.POSITIVE_INFINITY))&&t.push(e)}}}return{screenPoint:e,results:t}}_generateViewHandles(e){return[e.on("immediate-click",(i=>{const{_operationHandle:o,defaultUpdateOptions:r,layer:a,state:s,updateGraphics:n,updateOnGraphicClick:p}=this,c="active"===s&&"create"===o.type;"disabled"!==s&&!c&&p&&(this._beginAsyncOperation(),this._getFirstHit(O(i)).then((t=>{const o=t.results;if(o.length)for(let t=0;t<o.length;++t){const r=o[t];if(r.graphic){const t=r.graphic;if(n.indexOf(t)>-1||t.layer===a)return i.stopPropagation(),t;"2d"!==e.type||this._isComponentGraphic(t)||"active"!==s||this.cancel()}}else"active"===s&&this.cancel();return null})).then((e=>t(e)&&-1===n.indexOf(e)?this.update([e],{...r}):null)).then((()=>{this._endAsyncOperation()})))}),I.WIDGET)]}async _setupCreateOperation(e,t){if(!e)return null;const i={hasZ:"3d"===this.view.type,...this.defaultCreateOptions,...t};let r;if("2d"===this.view.type)switch(e){case"point":r=this._setupCreatePointOperation(e,i);break;case"multipoint":r=this._setupCreateMultipointOperation(e,null);break;case"polygon":case"polyline":r=this._setupCreatePolyOperation(e,i);break;case"rectangle":r=this._setupCreateRectangleOperation(e,i);break;case"circle":r=this._setupCreateCircleOperation(e,i)}else{const t=await this._setupCreate3DOperation(e,this.view,i);if(o(t)||oe(t))return null;r=t}return r}async _setupCreate3DOperation(e,r,a){if("multipoint"===e)return null;const s={point:this.pointSymbol,multipoint:null,polyline:this.polylineSymbol,polygon:this.polygonSymbol,rectangle:this.polygonSymbol,circle:this.polygonSymbol}[e];this._removeCreateOperationGraphics();const n="rectangle"!==e,p="rectangle"!==e;this.snappingOptions.selfEnabledToggled=!1;const c={view:r,mode:"rectangle"===e||"circle"===e?"hybrid":"click",...a,elevationInfo:this.layer.elevationInfo,geometryType:e,createGraphicSymbol:s,snapToScene:!t(this.layer.elevationInfo)||"absolute-height"===this.layer.elevationInfo.mode,snappingOptions:this.snappingOptions,forceUniformSize:p,centered:n},h=await this._requireModule(import("../../views/3d/interactive/editingTools.js"));if(oe(h))return h;const l=new h.module.DrawGraphicTool(c);this.view.tools.add(l);let d=null;this.view.activeTool=l;const y=[],v=new B({activeComponent:l,tool:e,type:"update",onEnd:()=>{var e;y.forEach((e=>e.remove())),y.length=0,null==(e=this.view.tools)||e.remove(l),l.destroy()},undo:()=>{l.canUndo&&l.undo()},redo:()=>{l.canRedo&&l.redo()},canUndo:()=>l.canUndo,canRedo:()=>l.canRedo});return y.push(this.view.on("key-down",(t=>{t.key===$.pan?(t.stopPropagation(),t.repeat||(l.enabled=!1)):t.key===$.complete?(t.stopPropagation(),l.completeCreateOperation()):t.key===$.undoKey?(t.stopPropagation(),v.undo()):t.key===$.redoKey?(t.stopPropagation(),v.redo()):t.key!==$.snappingKey||"rectangle"===e||"circle"===e||t.repeat?t.key!==$.constraintKey||"rectangle"!==e&&"circle"!==e||t.repeat?t.key===$.centerKey&&(t.repeat||(l.centered=!n,t.stopPropagation())):(l.forceUniformSize=!p,t.stopPropagation()):(l.snappingOptions.selfEnabledToggled=!0,t.stopPropagation())}),I.WIDGET),this.view.on("key-up",(t=>{t.key===$.pan?l.enabled=!0:t.key===$.snappingKey&&"rectangle"!==e&&"circle"!==e?(l.snappingOptions.selfEnabledToggled=!1,t.stopPropagation()):t.key!==$.constraintKey||"rectangle"!==e&&"circle"!==e?t.key===$.centerKey&&(l.centered=n,t.stopPropagation()):(l.forceUniformSize=p,t.stopPropagation())}),I.WIDGET),l.on("vertex-add",(t=>{switch(d=o(d)?"start":"active",t.operation){case"apply":this.emit("create",{graphic:i(l.createGraphic),state:d,tool:this.activeTool,toolEventInfo:t,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[i(l.createGraphic)],tool:e});break;case"redo":this._emitRedoEvent({graphics:[i(l.createGraphic)],tool:e})}})),l.on("cursor-update",(e=>{l.drawOperation.numCommittedVertices>0&&this.emit("create",{graphic:i(l.createGraphic),state:"active",tool:this.activeTool,toolEventInfo:{coordinates:e.vertices[0].coordinates,type:"cursor-update"},type:"create"})})),l.on("vertex-remove",(t=>{switch(t.operation){case"apply":this.emit("create",{graphic:i(l.createGraphic),state:"active",tool:this.activeTool,toolEventInfo:t,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[i(l.createGraphic)],tool:e});break;case"redo":this._emitRedoEvent({graphics:[i(l.createGraphic)],tool:e})}})),l.on("complete",(e=>{this._removeCreateOperationGraphics(),this._set("createGraphic",i(e.graphic)),d="complete",e.aborted?v&&v.cancel():v&&v.complete()}))),v}_setupCreatePointOperation(e,i){const o={elevationInfo:this.layer.elevationInfo,hasZ:i.hasZ,defaultZ:i.defaultZ,interactiveUndoDisabled:!0},r=this._draw.create(e,o),a=[r.on("cursor-update",(e=>{t(e.vertexIndex)?this._displayCrosshairCursor():this._displayDefaultCursor()})),r.on("draw-complete",(e=>{const t=this.createPointFromVertex(e.vertices[0]),i=new G(t,this.pointSymbol);this._set("createGraphic",i),n&&n.complete()}))],s=[this.view.on("key-down",(e=>{e.key===$.cancelKey&&(n&&n.cancel(),e.stopPropagation())}),I.WIDGET)],n=this._operationHandleForCreateAction(r,[...a,...s],e);return n}_setupCreateMultipointOperation(e,t){const i={...t,undoDisabled:!0},o=this._draw.create(e,i);let r=null;const a=[],s=this._operationHandleForCreateAction(o,a,e);return a.push(o.on("vertex-add",(t=>{const{type:i,vertexIndex:o,vertices:a}=t,s=a[o];r=t,this._drawMultipointGraphic(a,!0),this.emit("create",{graphic:this.createGraphic,state:1===a.length?"start":"active",tool:e,toolEventInfo:{added:s,vertices:[{coordinates:s,componentIndex:0,vertexIndex:o}],type:i},type:"create"})})),o.on("vertex-remove",(t=>{const{type:i,vertexIndex:o,vertices:a}=t,s=a[o];r=t,this._drawMultipointGraphic(a,!0),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{removed:s,vertices:[{coordinates:s,componentIndex:0,vertexIndex:o}],type:i},type:"create"})})),o.on("vertex-update",(t=>{const{type:i,vertexIndex:o,vertices:a}=t,s=a[o];r=t,this._drawMultipointGraphic(a,!0),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{type:i,updated:s,vertices:[{coordinates:s,componentIndex:0,vertexIndex:o}]},type:"create"})})),o.on("cursor-update",(e=>{r=e})),o.on("draw-complete",(e=>{const t=e.vertices.slice(0),i=H(t,this.view.spatialReference);i&&this.createGraphic&&(this.createGraphic.geometry=i),s&&s.complete()})),o.on("undo",(e=>{const t=e.vertices,i=r&&"cursor-update"!==r.type;this._resetCreateOperationGraphics(),t.length&&this._drawMultipointGraphic(t,i)})),o.on("redo",(e=>{const t=e.vertices,i=r&&"cursor-update"!==r.type;this._resetCreateOperationGraphics(),t.length&&this._drawMultipointGraphic(t,i)}))),a.push(this.view.on("pointer-move",(()=>this._displayCrosshairCursor()),I.WIDGET),this.view.on("key-down",(e=>this._getCommonUpdateOperationKeyDownHandlers(s,e)),I.WIDGET)),s}_setupCreatePolyOperation(e,t){const i={...t,elevationInfo:this.layer.elevationInfo,interactiveUndoDisabled:!0};let o=null;("polyline"===e||"polygon"===e)&&(o=this._draw.create(e,i));let r=new c,a=null,s=!1;const n=[o.on("vertex-add",(t=>{const{type:i,vertexIndex:o,vertices:r}=t,n=r[o];this._snap(e,r,s),a=t,this._drawVertexGraphics(e,r,{userClicked:!0}),this.emit("create",{graphic:this.createGraphic,state:1===r.length?"start":"active",tool:e,toolEventInfo:{added:n,vertices:[{coordinates:n,componentIndex:0,vertexIndex:o}],type:i},type:"create"})})),o.on("vertex-remove",(t=>{const{type:i,vertexIndex:o,vertices:r}=t,n=r[o];this._snap(e,r,s),a=t,this._drawVertexGraphics(e,r,{userClicked:!0}),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{removed:n,vertices:[{coordinates:n,componentIndex:0,vertexIndex:o}],type:i},type:"create"})})),o.on("vertex-update",(t=>{const{type:i,vertexIndex:o,vertices:r}=t,n=r[o];this._snap(e,r,s),a=t,this._drawVertexGraphics(e,r,{userClicked:!0}),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{type:i,updated:n,vertices:[{coordinates:n,componentIndex:0,vertexIndex:o}]},type:"create"})})),o.on("cursor-update",(t=>{const{type:i,vertices:o}=t;if(t.mapPoint&&(this._snap(e,o,s),a=t,r=t.mapPoint,this._drawVertexGraphics(e,o,{userClicked:!1}),o.length>1)){const t=o[o.length-1];this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:t,type:i},type:"create"})}})),o.on("draw-complete",(t=>{const i=t.vertices.slice(0);let o=null;"polyline"===e?o=L([i],this.view.spatialReference,this._doUnnormalization):"polygon"===e&&(o=M([i],this.view.spatialReference,this._doUnnormalization,!0)),o&&(this.createGraphic.geometry=o),h&&h.complete()})),o.on("undo",(t=>{const i=t.vertices,o=a&&"cursor-update"!==a.type;this._resetCreateOperationGraphics(),this._snap(e,i,s),i.length&&this._drawVertexGraphics(e,i,{userClicked:o})})),o.on("redo",(t=>{const i=t.vertices,o=a&&"cursor-update"!==a.type;this._resetCreateOperationGraphics(),this._snap(e,i,s),i.length&&this._drawVertexGraphics(e,i,{userClicked:o})}))],p=[this.view.on("pointer-move",(e=>{this.view.toMap(y(e.x,e.y))?this._displayCrosshairCursor():this._displayDefaultCursor()}),I.WIDGET),this.view.on("key-down",(t=>{const i=o.vertices.slice(0),r=a&&"cursor-update"!==a.type;t.key===$.constraintKey?"2d"===this.view.type&&(s||(s=!0,this._snap(e,i,!r),this._drawVertexGraphics(e,i,{userClicked:r}))):t.key===$.undoKey&&h&&h.canUndo()?(t.stopPropagation(),h.undo()):t.key===$.redoKey&&h&&h.canRedo()?(t.stopPropagation(),h.redo()):t.key===$.cancelKey&&h&&h.cancel()}),I.WIDGET),this.view.on("key-up",(t=>{const i=o.vertices.slice(0),n=a&&"cursor-update"!==a.type;t.key===$.constraintKey&&s&&(n||(i.pop(),i.push([r.x,r.y]),this._drawVertexGraphics(e,i,{userClicked:n})),s=!1)}),I.WIDGET)];if("polygon"===e){const e=(e,t,i)=>{if(!e||!e.layer||!e.visible)return!1;const o=this.view.toScreen(e.geometry);return this._isWithinScreenDistance(o,t,i)},t=t=>{if(!(this._vertexGraphics.length<=2))return e(this._vertexGraphics[0],t,this._getVertexIntersectDistance())};let i=!1;p.push(this.view.on("pointer-move",(()=>{i=!1}),I.WIDGET),this.view.on("pointer-down",(o=>{if(t(o))return i=!0,void o.stopPropagation();this._vertexGraphics.some((t=>e(t,o,this._getVertexIntersectDistance())))&&o.stopPropagation()}),I.WIDGET),this.view.on("pointer-up",(e=>{i&&(e.stopPropagation(),o.complete())})))}const h=this._operationHandleForCreateAction(o,[...n,...p],e);return h}_setupCreateCircleOperation(e,i){const o={...i,elevationInfo:this.layer.elevationInfo,interactiveUndoDisabled:!0},r=this._draw.create(e,o);let a=!1,s=!0;const n=[r.on("vertex-add",(t=>{const{type:i,vertexIndex:o,vertices:n}=t,p=n[o];this._drawSegmentGraphic(e,n,{centered:s,constrainToggle:a},r.viewAlignedCoordinateSystem),this.emit("create",{graphic:this.createGraphic,state:1===n.length?"start":"active",tool:e,toolEventInfo:{added:p,vertices:[{coordinates:p,componentIndex:0,vertexIndex:o}],type:i},type:"create"})})),r.on("cursor-update",(t=>{const{type:i,vertices:o}=t;if(this._drawSegmentGraphic(e,o,{centered:s,constrainToggle:a},r.viewAlignedCoordinateSystem),2===o.length){const t=o[o.length-1];this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:t,type:i},type:"create"})}})),r.on("draw-complete",(e=>{const t=e.vertices.slice(0);let i=null;1===t.length?(t.push(r.viewAlignedCoordinateSystem.makeMapPoint(t[0][0]+this._defaultSegmentOffset*this.view.resolution,t[0][1])),i=D(t,r.viewAlignedCoordinateSystem,!0,this.view.resolution)):i=a?R(t,r.viewAlignedCoordinateSystem,s):D(t,r.viewAlignedCoordinateSystem,s,this.view.resolution),this.createGraphic?this.createGraphic.geometry=i:(this._removeCreateGraphic(),this._set("createGraphic",new G(i,this.polygonSymbol))),c&&c.complete()}))],p=[this.view.on("pointer-move",(e=>{t(r.getCoordsFromScreenPoint(y(e.x,e.y)))?this._displayCrosshairCursor():this._displayDefaultCursor()}),I.WIDGET),this.view.on("key-down",(t=>{t.key===$.constraintKey?a||(a=!0,this._drawSegmentGraphic(e,r.vertices,{centered:s,constrainToggle:a},r.viewAlignedCoordinateSystem)):t.key===$.centerKey?s&&(s=!1,this._drawSegmentGraphic(e,r.vertices,{centered:s,constrainToggle:a},r.viewAlignedCoordinateSystem)):t.key===$.cancelKey&&c&&c.cancel()}),I.WIDGET),this.view.on("key-up",(t=>{t.key===$.constraintKey?(a=!1,this._drawSegmentGraphic(e,r.vertices,{centered:s,constrainToggle:a},r.viewAlignedCoordinateSystem)):t.key===$.centerKey&&(s=!0,this._drawSegmentGraphic(e,r.vertices,{centered:s,constrainToggle:a},r.viewAlignedCoordinateSystem))}),I.WIDGET)],c=this._operationHandleForCreateAction(r,[...n,...p],e);return c}_setupCreateRectangleOperation(e,i){const o={...i,elevationInfo:this.layer.elevationInfo,interactiveUndoDisabled:!0},r=this._draw.create(e,o);let a=!1,s=!1;const n=[r.on("vertex-add",(t=>{const{type:i,vertexIndex:o,vertices:n}=t,p=n[o];this._drawSegmentGraphic(e,n,{centered:s,constrainToggle:a},r.viewAlignedCoordinateSystem),this.emit("create",{graphic:this.createGraphic,state:1===n.length?"start":"active",tool:e,toolEventInfo:{added:p,vertices:[{coordinates:p,componentIndex:0,vertexIndex:o}],type:i},type:"create"})})),r.on("cursor-update",(t=>{const{type:i,vertices:o}=t;if(this._drawSegmentGraphic(e,o,{centered:s,constrainToggle:a},r.viewAlignedCoordinateSystem),2===o.length){const t=o[o.length-1];this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:t,type:i},type:"create"})}})),r.on("draw-complete",(e=>{const t=e.vertices.slice(0);let i=null;1===t.length&&(a=!1,s=!1),i=a?P(t,r.viewAlignedCoordinateSystem,s):U(t,r.viewAlignedCoordinateSystem,s),this.createGraphic?this.createGraphic.geometry=i:(this._removeCreateGraphic(),this._set("createGraphic",new G(i,this.polygonSymbol))),c&&c.complete()}))],p=[this.view.on("pointer-move",(e=>{t(r.getCoordsFromScreenPoint(y(e.x,e.y)))?this._displayCrosshairCursor():this._displayDefaultCursor()}),I.WIDGET),this.view.on("key-down",(t=>{t.key===$.constraintKey?a||(a=!0,this._drawSegmentGraphic(e,r.vertices,{centered:s,constrainToggle:a},r.viewAlignedCoordinateSystem)):t.key===$.centerKey?s||(s=!0,this._drawSegmentGraphic(e,r.vertices,{centered:s,constrainToggle:a},r.viewAlignedCoordinateSystem)):t.key===$.cancelKey&&c&&c.cancel()}),I.WIDGET),this.view.on("key-up",(t=>{t.key===$.constraintKey?(a=!1,this._drawSegmentGraphic(e,r.vertices,{centered:s,constrainToggle:a},r.viewAlignedCoordinateSystem)):t.key===$.centerKey&&(s=!1,this._drawSegmentGraphic(e,r.vertices,{centered:s,constrainToggle:a},r.viewAlignedCoordinateSystem))}),I.WIDGET)],c=this._operationHandleForCreateAction(r,[...n,...p],e);return c}async _setupUpdateOperation(e,t){const{_defaultUpdateTool:i,defaultUpdateOptions:o,layer:a,view:s}=this,n={...o,...t},p=n.tool||i;for(const t of e)a.remove(t),a.add(t);if("3d"===s.type){if(0===e.length)return null;switch(p){case"move":return this._setupMove3DOperation(e,n,s,p);case"reshape":{if(e.length>1)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;const t=z(e[0]);return 0===t?this._setupReshape3DOperation(e[0],n,s):(this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${V(t)}).`),null)}case"transform":return 1===e.length&&0===q(e[0])?this._setupPointTransform3DOperation(e[0],n,s):this._setupMove3DOperation(e,n,s,p)}}if("move"===p)return this._setupMoveOperation(e,n,s);if(e.length>1)return"reshape"===p?(this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null):this._setupTransformOrReshapeOperation(e,p,n,s);if(1===e.length){const t=e[0],i=r(t.geometry,"type");if("point"===i||"multipoint"===i)return this._setupMoveOperation(e,n,s);if("transform"===p||"reshape"===p)return this._setupTransformOrReshapeOperation(e,p,n,s)}return null}async _setupMove3DOperation(e,t,i,o,r=!1){for(const t of e){const e=W(t);if(0!==e)return this._logError("sketch:move",`Move operation not supported for provided graphic(s) (${V(e)}).`),null}const a=await this._requireModule(import("../../views/3d/interactive/editingTools.js"));if(oe(a))return a;const s=new a.module.GraphicMoveTool({view:i,enableZ:t.enableZ});this.view.tools.add(s),s.graphics.addMany(e),r||this.updateGraphics.addMany(e);const n=[],p=new B({activeComponent:s,tool:o,type:"update",onEnd:()=>{var e;n.forEach((e=>e.remove())),n.length=0,null==(e=this.view.tools)||e.remove(s),s.destroyed||s.destroy()},undo:()=>{X(p,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:o})},redo:()=>{ee(p,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:o})},addToSelection:e=>{this.updateGraphics.push(e),s.graphics.push(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=this.updateGraphics.indexOf(e);p.history.undo.forEach((e=>e.updates.splice(t,1))),p.history.redo.forEach((e=>e.updates.splice(t,1))),this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?s.graphics.remove(e):p.complete()},toggleTool:async()=>{if(1!==this.updateGraphics.length||!1===t.toggleToolOnClick)return;if("transform"!==o)return;const e=this.updateGraphics.getItemAt(0);if(0!==z(e))return;const r=await this._setupReshape3DOperation(e,t,i,!0);oe(r)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(r,t))}});return n.push(...this._getHandlesForComponent(p,t),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(p,e)),I.WIDGET),this.view.on("key-down",(e=>this._getCommonUpdateOperationKeyDownHandlers(p,e)),I.WIDGET)),p}async _setupPointTransform3DOperation(e,t,i){const o="transform",{enableRotation:r,enableScaling:a,enableZ:s}=t,n=await this._requireModule(import("../../views/3d/interactive/editingTools.js"));if(oe(n))return n;const p=new n.module.GraphicTransformTool({graphic:e,view:i,enableRotation:r,enableScaling:a,enableZ:s});this.view.tools.add(p),this.updateGraphics.add(e);const c=[],h=new B({activeComponent:p,tool:o,type:"update",onEnd:()=>{var e;c.forEach((e=>e.remove())),c.length=0,null==(e=this.view.tools)||e.remove(p),p.destroyed||p.destroy()},undo:()=>{X(h,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:o})},redo:()=>{ee(h,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:o})},addToSelection:async e=>{this.updateGraphics.add(e);const o=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,i,"transform",!0);oe(o)||(h.onEnd(),h.destroy(),this._setUpdateOperationHandle(o,t))}});return c.push(...this._getHandlesForComponent(h,t),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(h,e)),I.WIDGET),this.view.on("key-down",(e=>this._getCommonUpdateOperationKeyDownHandlers(h,e)),I.WIDGET)),h}async _setupMoveOperation(e,t,i){const o="move";this.updateGraphics.addMany(e);const r=this._getCloneInfos(e);for(const e of r)this._internalGraphicsLayer.add(e.clone);const a=await this._getGraphicMover(e,t,i);if(oe(a))return a;const s=new B({activeComponent:a,tool:o,type:"update",onEnd:()=>{var e;this._displayDefaultCursor(),p.forEach((e=>e.remove())),n.forEach((e=>e.remove())),p=[],n=[],a.destroy(),null==(e=this._internalGraphicsLayer)||e.removeMany([...this.updateGraphics.toArray(),...r.map((e=>e.clone))])},undo:()=>{X(s,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:o})},redo:()=>{ee(s,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:o})},addToSelection:e=>{this.updateGraphics.push(e),a.graphics=this.updateGraphics.toArray();const t=this._createClone(e);r.push({graphic:e,clone:t}),this._internalGraphicsLayer.add(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=this.updateGraphics.indexOf(e);s.history.undo.forEach((e=>e.updates.splice(t,1))),s.history.redo.forEach((e=>e.updates.splice(t,1)));const i=r.findIndex((t=>t.graphic===e)),o=r[i];this._internalGraphicsLayer.remove(o.clone),this.updateGraphics.remove(e),r.splice(i,1);const n=this.updateGraphics.toArray();this.emit("update",{graphics:n,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?a.graphics=n:s.complete()}});let n=[i.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(s,e,t)),I.WIDGET),i.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(s,e),e.key!==$.constraintKey||e.repeat||(a.enableMoveAllGraphics=!a.enableMoveAllGraphics)}),I.WIDGET),i.on("key-up",(e=>{e.key===$.constraintKey&&(a.enableMoveAllGraphics=!a.enableMoveAllGraphics)}),I.WIDGET)],p=this._getHandlesForComponent(s,t);return p.push(a.on("graphic-move",(e=>{r.forEach((t=>{const i=e.allGraphics.find((e=>e===t.graphic));i&&(t.clone.geometry=i.geometry)}))}))),s}_getCloneInfos(e){return(null==e?void 0:e.map((e=>({graphic:e,clone:this._createClone(e)}))))||[]}_createClone(e){const t=e.clone();return t.symbol=this._getSymbolForClone(e),t}_getSymbolForClone(e){if(o(e.symbol))return null;switch(e.symbol.type){case"cim":return new g({style:"circle",size:12,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}});case"picture-marker":{const{xoffset:t,yoffset:i,height:o,width:r}=e.symbol,a=o===r?r:Math.max(o,r);return new g({xoffset:t,yoffset:i,size:a,style:"square",color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}case"simple-marker":{const{xoffset:t,yoffset:i,size:o,style:r}=e.symbol;return new g({xoffset:t,yoffset:i,style:"circle"===r?"circle":"square",size:o+2,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}case"simple-fill":return new m({color:[0,0,0,0],outline:{style:"dash",color:[255,127,0,1],width:1}});case"simple-line":return new u({color:[255,127,0,1],style:"dash",width:1});case"text":{const{xoffset:t,yoffset:i}=e.symbol;return new g({xoffset:t,yoffset:i,size:12,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}default:return null}}async _setupReshape3DOperation(e,t,i,o=!1){const r="reshape",a=await this._requireModule(import("../../views/3d/interactive/editingTools.js"));if(oe(a))return a;this.snappingOptions.selfEnabledToggled=!1;const s=new a.module.GraphicReshapeTool({view:i,graphic:e,enableZ:t.enableZ,enableMoveGraphic:t.enableMoveGraphic,snappingOptions:this.snappingOptions});i.tools.add(s),o||this.updateGraphics.add(e);const n=[],p=new B({activeComponent:s,tool:r,type:"update",onEnd:()=>{var e;n.forEach((e=>e.remove())),n.length=0,null==(e=this.view.tools)||e.remove(s),s.destroyed||s.destroy()},undo:()=>{s.beforeUndo(),X(p,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:r})},redo:()=>{ee(p,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:r})},addToSelection:async e=>{this.updateGraphics.add(e);const o=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,i,"transform",!0);oe(o)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(o,t))},toggleTool:async()=>{if(!1===t.toggleToolOnClick)return;const e=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,i,"transform",!0);oe(e)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(e,t))}});return n.push(...this._getHandlesForComponent(p,t),i.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(p,e)),I.WIDGET),i.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(p,e),e.key===$.snappingKey&&(s.snappingOptions.selfEnabledToggled=!0,e.stopPropagation())}),I.WIDGET),i.on("key-up",(e=>{e.key===$.snappingKey&&(s.snappingOptions.selfEnabledToggled=!1,e.stopPropagation())}),I.WIDGET)),p}async _setupTransformOrReshapeOperation(e,t,i,o){const{multipleSelectionEnabled:r}=i;this.updateGraphics.addMany(e);const a="transform"===t?await this._getBox(e,i,o):await this._getReshape(e,i,o);if(oe(a))return a;const s=new B({activeComponent:a,type:"update",onEnd:()=>{p.forEach((e=>e.remove())),n.forEach((e=>e.remove())),p=[],n=[],s.activeComponent&&!s.activeComponent.destroyed&&s.activeComponent.destroy(),this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray())},undo:()=>{X(s,this.updateGraphics.toArray()),s.refreshComponent(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:s.tool})},redo:()=>{ee(s,this.updateGraphics.toArray()),s.refreshComponent(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:s.tool})},addToSelection:e=>{const t=s.activeComponent;this.updateGraphics.add(e),t.graphics=this.updateGraphics.toArray(),t.refresh(),s.resetHistory(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=s.activeComponent,i=this.updateGraphics.indexOf(e);s.history.undo.forEach((e=>e.updates.splice(i,1))),s.history.redo.forEach((e=>e.updates.splice(i,1))),this.updateGraphics.remove(e);const o=this.updateGraphics.toArray();this.emit("update",{graphics:o,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?t.graphics=o:s.complete()},toggleTool:async()=>{if(this.updateGraphics.length>1)return;let t=null;"transform"===s.tool?t=await this._getReshape(e,i,o):"reshape"===s.tool&&(t=await this._getBox(e,i,o)),oe(t)||(s.activeComponent.destroy(),s.activeComponent=t,s.activeComponent&&(p.forEach((e=>e.remove())),p=this._getHandlesForComponent(s,i)))}});let n=[o.on("immediate-click",(e=>{this._getFirstHit(O(e)).then((t=>{var i;if(!s)return;if(null==(i=t.results)||!i.length)return void s.complete();const o=s.activeComponent;t.results.some((t=>{if(t.graphic){var i;const a=t.graphic;if("box"===(null==o?void 0:o.type)&&null!=(i=e.native)&&i.shiftKey&&r)return s.addToSelection(a),!0;a.layer===this.layer&&s.complete()}return!1}))&&e.stopPropagation()}))}),I.WIDGET),o.on("key-down",(e=>{if(this._getCommonUpdateOperationKeyDownHandlers(s,e),e.key===$.constraintKey&&!e.repeat&&s){const e=s.activeComponent;e&&"box"===e.type&&(e.preserveAspectRatio=!e.preserveAspectRatio)}}),I.WIDGET),o.on("key-up",(e=>{if(e.key===$.constraintKey&&s){const e=s.activeComponent;e&&"box"===e.type&&(e.preserveAspectRatio=!e.preserveAspectRatio)}}),I.WIDGET)],p=this._getHandlesForComponent(s,i);return s}async _getGraphicMover(e,t,i){const{enableMoveAllGraphics:o}=t,r=await this._requireModule(import("../../views/draw/support/GraphicMover.js"));return oe(r)?r:new r.module.default({enableMoveAllGraphics:o,graphics:e,view:i,callbacks:{onGraphicMoveStart:({dx:e,dy:t,graphic:i})=>{this._displayGrabbingCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:"move-start"},type:"update"})},onGraphicMove:({dx:e,dy:t,graphic:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:"move"},type:"update"}),onGraphicMoveStop:({dx:e,dy:t,graphic:i})=>{this._displayPointerCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:"move-stop"},type:"update"})},onGraphicPointerOver:()=>this._displayPointerCursor(),onGraphicPointerOut:()=>this._displayDefaultCursor()}})}async _getBox(e,t,i){const{enableRotation:o,enableScaling:r,preserveAspectRatio:a}=t,s=await this._requireModule(import("../../views/draw/support/Box.js"));return oe(s)?s:new s.module.default({graphics:e,enableRotation:o,enableScaling:r,preserveAspectRatio:a,layer:this._internalGraphicsLayer,view:i,callbacks:{onMoveStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onMove:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onMoveStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScaleStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScale:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScaleStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotateStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotate:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotateStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"})}})}async _getReshape(e,t,i){const{enableMidpoints:o=!0}=t,r=await this._requireModule(import("../../views/draw/support/Reshape.js"));return oe(r)?r:new r.module.default({enableMidpoints:o,graphic:e[0],layer:this._internalGraphicsLayer,view:i,callbacks:{onReshapeStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onReshape:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onReshapeStop:({mover:e,type:t})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e,type:t},type:"update"}),onMoveStart:({dx:e,dy:t,mover:i,type:o})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:o},type:"update"}),onMove:({dx:e,dy:t,mover:i,type:o})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:o},type:"update"}),onMoveStop:({dx:e,dy:t,mover:i,type:o})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:o},type:"update"}),onVertexAdd:({added:e,type:t,vertices:i})=>{const o=e.map((e=>h(e.geometry)));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:o,vertices:i,type:t},type:"update"})},onVertexRemove:({removed:e,type:t,vertices:i})=>{const o=e.map((e=>h(e.geometry)));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{removed:o,vertices:i,type:t},type:"update"})}}})}_getHandlesForComponent(e,t){const i=e.activeComponent;switch(i.type){case"graphic-mover":return[i.on("graphic-click",(({graphic:t,viewEvent:i})=>{var o;null!=(o=i.native)&&o.shiftKey&&(i.stopPropagation(),e.removeFromSelection(t))})),i.on("graphic-move-start",(t=>e.addToHistory(te(t.allGraphics))))];case"box":return[i.on("graphic-click",(i=>this._onTransformOrReshape2DGraphicClick(e,t,i))),i.on("move-start",(t=>e.addToHistory(te(t.graphics)))),i.on("rotate-start",(t=>e.addToHistory(te(t.graphics)))),i.on("scale-start",(t=>e.addToHistory(te(t.graphics))))];case"reshape":return[i.on("graphic-click",(i=>this._onTransformOrReshape2DGraphicClick(e,t,i))),i.on("move-start",(t=>e.addToHistory(te([t.mover])))),i.on("reshape-start",(t=>e.addToHistory(te([t.graphic])))),i.on("vertex-add",(t=>e.addToHistory(te([t.oldGraphic])))),i.on("vertex-remove",(t=>e.addToHistory(te([t.oldGraphic]))))];case"move-3d":return[i.on("graphic-move-start",(t=>{e.addToHistory(te(t.allGraphics)),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:t.allGraphics.length>0?t.allGraphics[0]:null,type:"move-start"},type:"update"})})),i.on("graphic-move",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e.dx,dy:e.dy,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move"},type:"update"})})),i.on("graphic-move-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move-stop"},type:"update"})})),i.on("immediate-click",(i=>{i.shiftKey?this._toggleSelection([i.graphic],e,t):e.toggleTool()}))];case"transform-3d":return[i.on("graphic-translate-start",(t=>{e.addToHistory(te([t.graphic])),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,dx:t.dxScreen,dy:t.dyScreen,type:"move-start"},type:"update"})})),i.on("graphic-translate-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move-stop"},type:"update"})})),i.on("graphic-rotate-start",(t=>{e.addToHistory(ie([t.graphic])),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,angle:t.angle,type:"rotate-start"},type:"update"})})),i.on("graphic-rotate-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate-stop"},type:"update"})})),i.on("graphic-scale-start",(t=>{e.addToHistory(ie([t.graphic])),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,xScale:t.scale,yScale:t.scale,type:"scale-start"},type:"update"})})),i.on("graphic-scale-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.scale,yScale:e.scale,type:"scale-stop"},type:"update"})})),i.on("graphic-translate",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move"},type:"update"})})),i.on("graphic-rotate",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate"},type:"update"})})),i.on("graphic-scale",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.scale,yScale:e.scale,type:"scale"},type:"update"})}))];case"reshape-3d":return[i.on("reshape",(t=>{"reshape-start"===t.type&&e.addToHistory(te([t.mover])),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:t,type:"update"})})),i.on("move",(t=>{"move-start"===t.type&&e.addToHistory(te([t.mover])),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:t,type:"update"})})),i.on("vertex-add",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),i.on("vertex-remove",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),i.on("immediate-click",(()=>e.toggleTool()))];case"draw":case"draw-3d":return null;default:return}}_onTransformOrReshape2DGraphicClick(e,t,i){var r;const{graphic:a,viewEvent:s}=i;null!=(r=s.native)&&r.shiftKey?(s.stopPropagation(),e.removeFromSelection(a)):t.toggleToolOnClick&&(o(a.geometry)||"extent"!==a.geometry.type?(s.stopPropagation(),e.toggleTool()):this._logError("sketch:reshape-extent","Reshape operation does not support graphics with geometry of type 'extent'."))}_setUpdateOperationHandle(e,t){this._operationHandle=e;const i=this.view.map;this._disablePopup(t);e.on("complete",(()=>{if(e===this._operationHandle){const o=this.updateGraphics.toArray(),r=this._operationHandle.tool;this._operationHandle.destroy(),this._operationHandle=null,this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray()),this.updateGraphics.removeAll(),i&&i.remove(this._internalGraphicsLayer),this._restorePopup(t),this.emit("update",{graphics:o,state:"complete",aborted:e.cancelled,tool:r,toolEventInfo:null,type:"update"})}}))}_getCommonUpdateOperationClickHandlers(e,t,i){const o=O(t);this._getFirstHit(o).then((o=>{const r=o.results;if(!r.length)return void e.complete();if(t.native.shiftKey&&this._toggleSelection(r.map((e=>e.graphic)),e,i))return void t.stopPropagation();r.some((e=>e.graphic&&this.updateGraphics.indexOf(e.graphic)>-1))?t.stopPropagation():e.complete()}))}_toggleSelection(e,t,i){const o=!i||!!i.multipleSelectionEnabled;return e.some((e=>null!=e&&(!(!o||e.layer!==this.layer)&&(-1===this.updateGraphics.indexOf(e)?t.addToSelection(e):t.removeFromSelection(e),!0))))}_getCommonUpdateOperationKeyDownHandlers(e,t){if(!e)return;const i=t.key;i===$.undoKey&&e.canUndo()?(t.stopPropagation(),e.undo()):i===$.redoKey&&e.canRedo()?(t.stopPropagation(),e.redo()):i===$.cancelKey?(t.stopPropagation(),e.cancel()):$.deleteKeys.indexOf(i)>=0&&this._onDeleteKey(t)}_onDeleteKey(e){if(!this._operationHandle||"update"!==this._operationHandle.type)return;const t=this.activeComponent;if(o(t)||"reshape"===t.type||"reshape-3d"===t.type)return;e.stopPropagation();const i=this.updateGraphics.toArray();this.layer.removeMany(i),this._emitDeleteEvent({graphics:i,tool:this.activeTool})}_drawMultipointGraphic(e,t){let i=null;if(!t&&e.length>1){const t=e.slice(0);t.pop(),i=H(t,this.view.spatialReference)}else i=H(e,this.view.spatialReference);this.createGraphic?this.createGraphic.geometry=i:this._set("createGraphic",new G(i,this.pointSymbol)),t&&1===e.length&&this._internalGraphicsLayer.add(this.createGraphic)}_drawVertexGraphics(e,t,i){if(!t.length)return;const{_doUnnormalization:o,activeLineSymbol:r,activeVertexSymbol:a,polygonSymbol:s,polylineSymbol:n,vertexSymbol:p,view:{spatialReference:c}}=this,h=!(!i||!i.userClicked),l="polygon"===e,d=l?s:n;if(1===t.length){this._removeLineGraphic(),this._removeActiveLineGraphic();const e=this.createPointFromVertex(t[0]),i=l?M([t],c,o,!0):L([t],c,o);this._vertexGraphics.length?this._vertexGraphics[0].geometry=e:this._vertexGraphics.push(new G(e,a)),this.createGraphic?this.createGraphic.geometry=i:this._set("createGraphic",new G(i,d)),h&&this._internalGraphicsLayer.add(this._vertexGraphics[0])}else if(2===t.length){const e=this.createPointFromVertex(t[1]),i=L([t],c,o),r=l?M([t],c,o,!0):L([t],c,o);if(!this._vertexGraphics.length){const e=this.createPointFromVertex(t[0]),i=new G(e,p);this._vertexGraphics.push(i)}if(1===this._vertexGraphics.length){const t=this._vertexGraphics[0],i=new G(e,p);this._removeLineGraphic(),this._removeActiveFillGraphic(),this._vertexGraphics.push(i),this._internalGraphicsLayer.remove(t),this._internalGraphicsLayer.add(t)}else this._vertexGraphics[1].geometry=e;this._showActiveLineGraphic(i);const a=this._vertexGraphics[0];h&&(this._activeLineGraphic.symbol=n,a.symbol=p,this._internalGraphicsLayer.add(this._vertexGraphics[1])),this.createGraphic?this.createGraphic.geometry=r:this._set("createGraphic",new G(r,s)),this._internalGraphicsLayer.remove(a),this._internalGraphicsLayer.add(a)}else if(t.length>2){const i=l?M([t],c,o,!0):L([t],c,o);"polygon"===e&&this._showFillGraphic(i);const s=t.map((e=>e.slice())),y=s.pop(),v=[s[s.length-1],y],u=L([s],c,o),m=L([v],c,o);this._showLineGraphic(u),this._showActiveLineGraphic(m);for(let e=0;e<s.length;e++){const i=this._vertexGraphics[e];if(i)h||e!==this._vertexGraphics.length-1?i.symbol=p:i.symbol=a;else{const i=this.createPointFromVertex(t[e]);this._showVertexGraphic(i)}}if(h){this._activeLineGraphic.symbol=n;const e=t.length-1,i=this.createPointFromVertex(t[e]);this._showVertexGraphic(i)}else this._activeLineGraphic.symbol=r;this.createGraphic?this.createGraphic.geometry=i:(this._removeCreateGraphic(),this._set("createGraphic",new G(i,d)));for(const e of this._vertexGraphics)this._internalGraphicsLayer.remove(e),this._internalGraphicsLayer.add(e)}}_drawSegmentGraphic(e,t,i,o){if(!t.length)return;const r=!(null==i||!i.centered),a=!(null==i||!i.constrainToggle);let s=null;1===t.length?this._removeCenterIndicatorGraphic():("rectangle"===e?s=a?P(t,o,r):U(t,o,r):"circle"===e&&(s=a?R(t,o,r):D(t,o,r,this.view.resolution)),s.extent&&s.extent.center&&this._showCenterIndicatorGraphic(s.extent.center)),s?this.createGraphic?this.createGraphic.geometry=s:(this._removeCreateGraphic(),this._set("createGraphic",new G(s,this.polygonSymbol)),this._internalGraphicsLayer.add(this.createGraphic)):this._removeCreateGraphic()}_showCenterIndicatorGraphic(e){this._centerIndicatorGraphic?this._centerIndicatorGraphic.geometry=e:(this._centerIndicatorGraphic=new G(e,this._centerSymbol),this._internalGraphicsLayer.add(this._centerIndicatorGraphic))}_removeCenterIndicatorGraphic(){this._centerIndicatorGraphic&&(this._internalGraphicsLayer.remove(this._centerIndicatorGraphic),this._centerIndicatorGraphic.destroy(),this._centerIndicatorGraphic=null)}_showActiveLineGraphic(e){this._activeLineGraphic?(this._activeLineGraphic.geometry=e,this._internalGraphicsLayer.remove(this._activeLineGraphic)):this._activeLineGraphic=new G(e,this.activeLineSymbol),this._internalGraphicsLayer.add(this._activeLineGraphic)}_showFillGraphic(e){this._activeFillGraphic?(this._activeFillGraphic.geometry=e,this._internalGraphicsLayer.remove(this._activeFillGraphic)):this._activeFillGraphic=new G(e,this.activeFillSymbol),this._internalGraphicsLayer.add(this._activeFillGraphic)}_showLineGraphic(e){this._lineGraphic?(this._lineGraphic.geometry=e,this._internalGraphicsLayer.remove(this._lineGraphic)):this._lineGraphic=new G(e,this.polylineSymbol),this._internalGraphicsLayer.add(this._lineGraphic)}_showVertexGraphic(e,t){const i=t?this.activeVertexSymbol:this.vertexSymbol,o=new G(e,i);this._vertexGraphics.push(o),this._internalGraphicsLayer.add(o)}_resetCreateOperationGraphics(){this._removeActiveFillGraphic(),this._removeLineGraphic(),this._removeActiveLineGraphic(),this._removeVertexGraphics()}_removeCreateGraphic(){this.createGraphic&&(this._internalGraphicsLayer.remove(this.createGraphic),this._set("createGraphic",null))}_removeCreateOperationGraphics(){this._removeCenterIndicatorGraphic(),this._removeActiveLineGraphic(),this._removeActiveFillGraphic(),this._removeLineGraphic(),this._removeVertexGraphics()}_removeActiveLineGraphic(){this._activeLineGraphic&&(this._internalGraphicsLayer.remove(this._activeLineGraphic),this._activeLineGraphic.destroy(),this._activeLineGraphic=null)}_removeActiveFillGraphic(){this._activeFillGraphic&&(this._internalGraphicsLayer.remove(this._activeFillGraphic),this._activeFillGraphic.destroy(),this._activeFillGraphic=null)}_removeLineGraphic(){this._lineGraphic&&(this._internalGraphicsLayer.remove(this._lineGraphic),this._lineGraphic.destroy(),this._lineGraphic=null)}_removeVertexGraphics(){this._vertexGraphics.length&&(this._internalGraphicsLayer.removeMany(this._vertexGraphics),this._vertexGraphics.forEach((e=>e.destroy())),this._vertexGraphics=[])}_removeDefaultLayer(){this._internalGraphicsLayer&&(this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),this._internalGraphicsLayer.destroy(),this._internalGraphicsLayer=null)}_operationHandleForCreateAction(e,t,i){return new B({activeComponent:this._draw,tool:i,type:"create",onEnd:()=>{t.forEach((e=>e.remove())),t.length=0,this._removeCreateOperationGraphics(),this._internalGraphicsLayer&&this._internalGraphicsLayer.remove(this.createGraphic),this._displayDefaultCursor()},undo:()=>{e.undo(),this._emitUndoEvent({graphics:[this.createGraphic],tool:i})},redo:()=>{e.redo(),this._emitRedoEvent({graphics:[this.createGraphic],tool:i})},canUndo:()=>e&&e.canUndo(),canRedo:()=>e&&e.canRedo()})}_isComponentGraphic(e){const{activeComponent:t}=this;return!(!e||o(t))&&(!(!e.attributes||!e.attributes.esriSketchTool)||("box"===t.type||"reshape"===t.type)&&t.isUIGraphic(e))}_snap(e,t,i){i&&this._snapLastVertexToAxis(t),"polygon"===e&&this._snapLastPolygonVertexToFirst(t)}_snapLastPolygonVertexToFirst(e){if(e.length<=2)return;const t=e[0],i=e[e.length-1],o=this.view.toScreen(new c(t[0],t[1],this.view.spatialReference)),r=this.view.toScreen(new c(i[0],i[1],this.view.spatialReference));this._isWithinScreenDistance(o,r,this._getVertexIntersectDistance())&&(i[0]=t[0],i[1]=t[1])}_getVertexIntersectDistance(){return this.vertexSymbol&&"simple-marker"===this.vertexSymbol.type?v(this.vertexSymbol.size)/2+3:3}_isWithinScreenDistance(e,t,i){const o=e.x-t.x,r=e.y-t.y;return Math.sqrt(o*o+r*r)<=i}_snapLastVertexToAxis(e){if(e.length<2)return;const t=e.pop(),i=e[e.length-1],o=F(this.view,i),r=o.mapToLocal(i),a=o.mapToLocal(t),s=Math.abs(a.x-r.x),n=Math.abs(a.y-r.y),p=o.localToMap(K(s>n?a.x:r.x,s>n?r.y:a.y));e.push(p)}_displayPointerCursor(){this.view&&this.view.container&&"pointer"!==this.view.cursor&&(this.view.cursor="pointer")}_displayGrabbingCursor(){this.view&&this.view.container&&"grabbing"!==this.view.cursor&&(this.view.cursor="grabbing")}_displayCrosshairCursor(){this.view&&this.view.container&&"crosshair"!==this.view.cursor&&(this.view.cursor="crosshair")}_displayDefaultCursor(){this.view&&this.view.container&&null!==this.view.cursor&&(this.view.cursor=null)}_logError(e,t,i){N.error(new p(e,t,i))}async _requireModule(e){const t=new AbortController;this._moduleLoaderAbortController=t;const i=await e;return this._moduleLoaderAbortController!==t||t.signal.aborted?{requireError:"aborted"}:{module:i}}_emitUndoEvent(e){this.emit("undo",{...e,type:"undo"})}_emitRedoEvent(e){this.emit("redo",{...e,type:"redo"})}_emitDeleteEvent(e){this.emit("delete",{...e,type:"delete"})}createPointFromVertex(e){return e.length>2?new c(e[0],e[1],e[2],this.view.spatialReference):new c(e[0],e[1],this.view.spatialReference)}test(){return this._operationHandle}wait(){return E(this,"updating")}_beginAsyncOperation(){this._numUpdating+=1,this.notifyChange("updating")}_endAsyncOperation(){this._numUpdating-=1,this.notifyChange("updating")}_disablePopupEnabled(e){var t;return"3d"!==(null==(t=this.view)?void 0:t.type)||this.updateOnGraphicClick||e.toggleToolOnClick}_disablePopup(e){if(!this._disablePopupEnabled(e))return;const t=this.view.popup;t&&o(this._originalAutoOpenEnabled)&&(this._originalAutoOpenEnabled=t.autoOpenEnabled,t.autoOpenEnabled=!1)}_restorePopup(e){if(!this._disablePopupEnabled(e))return;const i=this.view.popup;i&&t(this._originalAutoOpenEnabled)&&(i.autoOpenEnabled=this._originalAutoOpenEnabled,this._originalAutoOpenEnabled=null)}};function X(e,i){const o=e.history.undo.pop().updates,r=[];i.forEach(((e,i)=>{const a=o[i],s={};null!=a&&(t(a.geometry)&&(s.geometry=e.geometry,e.geometry=a.geometry),t(a.symbol)&&(s.symbol=e.symbol,e.symbol=a.symbol),r.push(s))})),e.history.redo.push({updates:r})}function ee(e,i){const o=e.history.redo.pop().updates,r=[];i.forEach(((e,i)=>{const a=o[i],s={};null!=a&&(t(a.geometry)&&(s.geometry=e.geometry,e.geometry=a.geometry),t(a.symbol)&&(s.symbol=e.symbol,e.symbol=a.symbol),r.push(s))})),e.history.undo.push({updates:r})}function te(e){return{updates:e.map((e=>({geometry:e.geometry})))}}function ie(e){return{updates:e.map((e=>({symbol:e.symbol})))}}function oe(e){return"requireError"in e&&"aborted"===e.requireError}e([s({dependsOn:["state"],readOnly:!0})],Q.prototype,"_draw",null),e([s()],Q.prototype,"updating",null),e([s()],Q.prototype,"_operationHandle",void 0),e([s({dependsOn:["_operationHandle","_operationHandle.tool"],readOnly:!0})],Q.prototype,"activeTool",null),e([s()],Q.prototype,"activeFillSymbol",void 0),e([s()],Q.prototype,"activeLineSymbol",void 0),e([s()],Q.prototype,"activeVertexSymbol",void 0),e([s({readOnly:!0})],Q.prototype,"createGraphic",null),e([s()],Q.prototype,"defaultCreateOptions",null),e([s()],Q.prototype,"defaultUpdateOptions",null),e([s()],Q.prototype,"layer",void 0),e([s({types:_})],Q.prototype,"pointSymbol",void 0),e([s({types:_})],Q.prototype,"polygonSymbol",void 0),e([s({types:_})],Q.prototype,"polylineSymbol",void 0),e([s({dependsOn:["view.ready","layer","_operationHandle"],readOnly:!0})],Q.prototype,"state",null),e([s({readOnly:!0})],Q.prototype,"updateGraphics",void 0),e([s()],Q.prototype,"updateOnGraphicClick",void 0),e([s({types:_})],Q.prototype,"updatePointSymbol",void 0),e([s({types:_})],Q.prototype,"updatePolygonSymbol",void 0),e([s({types:_})],Q.prototype,"updatePolylineSymbol",void 0),e([s({types:_})],Q.prototype,"vertexSymbol",void 0),e([s({value:null})],Q.prototype,"view",null),e([s({type:k})],Q.prototype,"snappingOptions",void 0),e([s()],Q.prototype,"cancel",null),e([s()],Q.prototype,"complete",null),e([s()],Q.prototype,"delete",null),e([s()],Q.prototype,"create",null),e([s()],Q.prototype,"update",null),e([s()],Q.prototype,"undo",null),e([s()],Q.prototype,"redo",null),e([s()],Q.prototype,"canUndo",null),e([s()],Q.prototype,"canRedo",null),e([s()],Q.prototype,"toggleUpdateTool",null),Q=e([n("esri.widgets.Sketch.SketchViewModel")],Q);var re=Q;export default re;
