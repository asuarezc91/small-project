/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as s}from"../../../core/accessorSupport/decorators/property.js";import{subclass as t}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import{pt2px as i}from"../../../core/screenUtils.js";import{substitute as r}from"../../../intl/substitute.js";import"../../../intl.js";import a from"../../../core/Handles.js";import"../../support/widgetUtils.js";import{accessibleHandler as o}from"../../support/decorators/accessibleHandler.js";import{messageBundle as l}from"../../support/decorators/messageBundle.js";import{renderable as n}from"../../support/decorators/renderable.js";import{j as c}from"../../../chunks/index.js";import d from"../../Widget.js";import{renderSVG as h}from"../../../symbols/support/svgUtils.js";import{renderRelationshipRamp as p,getUnivariateAboveAndBelowRampElements as m,getUnivariateAboveAndBelowSizeRampSize as y,getUnivariateAboveAndBelowColorRampSize as g,getUnivariateAboveAndBelowColorRampPreview as _,getUnivariateAboveAndBelowColorRampMargin as u}from"./support/utils.js";import{getTitle as v,attachToNode as f,isImageryStretchedLegend as b}from"../support/styleUtils.js";const w="esri-legend--card__carousel-indicator--activated",x="esri-legend--card",L="esri-legend--stacked",$="esri-legend--card__carousel-title",S="esri-legend--card__carousel-indicator",k="esri-legend--card__interval-separator",I="esri-legend--card__imagery-layer-image--stretched",j="esri-legend--card__image-label",N="esri-legend--card__layer-caption",z="esri-legend--card__label-element",C="esri-legend--card__layer-row",E="esri-legend--card__label-cell",F="esri-legend--card__message",A="esri-legend--card__ramp-label",T="esri-legend--card__section",R="esri-legend--card__relationship-section",U="esri-legend--card__service-caption-text",M="esri-legend--card__service-content",B="esri-legend--card__service",O="esri-legend--card__group-layer",D="esri-legend--card__group-layer-child",P="esri-legend--card__symbol",H="esri-legend--card__size-ramp-row",W="esri-legend--card__symbol-row",Z="esri-legend--card__symbol-cell",q="esri-legend--card__carousel-indicator-container",G="esri-legend--card__interval-separators-container",J="esri-legend--card__relationship-label-container",K="esri-legend--card__label-container",Q="esri-legend--card__service-caption-container",V="esri-legend--card__symbol-container",X="esri-legend--card__size-ramp-container",Y="esri-legend--card__size-ramp-preview",ee="esri-legend__size-ramp--horizontal",se="esri-legend__ramp-labels",te="esri-legend__layer-cell esri-legend__layer-cell--info",ie="esri-univariate-above-and-below-ramp__color--card",re="esri-widget__heading",ae="esri-legend--card__",oe=window.devicePixelRatio;let le=class extends d{constructor(e,s){super(e,s),this._handles=new a,this._hasIndicators=!1,this._selectedSectionName=null,this._sectionNames=[],this._sectionMap=new Map,this.activeLayerInfos=null,this.layout="stack",this.messages=null,this.messagesCommon=null,this.type="card",this.view=null}initialize(){this.own([this.watch("activeLayerInfos",(e=>{this._handles.removeAll(),this._watchForSectionChanges(e)}))])}destroy(){this._handles.destroy(),this._handles=null}render(){this._hasIndicators="auto"===this.layout&&this.view.container.clientWidth<=768||"stack"===this.layout;const e=this.activeLayerInfos,s=e&&e.toArray().map((e=>this._renderLegendForLayer(e))).filter((e=>!!e));this._hasIndicators?this._selectedSectionName&&-1!==this._sectionNames.indexOf(this._selectedSectionName)||(this._selectedSectionName=this._sectionNames&&this._sectionNames[0]):this._selectedSectionName=null;const t=this._sectionNames.length,i=this._sectionNames.map(((e,s)=>{const i=r(this.messagesCommon.pagination.pageText,{index:s+1,total:t});return c("div",{key:e,"aria-label":i,title:i,tabIndex:0,onclick:this._selectSection,onkeydown:this._selectSection,bind:this,class:this.classes(S,{[w]:this._selectedSectionName===e}),"data-section-name":e})})),a=this._hasIndicators&&t>1?c("div",{class:q,key:"carousel-navigation"},i):null,o=this._hasIndicators?this._sectionMap.get(this._selectedSectionName):s&&s.length?s:null,l={[L]:this._hasIndicators};return c("div",{class:this.classes(x,l)},a,o||c("div",{class:F},this.messages.noLegend))}_selectSection(e){const s=e.target.getAttribute("data-section-name");s&&(this._selectedSectionName=s)}_watchForSectionChanges(e){if(this._generateSectionNames(),e){e.forEach((e=>{const s=`activeLayerInfo-${e.layer.uid}-version-change`;this._handles.remove(s),this._watchForSectionChanges(e.children),this._handles.add(e.watch("version",(()=>this._generateSectionNames())),s)}));const s="activeLayerInfos-collection-change";this._handles.remove(s),this._handles.add(e.on("change",(()=>this._watchForSectionChanges(e))),s)}}_generateSectionNames(){this._sectionNames.length=0,this.activeLayerInfos&&this.activeLayerInfos.forEach(this._generateSectionNamesForActiveLayerInfo,this)}_generateSectionNamesForActiveLayerInfo(e){e.children.forEach(this._generateSectionNamesForActiveLayerInfo,this),e.legendElements&&e.legendElements.forEach(((s,t)=>{this._sectionNames.push(`${ae}${e.layer.uid}-type-${s.type}-${t}`)}))}_renderLegendForLayer(e){if(!e.ready)return null;if(e.children.length){const s=e.children.map((e=>this._renderLegendForLayer(e))).toArray();return c("div",{key:e.layer.uid,class:this.classes(B,O)},c("div",{class:Q},e.title),s)}{const s=e.legendElements;if(s&&!s.length)return null;const t=s.some((e=>"relationship-ramp"===e.type)),i=s.map(((s,i)=>this._renderLegendForElement(s,e,i,t))).filter((e=>!!e));if(!i.length)return null;const r={[D]:!!e.parent};return c("div",{key:e.layer.uid,class:this.classes(B,r)},c("div",{class:Q},c("div",{class:U},e.title)),c("div",{class:M},i))}}_renderLegendForElement(e,s,t,i=!1){const r="color-ramp"===e.type,a="opacity-ramp"===e.type,o="size-ramp"===e.type,l=s.layer,n=e.title;let d=null;if("string"==typeof n)d=n;else if(n){const e=v(this.messages,n,r||a);d=n.title?`${n.title} (${e})`:e}const h=`${ae}${l.uid}-type-${e.type}-${t}`,m=this._hasIndicators?c("div",null,c("h3",{class:this.classes(re,$)},s.title),c("h4",{class:this.classes(re,N)},d)):d?c("h4",{class:this.classes(re,N)},d):null;let y=null;if("symbol-table"===e.type){const t=e.infos.map(((t,i)=>this._renderLegendForElementInfo(t,s,e.legendType,i))).filter((e=>!!e));if(t.length){const e=t[0].properties.classes&&t[0].properties.classes[W],s={[K]:!e&&!i,[J]:i};y=c("div",{key:h,class:T},m,c("div",{class:this.classes(s)},t))}}else"color-ramp"===e.type||"opacity-ramp"===e.type||"heatmap-ramp"===e.type?y=c("div",{key:h,class:T},m,this._renderLegendForRamp(e,l.opacity)):o?y=c("div",{key:h,class:T},m,this._renderSizeRamp(e,l.opacity)):"relationship-ramp"===e.type?y=c("div",{key:h,class:this.classes(T,R)},m,p(e,this.id,l.opacity)):"univariate-above-and-below-ramp"===e.type&&(y=c("div",{key:h,class:T},m,this._renderUnivariateAboveAndBelowRamp(e,l.opacity)));return y?(this._sectionMap.set(h,y),y):null}_renderUnivariateAboveAndBelowRamp(e,s){const{sizeRampElement:t,colorRampElement:i}=m(e,s,"horizontal"),r=y(t,"full","horizontal"),a=g(t,"above","horizontal"),o=g(t,"below","horizontal"),l=_(i,{width:a,height:12,rampAlignment:"horizontal",opacity:s,type:"above"}),n=_(i,{width:o,height:12,rampAlignment:"horizontal",opacity:s,type:"below"}),d=u(t,"card"),h=t.infos.map((e=>e.label)).map(((e,s)=>0===s||4===s?c("div",{key:s},e):null)),p={marginTop:"3px",marginLeft:`${d}px`,display:"flex"},v={width:`${r}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return c("div",{class:C,key:"size-ramp-preview",styles:{display:"flex",flexDirection:"column"}},c("div",{class:this.classes(V,ee),styles:{display:"flex",flexDirection:"row"}},t.infos.map(((e,s)=>c("div",{key:s,class:P,bind:e.preview,afterCreate:f})))),l?c("div",{class:ie,styles:p,key:"color-ramp-preview"},c("div",{bind:l,afterCreate:f}),c("div",{bind:n,afterCreate:f})):null,c("div",{class:te},c("div",{class:se,styles:v},h)))}_renderLegendForElementInfo(e,s,t,i){const r=s.layer;if(e.type)return this._renderLegendForElement(e,s,i);const a=b(r,t);if(e.preview){var o,l;if(-1===e.symbol.type.indexOf("simple-fill")){if(!e.label)return c("div",{key:i,bind:e.preview,afterCreate:f});const s={[Z]:this._hasIndicators};return c("div",{key:i,class:this.classes(C,{[W]:this._hasIndicators})},c("div",{class:this.classes(s),bind:e.preview,afterCreate:f}),c("div",{class:this.classes(j,{[E]:this._hasIndicators})},v(this.messages,e.label,!1)||""))}let s=255,t=255,a=255,n=0,d=255,h=255,p=255,m=0;const y=e.symbol.color&&e.symbol.color.a,g=e.symbol.outline&&e.symbol.outline.color&&e.symbol.outline.color.a;y&&(s=e.symbol.color.r,t=e.symbol.color.g,a=e.symbol.color.b,n=e.symbol.color.a*r.opacity),g&&(d=e.symbol.outline.color.r,h=e.symbol.outline.color.g,p=e.symbol.outline.color.b,m=e.symbol.outline.color.a*r.opacity);const _=null==(o=null==(l=e.symbol.color)?void 0:l.isBright)||o,u=_?"rgba(255, 255, 255, .6)":"rgba(0, 0, 0, .6)";return c("div",{key:i,class:C},c("div",{class:z,styles:{background:y?`rgba(${s}, ${t}, ${a}, ${n})`:"none",color:_?"black":"white",textShadow:`-1px -1px 0 ${u},\n                                              1px -1px 0 ${u},\n                                              -1px 1px 0 ${u},\n                                              1px 1px 0 ${u}`,border:g?`1px solid rgba(${d}, ${h}, ${p}, ${m})`:"none"}}," ",e.label," "))}if(e.src){const s=this._renderImage(e,r,a);return c("div",{key:i,class:C},s,c("div",{class:j},e.label||""))}}_renderImage(e,s,t){const{label:i,src:r,opacity:a}=e,o={[I]:t,[P]:!t},l={opacity:`${null!=a?a:s.opacity}`};return c("img",{alt:v(this.messages,i,!1),src:r,border:0,width:e.width,height:e.height,class:this.classes(o),styles:l})}_renderSizeRampLines(e){const s=e.infos,t=s[0],r=s[s.length-1],a=t.symbol,o=this._hasIndicators,l=i(t.size+t.outlineSize)*oe,n=i(r.size+r.outlineSize)*oe,d=o?l:l+50*oe,h=o?l/2+50*oe:l,p=function(e){if(e){if(e.type.indexOf("3d")>-1){const s=e.symbolLayers&&e.symbolLayers.length;if(!s)return;const t=e.symbolLayers.getItemAt(s-1).get("resource.primitive");return"triangle"===t||"cone"===t||"tetrahedron"===t}return"triangle"===e.style}}(a),m=function(e){if(e){if(e.type.indexOf("3d")>-1){const s=e.symbolLayers&&e.symbolLayers.length;if(!s)return;const t=e.symbolLayers.getItemAt(s-1),i=t.resource&&t.resource.primitive;return"circle"===i||"cross"===i||"kite"===i||"sphere"===i||"cube"===i||"diamond"===i}{const s=e.style;return"circle"===s||"diamond"===s||"cross"===s}}}(a),y=document.createElement("canvas");y.width=d,y.height=h,y.style.width=y.width/oe+"px",y.style.height=y.height/oe+"px";const g=y.getContext("2d");if(o){g.beginPath();const e=0,s=0,t=d/2-n/2,i=h;g.moveTo(e,s),g.lineTo(t,i);const r=d,a=0,o=d/2+n/2,l=h;g.moveTo(r,a),g.lineTo(o,l)}else{g.beginPath();const e=0,s=h/2-n/2,t=d,i=0;g.moveTo(e,s),g.lineTo(t,i);const r=0,a=h/2+n/2,o=d,l=h;g.moveTo(r,a),g.lineTo(o,l)}return g.strokeStyle="#ddd",g.stroke(),c("div",{bind:y,afterCreate:f,styles:o?{display:"flex",marginTop:`-${p?0:m?l/2:0}px`,marginBottom:`-${p?n:m?n/2:0}px`}:{display:"flex",marginRight:`-${p?0:m?l/2:0}px`,marginLeft:`-${p?0:m?n/2:0}px`}})}_renderSizeRamp(e,s){const t=e.infos,i=t[0].label,r=t[t.length-1].label;let a=t[0].preview,o=t[t.length-1].preview;const l=this._hasIndicators,n={"flex-direction":l?"column":"row-reverse"};a&&(a=a.cloneNode(!0),a.style.display="flex"),o&&(o=o.cloneNode(!0),o.style.display="flex");const d={opacity:null!=s?`${s}`:""};return c("div",{class:this.classes(C,{[H]:l})},c("div",{class:A},l?i:r),c("div",{class:X,styles:n},c("div",{bind:a,afterCreate:f,class:Y,styles:d}),this._renderSizeRampLines(e),c("div",{bind:o,afterCreate:f,class:X,styles:d})),c("div",{class:A},l?r:i))}_renderLegendForRamp(e,s){const t=e.infos,i="heatmap-ramp"===e.type,r=t.length-1,a=25,o=r>2&&!i?25*r:100,l=o+20,n=10,d=t.slice(0).reverse();d.forEach(((e,s)=>{e.offset=i?e.ratio:s/r}));const p=d.length-1,m=d.length%2!=0&&d[d.length/2|0],y=m&&c("div",{class:G},c("div",{class:k},"|"),c("div",{class:A},m.label)),g=t[t.length-1].label,_=t[0].label;let u=null;null!=s&&(u=`opacity: ${s}`);const v=[[{shape:{type:"path",path:"M0 12.5 L10 0 L10 25 Z"},fill:d[0].color,stroke:{width:0}},{shape:{type:"rect",x:n,y:0,width:o,height:a},fill:{type:"linear",x1:n,y1:0,x2:o+n,y2:0,colors:d},stroke:{width:0}},{shape:{type:"path",path:`M${o+n} 0 L${l} 12.5 L${o+n} 25 Z`},fill:d[p].color,stroke:{width:0}}]],f=h(v,l,a),{messages:b}=this;return c("div",{class:C},c("div",{class:A},i?b[g]:g),c("div",{class:V},c("div",{style:u},f),y),c("div",{class:A},i?b[_]:_))}};e([n(),s()],le.prototype,"activeLayerInfos",void 0),e([s()],le.prototype,"layout",void 0),e([s(),n(),l("esri/widgets/Legend/t9n/Legend")],le.prototype,"messages",void 0),e([s(),n(),l("esri/t9n/common")],le.prototype,"messagesCommon",void 0),e([s({readOnly:!0})],le.prototype,"type",void 0),e([s()],le.prototype,"view",void 0),e([o()],le.prototype,"_selectSection",null),le=e([t("esri.widgets.Legend.styles.Card")],le);var ne=le;export default ne;
