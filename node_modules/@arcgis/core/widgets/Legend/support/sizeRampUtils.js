/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{all as e}from"../../../core/promiseUtils.js";import l from"../../../Color.js";import{i as t}from"../../../chunks/symbols.js";import{applyCIMSymbolColor as s}from"../../../symbols/support/cimSymbolUtils.js";import{isVolumetricSymbol as n,getSymbolOutlineSize as o}from"../../../symbols/support/utils.js";import{round as i,numDigits as r,percentChange as a}from"../../../renderers/support/numberUtils.js";import{getUnivariateAboveAndBelowStopValues as u,createStopLabel as c}from"./utils.js";const m=30,p=12,f=[255,255,255],y=[200,200,200],b=[128,128,128];async function h(l,s,r,a,m,p){const f=s.legendOptions,y=f&&f.customValues,b=function(e,l){let s=null,n=null;if("simple"===e.type)s=e.symbol;else if("class-breaks"===e.type){const l=e.classBreakInfos;s=l&&l[0]&&l[0].symbol,n=l.length>1}else if("unique-value"===e.type){const l=e.uniqueValueInfos;s=l&&l[0]&&l[0].symbol,n=l.length>1}if(!s||function(e){if(e){if(t(e)){return!!e.symbolLayers&&e.symbolLayers.some((e=>e&&"fill"===e.type))}return-1!==e.type.indexOf("fill")}return!1}(s))return null;s=s.clone(),(l||n)&&(s.type.indexOf("3d")>-1?d(s):v(s));return s}(l,r),h=!!b,S=!!y,z=null!=s.minSize&&null!=s.maxSize,x=s.stops&&s.stops.length>1,V=!!s.target;if(!h||!S&&!(z||x&&!V))return;const k=n(b);let j=null,L=null,M=null;L=k&&!x?i([s.minDataValue,s.maxDataValue]):y||await async function(e,l,t,s){const n=(await import("../../../renderers/visualVariables/support/visualVariableUtils.js")).getSizeRangeAtScale(e,t,s),o=n&&function(e){const l=e.minSize,t=e.maxSize,s=5,n=(t-l)/(s-1),o=[];for(let e=0;e<s;e++)o.push(l+n*e);return o}(n);if(!n&&!o)return;let r=o.map((l=>function(e,l,t){const s=t.minSize,n=t.maxSize,o=l.minDataValue,i=l.maxDataValue;let r=null;if(e<=s)r=o;else if(e>=n)r=i;else{r=(e-s)/(n-s)*(i-o)+o}return r}(l,e,n)));r=i(r);for(let n=1;n<r.length-1;n++){const i=await w(e,l,r[n],r[n-1],t,s);i&&(r[n]=i[0],o[n]=i[1])}return r}(s,b,a,m);const C=null==l?void 0:l.authoringInfo,O="univariate-color-size"===(null==C?void 0:C.type)&&"above-and-below"===(null==C?void 0:C.univariateTheme);if(!L&&x&&(L=O?u(s,C):s.stops.map((e=>e.value)),j=s.stops.some((e=>!!e.label)),j&&(M=s.stops.map((e=>e.label)))),k&&L&&L.length>2&&(L=[L[0],L[L.length-1]]),!L)return null;const U=[12,30],D=o(b),I=j?null:function(e,l){const t=e.length-1;return e.map(((e,s)=>c(e,s,t,l)))}(L,p);return(await e(L.map((async(e,o)=>{const i=k?U[o]:await g(s,b,e,a,m);return{value:e,symbol:function(e,l){const s=e.clone();if(t(s))n(s)||s.symbolLayers.forEach((e=>{"fill"!==e.type&&(e.size=l)}));else if("esri.symbols.SimpleMarkerSymbol"===s.declaredClass)s.size=l;else if(function(e){return"esri.symbols.PictureMarkerSymbol"===e.declaredClass}(s)){const e=s.width,t=s.height;s.height=l,s.width=l*(e/t)}else!function(e){return"esri.symbols.SimpleLineSymbol"===e.declaredClass}(s)?function(e){return"esri.symbols.TextSymbol"===e.declaredClass}(s)&&s.font&&(s.font.size=l):s.width=l;return s}(O&&"class-breaks"===l.type?function(e,l){const t=e.classBreakInfos,s=t.length,n=l>=2,o=s<2||!n?t[0].symbol.clone():t[s-1].symbol.clone();e.visualVariables.some((e=>"color"===e.type))&&(o.type.indexOf("3d")>-1?d(o):v(o));return o}(l,o):b,i),label:j?M[o]:I[o],size:i,outlineSize:D}})))).reverse()}function d(e){n(e)||("line-3d"===e.type?e.symbolLayers.forEach((e=>{e.material={color:b}})):e.symbolLayers.forEach((e=>{"icon"!==e.type||e.resource&&e.resource.href?e.material={color:y}:(e.material={color:f},e.outline={color:b,size:1.5})})))}function v(e){"cim"===e.type?s(e,new l(y)):-1!==e.type.indexOf("line")?e.color=b:(e.color=f,"simple-marker"===e.type&&(e.outline={color:b,width:1.5}))}async function w(e,l,t,s,n,o){const u=await g(e,l,t,n,o),c=await g(e,l,s,n,o),m=r(t),p=m.fractional;let f=m.integer,y=null,b=null;t>0&&t<1&&(y=Math.pow(10,p),f=r(t*=y).integer);for(let s=f-1;s>=0;s--){const r=Math.pow(10,s);let m=Math.floor(t/r)*r,p=Math.ceil(t/r)*r;null!=y&&(m/=y,p/=y);let f=(m+p)/2;[,f]=i([m,f,p],{indexes:[1]});const h=await g(e,l,m,n,o),d=await g(e,l,p,n,o),v=await g(e,l,f,n,o),w=a(u,h,c,null),S=a(u,d,c,null),z=a(u,v,c,null);let x=w.previous<=20,V=S.previous<=20;if(x&&V&&(w.previous<=S.previous?(x=!0,V=!1):(V=!0,x=!1)),x?b=[m,h]:V?b=[p,d]:z.previous<=20&&(b=[f,v]),b)break}return b}async function g(e,l,t,s,n){const{getSize:o}=await import("../../../renderers/visualVariables/support/visualVariableUtils.js");return o(e,t,{scale:s,view:n,shape:"simple-marker"===l.type?l.style:null})}export{m as REAL_WORLD_MAX_SIZE,p as REAL_WORLD_MIN_SIZE,h as getRampStops};
