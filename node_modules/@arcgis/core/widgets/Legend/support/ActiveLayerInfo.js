/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import{unwrap as t,isSome as s}from"../../../core/maybe.js";import l from"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as r}from"../../../core/accessorSupport/decorators/property.js";import{JSONMap as i}from"../../../core/jsonMap.js";import{subclass as n}from"../../../core/accessorSupport/decorators/subclass.js";import{objectToQuery as a}from"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import{eachAlways as o,resolve as u,reject as c,all as d}from"../../../core/promiseUtils.js";import y from"../../../core/Accessor.js";import h from"../../../core/Collection.js";import{isDateField as m}from"../../../layers/support/fieldUtils.js";import p from"../../../Color.js";import{px2pt as f}from"../../../core/screenUtils.js";import{addTokenParameter as g}from"../../../kernel.js";import b from"../../../request.js";import S from"../../../symbols/SimpleFillSymbol.js";import _ from"../../../symbols/SimpleMarkerSymbol.js";import"../../../chunks/symbols.js";import v from"../../../core/Handles.js";import{on as w,init as L,watch as E}from"../../../core/watchUtils.js";import C from"../../../renderers/visualVariables/support/SizeVariableLegendOptions.js";import{applyCIMSymbolColor as I}from"../../../symbols/support/cimSymbolUtils.js";import{isVolumetricSymbol as R}from"../../../symbols/support/utils.js";import{fromJSON as F}from"../../../renderers/support/jsonUtils.js";import{ExportImageParameters as T}from"../../../layers/support/ExportImageParameters.js";import{renderColorRampPreviewHTML as V,renderDotDensityPreviewHTML as z,renderPreviewHTML as x}from"../../../symbols/support/symbolUtils.js";import{getClusterSizeVariable as O}from"./clusterUtils.js";import{RGB_IMG_SOURCE as D}from"./utils.js";import{getColorFromPointCloudStops as M,getRampStopsForPointCloud as j,getStrectchRampStops as k,getRampStops as B}from"./colorRampUtils.js";import{getHeatmapRampStops as U}from"./heatmapRampUtils.js";import{getRotationAngleForFocus as P,getRelationshipRampElement as A}from"./relationshipRampUtils.js";import{getRampStops as N,REAL_WORLD_MAX_SIZE as W,REAL_WORLD_MIN_SIZE as q}from"./sizeRampUtils.js";const G=l.getLogger("esri.widgets.Legend.support.ActiveLayerInfo"),$=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,J=new i({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),H={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-34e38,34e38],f64:[-Number.MAX_VALUE,Number.MAX_VALUE]},X=new _({size:6,outline:{color:[128,128,128,.5],width:.5}}),K=new S({style:"solid"});function Q(e){return"vector-field"===e.type}function Y(e){return"raster-colormap"===e.type}function Z(e){return"raster-stretch"===e.type}function ee(e){return"raster-shaded-relief"===e.type}function te(e){return"esri.renderers.SimpleRenderer"===e.declaredClass}function se(e){return"esri.renderers.ClassBreaksRenderer"===e.declaredClass}function le(e){return"esri.renderers.UniqueValueRenderer"===e.declaredClass}function re(e){return"esri.renderers.HeatmapRenderer"===e.declaredClass}function ie(e){return"esri.renderers.PointCloudClassBreaksRenderer"===e.declaredClass}function ne(e){return"esri.renderers.PointCloudStretchRenderer"===e.declaredClass}function ae(e){return"esri.renderers.PointCloudUniqueValueRenderer"===e.declaredClass}function oe(e){return"esri.renderers.DotDensityRenderer"===e.declaredClass}function ue(e){return"esri.layers.BuildingSceneLayer"===e.declaredClass}function ce(e){return"esri.layers.MapImageLayer"===e.declaredClass}function de(e){return"esri.layers.ImageryLayer"===e.declaredClass}function ye(e){return"esri.layers.WCSLayer"===e.declaredClass}const he=new _({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}});let me={},pe=class extends y{constructor(e){super(e),this._handles=new v,this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._webStyleSymbolCache=new Map,this._dotDensityUrlCache=new Map,this._scaleDrivenSizeVariable=null,this._hasClusterSizeVariable=!1,this.children=new h,this.layerView=null,this.layer=null,this.legendElements=[],this.parent=null,this.keepCacheOnDestroy=!1,this.respectLayerVisibility=!0,this.sublayerIds=[],this.title=null,this.view=null}initialize(){const e=()=>this.notifyChange("ready");this._handles.add([w(this,"children","change",(t=>{const{added:s,removed:l}=t,r=this._handles;s.map((t=>{const s=`activeLayerInfo-ready-watcher-${t.layer.uid}`;r.add(L(t,"ready",e),s)})),l.forEach((e=>r.remove(e.layer.uid))),e()}))]),this.keepCacheOnDestroy||(me={})}destroy(){this._handles.destroy(),this._handles=null,this._webStyleSymbolCache=null,this._dotDensityUrlCache=null,this._scaleDrivenSizeVariable=null,this.keepCacheOnDestroy||(me=null)}get opacity(){var e;const t=this.layer.opacity,s=null==(e=this.parent)?void 0:e.opacity,l=this.layer.parent,r=l&&"uid"in l?this._getParentLayerOpacity(l):null;return null!=s?s*t:null!=r?r*t:t}get ready(){return null===this.layer||(this.children.length>0?this._isGroupActive():this.legendElements.length>0)}get scale(){return this.view&&this.view.scale}get isScaleDriven(){const e=this.layer;if(null===e)return!1;if("featureReduction"in e&&e.featureReduction&&"cluster"===e.featureReduction.type)return!0;if("renderer"in e&&e.renderer){if("dot-density"===e.renderer.type)return!0;const t=e.get("renderer.valueExpression");if($.test(t))return!0;const s=e.get("renderer.visualVariables");if(s)return s.some((e=>this._isScaleDrivenSizeVariable(e)))}return this._isLayerScaleDriven(this.layer)}get version(){return this._get("version")+1}async buildLegendElementsForFeatureCollections(e){const t=e.map((e=>{if("esri.layers.FeatureLayer"===e.declaredClass)return this._getRendererLegendElements(e.renderer,{title:e.title});if(e.featureSet&&e.featureSet.features.length){const t=e.layerDefinition,s=t&&t.drawingInfo,l=s&&F(s.renderer),r=J.read(t.geometryType);return l?this._getRendererLegendElements(l,{title:e.name,geometryType:r}):(G.warn("drawingInfo not available!"),null)}return null}));try{const e=[];await o(t).then((t=>{t.forEach((({value:t})=>t&&e.push(...t)))})),this.legendElements=e,this.notifyChange("ready")}catch(e){G.warn("error while building legend for layer!",e)}}async buildLegendElementsForRenderer(e){try{const t=await this._getRendererLegendElements(e);this.legendElements=t,this.notifyChange("ready")}catch(e){G.warn("error while building legend for layer!",e)}}async buildLegendElementsForTools(){const e=this.layer;!function(e){return"esri.layers.WMTSLayer"===e.declaredClass}(e)?!function(e){return"esri.layers.WMSLayer"===e.declaredClass}(e)?ue(e)?await this._constructLegendElementsForBuildingSceneLayer():ce(e)||function(e){return"esri.layers.TileLayer"===e.declaredClass}(e)||ue(e)?await this._constructLegendElementsForSublayers():(this._handles.remove("imageryLayers-watcher"),await this._getLegendLayers().then((t=>{this.legendElements=[],t.forEach((t=>{if(de(e)){const t=e.watch(["renderingRule","bandIds"],(()=>{me.default=null,this.buildLegendElementsForTools()}));this._handles.add(t,"imageryLayers-watcher")}const s=this._generateSymbolTableElementForLegendLayer(t);s&&s.infos.length&&(de(e)&&(s.title=e.title),this.legendElements.push(s)),this.notifyChange("ready")})),this.notifyChange("ready")})).catch((e=>{G.warn("Request to server for legend has failed!",e)}))):await this._constructLegendElementsForWMSSublayers():this._constructLegendElementsForWMTSlayer()}_getParentLayerOpacity(e){let t=1;const s=e.parent;return s&&"uid"in s&&(t=this._getParentLayerOpacity(s)),e.opacity*t}_isGroupActive(){const e=this.children;return!!e.length&&e.some((e=>e.ready))}_isScaleDrivenSizeVariable(e){if(e&&"size"!==e.type)return!1;const t=e,s=t.minSize,l=t.maxSize;return"object"==typeof s&&s?this._isScaleDrivenSizeVariable(s):"object"==typeof l&&l?this._isScaleDrivenSizeVariable(l):!!t.expression||$.test(t.valueExpression)}_isLayerScaleDriven(e){if("minScale"in e&&e.minScale>0||"maxScale"in e&&e.maxScale>0)return!0;if("sublayers"in e&&e.sublayers)return e.sublayers.some((e=>this._isLayerScaleDriven(e)));const t=e.parent;if(!1===e.loaded&&t&&ce(t)&&"source"in e&&e.source&&"map-layer"===e.source.type)for(const s of t.sourceJSON.layers)if(s.id===e.source.mapLayerId&&(s.minScale>0||s.maxScale>0))return!0;return!1}_constructLegendElementsForWMTSlayer(){this.legendElements=[],this._handles.remove("wmts-activeLayer-watcher");const e=this.layer.activeLayer;if(this._handles.add(E(this.layer,"activeLayer",(()=>this._constructLegendElementsForWMTSlayer())),"wmts-activeLayer-watcher"),e.styleId&&e.styles){let t=null;e.styles.some((s=>e.styleId===s.id&&(t=s.legendUrl,!0))),t&&(this.legendElements=[{type:"symbol-table",title:e.title,infos:[{src:t,opacity:this.opacity}]}])}this.notifyChange("ready")}async _constructLegendElementsForWMSSublayers(){this.legendElements=[],this._handles.remove("wms-sublayers-watcher");const e=this.layer;let t=null;(e.customParameters||e.customLayerParameters)&&(t={...e.customParameters,...e.customLayerParameters}),this._handles.add(E(this.layer,"sublayers",(()=>this._constructLegendElementsForWMSSublayers())),"wms-sublayers-watcher"),this.legendElements=await this._generateLegendElementsForWMSSublayers(e.sublayers,t),this.notifyChange("ready")}async _generateLegendElementsForWMSSublayers(e,t){const s=[];this._handles.add(e.on("change",(()=>this._constructLegendElementsForWMSSublayers())),"wms-sublayers-watcher");const l=e.toArray();for(const e of l){const l=e.watch(["title","visible","legendEnabled"],(()=>this._constructLegendElementsForWMSSublayers()));if(this._handles.add(l,"wms-sublayers-watcher"),e.visible&&e.legendEnabled){const l=await this._generateSymbolTableElementForWMSSublayer(e,t);l&&l.infos.length&&s.unshift(l)}}return s}async _generateSymbolTableElementForWMSSublayer(e,t){if(!e.legendUrl&&e.sublayers){const s=(await this._generateLegendElementsForWMSSublayers(e.sublayers,t)).filter((e=>e));return{type:"symbol-table",title:e.title,infos:s}}return this._generateSymbolTableElementForLegendUrl(e,t)}async _generateSymbolTableElementForLegendUrl(e,t){var s;let l=e.legendUrl;if(!l)return;const r={type:"symbol-table",title:e.title||e.name||e.id&&e.id+"",infos:[]};t&&(l+="?"+a(t));let i=null;const n=null==(s=e.layer)?void 0:s.opacity;try{i=(await b(l,{responseType:"image"})).data,i&&(i.style.opacity=n)}catch{}return r.infos.push({src:l,preview:i,opacity:n}),r}_getLegendLayers(e){const t=e&&e.hasDynamicLayers?e.dynamicLayers:null,s=t||"default",l=me&&me[s];return l?u(l):this._legendRequest(t).then((e=>{const t=e.layers;return me[s]=t,t}))}_legendRequest(e){const t=this.layer;let s={f:"json",dynamicLayers:e};if(de(t)){const e=t.exportImageServiceParameters.renderingRule;if(e&&(s.renderingRule=JSON.stringify(e.toJSON())),t.bandIds&&(s.bandIds=t.bandIds.join()),t.raster||t.viewId){const{raster:e,viewId:l}=t;s={raster:e,viewId:l,...s}}}let l=t.url.replace(/(\/)+$/,"");if("version"in t&&t.version>=10.01){const e=l.indexOf("?");e>-1?l=l.substring(0,e)+"/legend"+l.substring(e):l+="/legend"}else{const e=l.toLowerCase().indexOf("/rest/"),t=l.substring(0,e)+l.substring(e+5,l.length);l="https://utility.arcgis.com/sharing/tools/legend?soapUrl="+encodeURI(t)+"&returnbytes=true"}return b(l,{query:s}).then((e=>e.data))}async _constructLegendElementsForBuildingSceneLayer(){this.legendElements=[],this._handles.remove("sublayers-watcher");const e=this.layer;this._handles.add(E(e,"sublayers",(()=>this._constructLegendElementsForBuildingSceneLayer())),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForBuildingSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(e){G.warn("Request to server for legend has failed!",e)}}async _generateLegendElementsForBuildingSublayers(e,t){let s=[];this._handles.add(e.on("change",(()=>this._constructLegendElementsForBuildingSceneLayer())),"sublayers-watcher");const l=e.toArray();for(const e of l){const l=e.watch(["renderer","opacity","title","visible"],(()=>this._constructLegendElementsForBuildingSceneLayer()));if(this._handles.add(l,"sublayers-watcher"),e.visible){const l=e&&null!=e.opacity?e.opacity:null,r=null!=l?l*t:t;if("building-group"===e.type){const t={type:"symbol-table",title:e.title,infos:[]},l=await this._generateLegendElementsForBuildingSublayers(e.sublayers,r);t.infos.push(...l),s=[t,...s]}else if(e.renderer){s=[...await this._getRendererLegendElements(e.renderer,{title:e.title,opacity:r,sublayer:e}),...s]}}}return s.filter((e=>!!e&&(!("infos"in e)||e.infos.length>0)))}async _constructLegendElementsForSublayers(){this.legendElements=[],this._handles.remove("sublayers-watcher");const e=this.layer;this._handles.add(E(e,"sublayers",(()=>this._constructLegendElementsForSublayers)),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(e){G.warn("Request to server for legend has failed!",e)}}async _generateLegendElementsForSublayers(e,t,s){let l=[];this._handles.add(e.on("change",(()=>this._constructLegendElementsForSublayers())),"sublayers-watcher");let r=e.toArray();if(!s&&this.sublayerIds&&this.sublayerIds.length){const e=this.layer;r=this.sublayerIds.map((t=>e.findSublayerById(t))).filter(Boolean)}const i=new T({layer:this.layer}),n=i.hasDynamicLayers&&i.dynamicLayers||"default";i.destroy();for(const e of r){const r=e.watch("renderer, opacity, title, visible, legendEnabled",((t,l,r)=>{var i;const a=me&&me[n];a&&!s&&(s=new Map,a.forEach((e=>s.set(e.layerId,e))));const o=null==(i=s)?void 0:i.get(e.id);("renderer"!==r||e.originIdOf("renderer")>2||!o)&&this._constructLegendElementsForSublayers()}));if(this._handles.add(r,"sublayers-watcher"),e.visible&&e.legendEnabled){const r=e&&null!=e.opacity?e.opacity:null,i=null!=r?r*t:t;if(e.renderer&&!e.sublayers&&e.originIdOf("renderer")>2){if(!this.respectLayerVisibility||this._isSublayerInScale(e)){await e.load();l=[...await this._getRendererLegendElements(e.renderer,{title:e.title,opacity:i,sublayer:e}),...l]}}else{const t=await this._generateSymbolTableElementForSublayer(e,i,s);t&&l.unshift(t)}}}return l.filter((e=>!!e&&(!("infos"in e)||e.infos.length>0)))}async _generateSymbolTableElementForSublayer(e,t,s){if(!s){s=new Map;const e=new T({layer:this.layer});try{(await this._getLegendLayers(e)).forEach((e=>s.set(e.layerId,e)))}finally{e.destroy()}}const l=s.get(e.id);if(!l&&e.sublayers){const l=await this._generateLegendElementsForSublayers(e.sublayers,t,s);return{type:"symbol-table",title:e.title,infos:l}}return this._generateSymbolTableElementForLegendLayer(l,e,t)}_generateSymbolTableElementForLegendLayer(e,t,s){if(!e||!e.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(e,t))return null;const l=t&&t.renderer;let r=t&&t.title||e.layerName;if(l){const e=t&&t.title||this._getRendererTitle(l,t);e&&(r&&"string"!=typeof e&&"title"in e&&(e.title=r),r=e)}const i={type:"symbol-table",title:r,infos:[]};e.legendType&&(i.legendType=e.legendType);const n=t?this._sanitizeLegendForSublayer(e.legend.slice(),t):e.legend;return i.infos=n.map((t=>{let l=t.url;if(t.imageData&&t.imageData.length>0)l=`data:image/png;base64,${t.imageData}`;else{if(0===l.indexOf("http"))return null;l=g(`${this.layer.url}/${e.layerId}/images/${l}`)}return{label:t.label,src:l,opacity:null==s?this.opacity:s,width:t.width,height:t.height}})).filter((e=>!!e)),i.infos.length?i:null}_isSublayerInScale(e){const t=e.minScale||0,s=e.maxScale||0;return!(t>0&&t<this.scale||s>this.scale)}_isLegendLayerInScale(e,t){const s=t||this.layer;let l=null,r=null,i=!0;return!s.minScale&&0!==s.minScale||!s.maxScale&&0!==s.maxScale?(0===e.minScale&&s.tileInfo&&(l=s.tileInfo.lods[0].scale),0===e.maxScale&&s.tileInfo&&(r=s.tileInfo.lods[s.tileInfo.lods.length-1].scale)):(l=Math.min(s.minScale,e.minScale)||s.minScale||e.minScale,r=Math.max(s.maxScale,e.maxScale)),(l>0&&l<this.scale||r>this.scale)&&(i=!1),i}_sanitizeLegendForSublayer(e,t){if("version"in this.layer&&this.layer.version<10.1||0===e.length)return e;const s=t.renderer,l=e.some((e=>e.values));let r=null,i=null;return l&&e.some(((e,t)=>(e.values||(r=t,i=e,i.label||(i.label="others")),null!=i))),s?"unique-value"===s.type?i&&(e.splice(r,1),e.push(i)):"class-breaks"===s.type&&(i&&e.splice(r,1),e.reverse(),i&&e.push(i)):i&&(e.splice(r,1),e.push(i)),e}async _getRendererLegendElements(e,t={}){return function(e){return te(e)||se(e)||le(e)||Z(e)||Y(e)||re(e)||ie(e)||ne(e)||ae(e)||oe(e)||Q(e)||ee(e)}(e)?function(e){return ie(e)||ne(e)||ae(e)||function(e){return"esri.renderers.PointCloudRGBRenderer"===e.declaredClass}(e)}(e)?this._constructPointCloudRendererLegendElements(e,t):oe(e)?this._constructDotDensityRendererLegendElements(e):this._constructRendererLegendElements(e,t):(G.warn("Renderer not supported!"),[])}_getPointCloudRendererTitle(e){return e.legendOptions&&e.legendOptions.title||e.field}_constructPointCloudRendererLegendElements(e,t={}){const s=t.title,l=[];let r=null,i=null;if(ie(e))r={type:"symbol-table",title:s||this._getPointCloudRendererTitle(e),infos:[]},e.colorClassBreakInfos.forEach((e=>{r.infos.unshift({label:e.label||e.minValue+" - "+e.maxValue,value:[e.minValue,e.maxValue],symbol:this._getAppliedCloneSymbol(X,e.color)})}));else if(ne(e)){const t=e.stops;let l=null;if(t.length&&(1===t.length&&(l=t[0].color),!l)){const e=t[0].value,s=t[t.length-1].value;if(null!=e&&null!=s){l=M(e+(s-e)/2,t)}}r={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(X,l||X.color)}]};const n=j(e.stops);i={type:"color-ramp",title:s||this._getPointCloudRendererTitle(e),infos:n,preview:V(n.map((e=>e.color)))}}else ae(e)&&(r={type:"symbol-table",title:s||this._getPointCloudRendererTitle(e),infos:[]},e.colorUniqueValueInfos.forEach((e=>{r.infos.push({label:e.label||e.values.join(", "),value:e.values.join(", "),symbol:this._getAppliedCloneSymbol(X,e.color)})})));r&&r.infos.length&&l.push(r),i&&i.infos.length&&l.push(i);const n=l.reduce(((e,t)=>e.concat(t.infos)),[]).filter((e=>!!e.symbol)).map((t=>this._getSymbolPreview(t,this.opacity,{symbolConfig:{applyColorModulation:!!e.colorModulation}})));return o(n).then((()=>l))}_getElementInfoForDotDensity(e,t){const{backgroundColor:s,outline:l,dotSize:r}=e,i=r+"-"+t+"-"+s+"-"+(l&&JSON.stringify(l.toJSON())),n=this._dotDensityUrlCache,a=n.has(i)?n.get(i):z(e,t);return n.set(i,a),{opacity:1,src:a.src,preview:a,width:a.width,height:a.height}}_constructDotDensityRendererLegendElements(e){const t=e.calculateDotValue(this.view.scale),s=e.legendOptions&&e.legendOptions.unit,l={type:"symbol-table",title:{value:t&&Math.round(t),unit:s||""},infos:[]};return e.attributes.forEach((t=>{const s=this._getElementInfoForDotDensity(e,t.color);s.label=t.label||t.valueExpressionTitle||t.field,l.infos.push(s)})),u([l])}async _constructRendererLegendElements(e,s={}){const{title:l,sublayer:r}=s,i=r||this.layer;let n=await this._loadRenderer(e);this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._scaleDrivenSizeVariable=null;const a=await this._getVisualVariableLegendElements(n,i)||[],u={type:"symbol-table",title:l||this._getRendererTitle(n,i),infos:[]};let c=null,d=!1;const y=new Set;if(function(e){const t="authoringInfo"in e&&(null==e?void 0:e.authoringInfo);return"univariate-color-size"===(null==t?void 0:t.type)&&"above-and-below"===(null==t?void 0:t.univariateTheme)}(n)){const e={type:"univariate-above-and-below-ramp",title:l,infos:[]},t=a.findIndex((e=>"color-ramp"===e.type)),s=a.splice(t,1)[0],r=a.findIndex((e=>"size-ramp"===e.type)),i=a.splice(r,1)[0];s&&(e.title=s.title,e.infos.push(s)),i&&(e.title=i.title,e.infos.push(i)),a.push(e)}else if(re(n)){const e=U(n);a.push({type:"heatmap-ramp",title:l,infos:e,preview:V(e.map((e=>e.color)))})}else if(le(n)){const e=n&&n.authoringInfo;if(e&&"relationship"===e.type){const{focus:t,numClasses:s,field1:l,field2:r}=e;if(s&&l&&r){const e=[l,r];let o=P(t)||0;for(const t of e){const{field:e,normalizationField:s,label:l}=t,r=l||{field:this._getFieldAlias(e,i),normField:s&&this._getFieldAlias(s,i)},n=he.clone();n.angle=o,u.infos.push({label:r,symbol:n}),y.add(n),o+=90}const c=A({focus:t,numClasses:s,infos:n.uniqueValueInfos});a.unshift(c)}}else{const e=n.field;n.uniqueValueInfos.forEach((t=>{t.symbol&&u.infos.push({label:t.label||this._getDomainName(e,t.value,i)||t.value,value:t.value,symbol:t.symbol})}))}n.defaultSymbol&&(u.infos.push({label:n.defaultLabel||"others",symbol:n.defaultSymbol}),d=!0)}else if(se(n)){c=this._isUnclassedRenderer(n);(!c||!this._hasSizeRamp)&&(n.classBreakInfos.forEach((e=>{e.symbol&&u.infos.unshift({label:e.label||(c?null:e.minValue+" - "+e.maxValue),value:[e.minValue,e.maxValue],symbol:e.symbol})})),c&&(u.title=null),this._updateInfosforClassedSizeRenderer(n,u.infos)),n.defaultSymbol&&!c&&(u.infos.push({label:n.defaultLabel||"others",symbol:n.defaultSymbol}),d=!0)}else if(Z(n))if(function(e){return"esri.layers.ImageryTileLayer"===e.declaredClass}(this.layer)||ye(this.layer)){const e=this._constructTileImageryStretchRendererElements(n);"stretch-ramp"===e.type?a.push(e):u.infos=e}else{const e=this.layer;let s,l;n.statistics&&n.statistics.length&&(s=n.statistics[0].min||n.statistics[0][0],l=n.statistics[0].max||n.statistics[0][1]);let r=[];const i=t(e.renderingRule?await e.generateRasterInfo(e.renderingRule):e.serviceRasterInfo),o=i.keyProperties.BandProperties;1===i.bandCount?(s=s||i.statistics&&i.statistics[0].min,l=l||i.statistics&&i.statistics[0].max,s||l?a.push(this._getStretchLegendElements(n,{min:s,max:l})):this.buildLegendElementsForTools()):e.bandIds&&1===e.bandIds.length?(s=s||i.statistics&&i.statistics[e.bandIds[0]].min,l=l||i.statistics&&i.statistics[e.bandIds[0]].max,s||l?a.push(this._getStretchLegendElements(n,{min:s,max:l})):this.buildLegendElementsForTools()):i.bandCount>=3?o&&o.length>=i.bandCount?e.bandIds&&3===e.bandIds.length?(r=e.bandIds.map((e=>o[e].BandName)),u.infos=this._createSymbolTableElementMultiBand(r)):"lerc"===e.format?(r=[0,1,2].map((e=>o[e].BandName)),u.infos=this._createSymbolTableElementMultiBand(r)):this.buildLegendElementsForTools():"lerc"===e.format?(r=["band1","band2","band3"],u.infos=this._createSymbolTableElementMultiBand(r)):this.buildLegendElementsForTools():this.buildLegendElementsForTools()}else if(Y(n))n.colormapInfos.forEach((e=>{u.infos.push({label:e.label,value:e.value,symbol:this._getAppliedCloneSymbol(K,e.color)})}));else if(te(n)){let e=n.symbol;switch(s.geometryType){case"point":e="pointSymbol"in i&&i.pointSymbol;break;case"polyline":e="lineSymbol"in i&&i.lineSymbol;break;case"polygon":e="polygonSymbol"in i&&i.polygonSymbol}n.symbol&&!this._hasSizeRamp&&u.infos.push({label:n.label,symbol:e})}else if(Q(n)){n.outputUnit&&(this.title="("+n.toJSON().outputUnit+")"),u.title=n.attributeField;const e=n.getClassBreakInfos();null!=e&&e.length?e.forEach((e=>{u.infos.push({label:e.minValue+" - "+e.maxValue,symbol:e.symbol})})):u.infos.push({label:n.attributeField,symbol:n.getDefaultSymbol()})}else ee(n)&&a.push(this._getStretchLegendElements(n,{min:0,max:255}));const h=n.defaultSymbol;!h||d||te(n)||c&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||a.push({type:"symbol-table",infos:[{label:n.defaultLabel||"others",symbol:h}]}),u.infos.length&&a.unshift(u);const m=null==s.opacity?this.opacity:s.opacity,p=this._isTallSymbol("visualVariables"in n&&n.visualVariables),f=de(this.layer),g=a.reduce(((e,t)=>e.concat(this._getAllInfos(t))),[]).filter((e=>!(!e||!e.symbol))).map((e=>this._getSymbolPreview(e,m,{applyScaleDrivenSize:!y.has(e.symbol),symbolConfig:{isTall:p,isSquareFill:f}})));return n=null,await o(g),a}_getAllInfos(e){const t=null==e?void 0:e.infos;return t?t.reduce(((e,t)=>e.concat(this._getAllInfos(t))),[]):[e]}_constructTileImageryStretchRendererElements(e){const t=this.layer,s=t.rasterInfo,l=s.bandCount||e.statistics.length;let r,i,n=[];const a=s.keyProperties&&s.keyProperties.BandProperties;if(e.statistics&&e.statistics.length)r=void 0!==e.statistics[0].min?e.statistics[0].min:e.statistics[0][0],i=e.statistics[0].max||e.statistics[0][1];else if(ye(t)){const e=H[t.rasterInfo.pixelType.toLowerCase()];r=e[0],i=e[1]}if(1===s.bandCount)return this._getStretchLegendElements(e,{min:r,max:i});function o(e){var l;const r=((null==t||null==(l=t.bandIds)?void 0:l.length)===s.bandCount?t.bandIds:Array.from(Array(Math.min(s.bandCount,3)).keys())).map((t=>e&&e[t]&&e[t].BandName||"band"+(t+1)));return r.length<3?r.push(r[1]):r.length>3&&r.splice(3),r}return n=a&&a.length>=l?o(a):o(),this._createSymbolTableElementMultiBand(n)}_getStretchLegendElements(e,t){const s=e.colorRamp,l=k(s,t);return{type:"stretch-ramp",title:"",infos:l,preview:V(l.map((e=>e.color)))}}_createSymbolTableElementMultiBand(e){const t=[],s=["red","green","blue"];return e.forEach(((e,l)=>{t.push({label:{colorName:s[l],bandName:e},src:D[l],opacity:1})})),t}_updateInfosforClassedSizeRenderer(e,t){const s=e.authoringInfo&&"class-breaks-size"===e.authoringInfo.type,l=e.classBreakInfos.some((e=>R(e.symbol)));if(s&&l){const s=W,l=q,r=e.classBreakInfos.length,i=(s-l)/(r>1?r-1:r);t.forEach(((e,t)=>{e.size=s-i*t}))}}_isTallSymbol(e){let t=!1,s=!1;if(e)for(let l=0;l<e.length&&(!t||!s);l++){const r=e[l];"size"===r.type&&("height"===r.axis&&(t=!0),"width-and-depth"===r.axis&&(s=!0))}return t&&s}async _getSymbolPreview(e,t,s){let l=null==e.size&&this._hasSizeRamp?f(22):e.size;if(this._scaleDrivenSizeVariable&&null!=s&&s.applyScaleDrivenSize){const{getSize:t}=await import("../../../renderers/visualVariables/support/visualVariableUtils.js");l=t(this._scaleDrivenSizeVariable,null,{view:this.view.type,scale:this.scale,shape:"simple-marker"===e.symbol.type?e.symbol.style:null})}return x(e.symbol,{size:l,opacity:t,scale:!1,symbolConfig:null==s?void 0:s.symbolConfig,rotation:e.symbol.angle}).then((t=>(e.preview=t,e))).catch((()=>(e.preview=null,e)))}async _loadRenderer(e){var s,l;const r=[],i=this.layer;e=e.clone(),this._hasClusterSizeVariable=!1;const n="visualVariables"in e&&(null==(s=e.visualVariables)?void 0:s.some((e=>"size"===e.type&&"outline"!==e.target&&!$.test(e.valueExpression))));if(e&&"visualVariables"in e&&!n&&"featureReduction"in i&&"cluster"===(null==(l=i.featureReduction)?void 0:l.type)){const s=this.layerView._effectiveRenderer,l=t(O(s,this.view));if(l){const t=i.featureReduction;if("clusterMinSize"in t&&"clusterMaxSize"in t){const{clusterMinSize:e,clusterMaxSize:s}=t;l.legendOptions=new C({showLegend:e!==s})}const s=e.visualVariables||[];e.visualVariables=s.concat([l]),this._hasClusterSizeVariable=!0}}const a=await this._getMedianColor(e);if(se(e)||le(e)){const t=(e.classBreakInfos||e.uniqueValueInfos).map((e=>this._fetchSymbol(e.symbol,a).then((t=>{e.symbol=t})).catch((()=>{e.symbol=null}))));Array.prototype.push.apply(r,t)}return r.push(this._fetchSymbol(e.symbol||e.defaultSymbol,e.defaultSymbol?null:a).then((t=>{this._applySymbolToRenderer(e,t,te(e))})).catch((()=>{this._applySymbolToRenderer(e,null,te(e))}))),o(r).then((()=>e))}_applySymbolToRenderer(e,t,s){s?e.symbol=t:e.defaultSymbol=t}async _getMedianColor(e){if(!("visualVariables"in e)||!e.visualVariables)return null;const t=e.visualVariables.find((e=>"color"===e.type));if(!t)return null;let s=null,l=null;if(t.stops){if(1===t.stops.length)return t.stops[0].color;s=t.stops[0].value,l=t.stops[t.stops.length-1].value}const r=s+(l-s)/2,{getColor:i}=await import("../../../renderers/visualVariables/support/visualVariableUtils.js");return i(t,r)}_fetchSymbol(e,t){if(!e)return c();if("web-style"===e.type){const s=e.portal,l=s&&s.url,r=s&&s.user&&s.user.username,i=e.name+"-"+e.styleName+"-"+e.styleUrl+"-"+l+"-"+r,n=this._webStyleSymbolCache;return n.has(i)||("2d"===this.view.type?n.set(i,e.fetchCIMSymbol()):n.set(i,e.fetchSymbol())),n.get(i).then((e=>this._getAppliedCloneSymbol(e,t))).catch((()=>(G.warn("Fetching web-style failed!"),c())))}return u(this._getAppliedCloneSymbol(e,t))}_getAppliedCloneSymbol(e,t){if(!e||!t)return e;const s=e.clone(),l=t&&t.toRgba();return s.type.indexOf("3d")>-1?this._applyColorTo3dSymbol(s,l):"cim"===s.type?I(s,t):s.color&&(s.color=new p(l||s.color)),s}_applyColorTo3dSymbol(e,t){t&&e.symbolLayers.forEach((e=>{e&&(e.material||(e.material={}),e.material.color=new p(t))}))}async _getVisualVariableLegendElements(e,t){if(!("visualVariables"in e)||!e.visualVariables||"vector-field"===e.type)return null;const l=e.visualVariables,r=[],i=[],n=[];for(const e of l)"color"===e.type?r.push(e):"size"===e.type?i.push(e):"opacity"===e.type&&n.push(e);const a=[...r,...i,...n];let o,u;if(0===r.length&&se(e)&&e.classBreakInfos&&1===e.classBreakInfos.length){const t=e.classBreakInfos[0];o=t&&t.symbol}if(0===r.length&&te(e)&&(o=e.symbol),o)if(o.type.indexOf("3d")>-1){const e=o.symbolLayers.getItemAt(0);"water"===e.type?s(e.color)&&(u=e.color):s(e.material)&&s(e.material.color)&&(u=e.material.color)}else o.url||(u=o.color);return(await d(a.map((async s=>{if(!s.legendOptions||!1!==s.legendOptions.showLegend){const l=this._getRampTitle(s,t);let r=null;const i="getField"in t&&t.getField&&t.getField(s.field),n=i&&m(i);if("color"===s.type){const t=await B(s,null,n,e);r={type:"color-ramp",title:l,infos:t,preview:V(t.map((e=>e.color)))},this._hasColorRamp||(this._hasColorRamp=!(null==r.infos||!r.infos.length))}else if("size"===s.type&&"outline"!==s.target)$.test(s.valueExpression)?this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=s):(r={type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(s):l,infos:await N(e,s,await this._getMedianColor(e),this.scale,this.view.type,n)},this._hasSizeRamp||(this._hasSizeRamp=!(null==r.infos||!r.infos.length)));else if("opacity"===s.type){const e=await B(s,u,n);r={type:"opacity-ramp",title:l,infos:e,preview:V(e.map((e=>e.color)))},this._hasOpacityRamp||(this._hasOpacityRamp=!(null==r.infos||!r.infos.length))}return r&&r.infos?r:null}})))).filter((e=>!!e))}_getDomainName(e,t,s){if(e&&"function"!=typeof e){const l="getField"in s&&s.getField&&s.getField(e),r=l&&"getFieldDomain"in s&&s.getFieldDomain?s.getFieldDomain(l.name):null;return r&&"coded-value"===r.type?r.getName(t):null}return null}_getClusterTitle(e){const t=this.layer,s=e.field;if("featureReduction"in t&&t.featureReduction&&"cluster"===t.featureReduction.type){const e=t.featureReduction,l="popupTemplate"in e&&e.popupTemplate,r=l&&l.fieldInfos;if(r)for(const e of r)if(e.fieldName===s)return"cluster_count"===s?e.label||{showCount:!0}:e.label}return{showCount:!0}}_getRampTitle(e,t){let s=e.field,l=e.normalizationField,r=!1,i=!1,n=!1,a=null;s="function"==typeof s?null:s,l="function"==typeof l?null:l;const o=e.legendOptions&&e.legendOptions.title;if(null!=o)a=o;else if(e.valueExpressionTitle)a=e.valueExpressionTitle;else{if("renderer"in t&&t.renderer&&"authoringInfo"in t.renderer&&t.renderer.authoringInfo&&t.renderer.authoringInfo.visualVariables){const e=t.renderer.authoringInfo.visualVariables;for(let t=0;t<e.length;t++){const s=e[t];if("color"===s.type){if("ratio"===s.style){r=!0;break}if("percent"===s.style){i=!0;break}if("percent-of-total"===s.style){n=!0;break}}}}a={field:s&&this._getFieldAlias(s,t),normField:l&&this._getFieldAlias(l,t),ratio:r,ratioPercent:i,ratioPercentTotal:n}}return a}_getRendererTitle(e,t){const s=e;if(s.legendOptions&&s.legendOptions.title)return s.legendOptions.title;if(s.valueExpressionTitle)return s.valueExpressionTitle;let l=s.field,r=null,i=null;se(s)&&(r=s.normalizationField,i="percent-of-total"===s.normalizationType),l="function"==typeof l?null:l,r="function"==typeof r?null:r;let n=null;return(l||r)&&(n={field:l&&this._getFieldAlias(l,t),normField:r&&this._getFieldAlias(r,t),normByPct:i}),n}_getFieldAlias(e,t){const s="popupTemplate"in t&&t.popupTemplate,l=s&&s.fieldInfos;let r=null;l&&l.some((t=>e===t.fieldName&&(r=t,!0)));let i=null;"getField"in t&&t.getField?i=t.getField(e):"fieldsIndex"in t&&t.fieldsIndex&&(i=t.fieldsIndex.get(e));const n=r||i;let a=null;return n&&(a=r&&r.label||i&&i.alias||"name"in n&&n.name||"fieldName"in n&&n.fieldName),a}_isUnclassedRenderer(e){const t=e.visualVariables;let s=!1;return se(e)&&e.classBreakInfos&&1===e.classBreakInfos.length&&t&&(s=e.field?t.some((t=>!(!t||e.field!==t.field||(e.normalizationField||t.normalizationField)&&e.normalizationField!==t.normalizationField))):!!t.length),s}};e([r()],pe.prototype,"children",void 0),e([r()],pe.prototype,"layerView",void 0),e([r()],pe.prototype,"layer",void 0),e([r()],pe.prototype,"legendElements",void 0),e([r({dependsOn:["parent","parent.opacity","layer","layer.opacity"],readOnly:!0})],pe.prototype,"opacity",null),e([r()],pe.prototype,"parent",void 0),e([r({readOnly:!0,dependsOn:[],autoTracked:!1})],pe.prototype,"ready",null),e([r()],pe.prototype,"keepCacheOnDestroy",void 0),e([r()],pe.prototype,"respectLayerVisibility",void 0),e([r({dependsOn:["view.scale"],readOnly:!0})],pe.prototype,"scale",null),e([r()],pe.prototype,"sublayerIds",void 0),e([r({dependsOn:["layer.renderer?.valueExpression?","layer.renderer?.visualVariables?","layer.featureReduction?","scale"],readOnly:!0})],pe.prototype,"isScaleDriven",null),e([r()],pe.prototype,"title",void 0),e([r({readOnly:!0,dependsOn:["ready"],autoTracked:!1,value:0})],pe.prototype,"version",null),e([r()],pe.prototype,"view",void 0),pe=e([n("esri.widgets.Legend.support.ActiveLayerInfo")],pe);var fe=pe;export default fe;
