/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import"../../core/has.js";import e from"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import{property as o}from"../../core/accessorSupport/decorators/property.js";import{subclass as i}from"../../core/accessorSupport/decorators/subclass.js";import r from"../../core/Error.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import{debounce as s,eachAlways as n,reject as a,resolve as h,all as c}from"../../core/promiseUtils.js";import l from"../../geometry/Point.js";import d from"../../core/Evented.js";import p from"../../core/Collection.js";import{getLocale as m}from"../../intl/locale.js";import{fetchMessageBundle as v}from"../../intl/messages.js";import{getAssetUrl as u}from"../../assets.js";import"../../intl.js";import _ from"../../symbols/PictureMarkerSymbol.js";import g from"../../Graphic.js";import w from"../../core/Handles.js";import{init as f}from"../../core/watchUtils.js";import{load as C}from"../../geometry/projection.js";import{GoToMixin as y}from"../support/GoTo.js";import{create as b}from"../../portal/support/geometryServiceUtils.js";import j from"./support/Conversion.js";import{isValidPoint as P,isSupportedNotation as S}from"./support/coordinateConversionUtils.js";import{generateDefaultFormats as L}from"./support/formatUtils.js";const M="default",U="crosshair",x=new l([0,0,500]),G=`${window.location.pathname}__coordinateConversionWidgetState`,A=e.getLogger("esri.widgets.CoordinateConversion.CoordinateConversionViewModel"),E="conversions",F="formats",N="view",W="view-change";let O=0,V=[],k=class extends(y(d.EventedAccessor)){constructor(t){super(t),this._conversionPromise=null,this._handles=new w,this._locationGraphic=null,this._locale=m(),this._pointerCount=0,this.conversions=new p,this.formats=new p,this.formatterAvailable=!1,this.geometryServicePromise=null,this.messages=null,this.requestDelay=300,this.locationSymbol=new _({url:u("esri/images/search/search-symbol-32.png"),width:24,height:24}),this.view=null,this._instanceNumber=O,O++,this._saveWidgetState=this._saveWidgetState.bind(this),this._handleFormatChange=this._handleFormatChange.bind(this),this._handleConversionChange=this._handleConversionChange.bind(this),this._handleViewChange=this._handleViewChange.bind(this),this._onClick=this._onClick.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerDown=this._onPointerDown.bind(this),this._onPointerUp=this._onPointerUp.bind(this)}initialize(){(async()=>this.messages=await v("esri/widgets/CoordinateConversion/t9n/CoordinateConversion"))().then((()=>{if(!this.destroyed&&(this.formats.addMany(L(this.messages)),this._loadWidgetState(),this.formats.forEach((t=>{t.viewModel=this,this._handles.add(t.watch("currentPattern",this._saveWidgetState),t.name)})),this._handles.add(this.conversions.on("change",this._handleConversionChange),E),this._handles.add(this.formats.on("change",this._handleFormatChange),F),this._handles.add(f(this,"view.map",(()=>{this.geometryServicePromise=b(this.get("view.map.portalItem"))})),W),C().then((()=>{this.formatterAvailable=!0})).catch((t=>{A.error(new r("coordinate-conversion:projection-load-failed","Failed to load the projection module.",{error:t})),this.formatterAvailable=!1})).then((()=>this._handles.add(f(this,"view",this._handleViewChange),W))),0===this.conversions.length)){const t=this.formats.find((t=>"xy"===t.name))||this.formats.getItemAt(0);this.conversions.add(new j({format:t}))}}))}destroy(){this._handles.removeAll(),this._cleanUpView(this.view),this.view=null}set currentLocation(t){this._set("currentLocation",t),this._updateConversions()}get currentLocation(){return this._get("currentLocation")||null}set mode(t){switch(t){case"capture":this.currentLocation=null,this._startCaptureMode(),this._set("mode",t);break;case"live":this._startLiveMode(),this._set("mode",t)}}get mode(){return this._get("mode")||"live"}get state(){const{messages:t,view:e}=this,o=null==e?void 0:e.ready;return t?o?"ready":e?"loading":"disabled":"disabled"}get waitingForConversions(){return null!=this._conversionPromise}get _debouncedConvert(){return s(((t,e,o)=>n(t.map((t=>t.convert(e,o))))),this.requestDelay)}setLocation(t){if(this.view.graphics.remove(this._locationGraphic),t){const e=t.clone();e.hasZ&&(e.z=void 0),this._locationGraphic=new g({geometry:e,symbol:this.get("locationSymbol")}),this.view.graphics.add(this._locationGraphic)}}convert(t,e){return P(e)?h().then((()=>t.convert(e))):a(new r("coordinate-conversion:invalid-point","Invalid point cannot be converted.",{point:e}))}goToLocation(t){if(this.get("view.clippingArea")||this.get("view.map.basemap.baseLayers.length")>0){const e=this.get("view.clippingArea")||this.view.map.basemap.baseLayers.getItemAt(0).fullExtent;return e?e.contains(t)?this.callGoTo({target:t}):a(new r("coordinate-conversion:go-to-failed","Point outside basemap extent.",{point:t})):this.callGoTo({target:t})}return this.callGoTo({target:t})}pause(){this.currentLocation=null,this._handles.remove(N),this.view&&(this.view.cursor=M,this.view.graphics.remove(this._locationGraphic))}previewConversion(t,e=this.currentLocation||x){return this._convertMany([t],e).then((()=>t.displayCoordinate))}resume(){"capture"===this.mode?this._startCaptureMode():this._startLiveMode()}reverseConvert(t,e){return e.reverseConvert(t)}async updateConversions(t,e){return e&&e.type&&"point"===e.type?this._convertMany(t,e).then((t=>t.client.concat(t.server))):(this._clearConversions(this.conversions),a(new r("coordinate-conversion:invalid-input-point","Point is invalid, conversions cannot be updated.",{point:e})))}_cleanUpView(t){t&&(t.graphics.remove(this._locationGraphic),this._handles.remove(N),t.cursor=M)}_clearConversions(t){t.forEach((t=>{t.position={location:null,coordinate:null}}))}_convertMany(t,e){const{client:o,server:i}=t.reduce(((t,e)=>(t[e.format.getConversionStrategy()].push(e),t)),{client:[],server:[]}),r=c(o.map((t=>t.format.convert(e).then((e=>(t.position=e,t))).catch((()=>{t.position=null}))))),s=t=>t?(this._conversionPromise=null,this.notifyChange("waitingForConversions"),t.map(((t,e)=>{const o=i[e];return t.error?(o.position=null,o):(o.position=t.value,o)}))):[];return this._conversionPromise=i.length>0?this._debouncedConvert(i.map((t=>t.format)),e).then(s,s):h([]),this.notifyChange("waitingForConversions"),c([r,this._conversionPromise]).then((t=>({client:t[0],server:t[1]})))}_handleConversionChange(t){t.added.forEach((t=>{const e=t.format;e.viewModel=this,this.currentLocation&&(this._set("waitingForConversions",!0),this.convert(e,this.currentLocation).then((e=>{t.position=e,this._set("waitingForConversions",!1)})))})),this._saveWidgetState()}_handleFormatChange(t){t.added.forEach((t=>{this._handles.add(t.watch("currentPattern",this._saveWidgetState),t.name),t.viewModel=this})),t.removed.forEach((t=>{t.viewModel=null,this._handles.remove(t.name)}))}_loadWidgetState(){if(0===this._instanceNumber)try{const t=JSON.parse(localStorage.getItem(G));t&&(V=t)}catch(t){A.error(new r("coordinate-conversion:invalid-local-storage-json","Could not read from localStorge.",{error:t}))}this._setWidgetState()}_startCaptureMode(){this._handles.remove(N),this.view&&(this.view.cursor=U,this.currentLocation&&this.setLocation(this.currentLocation),this._handles.add(this.view.on("click",this._onClick),N))}_startLiveMode(){this._pointerCount=0,this._handles.remove(N),this.view&&(this.view.cursor=M,this.view.graphics.remove(this._locationGraphic),this._handles.add([this.view.on("pointer-down",this._onPointerDown),this.view.on("pointer-up",this._onPointerUp),this.view.on("pointer-move",this._onPointerMove)],N))}_handleViewChange(t,e){e&&e!==t&&this._cleanUpView(e),t&&("capture"===this.mode&&this._startCaptureMode(),this._startLiveMode())}_onClick(t){if(0===t.button){const e=this.view.toMap(t),o=e&&e.normalize();this.setLocation(o),this.currentLocation=o}}_onPointerDown(t){const{pointerType:e}=t;if(this._pointerCount++,("touch"===e||"pen"===e)&&1===this._pointerCount){const e=this.view.toMap(t);this.currentLocation=e&&e.normalize()}}_onPointerMove(t){const{pointerType:e}=t;if("mouse"===e||1===this._pointerCount){const e=this.view.toMap(t);this.currentLocation=e&&e.normalize()}}_onPointerUp(){this._pointerCount--}_setWidgetState(){const t=V[this._instanceNumber];if(t)try{t.formats.forEach((e=>{const o=this.formats.find((t=>t.name===e.name));o&&t.locale===this._locale&&e.currentPattern&&(o.currentPattern=e.currentPattern),o&&e.index>=0&&this.conversions.add(new j({format:o}))}))}catch(t){A.warn(new r("coordinate-conversion:local-storage-read-error","Could not get widget state from stored JSON.",{error:t})),V[this._instanceNumber]={formats:[],locale:this._locale}}else V[this._instanceNumber]={formats:[],locale:this._locale}}_saveWidgetState(){const t=this._toJSON();V[this._instanceNumber]={formats:t,locale:this._locale};try{localStorage.setItem(G,JSON.stringify(V))}catch(t){A.error(new r("coordinate-conversion:local-storage-write-error","Could not write to localStorage.",{error:t}))}}async _updateConversions(){try{await this.updateConversions(this.conversions.toArray(),this.currentLocation)}catch{}}_toJSON(){return this.formats.filter((t=>{const e=t.name;return"xy"===e||"basemap"===e||S(e)})).map((t=>({name:t.name,currentPattern:t.currentPattern,defaultPattern:t.defaultPattern,index:this.conversions.findIndex((e=>e.format===t))}))).sort(((t,e)=>t.index-e.index)).toArray()}};t([o()],k.prototype,"conversions",void 0),t([o({type:l})],k.prototype,"currentLocation",null),t([o()],k.prototype,"formats",void 0),t([o()],k.prototype,"messages",void 0),t([o()],k.prototype,"mode",null),t([o()],k.prototype,"requestDelay",void 0),t([o({dependsOn:["messages","view","view.ready"],readOnly:!0})],k.prototype,"state",null),t([o()],k.prototype,"locationSymbol",void 0),t([o({readOnly:!0})],k.prototype,"waitingForConversions",null),t([o()],k.prototype,"view",void 0),t([o({readOnly:!0,dependsOn:["requestDelay"]})],k.prototype,"_debouncedConvert",null),k=t([i("esri.widgets.CoordinateConversion.CoordinateConversionViewModel")],k);var D=k;export default D;
