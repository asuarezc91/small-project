/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as t}from"../../../core/accessorSupport/decorators/property.js";import{subclass as r}from"../../../core/accessorSupport/decorators/subclass.js";import i from"../../../core/Error.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import{reject as o,resolve as s}from"../../../core/promiseUtils.js";import n from"../../../core/Accessor.js";import{equals as a}from"../../../geometry/support/spatialReferenceUtils.js";import c from"../../../geometry/SpatialReference.js";import{canProject as l,project as p}from"../../../geometry/support/webMercatorUtils.js";import"../../../geometry.js";import{isLoaded as m,project as u}from"../../../geometry/projection.js";import{fromUsng as d,fromUtm as h,fromMgrs as f,fromLatitudeLongitude as g,toUtm as v,toUsng as y,toMgrs as S,toLatitudeLongitude as w}from"../../../geometry/coordinateFormatter.js";import{isValidPoint as P,isSupportedNotation as R,fromXY as j,fromGeoCoordinateString as _,pointToCoordinate as b,toGeoCoordinateString as M,project as C,getDegreePrecision as I}from"./coordinateConversionUtils.js";let x=class extends n{constructor(e){super(e),this.conversionInfo=null,this.coordinateSegments=null,this.defaultPattern=null,this.name=null,this.viewModel=null}get currentPattern(){return this._get("currentPattern")||this._get("defaultPattern")}set currentPattern(e){this._set("currentPattern",e)}get hasDisplayProperties(){return!(!this.defaultPattern||!this.coordinateSegments)}get spatialReference(){const e=this.get("conversionInfo.spatialReference")||c.WGS84;return"basemap"===this.name?this._viewSpatialReference:e}set spatialReference(e){void 0===e&&this._clearOverride("spatialReference"),this._override("spatialReference",e)}get _viewSpatialReference(){return this.get("viewModel.view.spatialReference")||c.WGS84}get _additionalCharactersPattern(){const e=this.get("coordinateSegments");if(!e)return null;const t=e.map((e=>e.alias)),r=this.currentPattern.replace(new RegExp(`["nsew${t.join()}]`,"gi"),"").replace(/\ /g,"");return new RegExp(`[${r}]`,"g")}convert(e,t){if(!P(e))return o(new i("format:invalid-point","Could not convert invalid point.",{point:e}));const r=this.get("conversionInfo.convert");return r?s().then((()=>r(e))):this._project(e,this.spatialReference,t).then((e=>this._getCoordinate(e).then((t=>({location:e,coordinate:t})))))}getConversionStrategy(){const e=this._viewSpatialReference;return this.get("conversionInfo.convert")||this.get("viewModel.formatterAvailable")||"xy"===this.name&&(e.isWebMercator||e.isWGS84)||"basemap"===this.name?"client":"server"}getDisplayCoordinate(e){if(!e)return null;if(!this.coordinateSegments||!this.currentPattern)return e;let t=this.currentPattern;const r=this._getSegmentMatches(e,!1);for(let e=this.coordinateSegments.length-1;e>=0;e--){const i=this.coordinateSegments[e];t=t.replace(i.alias,r[e])}return t}parseUserInput(e){let t=this.defaultPattern.replace(this._additionalCharactersPattern,"");e=e.replace(this._additionalCharactersPattern,"");const r=this._getSegmentMatches(e,!0);for(let e=this.coordinateSegments.length-1;e>=0;e--){const i=this.coordinateSegments[e];t=t.replace(i.alias,r[e])}return t}_getSegmentMatches(e,t){const r=[];for(let i=0;i<this.coordinateSegments.length;i++){const o=this.coordinateSegments[i],s=e.match(o.searchPattern);if(!s){r.push("");continue}let n=s[0];if(e=e.replace(n,"").trim(),o.substitution){const e=t?o.substitution.input(n):o.substitution.output(n);e&&(n=e)}r.push(n)}return r}reverseConvert(e){const t=this.parseUserInput(e),r=this.get("conversionInfo.reverseConvert"),s=R(this.name);let n;if(r)n=r(t);else if("xy"===this.name||"basemap"===this.name)n=j(t,this.spatialReference);else if(this.viewModel.formatterAvailable)switch(this.name){case"dd":case"ddm":case"dms":n=g(t,this.spatialReference);break;case"mgrs":{const e="automatic";n=f(t,this.spatialReference,e);break}case"utm":{const e="latitude-band-indicators";n=h(t,this.spatialReference,e);break}case"usng":n=d(t,this.spatialReference);break;default:n=null}else if(s)return _({coordinate:t,spatialReference:this.spatialReference,formatName:this.name,geometryServicePromise:this.get("viewModel.geometryServicePromise")});return n?this._project(n,this._viewSpatialReference):o(new i("format:invalid-input","Could not parse input into point.",{userInput:e}))}_getCoordinate(e){const t=this.get("viewModel.view.scale");if(!P(e))return o(new i("format:invalid-point","Could not transform invalid point into coordinate.",{point:e}));if(this.get("viewModel.formatterAvailable")||"basemap"===this.name||"xy"===this.name)switch(this.name){case"dd":case"ddm":case"dms":{const r=I(t);return s(w(e,this.name,r))}case"mgrs":return s(S(e,"automatic",5,!1));case"usng":return s(y(e,5,!1));case"utm":return s(v(e,"latitude-band-indicators",!0));default:return s(b(e,t))}return R(this.name)?M({formatName:this.name,location:e,geometryServicePromise:this.get("viewModel.geometryServicePromise")}):s(b(e,t))}_project(e,t,r){return a(e.spatialReference,t)||!t?s(e):this.get("viewModel.formatterAvailable")&&m()?s(u(e,t)):this.get("viewModel.formatterAvailable")?null:l(e,t)?s(p(e,t)):C({location:e,spatialReference:t,geometryServicePromise:this.get("viewModel.geometryServicePromise"),scale:this.get("viewModel.view.scale")},r).then((e=>e.location))}};e([t()],x.prototype,"conversionInfo",void 0),e([t()],x.prototype,"coordinateSegments",void 0),e([t()],x.prototype,"currentPattern",null),e([t()],x.prototype,"defaultPattern",void 0),e([t({readOnly:!0,dependsOn:["defaultPattern","coordinateSegments"]})],x.prototype,"hasDisplayProperties",null),e([t()],x.prototype,"name",void 0),e([t({dependsOn:["_viewSpatialReference","name"],type:c})],x.prototype,"spatialReference",null),e([t()],x.prototype,"viewModel",void 0),e([t({dependsOn:["viewModel.view.spatialReference"],readOnly:!0})],x.prototype,"_viewSpatialReference",null),e([t({readOnly:!0,dependsOn:["currentPattern"]})],x.prototype,"_additionalCharactersPattern",null),x=e([r("esri.widgets.CoordinateConversion.support.Format")],x);var O=x;export default O;
