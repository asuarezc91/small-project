/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../core/has.js";import{isSome as s,unwrapOr as i,isNone as o,destroyMaybe as r,applySome as a}from"../../core/maybe.js";import"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import{handlesGroup as l}from"../../core/handleUtils.js";import{property as n}from"../../core/accessorSupport/decorators/property.js";import{subclass as c}from"../../core/accessorSupport/decorators/subclass.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import{on as p}from"../../core/events.js";import{formatDecimal as v,formatSlope as d}from"../../core/unitFormatUtils.js";import"../support/widgetUtils.js";import{messageBundle as m}from"../support/decorators/messageBundle.js";import{renderable as u}from"../support/decorators/renderable.js";import{j as h}from"../../chunks/index.js";import _ from"../Widget.js";import b from"../support/Popover.js";import{STATISTICS_CSS as g}from"./css.js";import{FORMAT_PRECISION as f,NOT_AVAILABLE as S}from"./support/constants.js";const P=(e,t)=>Number(t.available)-Number(e.available);let V=class extends _{constructor(e,t){super(e,t),this._messagesUnits=null,this._resizeObserver=null,this._maxNumStatistics=null,this._clickOutsideHandle=null,this._popover=null}destroy(){s(this._resizeObserver)&&(this._resizeObserver.disconnect(),this._resizeObserver=null),this._destroyPopover()}render(){const e=this._allStatistics,t=i(this._maxNumStatistics,1/0);return 0===e.length?h("div",{class:this.classes(g.base)}):h("div",{class:g.base,bind:this,afterCreate:this._onContainerAfterCreate,afterUpdate:this._onContainerResize},e.map(((e,s)=>this._renderStatistic(e,{hidden:s>=t,inPopover:!1}))),t<e.length&&h("button",{class:g.popoverToggle,bind:this,onclick:this._togglePopover,afterCreate:this._initializePopover,afterRemoved:this._destroyPopover}))}get _allStatistics(){const e=this.viewModel.statistics;if(o(e))return[];const i=this._messages.statistics,r=[{label:i.maxDistance,available:s(e.maxDistance),renderValue:()=>this._renderDistanceValue(e.maxDistance)},{label:i.minElevation,available:s(e.minElevation),renderValue:()=>this._renderElevationValue(e.minElevation)},{label:i.maxElevation,available:s(e.maxElevation),renderValue:()=>this._renderElevationValue(e.maxElevation)},{label:i.avgElevation,available:s(e.avgElevation),renderValue:()=>this._renderElevationValue(e.avgElevation)},{label:i.gain,available:s(e.elevationGain),renderValue:()=>this._renderElevationValue(e.elevationGain)},{label:i.loss,available:s(e.elevationLoss),renderValue:()=>this._renderElevationValue(e.elevationLoss)}];return t("elevation-profile-slope-stats")&&r.push({label:i.maxSlope,available:s(e.maxPositiveSlope)||s(e.maxNegativeSlope),renderValue:()=>this._renderSlopeValue(e.maxPositiveSlope,e.maxNegativeSlope)},{label:i.avgSlope,available:s(e.avgPositiveSlope)||s(e.avgNegativeSlope),renderValue:()=>this._renderSlopeValue(e.avgPositiveSlope,e.avgNegativeSlope)}),r.sort(P)}_renderDistanceValue(e){const t=this._messagesUnits,i=this.viewModel.effectiveUnits.distance;return h("div",{class:g.statisticValue},s(e)?v(t,e,i,f):S)}_renderElevationValue(e){const t=this._messagesUnits,i=this.viewModel.effectiveUnits.elevation;return h("div",{class:g.statisticValue},s(e)?v(t,e,i,f):S)}_renderSlopeValue(e,t){return h("div",{class:g.statisticValue},h("div",{key:"slope-up",class:this.classes(g.slopeValue,{[g.slopeValueNotAvailable]:o(e)})},h("div",{class:g.slopeUpIcon}),s(e)?d(e,"degrees",f):S),h("div",{key:"slope-down",class:this.classes(g.slopeValue,{[g.slopeValueNotAvailable]:o(t)})},h("div",{class:g.slopeDownIcon}),s(t)?d(t,"degrees",f):S))}_renderStatistic({label:e,available:t,renderValue:s},{hidden:i,inPopover:o}){return h("div",{key:e,class:this.classes(g.statistic,{[g.statistic]:!o,[g.statisticHidden]:i,[g.statisticNotAvailable]:!t,[g.popoverStatistic]:o})},h("h5",{class:g.statisticLabel},e),s())}_initializePopover(e){this._destroyPopover(),this._popover=new b({owner:this,placement:"bottom-end",anchorElement:e,renderContentFunction:()=>this._renderPopoverContent()})}_destroyPopover(){r(this._popover),a(this._clickOutsideHandle,(e=>e.remove()))}_renderPopoverContent(){const e=this._allStatistics,t=s(this._maxNumStatistics)?e.slice(this._maxNumStatistics,e.length):[];return h("div",{class:g.popoverContent,bind:this,afterCreate:this._onPopoverContentAfterCreate},t.map((e=>this._renderStatistic(e,{hidden:!1,inPopover:!0}))))}_togglePopover(){s(this._popover)&&this._popover.open?this._closePopover():this._openPopover()}_openPopover(){a(this._popover,(e=>e.open=!0))}_closePopover(){a(this._clickOutsideHandle,(e=>e.remove())),a(this._popover,(e=>e.open=!1))}_onPopoverContentAfterCreate(e){a(this._clickOutsideHandle,(e=>e.remove())),this._clickOutsideHandle=l([p(e,"click",(e=>e.stopPropagation())),p(window,"click",(()=>this._closePopover()))])}_onContainerAfterCreate(e){this._resizeObserver=new ResizeObserver((()=>this._onContainerResize(e))),this._resizeObserver.observe(e)}_onContainerResize(e){const{width:t}=e.getBoundingClientRect();let s=0;const i=Array.from(e.querySelectorAll(`.${g.statistic}`)),o=i.length;for(let e=0;e<o;++e){const o=i[e];if(!(o instanceof HTMLElement))continue;const r=o.classList.contains(g.statisticHidden);o.classList.remove(g.statisticHidden);const a=o.offsetWidth+15;if(s+=a,o.classList.toggle(g.statisticHidden,r),s>t)return s-=a,s+=49,void(this._maxNumStatistics=s>t?Math.max(0,e-1):e)}this._maxNumStatistics=o}};e([n(),u(["unit","unitOptions","statistics","effectiveUnits"])],V.prototype,"viewModel",void 0),e([n(),u(),m("esri/widgets/ElevationProfile/t9n/ElevationProfile")],V.prototype,"_messages",void 0),e([n(),u(),m("esri/core/t9n/Units")],V.prototype,"_messagesUnits",void 0),e([n(),u()],V.prototype,"_maxNumStatistics",void 0),e([n({readOnly:!0}),u()],V.prototype,"_allStatistics",null),V=e([c("esri.widgets.ElevationProfile.Statistics")],V);export{V as Statistics};
