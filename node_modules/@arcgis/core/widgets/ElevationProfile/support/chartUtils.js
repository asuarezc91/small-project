/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isNone as t,unwrapOr as e,applySome as i,isSome as o}from"../../../core/maybe.js";import{makeHandle as n,handlesGroup as s}from"../../../core/handleUtils.js";import{last as r,binaryFindClosest as a}from"../../../core/arrayUtils.js";import{on as l}from"../../../core/events.js";import{throwIfAborted as c}from"../../../core/promiseUtils.js";import{substitute as d}from"../../../intl/substitute.js";import"../../../intl.js";import{formatDecimal as m}from"../../../core/unitFormatUtils.js";import{isRTL as u}from"../../support/widgetUtils.js";import{loadChartsModule as p}from"../../support/chartUtils.js";import{getTranslatedLineTitle as f}from"./intlUtils.js";import{FORMAT_PRECISION as x,NOT_AVAILABLE as h}from"./constants.js";async function g(n){const a=await p();c(n.abortOptions);const{am4core:l,am4charts:d}=a;l.options.minPolylineStep=2,l.options.autoSetClassName=!0;const m=l.create(n.container,d.XYChart);u()?(m.rtl=!0,m.padding(20,-10,0,1)):m.padding(20,1,0,-10),m.cursor=function(t){const e=new t.am4charts.XYCursor;return e.trackable=!0,e.lineY.disabled=!0,e}(a);const f=m.plotContainer.background;f.strokeWidth=1,f.strokeOpacity=1,f.stroke=l.color("#e0e0e0");const x=m.xAxes.push(new d.ValueAxis),h=m.yAxes.push(new d.ValueAxis),g={params:n,amChart:m,xAxis:x,yAxis:h,series:new Map,data:null,elevationUnitsPerPixel:null,messages:null};!function(t,{am4core:e}){const i=t.amChart.zoomOutButton.background;i.fill=e.color("#0079c1"),i.states.getKey("hover").properties.fill=e.color("#00598e"),i.states.getKey("down").properties.fill=e.color("#00598e")}(g,a),function({amChart:{tooltip:t}},{am4core:e}){t.zIndex=-1,t.pointerOrientation="down",t.getFillFromObject=!1,t.label.fill=e.color("#323232"),t.background.cornerRadius=0,t.background.stroke=null,t.background.fill=e.color("#ffffff"),u()&&(t.label.textAlign="middle")}(g,a),function(t,e){const{am4core:i}=e,{xAxis:o}=t;o.numberFormatter=y(t,"distance"),o.strictMinMax=!0,o.title.visible=!1;const n=o.renderer;n.line.visible=!1,n.minGridDistance=80,n.maxLabelPosition=.98,n.fontWeight="400",n.fontSize=10;const s=n.labels.template;s.fontSize=8,s.fontWeight="400",s.paddingTop=5,s.horizontalCenter="left",s.paddingLeft=0;const r=n.grid.template;r.strokeOpacity=1,r.stroke=i.color("#e0e0e0"),u()&&(n.inversed=!0,o.tooltip.label.textAlign="middle",s.textAlign="middle")}(g,a),function(t,e){const{am4core:i}=e,{yAxis:o}=t;o.numberFormatter=y(t,"elevation"),o.title.visible=!1,o.cursorTooltipEnabled=!1,o.strictMinMax=!1,o.extraMax=.02,o.extraMin=.02;const n=o.renderer;n.line.visible=!1,n.minGridDistance=30,n.maxLabelPosition=.98,n.fontWeight="400",n.fontSize=10;const s=n.labels.template;s.fontSize=8,s.fontWeight="400",s.paddingRight=5,s.verticalCenter="bottom",s.paddingBottom=0;const r=n.grid.template;r.strokeOpacity=1,r.stroke=i.color("#e0e0e0"),u()&&(n.opposite=!0,s.textAlign="middle")}(g,a);const k=[A(g,n.onCursorPositionChange),P(g),C(g)];let w=null;const U=()=>{o(w)&&(clearTimeout(w),w=null)};return{...g,update(n){n.data===g.data&&n.messages===g.messages||(U(),w=setTimeout((()=>{w=null,function(n,s,{data:a,elevationUnitsPerPixel:l,messages:c}){const{amChart:d}=s;d.tooltip.hide();const m=s.data!==a,u=s.elevationUnitsPerPixel!==l;s.data=a,s.elevationUnitsPerPixel=l,s.messages=c,m&&function({xAxis:i,data:n}){if(t(n))return;let s=0;for(const t of n.lines){var a;const i=e(t.samples,[]),n=null==(a=r(i))?void 0:a.distance;o(n)&&n>s&&(s=n)}i.min=0,i.max=s,i.invalidateLabels()}(s);(m||u)&&function({yAxis:e,data:n,elevationUnitsPerPixel:s}){if(t(n))return;const r=i(n.statistics,(t=>t.minElevation)),a=i(n.statistics,(t=>t.maxElevation));if(o(s)&&o(r)&&o(a)){const t=a-r,i=Math.max(0,s-t)/2;e.min=Math.round(r-i),e.max=Math.round(a+i)}else e.min=void 0,e.max=void 0;e.invalidateLabels()}(s);m&&function(e,o){const{amChart:n,data:s}=o;if(t(s)||0===s.lines.length)return void n.series.clear();const r=new Map,a=new Set(n.series.values),l=s.lines.length;for(let t=0;t<l;t++){const c=s.lines[t];let d=o.series.get(c.id);d?(i(d.fill,(t=>a.delete(t))),a.delete(d.line)):(d=b(e,c),i(d.fill,(t=>n.series.push(t))),n.series.push(d.line)),r.set(d.id,d);const m=l-t-1;i(d.fill,(t=>t.zIndex=m)),d.line.zIndex=l+m,v(e,d,c)}o.series=r;for(const t of a)n.series.removeValue(t)}(n,s)}(a,g,n)})))},destroy(){U(),s(k).remove(),m.dispose()}}}function v(t,{line:o,fill:n},s){const{r:r,g:a,b:l,a:c}=s.color,d=t.am4core.color({r:r,g:a,b:l,a:c}),m=e(s.samples,[]),u=m.length>0;o.data=m,o.stroke=d,o.visible=u,i(n,(t=>{t.data=m,t.visible=u,t.fill=d.lighten(.9)}))}function b(t,{id:e,showFill:i}){const{am4charts:o}=t,n=new o.LineSeries;n.id=`line-${e}`,n.showOnInit=!1,n.simplifiedProcessing=!0,n.connect=!1,n.strokeWidth=1.5,n.fillOpacity=0;n.dataFields.valueX="distance";n.dataFields.valueY="elevation";let s=null;return i&&(s=n.clone(),s.id=`fill-${e}`,s.strokeWidth=0,s.fillOpacity=1),{id:e,line:n,fill:s}}function A(t,e){const{amChart:i,xAxis:o,yAxis:s}=t,r=i.cursor,a=r.events.on("cursorpositionchanged",(()=>{const t=o.toAxisPosition(r.xPosition),i=s.toAxisPosition(r.yPosition);e(t,i)})),c=l(i.chartContainer.htmlContainer,["mouseleave","pointerleave"],(()=>{e(null,null)}));return n((()=>{a.dispose(),c.remove()}))}function P(e){const{amChart:s,xAxis:r}=e,a=s.cursor.events.on("cursorpositionchanged",(()=>{if(1!==i(e.data,(t=>t.progress)))return;const n=s.tooltip,a=function(e){const{amChart:n,yAxis:s,data:r,messages:a}=e;if(t(r)||t(a))return null;const l=r.effectiveUnits.elevation,c=[];let u=null;for(const n of r.lines){const s=k(e,n),r=i(s,(t=>t.elevation));(t(u)||o(r)&&r>u)&&(u=r);const p=d(a.chartTooltip,{name:f(n,a),elevation:o(r)?m(a,r,l,x):h});c.push(`[${n.color.toHex()}]●[/] ${p}`)}if(t(u))return null;const p=n.cursor,g=s.measuredHeight,v=g+n.pixelPaddingTop;return{text:c.join("\n"),point:{x:p.point.x+p.parent.pixelX+n.pixelPaddingLeft,y:v-s.valueToPosition(u)*g-10}}}(e);o(a)?(n.text=a.text,n.pointTo(a.point,!0),n.show()):n.hide(),r.tooltip.text=function(e){const{data:i,messages:n}=e;if(t(i)||t(n))return"";const s=i.lines[0],r=s?k(e,s):null;return o(r)?m(n,r.distance,i.effectiveUnits.distance,x):"-"}(e),r.showTooltip()}));return n((()=>a.dispose()))}function C({amChart:t,xAxis:e}){return l(t.chartContainer.htmlContainer,["mouseleave","pointerleave"],(()=>{t.tooltip.hide(),e.hideTooltip()}))}function y(t,e){const i=t.xAxis.numberFormatter.clone();return i.format=(i,n,s)=>{const{messages:r,data:a}=t;return o(r)&&o(a)&&"string"!=typeof i?m(r,i,a.effectiveUnits[e],s):""},i}function k({amChart:t,xAxis:i},o){const n=e(o.samples,[]);if(0===n.length)return null;const s=i.toAxisPosition(t.cursor.xPosition),r=i.positionToValue(s);return a(n,r,(t=>t.distance))}export{g as createChart};
