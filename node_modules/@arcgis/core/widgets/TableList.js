/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../core/has.js";import"../core/Logger.js";import"../core/accessorSupport/ensureType.js";import{property as t}from"../core/accessorSupport/decorators/property.js";import{aliasOf as i}from"../core/accessorSupport/decorators/aliasOf.js";import{subclass as s}from"../core/accessorSupport/decorators/subclass.js";import"../core/urlUtils.js";import"../core/uuid.js";import"../portal/support/resourceExtension.js";import{eventKey as o}from"../core/events.js";import r from"../core/Collection.js";import n from"../core/Handles.js";import{on as l,init as a}from"../core/watchUtils.js";import"./support/widgetUtils.js";import{accessibleHandler as c}from"./support/decorators/accessibleHandler.js";import{messageBundle as d}from"./support/decorators/messageBundle.js";import{renderable as m}from"./support/decorators/renderable.js";import{vmEvent as u}from"./support/decorators/vmEvent.js";import{j as h}from"../chunks/index.js";import p from"./Widget.js";import g from"sortablejs";import b from"./TableList/ListItem.js";import _ from"./TableList/TableListViewModel.js";import{findSelectedItem as y}from"./TableList/support/tableListUtils.js";function v(e,t,i){e.splice(i,0,e.splice(t,1)[0])}const f=r.ofType(b),A="esri-table-list",I="esri-widget",w="esri-widget--panel",S="esri-table-list__no-items",T="esri-table-list__list",C="esri-table-list__list--root",j="esri-table-list__item",k="esri-table-list__item--chosen",O="esri-table-list__item--error",E="esri-table-list__item--selectable",L="esri-table-list__item-container",M="esri-table-list__item-actions-menu",U="esri-table-list__item-actions-menu-item",x="esri-table-list__item-actions-menu-item--active",$="esri-table-list__item-actions",N="esri-table-list__item-actions-list",R="esri-table-list__item-action",V="esri-table-list__item-action-icon",B="esri-table-list__item-action-image",K="esri-table-list__item-action-title",P="esri-table-list__action-toggle",D="esri-table-list__action-toggle--on",F="esri-table-list__item-error-message",z="esri-table-list__item-title",H="esri-disabled",W="esri-disabled-element",q="esri-hidden",G="esri-rotating",J="esri-icon-handle-horizontal",Q="esri-icon-notice-triangle",X="esri-icon-loading-indicator",Y="esri-icon-default-action",Z="esri-icon-table",ee="actions",te="action-section",ie="items";let se=class extends p{constructor(e,t){super(e,t),this._handles=new n,this._sortable=null,this._sortableNode=null,this._focusSortUid=null,this.visibleItems=null,this.iconClass=Z,this.label=void 0,this.listItemCreatedFunction=null,this.map=null,this.messages=null,this.messagesCommon=null,this.multipleSelectionEnabled=!1,this.selectionEnabled=!1,this.selectedItems=new f,this.tableItems=null,this.viewModel=new _}initialize(){this._setVisibleItems(this.tableItems),this.own(l(this.viewModel,"tableItems","change",(()=>this._itemsChanged())),a(this,"selectionEnabled",(()=>this._toggleSorting())))}destroy(){this._destroySortable(),this._handles.destroy(),this._handles=null}triggerAction(e,t){this.viewModel.triggerAction(e,t)}render(){var e;const{visibleItems:t}=this,i=null==(e=this.viewModel)?void 0:e.state,s={[q]:"loading"===i,[H]:"disabled"===i};return h("div",{class:this.classes(A,I,w,s)},null!=t&&t.length?this.renderList():this.renderNoItems())}renderNoItems(){return h("div",{class:S},this.messages.noItemsToDisplay)}renderList(){const{visibleItems:e,messages:t,selectionEnabled:i}=this;return h("ul",{"aria-label":t.widgetLabel,role:i?"listbox":void 0,afterCreate:this._sortNodeCreated,afterRemoved:this._destroySortable,"data-node-ref":"_sortableNode",bind:this,class:this.classes(T,C)},e.map((e=>this.renderItem(e))).toArray())}renderItem(e){const{id:t,selectionEnabled:i,selectedItems:s}=this,o=`${`${t}_${e.uid}`}__title`,r=!!e.error,n={[O]:!!r,[E]:i};if(i){var l;const t={"data-layer-uid":null==(l=e.layer)?void 0:l.uid};return h("li",Object.assign({key:`item-with-selection-${e.uid}`,bind:this,afterCreate:this._focusListItem,afterUpdate:this._focusListItem,class:this.classes(j,n),"aria-labelledby":o,onclick:this._toggleSelection,onkeydown:this._selectionKeydown,"data-item":e,tabIndex:0,"aria-selected":y(e,s)?"true":"false",role:"option"},t),this.renderItemContent(e,o))}return h("li",{key:`item-no-selection-${e.uid}`,bind:this,afterCreate:this._focusListItem,afterUpdate:this._focusListItem,class:this.classes(j,n),"aria-labelledby":o},this.renderItemContent(e,o))}renderActionsMenuIcon(e,t){const{messagesCommon:i}=this,s={[x]:e.actionsOpen},o=e.actionsOpen?i.close:i.open;return h("div",{key:"actions-menu-toggle","data-item":e,bind:this,onclick:this._toggleActionsOpen,onkeydown:this._toggleActionsOpen,class:this.classes(U,s),tabindex:"0",role:"button","aria-controls":t,"aria-label":o,title:o},h("span",{"aria-hidden":"true",class:J}))}renderActionsMenu(e,t,i,s){const o=1===i&&this._getSingleActionButton(t),r=o?this.renderAction({item:e,action:o,singleAction:!0}):null,n=!o&&i?this.renderActionsMenuIcon(e,s):null;return n||o?h("div",{key:"actions-menu",class:M},r,n):null}renderError(e){return e.error?h("div",{key:"error",class:F,role:"alert"},h("span",null,this.messages.tableError)):null}renderItemContent(e,t){const{id:i}=this,s=`${`${i}_${e.uid}`}_actions`,o=this._filterActions(e.actionsSections),r=this._countActions(o);return[h("div",{key:"list-item-container",class:L},this.renderLabel(e,t),this.renderActionsMenu(e,o,r,s)),this.renderError(e),r?this.renderActionsSections(e,o,s):null]}renderTitle(e,t){const{messages:i}=this,s=e.title||i.untitledTable;return h("span",{key:"layer-title-container",id:t,class:z},s)}renderItemError(e){return e.error?h("span",{key:"notice-triangle","aria-hidden":"true",class:Q}):null}renderLabel(e,t){return e.error?[this.renderItemError(e),this.renderTitle(e,t)]:this.renderTitle(e,t)}renderActionsSections(e,t,i){const s=t.toArray().map(((t,i)=>h("ul",{key:`${e}-action-section-${i}`,class:N},this.renderActionSection(e,t))));return h("div",{role:"group","aria-expanded":e.actionsOpen?"true":"false",key:"actions-section",id:i,class:$,hidden:!e.actionsOpen||null},s)}renderActionSection(e,t){return(t&&t.toArray()).map((t=>this.renderAction({item:e,action:t})))}renderActionIcon(e){const{active:t,className:i}=e,s=this._getIconImageStyles(e),o="button"!==e.type||e.image||i?i:Y,r={[B]:!t&&!!s["background-image"],[X]:t,[G]:t};return o&&!t&&(r[o]=!0),h("span",{key:"action-icon","aria-hidden":"true",class:this.classes(V,r),styles:s})}renderActionTitle(e,t){return t?null:h("span",{key:"action-title",class:K},e)}renderAction(e){const{item:t,action:i,singleAction:s}=e,{active:o,disabled:r,title:n}=i,l={[U]:s&&"button"===i.type,[R]:o||!s&&"toggle"!==i.type,[P]:!o&&"toggle"===i.type,[D]:!o&&"toggle"===i.type&&i.value,[W]:r},a=[this.renderActionIcon(i),this.renderActionTitle(n,s)];return s?h("div",{bind:this,"data-item":t,"data-action":i,role:"button",key:`single-action-${i.uid}`,onclick:this._triggerAction,onkeydown:this._triggerAction,classes:l,tabindex:"0",title:n,"aria-label":n},a):h("li",{bind:this,"data-item":t,"data-action":i,key:`action-${i.uid}`,onclick:this._triggerAction,onkeydown:this._triggerAction,classes:l,tabindex:"0",role:"button",title:n,"aria-label":n},a)}_filterActions(e){return e.map((e=>e.filter((e=>e.visible))))}_setVisibleItems(e){this.visibleItems=null==e?void 0:e.filter((e=>this.errorsVisible||!e.error))}_destroySortable(){const{_sortable:e}=this;e&&e.destroy(),this._sortable=null}_toggleSorting(){const{_sortable:e,_sortableNode:t,selectionEnabled:i}=this;if(t)if(e)e.option("disabled",!i);else{const e=g.create(t,{dataIdAttr:"data-layer-uid",group:"root-tables",fallbackTolerance:4,disabled:!i,onSort:()=>this._sortTablesToItems(e.toArray()),chosenClass:k});this._sortable=e}}_sortNodeCreated(e){this._sortableNode=e,this._toggleSorting()}_sortTablesToItems(e){var t;const i=null==(t=this.map)?void 0:t.tables;i&&i.sort(((t,i)=>{const s=e.indexOf(t.uid),o=e.indexOf(i.uid);return s>o?-1:s<o?1:0}))}_getSingleActionButton(e){return e.reduce((e=>e)).filter((e=>e&&"button"===e.type)).getItemAt(0)}_focusListItem(e){var t;const{_focusSortUid:i}=this;if(!e||!i)return;(null==(t=e["data-item"].layer)?void 0:t.uid)===i&&(e.focus(),this._focusSortUid=null)}_watchActionSectionChanges(e,t){const i=te+t;this._handles.add(e.on("change",(()=>this.scheduleRender())),i),e.forEach((e=>this._renderOnActionChanges(e,t)))}_renderOnActionChanges(e,t){const i=ee+t,s=()=>this.scheduleRender();"toggle"!==e.type?"slider"!==e.type?this._handles.add([a(e,["className","image","id","title","visible"],s)],i):this._handles.add([a(e,["className","id","title","visible","value","displayValueEnabled","max","min","step"],s)],i):this._handles.add([a(e,["className","image","id","title","visible","value"],s)],i)}_renderOnItemChanges(e){const t=e.uid,i=ie+t,s=()=>this.scheduleRender();this._handles.add([a(e,["actionsOpen","open","title","error"],s),e.actionsSections.on("change",s)],i),e.actionsSections.forEach((e=>this._watchActionSectionChanges(e,t)))}_itemsChanged(){const{tableItems:e}=this.viewModel;this._setVisibleItems(e),this._handles.removeAll(),e.forEach((e=>this._renderOnItemChanges(e))),this.scheduleRender()}_countActions(e){return e.reduce(((e,t)=>e+t.length),0)}_getIconImageStyles(e){const t="esri.support.Action.ActionButton"===e.declaredClass||"esri.support.Action.ActionToggle"===e.declaredClass?e.image:null;return{"background-image":t?`url("${t}")`:null}}_selectionKeydown(e){const t=o(e);if(-1===["ArrowDown","ArrowUp"].indexOf(t))return void this._toggleSelection(e);e.stopPropagation();const i=e.currentTarget["data-item"],{_sortable:s,selectedItems:r}=this,n=y(i,r),l=s.toArray(),a=e.target,c=l.indexOf(a.dataset.layerUid);if(-1!==c){if("ArrowDown"===t){const e=c+1;if(e>=l.length)return;var d,m;if(n)v(l,c,e),s.sort(l),this._sortTablesToItems(s.toArray()),this._focusSortUid=null==(d=i.layer)?void 0:d.uid;else this._focusSortUid=null==(m=i.layer)?void 0:m.uid,this.scheduleRender()}if("ArrowUp"===t){const e=c-1;if(e<=-1)return;var u,h;if(n)v(l,c,e),s.sort(l),this._sortTablesToItems(s.toArray()),this._focusSortUid=null==(u=i.layer)?void 0:u.uid;else this._focusSortUid=null==(h=i.layer)?void 0:h.uid,this.scheduleRender()}}}_toggleActionsOpen(e){const t=e.currentTarget["data-item"],{actionsOpen:i}=t,s=!i;s&&this.tableItems.forEach((e=>function(e){const{actionsOpen:t}=e;t&&(e.actionsOpen=!1)}(e))),t.actionsOpen=s,e.stopPropagation()}_triggerAction(e){const t=e.currentTarget,i=t["data-action"],s=t["data-item"];"toggle"===i.type&&(i.value=!i.value),this.triggerAction(i,s),e.stopPropagation()}_toggleSelection(e){e.stopPropagation();const{multipleSelectionEnabled:t,selectedItems:i}=this,s=t&&(e.metaKey||e.ctrlKey),o=e.currentTarget["data-item"],r=y(o,i),{length:n}=i;if(!s)return n&&!(r&&1===n)?(i.removeAll(),void i.add(o)):void(r?i.remove(r):i.add(o));r?i.remove(r):i.add(o)}};e([t()],se.prototype,"visibleItems",void 0),e([t()],se.prototype,"iconClass",void 0),e([t(),m()],se.prototype,"errorsVisible",void 0),e([t({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],se.prototype,"label",void 0),e([i("viewModel.listItemCreatedFunction"),m()],se.prototype,"listItemCreatedFunction",void 0),e([i("viewModel.map")],se.prototype,"map",void 0),e([t(),m(),d("esri/widgets/TableList/t9n/TableList")],se.prototype,"messages",void 0),e([t(),m(),d("esri/t9n/common")],se.prototype,"messagesCommon",void 0),e([t()],se.prototype,"multipleSelectionEnabled",void 0),e([t(),m()],se.prototype,"selectionEnabled",void 0),e([t(),m()],se.prototype,"selectedItems",void 0),e([i("viewModel.tableItems"),m()],se.prototype,"tableItems",void 0),e([u("trigger-action"),t({type:_}),m("viewModel.state")],se.prototype,"viewModel",void 0),e([i("viewModel.triggerAction")],se.prototype,"triggerAction",null),e([c()],se.prototype,"_toggleActionsOpen",null),e([c()],se.prototype,"_triggerAction",null),e([c()],se.prototype,"_toggleSelection",null),se=e([s("esri.widgets.TableList")],se);var oe=se;export default oe;
