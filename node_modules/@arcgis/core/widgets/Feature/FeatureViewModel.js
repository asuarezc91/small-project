/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../core/has.js";import{isSome as t}from"../../core/maybe.js";import r from"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import{property as o}from"../../core/accessorSupport/decorators/property.js";import{subclass as i}from"../../core/accessorSupport/decorators/subclass.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import{createAbortController as s,eachAlways as a}from"../../core/promiseUtils.js";import n from"../../core/Accessor.js";import l from"../../popup/content/TextContent.js";import p from"../../Graphic.js";import c from"../../core/Handles.js";import{init as d}from"../../core/watchUtils.js";import{throttle as u}from"../../core/throttle.js";import{createfieldInfoMap as f,getAllFieldInfos as h,getSourceLayer as m,processFieldsInLinks as _,substituteAttributes as g,formatEditInfo as y,graphicCallback as I,queryUpdatedFeature as v,formatAttributes as b,isRelatedField as T}from"./support/featureUtils.js";import w from"../Attachments/AttachmentsViewModel.js";import M from"./FeatureContent/FeatureContentViewModel.js";import A from"./FeatureFields/FeatureFieldsViewModel.js";import{queryLayerInfos as F,queryRelatedFeatures as C,setRelatedFeatures as j,getRelatedFieldInfo as L,createRelatedInfo as x,updateRelatedInfo as E}from"./support/relatedFeatureUtils.js";import V from"./FeatureMedia/FeatureMediaViewModel.js";import{createFormattedExpressions as O}from"./support/arcadeFeatureUtils.js";const P=r.getLogger("esri.widgets.FeatureViewModel");let R=class extends n{constructor(e){super(e),this._handles=new c,this._featureAbortController=null,this.graphicChangedThrottled=u(this.graphicChanged,1,this),this.content=null,this.contentViewModels=[],this.defaultPopupTemplateEnabled=!1,this.formattedAttributes=null,this.lastEditInfo=null,this.relatedInfos=new Map,this.title="",this.view=null,this._handles.add(d(this,["graphic","_effectivePopupTemplate"],(()=>this.graphicChangedThrottled())))}destroy(){this._clear(),this._cancelFeatureQuery(),this._handles.destroy(),this._handles=null,this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()}get _effectivePopupTemplate(){return t(this.graphic)?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}get _fieldInfoMap(){return f(h(this._effectivePopupTemplate),this._sourceLayer)}get _sourceLayer(){return m(this.graphic)}set graphic(e){this._set("graphic",e?e.clone():null)}get spatialReference(){return this.get("view.spatialReference")||null}set spatialReference(e){void 0!==e?this._override("spatialReference",e):this._clearOverride("spatialReference")}get map(){return this.get("view.map")||null}set map(e){void 0!==e?this._override("map",e):this._clearOverride("map")}get waitingForContent(){return!!this._featureAbortController}setActiveMedia(e,t){const r=this.contentViewModels[e];r instanceof V&&r.setActiveMedia(t)}nextMedia(e){const t=this.contentViewModels[e];t instanceof V&&t.next()}previousMedia(e){const t=this.contentViewModels[e];t instanceof V&&t.previous()}_clear(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)}async graphicChanged(){this._cancelFeatureQuery(),this._clear();const{graphic:e}=this;if(!e)return;const t=s();this._featureAbortController=t;try{await this._queryFeature({signal:t.signal})}catch(t){P.error("error","error loading popupTemplate for graphic",{error:t,graphic:e})}this._featureAbortController===t&&(this._featureAbortController=null)}_cancelFeatureQuery(){const{_featureAbortController:e}=this;e&&e.abort(),this._featureAbortController=null}_compileContent(e){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(e)?e.map(((e,t)=>"attachments"===e.type?this._compileAttachments(e,t):"custom"===e.type?this._compileCustom(e,t):"fields"===e.type?this._compileFields(e,t):"media"===e.type?this._compileMedia(e,t):"text"===e.type?this._compileText(e,t):void 0)):"string"==typeof e?this._compileText(new l({text:e}),0).text:e}_destroyContentViewModels(){this.contentViewModels.forEach((e=>e&&!e.destroyed&&e.destroy())),this._set("contentViewModels",[])}_compileAttachments(e,t){const{graphic:r}=this;return this.contentViewModels[t]=new w({graphic:r}),e}_compileCustom(e,t){const{graphic:r}=this,{creator:o,destroyer:i}=e;return this.contentViewModels[t]=new M({graphic:r,creator:o,destroyer:i}),e}_compileFields(e,t){const{_effectivePopupTemplate:r,formattedAttributes:o}=this,i=e.clone(),s=(null==e?void 0:e.fieldInfos)||(null==r?void 0:r.fieldInfos),a=null==r?void 0:r.expressionInfos,n={...o.global,...o.content[t]},l=new A({attributes:n,expressionInfos:a,fieldInfos:s});return this.contentViewModels[t]=l,i.fieldInfos=l.formattedFieldInfos.slice(0),i}_compileMedia(e,t){const{graphic:r,_fieldInfoMap:o,_effectivePopupTemplate:i,relatedInfos:s,_sourceLayer:a}=this,{attributes:n}=r,l=this.formattedAttributes.global,p=e.clone(),{mediaInfos:c}=p,d=new V({activeMediaInfoIndex:p.activeMediaInfoIndex||0,attributes:n,layer:a,fieldInfoMap:o,formattedAttributes:l,mediaInfos:c,popupTemplate:i,relatedInfos:s});return p.mediaInfos=d.formattedMediaInfos.slice(0),this.contentViewModels[t]=d,p}_compileText(e,t){const r=e.clone(),{graphic:o,_fieldInfoMap:i,_sourceLayer:s}=this;if(r&&r.text){const{attributes:e}=o,t=this.formattedAttributes.global,a=_(r.text,{...t,...e},s);r.text=g({formattedAttributes:t,template:a,fieldInfoMap:i})}return this.contentViewModels[t]=new M({graphic:o,creator:r.text}),r}_compileLastEditInfo(){const{_effectivePopupTemplate:e,_sourceLayer:t,graphic:r}=this;if(!e)return;const{lastEditInfoEnabled:o}=e,i=null==t?void 0:t.editFieldsInfo;return o&&i?y(i,r.attributes):void 0}_compileTitle(e){const{_fieldInfoMap:t,_sourceLayer:r,graphic:o}=this,{attributes:i}=o,s=this.formattedAttributes.global;if(e){const o=_(e,{...s,...i},r);return g({formattedAttributes:s,template:o,fieldInfoMap:t})}return""}async _getTitle(){const{_effectivePopupTemplate:e,graphic:t}=this,r=null==e?void 0:e.title;return I(r,{graphic:t})}async _getContent(){const{_effectivePopupTemplate:e,graphic:t}=this,r=null==e?void 0:e.content;return I(r,{graphic:t})}async _queryFeature(e){const{_featureAbortController:t,_sourceLayer:r,graphic:o,_effectivePopupTemplate:i,spatialReference:s,map:n}=this,{content:{value:l},title:{value:p}}=await a({content:this._getContent(),title:this._getTitle()});if(t!==this._featureAbortController||!o)return;const{expressionAttributes:{value:c}}=await a({checkForRelatedFeatures:this._checkForRelatedFeatures(e),expressionAttributes:O({popupTemplate:this._effectivePopupTemplate,spatialReference:s,graphic:o,map:n}),queryUpdatedFeature:v({graphic:o,popupTemplate:i,layer:r},e)});t===this._featureAbortController&&o&&(this._set("formattedAttributes",this._createFormattedAttributes(l,c)),this._set("title",this._compileTitle(p)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(l)||null))}_createFormattedAttributes(e,t){const{_effectivePopupTemplate:r,graphic:o,relatedInfos:i,_sourceLayer:s,_fieldInfoMap:a}=this,n=null==r?void 0:r.fieldInfos,l={...o.attributes,...t},p={global:b({fieldInfos:n,graphic:o,attributes:l,layer:s,fieldInfoMap:a,relatedInfos:i}),content:[]};return Array.isArray(e)&&e.forEach(((e,t)=>{"fields"===e.type&&e.fieldInfos&&(p.content[t]=b({fieldInfos:e.fieldInfos,graphic:o,attributes:l,layer:s,fieldInfoMap:a,relatedInfos:i}))})),p}_checkForRelatedFeatures(e){const{graphic:t,_effectivePopupTemplate:r}=this;return this._queryRelatedInfos(t,h(r),e)}async _queryRelatedInfos(e,r,o){const{relatedInfos:i,_sourceLayer:s}=this;i.clear();const a=t(s.associatedLayer)?await s.associatedLayer.load(o):s;if(!a)return;const n=r.filter((e=>e&&T(e.fieldName)));if(!n||!n.length)return;r.forEach((e=>this._configureRelatedInfo(e,a)));const l=await F({relatedInfos:i,layer:a},o);Object.keys(l).forEach((e=>{var t;const r=i.get(e.toString()),o=null==(t=l[e])?void 0:t.value;r&&o&&(r.layerInfo=o.data)}));const p=await C({graphic:e,relatedInfos:i,layer:a},o);Object.keys(p).forEach((e=>{var t;j(null==(t=p[e])?void 0:t.value,i.get(e.toString()))}))}_configureRelatedInfo(e,t){const{relatedInfos:r}=this,o=L(e.fieldName);if(!o)return;const{layerId:i,fieldName:s}=o;if(!i)return;const a=r.get(i.toString())||x(i,t);a&&(E({relatedInfo:a,fieldName:s,fieldInfo:e}),this.relatedInfos.set(i,a))}};e([o()],R.prototype,"_featureAbortController",void 0),e([o({readOnly:!0,dependsOn:["graphic","graphic.sourceLayer.popupTemplate.title","graphic.sourceLayer.popupTemplate.content","graphic.sourceLayer.popupTemplate.expressionInfos","graphic.sourceLayer.popupTemplate.fieldInfos","graphic.sourceLayer.popupTemplate.lastEditInfoEnabled","graphic.sourceLayer.popupTemplate.outFields","graphic.sourceLayer.popupTemplate.relatedRecordsInfo","graphic.popupTemplate.title","graphic.popupTemplate.content","graphic.popupTemplate.expressionInfos","graphic.popupTemplate.fieldInfos","graphic.popupTemplate.lastEditInfoEnabled","graphic.popupTemplate.outFields","graphic.popupTemplate.relatedRecordsInfo","defaultPopupTemplateEnabled"]})],R.prototype,"_effectivePopupTemplate",null),e([o({readOnly:!0,dependsOn:["_effectivePopupTemplate","_sourceLayer"]})],R.prototype,"_fieldInfoMap",null),e([o({readOnly:!0,dependsOn:["graphic.layer","graphic.sourceLayer"]})],R.prototype,"_sourceLayer",null),e([o({readOnly:!0})],R.prototype,"content",void 0),e([o({readOnly:!0})],R.prototype,"contentViewModels",void 0),e([o({type:Boolean})],R.prototype,"defaultPopupTemplateEnabled",void 0),e([o({readOnly:!0})],R.prototype,"formattedAttributes",void 0),e([o({type:p,value:null})],R.prototype,"graphic",null),e([o({readOnly:!0})],R.prototype,"lastEditInfo",void 0),e([o()],R.prototype,"relatedInfos",void 0),e([o({dependsOn:["view"]})],R.prototype,"spatialReference",null),e([o({readOnly:!0})],R.prototype,"title",void 0),e([o({dependsOn:["view"]})],R.prototype,"map",null),e([o({readOnly:!0,dependsOn:["_featureAbortController"]})],R.prototype,"waitingForContent",null),e([o()],R.prototype,"view",void 0),R=e([i("esri.widgets.FeatureViewModel")],R);var U=R;export default U;
