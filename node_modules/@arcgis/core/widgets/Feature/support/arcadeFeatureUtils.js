/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import e from"../../../core/Logger.js";import{eachAlways as r}from"../../../core/promiseUtils.js";import{applyTextFormattingHTML as t,htmlEntities as a}from"./featureUtils.js";const s=["$datastore","$map","$layer"],o=e.getLogger("esri.widgets.Feature.support.arcadeFeatureUtils");async function i({expressionAttributes:e,info:r,arcadeUtils:i,spatialReference:n,map:c,graphic:p}){const l=`expression/${r.name}`,u=i.createSyntaxTree(r.expression),f=s.filter((e=>i.hasVariable(u,e)));await i.loadScriptDependencies(u,!0,f);const d=i.getViewInfo({spatialReference:n}),m=i.createExecContext(p,d);m.useAsync=!0,function({arcadeUtils:e,featureSetVars:r,context:t,viewInfo:a,map:s,graphic:o}){r.forEach((r=>{const i=r.toLowerCase(),n={map:s,spatialReference:a.sr};"$map"===i&&(t.vars[i]=e.convertMapToFeatureSetCollection(n)),"$layer"===i&&(t.vars[i]=e.convertFeatureLayerToFeatureSet(o.sourceLayer,a.sr)),"$datastore"===i&&(t.vars[i]=e.convertServiceUrlToWorkspace(o.sourceLayer.url,a.sr))}))}({arcadeUtils:i,featureSetVars:f,context:m,viewInfo:d,map:c,graphic:p});const g=i.createFunction(u,m),y=await i.executeAsyncFunction(g,m).catch((e=>o.error("arcade-execution-error",{error:e,graphic:p,expressionInfo:r})));var x;e[l]="string"==typeof y?t(a(y)):Array.isArray(y)?function(e){return`<ul class="esri-widget__list">${e.map((e=>`<li>${"string"==typeof e?t(a(e)):e}</li>`)).join("")}</ul>`}(y):y&&"esri.arcade.Dictionary"===y.declaredClass?`<table class="esri-widget__table">${(x=y).keys().map((e=>{const r=x.field(e);return`<tr><th>${e}</th><td>${"string"==typeof r?t(a(r)):r}</td></tr>`})).join("")}</table>`:y}async function n({popupTemplate:e,spatialReference:t,graphic:a,map:s}){const o=e.expressionInfos,n=[],c={};if(!o||!o.length)return c;const p=await import("../../../support/arcadeUtils.js");for(const e of o)n.push(i({expressionAttributes:c,info:e,arcadeUtils:p,spatialReference:t,map:s,graphic:a}));return await r(n),c}export{n as createFormattedExpressions};
