/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isNone as e}from"../../../core/maybe.js";import{replace as t}from"../../../core/string.js";import r from"../../../core/Logger.js";import n from"../../../core/Error.js";import{featureHasFields as o}from"../../../layers/support/fieldUtils.js";import{formatDate as i,convertDateFormatToIntlOptions as a}from"../../../intl/date.js";import{formatNumber as u,convertNumberFormatToIntlOptions as l}from"../../../intl/number.js";import s from"../../../popup/support/FieldInfoFormat.js";import"../../../intl.js";const f=r.getLogger("esri.widgets.Feature.support.featureUtils"),c=/href=(""|'')/gi,d=/(\{([^\{\r\n]+)\})/g,p=/\'/g,m=/^\s*expression\//i,y=/(\n)/gi,g=/[\u00A0-\u9999<>\&]/gim,h=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,F=/^(?:mailto:|tel:)/,b=a("short-date-short-time");function I(t){if(!e(t))return t.get("sourceLayer")||t.get("layer")}async function w(e,t){return"function"==typeof e?e.call(null,t):e}function N(e=""){if(e)return!F.test(e.trim().toLowerCase())}function j(e){return m.test(e)}function v(e,t){const r=function(e,t){if(!j(t)||!e)return null;const r=t.replace(m,"").toLowerCase();let n;return e.some((e=>e.name.toLowerCase()===r&&(n=e,!0))),n}(t,null==e?void 0:e.fieldName);return r?r.title||null:e?e.label||e.fieldName:null}function C(e,t){const r=q(t,e);return r?r.name:e}function L(e,t){return e&&e.map((e=>C(e,t)))}function q(e,t){return e&&"function"==typeof e.getField?e.getField(t):null}function E(e){return`${e}`.trim()}function D({formattedAttributes:e,template:r,fieldInfoMap:n}){return E(t(t(r,(e=>function(e,t){const r=t.get(e.toLowerCase());return`{${r&&r.fieldName||e}}`}(e,n))),e).replace(c,""))}function x(e,t=!1){const r={...e};return Object.keys(r).forEach((e=>function(e,t,r=!1){const n=t[e];if("string"==typeof n){const o="%27",i=(r?encodeURIComponent(n):n).replace(p,o);t[e]=i}}(e,r,t))),r}function T(e,t){return e.replace(d,((e,r,n)=>{const o=q(t,n);return o?`{${o.name}}`:r}))}function $(e,r,n){const o=T(e,n);return o?o.replace(h,((e,n,o)=>function(e,r,n){const o=(r=E(r))&&"{"!==r[0];return t(e,x(n,o))}(e,n||o,r))):o}function A(e,t){const r=t.fieldInfos,n=t.fieldName,o=M(r,n),i=null==o?void 0:o.clone(),a=t.preventPlacesFormatting,f=q(t.layer,n);if(i&&f&&"date"===f.type){const e=i.format||new s;e.dateFormat=e.dateFormat||"short-date-short-time",i.format=e}const c=i&&i.format;return"string"==typeof(e=function(e,t){if("string"==typeof e&&t&&null==t.dateFormat&&(null!=t.places||null!=t.digitSeparator)){const t=Number(e);if(!isNaN(t))return t}return e}(e,c))||null==e||null==c?e:a?u(e,{...l(c),minimumFractionDigits:0,maximumFractionDigits:20}):c.format(e)}function M(e,t){if(!e||!e.length||!t)return;const r=t.toLowerCase();let n;return e.some((e=>!(!e.fieldName||e.fieldName.toLowerCase()!==r)&&(n=e,!0))),n}function S(e,t){const{creatorField:r,creationDateField:n,editorField:o,editDateField:a}=e;if(!t)return;const u=t[a];if("number"==typeof u){const e=t[o];return{type:"edit",date:i(u,b),user:e}}const l=t[n];if("number"==typeof l){const e=t[r];return{type:"create",date:i(l,b),user:e}}return null}function G(e,t){const r=new Map;return e&&e.forEach((e=>{const n=C(e.fieldName,t);e.fieldName=n,r.set(n.toLowerCase(),e)})),r}function O(e){const t=[];if(!e)return t;const{fieldInfos:r,content:n}=e;return r&&t.push(...r),n&&Array.isArray(n)?(n.forEach((e=>{if("fields"===e.type){const r=e&&e.fieldInfos;r&&t.push(...r)}})),t):t}function k(e){return e.replace(g,(e=>`&#${e.charCodeAt(0)};`))}function U(e){return"string"==typeof e?e.replace(y,'<br class="esri-text-new-line" />'):e}function R(e){const{value:t,fieldName:r,fieldInfos:n,fieldInfoMap:o,layer:a,graphic:u}=e;if(null==t)return"";const l=function({fieldName:e,value:t,graphic:r,layer:n}){if(z(e))return null;if(!n||"function"!=typeof n.getFieldDomain)return null;const o=n.getFieldDomain(e,{feature:r});return o&&"coded-value"===o.type?o.getName(t):null}({fieldName:r,value:t,graphic:u,layer:a});if(l)return l;const s=function({fieldName:e,graphic:t,layer:r}){if(z(e))return null;if(!r||"function"!=typeof r.getFeatureType)return null;const{typeIdField:n}=r;if(!n||e!==n)return null;const o=r.getFeatureType(t);return o?o.name:null}({fieldName:r,graphic:u,layer:a});if(s)return s;if(o.get(r.toLowerCase()))return A(t,{fieldInfos:n,fieldName:r,layer:a});const f=a&&a.fieldsIndex;return f&&f.isDateField(r)?i(t,b):U(t)}function P({fieldInfos:e,attributes:t,layer:r,graphic:n,fieldInfoMap:o,relatedInfos:i}){const a={...t};return null==i||i.forEach((e=>function(e,t){if(!e||!t)return;t.relatedFeatures&&t.relatedFeatures&&t.relatedFeatures.forEach((r=>B({attributes:e,graphic:r,relatedInfo:t})));t.relatedStatsFeatures&&t.relatedStatsFeatures&&t.relatedStatsFeatures.forEach((r=>B({attributes:e,graphic:r,relatedInfo:t})))}(a,e))),Object.keys(a).forEach((t=>{const i=a[t];a[t]=R({fieldName:t,fieldInfos:e,fieldInfoMap:o,layer:r,value:i,graphic:n})})),a}async function Q({graphic:e,popupTemplate:t,layer:r},i){if(!r||!t)return;const{returnGeometry:a}=t;"function"==typeof r.load&&await r.load(i);const u=e.attributes[r.objectIdField];if(null==u)return;const l=[u],s=await t.getRequiredFields(r.fields),c=o(s,e),d=c?[]:s;if(c&&!a)return;const p=await async function(e,t){const{layer:r,graphic:o,outFields:i,objectIds:a,returnGeometry:u}=e,l=a[0];if("number"!=typeof l){const e="Could not query required fields for the specified feature. The feature's ID is invalid.",t={layer:r,graphic:o,objectId:l,requiredFields:i},a=new n("layer-query-features-invalid-objectid",e,t);throw f.warn(e,t),a}if("function"!=typeof r.queryFeatures){const e="The specified layer does not support the method 'queryFeatures'. The following fields will not be available.",t={layer:r,graphic:o,requiredFields:i},a=new n("layer-query-features-unsupported",e,t);throw f.warn(e,t),a}const s=r.createQuery();return s.objectIds=a,s.outFields=i,s.returnGeometry=!!u,(await r.queryFeatures(s,t)).features[0]}({layer:r,graphic:e,outFields:d,objectIds:l,returnGeometry:a},i);p&&(p.geometry&&(e.geometry=p.geometry),p.attributes&&(e.attributes={...e.attributes,...p.attributes}))}function z(e=""){return!!e&&-1!==e.indexOf("relationships/")}function B({attributes:e,graphic:t,relatedInfo:r}){e&&t&&r&&Object.keys(t.attributes).forEach((n=>{const o=(i={layerId:r.relation.id.toString(),fieldName:n})?`relationships/${i.layerId}/${i.fieldName}`:"";var i;e[o]=t.attributes[n]}))}export{U as applyTextFormattingHTML,G as createfieldInfoMap,T as fixTokens,P as formatAttributes,S as formatEditInfo,A as formatValueToFieldInfo,O as getAllFieldInfos,M as getFieldInfo,v as getFieldInfoLabel,C as getFixedFieldName,L as getFixedFieldNames,I as getSourceLayer,w as graphicCallback,k as htmlEntities,j as isExpressionField,z as isRelatedField,$ as processFieldsInLinks,Q as queryUpdatedFeature,N as shouldOpenInNewTab,D as substituteAttributes};
