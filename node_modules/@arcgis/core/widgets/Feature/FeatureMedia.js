/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../core/has.js";import"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import{property as t}from"../../core/accessorSupport/decorators/property.js";import{aliasOf as i}from"../../core/accessorSupport/decorators/aliasOf.js";import{subclass as r}from"../../core/accessorSupport/decorators/subclass.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import{eventKey as a}from"../../core/events.js";import{init as s}from"../../core/watchUtils.js";import{isDarkTheme as o,isRTL as n}from"../support/widgetUtils.js";import{messageBundle as l}from"../support/decorators/messageBundle.js";import{renderable as d}from"../support/decorators/renderable.js";import{j as c}from"../../chunks/index.js";import u from"../Widget.js";import{shouldOpenInNewTab as p}from"./support/featureUtils.js";import h from"./FeatureMedia/FeatureMediaViewModel.js";import{loadChartsModule as m,getColorSet as f}from"../support/chartUtils.js";const v="esri-feature-media",M="esri-feature-media__container",_="esri-feature-media__item-container",I="esri-feature-media__item",w="esri-feature-media__item-title",g="esri-feature-media__item-caption",y="esri-feature-media__previous",b="esri-feature-media__previous-icon",x="esri-feature-media__previous-icon--rtl",C="esri-feature-media__next",T="esri-feature-media__next-icon",j="esri-feature-media__next-icon--rtl",F="esri-feature-media__chart",L="esri-feature-media__button",k="esri-feature-media__icon",S="esri-icon-left-triangle-arrow",A="esri-icon-right-triangle-arrow";let P=class extends u{constructor(e,t){super(e,t),this._refreshTimer=null,this._refreshIntervalInfo=null,this.attributes=null,this.activeMediaInfoIndex=null,this.fieldInfoMap=null,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.viewModel=new h,this.messages=null}initialize(){this.own(s(this,["viewModel.activeMediaInfo","viewModel.activeMediaInfoIndex"],(()=>this._setupMediaRefreshTimer())))}destroy(){this._clearMediaRefreshTimer()}render(){return c("div",{bind:this,class:v,onkeyup:this._handleMediaKeyup},this.renderMedia())}renderMedia(){const{formattedMediaInfoCount:e}=this.viewModel;return e?c("div",{key:"media-element-container",class:M},this.renderMediaPageButton("previous"),this.renderMediaInfo(),this.renderMediaPageButton("next")):null}renderImageMediaInfo(e){const{_refreshIntervalInfo:t}=this,{activeMediaInfoIndex:i,formattedMediaInfoCount:r}=this.viewModel,{value:a,refreshInterval:s,altText:o,title:n,type:l}=e,{sourceURL:d,linkURL:u}=a,h=p(u)?"_blank":"_self",m="_blank"===h?"noreferrer":"",f=s?t:null,v=f?f.timestamp:0,M=f?f.sourceURL:d,_=c("img",{alt:o||n,key:`media-${l}-${i}-${r}-${v}`,src:M}),I=u?c("a",{title:n,href:u,rel:m,target:h},_):null;return I||_}renderChartMediaInfo(e){const{activeMediaInfoIndex:t,formattedMediaInfoCount:i}=this.viewModel;return c("div",{key:`media-${e.type}-${t}-${i}`,bind:this,class:F,afterCreate:this._getChartDependencies})}renderMediaInfoType(){const{activeMediaInfo:e}=this.viewModel;return e?"image"===e.type?this.renderImageMediaInfo(e):-1!==e.type.indexOf("chart")?this.renderChartMediaInfo(e):null:null}renderMediaInfo(){const{activeMediaInfo:e}=this.viewModel,t=e.title?c("div",{key:"media-title",class:w,innerHTML:e.title}):null,i=e.caption?c("div",{key:"media-caption",class:g,innerHTML:e.caption}):null;return c("div",{key:"media-container",class:_},t,i,c("div",{key:"media-item-container",class:I},this.renderMediaInfoType()))}renderMediaPageButton(e){if(this.viewModel.formattedMediaInfoCount<2)return null;const t="previous"===e,i=t?this.messages.previous:this.messages.next,r=t?this.classes(L,y):this.classes(L,C),a=t?this.classes(k,b,S):this.classes(k,T,A),s=t?this.classes(k,x,A):this.classes(k,j,S),o=t?"media-previous":"media-next",n=t?this._previous:this._next;return c("button",{type:"button",key:o,title:i,"aria-label":i,tabIndex:0,class:r,bind:this,onclick:n},c("span",{"aria-hidden":"true",class:a}),c("span",{"aria-hidden":"true",class:s}))}_next(){this.viewModel.next()}_previous(){this.viewModel.previous()}async _getChartDependencies(e){const t=await m(),{activeMediaInfo:i}=this.viewModel;this._renderChart({chartDiv:e,mediaInfo:i,chartsModule:t})}_handleMediaKeyup(e){const t=a(e);"ArrowLeft"===t&&(e.stopPropagation(),this.viewModel.previous()),"ArrowRight"===t&&(e.stopPropagation(),this.viewModel.next())}_renderChart(e){const{chartsModule:t,chartDiv:i,mediaInfo:r}=e,{value:a,type:s}=r,{am4core:n}=t,l=f(n);o()&&n.useTheme(t.am4themes_dark),n.useTheme(t.am4themes_animated),n.useTheme((function(e){e instanceof n.ColorSet&&l&&(e.list=l)}));const d="pie-chart"===s?this._createPieChart(e):this._createXYChart(e);i.setAttribute("aria-label",r.altText||r.title),d.data=a.series.map((e=>({tooltip:e.tooltip,value:e.value}))).filter((e=>"pie-chart"!==s||e.value>0))}_customizeChartTooltip(e,t){e.label.wrap=!0,e.label.maxWidth=200,e.autoTextColor=!1,e.getFillFromObject=!1,e.label.fill=t.color("#ffffff"),e.background.fill=t.color({r:0,g:0,b:0,a:.7})}_createPieChart(e){const{chartDiv:t,chartsModule:i}=e,{am4core:r,am4charts:a}=i,s=r.create(t,a.PieChart);s.rtl=n();const o=s.series.push(new a.PieSeries);return o.labels.template.disabled=!0,o.ticks.template.disabled=!0,o.dataFields.value="value",o.dataFields.category="tooltip",this._customizeChartTooltip(o.tooltip,r),s}_getMinSeriesValue(e){let t=0;return e.forEach((e=>t=Math.min(e.value,t))),t}_createColumnChart(e,t){const{chartsModule:i,mediaInfo:r}=t,{value:a}=r,{am4core:s,am4charts:o}=i,n=e.xAxes.push(new o.CategoryAxis);n.dataFields.category="tooltip",n.renderer.labels.template.disabled=!0,this._customizeChartTooltip(n.tooltip,s),n.tooltip.events.on("sizechanged",(()=>{n.tooltip.dy=-n.tooltip.contentHeight}));const l=e.yAxes.push(new o.ValueAxis),d=l.renderer.labels.template;l.renderer.minLabelPosition=.05,l.renderer.maxLabelPosition=.95,l.min=this._getMinSeriesValue(a.series),this._customizeChartTooltip(l.tooltip,s),d.wrap=!0;const c=e.series.push(new o.ColumnSeries);c.dataFields.valueY="value",c.dataFields.categoryX="tooltip",e.cursor=new o.XYCursor,a.series.length>15&&(e.scrollbarX=new s.Scrollbar)}_createBarChart(e,t){const{chartsModule:i,mediaInfo:r}=t,{value:a}=r,{am4core:s,am4charts:o}=i,n=e.yAxes.push(new o.CategoryAxis);n.dataFields.category="tooltip",n.renderer.inversed=!0,n.renderer.labels.template.disabled=!0,this._customizeChartTooltip(n.tooltip,s),n.tooltip.events.on("sizechanged",(()=>{n.tooltip.dx=n.tooltip.contentWidth}));const l=e.xAxes.push(new o.ValueAxis),d=l.renderer.labels.template;l.renderer.minLabelPosition=.05,l.renderer.maxLabelPosition=.95,l.min=this._getMinSeriesValue(a.series),this._customizeChartTooltip(l.tooltip,s),d.wrap=!0;const c=e.series.push(new o.ColumnSeries);c.dataFields.valueX="value",c.dataFields.categoryY="tooltip",e.cursor=new o.XYCursor,a.series.length>15&&(e.scrollbarY=new s.Scrollbar)}_createLineChart(e,t){const{chartsModule:i,mediaInfo:r}=t,{value:a}=r,{am4core:s,am4charts:o}=i,n=e.xAxes.push(new o.CategoryAxis);n.dataFields.category="tooltip",n.renderer.labels.template.disabled=!0,this._customizeChartTooltip(n.tooltip,s),n.tooltip.events.on("sizechanged",(()=>{n.tooltip.dy=-n.tooltip.contentHeight}));const l=e.yAxes.push(new o.ValueAxis),d=l.renderer.labels.template;l.renderer.minLabelPosition=.05,l.renderer.maxLabelPosition=.95,l.min=this._getMinSeriesValue(a.series),this._customizeChartTooltip(l.tooltip,s),d.wrap=!0;const c=e.series.push(new o.LineSeries);c.dataFields.categoryX="tooltip",c.dataFields.valueY="value",e.cursor=new o.XYCursor,a.series.length>15&&(e.scrollbarX=new s.Scrollbar)}_createXYChart(e){const{chartDiv:t,chartsModule:i,mediaInfo:r}=e,{type:a}=r,{am4core:s,am4charts:o}=i,l=s.create(t,o.XYChart);return l.rtl=n(),"column-chart"===a&&this._createColumnChart(l,e),"bar-chart"===a&&this._createBarChart(l,e),"line-chart"===a&&this._createLineChart(l,e),l}_clearMediaRefreshTimer(){const{_refreshTimer:e}=this;e&&(clearTimeout(e),this._refreshTimer=null)}_updateMediaInfoTimestamp(e){const t=Date.now();this._refreshIntervalInfo={timestamp:t,sourceURL:this._getImageSource(e,t)},this.scheduleRender()}_setupMediaRefreshTimer(){this._clearMediaRefreshTimer();const{activeMediaInfo:e}=this.viewModel;e&&"image"===e.type&&e.refreshInterval&&this._setRefreshTimeout(e)}_setRefreshTimeout(e){const{refreshInterval:t,value:i}=e;if(!t)return;const r=6e4*t;this._updateMediaInfoTimestamp(i.sourceURL);const a=setInterval((()=>{this._updateMediaInfoTimestamp(i.sourceURL)}),r);this._refreshTimer=a}_getImageSource(e,t){const i=-1!==e.indexOf("?")?"&":"?",[r,a=""]=e.split("#");return`${r}${i}timestamp=${t}${a?"#":""}${a}`}};e([i("viewModel.attributes")],P.prototype,"attributes",void 0),e([i("viewModel.activeMediaInfoIndex")],P.prototype,"activeMediaInfoIndex",void 0),e([i("viewModel.fieldInfoMap")],P.prototype,"fieldInfoMap",void 0),e([i("viewModel.layer")],P.prototype,"layer",void 0),e([i("viewModel.mediaInfos")],P.prototype,"mediaInfos",void 0),e([i("viewModel.popupTemplate")],P.prototype,"popupTemplate",void 0),e([i("viewModel.relatedInfos")],P.prototype,"relatedInfos",void 0),e([t({type:h}),d(["viewModel.formattedMediaInfos","viewModel.activeMediaInfoIndex","viewModel.activeMediaInfo"])],P.prototype,"viewModel",void 0),e([t(),d(),l("esri/widgets/Feature/t9n/Feature")],P.prototype,"messages",void 0),P=e([r("esri.widgets.Feature.FeatureMedia")],P);var R=P;export default R;
