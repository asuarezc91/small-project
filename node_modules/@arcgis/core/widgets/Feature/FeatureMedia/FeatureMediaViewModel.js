/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as t}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as e}from"../../../core/accessorSupport/decorators/property.js";import{subclass as o}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import a from"../../../core/Accessor.js";import r from"../../../popup/FieldInfo.js";import i from"../../../popup/content/support/ChartMediaInfoValueSeries.js";import{processFieldsInLinks as s,substituteAttributes as l,fixTokens as n,getFixedFieldNames as d,getFixedFieldName as p,isRelatedField as f,formatValueToFieldInfo as u,getFieldInfo as m,getFieldInfoLabel as c}from"../support/featureUtils.js";import{getRelatedFieldInfo as h}from"../support/relatedFeatureUtils.js";let I=class extends a{constructor(t){super(t),this.activeMediaInfoIndex=0,this.attributes=null,this.fieldInfoMap=null,this.formattedAttributes=null,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null}get activeMediaInfo(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}get formattedMediaInfos(){return this._formatMediaInfos()||[]}get formattedMediaInfoCount(){return this.formattedMediaInfos.length}setActiveMedia(t){this._setContentElementMedia(t)}next(){this._pageContentElementMedia(1)}previous(){this._pageContentElementMedia(-1)}_setContentElementMedia(t){const{formattedMediaInfoCount:e}=this,o=(t+e)%e;this.activeMediaInfoIndex=o}_pageContentElementMedia(t){const{activeMediaInfoIndex:e}=this,o=e+t;this._setContentElementMedia(o)}_formatMediaInfos(){const{attributes:t,mediaInfos:e,formattedAttributes:o,fieldInfoMap:a,layer:r}=this,i={...o,...t};return null==e?void 0:e.map((e=>{if(!e)return null;const n=e.title?s(e.title,i,r):"";e.title=n?l({formattedAttributes:o,template:n,fieldInfoMap:a}):"";const d=e.caption?s(e.caption,i,r):"";e.caption=d?l({formattedAttributes:o,template:d,fieldInfoMap:a}):"";const p=e.altText?s(e.altText,i,r):"";if(e.altText=p?l({formattedAttributes:o,template:p,fieldInfoMap:a}):"","image"===e.type){const{value:t}=e;return this._setImageValue({value:t,formattedAttributes:o,layer:r}),e.value.sourceURL?e:void 0}if("pie-chart"===e.type||"line-chart"===e.type||"column-chart"===e.type||"bar-chart"===e.type){const{value:a}=e;return this._setChartValue({value:a,chartType:e.type,attributes:t,formattedAttributes:o,layer:r}),e}return null})).filter(Boolean)}_setImageValue(t){const{fieldInfoMap:e}=this,{value:o,formattedAttributes:a,layer:r}=t,{linkURL:i,sourceURL:s}=o;if(s){const t=n(s,r);o.sourceURL=l({formattedAttributes:a,template:t,fieldInfoMap:e})}if(i){const t=n(i,r);o.linkURL=l({formattedAttributes:a,template:t,fieldInfoMap:e})}}_setChartValue(t){const{value:e,attributes:o,formattedAttributes:a,chartType:r,layer:i}=t,{popupTemplate:s,relatedInfos:l}=this,{fields:n,normalizeField:u}=e;e.fields=d(n,i),u&&(e.normalizeField=p(u,i));if(!n.some((t=>!!(null!=a[t]||f(t)&&l.size))))return;const m=null==s?void 0:s.fieldInfos;n.forEach((t=>{if(f(t))return void(e.series=[...e.series,...this._getRelatedChartInfos({fieldInfos:m,fieldName:t,formattedAttributes:a,chartType:r,value:e})]);const i=this._getChartOption({value:e,attributes:o,chartType:r,formattedAttributes:a,fieldName:t,fieldInfos:m});e.series.push(i)}))}_getRelatedChartInfos(t){var e;const{fieldInfos:o,fieldName:a,formattedAttributes:r,chartType:i,value:s}=t,l=[],n=h(a),{layerId:d,fieldName:p}=n,f=null==(e=this.relatedInfos)?void 0:e.get(d.toString());if(!f)return l;const{relatedFeatures:u,relation:m}=f;if(!m||!u)return l;const{cardinality:c}=m;u.forEach((t=>{const{attributes:e}=t;e&&Object.keys(e).forEach((t=>{t===p&&l.push(this._getChartOption({value:s,attributes:e,formattedAttributes:r,fieldName:a,chartType:i,relatedFieldName:t,fieldInfos:o}))}))}));return"one-to-many"===c||"many-to-many"===c?l:[l[0]]}_getTooltip({label:t,value:e,chartType:o}){return"pie-chart"===o?t:`${t}: ${e}`}_getChartOption(t){var e;const{value:o,attributes:a,formattedAttributes:s,fieldName:l,relatedFieldName:n,fieldInfos:d,chartType:I}=t,{layer:v}=this,{normalizeField:y,tooltipField:M}=o,b=y?f(y)?a[h(y).fieldName]:a[y]:null,g=n&&void 0!==a[n]?a[n]:void 0!==a[l]?a[l]:s[l],T=void 0===g?null:g&&b?g/b:g,_=new i({value:T});if(f(l)){const t=h(l),e=h(M),o=e?e.fieldName:null,r=u(T,{fieldInfos:d,fieldName:n,layer:v,preventPlacesFormatting:!!b}),i=t?t.label||t.fieldName:n,s=o&&void 0!==a[o]?a[o]:i;return _.tooltip=this._getTooltip({label:s,value:r,chartType:I}),_}const A=m(d,l),C=p(l,v),j=M&&void 0!==s[M]?s[M]:c(A||new r({fieldName:C}),null==(e=this.popupTemplate)?void 0:e.expressionInfos),x=s[C];return _.tooltip=this._getTooltip({label:j,value:x,chartType:I}),_}};t([e()],I.prototype,"activeMediaInfoIndex",void 0),t([e({readOnly:!0,dependsOn:["formattedMediaInfos","activeMediaInfoIndex"]})],I.prototype,"activeMediaInfo",null),t([e()],I.prototype,"attributes",void 0),t([e()],I.prototype,"fieldInfoMap",void 0),t([e()],I.prototype,"formattedAttributes",void 0),t([e({readOnly:!0,dependsOn:["attributes","fieldInfoMap","formattedAttributes","mediaInfos","popupTemplate","layer","relatedInfos"]})],I.prototype,"formattedMediaInfos",null),t([e()],I.prototype,"layer",void 0),t([e({readOnly:!0,dependsOn:["formattedMediaInfos"]})],I.prototype,"formattedMediaInfoCount",null),t([e()],I.prototype,"mediaInfos",void 0),t([e()],I.prototype,"popupTemplate",void 0),t([e()],I.prototype,"relatedInfos",void 0),I=t([o("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],I);var v=I;export default v;
