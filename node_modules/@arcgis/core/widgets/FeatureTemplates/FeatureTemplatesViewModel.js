/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../core/has.js";import"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import{property as t}from"../../core/accessorSupport/decorators/property.js";import{subclass as r}from"../../core/accessorSupport/decorators/subclass.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import s from"../../core/ObjectPool.js";import o from"../../core/Evented.js";import{when as a}from"../../core/watchUtils.js";import{HandleOwnerMixin as l}from"../../core/HandleOwner.js";import i from"./TemplateItem.js";import p from"./TemplateItemGroup.js";const n=({layer:e})=>({key:e,label:e.title}),m=({layer:e})=>e.geometryType;let c=class extends(l(o.EventedAccessor)){constructor(e){super(e),this._templateToLayer=new Map,this._itemPool=new s(i),this._groupPool=new s(p),this.filterFunction=null,this.groupBy="layer"}destroy(){this._templateToLayer.clear(),this._templateToLayer=null}set layers(e){if(this.handles.removeAll(),e){const t=()=>this.notifyChange("state");this.handles.add(e.map((e=>a(e,"loadStatus",t))))}this._set("layers",e)}get layers(){return this._get("layers")}get state(){const{layers:e}=this;return e&&0!==e.length?e.some((e=>"loading"===e.loadStatus||"not-loaded"===e.loadStatus))?"loading":"ready":"disabled"}get items(){const{layers:e}=this;if(this._destroyItems(this._get("items")),!e||0===e.length)return[];this._templateToLayer.clear();const t=e.filter((({capabilities:e,loaded:t})=>t&&e.operations.supportsEditing&&e.operations.supportsAdd)).map((e=>{const t=this._getTemplatesForLayer(e);if(t.length>0)return t.forEach((t=>this._templateToLayer.set(t,e))),t})).filter((e=>null!=e)),{groupBy:r}=this;if("none"===r)return t.map((e=>e.filter((({name:e})=>!this.filterFunction||this.filterFunction({label:e}))))).map((e=>e.map((e=>this._createItem(e))))).reduce(((e,t)=>[...e,...t]),[]);const s=t.reduce(((e,t)=>(t.forEach((t=>{const s=("layer"===r?n:"geometry"===r?m:r)({template:t,layer:this._templateToLayer.get(t)});if(s){const r="string"==typeof s?s:s.key,o="string"==typeof s?s:s.label;e.has(r)||e.set(r,{label:o,templates:[]}),e.get(r).templates.push(t)}})),e)),new Map);if(0===s.size)return[];const o=[],{filterFunction:a}=this;return s.forEach((e=>{const{label:t,templates:r}=e;if(!a||this.filterFunction(e))o.push(this._createGroup(t,r.map((e=>this._createItem(e)))));else{const e=r.filter((({name:e})=>this.filterFunction({label:e}))).map((e=>this._createItem(e)));e.length>0&&o.push(this._createGroup(t,e))}})),o}refresh(){this.notifyChange("items")}select(e){const t=e.clone();this.emit("select",{item:t,template:t.template})}_getTemplatesForLayer(e){return[...e.templates||[],...(e.types||[]).map((e=>e.templates)).reduce(((e,t)=>[...e,...t]),[])]}_createItem(e){const t=this._itemPool.acquire();return t.set({template:e,layer:this._templateToLayer.get(e)}),t}_createGroup(e,t){const r=this._groupPool.acquire();return r.set("label",e),r.items=t,r}_destroyItems(e){if(!e)return;e[0]instanceof i?e.forEach((e=>this._destroyItem(e))):e.forEach((e=>this._destroyGroup(e)))}_destroyGroup(e){e.items.forEach((e=>this._destroyItem(e))),e.items.length=0,this._groupPool.release(e)}_destroyItem(e){e.layer=null,e.template=null,this._itemPool.release(e)}};e([t()],c.prototype,"filterFunction",void 0),e([t()],c.prototype,"groupBy",void 0),e([t()],c.prototype,"layers",null),e([t({dependsOn:["layers"]})],c.prototype,"state",null),e([t({dependsOn:["filterFunction","groupBy","layers","state"],readOnly:!0})],c.prototype,"items",null),c=e([r("esri.widgets.FeatureTemplates.FeatureTemplatesViewModel")],c);var u=c;export default u;
