/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../core/has.js";import{isSome as t}from"../../core/maybe.js";import"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import"../../core/accessorSupport/decorators/property.js";import{subclass as i}from"../../core/accessorSupport/decorators/subclass.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import r from"./CreateWorkflowData.js";import o from"./Edits.js";import a from"./Workflow.js";import{setUpFeatureAdd as s,findLayerInfo as n,getVisualVariableAttributes as l,setUpGeometryUpdate as f}from"./workflowUtils.js";var d;let c=d=class extends a{constructor(e){super(e),this.type="create"}static create(e,t,i){const a=new r({edits:new o,viewModel:e}),s=new d({data:a,afterCommit:i});return s._set("steps",this._createWorkflowSteps(s,t)),s}static _createWorkflowSteps(e,i="awaiting-feature-creation-info"){const{data:r,handles:o}=e,a={"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){r.creationInfo=null,o.add(r.viewModel.featureTemplatesViewModel.on("select",(({item:e})=>{r.creationInfo={layer:e.layer,template:e.template},r.viewModel.activeWorkflow.next()})),this.id)},async tearDown(){o.remove(this.id)}}),"awaiting-feature-to-create":()=>({id:"awaiting-feature-to-create",async setUp(){o.add(await s(r.viewModel.sketchViewModel,r.creationInfo,r.viewModel.view,(e=>{r.edits.feature=e,r.viewModel.activeWorkflow.next()})),this.id)},async tearDown(){o.remove(this.id)}}),"editing-new-feature":()=>({id:"editing-new-feature",async setUp(){const e=r.edits.feature,i=r.viewModel,a=n(i.layerInfos,e.layer),s=a&&a.fieldConfig;i.featureFormViewModel.set({feature:e,fieldConfig:s});const d=l(e),{interactive:c,visual:u}=await f(e,d,i.sketchViewModel,i.view,(({geometry:e,attributes:o})=>{if(t(d.rotation)){const{field:e}=d.rotation;i.featureFormViewModel.setValue(e,o[e])}if(t(d.size)){const{field:e}=d.size;i.featureFormViewModel.setValue(e,o[e])}r.edits.updateAttributes(o),r.edits.updateGeometry(e)}));o.add([r.viewModel.featureFormViewModel.on("value-change",(()=>{r.edits.updateAttributes(r.viewModel.featureFormViewModel.getValues()),e.attributes=r.edits.feature.attributes})),c,u],this.id)},async tearDown(){r.edits.feature=null,r.viewModel.featureFormViewModel.set({feature:null,fieldConfig:null}),o.remove(this.id)}})};let d=!1;const c=["awaiting-feature-creation-info","awaiting-feature-to-create","editing-new-feature"].filter((e=>!!d||(d=e===i,d))).map((e=>a[e]()));r.viewModel.refreshCreationTemplates();const u=function(e){if(1!==e.length)return null;const[t]=e;if(!("items"in t))return t;{const e=t;if(1===e.items.length)return e.items[0]}return null}(r.viewModel.featureTemplatesViewModel.items),[w]=c;if("awaiting-feature-creation-info"===w.id&&u){const{layer:e,template:t}=u;r.creationInfo={layer:e,template:t},c.shift()}return c}};c=d=e([i("esri.widgets.Editor.CreateWorkflow")],c);var u=c;export default u;
