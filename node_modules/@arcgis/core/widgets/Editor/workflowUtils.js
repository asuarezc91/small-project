/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import"../../core/has.js";import{isNone as e,isSome as t}from"../../core/maybe.js";import{resolve as r,whenOrAbort as i,eachAlways as a}from"../../core/promiseUtils.js";import{hasField as n}from"../../layers/support/fieldUtils.js";import{px2pt as s}from"../../core/screenUtils.js";import{t as l}from"../../chunks/symbols.js";import o from"../../Graphic.js";import{meterIn as c}from"../../renderers/support/lengthUtils.js";import{getTransformationType as u}from"../../renderers/visualVariables/support/sizeVariableUtils.js";import{getVisualVariableValues as p}from"../../renderers/visualVariables/support/visualVariableUtils.js";import{diff as y}from"../../core/accessorSupport/diffUtils.js";import{hitTestSelectSameDistance as d}from"../../views/support/hitTestSelectUtils.js";import{calculateTolerance as f}from"../../renderers/support/clickToleranceUtils.js";import{createQueryGeometry as m}from"../../views/support/drapedUtils.js";import{getDisplayedSymbol as b}from"../../symbols/support/symbolUtils.js";function g(e){const t=e.layer,r=function(e){switch(e.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":return!0;default:return!1}}(t.renderer)&&p(t.renderer,e),i=r?r.map((e=>e.variable)):[],a=i.filter((e=>"rotation"===e.type&&(!e.axis||"heading"===e.axis))),n=a[0],s=1===a.length&&n.field&&!n.valueExpression,l=i.filter((e=>"size"===e.type)),o=l[0],c=1===l.length&&"real-world-size"===u(o)&&o.field&&!o.useSymbolValue&&!o.valueExpression;return{rotation:s?h(n,t):null,size:c?v(o,t):null}}function h(e,t){const i="heading"===(e.axis||"heading")&&"arithmetic"===e.rotationType?-1:1,a=e.field,n=t.fields&&t.fields.filter((e=>e.name===a)),s=n&&1===n.length?n[0].type:"double",l={initial:0,current:0};return{field:a,getDefault:()=>r(0),getValue:e=>(l.current=l.initial-i*e,w((l.current+360)%360,s)),initValue:e=>{l.initial=null!=e?e:l.current,l.current=0},isUpdatingInteractively:!1}}function v(t,r){const i=t.field,a=t.axis,n=r.fields&&r.fields.filter((e=>e.name===i)),s=n&&1===n.length?n[0].type:"double",o={updating:!1,initial:0,current:0},u=c[t.valueUnit];let p;return p="area"===t.valueRepresentation?e=>Math.pow(e*u/2,2)*Math.PI:"radius"===t.valueRepresentation||"distance"===t.valueRepresentation?e=>e*u/2:e=>e*u,{field:i,getDefault:async(t,r)=>w(p(await async function(t,r,i){if(e(r))return 0;const{symbol:a}=l(r);if(e(a)||"web-style"===a.type)return 0;const n=a.symbolLayers.getItemAt(0);if(!n)return 0;switch(n.type){case"icon":{const{computeIconLayerResourceSize:e}=await import("../../symbols/support/symbolLayerUtils.js");return n.size||Math.min(F.icon,(await e(n,F.icon))[0])||F.icon}case"text":return n.size||F.text;case"line":return n.size||F.line;case"object":{const{computeObjectLayerResourceSize:e}=await import("../../symbols/support/symbolLayerUtils.js");return function(e,t){switch(t){case"width":return e[0];case"depth":return e[1];case"height":return e[2];default:return e[2]||e[1]||e[0]}}(await e(n,t.scale/F.viewScaleSizeFactor),i)}case"path":case"extrude":return n.size||t.scale/F.viewScaleSizeFactor;case"fill":case"water":default:return 0}}(r,t,a)),s),getValue:(e,t)=>(o.initial||(o.initial=t.pixelSizeAt(t.center)),o.current=o.initial*e,w(o.current,s)),initValue:e=>{o.initial=null!=e?e:o.current,o.current=0},isUpdatingInteractively:!1}}function w(e,t){switch(t){case"small-integer":case"integer":case"long":return Math.round(e);case"double":case"single":return e;default:return 0}}async function j(e){const r=await b(e,{ignoreGraphicSymbol:!0}),i=y(e.symbol,r);t(i)&&(e.symbol=r)}async function I(t,r,i,a){const n=r.layer;await async function(t,r,i){var a;if("3d"!==i.type)return;const n=r.layer,s={...r.template.prototype.attributes},l=new o({layer:n,sourceLayer:n,attributes:s}),{rotation:c,size:u}=g(l);let p=await b(l),y=!1;for(const t of[u,c]){if(e(t))continue;null==s[t.field]&&(s[t.field]=await t.getDefault(p,i),y=!0)}y&&(p=await b(l));switch(null==(a=p)?void 0:a.type){case"simple-fill":case"polygon-3d":t.polygonSymbol=p;break;case"simple-line":case"line-3d":t.polylineSymbol=p;break;case"simple-marker":case"point-3d":t.pointSymbol=p}}(t,r,i),t.layer.elevationInfo=n.elevationInfo;const s=()=>t.create(n.geometryType,{hasZ:n.capabilities.data.supportsZ});await s();const l=t.on("create",(async e=>{const{state:i,graphic:l}=e;if("cancel"!==i){if("complete"===i){const e=l.clone();e.attributes={...r.template.prototype.attributes},e.layer=n,t.layer.remove(l),await j(e),a(e)}}else s()}));return i.map.add(t.layer),{remove:()=>{l.remove(),i.map.remove(t.layer),t.cancel()}}}function S(e,t){return e&&e.find((e=>e.layer===t))}async function U(e,t,r,s){if(0===e.length)return[];const{updatable:l,graphicsByLayer:o}=await r.async((async()=>{const{results:a}=await i(d(t,r),s),n=new Map;a.forEach((({graphic:e})=>(({layer:e})=>{const t=n.get(e);if(!t){const t=new Array;return n.set(e,t),t}return t})(e).push(e)));const l=e.filter((({supports:e,layer:t})=>e.indexOf("update")>-1&&n.has(t)));return 0!==l.length&&r.stopPropagation(),{updatable:l,graphicsByLayer:n}}));return a(l.map((async({layer:e})=>{const{objectIdField:t,displayField:r}=e,i=[t];n(e.fields,r)&&i.push(r);const a=o.get(e);if(!!a.some((e=>i.some((t=>!(t in e.attributes)))))){const t=e.createQuery();return t.outFields=i,t.returnGeometry=!1,t.objectIds=a.map((e=>e.getObjectId())),e.queryFeatures(t,{signal:s}).then((({features:e})=>e))}return a})),s)}async function V(e,t,r,s){switch(t.type){case"3d":return U(e,t,r,s);case"2d":return async function(e,t,r,s){if(0===e.length)return[];const{results:l}=await i(t.hitTest(r),s);if(0===l.length)return[];const o=new Set;return l.forEach((({graphic:e})=>o.add(e.layer))),a(e.items.filter((({layer:e,supports:t})=>t.indexOf("update")>-1&&o.has(e))).map((({layer:e})=>{const{objectIdField:i,displayField:a}=e,l=[i];n(e.fields,a)&&l.push(a);const o=e.createQuery();o.outFields=l,o.returnGeometry=!1;const c=f({renderer:e.renderer,event:r});return o.geometry=m(r.mapPoint,c,t),e.queryFeatures(o,{signal:s}).then((({features:e})=>e))})),s)}(e,t,r,s)}}async function x(e,t,r){const i=e.layer,a=i.createQuery();return a.objectIds=[e.getAttribute(i.objectIdField)],a.outFields=["*"],a.outSpatialReference=t.spatialReference,a.returnM=i.capabilities.data.supportsM,a.returnZ=i.capabilities.data.supportsZ,(await i.queryFeatures(a,{signal:r})).features[0]}async function z(r,i,a,n,s){const l=r.clone();await j(l),a.layer.add(l),l.sourceLayer=r.layer;const o=(()=>{const{layer:e}=r;if("graphics"===e.type)return{remove(){}};const{objectIdField:t}=e,i=r.attributes[t],a=n.whenLayerView(e);return a.then((e=>e.setVisibility(i,!1)),(()=>{})),{remove(){a.then((e=>e.setVisibility(i,!0)),(()=>{}))}}})(),c=r.layer,u=i.size,p=i.rotation,y={multipleSelectionEnabled:!1};"point"===c.geometryType&&(y.enableRotation=!!p,y.enableScaling=!!u),a.layer.elevationInfo=c.elevationInfo,a.update(l,y);const d=(t(u)||t(p))&&r.watch("attributes",(async e=>{let r=!1;for(const i in e){const a=e[i];a!==l.attributes[i]&&(l.setAttribute(i,a),r=!0,t(u)&&!u.isUpdatingInteractively&&u.field===i&&u.initValue(a),t(p)&&!p.isUpdatingInteractively&&p.field===i&&p.initValue(a))}r&&"3d"===n.type&&await j(l)}));[p,u].forEach((async t=>{if(e(t))return;const i=r.attributes[t.field];if(null!=i)t.initValue(i);else{const e=await t.getDefault(l.symbol,n);t.initValue(e),l.setAttribute(t.field,e),"3d"===n.type&&await j(l)}}));const f=a.on("update",(async e=>{const{graphics:[r],state:i,toolEventInfo:o}=e;if("complete"===i)return void a.update(r,y);const c=o;if(t(p)&&c){const{field:e,getValue:t,initValue:r}=p;"rotate-stop"===c.type?(p.isUpdatingInteractively=!1,r()):null!=c.angle&&(p.isUpdatingInteractively=!0,l.attributes[e]=t(c.angle/Math.PI*180,n))}const d=o;if(t(u)&&d){const{field:e,getValue:t,initValue:r}=u;"scale-stop"===d.type?(u.isUpdatingInteractively=!1,r()):null!=d.xScale&&(u.isUpdatingInteractively=!0,l.attributes[e]=t(d.xScale,n))}"3d"===n.type&&await j(l),s(r.clone())}));n.map.add(a.layer);const m=()=>{};return{interactive:{remove(){f.remove(),a.cancel(),d&&d.remove(),this.remove=m}},visual:{remove(){o.remove(),n.map.remove(a.layer),a.layer.removeAll(),this.remove=m}}}}const F={icon:s(24),text:s(12),line:s(1),viewScaleSizeFactor:100};export{V as fetchCandidates,x as fetchFullFeature,S as findLayerInfo,g as getVisualVariableAttributes,I as setUpFeatureAdd,z as setUpGeometryUpdate,F as sizeDefaults};
