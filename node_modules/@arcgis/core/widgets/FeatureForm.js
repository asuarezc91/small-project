/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../core/has.js";import"../core/Logger.js";import"../core/accessorSupport/ensureType.js";import{property as t}from"../core/accessorSupport/decorators/property.js";import{aliasOf as i}from"../core/accessorSupport/decorators/aliasOf.js";import{subclass as s}from"../core/accessorSupport/decorators/subclass.js";import"../core/urlUtils.js";import"../core/uuid.js";import"../portal/support/resourceExtension.js";import{getDomainRange as a}from"../layers/support/domains.js";import{getFieldRange as r}from"../layers/support/fieldUtils.js";import{getLocale as l}from"../intl/locale.js";import"../intl.js";import{loadMoment as n}from"../intl/moment.js";import"./support/widgetUtils.js";import{messageBundle as o}from"./support/decorators/messageBundle.js";import{renderable as d}from"./support/decorators/renderable.js";import{vmEvent as u}from"./support/decorators/vmEvent.js";import{j as p}from"../chunks/index.js";import h from"./Widget.js";import c from"./FeatureForm/FeatureFormViewModel.js";const m="esri-feature-form",f="esri-feature-form__form",_="esri-feature-form__form-header",v="esri-feature-form__label",g="esri-feature-form__input",b="esri-feature-form__input--date",y="esri-feature-form__input--time",F="esri-feature-form__input--disabled",w="esri-feature-form__input--invalid",D="esri-feature-form__input-icon--invalid",I="esri-feature-form__field-error-message",N="esri-feature-form__description-text",M="esri-feature-form__date-input-part",V="esri-feature-form__date-input-part--lone",x="esri-feature-form__date-input-container",C="esri-feature-form__date-format-hint",j="esri-feature-form__group",k="esri-feature-form__group-label",U="esri-feature-form__group-header",E="esri-feature-form__group-title",O="esri-feature-form__group-description",$="esri-feature-form__group-toggle-icon",S="esri-feature-form__group--collapsed",T="esri-feature-form__group--sequential",K="esri-feature-form__group--active",L="esri-icon-up",A="esri-icon-notice-triangle",G="esri-icon-down",B="esri-widget",q="esri-widget--panel",R="esri-input",P="esri-select",z="esri-widget__heading",W="L",X="LTS";function H(e){return e&&e.inputFields}let J=class extends h{constructor(e,t){super(e,t),this._activeDateEdit=null,this._activeInputName=null,this._fieldFocusNeeded=!1,this._moment=null,this._userUpdatedInputFieldNames=new Set,this.description=null,this.feature=null,this.fieldConfig=null,this.formTemplate=null,this.groupDisplay="all",this.label=void 0,this.layer=null,this.messages=null,this.strict=null,this.title=null,this.viewModel=new c,this._handleFormKeyDown=this._handleFormKeyDown.bind(this),this._handleInputBlur=this._handleInputBlur.bind(this),this._handleInputFocus=this._handleInputFocus.bind(this),this._handleNumberInputMouseDown=this._handleNumberInputMouseDown.bind(this),this._handleInputKeyDown=this._handleInputKeyDown.bind(this),this._handleOptionChange=this._handleOptionChange.bind(this),this._handleGroupClick=this._handleGroupClick.bind(this),this._handleSubmit=this._handleSubmit.bind(this),this._afterScrollerCreateOrUpdate=this._afterScrollerCreateOrUpdate.bind(this)}async loadLocale(){this._moment=await n()}initialize(){this.own(this.watch("feature",(()=>{const e=this._getFocusableInput("forward");this._activeInputName=e&&e.name,this._userUpdatedInputFieldNames.clear(),this._fieldFocusNeeded=!0})),this.on("submit",(e=>{if(e.invalid.length>0){const[t]=e.invalid;e.invalid.forEach((e=>this._userUpdatedInputFieldNames.add(e))),this._activeInputName=t,this._fieldFocusNeeded=!0,this.scheduleRender()}})))}destroy(){this._userUpdatedInputFieldNames.clear(),this._userUpdatedInputFieldNames=null}getValues(){return null}submit(){return null}render(){const{state:e}=this.viewModel;return p("div",{class:this.classes(m,B,q)},"ready"===e?this.renderForm():null)}renderForm(){const e=this.title?p("h2",{class:z,key:"title"},this.title):null,t=this.description?p("p",{class:N,key:"description"},this.description):null,i=e||t?p("div",{class:_},e,t):null;return p("form",{class:f,novalidate:!0,onsubmit:this._handleSubmit,onkeydown:this._handleFormKeyDown},i,this.renderFields())}renderFields(){const{viewModel:{inputFields:e}}=this;return e.map(((e,t)=>H(e)?this.renderGroup(e,t):this.renderLabeledField(e)))}renderGroup(e,t){const{description:i,label:s,inputFields:a,state:r}=e,l=this.viewModel.findField(this._activeInputName),n=!(!l||l.group!==e),o=`${this.id}_group_${t}`,d=`${this.id}_group-label_${t}`,u=`${this.id}_group-description_${t}`,h=i?p("p",{class:this.classes(O,N),id:u},i):null,c="sequential"===this.groupDisplay,m=c?n:"expanded"===r,f=m?L:G;return p("fieldset",{"aria-expanded":m.toString(),"aria-labelledby":d,"aria-describedby":i?u:"",class:this.classes(j,c?T:null,m?null:S,n?K:null),"data-group":e,id:o,key:t,onclick:this._handleGroupClick},p("button",{role:c?"presentation":void 0,class:U,type:"button",tabIndex:c?-1:0},p("div",{class:E},p("h4",{class:this.classes(k,z),id:d},s),h),c?null:p("span",{class:this.classes(f,$)})),a.map((e=>this.renderLabeledField(e))))}_getFocusableInput(e,t){const i=this.viewModel._allInputFields,s="forward"===e?i:i.slice().reverse();let a;if(t)if(H(t))a=s.indexOf(t.inputFields[0]);else{let i;if(this._isFieldInClosedCollapsibleGroup(t)){const{inputFields:s}=t.group;i="forward"===e?s[s.length-1]:s[0]}else i=t;a=s.indexOf(i)+1}else a=0;for(let e=a;e<s.length;e++){const t=s[e];if(t.visible&&t.editable)return t}return null}renderLabeledField(e){const{label:t,layer:i,type:s}=e;return p("label",{key:`${i.id}-${e.name}`,class:v},[t,"unsupported"!==s?this.renderInputField(e):this.renderUnsupportedField(e),this.renderAuxiliaryText(e)])}renderInputField(e){const{viewModel:t}=this,{domain:i,editable:s,name:a,type:r}=e,l=t.getValue(a),n=!s,o=this.getCommonInputProps(e);return i&&"coded-value"===i.type&&!n?this.renderSelectInputField(l,i.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),o):"text"===r&&"text-area"===e.editorType||"rich-text"===e.editorType?p("textarea",Object.assign({},o)):"datetime-picker"===e.editorType||"date"===r?this.renderDateInputField(l,o):p("input",Object.assign({type:"text"===r?"text":"number"},o))}renderDateInputField(e,t){const{date:i,time:s}=this._formatDate(0),a=`${this.id}-${t.key}`,r=`${a}-date`,l=`${a}-time`,n=t["data-field"],{includeTime:o}=n,{date:d,time:u}=this._formatDate(e);return p("div",{key:`${t.key}-date`,class:x},p("div",{class:this.classes(M,o?null:V)},p("input",Object.assign({"aria-label":n.label,"aria-describedby":r,type:"text"},t,{"data-date-part":"date",class:this.classes(t.class,b),value:d})),p("div",{class:C,id:r},i)),o?p("div",{class:M,key:"time-input"},p("input",Object.assign({"aria-describedby":l,"aria-label":n.label,type:"text"},t,{"data-date-part":"time",class:this.classes(t.class,y),value:u})),p("div",{class:C,id:l},s)):null)}renderUnsupportedField(e){const t=this.viewModel.getValue(e.name);return p("input",{class:this.classes(R,g,F),disabled:!0,type:"text",value:`${t}`})}renderSelectInputField(e,t,i){let s=!1;const a=t.map((t=>(t.value===e&&(s=!0),p("option",{value:`${t.value}`,key:t.name},t.name))));null==e||""===e||s||a.unshift(p("option",{value:`${e}`,key:"outlier-option"},e));return i["data-field"].required||a.unshift(p("option",{value:"",key:"empty-option"},this.messages.empty)),p("select",Object.assign({},i,{class:this.classes(i.class,P),onchange:this._handleOptionChange}),a)}renderAuxiliaryText(e){return this._userUpdatedInputFieldNames.has(e.name)&&!e.valid?p("div",{key:"error-message"},p("span",{class:this.classes(D,A)}),p("div",{class:I},e.errorMessage)):e.description?p("div",{key:"description",class:N},e.description):void 0}getCommonInputProps(e){const{groupDisplay:t,viewModel:i}=this,{editable:s,group:a,hint:r,maxLength:l,minLength:n,name:o,required:d,type:u,valid:p}=e,h=i.getValue(o),c=this._userUpdatedInputFieldNames.has(o),m=!s,f="all"===t&&"collapsed"===(null==a?void 0:a.state);return{afterCreate:this._afterScrollerCreateOrUpdate,afterUpdate:this._afterScrollerCreateOrUpdate,"aria-invalid":p?"false":"true",class:this.classes(R,g,m?F:null,c&&!p?w:null),key:o,minlength:n>-1?`${n}`:"",maxlength:l>-1?`${l}`:"",...this._getNumberFieldConstraints(e),disabled:m,value:null==h?"":`${h}`,"data-field":e,onfocus:this._handleInputFocus,onblur:this._handleInputBlur,onkeydown:this._handleInputKeyDown,onmousedown:"number"===u?this._handleNumberInputMouseDown:null,required:d,tabIndex:f?-1:0,title:r}}_isFieldInClosedCollapsibleGroup(e){var t;return"all"===this.groupDisplay&&!H(e)&&"collapsed"===(null==e||null==(t=e.group)?void 0:t.state)}_handleNumberInputMouseDown({target:e}){const t=e;t.disabled||t.focus(),this.scheduleRender()}_getNumberFieldConstraints(e){const t=a(e.domain)||r(e.field);return t&&t.max!==Number.MAX_VALUE&&t.min!==Number.MIN_VALUE?t:{min:null,max:null}}_afterScrollerCreateOrUpdate(e){const t=e["data-field"],i=this.viewModel.findField(this._activeInputName);t.editable&&this._fieldFocusNeeded&&i===t&&(this._fieldFocusNeeded=!1,e.focus())}_handleInputFocus(e){const t=e.target;this._activeInputName=t["data-field"].name}_handleInputBlur(e){const t=e.target,i=t["data-field"],s=e.relatedTarget,a=s&&s["data-field"];this._syncDateEditsBeforeValueCommit(t);if(a&&"date"===i.type&&"date"===a.type&&i.field===a.field){if(""!==t.value&&""===s.value){const e=s.getAttribute("data-date-part");s.value=this._formatDate(Date.now())[e]}}else this._commitValue(t),this.scheduleRender()}_commitValue(e){const t=e["data-field"];if(this._activeDateEdit){const{date:e,time:i}=this._activeDateEdit,s=this._getDateEditValue(t,"date"),a=this._getDateEditValue(t,"time"),r=""===s||""===a;if(e){const{input:t}=e;t.value=r?"":s}if(i){const{input:e}=i;e.value=r?"":a}if(this._activeDateEdit=null,e&&i)return void this._updateDateFieldValue(e.input,i.input)}this._updateFieldValue(e)}_getDateEditValue(e,t){const i=this._activeDateEdit[t];if(!i)return;const{value:s}=i;if(""===s)return"";const a=this._parseDate(i.value,t);return a?this._formatDate(a.getTime())[t]:this._formatDate(e.value)[t]}_handleInputKeyDown(e){const{key:t,altKey:i,ctrlKey:s,metaKey:a,shiftKey:r}=e,l=e.target,n=l["data-field"];if("Tab"===t){const t=r?"backward":"forward",i=l.getAttribute("data-date-part");this._syncDateEditsBeforeValueCommit(l);if("backward"===t&&"time"===i||"forward"===t&&"date"===i&&n.includeTime)return;this._commitValue(l);const s=this.viewModel.findField(n.name),a=this._getFocusableInput(t,s),o=s.group===(null==a?void 0:a.group);return this._activeInputName=null==a?void 0:a.name,void(a&&("sequential"===this.groupDisplay||o)?(e.preventDefault(),this._fieldFocusNeeded=!0):this.renderNow())}if("Enter"===t)this._isFieldInClosedCollapsibleGroup(n)?n.group.state="expanded":(this._updateFieldValue(e.target),this.scheduleRender());else{const{type:r}=n.field,l="single"===r||"double"===r,o=!i&&!s&&!a;if(("integer"===r||"small-integer"===r||l)&&o&&1===t.length){const i=Number(t),s=["-","+"],a=["e","."],r=l?[...s,...a]:s;isNaN(i)&&-1===r.indexOf(t)&&e.preventDefault()}}}_syncDateEditsBeforeValueCommit(e){if("date"!==e["data-field"].type)return;const t=e.getAttribute("data-date-part");this._activeDateEdit={...this._activeDateEdit,[t]:{value:e.value,input:e}}}_updateFieldValue(e){const t=e["data-field"];this.viewModel.setValue(t.name,this._parseValue(e)),this._userUpdatedInputFieldNames.add(t.name)}_updateDateFieldValue(e,t){const i=e["data-field"];this.viewModel.setValue(i.name,this._parseDateTimeValue(e,t)),this._userUpdatedInputFieldNames.add(i.name)}_parseValue(e){const t=e["data-field"],i=e.value,{type:s}=t;if("number"===s)return parseFloat(i);if("date"===s){if(!i)return null;const s=Number(i);if(!isNaN(s))return s;const a=e.getAttribute("data-date-part"),r=this._parseDate(i,a);if(!r)return null;const l=this._moment,n=l(r),o=t.domain,d=l();let u=d;if(o&&"range"===o.type){const e=l(o.maxValue);d.isAfter(e)||(u=e)}const p=this.viewModel.getValue(t.name),h=l(null!=p?p:u);return"date"===a?(n.hour(h.hour()),n.minutes(h.minutes()),n.seconds(h.seconds())):(n.date(h.date()),n.month(h.month()),n.year(h.year())),n.valueOf()}return i}_parseDateTimeValue(e,t){const i=e.value,s=t.value;if(!i||!s)return null;const a=this._parseDate(i,"date"),r=this._parseDate(s,"time");if(!a||!r)return null;const l=this._moment(a),n=this._moment(r);return l.hour(n.hour()),l.minutes(n.minutes()),l.seconds(n.seconds()),l.valueOf()}_handleOptionChange(e){this._updateFieldValue(e.target),this.scheduleRender()}_handleGroupClick(e){var t;const i=e.currentTarget["data-group"],s="expanded"===i.state,a="sequential"===this.groupDisplay,r=`.${U}`;if(!(s&&!e.target.closest(r))){if(this._activeInputName=null==(t=this._getFocusableInput("forward",i))?void 0:t.name,a){const t=e.target.closest(r);if(s&&!t)return;this.viewModel.inputFields.forEach((e=>{H(e)&&e!==i&&(e.state="collapsed")}))}i.state=s?"collapsed":"expanded",this._fieldFocusNeeded=a,this.scheduleRender()}}_handleSubmit(e){e.preventDefault()}_handleFormKeyDown(e){"Enter"===e.key&&this.viewModel.submit()}_formatDate(e){if(null==e)return{date:"",time:""};const t=this._moment(e);return{date:t.format(W),time:t.format(X)}}_parseDate(e,t){if(null==e||""===e)return null;const i=this._moment(e,"date"===t?W:X,l(),!1);return i.isValid()?i.toDate():null}};e([i("viewModel.description"),d()],J.prototype,"description",void 0),e([i("viewModel.feature")],J.prototype,"feature",void 0),e([i("viewModel.fieldConfig")],J.prototype,"fieldConfig",void 0),e([i("viewModel.formTemplate")],J.prototype,"formTemplate",void 0),e([t(),d()],J.prototype,"groupDisplay",void 0),e([t({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],J.prototype,"label",void 0),e([i("viewModel.layer")],J.prototype,"layer",void 0),e([t(),d(),o("esri/widgets/FeatureForm/t9n/FeatureForm")],J.prototype,"messages",void 0),e([i("viewModel.strict")],J.prototype,"strict",void 0),e([i("viewModel.title"),d()],J.prototype,"title",void 0),e([t(),d(["viewModel.inputFields","viewModel.state"]),u(["value-change","submit"])],J.prototype,"viewModel",void 0),e([i("viewModel.getValues")],J.prototype,"getValues",null),e([i("viewModel.submit")],J.prototype,"submit",null),J=e([s("esri.widgets.FeatureForm")],J);var Q=J;export default Q;
