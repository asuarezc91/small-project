/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../core/has.js";import{unwrap as t,isNone as o}from"../../core/maybe.js";import i from"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import{property as s}from"../../core/accessorSupport/decorators/property.js";import{subclass as n}from"../../core/accessorSupport/decorators/subclass.js";import r from"../../core/Error.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import{reject as a,createAbortController as l,resolve as u}from"../../core/promiseUtils.js";import{geographicToWebMercator as c}from"../../geometry/support/webMercatorUtils.js";import h from"../../geometry/Point.js";import"../../geometry.js";import p from"../../core/Collection.js";import d from"../../support/actions/ActionBase.js";import g from"../../support/actions/ActionButton.js";import m from"../../support/actions/ActionToggle.js";import f from"../../core/Handles.js";import y from"../../layers/Layer.js";import{init as w,watch as F,whenFalse as v}from"../../core/watchUtils.js";import{ViewEventPriorities as _}from"../../views/input/InputManager.js";import b from"../Feature/FeatureViewModel.js";import C from"../support/AnchorElementViewModel.js";import{highlightsSupported as P}from"../../views/support/layerViewUtils.js";import{zoomToFeature as E,triggerAction as T}from"./actions.js";import{GoToMixin as j}from"../support/GoTo.js";const x=p.ofType({key:"type",defaultKeyValue:"button",base:d,typeMap:{button:g,toggle:m}}),O=i.getLogger("esri.widgets.Popup.PopupViewModel");let V=class extends(j(C)){constructor(e){super(e),this._handles=new f,this._pendingPromises=new Set,this._zoomToLocation=null,this._fetchFeaturesController=null,this.actions=new x([E.clone()]),this.defaultPopupTemplateEnabled=!1,this.autoCloseEnabled=!1,this.autoOpenEnabled=!0,this.content=null,this.featureViewModels=[],this.highlightEnabled=!0,this.title=null,this.updateLocationEnabled=!1,this.view=null,this.visible=!1,this.zoomFactor=4}initialize(){this._handles.add([w(this,["autoOpenEnabled","view"],(()=>this._autoOpenEnabledChange())),this.on("view-change",(()=>this._autoClose())),F(this,["highlightEnabled","selectedFeature","visible","view"],(()=>this._highlightFeature())),F(this,"view.animation.state",(e=>this._animationStateChange(e))),F(this,"location",(e=>this._locationChange(e))),F(this,"selectedFeature",(e=>this._selectedFeatureChange(e))),this.on("trigger-action",(e=>T({event:e,view:this.view}))),v(this,"waitingForResult",(()=>this._waitingForResultChange())),F(this,["features","view","view.map","view.spatialReference"],(()=>this._updateFeatureVMs()))])}destroy(){this._cancelFetchingFeatures(),this._handles.destroy(),this._handles=null,this._pendingPromises.clear(),this.view=null}get active(){return!(!this.visible||this.waitingForResult)}get allActions(){const e=this._get("allActions")||new x;e.removeAll();const t=this.selectedFeature&&("function"==typeof this.selectedFeature.getEffectivePopupTemplate&&this.selectedFeature.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled)||this.selectedFeature.popupTemplate),o=t&&t.actions,i=t&&t.overwriteActions?o:o?o.concat(this.actions):this.actions;return i&&i.filter(Boolean).forEach((t=>e.add(t))),e}get featureCount(){return this.features.length}get features(){return this._get("features")||[]}set features(e){const t=e||[];this._set("features",t);const{pendingPromisesCount:o,promiseCount:i,selectedFeatureIndex:s}=this,n=i&&t.length;n&&o&&-1===s?this.selectedFeatureIndex=0:n&&-1!==s||(this.selectedFeatureIndex=t.length?0:-1)}get location(){return this._get("location")||null}set location(e){const t=this.get("view.spatialReference.isWebMercator");e&&e.get("spatialReference.isWGS84")&&t&&(e=c(e)),this._set("location",e)}get pendingPromisesCount(){return this._pendingPromises.size}get waitingForResult(){return!(!(!!this._fetchFeaturesController||this.pendingPromisesCount>0)||0!==this.featureCount)}get promiseCount(){return this.promises.length}get promises(){return this._get("promises")||[]}set promises(e){if(this._pendingPromises.clear(),this.features=[],!Array.isArray(e)||!e.length)return this._set("promises",[]),void this.notifyChange("pendingPromisesCount");this._set("promises",e),(e=e.slice(0)).forEach((e=>{this._pendingPromises.add(e);e.then((t=>{this._pendingPromises.has(e)&&this._updateFeatures(t),this._updatePendingPromises(e)}),(()=>this._updatePendingPromises(e)))})),this.notifyChange("pendingPromisesCount")}get selectedFeature(){const{features:e,selectedFeatureIndex:t}=this;if(-1===t)return null;return e[t]||null}get selectedFeatureIndex(){const e=this._get("selectedFeatureIndex");return"number"==typeof e?e:-1}set selectedFeatureIndex(e){const{featureCount:t}=this;e=isNaN(e)||e<-1||!t?-1:(e+t)%t,this._set("selectedFeatureIndex",e)}get selectedFeatureViewModel(){return this.featureViewModels[this.selectedFeatureIndex]||null}get state(){return this.get("view.ready")?"ready":"disabled"}centerAtLocation(){const{view:e}=this,t=this._getSelectedTarget();if(!t){const o=new r("center-at-location:invalid-target-or-view","Cannot center at a location without a target and view.",{target:t,view:e});return O.error(o),a(o)}return this.callGoTo({target:{target:t,scale:e.scale}})}clear(){this.set({promises:[],features:[],content:null,title:null,location:null})}fetchFeatures(e,t){const{view:o}=this;if(!o||!e){const t=new r("fetch-features:invalid-screenpoint-or-view","Cannot fetch features without a screenPoint and view.",{screenPoint:e,view:o});return O.error(t),a(t)}return o.fetchPopupFeatures(e,{event:t&&t.event,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,signal:t&&t.signal})}open(e){const t={updateLocationEnabled:!1,promises:[],fetchFeatures:!1,...e,visible:!0},{fetchFeatures:o}=t;delete t.fetchFeatures,o&&this._setFetchFeaturesPromises(t.location),this.set(t)}triggerAction(e){const t=this.allActions.getItemAt(e);t&&!t.disabled&&this.emit("trigger-action",{action:t})}next(){return this.selectedFeatureIndex=this.selectedFeatureIndex+1,this}previous(){return this.selectedFeatureIndex=this.selectedFeatureIndex-1,this}zoomToLocation(){const{location:e,selectedFeature:t,view:o,zoomFactor:i}=this,s=this._getSelectedTarget();if(!s){const e=new r("zoom-to:invalid-target-or-view","Cannot zoom to location without a target and view.",{target:s,view:o});return O.error(e),a(e)}const n=o.scale/i,l=this.get("selectedFeature.geometry")||e,u=l&&"point"===l.type&&this._isZoomScreenSize(t);E.active=!0,E.disabled=!0;const c=this.callGoTo({target:{target:s,scale:u?n:void 0}}).catch((()=>{E.active=!1,E.disabled=!1,this._zoomToLocation=null})).then((()=>{u&&(this.location=l)}));return this._zoomToLocation=c,c}_animationStateChange(e){this._zoomToLocation||(E.disabled="waiting-for-target"===e)}_locationChange(e){const{selectedFeature:t,updateLocationEnabled:o}=this;o&&e&&(!t||t.geometry)&&this.centerAtLocation()}_selectedFeatureChange(e){if(!e)return;const{location:o,updateLocationEnabled:i,view:s}=this;!i&&o||!e.geometry?i&&!e.geometry&&this.centerAtLocation().then((()=>{this.location=s.center.clone()})):this.location=t(this._getPointFromGeometry(e.geometry))}_waitingForResultChange(){!this.featureCount&&this.promises&&(this.visible=!1)}_setFetchFeaturesPromises(e){return this._fetchFeaturesWithController(this._getScreenPoint(e||this.location)).then((e=>{const{clientOnlyGraphics:t,promisesPerLayerView:o}=e,i=u(t),s=o.map((e=>e.promise));this.promises=[i,...s]}))}_destroyFeatureVMs(){this.featureViewModels.forEach((e=>e&&!e.destroyed&&e.destroy())),this._set("featureViewModels",[])}_updateFeatureVMs(){const{features:e,featureViewModels:t}=this;if(this._destroyFeatureVMs(),!e||!e.length)return;const o=t.slice(0),i=[];e.forEach(((e,t)=>{if(!e)return;let s=null;if(o.some(((t,i)=>(t&&t.graphic===e&&(s=t,o.splice(i,1)),!!s))),s)i[t]=s;else{var n,r;const o=new b({defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,graphic:e,spatialReference:null==(n=this.view)?void 0:n.spatialReference,map:null==(r=this.view)?void 0:r.map});i[t]=o}})),o.forEach((e=>e&&!e.destroyed&&e.destroy())),this._set("featureViewModels",i)}_getScreenPoint(e){const{view:t}=this;return t&&e&&"function"==typeof t.toScreen?t.toScreen(e):null}_getSelectedTarget(){const{selectedFeature:e,location:t,view:o}=this;if(!o)return null;if("3d"===o.type)return e||t;return this.get("selectedFeature.geometry")||t}_autoOpenEnabledChange(){const e="auto-fetch-features",{_handles:t,autoOpenEnabled:o}=this;if(t.remove(e),o&&this.view){const o=this.view.on("click",(e=>{"mouse"===e.pointerType&&0!==e.button||this._fetchFeaturesAndOpen(e)}),_.WIDGET);t.add(o,e)}}_cancelFetchingFeatures(){const e=this._fetchFeaturesController;e&&e.abort(),this._fetchFeaturesController=null,this.notifyChange("waitingForResult")}_fetchFeaturesWithController(e,t){this._cancelFetchingFeatures();const o=l(),{signal:i}=o;this._fetchFeaturesController=o,this.notifyChange("waitingForResult");const s=this.fetchFeatures(e,{signal:i,event:t});return s.catch((()=>{})).then((()=>{this._fetchFeaturesController=null,this.notifyChange("waitingForResult")})),s}_fetchFeaturesAndOpen(e){const{screenPoint:t,mapPoint:o}=e,{view:i}=this;this._fetchFeaturesWithController(t,e).then((e=>{const{clientOnlyGraphics:t,promisesPerLayerView:s,location:n}=e,r=[u(t),...s.map((e=>e.promise))];return i.popup.open({location:n||o,promises:r}),e}))}_updatePendingPromises(e){e&&this._pendingPromises.has(e)&&(this._pendingPromises.delete(e),this.notifyChange("pendingPromisesCount"))}_autoClose(){this.autoCloseEnabled&&(this.visible=!1)}_isZoomScreenSize(e){const{view:t}=this;if("3d"!==t.type||!e||"esri.Graphic"!==e.declaredClass)return!0;const o=t.getViewForGraphic(e);if(o&&"whenGraphicBounds"in o){let t=!1;return o.whenGraphicBounds(e,{useViewElevation:!0}).then((e=>{t=!e||!e.boundingBox||e.boundingBox[0]===e.boundingBox[3]&&e.boundingBox[1]===e.boundingBox[4]&&e.boundingBox[2]===e.boundingBox[5]})).catch((()=>{const t=new r("zoom-to:invalid-graphic","Could not zoom to the location of the graphic.",{graphic:e});O.error(t)})),t}return!0}_getPointFromGeometry(e){return o(e)?null:"point"===e.type?e:"extent"===e.type?e.center:"polygon"===e.type?e.centroid:"multipoint"===e.type||"polyline"===e.type?e.extent.center:null}async _getLayerView(e,t){return await e.when(),e.whenLayerView(t)}async _highlightFeature(){const e="highlight";this._handles.remove(e);const{selectedFeature:t,highlightEnabled:o,view:i,visible:s}=this;if(!(t&&i&&o&&s))return;const{layer:n}=t;if(!(n&&n instanceof y))return;const r=this._getLayerView(i,n);this._highlightPromise=r;const a=await r;if(!(a&&P(a)&&this._highlightPromise===r&&this.selectedFeature&&this.highlightEnabled&&this.visible))return;const l="objectIdField"in n&&n.objectIdField,u=t.attributes,c=u&&l&&u[l],h=a.highlight(c||t);this._handles.add(h,e)}_updateFeatures(e){const{features:t}=this;if(!e||!e.length)return;if(!t.length)return void(this.features=e);const o=e.filter((e=>-1===t.indexOf(e)));this.features=t.concat(o)}};e([s({type:x})],V.prototype,"actions",void 0),e([s({readOnly:!0,dependsOn:["visible","waitingForResult"]})],V.prototype,"active",null),e([s({dependsOn:["actions.length","selectedFeature.sourceLayer.popupTemplate.actions.length","selectedFeature.sourceLayer.popupTemplate.overwriteActions","selectedFeature.popupTemplate.actions.length","selectedFeature.popupTemplate.overwriteActions"],readOnly:!0})],V.prototype,"allActions",null),e([s({type:Boolean})],V.prototype,"defaultPopupTemplateEnabled",void 0),e([s()],V.prototype,"autoCloseEnabled",void 0),e([s()],V.prototype,"autoOpenEnabled",void 0),e([s()],V.prototype,"content",void 0),e([s({readOnly:!0,dependsOn:["features"]})],V.prototype,"featureCount",null),e([s()],V.prototype,"features",null),e([s({readOnly:!0})],V.prototype,"featureViewModels",void 0),e([s()],V.prototype,"highlightEnabled",void 0),e([s({type:h})],V.prototype,"location",null),e([s({readOnly:!0,dependsOn:["promises"]})],V.prototype,"pendingPromisesCount",null),e([s({readOnly:!0,dependsOn:["featureCount","pendingPromisesCount"]})],V.prototype,"waitingForResult",null),e([s({readOnly:!0,dependsOn:["promises"]})],V.prototype,"promiseCount",null),e([s()],V.prototype,"promises",null),e([s({value:null,readOnly:!0,dependsOn:["features","selectedFeatureIndex","updateLocationEnabled"]})],V.prototype,"selectedFeature",null),e([s({value:-1})],V.prototype,"selectedFeatureIndex",null),e([s({readOnly:!0,dependsOn:["featureViewModels","selectedFeatureIndex"]})],V.prototype,"selectedFeatureViewModel",null),e([s({readOnly:!0,dependsOn:["view.ready"]})],V.prototype,"state",null),e([s()],V.prototype,"title",void 0),e([s()],V.prototype,"updateLocationEnabled",void 0),e([s()],V.prototype,"view",void 0),e([s()],V.prototype,"visible",void 0),e([s()],V.prototype,"zoomFactor",void 0),e([s()],V.prototype,"centerAtLocation",null),e([s()],V.prototype,"zoomToLocation",null),V=e([n("esri.widgets.Popup.PopupViewModel")],V);var L=V;export default L;
