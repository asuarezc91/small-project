/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../core/has.js";import t from"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import{property as s}from"../../core/accessorSupport/decorators/property.js";import{aliasOf as i}from"../../core/accessorSupport/decorators/aliasOf.js";import{subclass as a}from"../../core/accessorSupport/decorators/subclass.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import{eventKey as r}from"../../core/events.js";import{formatDate as o}from"../../intl/date.js";import"../../intl.js";import{loadMoment as n}from"../../intl/moment.js";import{storeNode as l,isRTL as d}from"./widgetUtils.js";import{accessibleHandler as c}from"./decorators/accessibleHandler.js";import{messageBundle as h}from"./decorators/messageBundle.js";import{renderable as u}from"./decorators/renderable.js";import{j as _}from"../../chunks/index.js";import p from"../Widget.js";import m from"./Popover.js";import v from"./DatePickerViewModel.js";import{parseDateIntoParts as y}from"./datePickerUtils.js";const k="esri-date-picker",D="esri-date-picker__calendar",g="esri-date-picker__month-picker",f="esri-date-picker__day-picker",w="esri-date-picker__week-item",b="esri-date-picker__day-item--nearby-month",P="esri-date-picker__day-item--active",O="esri-date-picker__day-item--today",M="esri-date-picker__day-item--selected",x="esri-date-picker__day-item",I="esri-date-picker__day-item--header",B="esri-date-picker__year-picker",j="esri-date-picker__year-picker-item--selected",C="esri-date-picker__year-picker-item",F="esri-date-picker__month-dropdown",N="esri-date-picker__date",S="esri-date-picker__calendar-toggle",T="esri-date-picker__input",A="esri-date-picker__text-input",U="esri-date-picker__icon--leading",Y="esri-icon-left",E="esri-icon-right",L="esri-icon-calendar",K="esri-widget",$="esri-widget--button",q="esri-input",H="esri-select",W={year:"numeric",month:"2-digit",day:"2-digit"},R=[" ","ArrowDown","ArrowLeft","ArrowRight","ArrowUp","End","Enter","Home","PageDown","PageUp"],V=t.getLogger("esri.widgets.support.DatePicker"),z="onfocusout"in HTMLElement.prototype,G="formatToParts"in Intl.DateTimeFormat.prototype;let J=class extends p{constructor(e,t){super(e,t),this._activeDate=null,this._calendarNode=null,this._calendarPopover=new m({owner:this,placement:"bottom-start",anchorElement:()=>this._rootNode,renderContentFunction:this._renderCalendar}),this._closedByUserAction=!1,this._isOpen=!1,this._requestDayPickerFocusOnCreate=!1,this._rootNode=null,this.dateInputEnabled=!1,this.label=void 0,this.messages=null,this.value=null,this.commitOnMonthChange=!1,this.viewModel=new v,this._handleDatePickerBlur=z?null:this._handleDatePickerBlurOrFocusOut,this._handleDatePickerFocusOut=z?this._handleDatePickerBlurOrFocusOut:null,this._toggle=this._toggle.bind(this)}async loadLocale(){this._moment=await n(),this._isOpen&&(this._activeDate=this._moment(this._activeDate.toDate()))}destroy(){this._calendarPopover.destroy()}render(){return _("div",{afterCreate:l,bind:this,class:this.classes(k,K),"data-node-ref":"_rootNode"},G&&this.dateInputEnabled?this.renderInputAndButtonMode():this.renderButtonOnlyMode())}renderButtonOnlyMode(){const e=o(this.viewModel.value,W),{_isOpen:t,messages:s}=this;return _("div",{afterUpdate:this._focusSelectedOrClosed,"aria-controls":t?this._getCalendarId():null,"aria-expanded":t.toString(),"aria-haspopup":"true","aria-label":s.setDate,"aria-pressed":t.toString(),class:this.classes($,H,S),onclick:this._toggle,onkeydown:this._toggle,role:"button",tabIndex:0},_("span",{class:N},e))}renderInputAndButtonMode(){const e=o(this.viewModel.value,W),{_isOpen:t,messages:s}=this;return _("div",{class:this.classes(T)},_("input",{"aria-controls":t?this._getCalendarId():null,"aria-haspopup":"true","aria-label":s.setDate,bind:this,class:this.classes(A,q),key:"date-input",onblur:this._handleDateInputBlur,onfocus:this._handleDateInputFocus,onkeydown:this._handleDateInputKeyDown,type:"text",value:e}),_("span",{"aria-hidden":"true",class:this.classes(U,L)}))}_handleDateInputKeyDown(e){"Enter"===e.key&&this._handleDateText(e)}_handleDateInputBlur(e){this._handleDatePickerBlurOrFocusOut(e),this._isOpen||this._handleDateText(e)}_handleDateInputFocus(){this._open(this.viewModel.value,!1)}_handleDateText(e){const t=e.currentTarget;let s;try{s=y(t.value,W)}catch(e){return V.warn(e),void(t.value=o(this.viewModel.value,W))}const i=this._moment(s);i.isValid()?(this.viewModel.value=i.toDate(),this._activeDate=i):t.value=o(this.viewModel.value,W)}_focusSelectedOrClosed(e){this._closedByUserAction&&(this._closedByUserAction=!1,e.focus())}_handleDatePickerKeydown(e){"Escape"===r(e)&&(this._closedByUserAction=!0,this._close(),e.preventDefault(),e.stopPropagation())}_renderCalendar(){const e=this._activeDate,t=this._moment(this.viewModel.value);return _("div",{afterCreate:l,bind:this,class:this.classes(D,K),"data-node-ref":"_calendarNode",id:this._getCalendarId(),key:"esri-date-picker__calendar",onkeydown:this._handleDatePickerKeydown},this._renderMonthPicker(e),this._renderDayPicker(e,t),this._renderYearPicker(e))}_getCalendarId(){return`date-picker__calendar--${this.id}`}_handleDatePickerBlurOrFocusOut(e){if(e.currentTarget!==e.target)return;const t=e.relatedTarget;this._calendarNode.contains(t)||this._rootNode.contains(t)||this._close()}_renderMonthPicker(e){const t=d(),s=t?E:Y,i=t?Y:E,a=this._moment.months().map(((t,s)=>{const i=e.month()===s;return _("option",{selected:i},t)})),{messages:r}=this;return _("div",{class:g},_("div",{"aria-label":r.goToPreviousMonth,bind:this,class:$,onblur:this._handleDatePickerBlur,onclick:this._setPreviousMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setPreviousMonth,role:"button",tabIndex:0,title:r.goToPreviousMonth},_("span",{"aria-hidden":"true",class:s})),_("select",{"aria-live":"assertive","aria-label":r.selectMonth,bind:this,class:this.classes(F,H),id:`${this.id}__month-picker`,onblur:this._handleDatePickerBlur,onchange:this._setMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setMonth,title:r.selectMonth},a),_("div",{"aria-label":r.goToNextMonth,bind:this,class:$,onblur:this._handleDatePickerBlur,onclick:this._setNextMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setNextMonth,role:"button",tabIndex:0,title:r.goToNextMonth},_("span",{"aria-hidden":"true",class:i})))}_renderDayPicker(e,t){const s=e.clone().day(this._moment.localeData().firstDayOfWeek()),i=this._getWeekLabels(s),a=this._getDayId(e),r=this._renderMonth(e,t);return _("div",{afterCreate:this._handleDayPickerCreate,"aria-activedescendant":a,"aria-labelledby":`${this.id}__month-picker ${this.id}__selected-year`,bind:this,class:f,id:`${this.id}__day-picker`,onblur:this._handleDatePickerBlur,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._handleDayPickerKeydown,role:"grid",tabIndex:0},_("div",{class:w,role:"row"},i.map((e=>_("div",{"aria-label":e.name,class:this.classes(x,I),role:"columnheader",title:e.name},e.abbr)))),r)}_getDayId(e){return`${this.id}__${o(e.valueOf(),W)}`}_handleDayPickerCreate(e){this._requestDayPickerFocusOnCreate&&(this._requestDayPickerFocusOnCreate=!1,e.focus())}_getWeekLabels(e){const t=[],s={weekday:"long"},i={weekday:"narrow"};for(let a=0;a<7;a++)t.push({name:o(e.valueOf(),s),abbr:o(e.valueOf(),i)}),e.add(1,"day");return t}_handleDayPickerKeydown(e){const{ctrlKey:t,shiftKey:s}=e,i=r(e),a=this._activeDate;if(-1!==R.indexOf(i)){if("ArrowLeft"===i)a.subtract(1,"day");else if("ArrowRight"===i)a.add(1,"day");else if("ArrowUp"===i)a.subtract(1,"week");else if("ArrowDown"===i)a.add(1,"week");else if("PageUp"===i){const e=s?"year":"month";a.subtract(1,e)}else if("PageDown"===i){const e=s?"year":"month";a.add(1,e)}else if("Home"===i){const e=t?"year":"month";a.startOf(e)}else if("End"===i){const e=t?"year":"month";a.endOf(e)}else"Enter"!==i&&" "!==i||(this.viewModel.value=a.toDate(),this._closedByUserAction=!0,this._close());e.preventDefault(),e.stopPropagation()}}_renderMonth(e,t){const s=this._moment(),i=e.clone().startOf("month"),a=e.clone().endOf("month"),r=i.clone().subtract(i.weekday(),"day"),o=[];for(let n=0;n<6;n++){const n=[];for(let o=0;o<7;o++){const o=r.date(),l=r.isSame(e,"day"),d=r.isSame(t,"day"),c=this._getDayId(r),h={[b]:!r.isBetween(i,a,null,"[]"),[O]:r.isSame(s,"day"),[P]:l,[M]:d};n.push(_("div",{"aria-label":o.toString(),"aria-selected":l.toString(),bind:this,class:this.classes(x,h),"data-iso-date":r.toISOString(),id:c,onclick:this._handleSelectedDate,onkeydown:this._handleSelectedDate,role:"gridcell"},o)),r.add(1,"day")}o.push(_("div",{class:w,role:"row"},n))}return o}_renderYearPicker(e){const t={year:"numeric"},s=e.clone(),i=o(s.valueOf(),t),a=o(s.add(1,"year").valueOf(),t),r=o(s.subtract(2,"year").valueOf(),t),{messages:n}=this;return _("div",{class:B},_("div",{"aria-label":n.goToPreviousYear,bind:this,class:C,onblur:this._handleDatePickerBlur,onclick:this._setPreviousYear,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setPreviousYear,tabIndex:0,title:n.goToPreviousYear},r),_("div",{class:this.classes(C,j),id:`${this.id}__selected-year`},i),_("div",{"aria-label":n.goToNextYear,bind:this,class:C,onblur:this._handleDatePickerBlur,onclick:this._setNextYear,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setNextYear,tabIndex:0,title:n.goToNextYear},a))}_toggle(){this._isOpen?this._close():this._open(this.viewModel.value)}_setMonth(e){const t=e.target.value;this._activeDate.month(t),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toDate())}_close(){this._activeDate=null,this._isOpen=!1,this._calendarPopover.open=!1}_open(e,t=!0){this._activeDate=this._moment(e),this._isOpen=!0,this._calendarPopover.open=!0,this._requestDayPickerFocusOnCreate=t}_setPreviousMonth(){this._activeDate.subtract(1,"month"),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toDate())}_setNextMonth(){this._activeDate.add(1,"month"),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toDate())}_setPreviousYear(){this._activeDate.subtract(1,"year")}_setNextYear(){this._activeDate.add(1,"year")}_handleSelectedDate(e){const t=e.target;this.viewModel.value=this._moment(t.getAttribute("data-iso-date")).toDate(),this._closedByUserAction=!0,this._close()}};e([s(),u()],J.prototype,"dateInputEnabled",void 0),e([s({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],J.prototype,"label",void 0),e([s(),u(),h("esri/widgets/support/t9n/DatePicker")],J.prototype,"messages",void 0),e([i("viewModel.value")],J.prototype,"value",void 0),e([s()],J.prototype,"commitOnMonthChange",void 0),e([s({type:v}),u("viewModel.value")],J.prototype,"viewModel",void 0),e([c()],J.prototype,"_toggle",null),e([c()],J.prototype,"_setPreviousMonth",null),e([c()],J.prototype,"_setNextMonth",null),e([c()],J.prototype,"_setPreviousYear",null),e([c()],J.prototype,"_setNextYear",null),e([c()],J.prototype,"_handleSelectedDate",null),J=e([a("esri.widgets.support.DatePicker")],J);var Q=J;export default Q;
