/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{unwrap as e,isSome as t}from"../../../core/maybe.js";import{resolve as o}from"../../../core/promiseUtils.js";import r from"../../../geometry/Polygon.js";import n from"../../../Graphic.js";import{createExtentFromGeometry as s,scaleExtent as c}from"./geometryUtils.js";function i(t,r){return t.location?function(e,t){const{source:o,spatialReference:r,location:n,sourceIndex:s,view:c}=e,{locator:i,zoomScale:a,defaultZoomScale:u}=o,l=c&&c.scale,m=t&&t.signal;r&&(i.outSpatialReference=r);return i.locationToAddress({location:n},{signal:m}).then((e=>f([e],{sourceIndex:s,scale:l,view:c,zoomScale:a,defaultZoomScale:u})))}(t,r):function(t,r){const{source:n,suggestResult:s,spatialReference:c,view:i,maxResults:a,sourceIndex:u}=t,m=n&&n.zoomScale,g=n&&n.defaultZoomScale;if(!s.text.trim())return o();const d=!s.key&&n.prefix?n.prefix:"",x=!s.key&&n.suffix?n.suffix:"",y=`${d}${s.text}${x}`,p={},{locator:S}=n,v=i&&i.scale,w=l(n,i),I=r&&r.signal;if(!S)return o();n.categories&&(p.categories=n.categories);n.locationType&&(p.locationType=n.locationType);c&&(S.outSpatialReference=c);const R=i&&i.get("extent.center");R&&(p.location=R);p.maxLocations=a,w&&(p.searchExtent=e(w));n.countryCode&&(p.countryCode=n.countryCode);const{key:$}=s;$&&(p.magicKey=$);p.address={},p.address[n.singleLineFieldName||"Single Line Input"]=y,n.outFields&&(p.outFields=n.outFields);return S.addressToLocations(p,{signal:I}).then((e=>f(e,{key:$,scale:v,sourceIndex:u,view:i,zoomScale:m,defaultZoomScale:g})))}(t,r)}function a(t,r){const{source:n,spatialReference:s,view:c,suggestTerm:i,maxSuggestions:a,sourceIndex:u}=t,f={},{locator:m}=n,g=l(n,c),d=r&&r.signal;if(!m)return o();n.categories&&(f.categories=n.categories),m.outSpatialReference=s;const x=c&&c.get("extent.center");x&&(f.location=x);if(!i.trim())return o();const{prefix:y="",suffix:p=""}=n,S=`${y}${i}${p}`;return f.text=S,g&&(f.searchExtent=e(g)),f.maxSuggestions=a,n.countryCode&&(f.countryCode=n.countryCode),m.suggestLocations(f,{signal:d}).then((e=>function(e,t){return e.map((e=>function(e,t){return{text:e.text,key:e.magicKey,sourceIndex:t}}(e,t)))}(e,u)))}function u(e){return!!e&&(function(e){return/(?:arcgis\.com\/arcgis\/rest\/services\/world\/geocodeserver).*/gi.test(e)}(e)||function(e){return/(?:\/servers\/[\da-z\.-]+\/rest\/services\/world\/geocodeserver).*/gi.test(e)}(e))}function l(e,t){const{filter:o,withinViewEnabled:r}=e,n=t&&t.scale,c=t&&t.extent,i=o&&o.geometry;return s(i,t,n)||(r&&c?c:void 0)}function f(e,o){return e.map((e=>function(e,o){const{key:i,scale:a,sourceIndex:u,view:l,zoomScale:f,defaultZoomScale:m}=o,{attributes:g,extent:d,location:x,address:y}=e,p=new n({geometry:x,attributes:g}),S=d||x,v=s(S,l,a),w="number"==typeof f?c(v,l,f):"number"==typeof m&&"point"===S.type?c(v,l,m):v,I=x?`${x.x},${x.y}`:"",R=y||I,$=p.clone();return t(w)&&($.geometry=r.fromExtent(w)),{extent:w,feature:p,target:$,key:i,name:R,sourceIndex:u}}(e,o)))}export{i as getResults,a as getSuggestions,u as isArcGISWorldGeocoder};
