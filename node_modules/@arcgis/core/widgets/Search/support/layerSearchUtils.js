/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{clone as e}from"../../../core/lang.js";import{isSome as t}from"../../../core/maybe.js";import i from"../../../core/Logger.js";import r from"../../../core/Error.js";import{resolve as n,reject as o}from"../../../core/promiseUtils.js";import l from"../../../geometry/Polygon.js";import{formatDate as s}from"../../../intl/date.js";import{substitute as u}from"../../../intl/substitute.js";import"../../../intl.js";import{getMetersPerUnitForSR as a}from"../../../core/unitUtils.js";import{createExtentFromGeometry as d,scaleExtent as c}from"./geometryUtils.js";const f=/https?:\/\/services.*\.arcgis\.com/i,m=/(?:\{([^}]+)\})/g,g=i.getLogger("esri.widgets.Search.support.layerSearchUtils");function p(i,n){const{exactMatch:o=!1,location:s,maxResults:u,spatialReference:f,source:m,sourceIndex:p,suggestResult:y,view:I}=i,{layer:L,filter:T,zoomScale:D}=m,E=I&&I.scale,O=h(m,I),C=n&&n.signal;return F(L).then((()=>{const e=L.popupTemplate;return e?e.getRequiredFields(L.fields):null})).then((i=>{var n,h;const{objectIdField:F,returnZ:N}=L,U=x(m);if(!b(L,U))throw g.error("invalid-field: displayField is invalid."),new r("getResults():invalid-field","displayField is invalid.");const k=i&&i.length?i:[U],q=m.outFields||k,A=v(q);-1!==q.indexOf(F)||A||q.push(F);if(!(A||$(L,q)))throw g.error("invalid-field: outField is invalid."),new r("getResults():invalid-field","outField is invalid.");const B=L.createQuery(),{orderByFields:P}=m;if(P&&(B.orderByFields=P),f){B.outSpatialReference=f;const e=1/a(f);e&&(B.maxAllowableOffset=e)}const V="mesh"===L.geometryType||"multipatch"===L.geometryType,Z=(null==(n=L.capabilities)||null==(h=n.data)?void 0:h.supportsZ)&&!V;if(B.returnZ=Z&&!1!==N,B.returnGeometry=!0,B.multipatchOption=V?"xyFootprint":null,q&&(B.outFields=q),s)B.geometry=s;else if(y.key)B.objectIds=[parseInt(y.key,10)];else{const e=m.searchFields||[U];if(!$(L,e))throw g.error("invalid-field: search field is invalid."),new r("getResults():invalid-field","search field is invalid.");w(L)&&(B.num=u),O&&(B.geometry=O);if(!y.text.trim())return[];const{prefix:t="",suffix:i=""}=m,n=R(j(`${t}${y.text}${i}`),L,e,T,o);if(!n)return[];B.where=n}return L.queryFeatures(B,{signal:C}).then((i=>function(i,r,n,o,s,u,a){return i.features.map((i=>function(i,r,n,o,s,u,a){const f=i.clone(),m=i.sourceLayer,g=m&&m.objectIdField,p=g&&i.attributes[g],y=S(i,n.searchTemplate,s),h=d(f.geometry,r,u),v="number"==typeof a?c(e(h),r,a):h,F=i.clone();t(v)&&(F.geometry=l.fromExtent(v));return{extent:v,target:F,feature:f,key:p,name:y,sourceIndex:o}}(i,r,n,o,s,u,a)))}(i,I,m,p,U,E,D)))}))}function y(e,t){const{source:i,spatialReference:n,view:o,suggestTerm:l,maxSuggestions:s,sourceIndex:u}=e,{layer:a,filter:d}=i,c=t&&t.signal,f=h(i,o);return F(a).then((()=>{if(!w(a))return[];const e=x(i),t=i.searchFields||[e],o=[];i.suggestionTemplate?i.suggestionTemplate.replace(m,((e,t)=>(o.push(t),e))):o.push(e);const p=v(o);-1!==o.indexOf(a.objectIdField)||p||o.push(a.objectIdField);const y=b(a,e),h=p||$(a,o),F=$(a,t);if(!y)throw g.error("invalid-field: displayField is invalid."),new r("getSuggestions():invalid-field","displayField is invalid.");if(!h)throw g.error("invalid-field: outField is invalid."),new r("getSuggestions():invalid-field","outField is invalid.");if(!F)throw g.error("invalid-field: search field is invalid."),new r("getSuggestions():invalid-field","search field is invalid.");const I=a.createQuery(),{orderByFields:L}=i;L&&(I.orderByFields=L),I.outSpatialReference=n,I.returnGeometry=!1,I.num=s,I.outFields=o,f&&(I.geometry=f);if(!l.trim())return[];const{prefix:T="",suffix:D=""}=i,E=R(j(`${T}${l}${D}`),a,t,d,!1);return E?(I.where=E,a.queryFeatures(I,{signal:c}).then((t=>function(e,t,i,r){return e.features.map((e=>function(e,t,i,r){const n=e.sourceLayer,{attributes:o}=e,{objectIdField:l}=n,s=o[l];return{text:S(e,t.suggestionTemplate,r),key:s,sourceIndex:i}}(e,t,i,r)))}(t,i,u,e)))):[]}))}function h(e,t){const{filter:i,withinViewEnabled:r}=e,n=t&&t.extent;return i&&i.geometry||(r&&n?n:void 0)}function v(e){return e&&-1!==e.indexOf("*")}function F(e){return e?e.load().then(n).catch(o):n()}function w(e){var t,i,r;return null!=(t=null==e||null==(i=e.capabilities)||null==(r=i.query)?void 0:r.supportsPagination)&&t}function x(e){return e.displayField||e.layer.displayField||function(e){let t="";if(e){const{fields:i}=e;i&&i.some((e=>"string"===e.type&&(t=e.name,!0)))}return t}(e.layer)}function $(e,t){return!(!e||!t)&&t.every((t=>b(e,t)))}function b(e,t){return!!e.getField(t)}function j(e){return e.replace(/\'/g,"''")}function I(e,t){const i=t&&t.where;return i?`(${e}) AND (${i})`:e}function R(e,t,i,r,n){const{definitionExpression:o}=t;let l="";if(e){const o=f.test(t.url)&&function(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!0;return!1}(e)?"N":"";i&&i.forEach((i=>{const s=t.getField(i),u="function"==typeof t.getFieldDomain&&t.getFieldDomain(i),a=(u&&"coded-value"===u.type?function(e,t,i){let r=null;const{codedValues:n}=e;return n&&n.some((e=>{const n=e.name,o=i?n:n.toLowerCase();return(i?t:t.toLowerCase())===o&&(r=e.code.toString(),!0)})),r}(u,e,n):null)||e||null;if(null!==a){const e=function(e,t,i,r,n){const o=t.type,l=t.name;if("string"===o||"date"===o||"global-id"===o)return I(n?`${l} = ${i}'${e}'`:`UPPER(${l}) LIKE ${i}'%${e.toUpperCase()}%'`,r);if("oid"===o||"small-integer"===o||"integer"===o||"single"===o||"double"===o){const t=Number(e);return isNaN(t)?null:I(`${l} = ${t}`,r)}return I(`${l} = ${e}`,r)}(a,s,o,r,n);e&&(l+=function(e,t){return e?` OR (${t})`:`(${t})`}(l,e))}}))}return o?`(${o}) AND (${l})`:l}function S(e,t,i){const r=e.sourceLayer,{attributes:n}=e,o="function"==typeof r.getFieldDomain&&r.getFieldDomain(i);if(t)return u(t,n);if(i&&n){const e=r.getField(i),t=(a=i,(l=n)[Object.keys(l).find((e=>e.toLowerCase()===a.toLowerCase()))]);return null==t?"":o&&"coded-value"===o.type?function(e,t){let i=null;const{codedValues:r}=e;return r&&r.length&&r.some((e=>e.code===t&&(i=e.name,!0))),i}(o,t):"date"===(null==e?void 0:e.type)?s(new Date(t)):"number"==typeof t?t.toString():"string"!=typeof t?"":t.trim()}var l,a;return""}export{p as getResults,y as getSuggestions};
