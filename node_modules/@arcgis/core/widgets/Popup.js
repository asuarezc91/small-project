/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../core/has.js";import t from"../core/Logger.js";import{property as i}from"../core/accessorSupport/decorators/property.js";import{aliasOf as o}from"../core/accessorSupport/decorators/aliasOf.js";import{cast as n}from"../core/accessorSupport/decorators/cast.js";import{deprecatedProperty as s}from"../core/deprecate.js";import{subclass as r}from"../core/accessorSupport/decorators/subclass.js";import"../core/urlUtils.js";import"../core/uuid.js";import"../portal/support/resourceExtension.js";import{eventKey as l}from"../core/events.js";import a from"../core/Collection.js";import{substitute as u}from"../intl/substitute.js";import"../intl.js";import d from"../core/Handles.js";import{watch as c,whenFalse as p,on as h,init as g}from"../core/watchUtils.js";import{throttle as _}from"../core/throttle.js";import{cssTransition as v,isRTL as m}from"./support/widgetUtils.js";import{accessibleHandler as f}from"./support/decorators/accessibleHandler.js";import{messageBundle as b}from"./support/decorators/messageBundle.js";import{renderable as w}from"./support/decorators/renderable.js";import{vmEvent as M}from"./support/decorators/vmEvent.js";import{j as y}from"../chunks/index.js";import k from"./Widget.js";import{FeatureContentMixin as A}from"./Feature/support/FeatureContentMixin.js";import C from"./Feature.js";import F from"./Spinner.js";import x from"./Popup/PopupViewModel.js";const O="esri-icon-left-triangle-arrow",E="esri-icon-right-triangle-arrow",I="esri-icon-maximize",N="esri-icon-dock-bottom",P="esri-icon-dock-left",B="esri-icon-dock-right",S="esri-icon-close",D="esri-icon-minimize",V="esri-icon-check-mark",U="esri-icon-loading-indicator",j="esri-icon-default-action",L="esri-icon-handle-horizontal",T="esri-rotating",W="esri-popup",R="esri-widget",H="esri-popup__main-container",$="esri-popup__loading-container",z="esri-popup--is-collapsible",K="esri-popup--is-collapsed",q="esri-popup--shadow",G="esri-popup--is-docked",J="esri-popup--is-docked-top-left",Q="esri-popup--is-docked-top-center",X="esri-popup--is-docked-top-right",Y="esri-popup--is-docked-bottom-left",Z="esri-popup--is-docked-bottom-center",ee="esri-popup--is-docked-bottom-right",te="esri-popup--aligned-top-center",ie="esri-popup--aligned-bottom-center",oe="esri-popup--aligned-top-left",ne="esri-popup--aligned-bottom-left",se="esri-popup--aligned-top-right",re="esri-popup--aligned-bottom-right",le="esri-popup--feature-menu-open",ae="esri-popup--actions-menu-open",ue="esri-popup--feature-updated",de="esri-popup__header",ce="esri-popup__header-buttons",pe="esri-popup__header-container",he="esri-popup__header-container--button",ge="esri-popup__header-title",_e="esri-popup__content",ve="esri-popup__footer",me="esri-popup__footer--has-pagination",fe="esri-popup__footer--has-actions",be="esri-popup__footer--has-actions-menu",we="esri-popup__button",Me="esri-popup__button--disabled",ye="esri-popup__button--dock",ke="esri-popup__icon",Ae="esri-popup__icon--dock-icon",Ce="esri-popup__inline-actions-container",Fe="esri-popup__actions-menu-button",xe="esri-popup__actions",Oe="esri-popup__action",Ee="esri-popup__action-image",Ie="esri-popup__action-text",Ne="esri-popup__action-toggle",Pe="esri-popup__action-toggle--on",Be="esri-popup__pointer",Se="esri-popup__pointer-direction",De="esri-popup__navigation",Ve="esri-popup__pagination-previous",Ue="esri-popup__pagination-next",je="esri-popup__pagination-previous-icon",Le="esri-popup__pagination-previous-icon--rtl",Te="esri-popup__pagination-next-icon",We="esri-popup__pagination-next-icon--rtl",Re="esri-popup__feature-menu",He="esri-popup__feature-menu-list",$e="esri-popup__feature-menu-item",ze="esri-popup__feature-menu-viewport",Ke="esri-popup__feature-menu-header",qe="esri-popup__feature-menu-item--selected",Ge="esri-popup__feature-menu-button",Je="esri-popup__feature-menu-title",Qe={buttonEnabled:!0,position:"auto",breakpoint:{width:544}};function Xe(e,t){return void 0===t?`esri-popup__${e}`:`esri-popup__${e}-${t}`}const Ye=t.getLogger("esri.widgets.Popup"),Ze={closeButton:!0,featureNavigation:!0};let et=class extends(A(k)){constructor(e,t){super(e,t),this._blurClose=!1,this._blurContainer=!1,this._containerNode=null,this._mainContainerNode=null,this._featureMenuNode=null,this._actionsMenuNode=null,this._focusClose=!1,this._focusContainer=!1,this._focusDockButton=!1,this._focusFeatureMenuButton=!1,this._focusActionsMenuButton=!1,this._focusFirstFeature=!1,this._focusFirstAction=!1,this._handles=new d,this._pointerOffsetInPx=16,this._spinner=null,this._feature=null,this._displaySpinnerThrottled=_((()=>this._displaySpinner()),0),this.actions=null,this.alignment="auto",this.autoCloseEnabled=null,this.autoOpenEnabled=null,this.defaultPopupTemplateEnabled=null,this.content=null,this.collapsed=!1,this.collapseEnabled=!0,this.dockEnabled=!1,this.featureCount=null,this.featureMenuOpen=!1,this.features=null,this.goToOverride=null,this.highlightEnabled=null,this.location=null,this.label=void 0,this.maxInlineActions=3,this.messages=null,this.messagesCommon=null,this.promises=null,this.selectedFeature=null,this.selectedFeatureIndex=null,this.spinnerEnabled=!0,this.title=null,this.updateLocationEnabled=null,this.view=null,this.viewModel=new x,this.visible=null,this.visibleElements={...Ze},this._addSelectedFeatureIndexHandle(),this.own([c(this,"viewModel.screenLocation",(()=>this._positionContainer())),c(this,["viewModel.active","dockEnabled"],(()=>this._toggleScreenLocationEnabled())),c(this,"viewModel.screenLocation",((e,t)=>{!!e!=!!t&&this.reposition()})),c(this,["viewModel.view.padding","viewModel.view.size","viewModel.active","viewModel.location","alignment"],(()=>this.reposition())),c(this,"spinnerEnabled",(e=>this._spinnerEnabledChange(e))),c(this,"viewModel.view.size",((e,t)=>this._updateDockEnabledForViewSize(e,t))),c(this,"viewModel.view",((e,t)=>this._viewChange(e,t))),c(this,"viewModel.view.ready",((e,t)=>this._viewReadyChange(e,t))),c(this,["viewModel.waitingForResult","viewModel.location"],(()=>{this._hideSpinner(),this._displaySpinnerThrottled()})),c(this,"selectedFeatureWidget.viewModel.title",(e=>this._setTitleFromFeatureWidget(e))),c(this,["selectedFeatureWidget.viewModel.content","selectedFeatureWidget.viewModel.waitingForContent"],(()=>this._setContentFromFeatureWidget())),p(this,"collapsed",(()=>{var e,t;"xsmall"===(null==(e=this.viewModel)||null==(t=e.view)?void 0:t.widthBreakpoint)&&this.viewModel.active&&this.collapseEnabled&&this.viewModel.centerAtLocation()})),h(this,"viewModel.allActions","change",(()=>this._watchActions())),g(this,"viewModel.allActions",(()=>this._watchActions()))])}destroy(){this._destroySelectedFeatureWidget(),this._destroySpinner(),this._handles&&this._handles.destroy(),this._handles=null}get actionsMenuId(){return`${this.id}-actions-menu`}get actionsMenuButtonId(){return`${this.id}-actions-menu-button`}get featureMenuId(){return`${this.id}-feature-menu`}get titleId(){return`${this.id}-popup-title`}get contentId(){return`${this.id}-popup-content`}get hasContent(){var e,t,i,o,n;return!!(this.selectedFeatureWidget?(null==(e=this.selectedFeatureWidget)||null==(t=e.viewModel)?void 0:t.waitingForContent)||(null==(i=this.selectedFeatureWidget)||null==(o=i.viewModel)?void 0:o.content):null==(n=this.viewModel)?void 0:n.content)}get featureNavigationVisible(){return this.viewModel.active&&this.viewModel.featureCount>1&&this.visibleElements.featureNavigation}get collapsible(){return!!(this.collapseEnabled&&this.viewModel.title&&this.hasContent)}get featureMenuVisible(){return this.featureNavigationVisible&&this.featureMenuOpen}get contentCollapsed(){return this.collapsible&&!this.featureMenuVisible&&this.collapsed}get dividedActions(){return this._divideActions()}set actionsMenuOpen(e){this._set("actionsMenuOpen",!!e)}get actionsMenuOpen(){return!!this.viewModel.active&&this._get("actionsMenuOpen")}get currentAlignment(){return this._getCurrentAlignment()}get currentDockPosition(){return this._getCurrentDockPosition()}get dockOptions(){return this._get("dockOptions")||Qe}set dockOptions(e){const t={...Qe},i=this.get("viewModel.view.breakpoints"),o={};i&&(o.width=i.xsmall,o.height=i.xsmall);const n={...t,...e},s={...t.breakpoint,...o},{breakpoint:r}=n;!0===r?n.breakpoint=s:"object"==typeof r&&(n.breakpoint={...s,...r}),this._set("dockOptions",n),this._setCurrentDockPosition(),this.reposition()}set featureNavigationEnabled(e){s(Ye,"featureNavigationEnabled",{replacement:"visibleElements.featureNavigation",version:"4.15"}),this.visibleElements={...this.visibleElements,featureNavigation:e}}get selectedFeatureWidget(){const{_feature:e,visibleElements:t}=this,{selectedFeatureViewModel:i}=this.viewModel,o={...t,title:!1};return i?(e?(e.viewModel=i,e.visibleElements=o):this._feature=new C({viewModel:i,visibleElements:o}),this._feature):null}castVisibleElements(e){return{...Ze,...e}}blur(){const{active:e}=this.viewModel;e||Ye.warn("Popup can only be blurred when currently active."),this.visibleElements.closeButton?this._blurClose=!0:this._blurContainer=!0,this.scheduleRender()}clear(){this.viewModel.clear()}close(){this.visible=!1}fetchFeatures(e,t){return this.viewModel.fetchFeatures(e,t)}focus(){const{active:e}=this.viewModel;e||Ye.warn("Popup can only be focused when currently active."),this.visibleElements.closeButton?this._focusClose=!0:this._focusContainer=!0,this.scheduleRender()}next(){return this.viewModel.next()}open(e){var t,i;this._handles.remove("selected-index");const o=!!e&&!!e.featureMenuOpen,n=!!e&&!!e.actionsMenuOpen,s={collapsed:!!e&&!!e.collapsed,actionsMenuOpen:n,featureMenuOpen:o};"xsmall"===(null==(t=this.viewModel)||null==(i=t.view)?void 0:i.widthBreakpoint)&&(s.collapsed=!0),this.set(s),this.viewModel.open(e),this._addSelectedFeatureIndexHandle()}previous(){return this.viewModel.previous()}reposition(){this.renderNow(),this._positionContainer(),this._setCurrentAlignment()}triggerAction(e){this.viewModel.triggerAction(e)}render(){var e,t,i,o;const{actionsMenuOpen:n,dockEnabled:s,featureMenuVisible:r,dividedActions:l,currentAlignment:a,currentDockPosition:u}=this,{active:d}=this.viewModel,{menuActions:c}=l,p=d&&c.length>1&&n,h=d&&s,g=d&&!s,_=null==(e=this.selectedFeature)||null==(t=e.layer)?void 0:t.title,v=null==(i=this.selectedFeature)||null==(o=i.layer)?void 0:o.id,m={[te]:"top-center"===a,[ie]:"bottom-center"===a,[oe]:"top-left"===a,[ne]:"bottom-left"===a,[se]:"top-right"===a,[re]:"bottom-right"===a,[G]:h,[q]:g,[J]:"top-left"===u,[Q]:"top-center"===u,[X]:"top-right"===u,[Y]:"bottom-left"===u,[Z]:"bottom-center"===u,[ee]:"bottom-right"===u,[le]:r,[ae]:p};return y("div",{class:this.classes(W,m),role:"presentation","data-layer-title":_,"data-layer-id":v,bind:this,afterCreate:this._positionContainer,afterUpdate:this._positionContainer},d?[this.renderMainContainer(),this.renderPointer()]:null)}renderLoadingIcon(){return y("span",{"aria-hidden":"true",class:this.classes(ke,U,T)})}renderNavigationLoading(){const{messagesCommon:e}=this;return this.viewModel.pendingPromisesCount?y("div",{key:Xe("loading-container"),role:"presentation",class:$,"aria-label":e.loading,title:e.loading},this.renderLoadingIcon()):null}renderPreviousIcon(){const e=m(),t={[E]:e,[Le]:e,[O]:!e,[je]:!e};return y("span",{"aria-hidden":"true",class:this.classes(ke,t)})}renderPreviousButton(){const{messages:e}=this;return y("div",{role:"button",tabIndex:0,bind:this,onclick:this._previous,onkeydown:this._previous,class:this.classes(we,Ve),"aria-label":e.previous,title:e.previous},this.renderPreviousIcon())}renderNextIcon(){const e=m(),t={[O]:e,[We]:e,[E]:!e,[Te]:!e};return y("span",{"aria-hidden":"true",class:this.classes(ke,t)})}renderNextButton(){const{messages:e}=this;return y("div",{role:"button",tabIndex:0,bind:this,onclick:this._next,onkeydown:this._next,class:this.classes(we,Ue),"aria-label":e.next,title:e.next},this.renderNextIcon())}renderFeatureMenuButton(){const{featureMenuOpen:e,featureMenuId:t,messagesCommon:i}=this,{featureCount:o,selectedFeatureIndex:n}=this.viewModel;return y("div",{role:"button",tabIndex:0,bind:this,onclick:this._toggleFeatureMenu,onkeydown:this._toggleFeatureMenu,afterCreate:this._focusFeatureMenuButtonNode,afterUpdate:this._focusFeatureMenuButtonNode,class:this.classes(we,Ge),"aria-haspopup":"true","aria-controls":t,"aria-expanded":e,"aria-label":i.menu,title:i.menu},this._getPageText(o,n))}renderNavigationButtons(){return this.featureNavigationVisible?[this.renderPreviousButton(),this.renderNavigationLoading()||this.renderFeatureMenuButton(),this.renderNextButton()]:null}renderDockIcon(){const{dockEnabled:e}=this,t=this._wouldDockTo(),i={[D]:e,[Ae]:!e,[B]:!e&&("top-right"===t||"bottom-right"===t),[P]:!e&&("top-left"===t||"bottom-left"===t),[I]:!e&&"top-center"===t,[N]:!e&&"bottom-center"===t};return y("span",{"aria-hidden":"true",class:this.classes(i,ke)})}renderDockButton(){var e,t,i;const{dockEnabled:o,messages:n}=this,s=null==(e=this.viewModel)||null==(t=e.view)?void 0:t.widthBreakpoint,r=o?n.undock:n.dock;return"xsmall"!==s&&null!=(i=this.dockOptions)&&i.buttonEnabled?y("div",{role:"button","aria-label":r,title:r,tabIndex:0,bind:this,onclick:this._toggleDockEnabled,onkeydown:this._toggleDockEnabled,afterCreate:this._focusDockButtonNode,afterUpdate:this._focusDockButtonNode,class:this.classes(we,ye)},this.renderDockIcon()):null}renderTitle(){const{title:e}=this.viewModel,{titleId:t,collapsible:i,contentCollapsed:o,messagesCommon:n}=this,s={[he]:i},r=y("h2",{class:ge,innerHTML:e}),l=i?y("button",{key:`${e}--collapsible`,id:t,title:o?n.expand:n.collapse,bind:this,enterAnimation:this._createFeatureUpdatedAnimation(),class:this.classes(pe,s),"aria-expanded":o?"false":"true",onclick:this._toggleCollapsed},r):y("div",{key:e,id:t,bind:this,enterAnimation:this._createFeatureUpdatedAnimation(),class:this.classes(pe,s)},r);return e?l:null}renderCloseIcon(){return y("span",{"aria-hidden":"true",class:this.classes(ke,S)})}renderCloseButton(){const{visibleElements:e,messagesCommon:t}=this;return e.closeButton?y("div",{role:"button",tabIndex:0,bind:this,onclick:this._close,onkeydown:this._close,class:we,"aria-label":t.close,title:t.close,afterCreate:this._closeButtonNodeUpdated,afterUpdate:this._closeButtonNodeUpdated},this.renderCloseIcon()):null}renderHeader(){return y("header",{class:de},this.renderTitle(),y("div",{class:ce},this.renderDockButton(),this.renderCloseButton()))}renderContentContainer(){const{contentId:e,hasContent:t,contentCollapsed:i}=this,{content:o}=this.viewModel;return t&&!i?y("article",{key:o,enterAnimation:this._createFeatureUpdatedAnimation(),id:e,class:_e},this.renderContent()):null}renderActionsMenuButton(){const{actionsMenuId:e,actionsMenuButtonId:t,actionsMenuOpen:i,dividedActions:o,messagesCommon:n}=this,s=i?n.close:n.open,{menuActions:r}=o;return r.length?y("div",{key:Xe("actions-menu-button"),class:this.classes(we,Fe),role:"button",id:t,"aria-haspopup":"true","aria-controls":i?e:null,tabIndex:0,bind:this,onclick:this._toggleActionsMenu,onkeydown:this._toggleActionsMenu,afterCreate:this._focusActionsMenuButtonNode,afterUpdate:this._focusActionsMenuButtonNode,"aria-label":s,title:s},y("span",{"aria-hidden":"true",class:L})):null}renderMenuActions(){const{actionsMenuId:e,actionsMenuButtonId:t,actionsMenuOpen:i,dividedActions:o}=this,{menuActions:n,inlineActions:s}=o;return n.length&&i?y("ul",{id:e,role:"menu","aria-labelledby":t,key:Xe("actions"),class:xe,bind:this,onkeyup:this._handleActionMenuKeyup,afterCreate:this._actionsMenuNodeUpdated,afterUpdate:this._actionsMenuNodeUpdated},n.toArray().map(((e,t)=>this.renderAction({action:e,index:t+s.length,type:"menu-item"})))):null}renderInlineActions(){const{inlineActions:e}=this.dividedActions;return!!e.length&&e.toArray().map(((e,t)=>this.renderAction({action:e,index:t,type:"inline"})))}renderInlineActionsContainer(){const{inlineActions:e,menuActions:t}=this.dividedActions,i=!!e.length,o=!!t.length;return i||o?y("div",{key:"inline-actions-container","data-inline-actions":i.toString(),"data-menu-actions":o.toString(),class:Ce},this.renderInlineActions(),this.renderActionsMenuButton(),this.renderMenuActions()):null}renderNavigation(){return this.featureNavigationVisible?y("section",{key:Xe("navigation"),class:this.classes(De)},this.renderNavigationButtons()):null}renderFooter(){const{featureNavigationVisible:e,dividedActions:t}=this,{inlineActions:i,menuActions:o}=t,n=!!i.length,s=!!o.length,r={[me]:e,[fe]:n,[be]:s};return e||n?y("div",{key:Xe("feature-buttons"),class:this.classes(ve,r)},this.renderInlineActionsContainer(),this.renderNavigation()):null}renderFeatureMenuContainer(){const{messages:e}=this,{featureViewModels:t}=this.viewModel,i=u(e.selectedFeatures,{total:t.length});return y("section",{key:Xe("menu"),class:Re},y("h2",{class:Ke},i),y("nav",{class:ze,afterCreate:this._featureMenuViewportNodeUpdated,afterUpdate:this._featureMenuViewportNodeUpdated},this.renderFeatureMenu()))}renderPointer(){return this.dockEnabled?null:y("div",{key:Xe("pointer"),class:Be,role:"presentation"},y("div",{class:this.classes(Se,q)}))}renderMainContainer(){const{dockEnabled:e,currentAlignment:t,currentDockPosition:i,titleId:o,contentId:n,collapsible:s,hasContent:r,contentCollapsed:l,visibleElements:a}=this,{title:u}=this.viewModel,d="bottom-left"===t||"bottom-center"===t||"bottom-right"===t||"top-left"===i||"top-center"===i||"top-right"===i,c="top-left"===t||"top-center"===t||"top-right"===t||"bottom-left"===i||"bottom-center"===i||"bottom-right"===i,p={[q]:e,[z]:s,[K]:l};return y("div",{class:this.classes(H,R,p),tabIndex:a.closeButton?null:-1,role:"dialog","aria-labelledby":u?o:"","aria-describedby":r&&!l?n:"",bind:this,onkeyup:this._handleMainKeyup,afterCreate:this._mainContainerNodeUpdated,afterUpdate:this._mainContainerNodeUpdated},d?this.renderFooter():null,d?this.renderFeatureMenuContainer():null,this.renderHeader(),this.renderContentContainer(),c?this.renderFooter():null,c?this.renderFeatureMenuContainer():null)}renderContent(){var e;const t=null==(e=this.viewModel)?void 0:e.content;return t?"string"==typeof t?y("div",{key:t,innerHTML:t}):this.renderNodeContent(t):null}renderActionText(e){return y("span",{key:"text",class:Ie},e)}renderActionIcon(e){const t=this._getActionClass(e),i=this._getActionImage(e),o={[U]:e.active,[T]:e.active,[ke]:!!t,[Ee]:!e.active&&!!i};return t&&(o[t]=!e.active),y("span",{key:"icon","aria-hidden":"true",class:this.classes(ke,o),styles:this._getIconStyles(i)})}renderAction(e){const{action:t,index:i,type:o}=e,n=this._getActionTitle(t),s={[Oe]:"toggle"!==t.type,[Ne]:"toggle"===t.type,[Pe]:"toggle"===t.type&&t.value,[Me]:t.disabled},r=[this.renderActionIcon(t),this.renderActionText(n)],l="menu-item"===o?y("li",{key:t.uid,role:"menuitem",tabIndex:0,title:n,"aria-label":n,class:this.classes(we,s),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-index":i,onclick:this._triggerAction,onkeydown:this._triggerAction},r):y("div",{key:t.uid,role:"button",tabIndex:0,title:n,"aria-label":n,class:this.classes(we,s),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-index":i,onclick:this._triggerAction,onkeydown:this._triggerAction},r);return t.visible?l:null}renderFeatureMenuItem(e,t){const{messages:i,messagesCommon:o}=this,{selectedFeatureIndex:n,selectedFeatureViewModel:s}=this.viewModel,r=e===s,l={[qe]:r},a=r?y("span",{key:Xe(`feature-menu-selected-feature-${n}`),title:i.selectedFeature,"aria-label":i.selectedFeature,class:V}):null,u=y("span",{innerHTML:e.title||o.untitled});return y("li",{role:"menuitem",tabIndex:-1,key:Xe(`feature-menu-feature-${n}`),class:this.classes(l,$e),bind:this,"data-feature-index":t,onkeyup:this._handleFeatureMenuItemKeyup,onclick:this._selectFeature,onkeydown:this._selectFeature},y("span",{class:Je},u,a))}renderFeatureMenu(){const{featureMenuId:e}=this,{featureViewModels:t}=this.viewModel;return t.length>1?y("ol",{class:He,id:e,bind:this,afterCreate:this._featureMenuNodeUpdated,afterUpdate:this._featureMenuNodeUpdated,onkeyup:this._handleFeatureMenuKeyup,role:"menu"},t.map(((e,t)=>this.renderFeatureMenuItem(e,t)))):null}_getActionTitle(e){const{messages:t,selectedFeature:i,messagesCommon:o}=this,{id:n}=e,s=null==i?void 0:i.attributes,r="zoom-to-feature"===n?u(e.title,{messages:t}):"remove-selected-feature"===n?u(e.title,{messages:o}):e.title;return r&&s?u(r,s):r}_getActionClass(e){const{selectedFeature:t}=this,i=null==t?void 0:t.attributes,{className:o,image:n}=e,s=n||o?o:j;return s&&i?u(s,i):s}_getActionImage(e){const{selectedFeature:t}=this,i=null==t?void 0:t.attributes,{image:o}=e;return o&&i?u(o,i):o}_createFeatureUpdatedAnimation(){return v("enter",ue)}_getInlineActionCount(){const{maxInlineActions:e,featureNavigationVisible:t}=this;if("number"!=typeof e)return null;const i=Math.round(e);return Math.max(t?i-1:i,0)}_watchActions(){const{allActions:e}=this.viewModel;this.notifyChange("dividedActions");const t="actions";this._handles.remove(t),e&&e.forEach((e=>{this._handles.add(c(e,["active","className","disabled","id","title","image","visible"],(()=>this.scheduleRender())),t)}))}_divideActions(){const{allActions:e}=this.viewModel,t=this._getInlineActionCount(),i=null===t,o=0===t;return{inlineActions:i?e.slice(0):o?new a:e.slice(0,t),menuActions:i?new a:o?e.slice(0):e.slice(t)}}_featureMenuOpenChanged(e){e?this._focusFirstFeature=!0:this._focusFeatureMenuButton=!0}_actionsMenuOpenChanged(e){e?this._focusFirstAction=!0:this._focusActionsMenuButton=!0}_setTitleFromFeatureWidget(e){const{selectedFeatureWidget:t}=this;t&&(this.viewModel.title=e||"")}_setContentFromFeatureWidget(){const{selectedFeatureWidget:e}=this;e&&(this.viewModel.content=e)}_handleFeatureMenuKeyup(e){"Escape"===l(e)&&(e.stopPropagation(),this._focusFeatureMenuButton=!0,this.featureMenuOpen=!1,this.scheduleRender())}_handleActionMenuKeyup(e){"Escape"===l(e)&&(e.stopPropagation(),this._focusActionsMenuButton=!0,this.actionsMenuOpen=!1,this.scheduleRender())}_handleFeatureMenuItemKeyup(e){const t=l(e),{_featureMenuNode:i}=this,o=e.currentTarget["data-feature-index"];if(!i)return;const n=i.querySelectorAll("li"),s=n.length;if("ArrowUp"!==t)if("ArrowDown"!==t)if("Home"!==t)if("End"!==t);else{e.stopPropagation();n[n.length-1].focus()}else{e.stopPropagation();n[0].focus()}else{e.stopPropagation();n[(o+1+s)%s].focus()}else{e.stopPropagation();n[(o-1+s)%s].focus()}}_handleActionMenuItemKeyup(e){const t=l(e),{_actionsMenuNode:i}=this,o=e.currentTarget["data-action-index"];if(!i)return;const n=i.querySelectorAll("li"),s=n.length;if("ArrowUp"!==t)if("ArrowDown"!==t)if("Home"!==t)if("End"!==t);else{e.stopPropagation();n[n.length-1].focus()}else{e.stopPropagation();n[0].focus()}else{e.stopPropagation();n[(o+1+s)%s].focus()}else{e.stopPropagation();n[(o-1+s)%s].focus()}}_handleMainKeyup(e){const t=l(e);"ArrowLeft"===t&&(e.stopPropagation(),this.previous()),"ArrowRight"===t&&(e.stopPropagation(),this.next())}_spinnerEnabledChange(e){if(this._destroySpinner(),!e)return;const t=this.get("viewModel.view");this._createSpinner(t)}_hideSpinner(){const{_spinner:e}=this;e&&(e.location=null,e.hide())}_displaySpinner(){const{_spinner:e}=this;if(!e)return;const{location:t,waitingForResult:i}=this.viewModel;i?e.show({location:t}):e.hide()}_getIconStyles(e){return{"background-image":e?`url(${e})`:""}}_addSelectedFeatureIndexHandle(){const e=c(this,"viewModel.selectedFeatureIndex",((e,t)=>this._selectedFeatureIndexUpdated(e,t)));this._handles.add(e,"selected-index")}_selectedFeatureIndexUpdated(e,t){const{featureCount:i}=this;i&&e!==t&&-1!==e&&(this.actionsMenuOpen=!1,this.featureMenuOpen=!1)}_destroySelectedFeatureWidget(){const{_feature:e}=this;e&&(e.viewModel=null,e&&!e.destroyed&&e.destroy()),this._feature=null}_isScreenLocationWithinView(e,t){return e.x>-1&&e.y>-1&&e.x<=t.width&&e.y<=t.height}_isOutsideView(e){const{popupHeight:t,popupWidth:i,screenLocation:o,side:n,view:s}=e;if(isNaN(i)||isNaN(t)||!s||!o)return!1;const r=s.padding;return"right"===n&&o.x+i/2>s.width-r.right||("left"===n&&o.x-i/2<r.left||("top"===n&&o.y-t<r.top||"bottom"===n&&o.y+t>s.height-r.bottom))}_calculateAutoAlignment(e){if("auto"!==e)return e;const{_pointerOffsetInPx:t,_containerNode:i,_mainContainerNode:o,viewModel:n}=this,{screenLocation:s,view:r}=n;if(!s||!r||!i)return"top-center";if(!this._isScreenLocationWithinView(s,r))return this._get("currentAlignment")||"top-center";function l(e){return parseInt(e.replace(/[^-\d\.]/g,""),10)}const a=o?window.getComputedStyle(o,null):null,u=a?l(a.getPropertyValue("max-height")):0,d=a?l(a.getPropertyValue("height")):0,{height:c,width:p}=i.getBoundingClientRect(),h=p+t,g=Math.max(c,u,d)+t,_=this._isOutsideView({popupHeight:g,popupWidth:h,screenLocation:s,side:"right",view:r}),v=this._isOutsideView({popupHeight:g,popupWidth:h,screenLocation:s,side:"left",view:r}),m=this._isOutsideView({popupHeight:g,popupWidth:h,screenLocation:s,side:"top",view:r}),f=this._isOutsideView({popupHeight:g,popupWidth:h,screenLocation:s,side:"bottom",view:r});return v?m?"bottom-right":"top-right":_?m?"bottom-left":"top-left":m?f?"top-center":"bottom-center":"top-center"}_callCurrentAlignment(e){return"function"==typeof e?e.call(this):e}_getCurrentAlignment(){const{alignment:e,dockEnabled:t}=this;return t||!this.viewModel.active?null:this._calculatePositionResult(this._calculateAutoAlignment(this._callCurrentAlignment(e)))}_setCurrentAlignment(){this._set("currentAlignment",this._getCurrentAlignment())}_setCurrentDockPosition(){this._set("currentDockPosition",this._getCurrentDockPosition())}_calculatePositionResult(e){const t=["left","right"];return m()&&t.reverse(),e.replace(/leading/gi,t[0]).replace(/trailing/gi,t[1])}_callDockPosition(e){return"function"==typeof e?e.call(this):e}_getDockPosition(){var e;return this._calculatePositionResult(this._calculateAutoDockPosition(this._callDockPosition(null==(e=this.dockOptions)?void 0:e.position)))}_getCurrentDockPosition(){return this.dockEnabled&&this.viewModel.active?this._getDockPosition():null}_wouldDockTo(){return this.dockEnabled?null:this._getDockPosition()}_calculateAutoDockPosition(e){var t;if("auto"!==e)return e;const i=null==(t=this.viewModel)?void 0:t.view,o=m()?"top-left":"top-right";if(!i)return o;const n=i.padding||{left:0,right:0,top:0,bottom:0},s=i.width-n.left-n.right,{breakpoints:r}=i;return r&&s<=r.xsmall?"bottom-center":o}_positionContainer(e=this._containerNode){if(e&&(this._containerNode=e),!e)return;const{screenLocation:t}=this.viewModel,{width:i}=e.getBoundingClientRect(),o=this._calculatePositionStyle(t,i);o&&(e.style.top=o.top,e.style.left=o.left,e.style.bottom=o.bottom,e.style.right=o.right)}_calculateFullWidth(e){const{currentAlignment:t,_pointerOffsetInPx:i}=this;return"top-left"===t||"bottom-left"===t||"top-right"===t||"bottom-right"===t?e+i:e}_calculateAlignmentPosition(e,t,i,o){const{currentAlignment:n,_pointerOffsetInPx:s}=this,r=o/2,l=i.height-t,a=i.width-e,{padding:u}=this.view;return"bottom-center"===n?{top:t+s-u.top,left:e-r-u.left}:"top-left"===n?{bottom:l+s-u.bottom,right:a+s-u.right}:"bottom-left"===n?{top:t+s-u.top,right:a+s-u.right}:"top-right"===n?{bottom:l+s-u.bottom,left:e+s-u.left}:"bottom-right"===n?{top:t+s-u.top,left:e+s-u.left}:"top-center"===n?{bottom:l+s-u.bottom,left:e-r-u.left}:void 0}_calculatePositionStyle(e,t){const{dockEnabled:i,view:o}=this;if(!o)return;if(i)return{left:"",top:"",right:"",bottom:""};if(!e||!t)return;const n=this._calculateFullWidth(t),s=this._calculateAlignmentPosition(e.x,e.y,o,n);return s?{top:void 0!==s.top?`${s.top}px`:"auto",left:void 0!==s.left?`${s.left}px`:"auto",bottom:void 0!==s.bottom?`${s.bottom}px`:"auto",right:void 0!==s.right?`${s.right}px`:"auto"}:void 0}_viewChange(e,t){e&&t&&(this.close(),this.clear())}_viewReadyChange(e,t){if(e){const e=this.get("viewModel.view");this._wireUpView(e)}else t&&(this.close(),this.clear())}_wireUpView(e){if(this._destroySpinner(),!e)return;const{spinnerEnabled:t}=this;t&&this._createSpinner(e),this._setDockEnabledForViewSize(this.dockOptions)}_dockingThresholdCrossed(e,t,i){const[o,n]=e,[s,r]=t,{width:l,height:a}=i;return o<=l&&s>l||o>l&&s<=l||n<=a&&r>a||n>a&&r<=a}_updateDockEnabledForViewSize(e,t){if(!e||!t)return;const i=this.get("viewModel.view.padding")||{left:0,right:0,top:0,bottom:0},o=i.left+i.right,n=i.top+i.bottom,s=[],r=[];s[0]=e[0]-o,s[1]=e[1]-n,r[0]=t[0]-o,r[1]=t[1]-n;const{dockOptions:l}=this,a=l.breakpoint;this._dockingThresholdCrossed(s,r,a)&&this._setDockEnabledForViewSize(l),this._setCurrentDockPosition()}_focusDockButtonNode(e){this._focusDockButton&&(this._focusDockButton=!1,e.focus())}_closeButtonNodeUpdated(e){return this._focusClose?(this._focusClose=!1,void e.focus()):this._blurClose?(this._blurClose=!1,void e.blur()):void 0}_mainContainerNodeUpdated(e){return this._mainContainerNode=e,this._focusContainer?(this._focusContainer=!1,void e.focus()):this._blurContainer?(this._blurContainer=!1,void e.blur()):void 0}_featureMenuNodeUpdated(e){if(this._featureMenuNode=e,!e||!this._focusFirstFeature)return;this._focusFirstFeature=!1;const t=e.querySelectorAll("li");if(t.length){t[0].focus()}}_actionsMenuNodeUpdated(e){if(this._actionsMenuNode=e,!e||!this._focusFirstAction)return;this._focusFirstAction=!1;const t=e.querySelectorAll("li");if(t.length){t[0].focus()}}_focusFeatureMenuButtonNode(e){this._focusFeatureMenuButton&&(this._focusFeatureMenuButton=!1,e.focus())}_focusActionsMenuButtonNode(e){this._focusActionsMenuButton&&(this._focusActionsMenuButton=!1,e.focus())}_featureMenuViewportNodeUpdated(e){e&&(e.scrollTop=0)}_toggleScreenLocationEnabled(){const{dockEnabled:e,viewModel:t}=this;if(!t)return;const i=t.active&&!e;t.screenLocationEnabled=i}_shouldDockAtCurrentViewSize(e){var t,i;const o=e.breakpoint,n=null==(t=this.viewModel)||null==(i=t.view)?void 0:i.ui;if(!n)return!1;const{width:s,height:r}=n;if(isNaN(s)||isNaN(r))return!1;const l=o.hasOwnProperty("width")&&s<=o.width,a=o.hasOwnProperty("height")&&r<=o.height;return l||a}_setDockEnabledForViewSize(e){e.breakpoint&&(this.dockEnabled=this._shouldDockAtCurrentViewSize(e))}_getPageText(e,t){return this.featureNavigationVisible?u(this.messages.pageText,{index:t+1,total:e}):null}_destroySpinner(){const{_spinner:e,view:t}=this;e&&(t&&t.ui&&t.ui.remove(this._spinner,"popup-spinner"),e.destroy(),this._spinner=null)}_createSpinner(e){e&&(this._spinner=new F({view:e}),e.ui.add(this._spinner,{key:"popup-spinner",position:"manual"}))}_toggleCollapsed(){this.collapsed=!this.collapsed}_close(){this.close(),this.view&&this.view.focus()}_toggleDockEnabled(){this.dockEnabled=!this.dockEnabled,this._focusDockButton=!0,this.scheduleRender()}_toggleFeatureMenu(){const e=!this.featureMenuOpen;this._featureMenuOpenChanged(e),this.actionsMenuOpen=!1,this.featureMenuOpen=e}_toggleActionsMenu(){const e=!this.actionsMenuOpen;this._actionsMenuOpenChanged(e),this.featureMenuOpen=!1,this.actionsMenuOpen=e}_triggerAction(e){const t=e.currentTarget["data-action-index"],i=this.viewModel.allActions.getItemAt(t);i&&"toggle"===i.type&&(i.value=!i.value),this.actionsMenuOpen=!1,this.viewModel.triggerAction(t)}_selectFeature(e){const t=e.currentTarget["data-feature-index"];isNaN(t)||(this.viewModel.selectedFeatureIndex=t),this.featureMenuOpen=!1,this._focusFeatureMenuButton=!0,this.scheduleRender()}_next(){this.next()}_previous(){this.previous()}};e([i({readOnly:!0,dependsOn:["id"]}),w()],et.prototype,"actionsMenuId",null),e([i({readOnly:!0,dependsOn:["id"]}),w()],et.prototype,"actionsMenuButtonId",null),e([i({readOnly:!0,dependsOn:["id"]}),w()],et.prototype,"featureMenuId",null),e([i({readOnly:!0,dependsOn:["id"]}),w()],et.prototype,"titleId",null),e([i({readOnly:!0,dependsOn:["id"]}),w()],et.prototype,"contentId",null),e([i({readOnly:!0,dependsOn:["selectedFeatureWidget","selectedFeatureWidget.viewModel","selectedFeatureWidget.viewModel.waitingForContent","selectedFeatureWidget.viewModel.content","viewModel.content"]}),w()],et.prototype,"hasContent",null),e([i({readOnly:!0,dependsOn:["viewModel.active","viewModel.featureCount","visibleElements.featureNavigation"]}),w()],et.prototype,"featureNavigationVisible",null),e([i({readOnly:!0,dependsOn:["collapseEnabled","viewModel.title","hasContent"]}),w()],et.prototype,"collapsible",null),e([i({readOnly:!0,dependsOn:["featureNavigationVisible","featureMenuOpen"]}),w()],et.prototype,"featureMenuVisible",null),e([i({readOnly:!0,dependsOn:["collapsible","featureMenuVisible","collapsed"]}),w()],et.prototype,"contentCollapsed",null),e([i({readOnly:!0,dependsOn:["featureNavigationVisible","maxInlineActions","viewModel.allActions","viewModel.allActions.length"]}),w()],et.prototype,"dividedActions",null),e([o("viewModel.actions"),w()],et.prototype,"actions",void 0),e([i({dependsOn:["viewModel.active"]}),w()],et.prototype,"actionsMenuOpen",null),e([i()],et.prototype,"alignment",void 0),e([o("viewModel.autoCloseEnabled")],et.prototype,"autoCloseEnabled",void 0),e([o("viewModel.autoOpenEnabled")],et.prototype,"autoOpenEnabled",void 0),e([o("viewModel.defaultPopupTemplateEnabled")],et.prototype,"defaultPopupTemplateEnabled",void 0),e([o("viewModel.content"),w()],et.prototype,"content",void 0),e([i(),w()],et.prototype,"collapsed",void 0),e([i(),w()],et.prototype,"collapseEnabled",void 0),e([i({readOnly:!0,dependsOn:["dockEnabled","alignment","viewModel.active"]}),w()],et.prototype,"currentAlignment",null),e([i({readOnly:!0,dependsOn:["viewModel.view.ready","dockEnabled","dockOptions","viewModel.active"]}),w()],et.prototype,"currentDockPosition",null),e([i(),w()],et.prototype,"dockOptions",null),e([i(),w()],et.prototype,"dockEnabled",void 0),e([o("viewModel.featureCount"),w()],et.prototype,"featureCount",void 0),e([i(),w()],et.prototype,"featureMenuOpen",void 0),e([o("viewModel.features"),w()],et.prototype,"features",void 0),e([i(),w()],et.prototype,"featureNavigationEnabled",null),e([o("viewModel.goToOverride")],et.prototype,"goToOverride",void 0),e([o("viewModel.highlightEnabled")],et.prototype,"highlightEnabled",void 0),e([o("viewModel.location"),w()],et.prototype,"location",void 0),e([i({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],et.prototype,"label",void 0),e([i(),w()],et.prototype,"maxInlineActions",void 0),e([i(),w(),b("esri/widgets/Popup/t9n/Popup")],et.prototype,"messages",void 0),e([i(),w(),b("esri/t9n/common")],et.prototype,"messagesCommon",void 0),e([o("viewModel.promises")],et.prototype,"promises",void 0),e([o("viewModel.selectedFeature"),w()],et.prototype,"selectedFeature",void 0),e([o("viewModel.selectedFeatureIndex"),w()],et.prototype,"selectedFeatureIndex",void 0),e([i({readOnly:!0,dependsOn:["viewModel.selectedFeatureViewModel","visibleElements"]}),w()],et.prototype,"selectedFeatureWidget",null),e([i()],et.prototype,"spinnerEnabled",void 0),e([o("viewModel.title"),w()],et.prototype,"title",void 0),e([o("viewModel.updateLocationEnabled")],et.prototype,"updateLocationEnabled",void 0),e([o("viewModel.view")],et.prototype,"view",void 0),e([i({type:x}),w(["viewModel.active","viewModel.view.widthBreakpoint","viewModel.allActions","viewModel.screenLocation","viewModel.screenLocationEnabled","viewModel.state","viewModel.pendingPromisesCount","viewModel.promiseCount","viewModel.waitingForResult"]),M(["triggerAction","trigger-action"])],et.prototype,"viewModel",void 0),e([o("viewModel.visible"),w()],et.prototype,"visible",void 0),e([i(),w()],et.prototype,"visibleElements",void 0),e([n("visibleElements")],et.prototype,"castVisibleElements",null),e([f()],et.prototype,"_close",null),e([f()],et.prototype,"_toggleDockEnabled",null),e([f()],et.prototype,"_toggleFeatureMenu",null),e([f()],et.prototype,"_toggleActionsMenu",null),e([f()],et.prototype,"_triggerAction",null),e([f()],et.prototype,"_selectFeature",null),e([f()],et.prototype,"_next",null),e([f()],et.prototype,"_previous",null),et=e([r("esri.widgets.Popup")],et);var tt=et;export default tt;
