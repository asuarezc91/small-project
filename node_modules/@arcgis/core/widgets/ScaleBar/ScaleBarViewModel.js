/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../core/has.js";import"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import{property as t}from"../../core/accessorSupport/decorators/property.js";import{subclass as r}from"../../core/accessorSupport/decorators/subclass.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import o from"../../core/Accessor.js";import s from"../../geometry/support/WKIDUnitConversion.js";import{getInfo as i}from"../../geometry/support/spatialReferenceUtils.js";import{webMercatorToGeographic as n}from"../../geometry/support/webMercatorUtils.js";import a from"../../geometry/Point.js";import c from"../../geometry/Polyline.js";import"../../geometry.js";import{createScreenPoint as p}from"../../core/screenUtils.js";import{straightLineDensify as m}from"../../geometry/support/normalizeUtils.js";import{geodesicLengths as l}from"../../geometry/support/geodesicUtils.js";function u(e,t){return e&&e.indexOf(t)>-1}function d(e,t){const{x:r,y:o}="decimal-degrees"===e?n(t,!0):t;return[r,o]}function f({state:{paddedViewState:e},spatialReference:t,width:r}){return t.isWrappable&&e.worldScreenWidth<r}let g=class extends o{constructor(e){super(e),this.scaleComputedFrom=p(),this.view=null}get state(){return this.get("view.ready")&&"2d"===this.get("view.type")?"ready":"disabled"}getScaleBarProperties(e,t){if("disabled"===this.state||isNaN(e)||!t)return null;const r=this._getDistanceInKm(this.view,this.scaleComputedFrom);if("metric"===t)return this._getScaleBarProps(e,r,"metric");const o=r/1.609;return this._getScaleBarProps(e,o,"non-metric")}_getLocationUnit(){const e=this.get("view.spatialReference"),{isWebMercator:t,wkid:r,wkt:o}=e;return t||u(o,"WGS_1984_Web_Mercator")?"decimal-degrees":null!=s[r]||u(o,"PROJCS")?"linear-unit":"unknown"}_getDistanceInKm(e,t){const{state:r,spatialReference:o}=e,i=this._getLocationUnit();if("linear-unit"===i){const e=1e3;return r.extent.width*function(e){const{wkid:t}=e;if(null!=s[t])return s.values[s[t]];const{wkt:r}=e,o=r.lastIndexOf(",")+1,i=r.lastIndexOf("]]");return parseFloat(r.substring(o,i))}(o)/e}const[n,a]=this._getScaleMeasuringPoints(e,t),p=new c({paths:[[d(i,n),d(i,a)]],spatialReference:4326}),u=m(p,10),[f]=l([u],"kilometers");return f}_getScaleMeasuringPoints(e,t){const{width:r,height:o,position:s,spatialReference:n}=e;if(f(e)){const{valid:e}=i(n);return[new a(e[0],0,n),new a(e[1],0,n)]}let c=t.y-s[1];c>o?c=o:c<0&&(c=0);const m=p(0,c),l=p(r,c);return[e.toMap(m),e.toMap(l)]}_getScaleBarProps(e,t,r){const{view:o}=this;let s=e*t/(f(o)?o.state.paddedViewState.worldScreenWidth:o.width),i="metric"===r?"km":"mi";if(s<.1)if("mi"===i){s*=5280,i="ft"}else if("km"===i){s*=1e3,i="m"}let n=0;for(;s>=1;)s/=10,n++;const a=this._getConstraints(s);if(!a)return null;const{min:c,max:p}=a,m=p/s>=s/c?c:p;return{length:e*(m/s),value:Math.pow(10,n)*m,unit:i}}_getConstraints(e){return e>.5?{min:.5,max:1}:e>.3?{min:.3,max:.5}:e>.2?{min:.2,max:.3}:e>.15?{min:.15,max:.2}:e>=.1?{min:.15,max:.1}:void 0}};e([t()],g.prototype,"scaleComputedFrom",void 0),e([t({readOnly:!0,dependsOn:["scaleComputedFrom","view.ready","view.scale"]})],g.prototype,"state",null),e([t()],g.prototype,"view",void 0),g=e([r("esri.widgets.Scalebar.ScaleBarViewModel")],g);var w=g;export default w;
