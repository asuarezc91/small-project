/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../core/has.js";import"../../core/Logger.js";import{property as t}from"../../core/accessorSupport/decorators/property.js";import{aliasOf as i}from"../../core/accessorSupport/decorators/aliasOf.js";import{cast as r}from"../../core/accessorSupport/decorators/cast.js";import{subclass as s}from"../../core/accessorSupport/decorators/subclass.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import o from"../../core/Accessor.js";import l from"../../core/Collection.js";import{IdentifiableMixin as a}from"../../core/Identifiable.js";import n from"../../support/actions/ActionBase.js";import p from"../../support/actions/ActionButton.js";import d from"../../support/actions/ActionToggle.js";import{init as h,watch as c}from"../../core/watchUtils.js";import{HandleOwnerMixin as y}from"../../core/HandleOwner.js";import u from"../../layers/support/Sublayer.js";import m from"../../support/actions/ActionSlider.js";import v from"./ListItemPanel.js";import{isLayerOutsideScaleRange as w,findLayerVisibilityMode as f,findLayerListMode as b,canDisplayLayer as g,getNormalizedChildLayerProperty as _}from"./support/layerListUtils.js";var j;const S=l.ofType({key:"type",defaultKeyValue:"button",base:n,typeMap:{button:p,toggle:d,slider:m}}),O=l.ofType(S);let L=j=class extends(a(y(o))){constructor(e){super(e),this.actionsSections=new O,this.actionsOpen=!1,this.children=new(l.ofType(j)),this.childrenSortable=!0,this.error=null,this.layer=null,this.layerView=null,this.open=!1,this.panel=null,this.parent=null,this.sortable=!0,this.view=null,this.visible=null}initialize(){this.handles.add([h(this,"layer",(e=>this._watchLayerProperties(e))),h(this,"view",(e=>this._updateChildren(e))),h(this,"panel",(e=>this._setListItemOnPanel(e))),h(this,["layer","view"],(()=>this._getLayerView()))])}destroy(){this.view=null}castPanel(e){return this.get("panel.open")&&!e.hasOwnProperty("open")&&(e.open=!0),e?new v(e):null}get title(){const e=this.get("layer.layer");return(!e||e&&this.get("layer.layer.loaded"))&&this.get("layer.title")||""}set title(e){void 0!==e?this._override("title",e):this._clearOverride("title")}get updating(){const e=this.layerView;return e?e.updating:this._isLayerUpdating(this.layer)}get visibleAtCurrentScale(){return!w(this.layer,this.get("view.scale"))}get visibilityMode(){return f(this.layer)}clone(){return new j({actionsSections:this.actionsSections.clone(),actionsOpen:this.actionsOpen,children:this.children.clone(),layer:this.layer,open:this.open,panel:this.panel,title:this.title,view:this.view,visible:this.visible})}_setListItemOnPanel(e){e&&(e.listItem=this)}_updateChildren(e){const t=this.children;t&&t.forEach((t=>t.view=e))}_addChildren(e){if(this.handles.remove("child-list-mode"),this.children.removeAll(),!e)return;e.forEach((t=>{this.handles.add(c(t,"listMode",(()=>this._addChildren(e))),"child-list-mode")}));const t=[];e.filter((e=>"hide"!==b(e))).forEach((e=>{if(g(e)){const i=new j({layer:e,parent:this,view:this.view});t.unshift(i)}})),this.children.addMany(t)}_watchSublayerChanges(e){e&&this.handles.add(e.on("change",(()=>{this._addChildren(e)})),"layer")}_initializeChildLayers(e){this._addChildren(e),this._watchSublayerChanges(e)}_watchLayerProperties(e){if(!this.handles)return;if(this.handles.remove("layer"),this.handles.remove("child-list-mode"),!e)return;this.handles.add(c(e,"listMode",(()=>this._watchLayerProperties(e))),"layer");if("hide-children"===b(e))return void this.children.removeAll();const t=_(e);t&&this.handles.add(h(e,t,(()=>{e.hasOwnProperty(t)&&this._initializeChildLayers(e[t])})),"layer")}async _getLayerView(){const{layer:e,view:t}=this;if(e&&t)try{const i=await t.whenLayerView(e);if(i.layer!==this.layer)return;this._set("layerView",i)}catch{}}_isLayerUpdating(e){return!(e instanceof u)&&(e&&"loading"===e.loadStatus)}};e([t({type:O})],L.prototype,"actionsSections",void 0),e([t()],L.prototype,"actionsOpen",void 0),e([t({type:l})],L.prototype,"children",void 0),e([t()],L.prototype,"childrenSortable",void 0),e([i("layer.loadError?")],L.prototype,"error",void 0),e([t()],L.prototype,"layer",void 0),e([t({readOnly:!0})],L.prototype,"layerView",void 0),e([t()],L.prototype,"open",void 0),e([t({type:v})],L.prototype,"panel",void 0),e([r("panel")],L.prototype,"castPanel",null),e([t()],L.prototype,"parent",void 0),e([t()],L.prototype,"sortable",void 0),e([t({dependsOn:["layer.layer?.loaded","layer.title"]})],L.prototype,"title",null),e([t({dependsOn:["layer.loadStatus?","layerView.updating"],readOnly:!0})],L.prototype,"updating",null),e([t({value:null})],L.prototype,"view",void 0),e([i("layer.visible")],L.prototype,"visible",void 0),e([t({dependsOn:["layer.minScale?","layer.maxScale?","view.scale"],readOnly:!0})],L.prototype,"visibleAtCurrentScale",null),e([t({dependsOn:["layer.visibilityMode?","layer.capabilities?.exportMap?.supportsSublayerVisibility","layer.layer?.capabilities?.exportMap?.supportsSublayerVisibility"],readOnly:!0})],L.prototype,"visibilityMode",null),L=j=e([s("esri.widgets.LayerList.ListItem")],L);var C=L;export default C;
