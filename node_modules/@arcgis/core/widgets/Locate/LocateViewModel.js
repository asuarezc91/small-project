/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import"../../core/has.js";import"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import{property as e}from"../../core/accessorSupport/decorators/property.js";import{subclass as o}from"../../core/accessorSupport/decorators/subclass.js";import a from"../../core/Error.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import{createAbortController as r}from"../../core/promiseUtils.js";import{onLocaleChange as i}from"../../intl/locale.js";import l from"../../PopupTemplate.js";import{fetchMessageBundle as s}from"../../intl/messages.js";import"../../intl.js";import c from"../../core/Handles.js";import{on as p}from"../../core/watchUtils.js";import{triggerAction as n,removeSelectedFeature as d}from"../Popup/actions.js";import{getCurrentPosition as u}from"../support/geolocationUtils.js";import h from"../support/GeolocationPositioning.js";let m=class extends h{constructor(t){super(t),this._locateController=null,this._handles=new c,this.locate=this.locate.bind(this)}initialize(){this._handles.add([p(this,"view.popup","trigger-action",(t=>n({event:t,view:this.view}))),i((()=>{var t;const{graphic:e,view:o}=this;(null==o||null==(t=o.graphics)?void 0:t.includes(e))&&this._updatePopupTemplate(e)}))])}destroy(){this.cancelLocate(),this._handles.destroy(),this._handles=null}get state(){return this._geolocationUsable?this.get("view.ready")?this._locateController?"locating":"ready":"disabled":"feature-unsupported"}async locate(){if(this.cancelLocate(),"disabled"===this.state)throw new a("locate:disabled-state","Cannot locate when disabled.");if("feature-unsupported"===this.state)throw new a("locate:feature-unsupported-state","Cannot locate in unsecure domain.");const t=r();this._locateController=t;try{let e=await u(this.geolocationOptions);return e=await this._setPosition(e,{signal:t.signal}),this._locateController!==t?null:(this.graphic&&(this.graphic=this.graphic.clone(),await this._updatePopupTemplate(this.graphic),this.view.graphics.push(this.graphic)),this.emit("locate",{position:e}),this._locateController=null,e)}catch(t){throw this._locateController=null,this.emit("locate-error",{error:t}),t}}cancelLocate(){this._clear(),this._locateController&&this._locateController.abort(),this._locateController=null}async _updatePopupTemplate(t){const e=await async function(){const t=await s("esri/widgets/Locate/t9n/Locate");return new l({title:t.currentLocation,fieldInfos:[{fieldName:"timestamp",label:t.timestamp,format:{dateFormat:"short-date-short-time"}},{fieldName:"latitude",label:t.latitude,format:{places:4,digitSeparator:!0}},{fieldName:"longitude",label:t.longitude,format:{places:4,digitSeparator:!0}},{fieldName:"accuracy",label:t.accuracy,format:{places:0,digitSeparator:!0}},{fieldName:"altitude",label:t.altitude,format:{places:0,digitSeparator:!0}},{fieldName:"altitudeAccuracy",label:t.altitudeAccuracy,format:{places:0,digitSeparator:!0}},{fieldName:"heading",label:t.heading,format:{places:0,digitSeparator:!0}},{fieldName:"speed",label:t.speed,format:{places:0,digitSeparator:!0}}],actions:[d.clone()],content:[{type:"fields"}]})}(),o=t!==this.graphic;this.destroyed||o||(t.popupTemplate=e)}};t([e()],m.prototype,"_locateController",void 0),t([e({dependsOn:["view.ready","_locateController","_geolocationUsable"],readOnly:!0})],m.prototype,"state",null),t([e()],m.prototype,"locate",null),t([e()],m.prototype,"cancelLocate",null),m=t([o("esri.widgets.Locate.LocateViewModel")],m);var f=m;export default f;
