/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import{isSome as t}from"../../../core/maybe.js";import"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import{property as i}from"../../../core/accessorSupport/decorators/property.js";import{aliasOf as s}from"../../../core/accessorSupport/decorators/aliasOf.js";import{subclass as o}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import{on as l}from"../../../core/events.js";import{clamp as n}from"../../../core/mathUtils.js";import r from"../../../core/Handles.js";import{init as h}from"../../../core/watchUtils.js";import{storeNode as a}from"../../support/widgetUtils.js";import{renderable as v}from"../../support/decorators/renderable.js";import{j as d}from"../../../chunks/index.js";import _ from"../../Widget.js";import p from"../BuildingLevel.js";import{L as g,a as c,b as u,A as m,c as L,d as w,e as M,f as y,g as f,h as P,i as b}from"../../../chunks/constants.js";import{Label as C}from"./Label.js";import{LevelItem as W}from"./LevelItem.js";const x={selectLevel:"selectLevel",clearLevel:"clearLevel",nextLevel:"nextLevel",previousLevel:"previousLevel",currentLevel:"{{value}}"},H="esri-building-level-picker",j={container:H,noLevel:`${H}--no-level`,animateLevel:`${H}--animate-level`,levelsContainer:`${H}__levels-container`,innerLevelsContainer:`${H}__inner-levels-container`,labelContainer:`${H}__label-container`,arrowUp:`${H}__arrow-up`,arrowDown:`${H}__arrow-down`};let E=class extends _{constructor(e,i){super(e,i),this._defaultViewModel=new p,this.viewModel=this._defaultViewModel,this.messages=x,this._levelHandles=new r,this._levelEventHandles=new r,this._levelWidgets=[],this._labelWidget=new C({onClear:()=>this.viewModel.clear()}),this._hoveredLevel=null,this._expandedLevelsHeight=void 0,this._normalizedPointerPosition=0,this._hovering=!1,this._containerPosTop=null,this._levelsContainer=null,this._onPointerUp=()=>{window.getSelection().removeAllRanges(),t(this._hoveredLevel)&&(this.viewModel.enabled&&this._hoveredLevel===this.viewModel.value?this.viewModel.clear():this.viewModel.select(this._hoveredLevel))},this._onPointerEnter=()=>{var e;!this._hovering&&t(this._levelsContainer)&&(this._hovering=!0,this._containerPosTop=null!=(e=this._levelsContainer.getBoundingClientRect().top)?e:0)},this._onPointerLeave=()=>{this._hovering&&(this._normalizedPointerPosition=0,this._hoveredLevel=null,this._hovering=!1)},this._onPointerMove=e=>{if(!this._hovering)return!1;if(window.getSelection().removeAllRanges(),t(this._containerPosTop)){const t=this._containerPosTop,i=w*b,s=this._expandedLevelsMargin;let o=this._levelsHeight,l=t+i+s;const n=this._levelHeight/2;l+=n,o-=n;let r=(e.clientY-l)/o;r+=g,this._normalizedPointerPosition=r}return!1}}postInitialize(){this.own(h(this,"_levelsContainer",(()=>this._onContainerChange())),h(this,"_levels",(()=>this._createLevelWidgets())),h(this,"messages",(()=>this._labelWidget.messages=this.messages)))}destroy(){this._levelHandles.destroy(),this._levelEventHandles.destroy(),this._levelWidgets.forEach((e=>e.destroy())),this._labelWidget.destroy(),this.viewModel!==this._defaultViewModel&&this._defaultViewModel.destroy()}get _levelsHeight(){return Math.round(this._levelHeight*this._numLevels)}get _expandedLevelsMargin(){return Math.round((this._expandedLevelsHeight-this._levelsHeight)/2)}get _levelWidth(){const{LEVEL_WIDTH_NOMINATOR:e,LEVEL_WIDTH_CONSTANT:t}=f,i=e/Math.sqrt(this._numLevels)+t;return Math.round(n(i,u,c))}get _levelHeight(){const e=P,t=2*e/Math.sqrt(this._numLevels);return Math.round(n(t,2,e))}get _gaussianFactor(){const e=this._numLevels;return e/Math.log(m*e)*L}get _levelClosestToPointer(){if(!this._hovering)return null;const e=this._numLevels-1,i=this._normalizedPointerPosition;return e>=0&&t(i)?this._levels[Math.round((1-i)*e)]:null}render(){const e=this._levelWidgets.length,t=e>1?this._levelWidgets.map((e=>e.render())):null,i=w*b,s=-i/b,o=this._levelsHeight,l=o+2*i;return d("div",{bind:this,key:this,class:this.classes("esri-widget",j.container,{[j.animateLevel]:!this._hovering,[j.noLevel]:e<2}),onkeydown:this._onKeyDown},this._renderLabelContainer(),d("div",{bind:this,class:j.levelsContainer,styles:{height:`${l}px`,marginTop:`${s}px`,marginBottom:`${s}px`},onfocus:this._onFocus,afterCreate:a,"data-node-ref":"_levelsContainer"},d("div",{styles:{height:`${o}px`,margin:w-this._expandedLevelsMargin+"px 0 0 0"},class:j.innerLevelsContainer},t)))}_renderLabelContainer(){const e=this.messages.previousLevel,t=this.messages.nextLevel;return d("div",{class:j.labelContainer,tabIndex:0},d("button",{bind:this,class:j.arrowUp,disabled:!this.viewModel.hasNext,onclick:this._onArrowUpClick,"aria-label":t,title:t,type:"button"}),this._labelWidget.render(),d("button",{bind:this,class:j.arrowDown,disabled:!this.viewModel.hasPrevious,onclick:this._onArrowDownClick,"aria-label":e,title:e,type:"button"}))}_updateComponents(){const e=this.viewModel.enabled?this.viewModel.value:null,i=t(this._hoveredLevel)?this._hoveredLevel:e;this._levelWidgets.forEach((i=>{var s,o;const l=this.viewModel.getValueLabel(i.level);i.label=t(l)?l:null==(s=this.messages)||null==(o=s.currentLevel)?void 0:o.replace("{{level}}",String(i.level)),i.active=i.level===e,i.hovering=i.level===this._hoveredLevel})),this._labelWidget.level=i,this._labelWidget.active=i===e,this._labelWidget.hovering=t(this._hoveredLevel)}_onWidthChange(){this._levelWidgets.forEach((e=>{e.width=this._levelWidth}))}_createLevelWidgets(){this._levelWidgets.forEach((e=>e.destroy())),this._levelWidgets=this._levels.map((e=>new W({level:e,onSelect:()=>this._onLevelToggle(e)}))),this._levelHandles.removeAll(),this._levelHandles.add([h(this,["messages","viewModel.value","viewModel.enabled","_hoveredLevel","_hovering"],(()=>this._updateComponents())),h(this,["_normalizedPointerPosition","_hovering"],(()=>this._onPointerPositionChange())),h(this,"_width",(()=>this._onWidthChange()))])}_onContainerChange(){const e=this._levelsContainer;t(e)&&(this._levelEventHandles.removeAll(),this._levelEventHandles.add([l(e,"pointerenter",this._onPointerEnter),l(e,"pointerover",this._onPointerEnter),l(e,"pointerleave",this._onPointerLeave),l(e,"pointerup",this._onPointerUp),l(e,"pointermove",this._onPointerMove)]))}_onKeyDown(e){switch(e.key){case"ArrowDown":case"ArrowLeft":e.preventDefault(),e.stopPropagation(),this.viewModel.previous(),this._focusCurrentLevel();break;case"ArrowUp":case"ArrowRight":e.preventDefault(),e.stopPropagation(),this.viewModel.next(),this._focusCurrentLevel()}}_focusCurrentLevel(){const e=this._levelWidgets.find((e=>e.level===this.viewModel.value));e&&e.focus()}_onFocus(){this._hoveredLevel=this._levels.length>0?this._levels[0]:null}_onLevelToggle(e){this.viewModel.enabled&&this.viewModel.value===e?this.viewModel.clear():this.viewModel.select(e)}_onArrowUpClick(){this.viewModel.next()}_onArrowDownClick(){this.viewModel.previous()}_onPointerPositionChange(){let e=0;this._levelWidgets.forEach(((t,i)=>{const{width:s,height:o}=this._getLevelWidgetSize(i);t.height=o,t.width=s,e+=o})),this._hoveredLevel=this._levelClosestToPointer;const t=this._expandedLevelsHeight;(null==t||Math.abs(t-e)>30)&&(this._expandedLevelsHeight=e)}_getLevelWidgetSize(e){const t={width:this._levelWidth,height:this._levelHeight};if(this._hovering){const i=this._getGaussianFactor(e,this._normalizedPointerPosition);t.width+=M*i,t.height+=y*i}return t}_getGaussianFactor(e,t){const i=this._numLevels-1,s=(i-e)/i,o=this._gaussianFactor*(s-t);return Math.exp(-(o**2))}};e([i({type:p}),v(["viewModel.hasNext","viewModel.hasPrevious"])],E.prototype,"viewModel",void 0),e([i()],E.prototype,"messages",void 0),e([i(),v()],E.prototype,"_levelWidgets",void 0),e([i(),v()],E.prototype,"_labelWidget",void 0),e([i(),v()],E.prototype,"_hoveredLevel",void 0),e([s("viewModel.allowedValues"),v()],E.prototype,"_levels",void 0),e([s("_levels.length"),v()],E.prototype,"_numLevels",void 0),e([i({readOnly:!0,dependsOn:["_numLevels","_levelHeight"]}),v()],E.prototype,"_levelsHeight",null),e([i(),v()],E.prototype,"_expandedLevelsHeight",void 0),e([i({readOnly:!0,dependsOn:["_expandedLevelsHeight","_levelsHeight"]}),v()],E.prototype,"_expandedLevelsMargin",null),e([i({readOnly:!0,dependsOn:["_numLevels"]})],E.prototype,"_levelWidth",null),e([i({readOnly:!0,dependsOn:["_numLevels"]})],E.prototype,"_levelHeight",null),e([i({readOnly:!0,dependsOn:["_numLevels"]})],E.prototype,"_gaussianFactor",null),e([i({readOnly:!0,dependsOn:["_levels","_numLevels","_hovering","_normalizedPointerPosition"]})],E.prototype,"_levelClosestToPointer",null),e([i({type:Number,range:{min:0,max:1}}),v()],E.prototype,"_normalizedPointerPosition",void 0),e([i()],E.prototype,"_hovering",void 0),e([i()],E.prototype,"_containerPosTop",void 0),e([i()],E.prototype,"_levelsContainer",void 0),E=e([o("esri.widgets.BuildingExplorer.BuildingLevelPicker.BuildingLevelPicker")],E);var T=E;export default T;
