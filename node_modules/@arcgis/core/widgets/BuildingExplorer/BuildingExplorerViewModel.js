/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../core/has.js";import{isSome as s}from"../../core/maybe.js";import t from"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import{property as r}from"../../core/accessorSupport/decorators/property.js";import{subclass as i}from"../../core/accessorSupport/decorators/subclass.js";import"../../core/urlUtils.js";import"../../core/uuid.js";import"../../portal/support/resourceExtension.js";import{all as o,isAbortError as l}from"../../core/promiseUtils.js";import a from"../../core/Accessor.js";import p from"../../core/Collection.js";import{referenceSetter as n}from"../../core/collectionUtils.js";import d from"../../core/Handles.js";import{init as h,whenEqualOnce as y}from"../../core/watchUtils.js";import c from"../../layers/support/BuildingFilter.js";import m from"../../layers/BuildingSceneLayer.js";import{showFullModel as u}from"./support/buildingLayerUtils.js";import{createLoadLayersFunction as f}from"./support/layerUtils.js";import g from"./BuildingDisciplinesViewModel.js";import{setFilterOnLayers as j,getFilterBlockSolid as v,getFilterBlockXRay as w,generateFilterId as _}from"./support/filterUtils.js";import x from"./BuildingLevel.js";import B from"./BuildingPhase.js";const L=t.getLogger("esri.widgets.BuildingExplorer.BuildingExplorerViewModel");let E=class extends a{constructor(e){super(e),this.view=null,this.state="disabled",this.level=new x,this.phase=new B,this.disciplines=new g,this._handles=new d,this._loadLayers=f(),this.layers=new p}initialize(){this._handles.add([this.layers.on("change",(()=>this._onLayersChange())),h(this,"_filter",(()=>j(this.layers,this._filter)))]),this._onLayersChange()}destroy(){this._handles.destroy(),this.level.destroyed||this.level.destroy(),this.phase.destroyed||this.phase.destroy(),this.disciplines.destroyed||this.disciplines.destroy()}get isSupported(){var e;return"3d"===(null==(e=this.view)?void 0:e.type)}set layers(e){const s=e.filter((e=>e instanceof m));s.length!==e.length&&L.error("Some layers are not BuildingSceneLayers but only BuildingSceneLayers can be passed to the widget."),this._set("layers",n(s,this._get("layers")))}get _filter(){const e=this.level.filterExpressions,t=this.phase.filterExpressions,r=[],i=v([e.solid,t.solid]);s(i)&&r.push(i);const o=w([e.xRay,t.xRay]);return s(o)&&r.push(o),0===r.length?null:new c({id:_(),name:"Building Explorer Filter",filterBlocks:r})}async _onLayersChange(){if(this.level.layers=this.layers,this.phase.layers=this.layers,this.disciplines.layers=this.layers,0!==this.layers.length){this._set("state","loading");try{await this._loadLayers(this.layers),await o([y(this.level,"state","ready"),y(this.phase,"state","ready"),y(this.disciplines,"state","ready")]),this.layers.forEach(u),this._set("state","ready")}catch(e){l(e)||this._set("state","failed")}}else this._set("state","disabled")}};e([r({value:null})],E.prototype,"view",void 0),e([r({dependsOn:["view.type"]})],E.prototype,"isSupported",null),e([r({type:p,nonNullable:!0})],E.prototype,"layers",null),e([r({readOnly:!0})],E.prototype,"state",void 0),e([r({readOnly:!0,type:x})],E.prototype,"level",void 0),e([r({readOnly:!0,type:B})],E.prototype,"phase",void 0),e([r({readOnly:!0,type:g})],E.prototype,"disciplines",void 0),e([r({readOnly:!0,dependsOn:["level.filterExpressions","phase.filterExpressions"]})],E.prototype,"_filter",null),E=e([i("esri.widgets.BuildingExplorer.BuildingExplorerViewModel")],E);var b=E;export default b;
