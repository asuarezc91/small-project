/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import t from"../geometry/SpatialReference.js";import{geographicToWebMercator as e}from"../geometry/support/webMercatorUtils.js";import a from"../geometry/Extent.js";import{deg2rad as i,rad2deg as s,asinClamped as n}from"../core/mathUtils.js";import{f as o,c as r}from"./vec3f64.js";import{n as c,c as l,d as m,i as p,p as f,l as h,a as u}from"./vec3.js";import{Cyclical as y,cyclical2PI as M}from"../views/3d/support/mathUtils.js";import{getReferenceEllipsoid as d}from"../geometry/projectionEllipsoid.js";import{i as j,r as T}from"./mat4.js";import{a as g}from"./mat4f64.js";import{getLonDeltaForDistance as R}from"../views/3d/support/earthUtils.js";import{createDirectionUp as x,directionToHeadingTilt as b}from"../views/3d/support/cameraUtilsInternal.js";const v=o(0,0,1),w=c(r(),o(1,1,1)),I=new y(-180,180),U=g(),P=r(),q=r();function E(t,e,a,s=x()){l(P,t,v),0===m(P,P)&&l(P,t,w),j(U),T(U,U,-i(e),t),T(U,U,-i(a),P);const{up:n,direction:o}=s;return l(n,P,t),c(n,n),p(n,n,U),c(o,t),f(o,o),p(o,o,U),s}function _(t,e,a,i){const s=P,n=q;return c(s,t),l(q,s,v),0===m(q,q)&&l(q,s,w),l(n,q,s),b(e,a,i,s,n)}function H(t,e,a,s){const o={eye:r(),up:null,tilt:s,heading:a},c=P;c[0]=t[0],c[1]=t[2],c[2]=-t[1];const l=e,m=i(a),p=i(s),f=Math.sin(m),y=Math.cos(m),M=Math.sin(p),d=Math.cos(p),j=h(c);let T;if(Math.abs(p)<1e-8)T=l+j;else{const t=j/M,e=n(l/t),a=Math.PI-p-e;T=t*Math.sin(a)}const g=d*l,R=l*l*(M*M),x=y*y*R,b=T-g,v=b*b,w=x*(x+v-c[1]*c[1]);if(w<0)return u(o.eye,c,T/j),o.tilt=0,o;const I=Math.sqrt(w),U=c[1]*b,q=x+v;let E;if(E=y>0?-I+U:I+U,Math.abs(q)<1e-8)return j<1e-8?(o.eye[0]=0,o.eye[1]=0,o.eye[2]=l):u(o.eye,c,T/j),o.tilt=0,W(o.eye),k(o,t);o.eye[1]=E/q;const _=f*f*R,H=M*l,z=y*H*o.eye[1],A=o.eye[1]*o.eye[1],G=1-A,S=Math.sqrt(G),C=x*A+_-2*z*S*b+G*v;return Math.abs(C)<1e-8?(u(o.eye,c,T/j),o.tilt=0,W(o.eye),k(o,t)):(o.eye[0]=(G*(T*c[0]-g*c[0])-H*S*(c[0]*o.eye[1]*y+c[2]*f))/C,o.eye[2]=(G*(T*c[2]-g*c[2])-H*S*(c[2]*o.eye[1]*y-c[0]*f))/C,u(o.eye,o.eye,T),W(o.eye),k(o,t))}function W(t){const e=t[1];t[1]=-t[2],t[2]=e}function k(t,e){const a=E(e,t.heading,t.tilt);return t.up=a.up,t}function z(t,e,a){const i=h(e),o=Math.sqrt(a*a+i*i-2*a*i*Math.cos(Math.PI-t)),r=n(a/(o/Math.sin(t)));return s(t-r)}function A(t,e,a){const s=i(t),o=h(e);return n(a/(o/Math.sin(s)))+s}function G(n,o,r,c,l){let m,p,f,h;const u=o.latitude,y=o.longitude,j=R(u,r,d(n.spatialReference).radius)/2;m=y-j,p=y+j;const T=i(u),g=d(n.spatialReference).radius,x=(1+Math.sin(T))/(1-Math.sin(T)),b=(x+1)*Math.tan(c/g/2),v=b*b;function w(t){const e=Math.PI/2;return(t=M.normalize(t,-e))>e&&(t=Math.PI-t),t}if(f=1.5*Math.PI-2*Math.atan(.5*(b+Math.sqrt(4*x+v))),h=f+c/g,f=w(f),h=w(h),h<f){const t=h;h=f,f=t}if(f=Math.max(s(f),-90),h=Math.min(s(h),90),p=I.monotonic(m,p),p-m>180){const t=(p-m-180)/2;m+=t,p-=t}const U=n.spatialReference&&n.spatialReference.isGeographic?n.spatialReference:t.WGS84;return l?(l.xmin=m,l.ymin=f,l.xmax=p,l.ymax=h,l.spatialReference=U):l=new a(m,f,p,h,U),n.spatialReference&&n.spatialReference.isWebMercator&&e(l,!1,l),l}var S=Object.freeze({__proto__:null,headingTiltToDirectionUp:E,directionToHeadingTilt:_,eyeForCenterWithHeadingTilt:H,lookAtTiltToEyeTilt:z,eyeTiltToLookAtTilt:A,toExtent:G});export{A as a,S as c,_ as d,H as e,E as h,z as l,G as t};
