/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isNone as e}from"../core/maybe.js";import{JSONMap as t}from"../core/jsonMap.js";import r from"../core/Error.js";import{resolve as i}from"../core/promiseUtils.js";import{isGeographic as s,isWebMercator as n,WGS84 as o,isValid as a}from"../geometry/support/spatialReferenceUtils.js";import{extentContainsPoint as l,extentContainsMultipoint as p}from"../geometry/support/contains.js";import{getExtentIntersector as u}from"../geometry/support/intersects.js";import{getGeometryExtent as c}from"../geometry/support/extentUtils.js";import{fromJSON as m,isPolygon as f,isExtent as y,getJsonType as R}from"../geometry/support/jsonUtils.js";import{getUnitString as S}from"../core/unitUtils.js";import{normalizeCentralMeridian as g}from"../geometry/support/normalizeUtils.js";import h from"../layers/graphics/OptimizedGeometry.js";import{quantizeOptimizedGeometry as d,convertToPoint as j,generalizeOptimizedGeometry as w,removeZMValues as G,convertToPolyline as U,convertToPolygon as M,convertToMultipoint as P,convertFromPolygon as I}from"../layers/graphics/featureConversionUtils.js";import{getCentroidOptimizedGeometry as v}from"../layers/graphics/centroid.js";import{checkProjectionSupport as C,project as O}from"../layers/graphics/data/projectionSupport.js";import{polygonContainsPoint as q,polygonContainsMultipoint as F}from"../layers/graphics/contains.js";const E=new t({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"}),N=Object.freeze({}),_=new h,b=new h,x=new h,J={esriGeometryPoint:j,esriGeometryPolyline:U,esriGeometryPolygon:M,esriGeometryMultipoint:P};function Z(e,t,r,i=e.hasZ,s=e.hasM){const n=e.hasZ&&i,o=e.hasM&&s;if(r){const a=d(x,t,e.hasZ,e.hasM,"esriGeometryPoint",r,i,s);return j(a,n,o)}return j(t,n,o)}function z(e,t,r){return"esriGeometryPolygon"===e.geometryType&&t&&(t.centroid||t.geometry)?(t.centroid||(t.centroid=v(new h,t.geometry,e.hasZ,e.hasM)),Z(e,t.centroid,r)):null}function B(e,t,r,i,s,n,o=t,a=r){const l=t&&o,p=r&&a,u=i?"coords"in i?i:i.geometry:null;if(!u)return null;if(s){let i=w(b,u,t,r,e,s,o,a);return n&&(i=d(x,i,l,p,e,n)),J[e](i,l,p)}if(n){const i=d(x,u,t,r,e,n,o,a);return J[e](i,l,p)}return G(_,u,t,r,o,a),J[e](_,l,p)}async function T(e,t,r){const{outFields:i,orderByFields:s,groupByFieldsForStatistics:n,outStatistics:o}=e;if(i)for(let e=0;e<i.length;e++)i[e]=i[e].trim();if(s)for(let e=0;e<s.length;e++)s[e]=s[e].trim();if(n)for(let e=0;e<n.length;e++)n[e]=n[e].trim();if(o)for(let e=0;e<o.length;e++)o[e].onStatisticField&&(o[e].onStatisticField=o[e].onStatisticField.trim());return e.geometry&&!e.outSR&&(e.outSR=e.geometry.spatialReference),W(e,t,r)}async function D(e,t,r){return W(e,t,r)}async function W(t,r,i){if(!t)return null;let{where:a}=t;if(t.where=a=a&&a.trim(),(!a||/^1 *= *1$/.test(a)||r&&r===a)&&(t.where=null),!t.geometry)return t;let l=await async function(e){const{geometry:t,distance:r,units:i}=e;if(null==r||"vertexAttributes"in t)return t;const a=t.spatialReference,l=i?E.fromJSON(i):S(a),p=a&&(s(a)||n(a))?t:await C(a,o).then((()=>O(t,o)));return(await X())(p.spatialReference,p,r,l)}(t);if(t.distance=0,t.units=null,"esriSpatialRelEnvelopeIntersects"===t.spatialRel){const{spatialReference:e}=t.geometry;l=c(l),l.spatialReference=e}t.geometry=l,await C(l.spatialReference,i);const p=(await g(m(l)))[0];if(e(p))throw N;const u=p.toJSON(),f=await O(u,u.spatialReference,i);if(!f)throw N;return f.spatialReference=i,t.geometry=f,t}function k(e){return e&&A in e?JSON.parse(JSON.stringify(e,K)):e}const A="_geVersion",K=(e,t)=>e!==A?t:void 0,Q={esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"intersects",esriSpatialRelIndexIntersects:null,esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:null},V={esriSpatialRelIntersects:!0,esriSpatialRelContains:!0,esriSpatialRelWithin:!0,esriSpatialRelCrosses:!0,esriSpatialRelDisjoint:!0,esriSpatialRelTouches:!0,esriSpatialRelOverlaps:!0,esriSpatialRelEnvelopeIntersects:!0,esriSpatialRelIndexIntersects:!1,esriSpatialRelRelation:!1},$={esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!0},H={esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!1};function L(){return import("../geometry/geometryEngineJSON.js")}function X(){return L().then((e=>e.geodesicBuffer))}function Y(e,t,r,s,n){if(f(t)&&"esriGeometryPoint"===r&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e)){const e=I(new h,t,!1,!1);return i((t=>q(e,!1,!1,t)))}if(f(t)&&"esriGeometryMultipoint"===r){const r=I(new h,t,!1,!1);if("esriSpatialRelContains"===e)return i((e=>F(r,!1,!1,e,s,n)))}if(y(t)&&"esriGeometryPoint"===r&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e))return i((e=>l(t,B(r,s,n,e))));if(y(t)&&"esriGeometryMultipoint"===r&&"esriSpatialRelContains"===e)return i((e=>p(t,B(r,s,n,e))));if(y(t)&&"esriSpatialRelIntersects"===e){const e=u(r);return i((i=>e(t,B(r,s,n,i))))}return L().then((i=>{const o=i[Q[e]].bind(null,t.spatialReference,t);return e=>o(B(r,s,n,e))}))}async function ee(e,t,i){const{spatialRel:s,geometry:n}=e;if(n){if(!0!==V[s])throw new r("feature-store:unsupported-query","Unsupported query spatial relationship",{query:e});if(a(n.spatialReference)&&a(i)){if(!function(e){return!0===$[R(e)]}(n))throw new r("feature-store:unsupported-query","Unsupported query geometry type",{query:e});if(!function(e){return!0===H[e]}(t))throw new r("feature-store:unsupported-query","Unsupported layer geometry type",{query:e});if(e.outSR)return C(e.geometry&&e.geometry.spatialReference,e.outSR)}}}function te(e){if(y(e))return!0;if(f(e)){for(const t of e.rings){if(5!==t.length)return!1;if(t[0][0]!==t[1][0]||t[0][0]!==t[4][0]||t[2][0]!==t[3][0]||t[0][1]!==t[3][1]||t[0][1]!==t[4][1]||t[1][1]!==t[2][1])return!1}return!0}return!1}export{N as Q,T as a,te as b,k as c,ee as d,B as e,z as f,Y as g,D as h,L as i,X as j,W as n,Z as t};
