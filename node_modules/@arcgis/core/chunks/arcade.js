/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import e from"../core/has.js";import{all as t,create as r}from"../core/promiseUtils.js";import{M as n}from"./languageUtils.js";import{findScriptDependencies as s,findFunctionCalls as i}from"../arcade/treeAnalysis.js";import{compileScript as u,extend as c,enableAsyncSupport as o}from"../arcade/arcadeCompiler.js";import{extend as a,executeScript as f,referencesMember as p,referencesFunction as l}from"../arcade/arcadeRuntime.js";import{parseScript as m,validateScript as d,scriptCheck as y,extractFieldLiterals as S}from"../arcade/parser.js";import{loadMoment as h}from"../intl/moment.js";const j=function(){if(e("csp-restrictions"))return!1;try{return new Function("function* test() {}; return true")()}catch(e){return!1}}();let A=!1,x=!1,b=null,g=[];function F(t,r){if(!0===r.useAsync||!0===t.isAsync)return function(t,r){if(null===b)throw new Error("Async Arcade must be enabled for this script");if(e("csp-restrictions")||!1===j){return function(e){return b.executeScript(t,e)}}return u(t,r,!0)}(t,r);if(e("csp-restrictions")){return function(e){return f(t,e)}}return u(t,r)}function E(e){a(e),c(e,"sync"),null===b?g.push(e):(c(e,"async"),b.extend(e))}function v(e,t=[]){return m(e,t)}function G(e,t,r=""){return d(e,t,r)}function w(e,t,r,n=""){return y(e,t,r,n)}function U(e,t,r=[]){return M(m(e,r),t)}function M(e,t){if(!0===t.useAsync||!0===e.isAsync){if(null===b)throw new Error("Async Arcade must be enabled for this script");return b.executeScript(e,t)}return f(e,t)}function _(e,t){return p(e,t)}function k(e,t){return l(e,t)}function C(e,t=!1){return S(e)}function O(e,t=[]){return void 0===e.usesGeometry&&s(e,t),!0===e.usesGeometry}let L=null;function R(){return L||(L=t([import("../geometry/geometryEngine.js"),import("../arcade/functions/geomsync.js")]).then((([e,t])=>(x=!0,t.setGeometryEngine(e),!0))),L)}let q=null;function z(){return null!==q||(q=o().then((()=>import("../arcade/arcadeAsyncRuntime.js"))).then((e=>{b=e;for(const e of g)b.extend(e),c(e,"async");return g=null,!0}))),q}function D(){return A}function I(){return!!b}function T(){return x}let B=null;function H(){return B||(B=z().then((()=>t([import("../arcade/featureSetUtils.js"),import("../arcade/functions/featuresetbase.js"),import("../arcade/functions/featuresetgeom.js"),import("../arcade/functions/featuresetstats.js"),import("../arcade/functions/featuresetstring.js")]).then((([e,t,r,n,s])=>(Q=e,b.extend([t,r,n,s]),c([t,r,n,s],"async"),A=!0,!0))))),B)}function J(e,t=[]){return void 0===e.usesFeatureSet&&s(e,t),!0===e.usesFeatureSet}function K(e,t=[]){return void 0===e.isAsync&&s(e,t),!0===e.isAsync}function N(e,n,s=[],i=!1){return r(((r,u)=>{const c="string"==typeof e?v(e):e,o=[];o.push(W()),c&&(!1===T()&&(O(c)||i)&&o.push(R()),!1===I()&&(!0===c.isAsync||n)&&o.push(z()),!1===D()&&(J(c)||function(e,t){if(t){for(const r of t)if(_(e,r))return!0;return!1}return!1}(c,s))&&o.push(H())),o?t(o).then((()=>{r(!0)}),u):r(!0)}))}function P(e){if(O(e))return!0;const t=i(e);return t.indexOf("geometry")>-1||t.indexOf("feature")>-1}let Q=null;function V(){return Q}function W(){return null!==X||(X=h().then((e=>(n.Moment=e,!0)))),X}let X=null;var Y=Object.freeze({__proto__:null,compileScript:F,extend:E,parseScript:v,validateScript:G,scriptCheck:w,parseAndExecuteScript:U,executeScript:M,referencesMember:_,referencesFunction:k,extractFieldLiterals:C,scriptUsesGeometryEngine:O,enableGeometrySupport:R,enableAsyncSupport:z,isFeatureSetSupportEnabled:D,isAsyncEnabled:I,isGeometryEnabled:T,enableFeatureSetSupport:H,scriptUsesFeatureSet:J,scriptIsAsync:K,loadScriptDependencies:N,scriptTouchesGeometry:P,featureSetUtils:V,load:W});export{C as a,R as b,F as c,H as d,M as e,V as f,Y as g,E as h,w as i,U as j,k,N as l,z as m,D as n,I as o,v as p,T as q,_ as r,O as s,J as t,K as u,G as v,P as w,W as x};
