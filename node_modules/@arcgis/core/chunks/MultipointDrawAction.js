/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import"../core/has.js";import{isSome as t}from"../core/maybe.js";import"../core/Logger.js";import"../core/accessorSupport/ensureType.js";import{property as i}from"../core/accessorSupport/decorators/property.js";import{subclass as s}from"../core/accessorSupport/decorators/subclass.js";import"../core/urlUtils.js";import"../core/uuid.js";import"../portal/support/resourceExtension.js";import r from"../core/Handles.js";import{ViewEventPriorities as o}from"../views/input/InputManager.js";import{createScreenPointFromEvent as n}from"../views/support/screenUtils.js";import d from"../views/draw/DrawAction.js";import{VertexAddEvent as h,VertexRemoveEvent as v,VertexUpdateEvent as c,CursorUpdateEvent as p,DrawCompleteEvent as a}from"../views/draw/input/DrawEvents.js";import{KEYS as u}from"../views/draw/input/Keys.js";let l=class extends d{constructor(e){super(e),this._cursorMoved=!1,this._cursorScreenPoint=null,this._dragEnabled=!0,this._pointerDownEvent=null,this._viewHandles=new r,this.vertices=[]}initialize(){this._addViewHandles()}destroy(){this._removeViewHandles(),this._viewHandles.destroy(),this.emit("destroy")}addVertex(e,t){isNaN(t)?(t=this.vertices.length,this.vertices.push(e)):this.vertices.splice(t,0,e);const i={vertex:e,vertexIndex:t,undo:()=>this._undoVertexAdd(null,t),redo:()=>this._redoVertexAdd(null,e,t)};this.history.push(i),this._set("redoHistory",[]);const s=new h(this.view,null,t,this.vertices);this.emit("vertex-add",s),s.defaultPrevented&&(this._cursorMoved=!0,this.history.pop())}removeVertex(e){const t=this.vertices.splice(e,1)[0],i={vertex:t,vertexIndex:e,undo:()=>this._undoVertexRemove(null,t,e),redo:()=>this._redoVertexRemove(null,e)};this.history.push(i),this._set("redoHistory",[]),this.emit("vertex-remove",new v(this.view,null,e,this.vertices))}updateVertex(e,t){const i=this.vertices[t];this.vertices[t]=e;const s={vertex:e,vertexIndex:t,undo:()=>this._undoVertexUpdate(null,i,t),redo:()=>this._redoVertexUpdate(null,e,t)};this.history.push(s),this._set("redoHistory",[]),this.emit("vertex-update",new c(this.view,null,t,this.vertices))}complete(){this._completeDrawing()}_addViewHandles(){this._removeViewHandles(),this._viewHandles.add([this.view.on("click",(e=>{e.stopPropagation()}),o.TOOL),this.view.on("pointer-down",(e=>{this._cursorMoved&&this.vertices.pop(),this._pointerDownEvent=e,this._cursorMoved=!1,this._cursorScreenPoint=n(e)}),o.TOOL),this.view.on("pointer-move",(e=>{this._cursorMoved&&this.vertices.pop(),this._cursorMoved=!0,this._cursorScreenPoint=n(e),this._cursorUpdateHandler(e)}),o.TOOL),this.view.on("pointer-up",(e=>{if(this._pointerDownEvent){if(this._cursorMoved)return this.vertices.pop(),void(this._cursorMoved=!1);this._pointerDownEvent=null,this._vertexAddHandler(e)}}),o.TOOL),this.view.on("drag",(e=>{this._dragEnabled&&this._pointerDownEvent&&e.stopPropagation()}),o.TOOL),this.view.on("drag",["Shift"],(e=>{e.stopPropagation()}),o.TOOL),this.view.on("double-click",(e=>{e.stopPropagation(),this._drawCompleteHandler(e)}),o.TOOL),this.view.on("double-click",["Control"],(e=>{e.stopPropagation(),this._drawCompleteHandler(e)}),o.TOOL),this.view.on("key-down",(e=>{e.key===u.vertexAddKey&&!e.repeat&&this._cursorScreenPoint?(this._cursorMoved&&(this.vertices.pop(),this._cursorMoved=!1),this._vertexAddHandler(e)):e.key===u.drawCompleteKey&&!e.repeat&&this._cursorScreenPoint?(this._cursorMoved&&(this.vertices.pop(),this._cursorMoved=!1),this._vertexAddHandler(e),this._drawCompleteHandler(e)):e.key!==u.undoKey||this.interactiveUndoDisabled||e.repeat?e.key!==u.redoKey||this.interactiveUndoDisabled||e.repeat||(e.stopPropagation(),this.redo()):(e.stopPropagation(),this.undo())}),o.TOOL)])}_removeViewHandles(){this._viewHandles.removeAll()}_addVertex(e,t){this.vertices.push(e);const i=this.vertices.indexOf(e),s={vertex:e,vertexIndex:i,undo:()=>this._undoVertexAdd(t,i),redo:()=>this._redoVertexAdd(t,e,i)};this.history.push(s),this._set("redoHistory",[]);const r=new h(this.view,t,i,this.vertices);this.emit("vertex-add",r),r.defaultPrevented&&(this._cursorMoved=!0,this.history.pop())}_updateCursor(e,t){this.vertices.push(e);const i=this.vertices.indexOf(e),s=new p(this.view,t,i,this.vertices);this.emit("cursor-update",s)}_completeDrawing(e){if(this._cursorMoved=!1,this._pointerDownEvent=null,this.vertices.length<1)return;const t=new a(e,this.vertices);this.emit("draw-complete",t),t.defaultPrevented?this._cursorMoved=!0:this._removeViewHandles()}_undoVertexAdd(e,t){this.vertices.splice(t,1),this.emit("undo",new v(this.view,e,t,this.vertices))}_redoVertexAdd(e,t,i){this.vertices.splice(i,0,t),this.emit("redo",new h(this.view,e,i,this.vertices))}_undoVertexRemove(e,t,i){this.vertices.splice(i,0,t),this.emit("undo",new h(this.view,e,i,this.vertices))}_redoVertexRemove(e,t){this.vertices.splice(t,1),this.emit("redo",new v(this.view,e,t,this.vertices))}_undoVertexUpdate(e,t,i){this.vertices[i]=t,this.emit("undo",new c(this.view,e,i,this.vertices))}_redoVertexUpdate(e,t,i){this.vertices[i]=t,this.emit("redo",new c(this.view,e,i,this.vertices))}_vertexAddHandler(e){const i=this.getCoordsFromScreenPoint(this._cursorScreenPoint);t(i)&&this._addVertex(i,e.native)}_cursorUpdateHandler(e){const i=this.getCoordsFromScreenPoint(this._cursorScreenPoint);t(i)&&this._updateCursor(i,e.native)}_drawCompleteHandler(e){this._completeDrawing(e.native)}};e([i({readOnly:!0})],l.prototype,"vertices",void 0),l=e([s("esri.views.draw.MultipointDrawAction")],l);var _=Object.freeze({__proto__:null,get MultipointDrawAction(){return l}});export{l as M,_ as a};
