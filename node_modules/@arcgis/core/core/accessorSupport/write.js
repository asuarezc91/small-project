/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import r from"../Logger.js";import{getProperties as e,merge as t}from"./utils.js";import{originSpecificWritePropertyDefinition as i}from"./extensions/serializableProperty.js";import o from"../Error.js";import{idToReadableName as n,nameToId as s}from"./PropertyOrigin.js";import{equals as u}from"../arrayUtils.js";import{all as l}from"../promiseUtils.js";const a=r.getLogger("esri.core.accessorSupport.write");function f(r,e,t,i,o){var n,s;const u={};return null==(n=e.write)||null==(s=n.writer)||s.call(r,i,u,t,o),u}function c(r,e,t,i,n,l){if(!i||!i.write)return!1;const f=r.get(t);if(!n&&i.write.overridePolicy){const e=i.write.overridePolicy.call(r,f,t,l);void 0!==e&&(n=e)}if(n||(n=i.write),!n||!1===n.enabled)return!1;if((null===f&&!n.allowNull||void 0===f)&&n.isRequired){const e=new o("web-document-write:property-required",`Missing value for required property '${t}' on '${r.declaredClass}'`,{propertyName:t,target:r});return e&&l&&l.messages?l.messages.push(e):e&&!l&&a.error(e.name,e.message),!1}if(void 0===f)return!1;if(null===f&&!n.allowNull)return!1;if(function(r,e,t,i,o){const n=i.default;if(void 0===n)return!1;if(null!=i.defaultEquals)return i.defaultEquals(o);if("function"==typeof n){if(Array.isArray(o)){const i=n.call(r,e,t);return u(i,o)}return!1}return n===o}(r,t,l,i,f))return!1;if(void 0!==i.default)return!0;if(!n.ignoreOrigin&&l&&l.origin){if(e.store.originOf(t)<s(l.origin))return!1}return!0}function p(r,t,o,n){const s=e(r),u=s.metadatas,l=i(u[t],n);return!!l&&c(r,s,t,l,o,n)}function g(r,o,s){if(r&&"function"==typeof r.toJSON&&(!r.toJSON.isDefaultToJSON||!r.write))return t(o,r.toJSON());const u=e(r),a=u.metadatas;for(const e in a){const p=i(a[e],s);if(!c(r,u,e,p,void 0,s))continue;const g=r.get(e),d=f(r,p,p.write&&"string"==typeof p.write.target?p.write.target:e,g,s);Object.keys(d).length>0&&(o=t(o,d),s&&s.resources&&s.resources.pendingOperations&&s.resources.pendingOperations.length&&l(s.resources.pendingOperations).then((()=>t(o,d))),s&&s.writtenProperties&&s.writtenProperties.push({target:r,propName:e,oldOrigin:n(u.store.originOf(e)),newOrigin:s.origin}))}return o}export default g;export{p as willPropertyWrite,g as write};
