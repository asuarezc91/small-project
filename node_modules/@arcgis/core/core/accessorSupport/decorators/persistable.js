/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as t,isNone as r,get as e}from"../../maybe.js";import{getOwnPropertyMetadata as o}from"../metadata.js";import{propertyJSONMeta as i}from"./property.js";import{isMultiOriginJSONMixin as n}from"../../multiOriginJSONSupportUtils.js";import{isAbsolute as s,isBlobProtocol as u,join as p,getPathExtension as a}from"../../urlUtils.js";import{generateUUID as c}from"../../uuid.js";import{nameToId as l}from"../PropertyOrigin.js";import{getResourceContentExtension as f}from"../../../portal/support/resourceExtension.js";import{r as m,t as y,i as h,p as d}from"../../../chunks/persistableUrlUtils.js";function g(e){const p=t(e)&&e.origins?e.origins:[void 0];return(c,g)=>{const j=function(e,i,p){if(t(e)&&"resource"===e.type)return function(e,i,p){const c=o(i,p);return{type:String,read:(t,r,e)=>{const o=m(t,r,e);return c.type===String?o:"function"==typeof c.type?new c.type({url:o}):void 0},write:{writer(o,i,m,d){if(!d||!d.resources)return"string"==typeof o?void(i[m]=y(o,d)):void(i[m]=o.write({},d));const g=function(t){if(r(t))return null;if("string"==typeof t)return t;return t.url}(o),j=g?y(g,{...d,verifyItemRelativeUrls:d&&d.verifyItemRelativeUrls?{writtenUrls:d.verifyItemRelativeUrls.writtenUrls,rootPath:null}:null}):null,I=c.type!==String&&(!n(this)||d&&d.origin&&this.originIdOf(p)>l(d.origin));d&&d.portalItem&&t(j)&&!s(j)?I?function(t,r,e,o,i,n,s,u){const p=s.portalItem.resourceFromPath(o),c=U(e,o,s),l=f(c),m=a(p.path);if(l!==m)return void v(t,r,e,o,i,n,s,u);w(t,r,p,c,s.resources.toUpdate),i[n]=o}(this,p,o,j,i,m,d,e):function(t,r,e,o){o.resources.toKeep.push({resource:o.portalItem.resourceFromPath(t)}),r[e]=t}(j,i,m,d):d&&d.portalItem&&(r(j)||t(h(j))||u(j)||I)?v(this,p,o,j,i,m,d,e):i[m]=j}}}}(e,i,p);switch(t(e)&&e.type?e.type:"other"){case"other":return{read:!0,write:!0};case"url":{const{read:t,write:r}=d;return{read:t,write:r}}}}(e,c,g);for(const t of p){const r=i(c,t,g);for(const t in j)r[t]=j[t]}}}function v(t,r,o,i,n,s,a,l){const m=c(),y=U(o,i,a),h=p(e(l,"prefix"),m),d=`${h}.${f(y)}`,g=a.portalItem.resourceFromPath(d);u(i)&&a.resources.pendingOperations.push(async function(t){const r=(await import("../../../request.js")).default,{data:e}=await r(t,{responseType:"blob"});return e}(i).then((t=>{g.path=`${h}.${f(t)}`,n[s]=g.itemRelativeUrl})).catch((()=>{}))),w(t,r,g,y,a.resources.toAdd),n[s]=g.itemRelativeUrl}function w(t,r,e,o,i){i.push({resource:e,content:o,finish:e=>{!function(t,r,e){"string"==typeof t[r]?t[r]=e.url:t[r].url=e.url}(t,r,e)}})}function U(t,r,e){return"string"==typeof t?{url:r}:new Blob([JSON.stringify(t.toJSON(e))],{type:"application/json"})}export{g as persistable};
