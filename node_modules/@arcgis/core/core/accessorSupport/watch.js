/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{equals as e}from"../lang.js";import{pathToStringOrArray as t,parse as o,once as r}from"./utils.js";import{valueOf as l}from"./get.js";import n from"../ArrayPool.js";import{ReentrantObjectPool as s}from"../ReentrantObjectPool.js";import{schedule as i}from"../scheduling.js";import{wireAsync as u,wire as c}from"./wire.js";class a{constructor(){this.uid=0,this.target=null,this.path=null,this.oldValue=null,this.callback=null,this.getValue=null,this.removed=!1,this.propertyPath=null}acquire(e,o,r,l,n){this.target=e,this.path=o,this.oldValue=r,this.callback=l,this.getValue=n,this.propertyPath=t(o),this.uid=++a.uid,this.removed=!1}release(){this.target=this.path=this.propertyPath=this.callback=this.oldValue=null,this.uid=++a.uid,this.removed=!0}}a.pool=new s(a),a.uid=0;const d=new n,h=new Set;let f,m=d.acquire();function p(e){h.has(e)?m.splice(m.indexOf(e),1):h.add(e),m.push(e),f||(f=i(j))}function g(e){if(e.removed)return;const{callback:t,path:o,oldValue:r,target:l}=e,n=e.getValue();_(r,n)&&(e.oldValue=n,t.call(l,n,r,o,l))}function _(t,o){return!e(t,o)}function v(e){const t=d.copy(m);for(let o=0;o<t.length;o++){const r=t[o];r.target===e&&(g(r),h.delete(r),m.splice(m.indexOf(r),1))}}function V(e){for(let t=0;t<m.length;t++){const o=m[t];o.target===e&&(o.removed=!0)}}function j(){let e=10;for(;f&&e--;){f=null;const e=m;m=d.acquire(),h.clear();const t=d.acquire();for(const o of e){const e=o.uid;g(o),e===o.uid&&o.removed&&t.push(o)}for(let e=0;e<m.length;e++){const o=m[e];o.removed&&(t.push(o),h.delete(o),m.splice(e,1),e-=1)}for(let e=0;e<t.length;e++)a.pool.release(t[e]);d.release(e),d.release(t),y.forEach((e=>e()))}}const y=new Set;function b(e){return y.add(e),{remove(){y.delete(e)}}}function q(e,t,n,s=!1){return!e.__accessor__||e.__accessor__.destroyed?{remove(){}}:s?function(e,t,r){const n=o(e,t,r,((e,t,o)=>{let r=!1;return c((()=>l(e,t)),((l,s)=>{e.__accessor__.destroyed?n.remove():r||(r=!0,_(l,s)&&o.call(e,s,l,t,e),r=!1)}))}));return n}(e,t,n):function(e,t,n){let s=o(e,t,n,((e,t,o)=>{let n,i,c=u((()=>l(e,t)),((r,l)=>{e.__accessor__.destroyed||n&&n.uid!==i?s.remove():(n||(n=a.pool.acquire(e,t,r,o,l),i=n.uid),p(n))}));return{remove:r((function(){c.remove(),n&&(n.uid!==i||n.removed||(n.removed=!0,p(n)),n=null),s=c=null}))}}));return s}(e,t,n)}function w(e){return m.some((t=>t.oldValue===e))}export default q;export{b as afterDispatch,j as dispatch,v as dispatchTarget,w as isValueInUse,V as removeTarget,q as watch};
