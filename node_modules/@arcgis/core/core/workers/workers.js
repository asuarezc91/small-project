/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import t from"../has.js";import r from"../Error.js";import{throwIfAborted as e,createAbortController as n,all as o}from"../promiseUtils.js";import i from"./RemoteClient.js";export{default as RemoteClient}from"./RemoteClient.js";import s from"./Connection.js";export{default as Connection}from"./Connection.js";import a from"./WorkerOwner.js";let c=t("esri-workers-debug")?1:t("host-browser")?navigator.hardwareConcurrency-1:0;c||(c=t("safari")&&t("mac")||t("trident")?7:2);let l=0;const m=[];function f(){k()}function u(t,r){return p(t,{client:r})}async function p(t,r){const e=new s;return await e.open(t,r),e}async function w(n,o={}){if("string"!=typeof n)throw new r("workers:undefined-module","modulePath is missing");let s=o.strategy||"distributed";if(t("host-webworker")&&!t("esri-workers")&&(s="local"),"local"===s){let t=await i.loadWorker(n);t||(t=await import(n)),e(o.signal);const r=o.client||t;return p([i.connect(t)],{...o,client:r})}if(await k(),e(o.signal),"dedicated"===s){const t=l++%c;return p([await m[t].open(n,o)],o)}if(o.maxNumWorkers&&o.maxNumWorkers>0){const t=Math.min(o.maxNumWorkers,c);if(t<c){const r=new Array(t);for(let e=0;e<t;++e){const t=l++%c;r[e]=m[t].open(n,o)}return p(r,o)}}return p(m.map((t=>t.open(n,o))),o)}function d(){g&&(h.abort(),g=null);for(let t=0;t<m.length;t++)m[t]&&m[t].terminate();m.length=0}let h,g=null;async function k(){if(g)return g;h=n();const t=[];for(let r=0;r<c;r++){const e=a.create(r).then((t=>(m[r]=t,t)));t.push(e)}return g=o(t),g}export{f as initialize,w as open,u as openWithPorts,d as terminate};
