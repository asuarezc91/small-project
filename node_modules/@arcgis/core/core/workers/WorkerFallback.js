/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import e from"../global.js";import{MessageType as t,receiveMessage as s}from"./utils.js";import r from"./RemoteClient.js";class n{constructor(){const e=document.createDocumentFragment();["addEventListener","dispatchEvent","removeEventListener"].forEach((t=>{this[t]=(...s)=>e[t](...s)}))}}const a=e.MutationObserver||e.WebKitMutationObserver,o=function(){let t;if(e.process&&e.process.nextTick)t=t=>{e.process.nextTick(t)};else if(e.Promise)t=t=>{e.Promise.resolve().then(t)};else if(a){const e=[],s=document.createElement("div");new a((()=>{for(;e.length>0;)e.shift()()})).observe(s,{attributes:!0}),t=t=>{e.push(t),s.setAttribute("queueStatus","1")}}return t}(),i=(()=>{const t=e.MessageEvent;try{new t("message",{data:null})}catch{return(e,t={})=>{const{data:s,bubbles:r=!1,cancelable:n=!1}=t,a=document.createEvent("Event");return a.initEvent(e,r,n),a.data=s,a}}return(e,s)=>new t(e,s)})();export default class{constructor(){this._dispatcher=new n,this._isInitialized=!1,this._workerPostMessage({type:t.HANDSHAKE})}terminate(){}get onmessage(){return this._onmessageHandler}set onmessage(e){this._onmessageHandler&&this.removeEventListener("message",this._onmessageHandler),this._onmessageHandler=e,e&&this.addEventListener("message",e)}get onmessageerror(){return this._onmessageerrorHandler}set onmessageerror(e){this._onmessageerrorHandler&&this.removeEventListener("messageerror",this._onmessageerrorHandler),this._onmessageerrorHandler=e,e&&this.addEventListener("messageerror",e)}get onerror(){return this._onerrorHandler}set onerror(e){this._onerrorHandler&&this.removeEventListener("error",this._onerrorHandler),this._onerrorHandler=e,e&&this.addEventListener("error",e)}postMessage(e){o((()=>{this._workerMessageHandler(i("message",{data:e}))}))}dispatchEvent(e){return this._dispatcher.dispatchEvent(e)}addEventListener(e,t,s){this._dispatcher.addEventListener(e,t,s)}removeEventListener(e,t,s){this._dispatcher.removeEventListener(e,t,s)}_workerPostMessage(e){o((()=>{this.dispatchEvent(i("message",{data:e}))}))}async _workerMessageHandler(e){const n=s(e);if(n)switch(n.type){case t.CONFIGURE:this._isInitialized||this._workerPostMessage({type:t.CONFIGURED});break;case t.OPEN:{const{modulePath:e,jobId:s}=n;let a=await r.loadWorker(e);a||(a=await import(e));const o=r.connect(a);this._workerPostMessage({type:t.OPENED,jobId:s,data:o});break}}}}
