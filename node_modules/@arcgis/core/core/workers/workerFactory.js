/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import e from"../has.js";import r from"../../config.js";import t from"../Logger.js";import{makeAbsolute as o}from"../urlUtils.js";import{create as s}from"../promiseUtils.js";import{getLocale as a}from"../../intl/locale.js";import{getAssetUrl as n}from"../../assets.js";import"../../intl.js";import{receiveMessage as i,MessageType as l}from"./utils.js";import f from"./loaderConfig.js";import c from"./WorkerFallback.js";const d=t.getLogger("esri.core.workers");e.add("esri-workers-arraybuffer-transfer",!e("safari")||e("safari")>=12);const{CONFIGURED:u,CONFIGURE:g,HANDSHAKE:m}=l;let p;try{p=URL.createObjectURL(new Blob(['var esriConfig,workerPath,globalId=0,outgoing=new Map,configured=!1,HANDSHAKE=0,CONFIGURE=1,CONFIGURED=2,OPEN=3,OPENED=4,RESPONSE=5,INVOKE=6,ABORT=7;function createAbortError(){var e=new Error("Aborted");return e.name="AbortError",e}function receiveMessage(e){return e&&e.data?"string"==typeof e.data?JSON.parse(e.data):e.data:null}function invokeStaticMessage(e,r,t){var o=t&&t.signal,n=globalId++;return new Promise((function(t,a){if(o){if(o.aborted)return a(createAbortError());o.addEventListener("abort",(function(){outgoing.get(n)&&(outgoing.delete(n),self.postMessage({type:ABORT,jobId:n}),a(createAbortError()))}))}outgoing.set(n,{resolve:t,reject:a}),self.postMessage({type:INVOKE,jobId:n,methodName:e,abortable:null!=o,data:r})}))}function messageHandler(e){var r=receiveMessage(e);if(r){var t=r.jobId;switch(r.type){case CONFIGURE:var o=r.configure;if(configured)return;configured=!0,esriConfig=o.esriConfig,workerPath=esriConfig.workers.workerPath,self.dojoConfig=o.loaderConfig,esriConfig.workers.loaderUrl&&(self.importScripts(esriConfig.workers.loaderUrl),"function"==typeof require&&"function"==typeof require.config&&require.config(o.loaderConfig)),self.postMessage({type:CONFIGURED});break;case OPEN:var n;function a(e){var r=n.connect(e);self.postMessage({type:OPENED,jobId:t,data:r},[r])}"function"==typeof define&&define.amd?require([workerPath],(function(e){(n=e.default||e).loadWorker(r.modulePath).then((function(e){return e||new Promise((function(e){require([r.modulePath],e)}))})).then(a)})):"System"in self&&"function"==typeof System.import?System.import(workerPath).then((function(e){return(n=e.default).loadWorker(r.modulePath)})).then((function(e){return e||System.import(r.modulePath)})).then(a):(self.RemoteClient||importScripts(workerPath),(n=self.RemoteClient.default||self.RemoteClient).loadWorker(r.modulePath).then(a));break;case RESPONSE:if(outgoing.has(t)){var i=outgoing.get(t);outgoing.delete(t),r.error?i.reject(JSON.parse(r.error)):i.resolve(r.data)}}}}self.addEventListener("message",messageHandler),self.postMessage({type:HANDSHAKE});'],{type:"text/javascript"}))}catch(e){}const w="Failed to create Worker. Fallback to execute module in main thread";async function k(){if(!e("esri-workers"))return h(new c);let r;if(p)try{r=new Worker(p)}catch(e){d.warn(w,event),r=new c}else d.warn(w,event),r=new c;return h(r)}async function h(t){return s((s=>{function l(c){const d=i(c);if(d)switch(d.type){case m:!function(t){let s;if(null!=r.default){const e={...r};delete e.default,s=JSON.parse(JSON.stringify(e))}else s=JSON.parse(JSON.stringify(r));s.assetsPath=o(s.assetsPath),s.locale=a(),s.has={"csp-restrictions":e("csp-restrictions"),"esri-2d-debug":!1,"esri-2d-update-debug":e("esri-2d-update-debug"),"esri-atomics":e("esri-atomics"),"esri-secure-context":e("esri-secure-context"),"esri-shared-array-buffer":e("esri-shared-array-buffer"),"esri-tiles-debug":e("esri-tiles-debug"),"esri-workers-arraybuffer-transfer":e("esri-workers-arraybuffer-transfer"),"host-webworker":1},s.workers.loaderUrl&&(s.workers.loaderUrl=o(s.workers.loaderUrl));s.workers.workerPath?s.workers.workerPath=o(s.workers.workerPath):s.workers.workerPath=o(n("esri/core/workers/RemoteClient.js"));const i=r.workers.loaderConfig,l=f({baseUrl:null==i?void 0:i.baseUrl,locale:a(),has:{"csp-restrictions":e("csp-restrictions"),"dojo-test-sniff":0,"host-webworker":1,...null==i?void 0:i.has},map:{...null==i?void 0:i.map},paths:{...null==i?void 0:i.paths},packages:(null==i?void 0:i.packages)||[]});t.postMessage({type:g,configure:{esriConfig:s,loaderConfig:l}})}(t);break;case u:t.removeEventListener("message",l),t.removeEventListener("error",p),s(t)}}function p(e){e.preventDefault(),t.removeEventListener("message",l),t.removeEventListener("error",p),d.warn("Failed to create Worker. Fallback to execute module in main thread",e),(t=new c).addEventListener("message",l),t.addEventListener("error",p)}t.addEventListener("message",l),t.addEventListener("error",p)}))}export{k as createWorker};
