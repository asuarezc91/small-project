/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{removeMaybe as e,isSome as s}from"../maybe.js";import t from"../Error.js";import{on as o}from"../events.js";import{resolve as n,reject as r,create as i,onAbortOrThrow as a,createAbortError as l,createAbortController as h,isPromiseLike as c,isAbortError as _}from"../promiseUtils.js";import{registry as p}from"./registry.js";import{newJobId as u,MessageType as d,receiveMessage as g,toInvokeError as m,postMessage as b}from"./utils.js";import{Task as f}from"../../views/support/Scheduler.js";const{CLOSE:v,ABORT:M,INVOKE:k,RESPONSE:y,OPEN_PORT:j,ON:I}=d;class w{constructor(e){this._timer=null,this._cancelledJobIds=new Set,this._invokeMessages=[],this._invoke=e,this._timer=null,this._process=this._process.bind(this)}push(e){e.type===d.ABORT?this._cancelledJobIds.add(e.jobId):(this._invokeMessages.push(e),null===this._timer&&(this._timer=setTimeout(this._process,0)))}clear(){this._invokeMessages.length=0,this._cancelledJobIds.clear(),this._timer=null}_process(){this._timer=null;for(const e of this._invokeMessages)this._cancelledJobIds.has(e.jobId)||this._invoke(e);this._cancelledJobIds.clear(),this._invokeMessages.length=0}}class J{constructor(e,s){this._port=e,this._outJobs=new Map,this._inJobs=new Map,this._invokeQueue=new w((e=>this._onInvokeMessage(e))),this._messageQueue=new Array,this._client=s.client,this._onMessage=this._onMessage.bind(this),this._channel=s.channel,s.scheduler&&(this._frameTask=s.scheduler.registerTask(f.REMOTE_CLIENT,(e=>this._update(e)),(()=>this._messageQueue.length>0))),this._port.addEventListener("message",this._onMessage),this._port.start()}static connect(e){const s=new MessageChannel;let t;t="function"==typeof e?new e:"default"in e&&"function"==typeof e.default?new e.default:e;const o=new J(s.port1,{channel:s,client:t});return"object"==typeof t&&"remoteClient"in t&&(t.remoteClient=o),J.clients.set(o,t),s.port2}static loadWorker(e){const s=p[e];return s?s():n(null)}close(){this._post({type:v}),this._close()}isBusy(){return this._outJobs.size>0}invoke(e,s,o){const n=o&&o.signal,h=o&&o.transferList;if(!this._port)return r(new t("worker:port-closed",`Cannot call invoke('${e}'), port is closed`,{methodName:e,data:s}));const c=u();return i(((t,o)=>{const r=a(n,(()=>{var e;const s=this._outJobs.get(c);s&&(this._outJobs.delete(c),null==(e=s.abortHandle)||e.remove(),this._post({type:M,jobId:c}),o(l()))})),i={resolve:t,reject:o,abortHandle:r,debugInfo:e};this._outJobs.set(c,i),this._post({type:k,jobId:c,methodName:e,abortable:null!=n},s,h)}))}on(e,s){const t=new MessageChannel;function o(e){s(e.data)}return this._port.postMessage({type:d.ON,eventType:e,port:t.port2},[t.port2]),t.port1.addEventListener("message",o),t.port1.start(),{remove(){t.port1.postMessage({type:d.CLOSE}),t.port1.close(),t.port1.removeEventListener("message",o)}}}openPort(){const e=new MessageChannel;return this._post({type:j,port:e.port2}),e.port1}_close(){this._channel&&(this._channel=null),this._port.removeEventListener("message",this._onMessage),this._port.close(),this._outJobs.forEach((e=>{var s;null==(s=e.abortHandle)||s.remove(),e.reject(l(`Worker closing, aborting job calling '${e.debugInfo}'`))})),this._inJobs.clear(),this._outJobs.clear(),this._invokeQueue.clear(),this._port=this._client=null,this._frameTask=e(this._frameTask)}_onMessage(e){s(this._frameTask)?this._messageQueue.push(e):this._processMessage(e)}_processMessage(e){const s=g(e);if(s)switch(s.type){case y:this._onResponseMessage(s);break;case k:this._invokeQueue.push(s);break;case M:this._onAbortMessage(s);break;case v:this._onCloseMessage();break;case j:this._onOpenPortMessage(s);break;case I:this._onOnMessage(s)}}_onAbortMessage(e){const s=this._inJobs,t=e.jobId,o=s.get(t);this._invokeQueue.push(e),o&&(o.controller&&o.controller.abort(),s.delete(t))}_onCloseMessage(){const e=this._client;this._close(),e&&"destroy"in e&&J.clients.get(this)===e&&e.destroy(),J.clients.delete(this),e&&e.remoteClient&&(e.remoteClient=null)}_onInvokeMessage(e){const{methodName:s,jobId:t,data:o,abortable:n}=e,r=n?h():null,i=this._inJobs;let a,l=this._client,p=l[s];try{if(!p&&s&&-1!==s.indexOf(".")){const e=s.split(".");for(let s=0;s<e.length-1;s++)l=l[e[s]],p=l[e[s+1]]}if("function"!=typeof p)throw new TypeError(`${s} is not a function`);a=p.call(l,o,{client:this,signal:r?r.signal:null})}catch(e){return void this._post({type:y,jobId:t,error:m(e)})}c(a)?(i.set(t,{controller:r,promise:a}),a.then((e=>{i.has(t)&&(i.delete(t),this._post({type:y,jobId:t},e))}),(e=>{i.has(t)&&(i.delete(t),_(e)||this._post({type:y,jobId:t,error:m(e||{message:`Error encountered at method ${s}`})}))}))):this._post({type:y,jobId:t},a)}_onOpenPortMessage(e){new J(e.port,{client:this._client})}_onOnMessage(e){const{port:s}=e,t=this._client.on(e.eventType,(e=>{s.postMessage(e)})),n=o(e.port,"message",(e=>{g(e).type===d.CLOSE&&(n.remove(),t.remove(),s.close())}))}_onResponseMessage(e){var s;const{jobId:o,error:n,data:r}=e,i=this._outJobs;if(!i.has(o))return;const a=i.get(o);i.delete(o),null==(s=a.abortHandle)||s.remove(),n?a.reject(t.fromJSON(JSON.parse(n))):a.resolve(r)}_update(e){for(;!e.done&&this._messageQueue.length>0;)this._processMessage(this._messageQueue.shift()),e.madeProgress()}_post(e,s,t){return b(this._port,e,s,t)}}J.clients=new Map;export default J;
