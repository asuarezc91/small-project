/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as t,isNone as n,removeMaybe as r,assumeNonNull as e}from"./maybe.js";import o from"./Logger.js";import i from"./Error.js";import u from"./clock.js";import{once as c}from"./events.js";const s=o.getLogger("esri");function f(t){return Promise.all(t)}function l(t,n){const r=t.slice();return f(t.map(((t,r)=>n(t,r)))).then((t=>r.filter(((n,r)=>t[r]))))}function h(t){return new Promise(((n,r)=>{try{t(n,r)}catch(t){Promise.resolve().then((()=>r(t)))}}))}function m(t="Aborted"){return new i("AbortError",t)}function a(){return new AbortController}function p(t){if(j(t))throw m()}function b(n){return t(n)?"aborted"in n?n:n.signal:n}function j(n){const r=b(n);return t(r)&&r.aborted}function w(t){if(T(t))throw t}function v(t){if(!T(t))throw t}function d(t,r){const e=b(t);if(!n(e)){if(!e.aborted)return c(e,"abort",(()=>r()));r()}}function g(t,r){const e=b(t);if(!n(e))return p(e),c(e,"abort",(()=>r(m())))}function y(t,e){const o=b(e);return n(o)?t:h(((n,o)=>{let i=d(e,(()=>o(m())));const u=()=>i=r(i);t.then(u,u),t.then(n,o)}))}function T(t){return t&&"AbortError"===t.name}function E(t){return t.catch((t=>{if(!T(t))throw t}))}function P(t,n=s){return t.catch((t=>{T(t)||n.error(t)}))}function A(){let t=null;const n=h(((n,r)=>{t={promise:void 0,resolve:n,reject:r}}));return t.promise=n,t}function k(t,n){if(!t)return;if("function"!=typeof t.forEach){const n=Object.keys(t);return k(n.map((n=>t[n]))).then((t=>{const r={};return n.forEach(((n,e)=>r[n]=t[e])),r}))}const r=t,e=U;return y(h((t=>{const n=[];let o=r.length;0===o&&t(n),r.forEach((r=>{const i={promise:r||e(r)};n.push(i),i.promise.then((t=>{i.value=t})).catch((t=>{i.error=t})).then((()=>{--o,0===o&&t(n)}))}))})),n)}function L(t){return t&&"function"==typeof t.then}function x(t){return k(t).then((t=>t.filter((t=>!!t.value)).map((t=>t.value))))}function C(t){return t&&t.length?h(((n,r)=>{for(const e of t)e.then(n,r)})):U()}function O(t){return Promise.reject(t)}function U(t){return Promise.resolve(t)}function q(t,n,r){const e=a();return d(r,(()=>e.abort())),h(((r,o)=>{let i=setTimeout((()=>{i=0,r(n)}),t);d(e,(()=>{i&&(clearTimeout(i),o(m()))}))}))}function z(t,n,r,e){const o=r&&"abort"in r?r:null;null!=e||o||(e=r);let u=setTimeout((()=>{u=0,o&&o.abort()}),n);const c=()=>{throw e||new i("promiseUtils:timeout","The wrapped promise did not resolve within "+n+" ms")};return t.then((t=>{if(0===u)throw c();return clearTimeout(u),t}),(t=>{throw clearTimeout(u),0===u?c():t}))}function B(t){return t&&"function"==typeof t.then}function D(t){return t&&"object"==typeof t&&"then"in t&&"function"==typeof t.then?t:U(t)}function F(t,n=-1){let r,o,i,u,c=null;const s=(...f)=>{if(r){o=f,u&&u.reject(m()),u=A();const t=e(u.promise);if(c){const t=c;c=null,t.abort()}return t}if(i=u||A(),u=null,n>0){const e=a();r=D(t(...f,e.signal));const o=r;q(n).then((()=>{r===o&&(u?e.abort():c=e)}))}else r=1,r=D(t(...f));const l=()=>{const t=o;o=i=r=c=null,null!=t&&s(...t)},h=r,p=i;return h.then(l,l),h.then(p.resolve,p.reject),e(p.promise)};return s}function G(){let t,n;const r=h(((r,e)=>{t=r,n=e})),e=n=>{t(n)};return e.resolve=n=>t(n),e.reject=t=>n(t),e.timeout=(t,n)=>u.setTimeout((()=>e.reject(n)),t),e.promise=r,e}function H(t,n){return t.then(n,n)}function I(t){let n=a();const r=t(n.signal);let e={promise:r,finished:!1,abort:()=>{n&&(n.abort(),n=null)}};const o=()=>{e&&(e.finished=!0,e=null),n=null};return r.then(o,o),e}export{q as after,f as all,H as always,h as create,a as createAbortController,m as createAbortError,A as createDeferred,G as createResolver,I as createTask,F as debounce,k as eachAlways,x as eachAlwaysValues,l as filter,C as first,E as ignoreAbortErrors,T as isAbortError,j as isAborted,B as isPromiseLike,L as isThenable,P as logOnError,d as onAbort,g as onAbortOrThrow,O as reject,U as resolve,w as throwIfAbortError,p as throwIfAborted,v as throwIfNotAbortError,z as timeout,D as when,y as whenOrAbort};
