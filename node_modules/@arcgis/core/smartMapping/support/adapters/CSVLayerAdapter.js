/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../core/has.js";import"../../../core/Logger.js";import"../../../core/accessorSupport/ensureType.js";import"../../../core/accessorSupport/decorators/property.js";import{subclass as r}from"../../../core/accessorSupport/decorators/subclass.js";import t from"../../../core/Error.js";import"../../../core/urlUtils.js";import"../../../core/uuid.js";import"../../../portal/support/resourceExtension.js";import{resolve as s}from"../../../core/promiseUtils.js";import{createGenerateRendererClassBreaks as i,createGenerateRendererUniqueValues as o}from"../../../tasks/support/generateRendererUtils.js";import{getFieldsList as a}from"../utils.js";import{mergeWhereClauses as n}from"../../statistics/support/utils.js";import{calculateStatsFromMemory as l,getDataValues as p,isValidNumber as u}from"./support/utils.js";import c from"./FeatureLayerAdapter.js";function m(e){return"esri.tasks.support.ClassBreaksDefinition"===e.declaredClass}function d(e){return"esri.tasks.support.UniqueValueDefinition"===e.declaredClass}let f=class extends c{constructor(e){super(e)}async _createGenerateRendererResult(e,r,s,a,n){const c=e&&e.features;if(!(c&&c.length))throw new t("csv-layer-adapter:insufficient-data","No features are available to calculate statistics");let f=null;if("percent-of-total"===a){if(f=(await l({field:r},c)).sum,null==f)throw new t("csv-layer-adapter:invalid","invalid normalizationTotal")}if(m(n)){const e=(await p({field:r,normalizationType:a,normalizationField:s,normalizationTotal:f},c)).filter((e=>null!=e&&u(e)));return i({definition:n,values:e,normalizationTotal:f})}if(d(n)){const e=(await p({field:r},c)).filter((e=>null!=e&&"string"==typeof e&&""!==e.trim()));return o(e)}}generateRenderer(e,r){const t=e.classificationDefinition;let s=null,i=null,o=null;m(t)?(s=t.classificationField,i=t.normalizationField,o=t.normalizationType):d(t)&&(s=t.attributeField);const l=this.layer;return a({field:s,normalizationField:i}).then((a=>{const p=l.createQuery();return p.returnGeometry=!1,p.outFields=a,p.where=n(p.where,e.where),l.queryFeatures(p,{signal:r}).then((e=>this._createGenerateRendererResult(e,s,i,o,t)))}))}load(e){const r=this.layer.load(e).then((e=>{this.geometryType=e.geometryType,this.objectIdField=e.objectIdField,this.supportsSQLExpression=!0,this._hasLocalSource=!1,this.hasQueryEngine=!0}));return this.addResolvingPromise(r),s(this)}};f=e([r("esri.smartMapping.support.adapters.CSVLayerAdapter")],f);var h=f;export default h;
