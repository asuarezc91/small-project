/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{loadArcade as e}from"../../../support/arcadeOnDemand.js";import{isValidNumber as t}from"../../support/adapters/support/utils.js";function n(e,n=!0,s=!0){return t(e)&&(n||0!==e)&&(s||e>=0)}async function s(t){const{features:s,attributes:i,includeZeros:o,includeNegatives:c,view:l}=t;let a=0,r=0,u=1/0,f=-1/0,p=null;const d=new Map;for(let t=0;t<i.length;t++){const{valueExpression:n}=i[t];if(n){if(!p){const{arcadeUtils:t}=await e();p=t}d.set(t,p.createFunction(n))}}const g=l&&p&&p.getViewInfo({viewingMode:"2d"===l.type?"map":l.viewingMode,scale:l.scale,spatialReference:l.spatialReference});for(const e of s){const t=e.geometry,s=e.attributes;if(t){const l=t.extent;if(l){const t=l.width*l.height;if(t>0){let l=0;const m=p&&p.createExecContext(e,g);for(let e=0;e<i.length;e++){const{field:t,valueExpression:a}=i[e];let r=null;if(t)r=s[t];else if(a){const t=d.get(e);r=p.executeFunction(t,m)}n(r,o,c)&&(l+=r||0)}if(n(l,o,c)){const e=l/t;++a,r+=e,e<u&&(u=e),e>f&&(f=e)}}}}}return{minDensity:u!==1/0?u:null,maxDensity:f!==-1/0?f:null,avgDensity:a?r/a:null}}export default s;
