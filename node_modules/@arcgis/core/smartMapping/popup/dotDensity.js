/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import e from"../../core/Error.js";import{all as t}from"../../core/promiseUtils.js";import n from"../../popup/FieldInfo.js";import i from"../../popup/ExpressionInfo.js";import o from"../../PopupTemplate.js";import{fetchMessageBundle as s}from"../../intl/messages.js";import{getArcadeForOrderedFields as r,getArcadeForPredominantCategoryAlias as a}from"../statistics/support/predominanceUtils.js";import{getContentFromFieldInfos as f,getFieldAndExpressionInfos as d,expressionFieldPrefix as p}from"./support/utils.js";async function l(t){const{layer:n,renderer:i}=t;await n.load();const o=i||n.renderer;if("dot-density"!==o.type)throw new e("dot-density-popup:invalid-parameters","renderer.type must be 'dot-density'");return{layer:n,renderer:o}}async function m(e,t){const{fieldInfos:n,expressionInfos:i}=await d({renderer:e,layer:t});return new o({content:await f(t,{fieldInfos:n,expressionInfos:i}),expressionInfos:i,fieldInfos:n})}async function c(e,t,s){const{fieldInfos:a,expressionInfos:f}=await d({renderer:e,layer:t}),l=a.filter((e=>-1===e.fieldName.indexOf(p))),m={fieldInfo:new n({fieldName:"expression/dot-density-categories-list"}),expressionInfo:new i({name:"dot-density-categories-list",title:s.listOfCategories,expression:r(l,f)})},c=new o({expressionInfos:[m.expressionInfo],fieldInfos:[m.fieldInfo],title:s.competingFields,content:`{${m.fieldInfo.fieldName}}`});return{name:"dot-density-categories-list",title:s.orderedListOfValues,value:c}}async function y(e,t,s){const{fieldInfos:r,expressionInfos:f}=await d({renderer:e,layer:t}),l=r.filter((e=>-1===e.fieldName.indexOf(p))),m={fieldInfo:new n({fieldName:"expression/dot-density-category"}),expressionInfo:new i({name:"dot-density-category",title:s.predominantCategory,expression:a(l,f)})},c=new o({expressionInfos:[m.expressionInfo,...f],fieldInfos:[m.fieldInfo,...r],content:[{type:"text",text:`<div><b><font size="3">{${m.fieldInfo.fieldName}}</font></b></div>`},{type:"media",mediaInfos:{type:"pie-chart",title:s.competingFields,value:{fields:r.map((e=>e.fieldName))}}}]});return{name:"dot-density-category-chart",title:s.predominantCategoryWithChart,value:c}}async function I(e){const[{renderer:n,layer:i},o]=await t([l(e),s("esri/smartMapping/t9n/smartMapping")]);return{primaryTemplate:{name:"dot-density",title:o.dotDensity,value:await m(n,i)},secondaryTemplates:[await c(n,i,o),await y(n,i,o)]}}export{I as getTemplates};
