/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as e}from"../../core/maybe.js";import a from"../../core/Error.js";import{getScaleForResolution as t}from"../../geometry/support/scaleUtils.js";import{createLayerAdapter as n,getLayerTypeLabels as r}from"../support/adapters/support/layerUtils.js";import i from"../statistics/spatialStatistics.js";function s(e,a,t=!0){if(e.constraints&&"effectiveLODs"in e.constraints){const n=e.constraints.effectiveLODs,r=t?n:n.slice(0).reverse();let i=null;for(const e of r)if(!(t?e.scale>a:e.scale<a)){i=e;break}return i}}async function l(l){const o=await async function(t){const{view:i,sampleSize:s}=t;if(!(t&&i&&t.layer))throw new a("scale-range:missing-parameters","'view' and 'layer' parameters are required");const l=[0,2,3,1],{layer:o,...c}=t,m=n(o,l),p={layerAdapter:m,...c};if(p.sampleSize=s||500,!m)throw new a("scale-range:invalid-parameters","'layer' must be one of these types: "+r(l).join(", "));await i.when();const u=e(p.signal)?{signal:p.signal}:null;return await m.load(u),p}(l),{view:c,sampleSize:m,layerAdapter:p,signal:u}=o,f=await p.getSampleFeatures({view:c,sampleSize:m,returnGeometry:!0,signal:u}),y=await i({features:f,geometryType:p.geometryType}),{minScale:g,maxScale:S}=function(e,a,n){const r=function(e,a){let t=null,n=null,r=null,i=null;switch(e){case"point":case"multipoint":{const e=a;t=e.avgMinDistance,n=12,r=e.minDistance,i=320;break}case"polyline":{const e=a;t=e.avgLength,n=30,r=e.minLength,i=320;break}case"polygon":{const e=a;t=e.avgSize,n=15,r=e.minSize,i=640;break}}return{resolutionForMinScale:t>0?t/n:null,resolutionForMaxScale:r>0?r/i:null}}(e.geometryType,a);return{minScale:t(r.resolutionForMinScale,n.spatialReference),maxScale:t(r.resolutionForMaxScale,n.spatialReference)}}(p,y,c);return function(e,t,n,r){const{view:i,snapToLOD:l,layerAdapter:o}=e;if(l){const e=s(i,t),a=s(i,n,!1);t=e?e.scale:t,n=a?a.scale:n}if(t<n)throw new a("scale-range:invalid","calculated minScale is less than maxScale.");return n>t/2&&(n=Math.floor(n/2)),t>1e8&&(t=0),"polygon"!==o.geometryType&&(n=0),{minScale:Math.ceil(t),maxScale:Math.floor(n),spatialStatistics:r}}(o,g,S,y)}export default l;
