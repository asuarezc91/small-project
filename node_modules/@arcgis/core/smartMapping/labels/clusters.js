/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import e from"../../core/Error.js";import{all as n,reject as t}from"../../core/promiseUtils.js";import{fetchMessageBundle as r}from"../../intl/messages.js";import s from"../../symbols/TextSymbol.js";import"../../chunks/symbols.js";import o from"../../layers/support/LabelExpressionInfo.js";import a from"../../layers/support/LabelClass.js";import i from"../heuristics/clusterMinSize.js";import{getStatisticInfos as l,getClusterField as u,clusterCountField as c,getPredominantTypeExpression as m,getClusterFieldHash as f}from"../support/clusterUtils.js";import{isClusterCompatibleRenderer as p}from"../../views/2d/layers/support/clusterUtils.js";async function v(r){const{layer:s,renderer:o,view:a}=r;await n([s.load(),a.when()]);const i=o||s.renderer;return p(i)?{layer:s,renderer:i,view:a}:t(new e("clusters-label-schemes:invalid-parameters","'renderer' is not valid"))}async function w(e){const{renderer:n,view:t,statInfo:r}=e,l=null==r?void 0:r.statisticType,p=r?u(r.attributeInfo,l):c,v=function(e){const n=new s({haloColor:"#373837",haloSize:"1px",color:"#f0f0f0",font:{family:"Noto Sans",size:"12px",weight:"bold"}});return new a({symbol:n,deconflictionStrategy:"none",labelPlacement:"center-center",labelExpressionInfo:new o({expression:e})})}("type"===l?function(e,n,t){const r="unique-value"===e.type?e.uniqueValueInfos:[];return m(r,n,t)}(n,p,e.noneValueLabel):function(e){return`\n  $feature["${e}"];\n  var value = $feature["${e}"];\n  var num = Count(Text(Round(value)));\n  var label = When(\n    num < 4, Text(value, "#.#"),\n    num == 4, Text(value / Pow(10, 3), "#.0k"),\n    num <= 6, Text(value / Pow(10, 3), "#k"),\n    num == 7, Text(value / Pow(10, 6), "#.0m"),\n    num > 7, Text(value / Pow(10, 6), "#m"),\n    Text(value, "#,###")\n  );\n  return label;\n  `}(p));return{name:r?`clusters-${l}-${f(p,l)}`:"clusters-count",labelingInfo:[v],clusterMinSize:await i(v.symbol,t),fieldName:p}}async function y(e){const[{renderer:t,layer:s,view:o},a]=await n([v(e),r("esri/smartMapping/t9n/smartMapping")]);if(!t)return null;let i=null;const u=[],c=function(e){const n=new Map;for(const t of e)"size"===t.attributeInfo.vvType?n.set(t.statisticHash,t):n.has(t.statisticHash)||n.set(t.statisticHash,t);return[...n.values()]}(l(s,t,!1));for(const e of c){const n=await w({renderer:t,view:o,statInfo:e,noneValueLabel:a.clusters.predominantNoneValue});"size"===e.attributeInfo.vvType?i=n:u.push(n)}const m=await w({renderer:t,view:o});return i?u.unshift(m):i=m,{primaryScheme:i,secondarySchemes:u}}export{y as getLabelSchemes};
