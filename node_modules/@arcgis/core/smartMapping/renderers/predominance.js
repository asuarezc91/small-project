/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as e}from"../../core/maybe.js";import a from"../../core/Error.js";import{all as i}from"../../core/promiseUtils.js";import{fetchMessageBundle as r}from"../../intl/messages.js";import s from"../../renderers/support/AuthoringInfoVisualVariable.js";import n from"../../renderers/support/AuthoringInfo.js";import o from"../../renderers/visualVariables/OpacityVariable.js";import{round as l}from"../../renderers/support/numberUtils.js";import{getPredominanceExpressions as t}from"../statistics/support/predominanceUtils.js";import{createLayerAdapter as p,getLayerTypeLabels as m}from"../support/adapters/support/layerUtils.js";import d from"../statistics/summaryStatistics.js";import u from"../heuristics/outline.js";import{verifyBasicFieldValidity as c,getBasemapInfo as y,createSymbol as b,getSymbolOutlineFromScheme as f,createColors as g}from"./support/utils.js";import{createVisualVariables as h}from"./size.js";import{createRenderer as v}from"./type.js";import w from"../statistics/predominantCategories.js";import{c as z,g as T}from"../../chunks/predominance.js";async function V(V){const E=await async function(i){if(!(i&&i.layer&&i.view&&i.fields&&i.fields.length))throw new a("predominance-renderer:missing-parameters","'layer', 'view' and 'fields' parameters are required");if(i.fields.length<2)throw new a("predominance-renderer:invalid-parameters","Minimum 2 fields are required");if(i.fields.length>10)throw new a("predominance-renderer:invalid-parameters","Maximum 10 fields are supported");const r={...i};r.symbolType=r.symbolType||"2d",r.defaultSymbolEnabled=null==r.defaultSymbolEnabled||r.defaultSymbolEnabled,r.includeOpacityVariable=i.includeOpacityVariable||!1,r.includeSizeVariable=i.includeSizeVariable||!1,r.sortBy=null==r.sortBy?"count":r.sortBy;const s=[0,2,1,3],n=p(r.layer,s);if(r.layer=n,!n)throw new a("predominance-renderer:invalid-parameters","'layer' must be one of these types: "+m(s).join(", "));const o=e(r.signal)?{signal:r.signal}:null;await n.load(o);const l=n.geometryType,t=r.symbolType.indexOf("3d")>-1;if(r.outlineOptimizationEnabled="polygon"===l&&r.outlineOptimizationEnabled,r.includeSizeVariable||(r.sizeOptimizationEnabled=("point"===l||"multipoint"===l||"polyline"===l)&&r.sizeOptimizationEnabled),"mesh"===l)r.symbolType="3d-volumetric",r.colorMixMode=r.colorMixMode||"replace",r.edgesType=r.edgesType||"none",r.sizeOptimizationEnabled=!1;else{if(t&&("polyline"===l||"polygon"===l))throw new a("predominance-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(r.symbolType.indexOf("3d-volumetric")>-1&&(!r.view||"3d"!==r.view.type))throw new a("predominance-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}const d=r.fields.map((e=>e.name)),u=c(n,d,"predominance-renderer:invalid-parameters");if(u)throw u;return r}(V),S=E.layer,x=(await async function(a){let i=a.predominanceScheme,r=null,s=null;const n=await y(a.basemap,a.view);if(r=e(n.basemapId)?n.basemapId:null,s=e(n.basemapTheme)?n.basemapTheme:null,i)return{scheme:z(i),basemapId:r,basemapTheme:s};const o=T({basemap:r,basemapTheme:s,geometryType:a.geometryType,numColors:a.numColors,theme:a.theme,worldScale:a.worldScale,view:a.view});return o&&(i=o.primaryScheme,r=o.basemapId,s=o.basemapTheme),{scheme:i,basemapId:r,basemapTheme:s}}({basemap:E.basemap,geometryType:S.geometryType,numColors:E.fields.length,predominanceScheme:E.predominanceScheme,worldScale:E.symbolType.indexOf("3d-volumetric")>-1,view:E.view})).scheme,O=E.fields.map((e=>e.name)),I=t(S,O),M=async function(e,a,s,o){const l=await r("esri/smartMapping/t9n/smartMapping"),t=e.layer,p={layer:e.layer,view:e.view,signal:e.signal},[m,d]=await i([w({layer:t,fields:o,view:e.view,signal:e.signal}),e.outlineOptimizationEnabled?u(p):null]);let c=m;m&&m.predominantCategoryInfos||(c={predominantCategoryInfos:o.map((e=>({value:e,count:0})))});const y=d&&d.opacity,h=await v({layer:t,basemap:e.basemap,valueExpression:a.valueExpression,valueExpressionTitle:l.predominantCategory,numTypes:-1,defaultSymbolEnabled:e.defaultSymbolEnabled,sortBy:e.sortBy,typeScheme:s,statistics:{uniqueValueInfos:c.predominantCategoryInfos},legendOptions:e.legendOptions,outlineOptimizationEnabled:!1,sizeOptimizationEnabled:(!e.includeSizeVariable||!e.sizeOptimizationEnabled)&&e.sizeOptimizationEnabled,symbolType:e.symbolType,colorMixMode:e.colorMixMode,edgesType:e.edgesType,view:e.view,signal:e.signal}),{renderer:z,basemapId:T,basemapTheme:V,uniqueValueInfos:E,excludedUniqueValueInfos:S}=h,x=z.uniqueValueInfos,O={};for(const a of e.fields){const e=t.getField(a.name);O[e.name]=a.label||e&&e.alias||a.name}if(x.forEach(((e,a)=>{const i=O[e.value];e.label=i,E[a].label=i})),e.includeSizeVariable){let a=t.geometryType,i=null;if("polygon"===a){const r=s.sizeScheme,n=r.background;z.backgroundFillSymbol=b(a,{type:e.symbolType,color:n.color,outline:f(n,a,y)}),i=r.marker.size,a="point"}else i="polyline"===a?s.width:s.size;const r=g(s.colors,x.length);x.forEach(((n,o)=>{const l=b(a,{type:e.symbolType,color:r[o],size:i,outline:f(s,a,y),meshInfo:{colorMixMode:e.colorMixMode,edgesType:e.edgesType}});n.symbol=l,E[o].symbol=l.clone()}))}return d&&d.visualVariables&&d.visualVariables.length&&(z.visualVariables=d.visualVariables.map((e=>e.clone()))),z.authoringInfo=new n({type:"predominance",fields:[...o]}),{renderer:z,predominantCategoryInfos:E,excludedCategoryInfos:S,predominanceScheme:s,basemapId:T,basemapTheme:V}}(E,I.predominantCategory,x,O),j=E.includeSizeVariable?async function(e,a,i){const s=await r("esri/smartMapping/t9n/smartMapping");return h({layer:e.layer,basemap:e.basemap,valueExpression:a.valueExpression,sqlExpression:a.statisticsQuery.sqlExpression,sqlWhere:a.statisticsQuery.sqlWhere,sizeScheme:i,sizeOptimizationEnabled:e.sizeOptimizationEnabled,worldScale:e.symbolType.indexOf("3d-volumetric")>-1,legendOptions:{title:s.sumOfCategories},view:e.view,signal:e.signal})}(E,I.size,x.sizeScheme):null,q=E.includeOpacityVariable?async function(e,a){const i=await r("esri/smartMapping/t9n/smartMapping"),t=await d({layer:e.layer,valueExpression:a.valueExpression,sqlExpression:a.statisticsQuery.sqlExpression,sqlWhere:a.statisticsQuery.sqlWhere,view:e.view,signal:e.signal}),p=null==t.avg||null==t.stddev,m=1/e.fields.length*100;let u=p?100:t.avg+1.285*t.stddev;u>100&&(u=100);const c=l([m,u],{strictBounds:!0}),y=new o({valueExpression:a.valueExpression,stops:[{value:c[0],opacity:.15},{value:c[1],opacity:1}],legendOptions:{title:i.strengthOfPredominance}}),b=new s({type:"opacity",minSliderValue:t.min,maxSliderValue:t.max});return{visualVariable:y,statistics:t,defaultValuesUsed:p,authoringInfo:new n({visualVariables:[b]})}}(E,I.opacity):null,[C,A,B]=await i([M,j,q]),U=[],k=[];if(A&&(Array.prototype.push.apply(U,A.visualVariables.map((e=>e.clone()))),delete A.sizeScheme,C.size=A,Array.prototype.push.apply(k,A.authoringInfo.visualVariables.map((e=>e.clone())))),B&&(U.push(B.visualVariable.clone()),C.opacity=B,Array.prototype.push.apply(k,B.authoringInfo.visualVariables.map((e=>e.clone())))),U.length){const e=C.renderer.visualVariables||[];Array.prototype.push.apply(e,U),C.renderer.visualVariables=e,C.renderer.authoringInfo.visualVariables=k}return C}export{V as createRenderer};
