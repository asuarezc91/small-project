/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isSome as i}from"../../core/maybe.js";import e from"../../core/Error.js";import{resolve as a}from"../../core/promiseUtils.js";import s from"../../renderers/support/AuthoringInfoVisualVariable.js";import r from"../../renderers/support/AuthoringInfo.js";import l from"../../renderers/visualVariables/OpacityVariable.js";import{getFieldsList as o}from"../support/utils.js";import{createLayerAdapter as t,getLayerTypeLabels as n}from"../support/adapters/support/layerUtils.js";import p from"../statistics/summaryStatistics.js";import{verifyBasicFieldValidity as u,createStopValues as m,getDefaultDataRange as d}from"./support/utils.js";async function f(f){const v=await async function(a){if(!(a&&a.layer&&(a.field||a.valueExpression||a.sqlExpression)))throw new e("opacity-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(a.valueExpression&&!a.view)throw new e("opacity-visual-variable:missing-parameters","View is required when 'valueExpression' is specified");const s={...a},r=[0,2,1,3],l=t(s.layer,r);if(s.layer=l,!l)throw new e("opacity-visual-variable:invalid-parameters","'layer' must be one of these types: "+n(r).join(", "));const p=i(s.signal)?{signal:s.signal}:null;await l.load(p);const m=await o({field:s.field,normalizationField:s.normalizationField,valueExpression:s.valueExpression}),d=u(l,m,"opacity-visual-variable:invalid-parameters");if(d)throw d;return s}(f);let c=null;return c=v.statistics?v.statistics:await p({layer:v.layer,field:v.field,valueExpression:v.valueExpression,sqlExpression:v.sqlExpression,sqlWhere:v.sqlWhere,normalizationType:v.normalizationField?"field":void 0,normalizationField:v.normalizationField,minValue:v.minValue,maxValue:v.maxValue,view:v.view,signal:v.signal}),function(i,e){const o=e.layer,t=e.field,n=t&&"function"!=typeof t?o.getField(t):null,p=n&&"date"===n.type,u=m(i),f=d(i,p,!0),v=f||[u[0],u[4]],c=new l({field:t,valueExpression:e.valueExpression,valueExpressionTitle:e.valueExpressionTitle,normalizationField:e.normalizationField,stops:[{value:v[0],opacity:.3},{value:v[1],opacity:1}],legendOptions:e.legendOptions}),y=new s({type:"opacity",minSliderValue:null!=e.minValue?e.minValue:i.min,maxSliderValue:null!=e.maxValue?e.maxValue:i.max}),x=new r({visualVariables:[y]});return a({visualVariable:c,statistics:i,defaultValuesUsed:!!f,authoringInfo:x})}(c,v)}export{f as createVisualVariable};
